#Drug-bug(s) community interactions, expanding on work by Garc√≠a-Santamarina et al., 2024 (Cell)
#In this script, we build towards the model that eventually is used in the Thesis
#i.e., the model that incorporates drug dynamics as deduced from the metabolomics data
#& species individual drug sensitivities as deduced from monoculture AUCs measured along tested concentration gradients
#In order to make the model - starting from line ~2100 onwards - work,
#run the code below in chronological order. Only manual intervention required in running any drug's model is
#changing the starting concentration by simply searching and replacing '$conc)[1]' (the lowest non-zero concentration tested for each drug in question) 
#with '$conc)[2]'. For instructions on how to do this, see line 2180-2184. 
#for questions, please approach me: nv321@cam.ac.uk or naomi.vdberg@hotmail.com

#Load needed libraries:
library(tidyverse) 
library(gridExtra) 
library(dplyr) 
library(readxl)
library(readr)
library(stringr)
library(vegan)
library(tidyr)
library(MASS)
library(ggplot2)
library(deSolve)
library(minpack.lm)

#Import files
#Main file: 16S, contains the control population (0 drugs)
X16S_counts <- read_delim("~/Downloads/16S_counts.tsv", 
                          delim = "\t", escape_double = FALSE, 
                          trim_ws = TRUE)
#30 drugs tested:
unique(X16S_counts$drug)

##Niclosamide was unique in this study in that it had more different concentrations tested than the other drugs:
unique(subset(X16S_counts, drug != "Niclosamide")$concentration)

#Most had 3 non-zero concentrations tested:
unique(subset(X16S_counts, drug == "Mefloquine")$concentration)
unique(subset(X16S_counts, drug == "Loratadine")$concentration)


#subset for Niclosamide
Niclosamide_16S <- subset(X16S_counts, drug == "Niclosamide")

Niclosamide_16S_0uM <- subset(X16S_counts, control == "TRUE")
Niclosamide_16S_20uM <- subset(Niclosamide_16S, concentration == 20)
Niclosamide_16S_80uM <- subset(Niclosamide_16S, concentration == 80)
Niclosamide_16S_160uM <- subset(Niclosamide_16S, concentration == 160)

Niclosamide_16S_0uM_summarised <- Niclosamide_16S_0uM %>%
  dplyr::group_by(species) %>%                                  
  dplyr::summarize(
    mean_rel_ab = mean(rel_abundance, na.rm = TRUE),     
    sd_rel_ab = sd(rel_abundance, na.rm = TRUE) ,
    mean_max_OD = mean(maxOD, na.rm = TRUE),
    sd_max_OD = sd(maxOD, na.rm = TRUE)
  ) %>%
  dplyr::ungroup() 


Niclosamide_16S_20uM_summarised <- Niclosamide_16S_20uM %>%
  dplyr::group_by(species) %>%                                  
  dplyr::summarize(
    mean_rel_ab = mean(rel_abundance, na.rm = TRUE),     
    sd_rel_ab = sd(rel_abundance, na.rm = TRUE) ,
    mean_max_OD = mean(maxOD, na.rm = TRUE),
    sd_max_OD = sd(maxOD, na.rm = TRUE)
  ) %>%
  dplyr::ungroup() 


Niclosamide_16S_80uM_summarised <- Niclosamide_16S_80uM %>%
  dplyr::group_by(species) %>%                                  
  dplyr::summarize(
    mean_rel_ab = mean(rel_abundance, na.rm = TRUE),     
    sd_rel_ab = sd(rel_abundance, na.rm = TRUE) ,
    mean_max_OD = mean(maxOD, na.rm = TRUE),
    sd_max_OD = sd(maxOD, na.rm = TRUE)  
  ) %>%
  dplyr::ungroup() 



Niclosamide_16S_160uM_summarised <- Niclosamide_16S_160uM %>%
  dplyr::group_by(species) %>%                                  
  dplyr::summarize(
    mean_rel_ab = mean(rel_abundance, na.rm = TRUE),     
    sd_rel_ab = sd(rel_abundance, na.rm = TRUE) ,
    mean_max_OD = mean(maxOD, na.rm = TRUE),
    sd_max_OD = sd(maxOD, na.rm = TRUE)   
  ) %>%
  dplyr::ungroup() 

#Monoculture AUCs
combined_monoculture_aucs <- read_delim("~/Downloads/combined_monoculture_aucs.tsv", 
                                        delim = "\t", escape_double = FALSE, 
                                        trim_ws = TRUE)
#View(combined_monoculture_aucs)

#Metabolomics
metabolomics_MGAM_normalised <- read_delim("~/Downloads/metabolomics_MGAM_normalised.tsv", 
                                           delim = "\t", escape_double = FALSE, 
                                           trim_ws = TRUE)
#View(metabolomics_MGAM_normalised)

#Normalised metabolomics
metabolomics_treatment_normalised <- read_delim("~/Downloads/metabolomics_treatment_normalised.tsv", 
                                                delim = "\t", escape_double = FALSE, 
                                                trim_ws = TRUE)
#View(metabolomics_treatment_normalised)

################################################################################
##Niclosamide study:
##Niclosamide MICs
Niclosamide_All_MICs <- read_excel("~/Downloads/Exps 95 to 97 and 113 to 115 combined for MICs (1).xlsx")
Niclosamide_All_MICs

Niclosamide_All_MICs_v1 <- gather(data = `Niclosamide_All_MICs`, key = "Condition", value = "OD_578", -Time_h)
Niclosamide_All_MICs_v1

Niclosamide_All_MICs_v2 <- separate(Niclosamide_All_MICs_v1, Condition, c ("Strain",
                                                                           "Concentration", 
                                                                           "Drug",
                                                                           "Well_number",
                                                                           "Tech_repl", 
                                                                           "Biol_repl",
                                                                           "Experiment_number",
                                                                           "Plate_number"), 
                                    sep = "_", remove = FALSE, convert = FALSE)

Niclosamide_All_MICs_v2


#Extract growth kinetics (while being mindful of 'false' max growth rates due to initial 'humps' etc.:
str(Niclosamide_All_MICs_v1)

Niclosamide_All_MICs_v1a <- Niclosamide_All_MICs_v1 %>%
  dplyr::mutate(
    Concentration = sapply(strsplit(Condition, "_"), function(x) x[2]),
    Species = sapply(strsplit(Condition, "_"), function(x) paste0(substr(x[1], 1, 1), ". ", substr(x[1], 2, nchar(x[1]))))
  )

#library(tidyverse)
#add replicate info
Niclosamide_All_MICs_v1b <- Niclosamide_All_MICs_v1a %>%
  dplyr::mutate(
    TechRep = str_extract(Condition, "(?<=_tech)\\d+"),
    BiolRep = str_extract(Condition, "(?<=_biol)\\d+"),
    Replicate = paste0(TechRep, "_", BiolRep)
  ) 

#Inspect species and collect outlier replicates, when outliers are consistent to one biological or technological replicate (since replicate space is large enough)
unique(Niclosamide_All_MICs_v1b$Species)
test1<-subset(Niclosamide_All_MICs_v1b, Species == "E. rectale" & Concentration == 0)
ggplot(test1, aes(x = Time_h, y = OD_578, color = Replicate)) + 
  geom_point(alpha = 0.5, size = 3) +  
  theme_minimal() +  
  labs(x = "Time (hours)", y = "Optical Density (OD 578)", color = "Replicate (tech_biol)") + 
  scale_color_manual(values=c("black", "#00AFBB", "#2e37fe", "darkorchid1", "green", 
                                     "gold1", "firebrick4","chocolate1","#6C0BA9", "red", 
                                     "#999999", "magenta")) 
                                     
#B. longum: appears consistent, no outliers
#C. perfringens: biological replicate 1 has longer initial lag (Niclosamide = 0), which holds in non-zero concentrations as well, but appears to then align both in growth rate as well as maxOD
#F. nucleatum: biological replicate 1 has longer initial lag across concentrations, but it doesn't appear to affect maximum growth rates or ODs so cannot be considered an outlier
#C. comes: same as above
#P. merdae: same as above
#E. coliIAI1: for calculating growth rate for most replicates, the first timepoints are crucial and hence the exception in the growth rate calculator below
#P. copri: biological replicate 1 has shorter initial lag than the rest of replicates (Niclosamide = 0), which also holds for nonzero concentrations like 0.08, but doesn't appear to affect max growth rates or maxODs too much so not considered an outlier
#also interesting: P. copri is good example of bug that consistently goes into diauxic shift
#B. vulgatus: same as rest where biological replicate 1 has longer initial lag but no apparent effect on max growth rate and maxODs (just a slightly higher growth rate as we consistently observe for these cases in other species)
#B. theta: same as above
#B. wadsworthia: same as above
#R. intestinalis: appears consistent, no outliers (since we skip the initial peak observed between 0-2 hrs)
#V. parvula: fine for 0 Niclosamide, but in the highest concentration (40 uM), biological repl. 2 does significantly better than biological replicate 1 (biol. repl. 3 not included here)
#B. uniformus: appears consistent, no outliers
#E. lenta: only at higher concentrations, such as 10 uM, biological replicate 2 stands out from 1 and 3 in that it does more poorly.
#C. ramosum: appears consistent, no outliers
#B. fragilis: in higher concentrations, such as 20 uM, biological replicate 1 is higher than 2 and 3, but difference is marginal
#C. boltea: appears consistent, no outliers
#C. saccharolyticum: appears consistent, no outliers
#R. gnavus: appears consistent, no outliers
#C. aerofaciens: in higher concentrations, such as 20 uM, biological replicate 3 stands out from 1 and 2 in having a shorter lag time, but does not appear to affect max growth rate much, just a marginally lower maxOD

#D. formicigenerans: only for Niclosamide = 0 uM, replicate 2_3 stands out (appears to only be an outlier at that concentration)
#E. rectale: biological replicate 3 deviates from rest (Niclosamide = 0). This deviation holds for other tested concentrations as well, so just remove altogether


#Now, per replicate, extract maxOD and max_r
# Calculate the growth rate, ignoring the initial burst by starting calculations from the 3rd hour onwards
# Define the function to calculate growth rates
calculate_growth_rates <- function(od, time) {
  od_change <- c(NA, diff(od))
  growth_rate <- ifelse(time <= 2, NA, od_change / lag(od))
  return(data.frame(OD_change = od_change, Growth_rate = growth_rate))
}


##Apply the function to each group and calculate the max OD and max growth rate
growth_data <- Niclosamide_All_MICs_v1b %>%
  dplyr::group_by(Species, Replicate, Concentration) %>%
  dplyr::arrange(Time_h) %>%
  dplyr::mutate(
    OD_change = c(NA, diff(OD_578)), # Calculate the change in OD between time points
    # Calculate growth rate, make required exceptions for: E. coliED1a
    Growth_rate = ifelse(Species == "E. coliED1a", OD_change / lag(OD_578), ifelse(Time_h <= 2, NA, OD_change / lag(OD_578)))
  ) %>%
  dplyr::summarise(
    max_OD = max(OD_578, na.rm = TRUE), # Extract the maximum OD
    max_Growth_rate = max(Growth_rate, na.rm = TRUE), # Extract the maximum growth rate
    .groups = 'drop' # This will drop the grouping structure afterwards
  )

#investigate results
print(growth_data)
#re-introduce separate technological and biological replicate numbers to fascilitate removing outliers
growth_data <- growth_data %>%
  separate(Replicate, into = c("Technological_replicate", "Biological_replicate"), sep = "_", remove = FALSE)

#remove outliers:
growth_data_1 <- growth_data %>%
  dplyr::filter(!(Species == 'E. rectale' & Biological_replicate == '3'))

growth_data_2 <- growth_data_1 %>%
  dplyr::filter(!(Species == 'D. formicigenerans' & Replicate == '2_3' & Concentration == 0))


#Main: 16S Niclosamide co-culture
X16S_counts_Niclosamide <- read_excel("~/Downloads/16S_counts_Niclosamide.xlsx")
#View(X16S_counts_Niclosamide)

##Growth community with Niclosamide: maxOD community
growth_community_Niclosamide <- read_excel("~/Downloads/growth_community_Niclosamide.xlsx")
#View(growth_community_Niclosamide)

#Growth monoculture with Niclosamide
growth_monoculture_niclosamide <- read_excel("~/Downloads/growth_monoculture_niclosamide.xlsx")
#View(growth_monoculture_niclosamide)

##Extract species:
unique(growth_monoculture_niclosamide$species_name)

##Not all species used for co-culture have monoculture growth data
list1 <- unique(growth_monoculture_niclosamide$species_name)
list2 <- unique(X16S_counts_Niclosamide$species)
mismatch1 <- setdiff(list1, list2)
mismatch2 <- setdiff(list2, list1)
print("Species in list2 but not in list1:")
print(mismatch2)

#After inspecting all missing species from the monoculture kinetics, these species all have a near-zero abundance in the community, 
#meaning we can neglect these species altogether (i.e., not build differentials for them), or we can assign them average growth kinetics since the co-culture correction factors will account for their poor performance.

##First, ensure naming is consistent between control samples, stored in X16S_counts, and the Niclosamide-specific dataframes 
X16S_counts_control <- subset(X16S_counts, drug == "control")

list1 <- unique(X16S_counts_control$species)
list2 <- unique(X16S_counts_Niclosamide$species)
mismatch1 <- setdiff(list1, list2)
mismatch2 <- setdiff(list2, list1)
print("Species in list2 but not in list1:")
print(mismatch2)

X16S_counts_control$species <- gsub("Phocaeicola vulgatus", "Bacteroides vulgatus", X16S_counts_control$species)
X16S_counts_control$species <- gsub("Enterocloster bolteae", "Clostridium bolteae", X16S_counts_control$species)
X16S_counts_control$species <- gsub("Erysipelatoclostridium ramosum", "Clostridium ramosum", X16S_counts_control$species)
X16S_counts_control$species <- gsub("Lacrimispora saccharolytica", "Clostridium saccharolyticum", X16S_counts_control$species)
X16S_counts_control$species <- gsub("Lacticaseibacillus paracasei", "Lactobacillus paracasei", X16S_counts_control$species)
#Check code above for no more mismatches


#Now, we need to ensure formatting between monoculture growth data and co-culture data is consistent
X16S_counts_control_1 <- X16S_counts_control %>%
  dplyr::rename(species_complete = species) %>% # Renaming the 'species' column to 'species_complete'
  dplyr::mutate(
    species = sapply(strsplit(species_complete, " "), function(x) paste0(substr(x[1], 1, 1), '. ', x[2])) # Creating the abbreviated species names
  )

#check for inconsistencies:
list1 <- unique(X16S_counts_control_1$species)
list2 <- unique(growth_data_2$Species)
mismatch1 <- setdiff(list1, list2)
mismatch2 <- setdiff(list2, list1)
print("Species in list2 but not in list1:")
print(mismatch2)
print("Species in list1 but not in list2:")
print(mismatch1)

growth_data_2$Species <- gsub("B. theta", "B. thetaiotaomicron", growth_data_2$Species)
growth_data_2$Species <- gsub("E. coliED1a", "E. coli", growth_data_2$Species)
growth_data_2$Species <- gsub("C. boltea", "C. bolteae", growth_data_2$Species)

#adjust mismatch to account for these corrected naming incompatibilities
mismatch1_a <- mismatch1[!mismatch1 %in% c("B. thetaiotaomicron", "C. bolteae", "E. coli")]


#After correcting for naming inconsistencies, the following species are in the 16S data but not in the monoculture growth data:
#[1] "A. muciniphila"   "B. adolescentis"  "B. obeum"         "O. splanchnicus"  "P. distasonis"    "R. bromii"        "R. torques"       "S. parasanguinis"
#[9] "S. salivarius"    "L. paracasei"   

#All of the above have near 0 rel. abundance in control samples, except:
#1) S. parasanguinis (~ 0.02) & S. salivarius (~ 0.01)


##Approach: first, calc averages for current species across all conditions & then add averages for all these missing species to the growth kinetics dataframe
growth_data_3 <- growth_data_2 %>%
  dplyr::group_by(Species, Concentration) %>%
  dplyr::summarise(
    mean_max_OD = mean(max_OD, na.rm = TRUE),
    sd_max_OD = sd(max_OD, na.rm = TRUE),
    mean_max_Growth_rate = mean(max_Growth_rate, na.rm = TRUE),
    sd_max_Growth_rate = sd(max_Growth_rate, na.rm = TRUE),
    .groups = 'drop' 
  )


rel_ab_control <- X16S_counts_control_1 %>%
  dplyr::group_by(species, concentration) %>%
  dplyr::summarise(
    mean_rel_ab = mean(rel_abundance, na.rm = TRUE),
    sd_rel_ab = sd(rel_abundance, na.rm = TRUE),
    mean_com_max_OD = mean(maxOD, na.rm = TRUE),
    sd_com_max_OD = sd(maxOD, na.rm = TRUE),
    mean_com_final_OD = mean(finalOD, na.rm = TRUE),
    sd_com_final_OD = sd(finalOD, na.rm = TRUE),
    .groups = 'drop' 
  )

##Nexts: add averages for missing species in monoculture data:
#First, calculate the overall averages
unique_concentrations <- unique(growth_data_3$Concentration)

overall_averages <- growth_data_3 %>%
  dplyr::group_by(Concentration) %>%
  dplyr::summarise(
    avg_mean_max_OD = mean(mean_max_OD, na.rm = TRUE),
    avg_sd_max_OD = mean(sd_max_OD, na.rm = TRUE),
    avg_mean_max_Growth_rate = mean(mean_max_Growth_rate, na.rm = TRUE),
    avg_sd_max_Growth_rate = mean(sd_max_Growth_rate, na.rm = TRUE)
  )

#Create a new dataframe for missing species
missing_species_data <- expand.grid(Species = mismatch1_a, Concentration = unique_concentrations) %>%
  dplyr::left_join(overall_averages, by = "Concentration") %>%
  dplyr::rename(
    mean_max_OD = avg_mean_max_OD,
    sd_max_OD = avg_sd_max_OD,
    mean_max_Growth_rate = avg_mean_max_Growth_rate,
    sd_max_Growth_rate = avg_sd_max_Growth_rate
  )

# Combine with the original dataframe
growth_data_all <- rbind(growth_data_3, missing_species_data)

growth_data_all_0_Niclosamide <- subset(growth_data_all, Concentration == 0)


X16S_counts_control$species <- X16S_counts_control$species

names(rel_ab_control)[names(rel_ab_control) == "concentration"] <- "Concentration"
names(rel_ab_control)[names(rel_ab_control) == "species"] <- "Species"

#View(rel_ab_control)


##Add system of ODEs for all 32 species
#Integration in accordance with experimental details: 2 growth cycles of 24 hours, at dilution of 1:50, initial densities per species: 0.01/32

library(deSolve)
library(dplyr)

# Step 1: Pull model parameters for each species from the respective dataset
#set.seed(123) # for fixing parameters
params <- lapply(1:nrow(growth_data_all_0_Niclosamide), function(idx) {
  species_params <- growth_data_all_0_Niclosamide[idx, ]
  list(
    r = rnorm(1, mean = species_params$mean_max_Growth_rate, sd = species_params$sd_max_Growth_rate),
    K = rnorm(1, mean = species_params$mean_max_OD, sd = species_params$sd_max_OD)
  )
})
names(params) <- gsub(" ", "_", growth_data_all_0_Niclosamide$Species) # Replace spaces with underscores for variable names

# Convert the list of parameters into a named vector to pass to the ODE solver
flat_params <- unlist(params)
names(flat_params) <- gsub("\\.\\d$", "", names(flat_params)) #remove indexing from names

# Define initial conditions and other necessary components as before...
#Initial conditions: initial inoculum mix was diluted to an OD of 1 and then inoculated at 0.01 OD

initial_conditions <- rep(0.01/32, 32)

times <- seq(from = 0, to = 24, by = 1) # From 0 to 24 hours, hourly intervals

#Make state variables in accordance with unique(rel_ab_control$Species)
closed.sir.model <- function (t, x, params) {
  ## first extract the state variables
  A_muciniphila <- x[1]
  B_adolescentis <- x[2]
  B_fragilis <- x[3]
  B_longum <- x[4]
  B_obeum <- x[5]
  B_thetaiotaomicron <- x[6]
  B_uniformis <- x[7]
  B_vulgatus <- x[8]
  B_wadsworthia <- x[9]
  C_aerofaciens <- x[10]
  C_bolteae <- x[11]
  C_comes <- x[12]
  C_perfringens <- x[13]
  C_ramosum <- x[14]
  C_saccharolyticum <- x[15]
  D_formicigenerans <- x[16]
  E_coli <- x[17]
  E_lenta <- x[18]
  E_rectale <- x[19]
  F_nucleatum <- x[20]
  L_paracasei <- x[21]
  O_splanchnicus <- x[22]
  P_copri <- x[23]
  P_distasonis <- x[24]
  P_merdae <- x[25]
  R_bromii <- x[26]
  R_gnavus <- x[27]
  R_intestinalis <- x[28]
  R_torques <- x[29]
  S_parasanguinis <- x[30]
  S_salivarius <- x[31]
  V_parvula <- x[32]
  
  
  ## now extract the parameters
  r_B_fragilis <- flat_params[["B._fragilis.r"]]
  K_B_fragilis <- flat_params[["B._fragilis.K"]]
  r_B_longum <- flat_params[["B._longum.r"]]
  K_B_longum <- flat_params[["B._longum.K"]]
  r_B_thetaiotaomicron <- flat_params[["B._thetaiotaomicron.r"]]
  K_B_thetaiotaomicron <- flat_params[["B._thetaiotaomicron.K"]]
  r_B_uniformis <- flat_params[["B._uniformis.r"]]
  K_B_uniformis <- flat_params[["B._uniformis.K"]]
  r_B_vulgatus <- flat_params[["B._vulgatus.r"]]
  K_B_vulgatus <- flat_params[["B._vulgatus.K"]]
  r_B_wadsworthia <- flat_params[["B._wadsworthia.r"]]
  K_B_wadsworthia <- flat_params[["B._wadsworthia.K"]]
  r_C_aerofaciens <- flat_params[["C._aerofaciens.r"]]
  K_C_aerofaciens <- flat_params[["C._aerofaciens.K"]]
  r_C_bolteae <- flat_params[["C._bolteae.r"]]
  K_C_bolteae <- flat_params[["C._bolteae.K"]]
  r_C_comes <- flat_params[["C._comes.r"]]
  K_C_comes <- flat_params[["C._comes.K"]]
  r_C_perfringens <- flat_params[["C._perfringens.r"]]
  K_C_perfringens <- flat_params[["C._perfringens.K"]]
  r_C_ramosum <- flat_params[["C._ramosum.r"]]
  K_C_ramosum <- flat_params[["C._ramosum.K"]]
  r_C_saccharolyticum <- flat_params[["C._saccharolyticum.r"]]
  K_C_saccharolyticum <- flat_params[["C._saccharolyticum.K"]]
  r_D_formicigenerans <- flat_params[["D._formicigenerans.r"]]
  K_D_formicigenerans <- flat_params[["D._formicigenerans.K"]]
  r_E_coli <- flat_params[["E._coli.r"]]
  K_E_coli <- flat_params[["E._coli.K"]]
  r_E_lenta <- flat_params[["E._lenta.r"]]
  K_E_lenta <- flat_params[["E._lenta.K"]]
  r_E_rectale <- flat_params[["E._rectale.r"]]
  K_E_rectale <- flat_params[["E._rectale.K"]]
  r_F_nucleatum <- flat_params[["F._nucleatum.r"]]
  K_F_nucleatum <- flat_params[["F._nucleatum.K"]]
  r_P_copri <- flat_params[["P._copri.r"]]
  K_P_copri <- flat_params[["P._copri.K"]]
  r_P_merdae <- flat_params[["P._merdae.r"]]
  K_P_merdae <- flat_params[["P._merdae.K"]]
  r_R_gnavus <- flat_params[["R._gnavus.r"]]
  K_R_gnavus <- flat_params[["R._gnavus.K"]]
  r_R_intestinalis <- flat_params[["R._intestinalis.r"]]
  K_R_intestinalis <- flat_params[["R._intestinalis.K"]]
  r_V_parvula <- flat_params[["V._parvula.r"]]
  K_V_parvula <- flat_params[["V._parvula.K"]]
  r_A_muciniphila <- flat_params[["A._muciniphila.r"]]
  K_A_muciniphila <- flat_params[["A._muciniphila.K"]]
  r_B_adolescentis <- flat_params[["B._adolescentis.r"]]
  K_B_adolescentis <- flat_params[["B._adolescentis.K"]]
  r_B_obeum <- flat_params[["B._obeum.r"]]
  K_B_obeum <- flat_params[["B._obeum.K"]]
  r_O_splanchnicus <- flat_params[["O._splanchnicus.r"]]
  K_O_splanchnicus <- flat_params[["O._splanchnicus.K"]]
  r_P_distasonis <- flat_params[["P._distasonis.r"]]
  K_P_distasonis <- flat_params[["P._distasonis.K"]]
  r_R_bromii <- flat_params[["R._bromii.r"]]
  K_R_bromii <- flat_params[["R._bromii.K"]]
  r_R_torques <- flat_params[["R._torques.r"]]
  K_R_torques <- flat_params[["R._torques.K"]]
  r_S_parasanguinis <- flat_params[["S._parasanguinis.r"]]
  K_S_parasanguinis <-flat_params[["S._parasanguinis.K"]]
  r_S_salivarius <- flat_params[["S._salivarius.r"]]
  K_S_salivarius <- flat_params[["S._salivarius.K"]]
  r_L_paracasei <- flat_params[["L._paracasei.r"]]
  K_L_paracasei <- flat_params[["L._paracasei.K"]]
  
  
  ## now code the model equations (logistic growth curves)
  dA_muciniphila_dt <- r_A_muciniphila * A_muciniphila * (1 - A_muciniphila / K_A_muciniphila)
  dB_adolescentis_dt <- r_B_adolescentis * B_adolescentis * (1 - B_adolescentis / K_B_adolescentis)
  dB_fragilis_dt <- r_B_fragilis * B_fragilis * (1 - B_fragilis / K_B_fragilis)
  dB_longum_dt <- r_B_longum * B_longum * (1 - B_longum / K_B_longum)
  dB_obeum_dt <- r_B_obeum * B_obeum * (1 - B_obeum / K_B_obeum)
  dB_thetaiotaomicron_dt <- r_B_thetaiotaomicron * B_thetaiotaomicron * (1 - B_thetaiotaomicron / K_B_thetaiotaomicron)
  dB_uniformis_dt <- r_B_uniformis * B_uniformis * (1 - B_uniformis / K_B_uniformis)
  dB_vulgatus_dt <- r_B_vulgatus * B_vulgatus * (1 - B_vulgatus / K_B_vulgatus)
  dB_wadsworthia_dt <- r_B_wadsworthia * B_wadsworthia * (1 - B_wadsworthia / K_B_wadsworthia)
  dC_aerofaciens_dt <- r_C_aerofaciens * C_aerofaciens * (1 - C_aerofaciens / K_C_aerofaciens)
  dC_bolteae_dt <- r_C_bolteae * C_bolteae * (1 - C_bolteae / K_C_bolteae)
  dC_comes_dt <- r_C_comes * C_comes * (1 - C_comes / K_C_comes)
  dC_perfringens_dt <- r_C_perfringens * C_perfringens * (1 - C_perfringens / K_C_perfringens)
  dC_ramosum_dt <- r_C_ramosum * C_ramosum * (1 - C_ramosum / K_C_ramosum)
  dC_saccharolyticum_dt <- r_C_saccharolyticum * C_saccharolyticum * (1 - C_saccharolyticum / K_C_saccharolyticum)
  dD_formicigenerans_dt <- r_D_formicigenerans * D_formicigenerans * (1 - D_formicigenerans / K_D_formicigenerans)
  dE_coli_dt <- r_E_coli * E_coli * (1 - E_coli / K_E_coli)
  dE_lenta_dt <- r_E_lenta * E_lenta * (1 - E_lenta / K_E_lenta)
  dE_rectale_dt <- r_E_rectale * E_rectale * (1 - E_rectale / K_E_rectale)
  dF_nucleatum_dt <- r_F_nucleatum * F_nucleatum * (1 - F_nucleatum / K_F_nucleatum)
  dL_paracasei_dt <- r_L_paracasei * L_paracasei * (1 - L_paracasei / K_L_paracasei)
  dO_splanchnicus_dt <- r_O_splanchnicus * O_splanchnicus * (1 - O_splanchnicus / K_O_splanchnicus)
  dP_copri_dt <- r_P_copri * P_copri * (1 - P_copri / K_P_copri)
  dP_distasonis_dt <- r_P_distasonis * P_distasonis * (1 - P_distasonis / K_P_distasonis)
  dP_merdae_dt <- r_P_merdae * P_merdae * (1 - P_merdae / K_P_merdae)
  dR_bromii_dt <- r_R_bromii * R_bromii * (1 - R_bromii / K_R_bromii)
  dR_gnavus_dt <- r_R_gnavus * R_gnavus * (1 - R_gnavus / K_R_gnavus)
  dR_intestinalis_dt <- r_R_intestinalis * R_intestinalis * (1 - R_intestinalis / K_R_intestinalis)
  dR_torques_dt <- r_R_torques * R_torques * (1 - R_torques / K_R_torques)
  dS_parasanguinis_dt <- r_S_parasanguinis * S_parasanguinis * (1 - S_parasanguinis / K_S_parasanguinis)
  dS_salivarius_dt <- r_S_salivarius * S_salivarius * (1 - S_salivarius / K_S_salivarius)
  dV_parvula_dt <- r_V_parvula * V_parvula * (1 - V_parvula / K_V_parvula)
  
  ## Combine results into a single vector
  dxdt <- c(dA_muciniphila_dt, dB_adolescentis_dt, dB_fragilis_dt, dB_longum_dt, dB_obeum_dt, dB_thetaiotaomicron_dt, dB_uniformis_dt, dB_vulgatus_dt, dB_wadsworthia_dt, dC_aerofaciens_dt, dC_bolteae_dt, dC_comes_dt, dC_perfringens_dt, dC_ramosum_dt, dC_saccharolyticum_dt, dD_formicigenerans_dt, dE_coli_dt, dE_lenta_dt, dE_rectale_dt, dF_nucleatum_dt, dL_paracasei_dt, dO_splanchnicus_dt, dP_copri_dt, dP_distasonis_dt, dP_merdae_dt, dR_bromii_dt, dR_gnavus_dt, dR_intestinalis_dt, dR_torques_dt, dS_parasanguinis_dt, dS_salivarius_dt, dV_parvula_dt)
  
  ## Return result as a list
  list(dxdt)
}

#Next: solve ODE with these parameters and the appropriate dilution regime
## Initial integration for the first 24-hour cycle
solution_cycle_1 <- ode(
  y = initial_conditions,
  times = seq(from = 0, to = 24, by = 1),
  func = closed.sir.model,
  parms = flat_params
)

#Get the last row of the solution (end of the first cycle)
end_of_cycle_1 <- solution_cycle_1[nrow(solution_cycle_1), -1] 

# Apply the dilution factor to get the new initial conditions for the second cycle
initial_conditions_cycle_2 <- end_of_cycle_1 / 50

# Integration for the second 24-hour cycle, starting from time = 24 to time = 48
times_cycle_2 <- seq(from = 24, to = 48, by = 1) #continue from the end of cycle 1

solution_cycle_2 <- ode(
  y = initial_conditions_cycle_2,
  times = times_cycle_2,
  func = closed.sir.model,
  parms = flat_params
)

combined_solution <- rbind(as.data.frame(solution_cycle_1), as.data.frame(solution_cycle_2)[-1,])



###preparing data for plotting
solution_df <- as.data.frame(combined_solution)

# Melting the data frame for ggplot2
solution_melt <- reshape2::melt(solution_df, id.vars = "time")

species_names <- c(
  "A_muciniphila",
  "B_adolescentis",
  "B_fragilis",
  "B_longum",
  "B_obeum",
  "B_thetaiotaomicron",
  "B_uniformis",
  "B_vulgatus",
  "B_wadsworthia",
  "C_aerofaciens",
  "C_bolteae",
  "C_comes",
  "C_perfringens",
  "C_ramosum",
  "C_saccharolyticum",
  "D_formicigenerans",
  "E_coli",
  "E_lenta",
  "E_rectale",
  "F_nucleatum",
  "L_paracasei",
  "O_splanchnicus",
  "P_copri",
  "P_distasonis",
  "P_merdae",
  "R_bromii",
  "R_gnavus",
  "R_intestinalis",
  "R_torques",
  "S_parasanguinis",
  "S_salivarius",
  "V_parvula"
)


species_colours <- c(
  "A_muciniphila" = "#1f77b4",
  "B_adolescentis" = "#ff7f0e",
  "B_fragilis" = "#2ca02c",
  "B_longum" = "#d62728",
  "B_obeum" = "#9467bd",
  "B_thetaiotaomicron" = "black",
  "B_uniformis" = "#e377c2",
  "B_vulgatus" = "#7f7f7f",
  "B_wadsworthia" = "gold1",
  "C_aerofaciens" = "#aec7e8",
  "C_bolteae" = "#ffbb78",
  "C_comes" = "magenta",
  "C_perfringens" = "#ff9896",
  "C_ramosum" = "#c5b0d5",
  "C_saccharolyticum" = "#c49c94",
  "D_formicigenerans" = "#f7b6d2",
  "E_coli" = "yellow",
  "E_lenta" = "turquoise",
  "E_rectale" = "#393b79",
  "F_nucleatum" = "royalblue2",
  "L_paracasei" = "blue",
  "O_splanchnicus" = "#637939",
  "P_copri" = "cyan",
  "P_distasonis" = "#8c6d31",
  "P_merdae" = "#c7c7c7",
  "R_bromii" = "#e6550d",
  "R_gnavus" = "#e7cb94",
  "R_intestinalis" = "#843c39",
  "R_torques" = "#d6616b",
  "S_parasanguinis" = "orange3",
  "S_salivarius" = "#7b4173",
  "V_parvula" = "#ce6dbd"
)

# Add a "Species" column 
solution_melt$Species <- species_names[as.numeric(as.character(solution_melt$variable))]

# Now, plotting with species-specific colours and using the new "Species" column
ggplot(solution_melt, aes(x = time, y = value, group = Species, color = Species)) +
  geom_line(size = 1, alpha = 0.7) +
  scale_color_manual(values = species_colours) +
  labs(title = "Species Growth Over Time",
       x = "Time (hours)",
       y = "Population Density (OD)",
       color = "Species") +
  theme_minimal() +
  theme(legend.position = "right")


#View(flat_params)

##Multiple sims

#Initialise data frames
sim_output <- data.frame()
input_params_list <- list() #list to collect parameters for each simulation


#number of simulations
num_sims <- 10 

for (i in 1:num_sims) {
  # generate model parameters
  set.seed(i) #set a different seed for each simulation for variation
  params <- lapply(1:nrow(growth_data_all_0_Niclosamide), function(idx) {
    species_params <- growth_data_all_0_Niclosamide[idx, ]
    list(
      r = rnorm(1, mean = species_params$mean_max_Growth_rate, sd = species_params$sd_max_Growth_rate),
      K = rnorm(1, mean = species_params$mean_max_OD, sd = species_params$sd_max_OD)
    )
  })
  names(params) <- gsub(" ", "_", growth_data_all_0_Niclosamide$Species)
  flat_params <- unlist(params)
  names(flat_params) <- gsub("\\.\\d$", "", names(flat_params))
  
  # Store parameters for each simulation
  input_params_list[[i]] <- c(sim_ID = i, flat_params)
  
  # Run the model for the first 24-hour cycle
  solution_cycle_1 <- ode(y = initial_conditions, times = seq(from = 0, to = 24, by = 1), func = closed.sir.model, parms = flat_params)
  
  # Dilution and second cycle
  end_of_cycle_1 <- solution_cycle_1[nrow(solution_cycle_1), -1]
  initial_conditions_cycle_2 <- end_of_cycle_1 / 50
  solution_cycle_2 <- ode(y = initial_conditions_cycle_2, times = seq(from = 24, to = 48, by = 1), func = closed.sir.model, parms = flat_params)
  
  # Combine and format results
  combined_solution <- rbind(as.data.frame(solution_cycle_1), as.data.frame(solution_cycle_2)[-1,])
  combined_solution$sim_ID <- rep(i, nrow(combined_solution))
  combined_solution <- combined_solution %>%
    gather(key = "Species", value = "Density", -time, -sim_ID) %>%
    dplyr::mutate(Hour = time) %>%
    dplyr::select(sim_ID, Hour, Species, Density)
  
  ##Append to sim_output
  sim_output <- rbind(sim_output, combined_solution)
}


##Combine all parameter data into a single dataframe
input_params <- do.call(rbind, input_params_list)
#View(input_params)
#View(sim_output)

# Add a "Species" column 
sim_output$Species_name <- species_names[as.numeric(as.character(sim_output$Species))]




#Transform sim_output so we have wide format by Species
sim_output_wide <- tidyr::pivot_wider(sim_output, 
                                      names_from = Species_name, 
                                      values_from = Density,
                                      id_cols = c(sim_ID, Hour))

#calc community OD per timepoint
sim_output_wide$Total_OD <- rowSums(sim_output_wide[, 3:34], na.rm = TRUE)
#calculate and add relative abundances here as well:
species_columns <- colnames(sim_output_wide)[3:34] 

for (species in species_columns) {
  sim_output_wide[[paste0("rel_", species)]] <- sim_output_wide[[species]] / sim_output_wide$Total_OD
}


#turn back into long format if interested in plotting relative abundances
cols_needed <- c("sim_ID", "Hour")

sim_output_long <- sim_output_wide %>% 
  dplyr::select(sim_ID, Hour, starts_with("rel_")) %>% 
  tidyr::pivot_longer(
    cols = starts_with("rel_"), 
    names_to = "Species", 
    values_to = "Relative_abundance",
    names_prefix = "rel_"
  ) 

str(sim_output_long)




#Now, plotting a specific sim, with species-specific colours and using the new "Species" column
ggplot(subset(sim_output, sim_ID == 1), aes(x = Hour, y = Density, group = Species_name, color = Species_name)) +
  geom_line(size = 1, alpha = 0.7) +
  scale_color_manual(values = species_colours) +
  labs(title = "Niclosamide = 0",
       x = "Time (hours)",
       y = "Population Density (OD)",
       color = "Species") +
  theme_minimal() +
  theme(legend.position = "right")

ggplot(subset(sim_output_long, sim_ID == 1), aes(x = Hour, y = Relative_abundance, group = Species, color = Species)) +
  geom_line(size = 1, alpha = 0.7) +
  scale_color_manual(values = species_colours) +
  labs(title = "Niclosamide = 0",
       x = "Time (hours)",
       y = "Relative abundance",
       color = "Species") +
  theme_minimal() +
  theme(legend.position = "right")






#####MODEL FOLLOWING CO-CULTURE CORRECTION######
#Still, assuming at 0 Niclosamide


###Next, we impose a co-culture correction on the growth rates
#So the file we used before is the following file, which contains monoculture growth rates;
growth_data_all_0_Niclosamide

#relative abundances in the Niclosamide = 0 community are stored in:
rel_ab_control

#calculate the co-culture correction factor per species based on rel_ab_control
#we here do not draw the co-culture abundance from a normal distribution as well, 
# since this would compound on the inter-simulation variation and require larger simulation space
# however, inherent variability in any species' performance (which can then explain the variability in performance in co-culture) 
# is already accounted for in the growth kinetics being drawn from respective distributions
# hence, we here take the mean for calculating the correction factor


growth_data_all_0_Niclosamide
growth_data_all_0_Niclosamide1 <- growth_data_all_0_Niclosamide %>%
  dplyr::mutate(Species = gsub(" ", "_", Species))
#check naming convention
growth_data_all_0_Niclosamide1

rel_ab_control_1 <- rel_ab_control %>%
  dplyr::mutate(Species = gsub(" ", "_", Species))
#check naming convention
rel_ab_control_1 

#ensure Species is formatted similarly:

unique(rel_ab_control_1$Species)
unique(growth_data_all_0_Niclosamide1$Species)

# Merge rel_ab_control with growth_data_all_0_Niclosamide on Species
rel_ab_control <- merge(rel_ab_control_1, growth_data_all_0_Niclosamide1[, c("Species", "mean_max_OD")], 
                        by = "Species", all.x = TRUE)

str(rel_ab_control)


#rel_ab_control$correction_factor <- rel_ab_control$mean_rel_ab / (rel_ab_control$mean_max_OD/sum(rel_ab_control$mean_max_OD))
rel_ab_control$correction_factor <- pmax(rel_ab_control$mean_rel_ab / (rel_ab_control$mean_max_OD / sum(rel_ab_control$mean_max_OD)), 1.1)


# Create a new dataframe for co-culture correction
co_culture_correction <- data.frame(
  species = rel_ab_control$Species,
  correction_factor = rel_ab_control$correction_factor
)

head(rel_ab_control)

#We will need to transform these growth rates by making them compatible with the community compositions at Niclosamide = 0
#This way, we account for the discrepancy between (relative) monoculture growth performance and co-culture growth performance due to community interactions
#This in turn would allow then for us to fit a drug effect (retrieved from monoculture information) on the co-culture corrected growth parameters (assuming relative drug effect is not changed due to community interactions)
#Thus, any discrepancy between (ensemble) model performance and observed community outcomes for Niclosamide > 0, is due to the drug changing the way A) the community interacts or B) the drug impacts individual species
#The latter we will account for in one indirect way, by incorporating drug inactivation by biological activity of some of our member bacteria (via e.g., bioaccumulation)
#Initialise data frames
sim_output <- data.frame()
input_params_list <- list() # Use a list to collect parameters for each simulation


#number of simulations
num_sims <- 10


for (i in 1:num_sims) {
  #generate model params
  set.seed(i) #a different seed for each simulation for variation
  params <- lapply(1:nrow(growth_data_all_0_Niclosamide), function(idx) {
    species_params <- growth_data_all_0_Niclosamide[idx, ]
    list(
      r = rnorm(1, mean = species_params$mean_max_Growth_rate, sd = species_params$sd_max_Growth_rate),
      K = rnorm(1, mean = species_params$mean_max_OD, sd = species_params$sd_max_OD)
    )
  })
  names(params) <- gsub(" ", "_", growth_data_all_0_Niclosamide$Species)
  flat_params <- unlist(params)
  names(flat_params) <- gsub("\\.\\d$", "", names(flat_params))
  
  #replace spaces with underscores to match formatting
  co_culture_correction$species <- gsub(" ", "_", co_culture_correction$species, fixed = TRUE)
  
  #Pull community maxOD at modelled concentration of Niclosamide from respective normal distribution:
  K <- rnorm(n = 1, mean = mean(rel_ab_control$mean_com_max_OD), sd = mean(rel_ab_control$sd_com_max_OD))
  
  #replace the species-specific K parameters extracted from monoculture growth data 
  #with drawn relative abundance values at Niclosamide = 0, scaled to K
  rel_ab_control$Species <- gsub(" ", "_", rel_ab_control$Species)
  
  #Initialise an empty vector to store drawn values
  drawn_values <- numeric(nrow(rel_ab_control))
  
  #draw values from their respective distributions
  for (k in 1:nrow(rel_ab_control)) {
    species_name <- rel_ab_control$Species[k]
    drawn_value <- rnorm(1, mean = rel_ab_control$mean_rel_ab[k], sd = rel_ab_control$sd_rel_ab[k])
    drawn_values[k] <- max(drawn_value, 0)  # Ensure no negative values
  }
  
  #Normalise drawn relative abundance values so they sum to 1 (to reflect a 'true' relative abundance distribution)
  #this is needed so when we convert the values into OD units by multiplying with the drawn community maxOD,
  # the sum of K_i parameters and the drawn K are equal
  normalised_values <- drawn_values / sum(drawn_values)
  
  # Assign these normalized values to their respective species' .K parameters
  for (k in 1:nrow(rel_ab_control)) {
    species_name <- rel_ab_control$Species[k]
    k_index <- grep(paste0("^", species_name, "\\.K$"), names(flat_params))
    
    if (length(k_index) > 0) {
      old_value <- flat_params[k_index]
      flat_params[k_index] <- (normalised_values[k] + 0.0001) * K #add small value in case drawn K_i is 0, which would cause issues with the solver
      cat(sprintf("Updated %s from %f to %f using normalised value %f scaled by K %f\n", names(flat_params)[k_index], old_value, flat_params[k_index], normalised_values[k], K))
    }
  }
  
  # Check the sum of updated K values (which, because of +0.0001 to drawn values, as done above, will not align perfectly)
  #k_indices <- grep("\\.K$", names(flat_params))
  #sum_k_values <- sum(flat_params[k_indices])
  #print(sum_k_values)
  #print(K)
  
  #loop through each species in co_culture_correction
  for (j in 1:nrow(co_culture_correction)) {
    # Extract the species name and correction factor
    species_name <- co_culture_correction$species[j]
    correction_factor <- co_culture_correction$correction_factor[j]
    
    # Identify the corresponding growth rate parameter in flat_params
    #by matching the base species name (without .r)
    growth_rate_indices <- grep(paste0("^", species_name, "\\.r$"), names(flat_params))
    
    # Check the growth rate parameter and apply the correction factor 
    for (index in growth_rate_indices) {
      flat_params[index] <- flat_params[index] * correction_factor
    }
  }
  
  flat_params
  # Store parameters for each simulation
  input_params_list[[i]] <- c(sim_ID = i, flat_params)
  
  # Run the model for the first 24-hour cycle
  solution_cycle_1 <- ode(y = initial_conditions, times = seq(from = 0, to = 24, by = 0.1), func = closed.sir.model, parms = flat_params)
  
  # Dilution and second cycle
  end_of_cycle_1 <- solution_cycle_1[nrow(solution_cycle_1), -1]
  initial_conditions_cycle_2 <- end_of_cycle_1 / 50
  solution_cycle_2 <- ode(y = initial_conditions_cycle_2, times = seq(from = 24, to = 48, by = 0.1), func = closed.sir.model, parms = flat_params)
  
  # Combine and format results
  combined_solution <- rbind(as.data.frame(solution_cycle_1), as.data.frame(solution_cycle_2)[-1,])
  combined_solution$sim_ID <- rep(i, nrow(combined_solution))
  combined_solution <- combined_solution %>%
    gather(key = "Species", value = "Density", -time, -sim_ID) %>%
    dplyr::mutate(Hour = time) %>%
    dplyr::select(sim_ID, Hour, Species, Density)
  
  ##Append to sim_output
  sim_output <- rbind(sim_output, combined_solution)
}


##Combine all parameter data into a single dataframe
input_params <- do.call(rbind, input_params_list)

# Add a "Species" column 
sim_output$Species_name <- species_names[as.numeric(as.character(sim_output$Species))]


#View(input_params)
#View(sim_output)


#Transform sim_output so we have wide format by Species
sim_output_wide <- tidyr::pivot_wider(sim_output, 
                                      names_from = Species_name, 
                                      values_from = Density,
                                      id_cols = c(sim_ID, Hour))

#calc community OD per timepoint
sim_output_wide$Total_OD <- rowSums(sim_output_wide[, 3:34], na.rm = TRUE)
#calculate and add relative abundances here as well:
species_columns <- colnames(sim_output_wide)[3:34] 

for (species in species_columns) {
  sim_output_wide[[paste0("rel_", species)]] <- sim_output_wide[[species]] / sim_output_wide$Total_OD
}


#turn back into long format if interested in plotting relative abundances
cols_needed <- c("sim_ID", "Hour")

sim_output_long <- sim_output_wide %>% 
  dplyr::select(sim_ID, Hour, starts_with("rel_")) %>% 
  tidyr::pivot_longer(
    cols = starts_with("rel_"), 
    names_to = "Species", 
    values_to = "Relative_abundance",
    names_prefix = "rel_"
  ) 

str(sim_output_long)




##Plot output for any specific sim
ggplot(subset(sim_output, sim_ID == 1), aes(x = Hour, y = Density, group = Species_name, color = Species_name)) +
  geom_line(size = 1, alpha = 0.7) +
  scale_color_manual(values = species_colours) +
  labs(title = "Niclosamide = 0",
       x = "Time (hours)",
       y = "Population Density (OD)",
       color = "Species") +
  theme_minimal() +
  theme(legend.position = "right")

ggplot(subset(sim_output_long, sim_ID == 7), aes(x = Hour, y = Relative_abundance, group = Species, color = Species)) +
  geom_line(size = 1, alpha = 0.7) +
  scale_color_manual(values = species_colours) +
  labs(title = "Niclosamide = 0",
       x = "Time (hours)",
       y = "Relative abundance",
       color = "Species") +
  theme_minimal() +
  theme(legend.position = "right")


#calc mean and standard deviation across sims
sim_stats <- sim_output_long %>%
  dplyr::group_by(Hour, Species) %>%
  dplyr::summarise(
    Mean = mean(Relative_abundance),
    SD = sd(Relative_abundance),
    .groups = 'drop'
  )

# Prepare the data for plotting
plot_data <- sim_stats %>%
  dplyr::mutate(Upper = Mean + SD, Lower = Mean - SD)

ggplot(plot_data, aes(x = Hour, y = Mean, group = Species, color = Species)) +
  geom_ribbon(aes(ymin = Lower, ymax = Upper, fill = Species), colour = NA, alpha = 0.2) +  # Shaded area for SD
  geom_line(size = 1, alpha = 0.7) +  #Mean line
  scale_color_manual(values = species_colours) +
  scale_fill_manual(values = species_colours) +  #emsure consistent colours for lines and fills
  labs(title = "Mean and SD of Relative Abundance Across Simulations",
       subtitle = "Niclosamide = 0",
       x = "Time (hours)",
       y = "Relative abundance",
       color = "Species",
       fill = "Species") +
  theme_minimal() +
  theme(legend.position = "right")

#log-scaled mean trends
ggplot(plot_data, aes(x = Hour, y = log10(Mean + 0.0001), group = Species, color = Species)) +
  geom_line(size = 1, alpha = 0.7) +  #Mean line
  scale_color_manual(values = species_colours) +
  scale_fill_manual(values = species_colours) +  #ensure consistent colours for lines and fills
  labs(title = "Mean and SD of Relative Abundance Across Simulations",
       subtitle = "Niclosamide = 0",
       x = "Time (hours)",
       y = "Relative abundance",
       color = "Species",
       fill = "Species") +
  theme_minimal() +
  theme(legend.position = "right")





##Other drugs with monoculture sensitivity stored as changes to the AUC
unique(X16S_counts$drug)
unique(metabolomics_treatment_normalised$drug)

combined_monoculture_aucs$drug


##To create an idea of what to expect, we first calculate Bray-Curtis dissimilarity metrics (relative to control community) for each of the potential drugs at each tested concentration
Community_compositions_focus_drugs <- X16S_counts

#plot(Community_compositions_focus_drugs$concentration, Community_compositions_focus_drugs$maxOD)


#calculate mean relative abundances
mean_rel_abundances_focus_drugs <- Community_compositions_focus_drugs %>%
  dplyr::group_by(species, drug, concentration) %>%
  dplyr::summarise(mean_rel_abundance = mean(rel_abundance, na.rm = TRUE), .groups = 'drop')

mean_rel_abundances_focus_drugs_enhanced <- mean_rel_abundances_focus_drugs %>%
  dplyr::group_by(drug, concentration) %>%
  dplyr::summarize(
    Survivor_count = sum(mean_rel_abundance > 0.01, na.rm = TRUE),  # Count survivor species
    .groups = 'drop'  
  ) %>%
  dplyr::left_join(mean_rel_abundances_focus_drugs, by = c("drug", "concentration"))  

mean_maxOD_focus_drugs <- Community_compositions_focus_drugs %>%
  dplyr::group_by(drug, concentration) %>%
  dplyr::summarize(
    mean_maxOD = mean(maxOD, na.rm = TRUE),    
    sd_maxOD = sd(maxOD, na.rm = TRUE),       
    .groups = 'drop'                          
  )


enhanced_mean_maxOD_focus_drugs <- mean_maxOD_focus_drugs %>%
  dplyr::left_join(mean_rel_abundances_focus_drugs_enhanced %>% select(drug, concentration, Survivor_count), 
            by = c("drug", "concentration"))

enhanced_mean_maxOD_focus_drugs <- enhanced_mean_maxOD_focus_drugs %>%
  dplyr::distinct()

##add the baseline for each drug to create a complete line plot:
zero_concentration_row <- enhanced_mean_maxOD_focus_drugs %>%
  filter(concentration == 0)

unique_drugs <- distinct(enhanced_mean_maxOD_focus_drugs, drug)

new_rows <- unique_drugs %>%
  dplyr::left_join(zero_concentration_row %>% select(-drug), by = character()) %>%
  dplyr::mutate(concentration = 0)  
  
enhanced_mean_maxOD_focus_drugs_complete <- bind_rows(enhanced_mean_maxOD_focus_drugs, new_rows)
enhanced_mean_maxOD_focus_drugs_complete1 <- subset(enhanced_mean_maxOD_focus_drugs_complete, drug != "control")


ggplot(enhanced_mean_maxOD_focus_drugs_complete1, aes(x = concentration, y = mean_maxOD, group = drug, color = drug)) +
  geom_line() +  
  geom_point() + 
  labs(title = "mean_maxOD across different concentrations for each drug",
       x = "Concentration",
       y = "mean_maxOD",
       color = "Drug") +
  theme_minimal() +  
  theme(legend.position = "right")  

#ggplot(subset(enhanced_mean_maxOD_focus_drugs_complete1, concentration < 90), 
ggplot(enhanced_mean_maxOD_focus_drugs_complete1, 
       aes(x = concentration, y = mean_maxOD, group = drug, color = drug)) +
  geom_ribbon(aes(ymin = mean_maxOD - sd_maxOD, ymax = mean_maxOD + sd_maxOD, fill = drug), 
              alpha = 0.2, color = NA) +  # Set border color to NA to make it transparent
  geom_line(linetype = "dashed") +  
  geom_point() + 
  labs(title = "",
       x = "Concentration",
       y = "Max OD of community",
       color = "Drug",
       fill = "Drug") +
  theme_minimal() +  
  theme(legend.position = "right")



c30 <- c(
  "dodgerblue2", 
  "#E31A1C", # red
  "green4",
  "#6A3D9A", # purple
  "#FF7F00", # orange
  "grey40", 
  "gold1",
  "skyblue", 
  "#FB9A99", # lt pink
  "palegreen2",
  "#CAB2D6", # lt purple
  "#FDBF6F", # lt orange
  "gray70", 
  "khaki2",
  "maroon", 
  "orchid1", 
  "deeppink1", 
  "blue1", 
  "steelblue4",
  "darkturquoise", 
  "green1", 
  "yellow4", 
  "yellow3",
  "darkorange4", 
  "brown",
  "navy",
  "#095859",
  "yellow",
  "coral2",
  "purple",
  "black"
)
pie(rep(1, 31), col = c30)


##assigning unique colours to the drugs:
drugs <- c("Acarbose", "Amlodipine", "Aprepitant", "Aripiprazole", "Azithromycin",
           "Chlorpromazine", "Ciprofloxacin", "Clomiphene", "Diacerein", "Dienestrol", 
           "Doxycycline", "Ebselen", "Entacapone", "Felodipine", "Ketoconazole", 
           "Lansoprazole", "Loratadine", "Loxapine", "Mecillinam", "Mefloquine", 
           "Methotrexate", "Niclosamide","Nifurtimox", "Olanzapine", "Omeprazole", 
           "Oxolinic acid", "Sertindole", "Simvastatin", "Tamoxifen", "beta-estradiol 17-valerate", "control")

# Manually defined colour vector
colours <- c30

drug_colours <- setNames(colours, drugs)

#ggplot(subset(enhanced_mean_maxOD_focus_drugs_complete1, concentration < 90), 
ggplot(enhanced_mean_maxOD_focus_drugs_complete1, 
       aes(x = concentration + 0.01, y = mean_maxOD, group = drug, color = drug)) +
  geom_ribbon(aes(ymin = mean_maxOD - sd_maxOD, ymax = mean_maxOD + sd_maxOD, fill = drug), 
              alpha = 0.2, color = NA) +  # Set border color to NA to make it transparent
  geom_line(linetype = "dashed", alpha = 0.6, size = 0.8) +  
  scale_x_log10() +  
  scale_color_manual(values = drug_colours) +  
  scale_fill_manual(values = drug_colours) +  
  geom_point(alpha = 0.8) + 
  labs(title = "",
       x = "log10(Concentration + 0.01)",
       y = "Max OD of community",
       color = "Drug",
       fill = "Drug") +
  theme_minimal() +  
  theme(legend.position = "right")



ggplot(subset(enhanced_mean_maxOD_focus_drugs_complete1, concentration < 90), aes(x = concentration, y = Survivor_count, group = drug, color = drug)) +
  geom_line(linetype = "dashed", alpha = 0.6, size = 1.2) +  
  geom_point(alpha = 0.8) + 
  labs(title = "",
       x = "Concentration",
       y = "Survivor (>1%) count",
       color = "Drug") +
  theme_minimal() +  
  scale_y_continuous(breaks = function(x) pretty(x, n = 10, min.n = 1)) +  
  theme(legend.position = "right")  

ggplot(subset(enhanced_mean_maxOD_focus_drugs_complete1, concentration < 90), aes(x = concentration + 0.01, y = Survivor_count, group = drug, color = drug)) +
  geom_line(linetype = "dashed", alpha = 0.7, size = 0.8) +  
  scale_x_log10() +  
  scale_color_manual(values = drug_colours) +  
  geom_point(alpha = 0.7, size = 1.7) + 
  labs(title = "",
       x = "log10(Concentration + 0.01)",
       y = "Survivor (>1%) count",
       color = "Drug") +
  theme_minimal() +  
  scale_y_continuous(breaks = function(x) pretty(x, n = 10, min.n = 1)) +  
  theme(legend.position = "right")  


#Ensure 'control' is included as a drug type; if not, adjust this step accordingly
enhanced_mean_maxOD_focus_drugs <- enhanced_mean_maxOD_focus_drugs %>%
  dplyr::mutate(drug = as.factor(drug),
         drug = fct_relevel(drug, "control", after = Inf))  #move 'control' to the end

#Perform the linear regression
fit_OD_vs_survivors <- lm(mean_maxOD ~ Survivor_count, data = enhanced_mean_maxOD_focus_drugs)

#Calculate R^2 and extract p-value
summary_fit <- summary(fit_OD_vs_survivors)
r_squared <- summary_fit$r.squared
p_value <- summary_fit$coefficients[2, 4]  


###quite similar trends:
ggplot(enhanced_mean_maxOD_focus_drugs, 
       aes(x = Survivor_count, y = mean_maxOD, color = drug)) +
  geom_smooth(method = "lm", se = FALSE, color = "grey", alpha = 0.5, linetype = "dashed") + 
  geom_point(aes(size =concentration), alpha = 0.7, stroke = 1.2) +  
  #geom_point(aes(shape = as.factor(concentration)), size = 3, alpha = 0.7, stroke = 1.2) +  
  #scale_shape_manual(values = c(0, 1, 2, 5, 6, 8, 9, 10, 12, 14, 7, 11, 4)) + 
  scale_color_manual(values = drug_colours) +  
  labs(title = "",
       x = "Survivor (>1%) Count",
       y = "Community mean max OD",
       color = "Drug",
       shape = "Concentration") +
  theme_minimal() +
  theme(legend.position = "right") + 
  scale_x_continuous(breaks = function(x) pretty(x, n = 10, min.n = 1)) +  
  annotate("text", x = Inf, y = Inf, label = sprintf("R^2 = %.2f, p = %.3f", r_squared, p_value),
           hjust = 1.4, vjust = 2.1, size = 4, color = "black")


community_matrix_focus_drugs <- mean_rel_abundances_focus_drugs %>%
  tidyr::pivot_wider(names_from = species, values_from = mean_rel_abundance, values_fill = list(mean_rel_abundance = 0))


control_data_focus_drugs <- community_matrix_focus_drugs %>% filter(drug == 'control')
treatment_data_focus_drugs <- community_matrix_focus_drugs %>% filter(drug != 'control')



results_focus_drugs <- data.frame(drug = character(),
                      concentration = numeric(),
                      dissimilarity = numeric(),
                      stringsAsFactors = FALSE)

# Calculate Bray-Curtis dissimilarity for each drug and concentration
for (i in 1:nrow(treatment_data_focus_drugs)) {
  treatment_row <- treatment_data_focus_drugs[i, ]
  
  # Combine the control and treatment row
  combined_data <- rbind(control_data_focus_drugs, treatment_row)
  
  # Ensure the data is numeric only for the species columns
  combined_numeric_data <- combined_data[, -(1:2)]  #adjust index if more non-species columns
  
  # Calculate Bray-Curtis dissimilarity
  dissimilarity_value <- vegdist(combined_numeric_data, method = "bray")[1]
  
  # Store the results
  results_focus_drugs <- rbind(results_focus_drugs, data.frame(
    drug = treatment_row$drug,
    concentration = treatment_row$concentration,
    dissimilarity = dissimilarity_value
  ))
}





unique_drugs <- unique(results_focus_drugs$drug)
origin_rows <- data.frame(drug = unique_drugs,
                          concentration = 0,
                          dissimilarity = 0,
                          stringsAsFactors = FALSE)

#combine with existing results
extended_results <- bind_rows(origin_rows, results_focus_drugs)

# #Plotting the results
# ggplot(subset(extended_results, concentration <90), aes(x = concentration, y = dissimilarity, color = drug, group = drug)) +
#   geom_line(alpha = 0.8, linetype = "dashed") +  
#   geom_point(size = 1.5, alpha = 0.7) +
#   labs(x = "Concentration", y = "Bray-Curtis Dissimilarity to Control", title = "Dissimilarity Across Drug Concentrations") +
#   theme_minimal() +
#   scale_x_continuous(breaks = scales::pretty_breaks(n = 10)) +
#   scale_y_continuous(limits = c(0, max(extended_results$dissimilarity) * 1.1)) 

##with correct colour scheme:
ggplot(extended_results, aes(x = concentration + 0.01, y = dissimilarity, color = drug, group = drug)) +
  geom_line(alpha = 0.7, linetype = "dashed") +  
  geom_point(size = 1.7, alpha = 0.7) +
  scale_color_manual(values = drug_colours) +  
  scale_x_log10() +  
  labs(x = "log10(Concentration + 0.01)", y = "Bray-Curtis Dissimilarity to Control", title = "") +
  theme_minimal() +
  scale_y_continuous(limits = c(0, max(extended_results$dissimilarity) * 1.1)) 


str(extended_results)

str(combined_monoculture_aucs)
combined_monoculture_aucs$abs_change_AUC <- abs(1 - combined_monoculture_aucs$AUC)

AUCs_per_drug <- combined_monoculture_aucs %>%
  dplyr::group_by(drug, conc) %>%
  dplyr::summarise(mean_abs_change_AUC = mean(abs_change_AUC, na.rm = TRUE), sd_abs_change_AUC = sd(abs_change_AUC, na.rm = TRUE))

AUCs_per_drug$concentration <- AUCs_per_drug$conc
str(AUCs_per_drug)


AUCs_and_BC <- merge(AUCs_per_drug, extended_results, by.x = c("drug", "conc"), by.y = c("drug", "concentration"))

str(AUCs_and_BC)


#Ecoli_AUCs <- subset(combined_monoculture_aucs, species_name == "Escherichia coli ED1a")
#Ecoli_AUCs_Nicl <- subset(Ecoli_AUCs, drug == "Niclosamide")
#plot(Ecoli_AUCs_Nicl$conc, Ecoli_AUCs_Nicl$AUC)

##Does degree of effect of drug*conc on monoculture growth relate to dissimilarity in community?
fit_BC_vs_Mean_AUC <- lm(mean_abs_change_AUC ~ dissimilarity, data = AUCs_and_BC)

# Calculate R^2 and extract p-value
summary_fit_BC_vs_Mean_AUC <- summary(fit_BC_vs_Mean_AUC)
r_squared_BC_vs_Mean_AUC <- summary_fit_BC_vs_Mean_AUC$r.squared
p_value_BC_vs_Mean_AUC <- summary_fit_BC_vs_Mean_AUC$coefficients[2, 4]  

##Bray-curtis dissimilarity versus the mean impact of a drug on member monoculture growth (AUC)
ggplot(AUCs_and_BC, aes(x = mean_abs_change_AUC, y = dissimilarity, color = drug, size = concentration)) +
  geom_smooth(method = "lm", se = FALSE, color = "grey", alpha = 0.5, linetype = "dashed") + 
  geom_point(alpha = 0.65) +  
  theme_minimal() +      
  scale_color_manual(values = drug_colours) +  
  labs(title = "",
       x = "Mean abs. impact on AUC monocultures",
       y = "Bray-Curtis Dissimilarity with Control Community",
       size = "Concentration") +  # Labelling the size aesthetic
  scale_size_continuous(range = c(1, 10)) +  # Adjusting the size range for visibility
  theme(legend.position = "right") +
  annotate("text", x = Inf, y = Inf, label = sprintf("R^2 = %.2f, p = %.3f", r_squared_BC_vs_Mean_AUC, p_value_BC_vs_Mean_AUC),
           hjust = 1.4, vjust = 2.1, size = 4, color = "black")


##Does Diversity of effect of drug*conc on monoculture growth relate to dissimilarity in community?

fit_BC_vs_SD_AUC <- lm(sd_abs_change_AUC ~ dissimilarity, data = AUCs_and_BC)

# Calculate R^2 and extract p-value
summary_fit_BC_vs_SD_AUC <- summary(fit_BC_vs_SD_AUC)
r_squared_BC_vs_SD_AUC <- summary_fit_BC_vs_SD_AUC$r.squared
p_value_BC_vs_SD_AUC <- summary_fit_BC_vs_SD_AUC$coefficients[2, 4]  

##Bray-curtis dissimilarity versus the standard deviation of impact of a drug on member monoculture growth (AUC)
ggplot(AUCs_and_BC, aes(x = sd_abs_change_AUC, y = dissimilarity, color = drug, size = concentration)) +
  geom_smooth(method = "lm", se = FALSE, color = "grey", alpha = 0.5, linetype = "dashed") + 
  geom_point(alpha = 0.6) +  
  theme_minimal() +      
  scale_color_manual(values = drug_colours) +  
  labs(title = "",
       x = "SD abs. impact on AUC monocultures",
       y = "Dissimilarity",
       size = "Concentration") +  
  scale_size_continuous(range = c(1, 10)) +  
  theme(legend.position = "right") +
  annotate("text", x = Inf, y = Inf, label = sprintf("R^2 = %.2f, p = %.3f", r_squared_BC_vs_SD_AUC, p_value_BC_vs_SD_AUC),
           hjust = 1.4, vjust = 2.1, size = 4, color = "black")




######## 
#USING AUC INFO TO DEDUCE SENSITIVITY TO DRUGS IN MONOCULTURE


##First: fit trend to metabolomics data of each drug

#Accounting for background degradation of the drug
#View(metabolomics_treatment_normalised)
#View(metabolomics_MGAM_normalised)   

unique(metabolomics_MGAM_normalised$drug)
#missing:beta-estradiol 17-valerate, Diacerein, and Acarbose
#Average effect of others for this drug?

##Since we are interested in both bioaccumulation as well as biotransformation as sources of community-level drug concentration reduction, 
#we here only include supernatant (SN) data, except for t0 (where the only sample  type was WC because there was no biotic activity yet)
#If we included WC, then we would miss/underestimate the contribution of bioaccumulation to the effective reduction of the drug concentration in solution

metabolomics_treatment_normalised_1 <- subset(metabolomics_treatment_normalised, ifelse(time_point != "t0", sample_type == "SN", sample_type == "WC"))

#Chlorpromazine
metabolomics_MGAM_normalised_Chlorpromazine <- subset(metabolomics_MGAM_normalised, drug == "Chlorpromazine")
metabolomics_treatment_normalised_Chlorpromazine <- subset(metabolomics_treatment_normalised_1, drug == "Chlorpromazine")

#Felodipine
metabolomics_MGAM_normalised_Felodipine <- subset(metabolomics_MGAM_normalised, drug == "Felodipine")
metabolomics_treatment_normalised_Felodipine <- subset(metabolomics_treatment_normalised_1, drug == "Felodipine")

#Amlodipine
metabolomics_MGAM_normalised_Amlodipine <- subset(metabolomics_MGAM_normalised, drug == "Amlodipine")
metabolomics_treatment_normalised_Amlodipine <- subset(metabolomics_treatment_normalised_1, drug == "Amlodipine")

#Aprepitant
metabolomics_MGAM_normalised_Aprepitant <- subset(metabolomics_MGAM_normalised, drug == "Aprepitant")
metabolomics_treatment_normalised_Aprepitant <- subset(metabolomics_treatment_normalised_1, drug == "Aprepitant")

#Aripiprazole
metabolomics_MGAM_normalised_Aripiprazole <- subset(metabolomics_MGAM_normalised, drug == "Aripiprazole")
metabolomics_treatment_normalised_Aripiprazole <- subset(metabolomics_treatment_normalised_1, drug == "Aripiprazole")

#Methotrexate
metabolomics_MGAM_normalised_Methotrexate <- subset(metabolomics_MGAM_normalised, drug == "Methotrexate")
#set y = 1 for t = 0 for following to not get errors in fitting asymptomatic:
metabolomics_MGAM_normalised_Methotrexate$y[1] <- 1
metabolomics_treatment_normalised_Methotrexate <- subset(metabolomics_treatment_normalised_1, drug == "Methotrexate")

#Oxolinic acid
metabolomics_MGAM_normalised_Oxolinic_acid <- subset(metabolomics_MGAM_normalised, drug == "Oxolinic acid")
metabolomics_treatment_normalised_Oxolinic_acid <- subset(metabolomics_treatment_normalised_1, drug == "Oxolinic acid")

# Azithromycin
metabolomics_MGAM_normalised_Azithromycin <- subset(metabolomics_MGAM_normalised, drug == "Azithromycin")
metabolomics_treatment_normalised_Azithromycin <- subset(metabolomics_treatment_normalised_1, drug == "Azithromycin")

# Ciprofloxacin
metabolomics_MGAM_normalised_Ciprofloxacin <- subset(metabolomics_MGAM_normalised, drug == "Ciprofloxacin")
metabolomics_treatment_normalised_Ciprofloxacin <- subset(metabolomics_treatment_normalised_1, drug == "Ciprofloxacin")

# Clomiphene
metabolomics_MGAM_normalised_Clomiphene <- subset(metabolomics_MGAM_normalised, drug == "Clomiphene")
metabolomics_treatment_normalised_Clomiphene <- subset(metabolomics_treatment_normalised_1, drug == "Clomiphene")

# Dienestrol
metabolomics_MGAM_normalised_Dienestrol <- subset(metabolomics_MGAM_normalised, drug == "Dienestrol")
metabolomics_treatment_normalised_Dienestrol <- subset(metabolomics_treatment_normalised_1, drug == "Dienestrol")

# Doxycycline
metabolomics_MGAM_normalised_Doxycycline <- subset(metabolomics_MGAM_normalised, drug == "Doxycycline")
metabolomics_treatment_normalised_Doxycycline <- subset(metabolomics_treatment_normalised_1, drug == "Doxycycline")

# Ebselen
metabolomics_MGAM_normalised_Ebselen <- subset(metabolomics_MGAM_normalised, drug == "Ebselen")
metabolomics_treatment_normalised_Ebselen <- subset(metabolomics_treatment_normalised_1, drug == "Ebselen")

# Entacapone
metabolomics_MGAM_normalised_Entacapone <- subset(metabolomics_MGAM_normalised, drug == "Entacapone")
metabolomics_treatment_normalised_Entacapone <- subset(metabolomics_treatment_normalised_1, drug == "Entacapone")

# Ketoconazole
metabolomics_MGAM_normalised_Ketoconazole <- subset(metabolomics_MGAM_normalised, drug == "Ketoconazole")
metabolomics_treatment_normalised_Ketoconazole <- subset(metabolomics_treatment_normalised_1, drug == "Ketoconazole")

# Lansoprazole
metabolomics_MGAM_normalised_Lansoprazole <- subset(metabolomics_MGAM_normalised, drug == "Lansoprazole")
metabolomics_treatment_normalised_Lansoprazole <- subset(metabolomics_treatment_normalised_1, drug == "Lansoprazole")

# Loratadine
metabolomics_MGAM_normalised_Loratadine <- subset(metabolomics_MGAM_normalised, drug == "Loratadine")
metabolomics_treatment_normalised_Loratadine <- subset(metabolomics_treatment_normalised_1, drug == "Loratadine")

# Loxapine
metabolomics_MGAM_normalised_Loxapine <- subset(metabolomics_MGAM_normalised, drug == "Loxapine")
metabolomics_treatment_normalised_Loxapine <- subset(metabolomics_treatment_normalised_1, drug == "Loxapine")

# Mecillinam
metabolomics_MGAM_normalised_Mecillinam <- subset(metabolomics_MGAM_normalised, drug == "Mecillinam")
#set y = 1 for t = 0 for following to not get errors in fitting asymptomatic:
metabolomics_MGAM_normalised_Mecillinam$y[1] <- 1
metabolomics_treatment_normalised_Mecillinam <- subset(metabolomics_treatment_normalised_1, drug == "Mecillinam")

# Mefloquine
metabolomics_MGAM_normalised_Mefloquine <- subset(metabolomics_MGAM_normalised, drug == "Mefloquine")
metabolomics_treatment_normalised_Mefloquine <- subset(metabolomics_treatment_normalised_1, drug == "Mefloquine")

# Niclosamide
metabolomics_MGAM_normalised_Niclosamide <- subset(metabolomics_MGAM_normalised, drug == "Niclosamide")
metabolomics_treatment_normalised_Niclosamide <- subset(metabolomics_treatment_normalised_1, drug == "Niclosamide")

# Nifurtimox
metabolomics_MGAM_normalised_Nifurtimox <- subset(metabolomics_MGAM_normalised, drug == "Nifurtimox")
metabolomics_treatment_normalised_Nifurtimox <- subset(metabolomics_treatment_normalised_1, drug == "Nifurtimox")

# Olanzapine
metabolomics_MGAM_normalised_Olanzapine <- subset(metabolomics_MGAM_normalised, drug == "Olanzapine")
metabolomics_treatment_normalised_Olanzapine <- subset(metabolomics_treatment_normalised_1, drug == "Olanzapine")

# Omeprazole
metabolomics_MGAM_normalised_Omeprazole <- subset(metabolomics_MGAM_normalised, drug == "Omeprazole")
metabolomics_treatment_normalised_Omeprazole <- subset(metabolomics_treatment_normalised_1, drug == "Omeprazole")

# Sertindole
metabolomics_MGAM_normalised_Sertindole <- subset(metabolomics_MGAM_normalised, drug == "Sertindole")
metabolomics_treatment_normalised_Sertindole <- subset(metabolomics_treatment_normalised_1, drug == "Sertindole")

# Simvastatin
metabolomics_MGAM_normalised_Simvastatin <- subset(metabolomics_MGAM_normalised, drug == "Simvastatin")
metabolomics_treatment_normalised_Simvastatin <- subset(metabolomics_treatment_normalised_1, drug == "Simvastatin")

# Tamoxifen
metabolomics_MGAM_normalised_Tamoxifen <- subset(metabolomics_MGAM_normalised, drug == "Tamoxifen")
metabolomics_treatment_normalised_Tamoxifen <- subset(metabolomics_treatment_normalised_1, drug == "Tamoxifen")


#inspecting community specificity
ggplot(data = metabolomics_treatment_normalised_Loxapine, aes(x = time, y = y, color = community)) +
  geom_point(alpha = 0.7) + 
  labs(x = "Time (hr)", y = "Y (scaled)", title = "Y vs. Time Coloured by Community") +
  theme_minimal() +  
  scale_color_manual(values = c("C1" = "navy", "C2" = "red")) 


ggplot(data = metabolomics_treatment_normalised_Chlorpromazine, aes(x = time, y = y, color = sample_type)) +
  geom_point(alpha = 0.7) + 
  labs(x = "Time (hr)", y = "Y (scaled)", title = "Y vs. Time Coloured by Community") +
  theme_minimal() 


##first, we collect background and community degradation for each drug

library(minpack.lm) # For nlsLM function

max_concentrations <- tapply(metabolomics_MGAM_normalised$concentration, metabolomics_MGAM_normalised$drug, max)
max_concentrations1 <- tapply(metabolomics_treatment_normalised$concentration, metabolomics_treatment_normalised$drug, max)


# Define a function to fit and plot the drug degradation curve
fit_drug_degradation <- function(drug_name, dataframe, max_concentration) {
  # Subset the data for the maximum concentration
  subset_data <- subset(dataframe, concentration == max_concentration)
  
  # Handle time values, adding a small number if time is 0
  time <- as.numeric(subset_data$time)
  x <- ifelse(time == 0, time + 0.0001, time)
  
  # Extract the response variable
  y <- subset_data$y
  
  # Initial plot
  plot(x, y, xlab='Time (hr)', ylab=paste(drug_name, "(scaled)"), pch=16, cex = 1.5, col = rgb(red = 0, green = 0, blue = 1, alpha = 0.3), ylim=c(0, 1.2))
  
  # Calculate means at specific times
  mean_y_at_x0 <- mean(y[x == 0.0001])
  mean_y_at_x10 <- mean(y[x == 10])
  
  # Define the asymptotic function
  asymptotic_func <- function(x, c, d, e) {
      d - (d - c) * exp(-e * x)
  }
  
  ##Fit the model
  bfit_asymptotic <- nlsLM(y ~ asymptotic_func(x, mean_y_at_x0, mean_y_at_x10, e), 
                           start = list(e = 1), data = subset_data)
  
  ##Extract coefficients and calculate RSS
  asymptotic_coefs <- coef(bfit_asymptotic)
  asymptotic_rss <- sum(resid(bfit_asymptotic)^2)
  
  ##Add curve to the plot
  curve(asymptotic_func(x, mean_y_at_x0, mean_y_at_x10, asymptotic_coefs['e']), 
        add = TRUE, col = "navy", lwd = 2, lty = 2)
  
  ##Predict y at 24 hours (duration of complete growth cycle)
  predicted_y_at_24 <- asymptotic_func(24, mean_y_at_x0, mean_y_at_x10, asymptotic_coefs['e'])
  
  sd_endpoint_y <- sd(y[x == 10])
  sd_start_y <- sd(y[x == 0.0001])
  
  ##Return results
  list(
    coefs = asymptotic_coefs,
    rss = asymptotic_rss,
    predicted_y_at_24 = predicted_y_at_24,
    sd_endpoint_y = sd_endpoint_y,
    sd_start_y = sd_start_y,
    max_concentration = max_concentration
  )
}


#Asymptotic fitting for all 27 drugs measured:

#1) Chlorpromazine
Community_degradation_Chlorpromazine <- fit_drug_degradation("Chlorpromazine", metabolomics_treatment_normalised_Chlorpromazine, max_concentrations1[["Chlorpromazine"]])
Background_degradation_Chlorpromazine <- fit_drug_degradation("Chlorpromazine", metabolomics_MGAM_normalised_Chlorpromazine, max_concentrations[["Chlorpromazine"]])

#2) Sertindole
Community_degradation_Sertindole <- fit_drug_degradation("Sertindole", metabolomics_treatment_normalised_Sertindole, max_concentrations1[["Sertindole"]])
Background_degradation_Sertindole <- fit_drug_degradation("Sertindole", metabolomics_MGAM_normalised_Sertindole, max_concentrations[["Sertindole"]])

#3) Amlodipine
Community_degradation_Amlodipine <- fit_drug_degradation("Amlodipine", metabolomics_treatment_normalised_Amlodipine, max_concentrations1[["Amlodipine"]])
Background_degradation_Amlodipine <- fit_drug_degradation("Amlodipine", metabolomics_MGAM_normalised_Amlodipine, max_concentrations[["Amlodipine"]])

#4) Entacapone
Community_degradation_Entacapone <- fit_drug_degradation("Entacapone", metabolomics_treatment_normalised_Entacapone, max_concentrations1[["Entacapone"]])
Background_degradation_Entacapone <- fit_drug_degradation("Entacapone", metabolomics_MGAM_normalised_Entacapone, max_concentrations[["Entacapone"]])

#5) Felodipine
Community_degradation_Felodipine <- fit_drug_degradation("Felodipine", metabolomics_treatment_normalised_Felodipine, max_concentrations1[["Felodipine"]])
Background_degradation_Felodipine <- fit_drug_degradation("Felodipine", metabolomics_MGAM_normalised_Felodipine, max_concentrations[["Felodipine"]])

#6) Ketoconazole
Community_degradation_Ketoconazole <- fit_drug_degradation("Ketoconazole", metabolomics_treatment_normalised_Ketoconazole, max_concentrations1[["Ketoconazole"]])
Background_degradation_Ketoconazole <- fit_drug_degradation("Ketoconazole", metabolomics_MGAM_normalised_Ketoconazole, max_concentrations[["Ketoconazole"]])

#7) Lansoprazole
Community_degradation_Lansoprazole <- fit_drug_degradation("Lansoprazole", metabolomics_treatment_normalised_Lansoprazole, max_concentrations1[["Lansoprazole"]])
Background_degradation_Lansoprazole <- fit_drug_degradation("Lansoprazole", metabolomics_MGAM_normalised_Lansoprazole, max_concentrations[["Lansoprazole"]])

#8) Loratadine
Community_degradation_Loratadine <- fit_drug_degradation("Loratadine", metabolomics_treatment_normalised_Loratadine, max_concentrations1[["Loratadine"]])
Background_degradation_Loratadine <- fit_drug_degradation("Loratadine", metabolomics_MGAM_normalised_Loratadine, max_concentrations[["Loratadine"]])

#9) Loxapine
Community_degradation_Loxapine <- fit_drug_degradation("Loxapine", metabolomics_treatment_normalised_Loxapine, max_concentrations1[["Loxapine"]])
Background_degradation_Loxapine <- fit_drug_degradation("Loxapine", metabolomics_MGAM_normalised_Loxapine, max_concentrations[["Loxapine"]])

#10) Omeprazole
Community_degradation_Omeprazole <- fit_drug_degradation("Omeprazole", metabolomics_treatment_normalised_Omeprazole, max_concentrations1[["Omeprazole"]])
Background_degradation_Omeprazole <- fit_drug_degradation("Omeprazole", metabolomics_MGAM_normalised_Omeprazole, max_concentrations[["Omeprazole"]])

#11) Aprepitant
Community_degradation_Aprepitant <- fit_drug_degradation("Aprepitant", metabolomics_treatment_normalised_Aprepitant, max_concentrations1[["Aprepitant"]])
Background_degradation_Aprepitant <- fit_drug_degradation("Aprepitant", metabolomics_MGAM_normalised_Aprepitant, max_concentrations[["Aprepitant"]])

#12) Aripiprazole
Community_degradation_Aripiprazole <- fit_drug_degradation("Aripiprazole", metabolomics_treatment_normalised_Aripiprazole, max_concentrations1[["Aripiprazole"]])
Background_degradation_Aripiprazole <- fit_drug_degradation("Aripiprazole", metabolomics_MGAM_normalised_Aripiprazole, max_concentrations[["Aripiprazole"]])

#13) Clomiphene
Community_degradation_Clomiphene <- fit_drug_degradation("Clomiphene", metabolomics_treatment_normalised_Clomiphene, max_concentrations1[["Clomiphene"]])
Background_degradation_Clomiphene <- fit_drug_degradation("Clomiphene", metabolomics_MGAM_normalised_Clomiphene, max_concentrations[["Clomiphene"]])

#14) Ciprofloxacin
Community_degradation_Ciprofloxacin <- fit_drug_degradation("Ciprofloxacin", metabolomics_treatment_normalised_Ciprofloxacin, max_concentrations1[["Ciprofloxacin"]])
Background_degradation_Ciprofloxacin <- fit_drug_degradation("Ciprofloxacin", metabolomics_MGAM_normalised_Ciprofloxacin, max_concentrations[["Ciprofloxacin"]])

#15) Dienestrol
Community_degradation_Dienestrol <- fit_drug_degradation("Dienestrol", metabolomics_treatment_normalised_Dienestrol, max_concentrations1[["Dienestrol"]])
Background_degradation_Dienestrol <- fit_drug_degradation("Dienestrol", metabolomics_MGAM_normalised_Dienestrol, max_concentrations[["Dienestrol"]])

#16) Mecillinam
Community_degradation_Mecillinam <- fit_drug_degradation("Mecillinam", metabolomics_treatment_normalised_Mecillinam, max_concentrations1[["Mecillinam"]])
Background_degradation_Mecillinam <- fit_drug_degradation("Mecillinam", metabolomics_MGAM_normalised_Mecillinam, max_concentrations[["Mecillinam"]])

#17) Mefloquine
Community_degradation_Mefloquine <- fit_drug_degradation("Mefloquine", metabolomics_treatment_normalised_Mefloquine, max_concentrations1[["Mefloquine"]])
Background_degradation_Mefloquine <- fit_drug_degradation("Mefloquine", metabolomics_MGAM_normalised_Mefloquine, max_concentrations[["Mefloquine"]])

#18) Methotrexate
Community_degradation_Methotrexate <- fit_drug_degradation("Methotrexate", metabolomics_treatment_normalised_Methotrexate, max_concentrations1[["Methotrexate"]])
Background_degradation_Methotrexate <- fit_drug_degradation("Methotrexate", metabolomics_MGAM_normalised_Methotrexate, max_concentrations[["Methotrexate"]])

#19) Oxolinic acid
Community_degradation_Oxolinic_acid <- fit_drug_degradation("Oxolinic acid", metabolomics_treatment_normalised_Oxolinic_acid, max_concentrations1[["Oxolinic acid"]])
Background_degradation_Oxolinic_acid <- fit_drug_degradation("Oxolinic acid", metabolomics_MGAM_normalised_Oxolinic_acid, max_concentrations[["Oxolinic acid"]])

#20) Simvastatin
Community_degradation_Simvastatin <- fit_drug_degradation("Simvastatin", metabolomics_treatment_normalised_Simvastatin, max_concentrations1[["Simvastatin"]])
Background_degradation_Simvastatin <- fit_drug_degradation("Simvastatin", metabolomics_MGAM_normalised_Simvastatin, max_concentrations[["Simvastatin"]])

#21) Tamoxifen
Community_degradation_Tamoxifen <- fit_drug_degradation("Tamoxifen", metabolomics_treatment_normalised_Tamoxifen, max_concentrations1[["Tamoxifen"]])
Background_degradation_Tamoxifen <- fit_drug_degradation("Tamoxifen", metabolomics_MGAM_normalised_Tamoxifen, max_concentrations[["Tamoxifen"]])

#22) Niclosamide
Community_degradation_Niclosamide <- fit_drug_degradation("Niclosamide", metabolomics_treatment_normalised_Niclosamide, max_concentrations1[["Niclosamide"]])
Background_degradation_Niclosamide <- fit_drug_degradation("Niclosamide", metabolomics_MGAM_normalised_Niclosamide, max_concentrations[["Niclosamide"]])

#23) Nifurtimox
Community_degradation_Nifurtimox <- fit_drug_degradation("Nifurtimox", metabolomics_treatment_normalised_Nifurtimox, max_concentrations1[["Nifurtimox"]])
Background_degradation_Nifurtimox <- fit_drug_degradation("Nifurtimox", metabolomics_MGAM_normalised_Nifurtimox, max_concentrations[["Nifurtimox"]])

#24) Ebselen
Community_degradation_Ebselen <- fit_drug_degradation("Ebselen", metabolomics_treatment_normalised_Ebselen, max_concentrations1[["Ebselen"]])
Background_degradation_Ebselen <- fit_drug_degradation("Ebselen", metabolomics_MGAM_normalised_Ebselen, max_concentrations[["Ebselen"]])

#25) Azithromycin
Community_degradation_Azithromycin <- fit_drug_degradation("Azithromycin", metabolomics_treatment_normalised_Azithromycin, max_concentrations1[["Azithromycin"]])
Background_degradation_Azithromycin <- fit_drug_degradation("Azithromycin", metabolomics_MGAM_normalised_Azithromycin, max_concentrations[["Azithromycin"]])

#26) Doxycycline
Community_degradation_Doxycycline <- fit_drug_degradation("Doxycycline", metabolomics_treatment_normalised_Doxycycline, max_concentrations1[["Doxycycline"]])
Background_degradation_Doxycycline <- fit_drug_degradation("Doxycycline", metabolomics_MGAM_normalised_Doxycycline, max_concentrations[["Doxycycline"]])

#27) Olanzapine
Community_degradation_Olanzapine <- fit_drug_degradation("Olanzapine", metabolomics_treatment_normalised_Olanzapine, max_concentrations1[["Olanzapine"]])
Background_degradation_Olanzapine <- fit_drug_degradation("Olanzapine", metabolomics_MGAM_normalised_Olanzapine, max_concentrations[["Olanzapine"]])


##All drug effects in a dataframe
drug_dynamics <- data.frame(
  Drug = c("Olanzapine", "Sertindole", "Amlodipine", "Entacapone", "Felodipine", "Ketoconazole",
           "Lansoprazole", "Loratadine", "Loxapine", "Omeprazole", "Aprepitant", "Aripiprazole",
           "Clomiphene", "Ciprofloxacin", "Dienestrol", "Mecillinam", "Mefloquine", "Methotrexate",
           "Oxolinic acid", "Simvastatin", "Tamoxifen", "Niclosamide", "Nifurtimox", "Chlorpromazine",
           "Ebselen", "Azithromycin", "Doxycycline"),
  Prop_left_24h_community = c(Community_degradation_Olanzapine$predicted_y_at_24['e'], 
                              Community_degradation_Sertindole$predicted_y_at_24['e'],
                              Community_degradation_Amlodipine$predicted_y_at_24['e'],
                              Community_degradation_Entacapone$predicted_y_at_24['e'],
                              Community_degradation_Felodipine$predicted_y_at_24['e'],
                              Community_degradation_Ketoconazole$predicted_y_at_24['e'],
                              Community_degradation_Lansoprazole$predicted_y_at_24['e'],
                              Community_degradation_Loratadine$predicted_y_at_24['e'],
                              Community_degradation_Loxapine$predicted_y_at_24['e'],
                              Community_degradation_Omeprazole$predicted_y_at_24['e'],
                              Community_degradation_Aprepitant$predicted_y_at_24['e'],
                              Community_degradation_Aripiprazole$predicted_y_at_24['e'],
                              Community_degradation_Clomiphene$predicted_y_at_24['e'],
                              Community_degradation_Ciprofloxacin$predicted_y_at_24['e'],
                              Community_degradation_Dienestrol$predicted_y_at_24['e'],
                              Community_degradation_Mecillinam$predicted_y_at_24['e'],
                              Community_degradation_Mefloquine$predicted_y_at_24['e'],
                              Community_degradation_Methotrexate$predicted_y_at_24['e'],
                              Community_degradation_Oxolinic_acid$predicted_y_at_24['e'],
                              Community_degradation_Simvastatin$predicted_y_at_24['e'],
                              Community_degradation_Tamoxifen$predicted_y_at_24['e'],
                              Community_degradation_Niclosamide$predicted_y_at_24['e'],
                              Community_degradation_Nifurtimox$predicted_y_at_24['e'],
                              Community_degradation_Chlorpromazine$predicted_y_at_24['e'],
                              Community_degradation_Ebselen$predicted_y_at_24['e'],
                              Community_degradation_Azithromycin$predicted_y_at_24['e'],
                              Community_degradation_Doxycycline$predicted_y_at_24['e']),
  Steepness_param_community = c(Community_degradation_Olanzapine$coefs['e'],
                                Community_degradation_Sertindole$coefs['e'],
                                Community_degradation_Amlodipine$coefs['e'],
                                Community_degradation_Entacapone$coefs['e'],
                                Community_degradation_Felodipine$coefs['e'],
                                Community_degradation_Ketoconazole$coefs['e'],
                                Community_degradation_Lansoprazole$coefs['e'],
                                Community_degradation_Loratadine$coefs['e'],
                                Community_degradation_Loxapine$coefs['e'],
                                Community_degradation_Omeprazole$coefs['e'],
                                Community_degradation_Aprepitant$coefs['e'],
                                Community_degradation_Aripiprazole$coefs['e'],
                                Community_degradation_Clomiphene$coefs['e'],
                                Community_degradation_Ciprofloxacin$coefs['e'],
                                Community_degradation_Dienestrol$coefs['e'],
                                Community_degradation_Mecillinam$coefs['e'],
                                Community_degradation_Mefloquine$coefs['e'],
                                Community_degradation_Methotrexate$coefs['e'],
                                Community_degradation_Oxolinic_acid$coefs['e'],
                                Community_degradation_Simvastatin$coefs['e'],
                                Community_degradation_Tamoxifen$coefs['e'],
                                Community_degradation_Niclosamide$coefs['e'],
                                Community_degradation_Nifurtimox$coefs['e'],
                                Community_degradation_Chlorpromazine$coefs['e'],
                                Community_degradation_Ebselen$coefs['e'],
                                Community_degradation_Azithromycin$coefs['e'],
                                Community_degradation_Doxycycline$coefs['e']),
  Prop_left_24h_background = c(Background_degradation_Olanzapine$predicted_y_at_24['e'],
                               Background_degradation_Sertindole$predicted_y_at_24['e'],
                               Background_degradation_Amlodipine$predicted_y_at_24['e'],
                               Background_degradation_Entacapone$predicted_y_at_24['e'],
                               Background_degradation_Felodipine$predicted_y_at_24['e'],
                               Background_degradation_Ketoconazole$predicted_y_at_24['e'],
                               Background_degradation_Lansoprazole$predicted_y_at_24['e'],
                               Background_degradation_Loratadine$predicted_y_at_24['e'],
                               Background_degradation_Loxapine$predicted_y_at_24['e'],
                               Background_degradation_Omeprazole$predicted_y_at_24['e'],
                               Background_degradation_Aprepitant$predicted_y_at_24['e'],
                               Background_degradation_Aripiprazole$predicted_y_at_24['e'],
                               Background_degradation_Clomiphene$predicted_y_at_24['e'],
                               Background_degradation_Ciprofloxacin$predicted_y_at_24['e'],
                               Background_degradation_Dienestrol$predicted_y_at_24['e'],
                               Background_degradation_Mecillinam$predicted_y_at_24['e'],
                               Background_degradation_Mefloquine$predicted_y_at_24['e'],
                               Background_degradation_Methotrexate$predicted_y_at_24['e'],
                               Background_degradation_Oxolinic_acid$predicted_y_at_24['e'],
                               Background_degradation_Simvastatin$predicted_y_at_24['e'],
                               Background_degradation_Tamoxifen$predicted_y_at_24['e'],
                               Background_degradation_Niclosamide$predicted_y_at_24['e'],
                               Background_degradation_Nifurtimox$predicted_y_at_24['e'],
                               Background_degradation_Chlorpromazine$predicted_y_at_24['e'],
                               Background_degradation_Ebselen$predicted_y_at_24['e'],
                               Background_degradation_Azithromycin$predicted_y_at_24['e'],
                               Background_degradation_Doxycycline$predicted_y_at_24['e']),
  Steepness_param_background = c(Background_degradation_Olanzapine$coefs['e'],
                                 Background_degradation_Sertindole$coefs['e'],
                                 Background_degradation_Amlodipine$coefs['e'],
                                 Background_degradation_Entacapone$coefs['e'],
                                 Background_degradation_Felodipine$coefs['e'],
                                 Background_degradation_Ketoconazole$coefs['e'],
                                 Background_degradation_Lansoprazole$coefs['e'],
                                 Background_degradation_Loratadine$coefs['e'],
                                 Background_degradation_Loxapine$coefs['e'],
                                 Background_degradation_Omeprazole$coefs['e'],
                                 Background_degradation_Aprepitant$coefs['e'],
                                 Background_degradation_Aripiprazole$coefs['e'],
                                 Background_degradation_Clomiphene$coefs['e'],
                                 Background_degradation_Ciprofloxacin$coefs['e'],
                                 Background_degradation_Dienestrol$coefs['e'],
                                 Background_degradation_Mecillinam$coefs['e'],
                                 Background_degradation_Mefloquine$coefs['e'],
                                 Background_degradation_Methotrexate$coefs['e'],
                                 Background_degradation_Oxolinic_acid$coefs['e'],
                                 Background_degradation_Simvastatin$coefs['e'],
                                 Background_degradation_Tamoxifen$coefs['e'],
                                 Background_degradation_Niclosamide$coefs['e'],
                                 Background_degradation_Nifurtimox$coefs['e'],
                                 Background_degradation_Chlorpromazine$coefs['e'],
                                 Background_degradation_Ebselen$coefs['e'],
                                 Background_degradation_Azithromycin$coefs['e'],
                                 Background_degradation_Doxycycline$coefs['e']),
  SD_drug_community = c(Community_degradation_Olanzapine$sd_endpoint_y,
                        Community_degradation_Sertindole$sd_endpoint_y,
                        Community_degradation_Amlodipine$sd_endpoint_y,
                        Community_degradation_Entacapone$sd_endpoint_y,
                        Community_degradation_Felodipine$sd_endpoint_y,
                        Community_degradation_Ketoconazole$sd_endpoint_y,
                        Community_degradation_Lansoprazole$sd_endpoint_y,
                        Community_degradation_Loratadine$sd_endpoint_y,
                        Community_degradation_Loxapine$sd_endpoint_y,
                        Community_degradation_Omeprazole$sd_endpoint_y,
                        Community_degradation_Aprepitant$sd_endpoint_y,
                        Community_degradation_Aripiprazole$sd_endpoint_y,
                        Community_degradation_Clomiphene$sd_endpoint_y,
                        Community_degradation_Ciprofloxacin$sd_endpoint_y,
                        Community_degradation_Dienestrol$sd_endpoint_y,
                        Community_degradation_Mecillinam$sd_endpoint_y,
                        Community_degradation_Mefloquine$sd_endpoint_y,
                        Community_degradation_Methotrexate$sd_endpoint_y,
                        Community_degradation_Oxolinic_acid$sd_endpoint_y,
                        Community_degradation_Simvastatin$sd_endpoint_y,
                        Community_degradation_Tamoxifen$sd_endpoint_y,
                        Community_degradation_Niclosamide$sd_endpoint_y,
                        Community_degradation_Nifurtimox$sd_endpoint_y,
                        Community_degradation_Chlorpromazine$sd_endpoint_y,
                        Community_degradation_Ebselen$sd_endpoint_y,
                        Community_degradation_Azithromycin$sd_endpoint_y,
                        Community_degradation_Doxycycline$sd_endpoint_y),
  SD_drug_community_start = c(Community_degradation_Olanzapine$sd_start_y,
                              Community_degradation_Sertindole$sd_start_y,
                              Community_degradation_Amlodipine$sd_start_y,
                              Community_degradation_Entacapone$sd_start_y,
                              Community_degradation_Felodipine$sd_start_y,
                              Community_degradation_Ketoconazole$sd_start_y,
                              Community_degradation_Lansoprazole$sd_start_y,
                              Community_degradation_Loratadine$sd_start_y,
                              Community_degradation_Loxapine$sd_start_y,
                              Community_degradation_Omeprazole$sd_start_y,
                              Community_degradation_Aprepitant$sd_start_y,
                              Community_degradation_Aripiprazole$sd_start_y,
                              Community_degradation_Clomiphene$sd_start_y,
                              Community_degradation_Ciprofloxacin$sd_start_y,
                              Community_degradation_Dienestrol$sd_start_y,
                              Community_degradation_Mecillinam$sd_start_y,
                              Community_degradation_Mefloquine$sd_start_y,
                              Community_degradation_Methotrexate$sd_start_y,
                              Community_degradation_Oxolinic_acid$sd_start_y,
                              Community_degradation_Simvastatin$sd_start_y,
                              Community_degradation_Tamoxifen$sd_start_y,
                              Community_degradation_Niclosamide$sd_start_y,
                              Community_degradation_Nifurtimox$sd_start_y,
                              Community_degradation_Chlorpromazine$sd_start_y,
                              Community_degradation_Ebselen$sd_start_y,
                              Community_degradation_Azithromycin$sd_start_y,
                              Community_degradation_Doxycycline$sd_start_y),
  Concentration_tested = c(Community_degradation_Olanzapine$max_concentration,
                           Community_degradation_Sertindole$max_concentration,
                           Community_degradation_Amlodipine$max_concentration,
                           Community_degradation_Entacapone$max_concentration,
                           Community_degradation_Felodipine$max_concentration,
                           Community_degradation_Ketoconazole$max_concentration,
                           Community_degradation_Lansoprazole$max_concentration,
                           Community_degradation_Loratadine$max_concentration,
                           Community_degradation_Loxapine$max_concentration,
                           Community_degradation_Omeprazole$max_concentration,
                           Community_degradation_Aprepitant$max_concentration,
                           Community_degradation_Aripiprazole$max_concentration,
                           Community_degradation_Clomiphene$max_concentration,
                           Community_degradation_Ciprofloxacin$max_concentration,
                           Community_degradation_Dienestrol$max_concentration,
                           Community_degradation_Mecillinam$max_concentration,
                           Community_degradation_Mefloquine$max_concentration,
                           Community_degradation_Methotrexate$max_concentration,
                           Community_degradation_Oxolinic_acid$max_concentration,
                           Community_degradation_Simvastatin$max_concentration,
                           Community_degradation_Tamoxifen$max_concentration,
                           Community_degradation_Niclosamide$max_concentration,
                           Community_degradation_Nifurtimox$max_concentration,
                           Community_degradation_Chlorpromazine$max_concentration,
                           Community_degradation_Ebselen$max_concentration,
                           Community_degradation_Azithromycin$max_concentration,
                           Community_degradation_Doxycycline$max_concentration)
)


##ensuring vals in Prop_left_24h_background do not exceed 1 (error/variability in metabolomics data + more variation due to fewer datapoints)
#since after all, more of the drug than that which is added cannot spontaneously be generated
drug_dynamics$Prop_left_24h_background <- pmin(drug_dynamics$Prop_left_24h_background, 1)
drug_dynamics$Prop_left_24h_community <- pmin(drug_dynamics$Prop_left_24h_community, 1)


#subset community composition data by drug:
Community_compositions_focus_drugs_Acarbose <- subset(Community_compositions_focus_drugs, drug == "Acarbose")
Community_compositions_focus_drugs_Amlodipine <- subset(Community_compositions_focus_drugs, drug == "Amlodipine")
Community_compositions_focus_drugs_Aprepitant <- subset(Community_compositions_focus_drugs, drug == "Aprepitant")
Community_compositions_focus_drugs_Aripiprazole <- subset(Community_compositions_focus_drugs, drug == "Aripiprazole")
Community_compositions_focus_drugs_Azithromycin <- subset(Community_compositions_focus_drugs, drug == "Azithromycin")
Community_compositions_focus_drugs_beta_estradiol_17_valerate <- subset(Community_compositions_focus_drugs, drug == "beta-estradiol 17-valerate")
Community_compositions_focus_drugs_Chlorpromazine <- subset(Community_compositions_focus_drugs, drug == "Chlorpromazine")
Community_compositions_focus_drugs_Ciprofloxacin <- subset(Community_compositions_focus_drugs, drug == "Ciprofloxacin")
Community_compositions_focus_drugs_Clomiphene <- subset(Community_compositions_focus_drugs, drug == "Clomiphene")
Community_compositions_focus_drugs_Diacerein <- subset(Community_compositions_focus_drugs, drug == "Diacerein")
Community_compositions_focus_drugs_Dienestrol <- subset(Community_compositions_focus_drugs, drug == "Dienestrol")
Community_compositions_focus_drugs_Doxycycline <- subset(Community_compositions_focus_drugs, drug == "Doxycycline")
Community_compositions_focus_drugs_Ebselen <- subset(Community_compositions_focus_drugs, drug == "Ebselen")
Community_compositions_focus_drugs_Entacapone <- subset(Community_compositions_focus_drugs, drug == "Entacapone")
Community_compositions_focus_drugs_Felodipine <- subset(Community_compositions_focus_drugs, drug == "Felodipine")
Community_compositions_focus_drugs_Ketoconazole <- subset(Community_compositions_focus_drugs, drug == "Ketoconazole")
Community_compositions_focus_drugs_Lansoprazole <- subset(Community_compositions_focus_drugs, drug == "Lansoprazole")
Community_compositions_focus_drugs_Loratadine <- subset(Community_compositions_focus_drugs, drug == "Loratadine")
Community_compositions_focus_drugs_Loxapine <- subset(Community_compositions_focus_drugs, drug == "Loxapine")
Community_compositions_focus_drugs_Mecillinam <- subset(Community_compositions_focus_drugs, drug == "Mecillinam")
Community_compositions_focus_drugs_Mefloquine <- subset(Community_compositions_focus_drugs, drug == "Mefloquine")
Community_compositions_focus_drugs_Methotrexate <- subset(Community_compositions_focus_drugs, drug == "Methotrexate")
Community_compositions_focus_drugs_Niclosamide <- subset(Community_compositions_focus_drugs, drug == "Niclosamide")
Community_compositions_focus_drugs_Nifurtimox <- subset(Community_compositions_focus_drugs, drug == "Nifurtimox")
Community_compositions_focus_drugs_Olanzapine <- subset(Community_compositions_focus_drugs, drug == "Olanzapine")
Community_compositions_focus_drugs_Omeprazole <- subset(Community_compositions_focus_drugs, drug == "Omeprazole")
Community_compositions_focus_drugs_Oxolinic_acid <- subset(Community_compositions_focus_drugs, drug == "Oxolinic acid")
Community_compositions_focus_drugs_Sertindole <- subset(Community_compositions_focus_drugs, drug == "Sertindole")
Community_compositions_focus_drugs_Simvastatin <- subset(Community_compositions_focus_drugs, drug == "Simvastatin")
Community_compositions_focus_drugs_Tamoxifen <- subset(Community_compositions_focus_drugs, drug == "Tamoxifen")




##Fitting effects
#First; multiply AUCs with mean co-culture corrected K values:
combined_monoculture_aucs
#control_community <- Niclosamide_16S_0uM_summarised
control_community <- rel_ab_control_1
control_community$cc_K <- control_community$mean_rel_ab * control_community$mean_com_max_OD
Niclosamide_16S_0uM_summarised <- control_community
#control_community$Species <- control_community$species


combined_monoculture_aucs <- combined_monoculture_aucs %>%
  dplyr::mutate(Species = case_when(
    species_name == "Phocaeicola vulgatus" ~ "B_vulgatus",
    species_name == "Erysipelatoclostridium ramosum" ~ "C_ramosum",
    species_name == "Bacteroides uniformis" ~ "B_uniformis",
    species_name == "Bacteroides fragilis" ~ "B_fragilis",
    species_name == "Bacteroides thetaiotaomicron" ~ "B_thetaiotaomicron",
    species_name == "Eubacterium rectale" ~ "E_rectale",
    species_name == "Roseburia intestinalis" ~ "R_intestinalis",
    species_name == "Veillonella parvula" ~ "V_parvula",
    species_name == "Prevotella copri" ~ "P_copri",
    species_name == "Eggerthella lenta" ~ "E_lenta",
    species_name == "Fusobacterium nucleatum subsp. nucleatum" ~ "F_nucleatum",
    species_name == "Enterocloster bolteae" ~ "C_bolteae",
    species_name == "Bifidobacterium longum subsp. longum" ~ "B_longum",
    species_name == "Clostridium perfringens" ~ "C_perfringens",
    species_name == "Bilophila wadsworthia" ~ "B_wadsworthia",
    species_name == "Lacrimispora saccharolytica" ~ "C_saccharolyticum",
    species_name == "Streptococcus salivarius" ~ "S_salivarius",
    species_name == "Ruminococcus gnavus" ~ "R_gnavus",
    species_name == "Coprococcus comes" ~ "C_comes",
    species_name == "Parabacteroides merdae" ~ "P_merdae",
    species_name == "Streptococcus parasanguinis" ~ "S_parasanguinis",
    species_name == "Collinsella aerofaciens" ~ "C_aerofaciens",
    species_name == "Dorea formicigenerans" ~ "D_formicigenerans",
    species_name == "Escherichia coli ED1a" ~ "E_coli",
    TRUE ~ species_name  # Default case to handle any other species not specifically listed
  ))

#ensure consistent formatting for species names/labels
#control_community$Species <- gsub("\\. ", "_", control_community$Species)
control_community$Species <- gsub("._", "_", control_community$Species)
head(control_community)

##add a 0 conc for each drug, like for niclosamide
template_row <- combined_monoculture_aucs %>%
  dplyr::filter(drug == "Niclosamide", conc == 0)

#remove the 'drug' column from the template to reuse all other info
template_row <- template_row %>%
  dplyr::select(-drug)

other_drugs <- setdiff(unique(combined_monoculture_aucs$drug), "Niclosamide")
new_rows <- lapply(other_drugs, function(drug_name) {
  modified_row <- template_row
  modified_row$drug <- drug_name  
  return(modified_row)
}) %>%
  bind_rows()  

#now all drugs have the control row (with AUC == 1)
combined_monoculture_aucs1 <- combined_monoculture_aucs %>%
  dplyr::bind_rows(new_rows)


#join the co-culture corrected 'K' parameter with the monoculture AUCs so we can change the units of AUC (normalised to 1 at control) to K (OD)
combined_monoculture_aucs1 <- combined_monoculture_aucs1 %>%
  dplyr::left_join(select(control_community, Species, cc_K), by = "Species")

head(combined_monoculture_aucs1)

#AUC co-culture corrected:
combined_monoculture_aucs1$AUC_cc_K <- combined_monoculture_aucs1$AUC * combined_monoculture_aucs1$cc_K


combined_monoculture_aucs1 <- combined_monoculture_aucs1 %>%
  dplyr::mutate(Species = case_when(
    species_name == "Phocaeicola vulgatus" ~ "B._vulgatus",
    species_name == "Erysipelatoclostridium ramosum" ~ "C._ramosum",
    species_name == "Bacteroides uniformis" ~ "B._uniformis",
    species_name == "Bacteroides fragilis" ~ "B._fragilis",
    species_name == "Bacteroides thetaiotaomicron" ~ "B._thetaiotaomicron",
    species_name == "Eubacterium rectale" ~ "E._rectale",
    species_name == "Roseburia intestinalis" ~ "R._intestinalis",
    species_name == "Veillonella parvula" ~ "V._parvula",
    species_name == "Prevotella copri" ~ "P._copri",
    species_name == "Eggerthella lenta" ~ "E._lenta",
    species_name == "Fusobacterium nucleatum subsp. nucleatum" ~ "F._nucleatum",
    species_name == "Enterocloster bolteae" ~ "C._bolteae",
    species_name == "Bifidobacterium longum subsp. longum" ~ "B._longum",
    species_name == "Clostridium perfringens" ~ "C._perfringens",
    species_name == "Bilophila wadsworthia" ~ "B._wadsworthia",
    species_name == "Lacrimispora saccharolytica" ~ "C._saccharolyticum",
    species_name == "Streptococcus salivarius" ~ "S._salivarius",
    species_name == "Ruminococcus gnavus" ~ "R._gnavus",
    species_name == "Coprococcus comes" ~ "C._comes",
    species_name == "Parabacteroides merdae" ~ "P._merdae",
    species_name == "Streptococcus parasanguinis" ~ "S._parasanguinis",
    species_name == "Collinsella aerofaciens" ~ "C._aerofaciens",
    species_name == "Dorea formicigenerans" ~ "D._formicigenerans",
    species_name == "Escherichia coli ED1a" ~ "E._coli",
    TRUE ~ species_name  # Default case to handle any other species not specifically listed
  ))



####
combined_monoculture_aucs1
combined_monoculture_aucs2 <- combined_monoculture_aucs1
combined_monoculture_aucs2$concentration <- combined_monoculture_aucs2$conc
head(combined_monoculture_aucs2)

drug_dynamics1 <- drug_dynamics

drug_dynamics1$drug <- drug_dynamics1$Drug

combined_monoculture_aucs2 <- combined_monoculture_aucs2 %>%
  dplyr::left_join(select(drug_dynamics1, drug, Prop_left_24h_background), by = "drug")

##to get the 'effective_concentration' column, we will need to multiply by Prop_left_24h_background
#for a subset of drugs, we do not have available metabolomics data and hence no estimate of associated dynamics
#for these, we will assign 1
combined_monoculture_aucs2$Prop_left_24h_background[is.na(combined_monoculture_aucs2$Prop_left_24h_background)] <- 1

##create 'effective concentration' variable, accounting for background degradation 
combined_monoculture_aucs2$effective_concentration <- combined_monoculture_aucs2$conc * combined_monoculture_aucs2$Prop_left_24h_background






##Accounting for dynamic, non-linear drug sensitivities as described in:
#Dynamic_fits_all_drugs_August24.R
#In this script, we also define the required inputted objects: best_fitting_models_df1

# Function to generate y(Drug) with numeric values embedded
get_y_function <- function(species, drug, best_fitting_models_df1) {
  # Subset the dataframe for the specific species and drug
  model_info <- best_fitting_models_df1 %>%
    filter(Species == species, drug == drug)
  
  ##Extract the model type
  model_type <- unique(model_info$Model_type)
  
  ##Extract the parameters
  d <- unique(model_info$d)
  d1 <- unique(model_info$d1)
  params <- setNames(model_info$Fit_param_value, model_info$Fit_param_name)
  
  ##Create the function string based on the model type
  function_string <- switch(model_type,
                            "Linear_func" = sprintf("function(Drug) 1 + %f * Drug", params["e"]),
                            "Asymptotic_func" = sprintf("function(Drug) %f - (%f - 1) * exp(-%f * Drug)", d, d, params["e"]),
                            "Log_log_func" = sprintf("function(Drug) 1 + ((%f - 1) / (1 + exp(-%f * (log10(Drug) - log10(%f)))))", d, params["e"], params["b"]),
                            "Gompertz_func" = sprintf("function(Drug) 1 + (%f - 1) * exp(-exp(-%f * (Drug - %f)))", d, params["b"], params["e"]),
                            "Modified_Gompertz_func" = sprintf("function(Drug) 1 + (%f - 1) * (1 - exp(-exp(%f*(Drug-%f))))", d, params["b"], params["e"]),
                            "Inverse_sigmoidal_func" = sprintf("function(Drug) ((1 - %f) / (1 + exp(%f * Drug - %f))) + %f", d, params["b"], params["e"], d),
                            "Weibull_I_func" = sprintf("function(Drug) 1 + (%f - 1) * exp(-exp(-%f * (log10(Drug) - log10(%f))))", d, params["e"], params["b"]),
                            "Weibull_II_func" = sprintf("function(Drug) 1 + (%f - 1) * (1 - exp(-exp(%f * (log10(Drug) - log10(%f)))))", d, params["e"], params["b"]),
                            "Lorentz_func" = sprintf("function(Drug) 1 + (%f - 1) / (1 + %f * (Drug - %f)^2)", d1, params["e"], params["b"]),
                            "Bragg_func" = sprintf("function(Drug) 1 + (%f - 1) * exp(-%f*(Drug-%f)^2)", d1, params["e"], params["b"]),
                            "Mod_exp_func" = sprintf("function(Drug) %f * exp(-%f * Drug) + %f * Drug", d1, params["e"], params["b"]),
                            "Gauss_peak_func" = sprintf("function(Drug) %f + (%f - %f) * exp(-%f * (Drug - %f)^2)", d, d1, d, params["e"], params["b"]),
                            "Lorentz_func_II" = sprintf("function(Drug) %f + (%f - %f) / (1 + %f * (Drug - %f)^2)", d, d1, d, params["e"], params["b"]),
                            stop("Model type not recognised")
  )
  
  ##parse and create the function
  y_function_eval <- eval(parse(text = function_string))
  
  return(y_function_eval)
}

##Example of usage for B. vulgatus sensitivity to Acarbose: 
#y_function_B_vulgatus_Acarbose <- get_y_function("B_vulgatus", "Acarbose", best_fitting_models_df_Acarbose)

best_fitting_models_df_Acarbose <- subset(best_fitting_models_df1, drug == "Acarbose")
best_fitting_models_df_Amlodipine <- subset(best_fitting_models_df1, drug == "Amlodipine")
best_fitting_models_df_Aprepitant <- subset(best_fitting_models_df1, drug == "Aprepitant")
best_fitting_models_df_Aripiprazole <- subset(best_fitting_models_df1, drug == "Aripiprazole")
best_fitting_models_df_Azithromycin <- subset(best_fitting_models_df1, drug == "Azithromycin")
best_fitting_models_df_beta_estradiol_17_valerate <- subset(best_fitting_models_df1, drug == "beta-estradiol 17-valerate")
best_fitting_models_df_Chlorpromazine <- subset(best_fitting_models_df1, drug == "Chlorpromazine")
best_fitting_models_df_Ciprofloxacin <- subset(best_fitting_models_df1, drug == "Ciprofloxacin")
best_fitting_models_df_Clomiphene <- subset(best_fitting_models_df1, drug == "Clomiphene")
best_fitting_models_df_Diacerein <- subset(best_fitting_models_df1, drug == "Diacerein")
best_fitting_models_df_Dienestrol <- subset(best_fitting_models_df1, drug == "Dienestrol")
best_fitting_models_df_Doxycycline <- subset(best_fitting_models_df1, drug == "Doxycycline")
best_fitting_models_df_Ebselen <- subset(best_fitting_models_df1, drug == "Ebselen")
best_fitting_models_df_Entacapone <- subset(best_fitting_models_df1, drug == "Entacapone")
best_fitting_models_df_Felodipine <- subset(best_fitting_models_df1, drug == "Felodipine")
best_fitting_models_df_Ketoconazole <- subset(best_fitting_models_df1, drug == "Ketoconazole")
best_fitting_models_df_Lansoprazole <- subset(best_fitting_models_df1, drug == "Lansoprazole")
best_fitting_models_df_Loratadine <- subset(best_fitting_models_df1, drug == "Loratadine")
best_fitting_models_df_Loxapine <- subset(best_fitting_models_df1, drug == "Loxapine")
best_fitting_models_df_Mecillinam <- subset(best_fitting_models_df1, drug == "Mecillinam")
best_fitting_models_df_Mefloquine <- subset(best_fitting_models_df1, drug == "Mefloquine")
best_fitting_models_df_Methotrexate <- subset(best_fitting_models_df1, drug == "Methotrexate")
best_fitting_models_df_Niclosamide <- subset(best_fitting_models_df1, drug == "Niclosamide")
best_fitting_models_df_Nifurtimox <- subset(best_fitting_models_df1, drug == "Nifurtimox")
best_fitting_models_df_Olanzapine <- subset(best_fitting_models_df1, drug == "Olanzapine")
best_fitting_models_df_Omeprazole <- subset(best_fitting_models_df1, drug == "Omeprazole")
best_fitting_models_df_Oxolinic_acid <- subset(best_fitting_models_df1, drug == "Oxolinic acid")
best_fitting_models_df_Sertindole <- subset(best_fitting_models_df1, drug == "Sertindole")
best_fitting_models_df_Simvastatin <- subset(best_fitting_models_df1, drug == "Simvastatin")
best_fitting_models_df_Tamoxifen <- subset(best_fitting_models_df1, drug == "Tamoxifen")


##########
#The first drug to run: Aprepitant

##!!!!INSTRUCTIONS FOR EFFICIENT RUNNING OF THE CODE BLOCK BELOW!!!!
#To run all drugs and their tested non-zero concentrations, as stored in code block in line 2100 through to 41450 below,
#find and replace all '$conc)[1]' with '$conc)[2]' within the entire block once having run the block for the first time, so one first runs each drug's lowest tested concentration, 
#and then one runs the second-lowest concentration tested, etc. etc. Then, following the last line of the simulations (41450), one should have all
#objects required for analysing the simulated/predicted community composition and dynamics data.

combined_monoculture_aucs2_Aprepitant <- subset(combined_monoculture_aucs2, drug == "Aprepitant")

#drug sensitivity terms: define once outside of ODEs
y_function_B_vulgatus_Aprepitant <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("B_vulgatus", "Aprepitant", best_fitting_models_df_Aprepitant)), collapse = " ")))
y_function_B_uniformis_Aprepitant <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("B_uniformis", "Aprepitant", best_fitting_models_df_Aprepitant)), collapse = " ")))
y_function_B_fragilis_Aprepitant <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("B_fragilis", "Aprepitant", best_fitting_models_df_Aprepitant)), collapse = " ")))
y_function_B_thetaiotaomicron_Aprepitant <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("B_thetaiotaomicron", "Aprepitant", best_fitting_models_df_Aprepitant)), collapse = " ")))
y_function_C_ramosum_Aprepitant <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("C_ramosum", "Aprepitant", best_fitting_models_df_Aprepitant)), collapse = " ")))
y_function_E_rectale_Aprepitant <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("E_rectale", "Aprepitant", best_fitting_models_df_Aprepitant)), collapse = " ")))
y_function_R_intestinalis_Aprepitant <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("R_intestinalis", "Aprepitant", best_fitting_models_df_Aprepitant)), collapse = " ")))
y_function_V_parvula_Aprepitant <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("V_parvula", "Aprepitant", best_fitting_models_df_Aprepitant)), collapse = " ")))
y_function_E_lenta_Aprepitant <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("E_lenta", "Aprepitant", best_fitting_models_df_Aprepitant)), collapse = " ")))
y_function_F_nucleatum_Aprepitant <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("F_nucleatum", "Aprepitant", best_fitting_models_df_Aprepitant)), collapse = " ")))
y_function_C_bolteae_Aprepitant <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("C_bolteae", "Aprepitant", best_fitting_models_df_Aprepitant)), collapse = " ")))
y_function_C_perfringens_Aprepitant <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("C_perfringens", "Aprepitant", best_fitting_models_df_Aprepitant)), collapse = " ")))
y_function_C_saccharolyticum_Aprepitant <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("C_saccharolyticum", "Aprepitant", best_fitting_models_df_Aprepitant)), collapse = " ")))
y_function_S_salivarius_Aprepitant <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("S_salivarius", "Aprepitant", best_fitting_models_df_Aprepitant)), collapse = " ")))
y_function_R_gnavus_Aprepitant <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("R_gnavus", "Aprepitant", best_fitting_models_df_Aprepitant)), collapse = " ")))
y_function_C_comes_Aprepitant <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("C_comes", "Aprepitant", best_fitting_models_df_Aprepitant)), collapse = " ")))
y_function_P_merdae_Aprepitant <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("P_merdae", "Aprepitant", best_fitting_models_df_Aprepitant)), collapse = " ")))
y_function_S_parasanguinis_Aprepitant <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("S_parasanguinis", "Aprepitant", best_fitting_models_df_Aprepitant)), collapse = " ")))
y_function_C_aerofaciens_Aprepitant <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("C_aerofaciens", "Aprepitant", best_fitting_models_df_Aprepitant)), collapse = " ")))
y_function_D_formicigenerans_Aprepitant <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("D_formicigenerans", "Aprepitant", best_fitting_models_df_Aprepitant)), collapse = " ")))
y_function_E_coli_Aprepitant <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("E_coli", "Aprepitant", best_fitting_models_df_Aprepitant)), collapse = " ")))



y_function_B_vulgatus_Aprepitant_func <- eval(parse(text = paste("function(Drug) {", y_function_B_vulgatus_Aprepitant, "}")))
y_function_B_uniformis_Aprepitant_func <- eval(parse(text = paste("function(Drug) {", y_function_B_uniformis_Aprepitant, "}")))
y_function_B_fragilis_Aprepitant_func <- eval(parse(text = paste("function(Drug) {", y_function_B_fragilis_Aprepitant, "}")))
y_function_B_thetaiotaomicron_Aprepitant_func <- eval(parse(text = paste("function(Drug) {", y_function_B_thetaiotaomicron_Aprepitant, "}")))
y_function_C_ramosum_Aprepitant_func <- eval(parse(text = paste("function(Drug) {", y_function_C_ramosum_Aprepitant, "}")))
y_function_E_rectale_Aprepitant_func <- eval(parse(text = paste("function(Drug) {", y_function_E_rectale_Aprepitant, "}")))
y_function_R_intestinalis_Aprepitant_func <- eval(parse(text = paste("function(Drug) {", y_function_R_intestinalis_Aprepitant, "}")))
y_function_E_lenta_Aprepitant_func <- eval(parse(text = paste("function(Drug) {", y_function_E_lenta_Aprepitant, "}")))
y_function_F_nucleatum_Aprepitant_func <- eval(parse(text = paste("function(Drug) {", y_function_F_nucleatum_Aprepitant, "}")))
y_function_C_bolteae_Aprepitant_func <- eval(parse(text = paste("function(Drug) {", y_function_C_bolteae_Aprepitant, "}")))
y_function_C_perfringens_Aprepitant_func <- eval(parse(text = paste("function(Drug) {", y_function_C_perfringens_Aprepitant, "}")))
y_function_C_saccharolyticum_Aprepitant_func <- eval(parse(text = paste("function(Drug) {", y_function_C_saccharolyticum_Aprepitant, "}")))
y_function_S_salivarius_Aprepitant_func <- eval(parse(text = paste("function(Drug) {", y_function_S_salivarius_Aprepitant, "}")))
y_function_R_gnavus_Aprepitant_func <- eval(parse(text = paste("function(Drug) {", y_function_R_gnavus_Aprepitant, "}")))
y_function_C_comes_Aprepitant_func <- eval(parse(text = paste("function(Drug) {", y_function_C_comes_Aprepitant, "}")))
y_function_P_merdae_Aprepitant_func <- eval(parse(text = paste("function(Drug) {", y_function_P_merdae_Aprepitant, "}")))
y_function_S_parasanguinis_Aprepitant_func <- eval(parse(text = paste("function(Drug) {", y_function_S_parasanguinis_Aprepitant, "}")))
y_function_C_aerofaciens_Aprepitant_func <- eval(parse(text = paste("function(Drug) {", y_function_C_aerofaciens_Aprepitant, "}")))
y_function_D_formicigenerans_Aprepitant_func <- eval(parse(text = paste("function(Drug) {", y_function_D_formicigenerans_Aprepitant, "}")))
y_function_E_coli_Aprepitant_func <- eval(parse(text = paste("function(Drug) {", y_function_E_coli_Aprepitant, "}")))
y_function_V_parvula_Aprepitant_func <- eval(parse(text = paste("function(Drug) {", y_function_V_parvula_Aprepitant, "}")))


#Check concentrations tested:
unique(combined_monoculture_aucs2_Aprepitant$conc)
##dictate drug concentration tested for simulation cycle here:
#drug_concentration_tested <- 5 #if manually or:
drug_concentration_tested <- unique(combined_monoculture_aucs2_Aprepitant$conc)[1] 
initial_conditions <- rep(0.01/32, 32)
initial_conditions <- c(initial_conditions, drug_concentration_tested)

##drug effect fitted for species showing sensitivity in monoculture:
#unique(combined_monoculture_aucs2_Aprepitant$Species)

##for more simple linear fits
closed.sir.model_Aprepitant <- function (t, x, params) {
  ## first extract the state variables
  A_muciniphila <- x[1]
  B_adolescentis <- x[2]
  B_fragilis <- x[3]
  B_longum <- x[4]
  B_obeum <- x[5]
  B_thetaiotaomicron <- x[6]
  B_uniformis <- x[7]
  B_vulgatus <- x[8]
  B_wadsworthia <- x[9]
  C_aerofaciens <- x[10]
  C_bolteae <- x[11]
  C_comes <- x[12]
  C_perfringens <- x[13]
  C_ramosum <- x[14]
  C_saccharolyticum <- x[15]
  D_formicigenerans <- x[16]
  E_coli <- x[17]
  E_lenta <- x[18]
  E_rectale <- x[19]
  F_nucleatum <- x[20]
  L_paracasei <- x[21]
  O_splanchnicus <- x[22]
  P_copri <- x[23]
  P_distasonis <- x[24]
  P_merdae <- x[25]
  R_bromii <- x[26]
  R_gnavus <- x[27]
  R_intestinalis <- x[28]
  R_torques <- x[29]
  S_parasanguinis <- x[30]
  S_salivarius <- x[31]
  V_parvula <- x[32]
  Drug <- x[33]
  
  
  ## now extract the parameters
  r_B_fragilis <- flat_params[["B._fragilis.r"]]
  K_B_fragilis <- flat_params[["B._fragilis.K"]]
  r_B_longum <- flat_params[["B._longum.r"]]
  K_B_longum <- flat_params[["B._longum.K"]]
  r_B_thetaiotaomicron <- flat_params[["B._thetaiotaomicron.r"]]
  K_B_thetaiotaomicron <- flat_params[["B._thetaiotaomicron.K"]]
  r_B_uniformis <- flat_params[["B._uniformis.r"]]
  K_B_uniformis <- flat_params[["B._uniformis.K"]]
  r_B_vulgatus <- flat_params[["B._vulgatus.r"]]
  K_B_vulgatus <- flat_params[["B._vulgatus.K"]]
  r_B_wadsworthia <- flat_params[["B._wadsworthia.r"]]
  K_B_wadsworthia <- flat_params[["B._wadsworthia.K"]]
  r_C_aerofaciens <- flat_params[["C._aerofaciens.r"]]
  K_C_aerofaciens <- flat_params[["C._aerofaciens.K"]]
  r_C_bolteae <- flat_params[["C._bolteae.r"]]
  K_C_bolteae <- flat_params[["C._bolteae.K"]]
  r_C_comes <- flat_params[["C._comes.r"]]
  K_C_comes <- flat_params[["C._comes.K"]]
  r_C_perfringens <- flat_params[["C._perfringens.r"]]
  K_C_perfringens <- flat_params[["C._perfringens.K"]]
  r_C_ramosum <- flat_params[["C._ramosum.r"]]
  K_C_ramosum <- flat_params[["C._ramosum.K"]]
  r_C_saccharolyticum <- flat_params[["C._saccharolyticum.r"]]
  K_C_saccharolyticum <- flat_params[["C._saccharolyticum.K"]]
  r_D_formicigenerans <- flat_params[["D._formicigenerans.r"]]
  K_D_formicigenerans <- flat_params[["D._formicigenerans.K"]]
  r_E_coli <- flat_params[["E._coli.r"]]
  K_E_coli <- flat_params[["E._coli.K"]]
  r_E_lenta <- flat_params[["E._lenta.r"]]
  K_E_lenta <- flat_params[["E._lenta.K"]]
  r_E_rectale <- flat_params[["E._rectale.r"]]
  K_E_rectale <- flat_params[["E._rectale.K"]]
  r_F_nucleatum <- flat_params[["F._nucleatum.r"]]
  K_F_nucleatum <- flat_params[["F._nucleatum.K"]]
  r_P_copri <- flat_params[["P._copri.r"]]
  K_P_copri <- flat_params[["P._copri.K"]]
  r_P_merdae <- flat_params[["P._merdae.r"]]
  K_P_merdae <- flat_params[["P._merdae.K"]]
  r_R_gnavus <- flat_params[["R._gnavus.r"]]
  K_R_gnavus <- flat_params[["R._gnavus.K"]]
  r_R_intestinalis <- flat_params[["R._intestinalis.r"]]
  K_R_intestinalis <- flat_params[["R._intestinalis.K"]]
  r_V_parvula <- flat_params[["V._parvula.r"]]
  K_V_parvula <- flat_params[["V._parvula.K"]]
  r_A_muciniphila <- flat_params[["A._muciniphila.r"]]
  K_A_muciniphila <- flat_params[["A._muciniphila.K"]]
  r_B_adolescentis <- flat_params[["B._adolescentis.r"]]
  K_B_adolescentis <- flat_params[["B._adolescentis.K"]]
  r_B_obeum <- flat_params[["B._obeum.r"]]
  K_B_obeum <- flat_params[["B._obeum.K"]]
  r_O_splanchnicus <- flat_params[["O._splanchnicus.r"]]
  K_O_splanchnicus <- flat_params[["O._splanchnicus.K"]]
  r_P_distasonis <- flat_params[["P._distasonis.r"]]
  K_P_distasonis <- flat_params[["P._distasonis.K"]]
  r_R_bromii <- flat_params[["R._bromii.r"]]
  K_R_bromii <- flat_params[["R._bromii.K"]]
  r_R_torques <- flat_params[["R._torques.r"]]
  K_R_torques <- flat_params[["R._torques.K"]]
  r_S_parasanguinis <- flat_params[["S._parasanguinis.r"]]
  K_S_parasanguinis <-flat_params[["S._parasanguinis.K"]]
  r_S_salivarius <- flat_params[["S._salivarius.r"]]
  K_S_salivarius <- flat_params[["S._salivarius.K"]]
  r_L_paracasei <- flat_params[["L._paracasei.r"]]
  K_L_paracasei <- flat_params[["L._paracasei.K"]]
  
  
  t_mod <- ifelse(t > 24.1, t - 24.1, t)
  
  
  ## now code the model equations
  dA_muciniphila_dt <- r_A_muciniphila * A_muciniphila * (1 - A_muciniphila / K_A_muciniphila)
  dB_adolescentis_dt <- r_B_adolescentis * B_adolescentis * (1 - B_adolescentis / K_B_adolescentis)
  dB_fragilis_dt <- r_B_fragilis * B_fragilis * (1 - B_fragilis / max(0.0001, K_B_fragilis * (y_function_B_fragilis_Aprepitant_func(Drug))))
  dB_longum_dt <- r_B_longum * B_longum * (1 - B_longum / K_B_longum)
  dB_obeum_dt <- r_B_obeum * B_obeum * (1 - B_obeum / K_B_obeum)
  dB_thetaiotaomicron_dt <- r_B_thetaiotaomicron * B_thetaiotaomicron * (1 - B_thetaiotaomicron / max(0.0001, K_B_thetaiotaomicron * (y_function_B_thetaiotaomicron_Aprepitant_func(Drug))))  
  dB_uniformis_dt <- r_B_uniformis * B_uniformis * (1 - B_uniformis / max(0.0001, K_B_uniformis * (y_function_B_uniformis_Aprepitant_func(Drug))))
  dB_vulgatus_dt <- r_B_vulgatus * B_vulgatus * (1 - B_vulgatus / max(0.0001, K_B_vulgatus * (y_function_B_vulgatus_Aprepitant_func(Drug))))
  dB_wadsworthia_dt <- r_B_wadsworthia * B_wadsworthia * (1 - B_wadsworthia / K_B_wadsworthia)
  dC_aerofaciens_dt <- r_C_aerofaciens * C_aerofaciens * (1 - C_aerofaciens / max(0.0001, K_C_aerofaciens * (y_function_C_aerofaciens_Aprepitant_func(Drug))))
  dC_bolteae_dt <- r_C_bolteae * C_bolteae * (1 - C_bolteae /  max(0.0001, K_C_bolteae * (y_function_C_bolteae_Aprepitant_func(Drug))))
  dC_comes_dt <- r_C_comes * C_comes * (1 - C_comes / max(0.0001, K_C_comes * (y_function_C_comes_Aprepitant_func(Drug))))
  dC_perfringens_dt <- r_C_perfringens * C_perfringens * (1 - C_perfringens / max(0.0001, K_C_perfringens * (y_function_C_perfringens_Aprepitant_func(Drug))))
  dC_ramosum_dt <- r_C_ramosum * C_ramosum * (1 - C_ramosum / max(0.0001, K_C_ramosum * (y_function_C_ramosum_Aprepitant_func(Drug))))
  dC_saccharolyticum_dt <- r_C_saccharolyticum * C_saccharolyticum * (1 - C_saccharolyticum / max(0.0001, K_C_saccharolyticum * (y_function_C_saccharolyticum_Aprepitant_func(Drug))))
  dD_formicigenerans_dt <- r_D_formicigenerans * D_formicigenerans * (1 - D_formicigenerans / max(0.0001, K_D_formicigenerans * (y_function_D_formicigenerans_Aprepitant_func(Drug))))
  dE_coli_dt <- r_E_coli * E_coli * (1 - E_coli / max(0.0001, K_E_coli * (y_function_E_coli_Aprepitant_func(Drug))))
  dE_lenta_dt <- r_E_lenta * E_lenta * (1 - E_lenta / max(0.0001, K_E_lenta * (y_function_E_lenta_Aprepitant_func(Drug))))
  dE_rectale_dt <- r_E_rectale * E_rectale * (1 - E_rectale / max(0.0001, K_E_rectale * (y_function_E_rectale_Aprepitant_func(Drug))))
  dF_nucleatum_dt <- r_F_nucleatum * F_nucleatum * (1 - F_nucleatum / max(0.0001, K_F_nucleatum * (y_function_F_nucleatum_Aprepitant_func(Drug))))
  dL_paracasei_dt <- r_L_paracasei * L_paracasei * (1 - L_paracasei / K_L_paracasei)  
  dO_splanchnicus_dt <- r_O_splanchnicus * O_splanchnicus * (1 - O_splanchnicus / K_O_splanchnicus)  
  dP_copri_dt <- r_P_copri * P_copri * (1 - P_copri / K_P_copri)
  dP_distasonis_dt <- r_P_distasonis * P_distasonis * (1 - P_distasonis / K_P_distasonis)  
  dP_merdae_dt <- r_P_merdae * P_merdae * (1 - P_merdae / max(0.0001, K_P_merdae * (y_function_P_merdae_Aprepitant_func(Drug))))
  dR_bromii_dt <- r_R_bromii * R_bromii * (1 - R_bromii / K_R_bromii) 
  dR_gnavus_dt <- r_R_gnavus * R_gnavus * (1 - R_gnavus / max(0.0001, K_R_gnavus * (y_function_R_gnavus_Aprepitant_func(Drug))))
  dR_intestinalis_dt <- r_R_intestinalis * R_intestinalis * (1 - R_intestinalis / max(0.0001, K_R_intestinalis * (y_function_R_intestinalis_Aprepitant_func(Drug))))
  dR_torques_dt <- r_R_torques * R_torques * (1 - R_torques /K_R_torques) 
  dS_parasanguinis_dt <- r_S_parasanguinis * S_parasanguinis * (1 - S_parasanguinis / max(0.0001, K_S_parasanguinis * (y_function_S_parasanguinis_Aprepitant_func(Drug))))
  dS_salivarius_dt <- r_S_salivarius * S_salivarius * (1 - S_salivarius / max(0.0001, K_S_salivarius * (y_function_S_salivarius_Aprepitant_func(Drug))))
  dV_parvula_dt <- r_V_parvula * V_parvula * (1 - V_parvula / max(0.0001, K_V_parvula * (y_function_V_parvula_Aprepitant_func(Drug))))
  

  
  #Drug differential:
  dDrug_dt <- (subset(drug_dynamics, Drug == "Aprepitant")$Steepness_param_community * exp(-subset(drug_dynamics, Drug == "Aprepitant")$Steepness_param_community * t_mod)) * (drug_concentration_tested * prop_left_Aprepitant - drug_concentration_tested)
  #dDrug_dt <- 0
  
  ## Combine results into a single vector
  dxdt <- c(dA_muciniphila_dt, dB_adolescentis_dt, dB_fragilis_dt, dB_longum_dt, dB_obeum_dt, dB_thetaiotaomicron_dt, dB_uniformis_dt, dB_vulgatus_dt, dB_wadsworthia_dt, dC_aerofaciens_dt, dC_bolteae_dt, dC_comes_dt, dC_perfringens_dt, dC_ramosum_dt, dC_saccharolyticum_dt, dD_formicigenerans_dt, dE_coli_dt, dE_lenta_dt, dE_rectale_dt, dF_nucleatum_dt, dL_paracasei_dt, dO_splanchnicus_dt, dP_copri_dt, dP_distasonis_dt, dP_merdae_dt, dR_bromii_dt, dR_gnavus_dt, dR_intestinalis_dt, dR_torques_dt, dS_parasanguinis_dt, dS_salivarius_dt, dV_parvula_dt, dDrug_dt)
  
  ## Return result as a list
  list(dxdt)
}




#calculate the co-culture correction factor per species based on community composition in absence of drug, just like done for Niclosamide

growth_data_all_0_Niclosamide
growth_data_all_0_Niclosamide1 <- growth_data_all_0_Niclosamide %>%
  dplyr::mutate(Species = gsub(" ", "_", Species))


##Merge rel_ab_control with growth_data_all_0_Niclosamide on Species
##Function to remove duplicated columns by name pattern
clean_columns_base <- function(df, pattern) {
  cols_to_keep <- !grepl(pattern, names(df))
  df <- df[, cols_to_keep]
  return(df)
}

# Use the new function to clean up your dataframe
rel_ab_control <- clean_columns_base(rel_ab_control, "mean_max_OD.[xy]")
str(rel_ab_control)


#rel_ab_control$correction_factor <- rel_ab_control$mean_rel_ab / (rel_ab_control$mean_max_OD/sum(rel_ab_control$mean_max_OD))
# Calculate correction factor with a minimum value of ~1
rel_ab_control$correction_factor <- pmax(rel_ab_control$mean_rel_ab / (rel_ab_control$mean_max_OD / sum(rel_ab_control$mean_max_OD)), 1.1)


# Create a new dataframe for co-culture correction
co_culture_correction <- data.frame(
  species = rel_ab_control$Species,
  correction_factor = rel_ab_control$correction_factor
)


#summarise community data
#Adjust based on tested concentrations for each drug
unique(Community_compositions_focus_drugs_Aprepitant$concentration)

Community_compositions_focus_drugs_Aprepitant_5uM <- subset(Community_compositions_focus_drugs_Aprepitant, concentration == 5)
Community_compositions_focus_drugs_Aprepitant_20uM <- subset(Community_compositions_focus_drugs_Aprepitant, concentration == 20)
Community_compositions_focus_drugs_Aprepitant_30uM <- subset(Community_compositions_focus_drugs_Aprepitant, concentration == 30)


#5 uM
Community_compositions_focus_drugs_Aprepitant_5uM_summarised <- Community_compositions_focus_drugs_Aprepitant_5uM %>%
  dplyr::group_by(species) %>%                                  
  dplyr::summarize(
    mean_rel_ab = mean(rel_abundance, na.rm = TRUE),     
    sd_rel_ab = sd(rel_abundance, na.rm = TRUE) ,
    mean_max_OD = mean(maxOD, na.rm = TRUE),
    sd_max_OD = sd(maxOD, na.rm = TRUE),
    mean_final_OD = mean(finalOD, na.rm = TRUE),
    sd_final_OD = sd(finalOD, na.rm = TRUE)
  ) %>%
  dplyr::ungroup() 


Community_compositions_focus_drugs_Aprepitant_5uM_summarised <- Community_compositions_focus_drugs_Aprepitant_5uM_summarised %>%
  dplyr::mutate(Species = sub("^(\\w)\\w*\\s(.*)", "\\1._\\2", species))

#remove (sub)strain info
Community_compositions_focus_drugs_Aprepitant_5uM_summarised <- Community_compositions_focus_drugs_Aprepitant_5uM_summarised %>%
  dplyr::mutate(Species = sub("^(\\w\\._\\w+).*", "\\1", Species))


#20 uM
Community_compositions_focus_drugs_Aprepitant_20uM_summarised <- Community_compositions_focus_drugs_Aprepitant_20uM %>%
  dplyr::group_by(species) %>%                                  
  dplyr::summarize(
    mean_rel_ab = mean(rel_abundance, na.rm = TRUE),     
    sd_rel_ab = sd(rel_abundance, na.rm = TRUE) ,
    mean_max_OD = mean(maxOD, na.rm = TRUE),
    sd_max_OD = sd(maxOD, na.rm = TRUE),
    mean_final_OD = mean(finalOD, na.rm = TRUE),
    sd_final_OD = sd(finalOD, na.rm = TRUE)
  ) %>%
  dplyr::ungroup() 


Community_compositions_focus_drugs_Aprepitant_20uM_summarised <- Community_compositions_focus_drugs_Aprepitant_20uM_summarised %>%
  dplyr::mutate(Species = sub("^(\\w)\\w*\\s(.*)", "\\1._\\2", species))

#remove (sub)strain info
Community_compositions_focus_drugs_Aprepitant_20uM_summarised <- Community_compositions_focus_drugs_Aprepitant_20uM_summarised %>%
  dplyr::mutate(Species = sub("^(\\w\\._\\w+).*", "\\1", Species))


#30 uM
Community_compositions_focus_drugs_Aprepitant_30uM_summarised <- Community_compositions_focus_drugs_Aprepitant_30uM %>%
  dplyr::group_by(species) %>%                                  
  dplyr::summarize(
    mean_rel_ab = mean(rel_abundance, na.rm = TRUE),     
    sd_rel_ab = sd(rel_abundance, na.rm = TRUE) ,
    mean_max_OD = mean(maxOD, na.rm = TRUE),
    sd_max_OD = sd(maxOD, na.rm = TRUE),    
    mean_final_OD = mean(finalOD, na.rm = TRUE),
    sd_final_OD = sd(finalOD, na.rm = TRUE)
  ) %>%
  dplyr::ungroup() 



Community_compositions_focus_drugs_Aprepitant_30uM_summarised <- Community_compositions_focus_drugs_Aprepitant_30uM_summarised %>%
  dplyr::mutate(Species = sub("^(\\w)\\w*\\s(.*)", "\\1._\\2", species))

#remove (sub)strain info
Community_compositions_focus_drugs_Aprepitant_30uM_summarised <- Community_compositions_focus_drugs_Aprepitant_30uM_summarised %>%
  dplyr::mutate(Species = sub("^(\\w\\._\\w+).*", "\\1", Species))


#Initialise data frames
sim_output <- data.frame()
input_params_list <- list() #Use a list to collect parameters for each simulation

#number of simulations
num_sims <- 250


for (i in 1:num_sims) {
  tryCatch({
    # generate model parameters
    set.seed(i) #set a different seed for each simulation for variation
    params <- lapply(1:nrow(growth_data_all_0_Niclosamide), function(idx) {
      species_params <- growth_data_all_0_Niclosamide[idx, ]
      list(
        r = rnorm(1, mean = species_params$mean_max_Growth_rate, sd = species_params$sd_max_Growth_rate),
        K = rnorm(1, mean = species_params$mean_max_OD, sd = species_params$sd_max_OD)
      )
    })
    names(params) <- gsub(" ", "_", growth_data_all_0_Niclosamide$Species)
    flat_params <- unlist(params)
    names(flat_params) <- gsub("\\.\\d$", "", names(flat_params))
    
    #replace spaces with underscores to match formatting
    co_culture_correction$species <- gsub(" ", "_", co_culture_correction$species, fixed = TRUE)
    
    #replace the species-specific K parameters extracted from monoculture growth data 
    #with drawn relative abundance values at Niclosamide = 0, scaled to K
    rel_ab_control$Species <- gsub(" ", "_", rel_ab_control$Species)
    
    #Initialise an empty vector to store drawn values
    drawn_values <- numeric(nrow(rel_ab_control))
    
    #draw values from their respective distributions
    for (k in 1:nrow(rel_ab_control)) {
      species_name <- rel_ab_control$Species[k]
      drawn_value <- rnorm(1, mean = rel_ab_control$mean_rel_ab[k], sd = rel_ab_control$sd_rel_ab[k])
      drawn_values[k] <- max(drawn_value, 0)  # Ensure no negative values
    }
    
    #Normalise drawn relative abundance values so they sum to 1 (to reflect a 'true' relative abundance distribution)
    #this is needed so when we convert the values into OD units by multiplying with the drawn community maxOD,
    # the sum of K_i parameters and the drawn K are equal
    normalised_values <- drawn_values / sum(drawn_values)
    
    #Pull community maxOD (K) at 0 drugs from respective normal distribution:
    K <- rnorm(n = 1, mean = rel_ab_control$mean_com_max_OD[1], sd = rel_ab_control$sd_com_max_OD[1])
    
    # Assign these normalised values to their respective species' .K parameters
    for (k in 1:nrow(rel_ab_control)) {
      species_name <- rel_ab_control$Species[k]
      k_index <- grep(paste0("^", species_name, "\\.K$"), names(flat_params))
      
      if (length(k_index) > 0) {
        old_value <- flat_params[k_index]
        flat_params[k_index] <- (normalised_values[k] + 0.0001) * K #add small value in case drawn K_i is 0, which would cause issues with the solver
        cat(sprintf("Updated %s from %f to %f using normalised value %f scaled by K %f\n", names(flat_params)[k_index], old_value, flat_params[k_index], normalised_values[k], K))
      }
    }
    
    #Accounting for variation in drug degradation by community, with standard deviation of end concentration (at 10h) around the fitted predicted (relative) end concentration at 24h
    #prop_left_Aprepitant <- abs(rnorm(1, (subset(drug_dynamics, Drug == "Aprepitant")$Prop_left_24h_community), (subset(drug_dynamics, Drug == "Aprepitant")$SD_drug_community))) 
    #below, we account for measurement error rather than ecological drivers that lead to the variability of degradation at the final point measured 
    prop_left_Aprepitant <- abs(rnorm(
      n = 1, 
      mean = subset(drug_dynamics, Drug == "Aprepitant")$Prop_left_24h_community, 
      sd = ifelse(
        subset(drug_dynamics, Drug == "Aprepitant")$SD_drug_community > subset(drug_dynamics, Drug == "Aprepitant")$SD_drug_community_start, 
        subset(drug_dynamics, Drug == "Aprepitant")$SD_drug_community - subset(drug_dynamics, Drug == "Aprepitant")$SD_drug_community_start, 
        subset(drug_dynamics, Drug == "Aprepitant")$SD_drug_community
      )
    ))
    
    
    #loop through each species in co_culture_correction
    for (j in 1:nrow(co_culture_correction)) {
      # Extract the species name and correction factor
      species_name <- co_culture_correction$species[j]
      correction_factor <- co_culture_correction$correction_factor[j]
      
      # Identify the corresponding growth rate parameter in flat_params
      #by matching the base species name (without .r)
      growth_rate_indices <- grep(paste0("^", species_name, "\\.r$"), names(flat_params))
      
      #take the growth rate parameter and apply the correction factor 
      for (index in growth_rate_indices) {
        flat_params[index] <- flat_params[index] * correction_factor
      }
    }
    
    flat_params
    # Store parameters for each simulation
    input_params_list[[i]] <- c(sim_ID = i, flat_params)
    
    # Run the model for the first 24-hour cycle
    solution_cycle_1 <- ode(y = initial_conditions, times = seq(from = 0, to = 24, by = 0.1), func = closed.sir.model_Aprepitant, parms = flat_params,   method = "lsoda", rtol = 1e-6, atol = 1e-6)
    
    # Dilution and second cycle
    end_of_cycle_1 <- solution_cycle_1[nrow(solution_cycle_1), -1]
    initial_conditions_cycle_2 <- end_of_cycle_1 / 50
    #accounting for the drugs being added with the new growth cycle as well:
    initial_conditions_cycle_2[33] <- initial_conditions_cycle_2[33] + drug_concentration_tested
    solution_cycle_2 <- ode(y = initial_conditions_cycle_2, times = seq(from = 24, to = 48, by = 0.1), func = closed.sir.model_Aprepitant, parms = flat_params,  method = "lsoda", rtol = 1e-6, atol = 1e-6)
    
    # Combine and format results
    combined_solution <- rbind(as.data.frame(solution_cycle_1), as.data.frame(solution_cycle_2)[-1,])
    combined_solution$sim_ID <- rep(i, nrow(combined_solution))
    combined_solution <- combined_solution %>%
      tidyr::gather(key = "Species", value = "Density", -time, -sim_ID) %>%
      dplyr::mutate(Hour = time) %>%
      dplyr::select(sim_ID, Hour, Species, Density)
    
    ##Append to sim_output
    sim_output <- rbind(sim_output, combined_solution)
  }, error = function(e) {
    cat(sprintf("Skipping simulation %d due to an error: %s\n", i, e$message))
  })
}



##Combine all parameter data into a single dataframe
input_params <- do.call(rbind, input_params_list)

# Add a "Species" column 
sim_output$Species_name <- species_names[as.numeric(as.character(sim_output$Species))]
sim_output$Species_name <- replace_na(sim_output$Species_name, "Drug")

#View(input_params)
#View(sim_output)

sim_output <- na.omit(sim_output)
successful_sim_ids <- unique(subset(sim_output, Hour == 48)$sim_ID)
length(successful_sim_ids)
sim_output1 <- sim_output[sim_output$sim_ID %in% successful_sim_ids, ]


#Transform sim_output so we have wide format by Species
sim_output_wide <- tidyr::pivot_wider(sim_output1, 
                                      names_from = Species_name, 
                                      values_from = Density,
                                      id_cols = c(sim_ID, Hour))

length(unique(sim_output_wide$sim_ID))
#calc community OD per timepoint
sim_output_wide$Total_OD <- rowSums(sim_output_wide[, 3:34], na.rm = TRUE)
#calculate and add relative abundances here as well:
species_columns <- colnames(sim_output_wide)[3:34] 

for (species in species_columns) {
  sim_output_wide[[paste0("rel_", species)]] <- sim_output_wide[[species]] / sim_output_wide$Total_OD
}


#assign sim_output_wide test conditions to dataframe name
drug_tested <- "Aprepitant"
variable_name_1 <- paste0("sim_output_wide_", ifelse(drug_concentration_tested == 1e-04, 0, drug_concentration_tested), "_", drug_tested)
assign(variable_name_1, sim_output_wide)

#turn back into long format if interested in plotting relative abundances
cols_needed <- c("sim_ID", "Hour")

sim_output_long <- sim_output_wide %>% 
  dplyr::select(sim_ID, Hour, Drug, starts_with("rel_")) %>% 
  tidyr::pivot_longer(
    cols = c(Drug, starts_with("rel_")),
    names_to = "Species", 
    values_to = "Relative_abundance",
    names_prefix = "rel_",
    names_transform = list(Species = ~ ifelse(.x == "Drug", "Drug", .x))
  ) 

str(sim_output_long)


species_names_1 <- c(
  "A_muciniphila",
  "B_adolescentis",
  "B_fragilis",
  "B_longum",
  "B_obeum",
  "B_thetaiotaomicron",
  "B_uniformis",
  "B_vulgatus",
  "B_wadsworthia",
  "C_aerofaciens",
  "C_bolteae",
  "C_comes",
  "C_perfringens",
  "C_ramosum",
  "C_saccharolyticum",
  "D_formicigenerans",
  "E_coli",
  "E_lenta",
  "E_rectale",
  "F_nucleatum",
  "L_paracasei",
  "O_splanchnicus",
  "P_copri",
  "P_distasonis",
  "P_merdae",
  "R_bromii",
  "R_gnavus",
  "R_intestinalis",
  "R_torques",
  "S_parasanguinis",
  "S_salivarius",
  "V_parvula",
  "Drug"
)

species_colours_1 <- c(
  "A_muciniphila" = "#1f77b4",
  "B_adolescentis" = "#ff7f0e",
  "B_fragilis" = "#2ca02c",
  "B_longum" = "#d62728",
  "B_obeum" = "#9467bd",
  "B_thetaiotaomicron" = "black",
  "B_uniformis" = "#e377c2",
  "B_vulgatus" = "#7f7f7f",
  "B_wadsworthia" = "gold1",
  "C_aerofaciens" = "#aec7e8",
  "C_bolteae" = "#ffbb78",
  "C_comes" = "magenta",
  "C_perfringens" = "#ff9896",
  "C_ramosum" = "#c5b0d5",
  "C_saccharolyticum" = "#c49c94",
  "D_formicigenerans" = "#f7b6d2",
  "E_coli" = "yellow",
  "E_lenta" = "turquoise",
  "E_rectale" = "#393b79",
  "F_nucleatum" = "royalblue2",
  "L_paracasei" = "blue",
  "O_splanchnicus" = "#637939",
  "P_copri" = "cyan",
  "P_distasonis" = "#8c6d31",
  "P_merdae" = "#c7c7c7",
  "R_bromii" = "#e6550d",
  "R_gnavus" = "#e7cb94",
  "R_intestinalis" = "#843c39",
  "R_torques" = "#d6616b",
  "S_parasanguinis" = "orange3",
  "S_salivarius" = "#7b4173",
  "V_parvula" = "#ce6dbd",
  "Drug" = "green"
)



##Plot output for any specific sim:
# ggplot(subset(sim_output, sim_ID == 1 & Species_name != "Drug"), aes(x = Hour, y = Density, group = Species_name, color = Species_name)) +
#   geom_line(size = 1, alpha = 0.7) +
#   scale_color_manual(values = species_colours_1) +
#   labs(title = paste0("Aprepitant = ", drug_concentration_tested),
#        x = "Time (hours)",
#        y = "Population Density (OD)",
#        color = "Species") +
#   theme_minimal() +
#   theme(legend.position = "right")
# 
# ggplot(subset(sim_output, sim_ID == 3 & Species_name != "Drug"), aes(x = Hour, y = Density, group = Species_name, color = Species_name)) +
#   geom_line(size = 1, alpha = 0.7) +
#   scale_color_manual(values = species_colours_1) +
#   labs(title = paste0("Aprepitant = ", drug_concentration_tested),
#        x = "Time (hours)",
#        y = "Population Density (OD)",
#        color = "Species") +
#   theme_minimal() +
#   theme(legend.position = "right")


ggplot(subset(sim_output_long, sim_ID == 1), aes(x = Hour, y = Relative_abundance, group = Species, color = Species)) +
  geom_line(size = 1, alpha = 0.7) +
  scale_color_manual(values = species_colours_1) +
  labs(title = paste0("Aprepitant = ", drug_concentration_tested),
       x = "Time (hours)",
       y = "Relative abundance",
       color = "Species") +
  theme_minimal() +
  theme(legend.position = "right")


ggplot(subset(sim_output_long, sim_ID == 3), aes(x = Hour, y = Relative_abundance, group = Species, color = Species)) +
  geom_line(size = 1, alpha = 0.7) +
  scale_color_manual(values = species_colours_1) +
  labs(title = paste0("Aprepitant = ", drug_concentration_tested),
       x = "Time (hours)",
       y = "Relative abundance",
       color = "Species") +
  theme_minimal() +
  theme(legend.position = "right")


#calc mean and standard deviation across sims
sim_stats <- sim_output_long %>%
  dplyr::group_by(Hour, Species) %>%
  dplyr::summarise(
    mean_rel_ab = mean(Relative_abundance),
    sd_rel_ab = sd(Relative_abundance),
    .groups = 'drop'
  )

#Prepare the data for plotting
plot_data <- sim_stats %>%
  dplyr::mutate(Upper = mean_rel_ab + sd_rel_ab, Lower = mean_rel_ab - sd_rel_ab)

ggplot(subset(plot_data, Species != "Drug"), aes(x = Hour, y = mean_rel_ab, group = Species, color = Species)) +
  geom_ribbon(aes(ymin = Lower, ymax = Upper, fill = Species), colour = NA, alpha = 0.2) +  
  geom_line(size = 1, alpha = 0.7) + 
  scale_color_manual(values = species_colours_1) +
  scale_fill_manual(values = species_colours_1) +  
  labs(title = "Mean and SD of Relative Abundance Across Simulations",
       subtitle = paste0("Aprepitant = ", drug_concentration_tested),       
       x = "Time (hours)",
       y = "Relative abundance",
       color = "Species",
       fill = "Species") +
  theme_minimal() +
  theme(legend.position = "right")

#log-scaled mean trends
ggplot(plot_data, aes(x = Hour, y = log10(mean_rel_ab + 0.0001), group = Species, color = Species)) +
  geom_line(size = 1, alpha = 0.7) +  # Mean line
  scale_color_manual(values = species_colours_1) +
  scale_fill_manual(values = species_colours_1) +  # Ensure consistent colors for lines and fills
  labs(title = "Mean and SD of Relative Abundance Across Simulations",
       subtitle = paste0("Aprepitant = ", drug_concentration_tested),
       x = "Time (hours)",
       y = "Relative abundance",
       color = "Species",
       fill = "Species") +
  theme_minimal() +
  theme(legend.position = "right")




##prediction quality evaluation
drug_tested <- "Aprepitant"
variable_name <- paste0("plot_data_", ifelse(drug_concentration_tested == 1e-04, 0, drug_concentration_tested), "_", drug_tested)
assign(variable_name, plot_data)


#extract total OD info:
predicted_mean_final_od_NULL <- Niclosamide_16S_0uM_summarised$mean_com_final_OD[1]
predicted_sd_final_od_NULL <- Niclosamide_16S_0uM_summarised$sd_com_final_OD[1]

predicted_mean_final_od_5_Aprepitant <- mean(subset(sim_output_wide_5_Aprepitant, Hour == 48)$Total_OD, na.rm = TRUE)
predicted_sd_final_od_5_Aprepitant <- sd(subset(sim_output_wide_5_Aprepitant, Hour == 48)$Total_OD, na.rm = TRUE)

real_mean_final_od_5_Aprepitant <- Community_compositions_focus_drugs_Aprepitant_5uM_summarised$mean_final_OD[1]
real_sd_final_od_5_Aprepitant <- Community_compositions_focus_drugs_Aprepitant_5uM_summarised$sd_final_OD[1]


predicted_mean_final_od_20_Aprepitant <- mean(subset(sim_output_wide_20_Aprepitant, Hour == 48)$Total_OD, na.rm = TRUE)
predicted_sd_final_od_20_Aprepitant <- sd(subset(sim_output_wide_20_Aprepitant, Hour == 48)$Total_OD, na.rm = TRUE)

real_mean_final_od_20_Aprepitant <- Community_compositions_focus_drugs_Aprepitant_20uM_summarised$mean_final_OD[1]
real_sd_final_od_20_Aprepitant <- Community_compositions_focus_drugs_Aprepitant_20uM_summarised$sd_final_OD[1]


predicted_mean_final_od_30_Aprepitant <- mean(subset(sim_output_wide_30_Aprepitant, Hour == 48)$Total_OD, na.rm = TRUE)
predicted_sd_final_od_30_Aprepitant <- sd(subset(sim_output_wide_30_Aprepitant, Hour == 48)$Total_OD, na.rm = TRUE)

real_mean_final_od_30_Aprepitant <- Community_compositions_focus_drugs_Aprepitant_30uM_summarised$mean_final_OD[1]
real_sd_final_od_30_Aprepitant <- Community_compositions_focus_drugs_Aprepitant_30uM_summarised$sd_final_OD[1]




#plot_data_0_Aprepitant_endpoint was used to test model performance at 0 drugs
#plot_data_0_Aprepitant_endpoint <- subset(plot_data_0_Aprepitant, Hour == 48 & Species != "Drug")
plot_data_5_Aprepitant_endpoint <- subset(plot_data_5_Aprepitant, Hour == 48 & Species != "Drug")
plot_data_20_Aprepitant_endpoint <- subset(plot_data_20_Aprepitant, Hour == 48 & Species != "Drug")
plot_data_30_Aprepitant_endpoint <- subset(plot_data_30_Aprepitant, Hour == 48 & Species != "Drug")

##Inspecting 'match' to real relative abundance distributions:
Niclosamide_16S_0uM_summarised <- rel_ab_control
Niclosamide_16S_0uM_summarised$Species <- gsub("\\.", "", Niclosamide_16S_0uM_summarised$Species)

Aprepitant_16S_5uM_summarised <- Community_compositions_focus_drugs_Aprepitant_5uM_summarised
Aprepitant_16S_20uM_summarised <- Community_compositions_focus_drugs_Aprepitant_20uM_summarised
Aprepitant_16S_30uM_summarised <- Community_compositions_focus_drugs_Aprepitant_30uM_summarised

Niclosamide_16S_0uM_summarised
Aprepitant_16S_5uM_summarised 
Aprepitant_16S_20uM_summarised 
Aprepitant_16S_30uM_summarised 

#Rename 'species' so the outputs become comparable
original_names_30 <- unique(Aprepitant_16S_30uM_summarised$species)
original_names_20 <- unique(Aprepitant_16S_20uM_summarised$species)
original_names_5 <- unique(Aprepitant_16S_5uM_summarised$species)


##Create a named vector with the original and new names mapping
name_changes <- c(
  "Akkermansia muciniphila" = "A_muciniphila",
  "Bacteroides fragilis" = "B_fragilis",
  "Bacteroides thetaiotaomicron" = "B_thetaiotaomicron",
  "Bacteroides uniformis" = "B_uniformis",
  "Bifidobacterium adolescentis" = "B_adolescentis",
  "Bifidobacterium longum subsp. longum" = "B_longum",
  "Bilophila wadsworthia" = "B_wadsworthia",
  "Blautia obeum" = "B_obeum",
  "Clostridium perfringens" = "C_perfringens",
  "Collinsella aerofaciens" = "C_aerofaciens",
  "Coprococcus comes" = "C_comes",
  "Dorea formicigenerans" = "D_formicigenerans",
  "Eggerthella lenta" = "E_lenta",
  "Enterocloster bolteae" = "C_bolteae",
  "Erysipelatoclostridium ramosum" = "C_ramosum",
  "Escherichia coli ED1a" = "E_coli",
  "Eubacterium rectale" = "E_rectale",
  "Fusobacterium nucleatum subsp. nucleatum" = "F_nucleatum",
  "Lacrimispora saccharolytica" = "C_saccharolyticum",
  "Lacticaseibacillus paracasei" = "L_paracasei",
  "Odoribacter splanchnicus" = "O_splanchnicus",
  "Parabacteroides distasonis" = "P_distasonis",
  "Parabacteroides merdae" = "P_merdae",
  "Phocaeicola vulgatus" = "B_vulgatus",
  "Prevotella copri" = "P_copri",
  "Roseburia intestinalis" = "R_intestinalis",
  "Ruminococcus bromii" = "R_bromii",
  "Ruminococcus gnavus" = "R_gnavus",
  "Ruminococcus torques" = "R_torques",
  "Streptococcus parasanguinis" = "S_parasanguinis",
  "Streptococcus salivarius" = "S_salivarius",
  "Veillonella parvula" = "V_parvula"
)

# Apply name changes to the species column in Aprepitant_16S_30uM_summarised

Aprepitant_16S_30uM_summarised$Species <- name_changes[Aprepitant_16S_30uM_summarised$species]
Aprepitant_16S_20uM_summarised$Species <- name_changes[Aprepitant_16S_20uM_summarised$species]
Aprepitant_16S_5uM_summarised$Species <- name_changes[Aprepitant_16S_5uM_summarised$species]

# Verify the changes
unique(Aprepitant_16S_30uM_summarised$Species)
unique(Aprepitant_16S_20uM_summarised$Species)
unique(Aprepitant_16S_5uM_summarised$Species)



##First, for 5 uM:
# Get top 6 species from plot_data_5_endpoint
# Adjust the plot_data_5_endpoint with confidence bounds

# #plot_data_0_Aprepitant_endpoint was used to test model performance at 0 drugs
# plot_data_0_Aprepitant_endpoint <- plot_data_0_Aprepitant_endpoint %>%
#   dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)

plot_data_5_Aprepitant_endpoint <- plot_data_5_Aprepitant_endpoint %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)

# Adjust the Aprepitant_16S_5uM_summarised with confidence bounds
Aprepitant_16S_5uM_summarised <- Aprepitant_16S_5uM_summarised %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)

#NULL model:
Null_model_summarised <- Niclosamide_16S_0uM_summarised %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)


# Get top 6 species based on the lower bound from plot_data_5_endpoint

#top6_predicted_0_Aprepitant was used to test model performance at 0 drugs
# top6_predicted_0_Aprepitant <- plot_data_0_Aprepitant_endpoint %>%
#    arrange(desc(lower_bound)) %>%
#    slice(1:6) %>%
#    pull(Species)

top6_predicted_5_Aprepitant <- plot_data_5_Aprepitant_endpoint %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

# Get top 6 species based on the lower bound from Aprepitant_16S_5uM_summarised
top6_real_5_Aprepitant <- Aprepitant_16S_5uM_summarised %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

top6_NULL <- Null_model_summarised %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

# Calculate the overlap of top 6 species

#top_six_correct_0_Aprepitant was used to assess model performance at 0 drugs
# top_six_correct_0_Aprepitant <- length(intersect(top6_predicted_0_Aprepitant, top6_NULL))
# top_six_correct_0_Aprepitant

top_six_correct_5_Aprepitant <- length(intersect(top6_predicted_5_Aprepitant, top6_real_5_Aprepitant))
top_six_correct_5_Aprepitant

top_six_correct_5_Aprepitant_NULL <- length(intersect(top6_NULL, top6_real_5_Aprepitant))
top_six_correct_5_Aprepitant_NULL

top6_predicted_5_Aprepitant
top6_real_5_Aprepitant

#top6_NULL

#Now by means:
# #top6_predicted_0_Aprepitant_means was used to assess model performance at 0 drugs
# top6_predicted_0_Aprepitant_means <- plot_data_0_Aprepitant_endpoint %>%
#    arrange(desc(mean_rel_ab)) %>%
#    slice(1:6) %>%
#    pull(Species)

top6_predicted_5_Aprepitant_means <- plot_data_5_Aprepitant_endpoint %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)

# Get top 6 species based on the lower bound from Aprepitant_16S_5uM_summarised
top6_real_5_Aprepitant_means <- Aprepitant_16S_5uM_summarised %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)

top6_NULL_means <- Null_model_summarised %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)


# #top_six_correct_0_Aprepitant_means was used to assess model performance at 0 drugs
# top_six_correct_0_Aprepitant_means <- length(intersect(top6_predicted_0_Aprepitant_means, top6_NULL_means))
# top_six_correct_0_Aprepitant_means

top_six_correct_5_Aprepitant_means <- length(intersect(top6_predicted_5_Aprepitant_means, top6_real_5_Aprepitant_means))
top_six_correct_5_Aprepitant_means

top_six_correct_5_Aprepitant_means_NULL <- length(intersect(top6_NULL_means, top6_real_5_Aprepitant_means))
top_six_correct_5_Aprepitant_means_NULL

top6_predicted_5_Aprepitant_means
top6_real_5_Aprepitant_means

#top6_NULL_means


# Merge dataframes by Species

#merged_data_0_Aprepitant was used to assess model performance at 0 drugs
#merged_data_0_Aprepitant <- merge(plot_data_0_Aprepitant_endpoint, Niclosamide_16S_0uM_summarised, by = "Species", suffixes = c(".pred", ".real"))
merged_data_5_Aprepitant <- merge(plot_data_5_Aprepitant_endpoint, Aprepitant_16S_5uM_summarised, by = "Species", suffixes = c(".pred", ".real"))
merged_data_5_Aprepitant_NULL <- merge(Niclosamide_16S_0uM_summarised, Aprepitant_16S_5uM_summarised, by = "Species", suffixes = c(".null", ".real"))


## Below lines used for assessing model performance at 0 drugs; ignore for nonzero concentrations
# # Create lower and upper bounds considering mean ¬± sd
# merged_data_0_Aprepitant$lower_bound_pred <- merged_data_0_Aprepitant$mean_rel_ab.pred - merged_data_0_Aprepitant$sd_rel_ab.pred
# merged_data_0_Aprepitant$upper_bound_pred <- merged_data_0_Aprepitant$mean_rel_ab.pred + merged_data_0_Aprepitant$sd_rel_ab.pred
# merged_data_0_Aprepitant$lower_bound_real <- merged_data_0_Aprepitant$mean_rel_ab.real - merged_data_0_Aprepitant$sd_rel_ab.real
# merged_data_0_Aprepitant$upper_bound_real <- merged_data_0_Aprepitant$mean_rel_ab.real + merged_data_0_Aprepitant$sd_rel_ab.real
# 
# # Ensure lower and upper bounds are non-negative, adjusting as necessary
# merged_data_0_Aprepitant$lower_bound_pred[merged_data_0_Aprepitant$lower_bound_pred <= 0] <- 1e-10
# merged_data_0_Aprepitant$lower_bound_real[merged_data_0_Aprepitant$lower_bound_real <= 0] <- 1e-10
# merged_data_0_Aprepitant$upper_bound_pred[merged_data_0_Aprepitant$upper_bound_pred <= 0] <- 1e-10
# merged_data_0_Aprepitant$upper_bound_real[merged_data_0_Aprepitant$upper_bound_real <= 0] <- 1e-10


# Create lower and upper bounds considering mean ¬± sd
merged_data_5_Aprepitant$lower_bound_pred <- merged_data_5_Aprepitant$mean_rel_ab.pred - merged_data_5_Aprepitant$sd_rel_ab.pred
merged_data_5_Aprepitant$upper_bound_pred <- merged_data_5_Aprepitant$mean_rel_ab.pred + merged_data_5_Aprepitant$sd_rel_ab.pred
merged_data_5_Aprepitant$lower_bound_real <- merged_data_5_Aprepitant$mean_rel_ab.real - merged_data_5_Aprepitant$sd_rel_ab.real
merged_data_5_Aprepitant$upper_bound_real <- merged_data_5_Aprepitant$mean_rel_ab.real + merged_data_5_Aprepitant$sd_rel_ab.real

# Ensure lower and upper bounds are non-negative, adjusting as necessary
merged_data_5_Aprepitant$lower_bound_pred[merged_data_5_Aprepitant$lower_bound_pred <= 0] <- 1e-10
merged_data_5_Aprepitant$lower_bound_real[merged_data_5_Aprepitant$lower_bound_real <= 0] <- 1e-10
merged_data_5_Aprepitant$upper_bound_pred[merged_data_5_Aprepitant$upper_bound_pred <= 0] <- 1e-10
merged_data_5_Aprepitant$upper_bound_real[merged_data_5_Aprepitant$upper_bound_real <= 0] <- 1e-10

##and for NULL model:
# Create lower and upper bounds considering mean ¬± sd
merged_data_5_Aprepitant_NULL$lower_bound_null <- merged_data_5_Aprepitant_NULL$mean_rel_ab.null - merged_data_5_Aprepitant_NULL$sd_rel_ab.null
merged_data_5_Aprepitant_NULL$upper_bound_null <- merged_data_5_Aprepitant_NULL$mean_rel_ab.null + merged_data_5_Aprepitant_NULL$sd_rel_ab.null
merged_data_5_Aprepitant_NULL$lower_bound_real <- merged_data_5_Aprepitant_NULL$mean_rel_ab.real - merged_data_5_Aprepitant_NULL$sd_rel_ab.real
merged_data_5_Aprepitant_NULL$upper_bound_real <- merged_data_5_Aprepitant_NULL$mean_rel_ab.real + merged_data_5_Aprepitant_NULL$sd_rel_ab.real

# Ensure lower and upper bounds are non-negative, adjusting as necessary
merged_data_5_Aprepitant_NULL$lower_bound_null[merged_data_5_Aprepitant_NULL$lower_bound_null <= 0] <- 1e-10
merged_data_5_Aprepitant_NULL$lower_bound_real[merged_data_5_Aprepitant_NULL$lower_bound_real <= 0] <- 1e-10
merged_data_5_Aprepitant_NULL$upper_bound_null[merged_data_5_Aprepitant_NULL$upper_bound_null <= 0] <- 1e-10
merged_data_5_Aprepitant_NULL$upper_bound_real[merged_data_5_Aprepitant_NULL$upper_bound_real <= 0] <- 1e-10

# Filter to include only species with a mean relative abundance > 0.01 in the 'real' dataset

## significant_species_0 was used to assess model performance at 0 drugs
#significant_species_0 <- merged_data_0_Aprepitant[merged_data_0_Aprepitant$mean_rel_ab.real > 0.01, ]
significant_species <- merged_data_5_Aprepitant[merged_data_5_Aprepitant$mean_rel_ab.real > 0.01, ]
survivors_5_Aprepitant <- nrow(significant_species)
survivors_5_Aprepitant

#should be the same as survivors defined above, since it is calculated from .real
significant_species_NULL <- merged_data_5_Aprepitant_NULL[merged_data_5_Aprepitant_NULL$mean_rel_ab.real > 0.01, ]
survivors_5_Aprepitant_NULL <- nrow(significant_species_NULL)
survivors_5_Aprepitant_NULL

# Adjusted order of magnitude check to include SD, only for significant species
## below code was used to assess model performance at 0 drugs
# significant_species_0$Predicted_magnitude_correct <- ifelse(
#   (floor(log10(significant_species_0$lower_bound_pred)) <= floor(log10(significant_species_0$upper_bound_real)) &
#      floor(log10(significant_species_0$upper_bound_pred)) >= floor(log10(significant_species_0$lower_bound_real))),
#   1,
#   0
# )

significant_species$Predicted_magnitude_correct <- ifelse(
  (floor(log10(significant_species$lower_bound_pred)) <= floor(log10(significant_species$upper_bound_real)) &
     floor(log10(significant_species$upper_bound_pred)) >= floor(log10(significant_species$lower_bound_real))),
  1,
  0
)

#and for the Null model:
significant_species_NULL$Predicted_magnitude_correct <- ifelse(
  (floor(log10(significant_species_NULL$lower_bound_null)) <= floor(log10(significant_species_NULL$upper_bound_real)) &
     floor(log10(significant_species_NULL$upper_bound_null)) >= floor(log10(significant_species_NULL$lower_bound_real))),
  1,
  0
)

# Calculate the fraction of correctly predicted magnitudes for significant species
## below code was used to assess model performance at 0 drugs
#predicted_magnitude_correct_fraction_0_Aprepitant <- sum(significant_species_0$Predicted_magnitude_correct) / nrow(significant_species_0)
#predicted_magnitude_correct_fraction_0_Aprepitant

predicted_magnitude_correct_fraction_5_Aprepitant <- sum(significant_species$Predicted_magnitude_correct) / nrow(significant_species)
predicted_magnitude_correct_fraction_5_Aprepitant

predicted_magnitude_correct_fraction_5_Aprepitant_NULL <- sum(significant_species_NULL$Predicted_magnitude_correct) / nrow(significant_species_NULL)
predicted_magnitude_correct_fraction_5_Aprepitant_NULL

top_species_missing_5_Aprepitant <- setdiff(top6_real_5_Aprepitant_means, top6_predicted_5_Aprepitant_means)
top_species_wrong_5_Aprepitant <- setdiff(top6_predicted_5_Aprepitant_means, top6_real_5_Aprepitant_means)


Prediction_quality_5_Aprepitant <- data.frame(
  Top_six_correct = paste(top_six_correct_5_Aprepitant, sep=""),
  Top_six_correct_NULL = paste(top_six_correct_5_Aprepitant_NULL, sep=""),
  Top_six_correct_means = paste(top_six_correct_5_Aprepitant_means, sep=""),
  Top_six_correct_means_NULL = paste(top_six_correct_5_Aprepitant_means_NULL, sep=""),
  Predicted_magnitude_correct = paste(round(predicted_magnitude_correct_fraction_5_Aprepitant * 100, 2), "%", sep=""),
  Predicted_magnitude_correct_NULL = paste(round(predicted_magnitude_correct_fraction_5_Aprepitant_NULL * 100, 2), "%", sep=""),
  survivors_total = survivors_5_Aprepitant,
  top_species_missing <- top_species_missing_5_Aprepitant,
  top_species_wrong <- top_species_wrong_5_Aprepitant, 
  predicted_mean_final_OD <- predicted_mean_final_od_5_Aprepitant,
  real_mean_final_OD <- real_mean_final_od_5_Aprepitant,
  sims_total = length(successful_sim_ids)
)



Prediction_quality_5_Aprepitant



##Next, for 20 uM:
# Get top 6 species from plot_data_20_endpoint
# Adjust the plot_data_20_endpoint with confidence bounds
plot_data_20_Aprepitant_endpoint <- plot_data_20_Aprepitant_endpoint %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)

# Adjust the Aprepitant_16S_20uM_summarised with confidence bounds
Aprepitant_16S_20uM_summarised <- Aprepitant_16S_20uM_summarised %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)

#NULL model:
Null_model_summarised <- Niclosamide_16S_0uM_summarised %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)


# Get top 6 species based on the lower bound from plot_data_20_endpoint
top6_predicted_20_Aprepitant <- plot_data_20_Aprepitant_endpoint %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

# Get top 6 species based on the lower bound from Aprepitant_16S_20uM_summarised
top6_real_20_Aprepitant <- Aprepitant_16S_20uM_summarised %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

top6_NULL <- Null_model_summarised %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

# Calculate the overlap of top 6 species
top_six_correct_20_Aprepitant <- length(intersect(top6_predicted_20_Aprepitant, top6_real_20_Aprepitant))
#top_six_correct_20_Aprepitant

top_six_correct_20_Aprepitant_NULL <- length(intersect(top6_NULL, top6_real_20_Aprepitant))
#top_six_correct_20_Aprepitant_NULL

#top6_predicted_20_Aprepitant
#top6_real_20_Aprepitant



#Now by means:
top6_predicted_20_Aprepitant_means <- plot_data_20_Aprepitant_endpoint %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)

# Get top 6 species based on the lower bound from Aprepitant_16S_20uM_summarised
top6_real_20_Aprepitant_means <- Aprepitant_16S_20uM_summarised %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)

top6_NULL_means <- Null_model_summarised %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)



top_six_correct_20_Aprepitant_means <- length(intersect(top6_predicted_20_Aprepitant_means, top6_real_20_Aprepitant_means))
#top_six_correct_20_Aprepitant_means

top_six_correct_20_Aprepitant_means_NULL <- length(intersect(top6_NULL_means, top6_real_20_Aprepitant_means))
#top_six_correct_20_Aprepitant_means_NULL

top6_predicted_20_Aprepitant_means
#top6_real_20_Aprepitant_means




# Merge dataframes by Species
merged_data_20_Aprepitant <- merge(plot_data_20_Aprepitant_endpoint, Aprepitant_16S_20uM_summarised, by = "Species", suffixes = c(".pred", ".real"))
merged_data_20_Aprepitant_NULL <- merge(Niclosamide_16S_0uM_summarised, Aprepitant_16S_20uM_summarised, by = "Species", suffixes = c(".null", ".real"))



# Create lower and upper bounds considering mean ¬± sd
merged_data_20_Aprepitant$lower_bound_pred <- merged_data_20_Aprepitant$mean_rel_ab.pred - merged_data_20_Aprepitant$sd_rel_ab.pred
merged_data_20_Aprepitant$upper_bound_pred <- merged_data_20_Aprepitant$mean_rel_ab.pred + merged_data_20_Aprepitant$sd_rel_ab.pred
merged_data_20_Aprepitant$lower_bound_real <- merged_data_20_Aprepitant$mean_rel_ab.real - merged_data_20_Aprepitant$sd_rel_ab.real
merged_data_20_Aprepitant$upper_bound_real <- merged_data_20_Aprepitant$mean_rel_ab.real + merged_data_20_Aprepitant$sd_rel_ab.real

# Ensure lower and upper bounds are non-negative, adjusting as necessary
merged_data_20_Aprepitant$lower_bound_pred[merged_data_20_Aprepitant$lower_bound_pred <= 0] <- 1e-10
merged_data_20_Aprepitant$lower_bound_real[merged_data_20_Aprepitant$lower_bound_real <= 0] <- 1e-10
merged_data_20_Aprepitant$upper_bound_pred[merged_data_20_Aprepitant$upper_bound_pred <= 0] <- 1e-10
merged_data_20_Aprepitant$upper_bound_real[merged_data_20_Aprepitant$upper_bound_real <= 0] <- 1e-10

##and for NULL model:
# Create lower and upper bounds considering mean ¬± sd
merged_data_20_Aprepitant_NULL$lower_bound_null <- merged_data_20_Aprepitant_NULL$mean_rel_ab.null - merged_data_20_Aprepitant_NULL$sd_rel_ab.null
merged_data_20_Aprepitant_NULL$upper_bound_null <- merged_data_20_Aprepitant_NULL$mean_rel_ab.null + merged_data_20_Aprepitant_NULL$sd_rel_ab.null
merged_data_20_Aprepitant_NULL$lower_bound_real <- merged_data_20_Aprepitant_NULL$mean_rel_ab.real - merged_data_20_Aprepitant_NULL$sd_rel_ab.real
merged_data_20_Aprepitant_NULL$upper_bound_real <- merged_data_20_Aprepitant_NULL$mean_rel_ab.real + merged_data_20_Aprepitant_NULL$sd_rel_ab.real

# Ensure lower and upper bounds are non-negative, adjusting as necessary
merged_data_20_Aprepitant_NULL$lower_bound_null[merged_data_20_Aprepitant_NULL$lower_bound_null <= 0] <- 1e-10
merged_data_20_Aprepitant_NULL$lower_bound_real[merged_data_20_Aprepitant_NULL$lower_bound_real <= 0] <- 1e-10
merged_data_20_Aprepitant_NULL$upper_bound_null[merged_data_20_Aprepitant_NULL$upper_bound_null <= 0] <- 1e-10
merged_data_20_Aprepitant_NULL$upper_bound_real[merged_data_20_Aprepitant_NULL$upper_bound_real <= 0] <- 1e-10

# Filter to include only species with a mean relative abundance > 0.01 in the 'real' dataset
significant_species <- merged_data_20_Aprepitant[merged_data_20_Aprepitant$mean_rel_ab.real > 0.01, ]
survivors_20_Aprepitant <- nrow(significant_species)
survivors_20_Aprepitant

#should be the same as survivors defined above, since it is calculated from .real
significant_species_NULL <- merged_data_20_Aprepitant_NULL[merged_data_20_Aprepitant_NULL$mean_rel_ab.real > 0.01, ]
survivors_20_Aprepitant_NULL <- nrow(significant_species_NULL)
survivors_20_Aprepitant_NULL

# Adjusted order of magnitude check to include SD, only for significant species
significant_species$Predicted_magnitude_correct <- ifelse(
  (floor(log10(significant_species$lower_bound_pred)) <= floor(log10(significant_species$upper_bound_real)) &
     floor(log10(significant_species$upper_bound_pred)) >= floor(log10(significant_species$lower_bound_real))),
  1,
  0
)

#and for the Null model:
significant_species_NULL$Predicted_magnitude_correct <- ifelse(
  (floor(log10(significant_species_NULL$lower_bound_null)) <= floor(log10(significant_species_NULL$upper_bound_real)) &
     floor(log10(significant_species_NULL$upper_bound_null)) >= floor(log10(significant_species_NULL$lower_bound_real))),
  1,
  0
)

# Calculate the fraction of correctly predicted magnitudes for significant species
predicted_magnitude_correct_fraction_20_Aprepitant <- sum(significant_species$Predicted_magnitude_correct) / nrow(significant_species)
predicted_magnitude_correct_fraction_20_Aprepitant

predicted_magnitude_correct_fraction_20_Aprepitant_NULL <- sum(significant_species_NULL$Predicted_magnitude_correct) / nrow(significant_species_NULL)
predicted_magnitude_correct_fraction_20_Aprepitant_NULL

top_species_missing_20_Aprepitant <- setdiff(top6_real_20_Aprepitant_means, top6_predicted_20_Aprepitant_means)
top_species_wrong_20_Aprepitant <- setdiff(top6_predicted_20_Aprepitant_means, top6_real_20_Aprepitant_means)

Prediction_quality_20_Aprepitant <- data.frame(
  Top_six_correct = paste(top_six_correct_20_Aprepitant, sep=""),
  Top_six_correct_NULL = paste(top_six_correct_20_Aprepitant_NULL, sep=""),
  Top_six_correct_means = paste(top_six_correct_20_Aprepitant_means, sep=""),
  Top_six_correct_means_NULL = paste(top_six_correct_20_Aprepitant_means_NULL, sep=""),
  Predicted_magnitude_correct = paste(round(predicted_magnitude_correct_fraction_20_Aprepitant * 100, 2), "%", sep=""),
  Predicted_magnitude_correct_NULL = paste(round(predicted_magnitude_correct_fraction_20_Aprepitant_NULL * 100, 2), "%", sep=""),
  survivors_total = survivors_20_Aprepitant,
  top_species_missing <- top_species_missing_20_Aprepitant,
  top_species_wrong <- top_species_wrong_20_Aprepitant, 
  predicted_mean_final_OD <- predicted_mean_final_od_20_Aprepitant,
  real_mean_final_OD <- real_mean_final_od_20_Aprepitant,
  sims_total = length(successful_sim_ids)
)

Prediction_quality_20_Aprepitant






##Next, for 30 uM:
# Get top 6 species from plot_data_30_endpoint
# Adjust the plot_data_30_endpoint with confidence bounds
plot_data_30_Aprepitant_endpoint <- plot_data_30_Aprepitant_endpoint %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)

# Adjust the Aprepitant_16S_30uM_summarised with confidence bounds
Aprepitant_16S_30uM_summarised <- Aprepitant_16S_30uM_summarised %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)

#NULL model:
Null_model_summarised <- Niclosamide_16S_0uM_summarised %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)


# Get top 6 species based on the lower bound from plot_data_30_endpoint
top6_predicted_30_Aprepitant <- plot_data_30_Aprepitant_endpoint %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

# Get top 6 species based on the lower bound from Aprepitant_16S_30uM_summarised
top6_real_30_Aprepitant <- Aprepitant_16S_30uM_summarised %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

top6_NULL <- Null_model_summarised %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

# Calculate the overlap of top 6 species
top_six_correct_30_Aprepitant <- length(intersect(top6_predicted_30_Aprepitant, top6_real_30_Aprepitant))
#top_six_correct_30_Aprepitant

top_six_correct_30_Aprepitant_NULL <- length(intersect(top6_NULL, top6_real_30_Aprepitant))
#top_six_correct_30_Aprepitant_NULL

#top6_predicted_30_Aprepitant
#top6_real_30_Aprepitant




#Now by means:
top6_predicted_30_Aprepitant_means <- plot_data_30_Aprepitant_endpoint %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)

# Get top 6 species based on the lower bound from Aprepitant_16S_30uM_summarised
top6_real_30_Aprepitant_means <- Aprepitant_16S_30uM_summarised %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)

top6_NULL_means <- Null_model_summarised %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)



top_six_correct_30_Aprepitant_means <- length(intersect(top6_predicted_30_Aprepitant_means, top6_real_30_Aprepitant_means))
#top_six_correct_30_Aprepitant_means

top_six_correct_30_Aprepitant_means_NULL <- length(intersect(top6_NULL_means, top6_real_30_Aprepitant_means))
#top_six_correct_30_Aprepitant_means_NULL

#top6_predicted_30_Aprepitant_means
#top6_real_30_Aprepitant_means




# Merge dataframes by Species
merged_data_30_Aprepitant <- merge(plot_data_30_Aprepitant_endpoint, Aprepitant_16S_30uM_summarised, by = "Species", suffixes = c(".pred", ".real"))
merged_data_30_Aprepitant_NULL <- merge(Niclosamide_16S_0uM_summarised, Aprepitant_16S_30uM_summarised, by = "Species", suffixes = c(".null", ".real"))



# Create lower and upper bounds considering mean ¬± sd
merged_data_30_Aprepitant$lower_bound_pred <- merged_data_30_Aprepitant$mean_rel_ab.pred - merged_data_30_Aprepitant$sd_rel_ab.pred
merged_data_30_Aprepitant$upper_bound_pred <- merged_data_30_Aprepitant$mean_rel_ab.pred + merged_data_30_Aprepitant$sd_rel_ab.pred
merged_data_30_Aprepitant$lower_bound_real <- merged_data_30_Aprepitant$mean_rel_ab.real - merged_data_30_Aprepitant$sd_rel_ab.real
merged_data_30_Aprepitant$upper_bound_real <- merged_data_30_Aprepitant$mean_rel_ab.real + merged_data_30_Aprepitant$sd_rel_ab.real

# Ensure lower and upper bounds are non-negative, adjusting as necessary
merged_data_30_Aprepitant$lower_bound_pred[merged_data_30_Aprepitant$lower_bound_pred <= 0] <- 1e-10
merged_data_30_Aprepitant$lower_bound_real[merged_data_30_Aprepitant$lower_bound_real <= 0] <- 1e-10
merged_data_30_Aprepitant$upper_bound_pred[merged_data_30_Aprepitant$upper_bound_pred <= 0] <- 1e-10
merged_data_30_Aprepitant$upper_bound_real[merged_data_30_Aprepitant$upper_bound_real <= 0] <- 1e-10

##and for NULL model:
# Create lower and upper bounds considering mean ¬± sd
merged_data_30_Aprepitant_NULL$lower_bound_null <- merged_data_30_Aprepitant_NULL$mean_rel_ab.null - merged_data_30_Aprepitant_NULL$sd_rel_ab.null
merged_data_30_Aprepitant_NULL$upper_bound_null <- merged_data_30_Aprepitant_NULL$mean_rel_ab.null + merged_data_30_Aprepitant_NULL$sd_rel_ab.null
merged_data_30_Aprepitant_NULL$lower_bound_real <- merged_data_30_Aprepitant_NULL$mean_rel_ab.real - merged_data_30_Aprepitant_NULL$sd_rel_ab.real
merged_data_30_Aprepitant_NULL$upper_bound_real <- merged_data_30_Aprepitant_NULL$mean_rel_ab.real + merged_data_30_Aprepitant_NULL$sd_rel_ab.real

# Ensure lower and upper bounds are non-negative, adjusting as necessary
merged_data_30_Aprepitant_NULL$lower_bound_null[merged_data_30_Aprepitant_NULL$lower_bound_null <= 0] <- 1e-10
merged_data_30_Aprepitant_NULL$lower_bound_real[merged_data_30_Aprepitant_NULL$lower_bound_real <= 0] <- 1e-10
merged_data_30_Aprepitant_NULL$upper_bound_null[merged_data_30_Aprepitant_NULL$upper_bound_null <= 0] <- 1e-10
merged_data_30_Aprepitant_NULL$upper_bound_real[merged_data_30_Aprepitant_NULL$upper_bound_real <= 0] <- 1e-10

# Filter to include only species with a mean relative abundance > 0.01 in the 'real' dataset
significant_species <- merged_data_30_Aprepitant[merged_data_30_Aprepitant$mean_rel_ab.real > 0.01, ]
survivors_30_Aprepitant <- nrow(significant_species)
survivors_30_Aprepitant

#should be the same as survivors defined above, since it is calculated from .real
significant_species_NULL <- merged_data_30_Aprepitant_NULL[merged_data_30_Aprepitant_NULL$mean_rel_ab.real > 0.01, ]
survivors_30_Aprepitant_NULL <- nrow(significant_species_NULL)
survivors_30_Aprepitant_NULL

# Adjusted order of magnitude check to include SD, only for significant species
significant_species$Predicted_magnitude_correct <- ifelse(
  (floor(log10(significant_species$lower_bound_pred)) <= floor(log10(significant_species$upper_bound_real)) &
     floor(log10(significant_species$upper_bound_pred)) >= floor(log10(significant_species$lower_bound_real))),
  1,
  0
)

#and for the Null model:
significant_species_NULL$Predicted_magnitude_correct <- ifelse(
  (floor(log10(significant_species_NULL$lower_bound_null)) <= floor(log10(significant_species_NULL$upper_bound_real)) &
     floor(log10(significant_species_NULL$upper_bound_null)) >= floor(log10(significant_species_NULL$lower_bound_real))),
  1,
  0
)

# Calculate the fraction of correctly predicted magnitudes for significant species
predicted_magnitude_correct_fraction_30_Aprepitant <- sum(significant_species$Predicted_magnitude_correct) / nrow(significant_species)
predicted_magnitude_correct_fraction_30_Aprepitant

predicted_magnitude_correct_fraction_30_Aprepitant_NULL <- sum(significant_species_NULL$Predicted_magnitude_correct) / nrow(significant_species_NULL)
predicted_magnitude_correct_fraction_30_Aprepitant_NULL


top_species_missing_30_Aprepitant <- setdiff(top6_real_30_Aprepitant_means, top6_predicted_30_Aprepitant_means)
top_species_wrong_30_Aprepitant <- setdiff(top6_predicted_30_Aprepitant_means, top6_real_30_Aprepitant_means)

Prediction_quality_30_Aprepitant <- data.frame(
  Top_six_correct = paste(top_six_correct_30_Aprepitant, sep=""),
  Top_six_correct_NULL = paste(top_six_correct_30_Aprepitant_NULL, sep=""),
  Top_six_correct_means = paste(top_six_correct_30_Aprepitant_means, sep=""),
  Top_six_correct_means_NULL = paste(top_six_correct_30_Aprepitant_means_NULL, sep=""),
  Predicted_magnitude_correct = paste(round(predicted_magnitude_correct_fraction_30_Aprepitant * 100, 2), "%", sep=""),
  Predicted_magnitude_correct_NULL = paste(round(predicted_magnitude_correct_fraction_30_Aprepitant_NULL * 100, 2), "%", sep=""),
  survivors_total = survivors_30_Aprepitant,
  top_species_missing <- top_species_missing_30_Aprepitant,
  top_species_wrong <- top_species_wrong_30_Aprepitant, 
  predicted_mean_final_OD <- predicted_mean_final_od_30_Aprepitant,
  real_mean_final_OD <- real_mean_final_od_30_Aprepitant,
  sims_total = length(successful_sim_ids)
)

Prediction_quality_30_Aprepitant







##Acarbose

combined_monoculture_aucs2_Acarbose <- subset(combined_monoculture_aucs2, drug == "Acarbose")


#drug sensitivity terms: define once outside of ODEs
y_function_B_vulgatus_Acarbose <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("B_vulgatus", "Acarbose", best_fitting_models_df_Acarbose)), collapse = " ")))
y_function_B_uniformis_Acarbose <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("B_uniformis", "Acarbose", best_fitting_models_df_Acarbose)), collapse = " ")))
y_function_B_fragilis_Acarbose <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("B_fragilis", "Acarbose", best_fitting_models_df_Acarbose)), collapse = " ")))
y_function_B_thetaiotaomicron_Acarbose <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("B_thetaiotaomicron", "Acarbose", best_fitting_models_df_Acarbose)), collapse = " ")))
y_function_C_ramosum_Acarbose <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("C_ramosum", "Acarbose", best_fitting_models_df_Acarbose)), collapse = " ")))
y_function_E_rectale_Acarbose <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("E_rectale", "Acarbose", best_fitting_models_df_Acarbose)), collapse = " ")))
y_function_R_intestinalis_Acarbose <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("R_intestinalis", "Acarbose", best_fitting_models_df_Acarbose)), collapse = " ")))
y_function_V_parvula_Acarbose <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("V_parvula", "Acarbose", best_fitting_models_df_Acarbose)), collapse = " ")))
y_function_E_lenta_Acarbose <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("E_lenta", "Acarbose", best_fitting_models_df_Acarbose)), collapse = " ")))
y_function_F_nucleatum_Acarbose <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("F_nucleatum", "Acarbose", best_fitting_models_df_Acarbose)), collapse = " ")))
y_function_C_bolteae_Acarbose <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("C_bolteae", "Acarbose", best_fitting_models_df_Acarbose)), collapse = " ")))
y_function_C_perfringens_Acarbose <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("C_perfringens", "Acarbose", best_fitting_models_df_Acarbose)), collapse = " ")))
y_function_C_saccharolyticum_Acarbose <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("C_saccharolyticum", "Acarbose", best_fitting_models_df_Acarbose)), collapse = " ")))
y_function_S_salivarius_Acarbose <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("S_salivarius", "Acarbose", best_fitting_models_df_Acarbose)), collapse = " ")))
y_function_R_gnavus_Acarbose <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("R_gnavus", "Acarbose", best_fitting_models_df_Acarbose)), collapse = " ")))
y_function_C_comes_Acarbose <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("C_comes", "Acarbose", best_fitting_models_df_Acarbose)), collapse = " ")))
y_function_P_merdae_Acarbose <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("P_merdae", "Acarbose", best_fitting_models_df_Acarbose)), collapse = " ")))
y_function_S_parasanguinis_Acarbose <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("S_parasanguinis", "Acarbose", best_fitting_models_df_Acarbose)), collapse = " ")))
y_function_C_aerofaciens_Acarbose <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("C_aerofaciens", "Acarbose", best_fitting_models_df_Acarbose)), collapse = " ")))
y_function_D_formicigenerans_Acarbose <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("D_formicigenerans", "Acarbose", best_fitting_models_df_Acarbose)), collapse = " ")))
y_function_E_coli_Acarbose <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("E_coli", "Acarbose", best_fitting_models_df_Acarbose)), collapse = " ")))



y_function_B_vulgatus_Acarbose_func <- eval(parse(text = paste("function(Drug) {", y_function_B_vulgatus_Acarbose, "}")))
y_function_B_uniformis_Acarbose_func <- eval(parse(text = paste("function(Drug) {", y_function_B_uniformis_Acarbose, "}")))
y_function_B_fragilis_Acarbose_func <- eval(parse(text = paste("function(Drug) {", y_function_B_fragilis_Acarbose, "}")))
y_function_B_thetaiotaomicron_Acarbose_func <- eval(parse(text = paste("function(Drug) {", y_function_B_thetaiotaomicron_Acarbose, "}")))
y_function_C_ramosum_Acarbose_func <- eval(parse(text = paste("function(Drug) {", y_function_C_ramosum_Acarbose, "}")))
y_function_E_rectale_Acarbose_func <- eval(parse(text = paste("function(Drug) {", y_function_E_rectale_Acarbose, "}")))
y_function_R_intestinalis_Acarbose_func <- eval(parse(text = paste("function(Drug) {", y_function_R_intestinalis_Acarbose, "}")))
y_function_E_lenta_Acarbose_func <- eval(parse(text = paste("function(Drug) {", y_function_E_lenta_Acarbose, "}")))
y_function_F_nucleatum_Acarbose_func <- eval(parse(text = paste("function(Drug) {", y_function_F_nucleatum_Acarbose, "}")))
y_function_C_bolteae_Acarbose_func <- eval(parse(text = paste("function(Drug) {", y_function_C_bolteae_Acarbose, "}")))
y_function_C_perfringens_Acarbose_func <- eval(parse(text = paste("function(Drug) {", y_function_C_perfringens_Acarbose, "}")))
y_function_C_saccharolyticum_Acarbose_func <- eval(parse(text = paste("function(Drug) {", y_function_C_saccharolyticum_Acarbose, "}")))
y_function_S_salivarius_Acarbose_func <- eval(parse(text = paste("function(Drug) {", y_function_S_salivarius_Acarbose, "}")))
y_function_R_gnavus_Acarbose_func <- eval(parse(text = paste("function(Drug) {", y_function_R_gnavus_Acarbose, "}")))
y_function_C_comes_Acarbose_func <- eval(parse(text = paste("function(Drug) {", y_function_C_comes_Acarbose, "}")))
y_function_P_merdae_Acarbose_func <- eval(parse(text = paste("function(Drug) {", y_function_P_merdae_Acarbose, "}")))
y_function_S_parasanguinis_Acarbose_func <- eval(parse(text = paste("function(Drug) {", y_function_S_parasanguinis_Acarbose, "}")))
y_function_C_aerofaciens_Acarbose_func <- eval(parse(text = paste("function(Drug) {", y_function_C_aerofaciens_Acarbose, "}")))
y_function_D_formicigenerans_Acarbose_func <- eval(parse(text = paste("function(Drug) {", y_function_D_formicigenerans_Acarbose, "}")))
y_function_E_coli_Acarbose_func <- eval(parse(text = paste("function(Drug) {", y_function_E_coli_Acarbose, "}")))
y_function_V_parvula_Acarbose_func <- eval(parse(text = paste("function(Drug) {", y_function_V_parvula_Acarbose, "}")))



unique(combined_monoculture_aucs2_Acarbose$conc)
##dictate drug concentration tested for simulation cycle here:
#drug_concentration_tested <- 5 #if manually or:
drug_concentration_tested <- unique(combined_monoculture_aucs2_Acarbose$conc)[1] 
initial_conditions <- rep(0.01/32, 32)
initial_conditions <- c(initial_conditions, drug_concentration_tested)


##drug effect fitted for species showing sensitivity in monoculture:
#unique(combined_monoculture_aucs2_Acarbose$Species)

##for more simple linear fits
closed.sir.model_Acarbose <- function (t, x, params) {
  ## first extract the state variables
  A_muciniphila <- x[1]
  B_adolescentis <- x[2]
  B_fragilis <- x[3]
  B_longum <- x[4]
  B_obeum <- x[5]
  B_thetaiotaomicron <- x[6]
  B_uniformis <- x[7]
  B_vulgatus <- x[8]
  B_wadsworthia <- x[9]
  C_aerofaciens <- x[10]
  C_bolteae <- x[11]
  C_comes <- x[12]
  C_perfringens <- x[13]
  C_ramosum <- x[14]
  C_saccharolyticum <- x[15]
  D_formicigenerans <- x[16]
  E_coli <- x[17]
  E_lenta <- x[18]
  E_rectale <- x[19]
  F_nucleatum <- x[20]
  L_paracasei <- x[21]
  O_splanchnicus <- x[22]
  P_copri <- x[23]
  P_distasonis <- x[24]
  P_merdae <- x[25]
  R_bromii <- x[26]
  R_gnavus <- x[27]
  R_intestinalis <- x[28]
  R_torques <- x[29]
  S_parasanguinis <- x[30]
  S_salivarius <- x[31]
  V_parvula <- x[32]
  Drug <- x[33]
  
  
  ## now extract the parameters
  r_B_fragilis <- flat_params[["B._fragilis.r"]]
  K_B_fragilis <- flat_params[["B._fragilis.K"]]
  r_B_longum <- flat_params[["B._longum.r"]]
  K_B_longum <- flat_params[["B._longum.K"]]
  r_B_thetaiotaomicron <- flat_params[["B._thetaiotaomicron.r"]]
  K_B_thetaiotaomicron <- flat_params[["B._thetaiotaomicron.K"]]
  r_B_uniformis <- flat_params[["B._uniformis.r"]]
  K_B_uniformis <- flat_params[["B._uniformis.K"]]
  r_B_vulgatus <- flat_params[["B._vulgatus.r"]]
  K_B_vulgatus <- flat_params[["B._vulgatus.K"]]
  r_B_wadsworthia <- flat_params[["B._wadsworthia.r"]]
  K_B_wadsworthia <- flat_params[["B._wadsworthia.K"]]
  r_C_aerofaciens <- flat_params[["C._aerofaciens.r"]]
  K_C_aerofaciens <- flat_params[["C._aerofaciens.K"]]
  r_C_bolteae <- flat_params[["C._bolteae.r"]]
  K_C_bolteae <- flat_params[["C._bolteae.K"]]
  r_C_comes <- flat_params[["C._comes.r"]]
  K_C_comes <- flat_params[["C._comes.K"]]
  r_C_perfringens <- flat_params[["C._perfringens.r"]]
  K_C_perfringens <- flat_params[["C._perfringens.K"]]
  r_C_ramosum <- flat_params[["C._ramosum.r"]]
  K_C_ramosum <- flat_params[["C._ramosum.K"]]
  r_C_saccharolyticum <- flat_params[["C._saccharolyticum.r"]]
  K_C_saccharolyticum <- flat_params[["C._saccharolyticum.K"]]
  r_D_formicigenerans <- flat_params[["D._formicigenerans.r"]]
  K_D_formicigenerans <- flat_params[["D._formicigenerans.K"]]
  r_E_coli <- flat_params[["E._coli.r"]]
  K_E_coli <- flat_params[["E._coli.K"]]
  r_E_lenta <- flat_params[["E._lenta.r"]]
  K_E_lenta <- flat_params[["E._lenta.K"]]
  r_E_rectale <- flat_params[["E._rectale.r"]]
  K_E_rectale <- flat_params[["E._rectale.K"]]
  r_F_nucleatum <- flat_params[["F._nucleatum.r"]]
  K_F_nucleatum <- flat_params[["F._nucleatum.K"]]
  r_P_copri <- flat_params[["P._copri.r"]]
  K_P_copri <- flat_params[["P._copri.K"]]
  r_P_merdae <- flat_params[["P._merdae.r"]]
  K_P_merdae <- flat_params[["P._merdae.K"]]
  r_R_gnavus <- flat_params[["R._gnavus.r"]]
  K_R_gnavus <- flat_params[["R._gnavus.K"]]
  r_R_intestinalis <- flat_params[["R._intestinalis.r"]]
  K_R_intestinalis <- flat_params[["R._intestinalis.K"]]
  r_V_parvula <- flat_params[["V._parvula.r"]]
  K_V_parvula <- flat_params[["V._parvula.K"]]
  r_A_muciniphila <- flat_params[["A._muciniphila.r"]]
  K_A_muciniphila <- flat_params[["A._muciniphila.K"]]
  r_B_adolescentis <- flat_params[["B._adolescentis.r"]]
  K_B_adolescentis <- flat_params[["B._adolescentis.K"]]
  r_B_obeum <- flat_params[["B._obeum.r"]]
  K_B_obeum <- flat_params[["B._obeum.K"]]
  r_O_splanchnicus <- flat_params[["O._splanchnicus.r"]]
  K_O_splanchnicus <- flat_params[["O._splanchnicus.K"]]
  r_P_distasonis <- flat_params[["P._distasonis.r"]]
  K_P_distasonis <- flat_params[["P._distasonis.K"]]
  r_R_bromii <- flat_params[["R._bromii.r"]]
  K_R_bromii <- flat_params[["R._bromii.K"]]
  r_R_torques <- flat_params[["R._torques.r"]]
  K_R_torques <- flat_params[["R._torques.K"]]
  r_S_parasanguinis <- flat_params[["S._parasanguinis.r"]]
  K_S_parasanguinis <-flat_params[["S._parasanguinis.K"]]
  r_S_salivarius <- flat_params[["S._salivarius.r"]]
  K_S_salivarius <- flat_params[["S._salivarius.K"]]
  r_L_paracasei <- flat_params[["L._paracasei.r"]]
  K_L_paracasei <- flat_params[["L._paracasei.K"]]
  
  
  t_mod <- ifelse(t > 24.1, t - 24.1, t)
  
  
  ## now code the model equations
  dA_muciniphila_dt <- r_A_muciniphila * A_muciniphila * (1 - A_muciniphila / K_A_muciniphila)
  dB_adolescentis_dt <- r_B_adolescentis * B_adolescentis * (1 - B_adolescentis / K_B_adolescentis)
  dB_fragilis_dt <- r_B_fragilis * B_fragilis * (1 - B_fragilis / max(0.0001, K_B_fragilis * (y_function_B_fragilis_Acarbose_func(Drug))))
  dB_longum_dt <- r_B_longum * B_longum * (1 - B_longum / K_B_longum)
  dB_obeum_dt <- r_B_obeum * B_obeum * (1 - B_obeum / K_B_obeum)
  dB_thetaiotaomicron_dt <- r_B_thetaiotaomicron * B_thetaiotaomicron * (1 - B_thetaiotaomicron / max(0.0001, K_B_thetaiotaomicron * (y_function_B_thetaiotaomicron_Acarbose_func(Drug))))  
  dB_uniformis_dt <- r_B_uniformis * B_uniformis * (1 - B_uniformis / max(0.0001, K_B_uniformis * (y_function_B_uniformis_Acarbose_func(Drug))))
  dB_vulgatus_dt <- r_B_vulgatus * B_vulgatus * (1 - B_vulgatus / max(0.0001, K_B_vulgatus * (y_function_B_vulgatus_Acarbose_func(Drug))))
  dB_wadsworthia_dt <- r_B_wadsworthia * B_wadsworthia * (1 - B_wadsworthia / K_B_wadsworthia)
  dC_aerofaciens_dt <- r_C_aerofaciens * C_aerofaciens * (1 - C_aerofaciens / max(0.0001, K_C_aerofaciens * (y_function_C_aerofaciens_Acarbose_func(Drug))))
  dC_bolteae_dt <- r_C_bolteae * C_bolteae * (1 - C_bolteae /  max(0.0001, K_C_bolteae * (y_function_C_bolteae_Acarbose_func(Drug))))
  dC_comes_dt <- r_C_comes * C_comes * (1 - C_comes / max(0.0001, K_C_comes * (y_function_C_comes_Acarbose_func(Drug))))
  dC_perfringens_dt <- r_C_perfringens * C_perfringens * (1 - C_perfringens / max(0.0001, K_C_perfringens * (y_function_C_perfringens_Acarbose_func(Drug))))
  dC_ramosum_dt <- r_C_ramosum * C_ramosum * (1 - C_ramosum / max(0.0001, K_C_ramosum * (y_function_C_ramosum_Acarbose_func(Drug))))
  dC_saccharolyticum_dt <- r_C_saccharolyticum * C_saccharolyticum * (1 - C_saccharolyticum / max(0.0001, K_C_saccharolyticum * (y_function_C_saccharolyticum_Acarbose_func(Drug))))
  dD_formicigenerans_dt <- r_D_formicigenerans * D_formicigenerans * (1 - D_formicigenerans / max(0.0001, K_D_formicigenerans * (y_function_D_formicigenerans_Acarbose_func(Drug))))
  dE_coli_dt <- r_E_coli * E_coli * (1 - E_coli / max(0.0001, K_E_coli * (y_function_E_coli_Acarbose_func(Drug))))
  dE_lenta_dt <- r_E_lenta * E_lenta * (1 - E_lenta / max(0.0001, K_E_lenta * (y_function_E_lenta_Acarbose_func(Drug))))
  dE_rectale_dt <- r_E_rectale * E_rectale * (1 - E_rectale / max(0.0001, K_E_rectale * (y_function_E_rectale_Acarbose_func(Drug))))
  dF_nucleatum_dt <- r_F_nucleatum * F_nucleatum * (1 - F_nucleatum / max(0.0001, K_F_nucleatum * (y_function_F_nucleatum_Acarbose_func(Drug))))
  dL_paracasei_dt <- r_L_paracasei * L_paracasei * (1 - L_paracasei / K_L_paracasei)  
  dO_splanchnicus_dt <- r_O_splanchnicus * O_splanchnicus * (1 - O_splanchnicus / K_O_splanchnicus)  
  dP_copri_dt <- r_P_copri * P_copri * (1 - P_copri / K_P_copri)
  dP_distasonis_dt <- r_P_distasonis * P_distasonis * (1 - P_distasonis / K_P_distasonis)  
  dP_merdae_dt <- r_P_merdae * P_merdae * (1 - P_merdae / max(0.0001, K_P_merdae * (y_function_P_merdae_Acarbose_func(Drug))))
  dR_bromii_dt <- r_R_bromii * R_bromii * (1 - R_bromii / K_R_bromii) 
  dR_gnavus_dt <- r_R_gnavus * R_gnavus * (1 - R_gnavus / max(0.0001, K_R_gnavus * (y_function_R_gnavus_Acarbose_func(Drug))))
  dR_intestinalis_dt <- r_R_intestinalis * R_intestinalis * (1 - R_intestinalis / max(0.0001, K_R_intestinalis * (y_function_R_intestinalis_Acarbose_func(Drug))))
  dR_torques_dt <- r_R_torques * R_torques * (1 - R_torques /K_R_torques) 
  dS_parasanguinis_dt <- r_S_parasanguinis * S_parasanguinis * (1 - S_parasanguinis / max(0.0001, K_S_parasanguinis * (y_function_S_parasanguinis_Acarbose_func(Drug))))
  dS_salivarius_dt <- r_S_salivarius * S_salivarius * (1 - S_salivarius / max(0.0001, K_S_salivarius * (y_function_S_salivarius_Acarbose_func(Drug))))
  dV_parvula_dt <- r_V_parvula * V_parvula * (1 - V_parvula / max(0.0001, K_V_parvula * (y_function_V_parvula_Acarbose_func(Drug))))
  
  
  
  #Drug differential (no metabolomics for this drug):
  dDrug_dt <- (mean(drug_dynamics$Steepness_param_community) * exp(-mean(drug_dynamics$Steepness_param_community) * t_mod)) * (drug_concentration_tested * prop_left_Acarbose - drug_concentration_tested)
  #dDrug_dt <- 0
  
  ## Combine results into a single vector
  dxdt <- c(dA_muciniphila_dt, dB_adolescentis_dt, dB_fragilis_dt, dB_longum_dt, dB_obeum_dt, dB_thetaiotaomicron_dt, dB_uniformis_dt, dB_vulgatus_dt, dB_wadsworthia_dt, dC_aerofaciens_dt, dC_bolteae_dt, dC_comes_dt, dC_perfringens_dt, dC_ramosum_dt, dC_saccharolyticum_dt, dD_formicigenerans_dt, dE_coli_dt, dE_lenta_dt, dE_rectale_dt, dF_nucleatum_dt, dL_paracasei_dt, dO_splanchnicus_dt, dP_copri_dt, dP_distasonis_dt, dP_merdae_dt, dR_bromii_dt, dR_gnavus_dt, dR_intestinalis_dt, dR_torques_dt, dS_parasanguinis_dt, dS_salivarius_dt, dV_parvula_dt, dDrug_dt)
  
  ## Return result as a list
  list(dxdt)
}




#calculate the co-culture correction factor per species based on community composition in absence of drug, just like done for Niclosamide

growth_data_all_0_Niclosamide
growth_data_all_0_Niclosamide1 <- growth_data_all_0_Niclosamide %>%
  dplyr::mutate(Species = gsub(" ", "_", Species))


# Merge rel_ab_control with growth_data_all_0_Niclosamide on Species
# Function to remove duplicated columns by name pattern
clean_columns_base <- function(df, pattern) {
  cols_to_keep <- !grepl(pattern, names(df))
  df <- df[, cols_to_keep]
  return(df)
}

# Use the new function to clean up your dataframe
rel_ab_control <- clean_columns_base(rel_ab_control, "mean_max_OD.[xy]")
str(rel_ab_control)


#rel_ab_control$correction_factor <- rel_ab_control$mean_rel_ab / (rel_ab_control$mean_max_OD/sum(rel_ab_control$mean_max_OD))
# Calculate correction factor with a minimum value of ~1
rel_ab_control$correction_factor <- pmax(rel_ab_control$mean_rel_ab / (rel_ab_control$mean_max_OD / sum(rel_ab_control$mean_max_OD)), 1.1)


# Create a new dataframe for co-culture correction
co_culture_correction <- data.frame(
  species = rel_ab_control$Species,
  correction_factor = rel_ab_control$correction_factor
)


#summarise community data
#Adjust based on tested concentrations for each drug
unique(Community_compositions_focus_drugs_Acarbose$concentration)

Community_compositions_focus_drugs_Acarbose_5uM <- subset(Community_compositions_focus_drugs_Acarbose, concentration == 5)
Community_compositions_focus_drugs_Acarbose_20uM <- subset(Community_compositions_focus_drugs_Acarbose, concentration == 20)
Community_compositions_focus_drugs_Acarbose_80uM <- subset(Community_compositions_focus_drugs_Acarbose, concentration == 80)


#5 uM
Community_compositions_focus_drugs_Acarbose_5uM_summarised <- Community_compositions_focus_drugs_Acarbose_5uM %>%
  dplyr::group_by(species) %>%                                  
  dplyr::summarize(
    mean_rel_ab = mean(rel_abundance, na.rm = TRUE),     
    sd_rel_ab = sd(rel_abundance, na.rm = TRUE) ,
    mean_max_OD = mean(maxOD, na.rm = TRUE),
    sd_max_OD = sd(maxOD, na.rm = TRUE),
    mean_final_OD = mean(finalOD, na.rm = TRUE),
    sd_final_OD = sd(finalOD, na.rm = TRUE)
  ) %>%
  dplyr::ungroup() 


Community_compositions_focus_drugs_Acarbose_5uM_summarised <- Community_compositions_focus_drugs_Acarbose_5uM_summarised %>%
  dplyr::mutate(Species = sub("^(\\w)\\w*\\s(.*)", "\\1._\\2", species))

#remove (sub)strain info
Community_compositions_focus_drugs_Acarbose_5uM_summarised <- Community_compositions_focus_drugs_Acarbose_5uM_summarised %>%
  dplyr::mutate(Species = sub("^(\\w\\._\\w+).*", "\\1", Species))


#20 uM
Community_compositions_focus_drugs_Acarbose_20uM_summarised <- Community_compositions_focus_drugs_Acarbose_20uM %>%
  dplyr::group_by(species) %>%                                  
  dplyr::summarize(
    mean_rel_ab = mean(rel_abundance, na.rm = TRUE),     
    sd_rel_ab = sd(rel_abundance, na.rm = TRUE) ,
    mean_max_OD = mean(maxOD, na.rm = TRUE),
    sd_max_OD = sd(maxOD, na.rm = TRUE),
    mean_final_OD = mean(finalOD, na.rm = TRUE),
    sd_final_OD = sd(finalOD, na.rm = TRUE)
  ) %>%
  dplyr::ungroup() 


Community_compositions_focus_drugs_Acarbose_20uM_summarised <- Community_compositions_focus_drugs_Acarbose_20uM_summarised %>%
  dplyr::mutate(Species = sub("^(\\w)\\w*\\s(.*)", "\\1._\\2", species))

#remove (sub)strain info
Community_compositions_focus_drugs_Acarbose_20uM_summarised <- Community_compositions_focus_drugs_Acarbose_20uM_summarised %>%
  dplyr::mutate(Species = sub("^(\\w\\._\\w+).*", "\\1", Species))


#80 uM
Community_compositions_focus_drugs_Acarbose_80uM_summarised <- Community_compositions_focus_drugs_Acarbose_80uM %>%
  dplyr::group_by(species) %>%                                  
  dplyr::summarize(
    mean_rel_ab = mean(rel_abundance, na.rm = TRUE),     
    sd_rel_ab = sd(rel_abundance, na.rm = TRUE) ,
    mean_max_OD = mean(maxOD, na.rm = TRUE),
    sd_max_OD = sd(maxOD, na.rm = TRUE),    
    mean_final_OD = mean(finalOD, na.rm = TRUE),
    sd_final_OD = sd(finalOD, na.rm = TRUE)
  ) %>%
  dplyr::ungroup() 



Community_compositions_focus_drugs_Acarbose_80uM_summarised <- Community_compositions_focus_drugs_Acarbose_80uM_summarised %>%
  dplyr::mutate(Species = sub("^(\\w)\\w*\\s(.*)", "\\1._\\2", species))

#remove (sub)strain info
Community_compositions_focus_drugs_Acarbose_80uM_summarised <- Community_compositions_focus_drugs_Acarbose_80uM_summarised %>%
  dplyr::mutate(Species = sub("^(\\w\\._\\w+).*", "\\1", Species))


#Initialise data frames
sim_output <- data.frame()
input_params_list <- list() #Use a list to collect parameters for each simulation

#number of simulations
num_sims <- 500


for (i in 1:num_sims) {
  tryCatch({
    # generate model parameters
    set.seed(i) #set a different seed for each simulation for variation
    params <- lapply(1:nrow(growth_data_all_0_Niclosamide), function(idx) {
      species_params <- growth_data_all_0_Niclosamide[idx, ]
      list(
        r = rnorm(1, mean = species_params$mean_max_Growth_rate, sd = species_params$sd_max_Growth_rate),
        K = rnorm(1, mean = species_params$mean_max_OD, sd = species_params$sd_max_OD)
      )
    })
    names(params) <- gsub(" ", "_", growth_data_all_0_Niclosamide$Species)
    flat_params <- unlist(params)
    names(flat_params) <- gsub("\\.\\d$", "", names(flat_params))
    
    #replace spaces with underscores to match formatting
    co_culture_correction$species <- gsub(" ", "_", co_culture_correction$species, fixed = TRUE)
    
    #replace the species-specific K parameters extracted from monoculture growth data 
    #with drawn relative abundance values at Niclosamide = 0, scaled to K
    rel_ab_control$Species <- gsub(" ", "_", rel_ab_control$Species)
    
    #Initialise an empty vector to store drawn values
    drawn_values <- numeric(nrow(rel_ab_control))
    
    #draw values from their respective distributions
    for (k in 1:nrow(rel_ab_control)) {
      species_name <- rel_ab_control$Species[k]
      drawn_value <- rnorm(1, mean = rel_ab_control$mean_rel_ab[k], sd = rel_ab_control$sd_rel_ab[k])
      drawn_values[k] <- max(drawn_value, 0)  # Ensure no negative values
    }
    
    #Normalise drawn relative abundance values so they sum to 1 (to reflect a 'true' relative abundance distribution)
    #this is needed so when we convert the values into OD units by multiplying with the drawn community maxOD,
    # the sum of K_i parameters and the drawn K are equal
    normalised_values <- drawn_values / sum(drawn_values)
    
    #Pull community maxOD (K) at 0 drugs from respective normal distribution:
    K <- rnorm(n = 1, mean = rel_ab_control$mean_com_max_OD[1], sd = rel_ab_control$sd_com_max_OD[1])
    
    # Assign these normalised values to their respective species' .K parameters
    for (k in 1:nrow(rel_ab_control)) {
      species_name <- rel_ab_control$Species[k]
      k_index <- grep(paste0("^", species_name, "\\.K$"), names(flat_params))
      
      if (length(k_index) > 0) {
        old_value <- flat_params[k_index]
        flat_params[k_index] <- (normalised_values[k] + 0.0001) * K #add small value in case drawn K_i is 0, which would cause issues with the solver
        cat(sprintf("Updated %s from %f to %f using normalised value %f scaled by K %f\n", names(flat_params)[k_index], old_value, flat_params[k_index], normalised_values[k], K))
      }
    }
    
    #Accounting for variation in drug degradation by community, with standard deviation of end concentration (at 10h) around the fitted predicted (relative) end concentration at 24h
    #This drug (Acarbose) does not have metabolomics data available.
    #Taking averages of degradation and variability thereof observed across all 27 drugs that did have metabolomics data
    #prop_left_Acarbose <- abs(rnorm(1, mean(drug_dynamics$Prop_left_24h_community), mean(drug_dynamics$SD_drug_community))) 
    prop_left_Acarbose <- runif(1, min(drug_dynamics$Prop_left_24h_community), max(drug_dynamics$Prop_left_24h_community))
    
    #loop through each species in co_culture_correction
    for (j in 1:nrow(co_culture_correction)) {
      # Extract the species name and correction factor
      species_name <- co_culture_correction$species[j]
      correction_factor <- co_culture_correction$correction_factor[j]
      
      # Identify the corresponding growth rate parameter in flat_params
      #by matching the base species name (without .r)
      growth_rate_indices <- grep(paste0("^", species_name, "\\.r$"), names(flat_params))
      
      #take the growth rate parameter and apply the correction factor 
      for (index in growth_rate_indices) {
        flat_params[index] <- flat_params[index] * correction_factor
      }
    }
    
    flat_params
    # Store parameters for each simulation
    input_params_list[[i]] <- c(sim_ID = i, flat_params)
    
    # Run the model for the first 24-hour cycle
    solution_cycle_1 <- ode(y = initial_conditions, times = seq(from = 0, to = 24, by = 0.1), func = closed.sir.model_Acarbose, parms = flat_params,   method = "lsoda", rtol = 1e-6, atol = 1e-6)
    
    # Dilution and second cycle
    end_of_cycle_1 <- solution_cycle_1[nrow(solution_cycle_1), -1]
    initial_conditions_cycle_2 <- end_of_cycle_1 / 50
    #accounting for the drugs being added with the new growth cycle as well:
    initial_conditions_cycle_2[33] <- initial_conditions_cycle_2[33] + drug_concentration_tested
    solution_cycle_2 <- ode(y = initial_conditions_cycle_2, times = seq(from = 24, to = 48, by = 0.1), func = closed.sir.model_Acarbose, parms = flat_params,  method = "lsoda", rtol = 1e-6, atol = 1e-6)
    
    # Combine and format results
    combined_solution <- rbind(as.data.frame(solution_cycle_1), as.data.frame(solution_cycle_2)[-1,])
    combined_solution$sim_ID <- rep(i, nrow(combined_solution))
    combined_solution <- combined_solution %>%
      tidyr::gather(key = "Species", value = "Density", -time, -sim_ID) %>%
      dplyr::mutate(Hour = time) %>%
      dplyr::select(sim_ID, Hour, Species, Density)
    
    ##Append to sim_output
    sim_output <- rbind(sim_output, combined_solution)
  }, error = function(e) {
    cat(sprintf("Skipping simulation %d due to an error: %s\n", i, e$message))
  })
}



##Combine all parameter data into a single dataframe
input_params <- do.call(rbind, input_params_list)

# Add a "Species" column 
sim_output$Species_name <- species_names[as.numeric(as.character(sim_output$Species))]
sim_output$Species_name <- replace_na(sim_output$Species_name, "Drug")

#View(input_params)
#View(sim_output)

sim_output <- na.omit(sim_output)
successful_sim_ids <- unique(subset(sim_output, Hour == 48)$sim_ID)
length(successful_sim_ids)
sim_output1 <- sim_output[sim_output$sim_ID %in% successful_sim_ids, ]


#Transform sim_output so we have wide format by Species
sim_output_wide <- tidyr::pivot_wider(sim_output1, 
                                      names_from = Species_name, 
                                      values_from = Density,
                                      id_cols = c(sim_ID, Hour))

length(unique(sim_output_wide$sim_ID))
#calc community OD per timepoint
sim_output_wide$Total_OD <- rowSums(sim_output_wide[, 3:34], na.rm = TRUE)
#calculate and add relative abundances here as well:
species_columns <- colnames(sim_output_wide)[3:34] 

for (species in species_columns) {
  sim_output_wide[[paste0("rel_", species)]] <- sim_output_wide[[species]] / sim_output_wide$Total_OD
}


#assign sim_output_wide test conditions to dataframe name
drug_tested <- "Acarbose"
variable_name_1 <- paste0("sim_output_wide_", ifelse(drug_concentration_tested == 1e-04, 0, drug_concentration_tested), "_", drug_tested)
assign(variable_name_1, sim_output_wide)

#turn back into long format if interested in plotting relative abundances
cols_needed <- c("sim_ID", "Hour")

sim_output_long <- sim_output_wide %>% 
  dplyr::select(sim_ID, Hour, Drug, starts_with("rel_")) %>% 
  tidyr::pivot_longer(
    cols = c(Drug, starts_with("rel_")),
    names_to = "Species", 
    values_to = "Relative_abundance",
    names_prefix = "rel_",
    names_transform = list(Species = ~ ifelse(.x == "Drug", "Drug", .x))
  ) 

str(sim_output_long)


species_names_1 <- c(
  "A_muciniphila",
  "B_adolescentis",
  "B_fragilis",
  "B_longum",
  "B_obeum",
  "B_thetaiotaomicron",
  "B_uniformis",
  "B_vulgatus",
  "B_wadsworthia",
  "C_aerofaciens",
  "C_bolteae",
  "C_comes",
  "C_perfringens",
  "C_ramosum",
  "C_saccharolyticum",
  "D_formicigenerans",
  "E_coli",
  "E_lenta",
  "E_rectale",
  "F_nucleatum",
  "L_paracasei",
  "O_splanchnicus",
  "P_copri",
  "P_distasonis",
  "P_merdae",
  "R_bromii",
  "R_gnavus",
  "R_intestinalis",
  "R_torques",
  "S_parasanguinis",
  "S_salivarius",
  "V_parvula",
  "Drug"
)

species_colours_1 <- c(
  "A_muciniphila" = "#1f77b4",
  "B_adolescentis" = "#ff7f0e",
  "B_fragilis" = "#2ca02c",
  "B_longum" = "#d62728",
  "B_obeum" = "#9467bd",
  "B_thetaiotaomicron" = "black",
  "B_uniformis" = "#e377c2",
  "B_vulgatus" = "#7f7f7f",
  "B_wadsworthia" = "gold1",
  "C_aerofaciens" = "#aec7e8",
  "C_bolteae" = "#ffbb78",
  "C_comes" = "magenta",
  "C_perfringens" = "#ff9896",
  "C_ramosum" = "#c5b0d5",
  "C_saccharolyticum" = "#c49c94",
  "D_formicigenerans" = "#f7b6d2",
  "E_coli" = "yellow",
  "E_lenta" = "turquoise",
  "E_rectale" = "#393b79",
  "F_nucleatum" = "royalblue2",
  "L_paracasei" = "blue",
  "O_splanchnicus" = "#637939",
  "P_copri" = "cyan",
  "P_distasonis" = "#8c6d31",
  "P_merdae" = "#c7c7c7",
  "R_bromii" = "#e6550d",
  "R_gnavus" = "#e7cb94",
  "R_intestinalis" = "#843c39",
  "R_torques" = "#d6616b",
  "S_parasanguinis" = "orange3",
  "S_salivarius" = "#7b4173",
  "V_parvula" = "#ce6dbd",
  "Drug" = "green"
)



##Plot output for any specific sim:
# ggplot(subset(sim_output, sim_ID == 1 & Species_name != "Drug"), aes(x = Hour, y = Density, group = Species_name, color = Species_name)) +
#   geom_line(size = 1, alpha = 0.7) +
#   scale_color_manual(values = species_colours_1) +
#   labs(title = paste0("Acarbose = ", drug_concentration_tested),
#        x = "Time (hours)",
#        y = "Population Density (OD)",
#        color = "Species") +
#   theme_minimal() +
#   theme(legend.position = "right")
# 
# ggplot(subset(sim_output, sim_ID == 3 & Species_name != "Drug"), aes(x = Hour, y = Density, group = Species_name, color = Species_name)) +
#   geom_line(size = 1, alpha = 0.7) +
#   scale_color_manual(values = species_colours_1) +
#   labs(title = paste0("Acarbose = ", drug_concentration_tested),
#        x = "Time (hours)",
#        y = "Population Density (OD)",
#        color = "Species") +
#   theme_minimal() +
#   theme(legend.position = "right")


ggplot(subset(sim_output_long, sim_ID == 1), aes(x = Hour, y = Relative_abundance, group = Species, color = Species)) +
  geom_line(size = 1, alpha = 0.7) +
  scale_color_manual(values = species_colours_1) +
  labs(title = paste0("Acarbose = ", drug_concentration_tested),
       x = "Time (hours)",
       y = "Relative abundance",
       color = "Species") +
  theme_minimal() +
  theme(legend.position = "right")


ggplot(subset(sim_output_long, sim_ID == 3), aes(x = Hour, y = Relative_abundance, group = Species, color = Species)) +
  geom_line(size = 1, alpha = 0.7) +
  scale_color_manual(values = species_colours_1) +
  labs(title = paste0("Acarbose = ", drug_concentration_tested),
       x = "Time (hours)",
       y = "Relative abundance",
       color = "Species") +
  theme_minimal() +
  theme(legend.position = "right")


#calc mean and standard deviation across sims
sim_stats <- sim_output_long %>%
  dplyr::group_by(Hour, Species) %>%
  dplyr::summarise(
    mean_rel_ab = mean(Relative_abundance),
    sd_rel_ab = sd(Relative_abundance),
    .groups = 'drop'
  )

# Prepare the data for plotting
plot_data <- sim_stats %>%
  dplyr::mutate(Upper = mean_rel_ab + sd_rel_ab, Lower = mean_rel_ab - sd_rel_ab)

ggplot(subset(plot_data, Species != "Drug"), aes(x = Hour, y = mean_rel_ab, group = Species, color = Species)) +
  geom_ribbon(aes(ymin = Lower, ymax = Upper, fill = Species), colour = NA, alpha = 0.2) +  
  geom_line(size = 1, alpha = 0.7) + 
  scale_color_manual(values = species_colours_1) +
  scale_fill_manual(values = species_colours_1) +  
  labs(title = "Mean and SD of Relative Abundance Across Simulations",
       subtitle = paste0("Acarbose = ", drug_concentration_tested),       
       x = "Time (hours)",
       y = "Relative abundance",
       color = "Species",
       fill = "Species") +
  theme_minimal() +
  theme(legend.position = "right")

#log-scaled mean trends
ggplot(plot_data, aes(x = Hour, y = log10(mean_rel_ab + 0.0001), group = Species, color = Species)) +
  geom_line(size = 1, alpha = 0.7) +  # Mean line
  scale_color_manual(values = species_colours_1) +
  scale_fill_manual(values = species_colours_1) +  # Ensure consistent colors for lines and fills
  labs(title = "Mean and SD of Relative Abundance Across Simulations",
       subtitle = paste0("Acarbose = ", drug_concentration_tested),
       x = "Time (hours)",
       y = "Relative abundance",
       color = "Species",
       fill = "Species") +
  theme_minimal() +
  theme(legend.position = "right")




##prediction quality evaluation
drug_tested <- "Acarbose"
variable_name <- paste0("plot_data_", ifelse(drug_concentration_tested == 1e-04, 0, drug_concentration_tested), "_", drug_tested)
assign(variable_name, plot_data)


#extract total OD info:
predicted_mean_final_od_NULL <- Niclosamide_16S_0uM_summarised$mean_com_final_OD[1]
predicted_sd_final_od_NULL <- Niclosamide_16S_0uM_summarised$sd_com_final_OD[1]

predicted_mean_final_od_5_Acarbose <- mean(subset(sim_output_wide_5_Acarbose, Hour == 48)$Total_OD, na.rm = TRUE)
predicted_sd_final_od_5_Acarbose <- sd(subset(sim_output_wide_5_Acarbose, Hour == 48)$Total_OD, na.rm = TRUE)

real_mean_final_od_5_Acarbose <- Community_compositions_focus_drugs_Acarbose_5uM_summarised$mean_final_OD[1]
real_sd_final_od_5_Acarbose <- Community_compositions_focus_drugs_Acarbose_5uM_summarised$sd_final_OD[1]


predicted_mean_final_od_20_Acarbose <- mean(subset(sim_output_wide_20_Acarbose, Hour == 48)$Total_OD, na.rm = TRUE)
predicted_sd_final_od_20_Acarbose <- sd(subset(sim_output_wide_20_Acarbose, Hour == 48)$Total_OD, na.rm = TRUE)

real_mean_final_od_20_Acarbose <- Community_compositions_focus_drugs_Acarbose_20uM_summarised$mean_final_OD[1]
real_sd_final_od_20_Acarbose <- Community_compositions_focus_drugs_Acarbose_20uM_summarised$sd_final_OD[1]


predicted_mean_final_od_80_Acarbose <- mean(subset(sim_output_wide_80_Acarbose, Hour == 48)$Total_OD, na.rm = TRUE)
predicted_sd_final_od_80_Acarbose <- sd(subset(sim_output_wide_80_Acarbose, Hour == 48)$Total_OD, na.rm = TRUE)

real_mean_final_od_80_Acarbose <- Community_compositions_focus_drugs_Acarbose_80uM_summarised$mean_final_OD[1]
real_sd_final_od_80_Acarbose <- Community_compositions_focus_drugs_Acarbose_80uM_summarised$sd_final_OD[1]




#plot_data_0_Acarbose_endpoint was used to test model performance at 0 drugs
#plot_data_0_Acarbose_endpoint <- subset(plot_data_0_Acarbose, Hour == 48 & Species != "Drug")
plot_data_5_Acarbose_endpoint <- subset(plot_data_5_Acarbose, Hour == 48 & Species != "Drug")
plot_data_20_Acarbose_endpoint <- subset(plot_data_20_Acarbose, Hour == 48 & Species != "Drug")
plot_data_80_Acarbose_endpoint <- subset(plot_data_80_Acarbose, Hour == 48 & Species != "Drug")

##Inspecting 'match' to real relative abundance distributions:
Niclosamide_16S_0uM_summarised <- rel_ab_control
Niclosamide_16S_0uM_summarised$Species <- gsub("\\.", "", Niclosamide_16S_0uM_summarised$Species)

Acarbose_16S_5uM_summarised <- Community_compositions_focus_drugs_Acarbose_5uM_summarised
Acarbose_16S_20uM_summarised <- Community_compositions_focus_drugs_Acarbose_20uM_summarised
Acarbose_16S_80uM_summarised <- Community_compositions_focus_drugs_Acarbose_80uM_summarised

Niclosamide_16S_0uM_summarised
Acarbose_16S_5uM_summarised 
Acarbose_16S_20uM_summarised 
Acarbose_16S_80uM_summarised 

#Rename 'species' so the outputs become comparable
original_names_80 <- unique(Acarbose_16S_80uM_summarised$species)
original_names_20 <- unique(Acarbose_16S_20uM_summarised$species)
original_names_5 <- unique(Acarbose_16S_5uM_summarised$species)


##Create a named vector with the original and new names mapping
name_changes <- c(
  "Akkermansia muciniphila" = "A_muciniphila",
  "Bacteroides fragilis" = "B_fragilis",
  "Bacteroides thetaiotaomicron" = "B_thetaiotaomicron",
  "Bacteroides uniformis" = "B_uniformis",
  "Bifidobacterium adolescentis" = "B_adolescentis",
  "Bifidobacterium longum subsp. longum" = "B_longum",
  "Bilophila wadsworthia" = "B_wadsworthia",
  "Blautia obeum" = "B_obeum",
  "Clostridium perfringens" = "C_perfringens",
  "Collinsella aerofaciens" = "C_aerofaciens",
  "Coprococcus comes" = "C_comes",
  "Dorea formicigenerans" = "D_formicigenerans",
  "Eggerthella lenta" = "E_lenta",
  "Enterocloster bolteae" = "C_bolteae",
  "Erysipelatoclostridium ramosum" = "C_ramosum",
  "Escherichia coli ED1a" = "E_coli",
  "Eubacterium rectale" = "E_rectale",
  "Fusobacterium nucleatum subsp. nucleatum" = "F_nucleatum",
  "Lacrimispora saccharolytica" = "C_saccharolyticum",
  "Lacticaseibacillus paracasei" = "L_paracasei",
  "Odoribacter splanchnicus" = "O_splanchnicus",
  "Parabacteroides distasonis" = "P_distasonis",
  "Parabacteroides merdae" = "P_merdae",
  "Phocaeicola vulgatus" = "B_vulgatus",
  "Prevotella copri" = "P_copri",
  "Roseburia intestinalis" = "R_intestinalis",
  "Ruminococcus bromii" = "R_bromii",
  "Ruminococcus gnavus" = "R_gnavus",
  "Ruminococcus torques" = "R_torques",
  "Streptococcus parasanguinis" = "S_parasanguinis",
  "Streptococcus salivarius" = "S_salivarius",
  "Veillonella parvula" = "V_parvula"
)

# Apply name changes to the species column in Acarbose_16S_80uM_summarised

Acarbose_16S_80uM_summarised$Species <- name_changes[Acarbose_16S_80uM_summarised$species]
Acarbose_16S_20uM_summarised$Species <- name_changes[Acarbose_16S_20uM_summarised$species]
Acarbose_16S_5uM_summarised$Species <- name_changes[Acarbose_16S_5uM_summarised$species]

# Verify the changes
unique(Acarbose_16S_80uM_summarised$Species)
unique(Acarbose_16S_20uM_summarised$Species)
unique(Acarbose_16S_5uM_summarised$Species)



##First, for 5 uM:
# Get top 6 species from plot_data_5_endpoint
# Adjust the plot_data_5_endpoint with confidence bounds

# #plot_data_0_Acarbose_endpoint was used to test model performance at 0 drugs
# plot_data_0_Acarbose_endpoint <- plot_data_0_Acarbose_endpoint %>%
#   dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)

plot_data_5_Acarbose_endpoint <- plot_data_5_Acarbose_endpoint %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)

# Adjust the Acarbose_16S_5uM_summarised with confidence bounds
Acarbose_16S_5uM_summarised <- Acarbose_16S_5uM_summarised %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)

#NULL model:
Null_model_summarised <- Niclosamide_16S_0uM_summarised %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)


# Get top 6 species based on the lower bound from plot_data_5_endpoint

#top6_predicted_0_Acarbose was used to test model performance at 0 drugs
# top6_predicted_0_Acarbose <- plot_data_0_Acarbose_endpoint %>%
#    arrange(desc(lower_bound)) %>%
#    slice(1:6) %>%
#    pull(Species)

top6_predicted_5_Acarbose <- plot_data_5_Acarbose_endpoint %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

# Get top 6 species based on the lower bound from Acarbose_16S_5uM_summarised
top6_real_5_Acarbose <- Acarbose_16S_5uM_summarised %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

top6_NULL <- Null_model_summarised %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

# Calculate the overlap of top 6 species

#top_six_correct_0_Acarbose was used to assess model performance at 0 drugs
# top_six_correct_0_Acarbose <- length(intersect(top6_predicted_0_Acarbose, top6_NULL))
# top_six_correct_0_Acarbose

top_six_correct_5_Acarbose <- length(intersect(top6_predicted_5_Acarbose, top6_real_5_Acarbose))
top_six_correct_5_Acarbose

top_six_correct_5_Acarbose_NULL <- length(intersect(top6_NULL, top6_real_5_Acarbose))
top_six_correct_5_Acarbose_NULL

top6_predicted_5_Acarbose
top6_real_5_Acarbose

#top6_NULL

#Now by means:
# #top6_predicted_0_Acarbose_means was used to assess model performance at 0 drugs
# top6_predicted_0_Acarbose_means <- plot_data_0_Acarbose_endpoint %>%
#    arrange(desc(mean_rel_ab)) %>%
#    slice(1:6) %>%
#    pull(Species)

top6_predicted_5_Acarbose_means <- plot_data_5_Acarbose_endpoint %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)

# Get top 6 species based on the lower bound from Acarbose_16S_5uM_summarised
top6_real_5_Acarbose_means <- Acarbose_16S_5uM_summarised %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)

top6_NULL_means <- Null_model_summarised %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)


# #top_six_correct_0_Acarbose_means was used to assess model performance at 0 drugs
# top_six_correct_0_Acarbose_means <- length(intersect(top6_predicted_0_Acarbose_means, top6_NULL_means))
# top_six_correct_0_Acarbose_means

top_six_correct_5_Acarbose_means <- length(intersect(top6_predicted_5_Acarbose_means, top6_real_5_Acarbose_means))
top_six_correct_5_Acarbose_means

top_six_correct_5_Acarbose_means_NULL <- length(intersect(top6_NULL_means, top6_real_5_Acarbose_means))
top_six_correct_5_Acarbose_means_NULL

top6_predicted_5_Acarbose_means
top6_real_5_Acarbose_means

#top6_NULL_means


# Merge dataframes by Species

#merged_data_0_Acarbose was used to assess model performance at 0 drugs
#merged_data_0_Acarbose <- merge(plot_data_0_Acarbose_endpoint, Niclosamide_16S_0uM_summarised, by = "Species", suffixes = c(".pred", ".real"))
merged_data_5_Acarbose <- merge(plot_data_5_Acarbose_endpoint, Acarbose_16S_5uM_summarised, by = "Species", suffixes = c(".pred", ".real"))
merged_data_5_Acarbose_NULL <- merge(Niclosamide_16S_0uM_summarised, Acarbose_16S_5uM_summarised, by = "Species", suffixes = c(".null", ".real"))


## Below lines used for assessing model performance at 0 drugs; ignore for nonzero concentrations
# # Create lower and upper bounds considering mean ¬± sd
# merged_data_0_Acarbose$lower_bound_pred <- merged_data_0_Acarbose$mean_rel_ab.pred - merged_data_0_Acarbose$sd_rel_ab.pred
# merged_data_0_Acarbose$upper_bound_pred <- merged_data_0_Acarbose$mean_rel_ab.pred + merged_data_0_Acarbose$sd_rel_ab.pred
# merged_data_0_Acarbose$lower_bound_real <- merged_data_0_Acarbose$mean_rel_ab.real - merged_data_0_Acarbose$sd_rel_ab.real
# merged_data_0_Acarbose$upper_bound_real <- merged_data_0_Acarbose$mean_rel_ab.real + merged_data_0_Acarbose$sd_rel_ab.real
# 
# # Ensure lower and upper bounds are non-negative, adjusting as necessary
# merged_data_0_Acarbose$lower_bound_pred[merged_data_0_Acarbose$lower_bound_pred <= 0] <- 1e-10
# merged_data_0_Acarbose$lower_bound_real[merged_data_0_Acarbose$lower_bound_real <= 0] <- 1e-10
# merged_data_0_Acarbose$upper_bound_pred[merged_data_0_Acarbose$upper_bound_pred <= 0] <- 1e-10
# merged_data_0_Acarbose$upper_bound_real[merged_data_0_Acarbose$upper_bound_real <= 0] <- 1e-10


# Create lower and upper bounds considering mean ¬± sd
merged_data_5_Acarbose$lower_bound_pred <- merged_data_5_Acarbose$mean_rel_ab.pred - merged_data_5_Acarbose$sd_rel_ab.pred
merged_data_5_Acarbose$upper_bound_pred <- merged_data_5_Acarbose$mean_rel_ab.pred + merged_data_5_Acarbose$sd_rel_ab.pred
merged_data_5_Acarbose$lower_bound_real <- merged_data_5_Acarbose$mean_rel_ab.real - merged_data_5_Acarbose$sd_rel_ab.real
merged_data_5_Acarbose$upper_bound_real <- merged_data_5_Acarbose$mean_rel_ab.real + merged_data_5_Acarbose$sd_rel_ab.real

# Ensure lower and upper bounds are non-negative, adjusting as necessary
merged_data_5_Acarbose$lower_bound_pred[merged_data_5_Acarbose$lower_bound_pred <= 0] <- 1e-10
merged_data_5_Acarbose$lower_bound_real[merged_data_5_Acarbose$lower_bound_real <= 0] <- 1e-10
merged_data_5_Acarbose$upper_bound_pred[merged_data_5_Acarbose$upper_bound_pred <= 0] <- 1e-10
merged_data_5_Acarbose$upper_bound_real[merged_data_5_Acarbose$upper_bound_real <= 0] <- 1e-10

##and for NULL model:
# Create lower and upper bounds considering mean ¬± sd
merged_data_5_Acarbose_NULL$lower_bound_null <- merged_data_5_Acarbose_NULL$mean_rel_ab.null - merged_data_5_Acarbose_NULL$sd_rel_ab.null
merged_data_5_Acarbose_NULL$upper_bound_null <- merged_data_5_Acarbose_NULL$mean_rel_ab.null + merged_data_5_Acarbose_NULL$sd_rel_ab.null
merged_data_5_Acarbose_NULL$lower_bound_real <- merged_data_5_Acarbose_NULL$mean_rel_ab.real - merged_data_5_Acarbose_NULL$sd_rel_ab.real
merged_data_5_Acarbose_NULL$upper_bound_real <- merged_data_5_Acarbose_NULL$mean_rel_ab.real + merged_data_5_Acarbose_NULL$sd_rel_ab.real

# Ensure lower and upper bounds are non-negative, adjusting as necessary
merged_data_5_Acarbose_NULL$lower_bound_null[merged_data_5_Acarbose_NULL$lower_bound_null <= 0] <- 1e-10
merged_data_5_Acarbose_NULL$lower_bound_real[merged_data_5_Acarbose_NULL$lower_bound_real <= 0] <- 1e-10
merged_data_5_Acarbose_NULL$upper_bound_null[merged_data_5_Acarbose_NULL$upper_bound_null <= 0] <- 1e-10
merged_data_5_Acarbose_NULL$upper_bound_real[merged_data_5_Acarbose_NULL$upper_bound_real <= 0] <- 1e-10

# Filter to include only species with a mean relative abundance > 0.01 in the 'real' dataset

## significant_species_0 was used to assess model performance at 0 drugs
#significant_species_0 <- merged_data_0_Acarbose[merged_data_0_Acarbose$mean_rel_ab.real > 0.01, ]
significant_species <- merged_data_5_Acarbose[merged_data_5_Acarbose$mean_rel_ab.real > 0.01, ]
survivors_5_Acarbose <- nrow(significant_species)
survivors_5_Acarbose

#should be the same as survivors defined above, since it is calculated from .real
significant_species_NULL <- merged_data_5_Acarbose_NULL[merged_data_5_Acarbose_NULL$mean_rel_ab.real > 0.01, ]
survivors_5_Acarbose_NULL <- nrow(significant_species_NULL)
survivors_5_Acarbose_NULL

# Adjusted order of magnitude check to include SD, only for significant species
## below code was used to assess model performance at 0 drugs
# significant_species_0$Predicted_magnitude_correct <- ifelse(
#   (floor(log10(significant_species_0$lower_bound_pred)) <= floor(log10(significant_species_0$upper_bound_real)) &
#      floor(log10(significant_species_0$upper_bound_pred)) >= floor(log10(significant_species_0$lower_bound_real))),
#   1,
#   0
# )

significant_species$Predicted_magnitude_correct <- ifelse(
  (floor(log10(significant_species$lower_bound_pred)) <= floor(log10(significant_species$upper_bound_real)) &
     floor(log10(significant_species$upper_bound_pred)) >= floor(log10(significant_species$lower_bound_real))),
  1,
  0
)

#and for the Null model:
significant_species_NULL$Predicted_magnitude_correct <- ifelse(
  (floor(log10(significant_species_NULL$lower_bound_null)) <= floor(log10(significant_species_NULL$upper_bound_real)) &
     floor(log10(significant_species_NULL$upper_bound_null)) >= floor(log10(significant_species_NULL$lower_bound_real))),
  1,
  0
)

# Calculate the fraction of correctly predicted magnitudes for significant species
## below code was used to assess model performance at 0 drugs
#predicted_magnitude_correct_fraction_0_Acarbose <- sum(significant_species_0$Predicted_magnitude_correct) / nrow(significant_species_0)
#predicted_magnitude_correct_fraction_0_Acarbose

predicted_magnitude_correct_fraction_5_Acarbose <- sum(significant_species$Predicted_magnitude_correct) / nrow(significant_species)
predicted_magnitude_correct_fraction_5_Acarbose

predicted_magnitude_correct_fraction_5_Acarbose_NULL <- sum(significant_species_NULL$Predicted_magnitude_correct) / nrow(significant_species_NULL)
predicted_magnitude_correct_fraction_5_Acarbose_NULL

top_species_missing_5_Acarbose <- setdiff(top6_real_5_Acarbose_means, top6_predicted_5_Acarbose_means)
top_species_wrong_5_Acarbose <- setdiff(top6_predicted_5_Acarbose_means, top6_real_5_Acarbose_means)


Prediction_quality_5_Acarbose <- data.frame(
  Top_six_correct = paste(top_six_correct_5_Acarbose, sep=""),
  Top_six_correct_NULL = paste(top_six_correct_5_Acarbose_NULL, sep=""),
  Top_six_correct_means = paste(top_six_correct_5_Acarbose_means, sep=""),
  Top_six_correct_means_NULL = paste(top_six_correct_5_Acarbose_means_NULL, sep=""),
  Predicted_magnitude_correct = paste(round(predicted_magnitude_correct_fraction_5_Acarbose * 100, 2), "%", sep=""),
  Predicted_magnitude_correct_NULL = paste(round(predicted_magnitude_correct_fraction_5_Acarbose_NULL * 100, 2), "%", sep=""),
  survivors_total = survivors_5_Acarbose,
  top_species_missing <- top_species_missing_5_Acarbose,
  top_species_wrong <- top_species_wrong_5_Acarbose, 
  predicted_mean_final_OD <- predicted_mean_final_od_5_Acarbose,
  real_mean_final_OD <- real_mean_final_od_5_Acarbose,
  sims_total = length(successful_sim_ids)
)



Prediction_quality_5_Acarbose



##Next, for 20 uM:
# Get top 6 species from plot_data_20_endpoint
# Adjust the plot_data_20_endpoint with confidence bounds
plot_data_20_Acarbose_endpoint <- plot_data_20_Acarbose_endpoint %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)

# Adjust the Acarbose_16S_20uM_summarised with confidence bounds
Acarbose_16S_20uM_summarised <- Acarbose_16S_20uM_summarised %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)

#NULL model:
Null_model_summarised <- Niclosamide_16S_0uM_summarised %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)


# Get top 6 species based on the lower bound from plot_data_20_endpoint
top6_predicted_20_Acarbose <- plot_data_20_Acarbose_endpoint %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

# Get top 6 species based on the lower bound from Acarbose_16S_20uM_summarised
top6_real_20_Acarbose <- Acarbose_16S_20uM_summarised %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

top6_NULL <- Null_model_summarised %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

# Calculate the overlap of top 6 species
top_six_correct_20_Acarbose <- length(intersect(top6_predicted_20_Acarbose, top6_real_20_Acarbose))
#top_six_correct_20_Acarbose

top_six_correct_20_Acarbose_NULL <- length(intersect(top6_NULL, top6_real_20_Acarbose))
#top_six_correct_20_Acarbose_NULL

#top6_predicted_20_Acarbose
#top6_real_20_Acarbose



#Now by means:
top6_predicted_20_Acarbose_means <- plot_data_20_Acarbose_endpoint %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)

# Get top 6 species based on the lower bound from Acarbose_16S_20uM_summarised
top6_real_20_Acarbose_means <- Acarbose_16S_20uM_summarised %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)

top6_NULL_means <- Null_model_summarised %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)



top_six_correct_20_Acarbose_means <- length(intersect(top6_predicted_20_Acarbose_means, top6_real_20_Acarbose_means))
#top_six_correct_20_Acarbose_means

top_six_correct_20_Acarbose_means_NULL <- length(intersect(top6_NULL_means, top6_real_20_Acarbose_means))
#top_six_correct_20_Acarbose_means_NULL

top6_predicted_20_Acarbose_means
#top6_real_20_Acarbose_means




# Merge dataframes by Species
merged_data_20_Acarbose <- merge(plot_data_20_Acarbose_endpoint, Acarbose_16S_20uM_summarised, by = "Species", suffixes = c(".pred", ".real"))
merged_data_20_Acarbose_NULL <- merge(Niclosamide_16S_0uM_summarised, Acarbose_16S_20uM_summarised, by = "Species", suffixes = c(".null", ".real"))



# Create lower and upper bounds considering mean ¬± sd
merged_data_20_Acarbose$lower_bound_pred <- merged_data_20_Acarbose$mean_rel_ab.pred - merged_data_20_Acarbose$sd_rel_ab.pred
merged_data_20_Acarbose$upper_bound_pred <- merged_data_20_Acarbose$mean_rel_ab.pred + merged_data_20_Acarbose$sd_rel_ab.pred
merged_data_20_Acarbose$lower_bound_real <- merged_data_20_Acarbose$mean_rel_ab.real - merged_data_20_Acarbose$sd_rel_ab.real
merged_data_20_Acarbose$upper_bound_real <- merged_data_20_Acarbose$mean_rel_ab.real + merged_data_20_Acarbose$sd_rel_ab.real

# Ensure lower and upper bounds are non-negative, adjusting as necessary
merged_data_20_Acarbose$lower_bound_pred[merged_data_20_Acarbose$lower_bound_pred <= 0] <- 1e-10
merged_data_20_Acarbose$lower_bound_real[merged_data_20_Acarbose$lower_bound_real <= 0] <- 1e-10
merged_data_20_Acarbose$upper_bound_pred[merged_data_20_Acarbose$upper_bound_pred <= 0] <- 1e-10
merged_data_20_Acarbose$upper_bound_real[merged_data_20_Acarbose$upper_bound_real <= 0] <- 1e-10

##and for NULL model:
# Create lower and upper bounds considering mean ¬± sd
merged_data_20_Acarbose_NULL$lower_bound_null <- merged_data_20_Acarbose_NULL$mean_rel_ab.null - merged_data_20_Acarbose_NULL$sd_rel_ab.null
merged_data_20_Acarbose_NULL$upper_bound_null <- merged_data_20_Acarbose_NULL$mean_rel_ab.null + merged_data_20_Acarbose_NULL$sd_rel_ab.null
merged_data_20_Acarbose_NULL$lower_bound_real <- merged_data_20_Acarbose_NULL$mean_rel_ab.real - merged_data_20_Acarbose_NULL$sd_rel_ab.real
merged_data_20_Acarbose_NULL$upper_bound_real <- merged_data_20_Acarbose_NULL$mean_rel_ab.real + merged_data_20_Acarbose_NULL$sd_rel_ab.real

# Ensure lower and upper bounds are non-negative, adjusting as necessary
merged_data_20_Acarbose_NULL$lower_bound_null[merged_data_20_Acarbose_NULL$lower_bound_null <= 0] <- 1e-10
merged_data_20_Acarbose_NULL$lower_bound_real[merged_data_20_Acarbose_NULL$lower_bound_real <= 0] <- 1e-10
merged_data_20_Acarbose_NULL$upper_bound_null[merged_data_20_Acarbose_NULL$upper_bound_null <= 0] <- 1e-10
merged_data_20_Acarbose_NULL$upper_bound_real[merged_data_20_Acarbose_NULL$upper_bound_real <= 0] <- 1e-10

# Filter to include only species with a mean relative abundance > 0.01 in the 'real' dataset
significant_species <- merged_data_20_Acarbose[merged_data_20_Acarbose$mean_rel_ab.real > 0.01, ]
survivors_20_Acarbose <- nrow(significant_species)
survivors_20_Acarbose

#should be the same as survivors defined above, since it is calculated from .real
significant_species_NULL <- merged_data_20_Acarbose_NULL[merged_data_20_Acarbose_NULL$mean_rel_ab.real > 0.01, ]
survivors_20_Acarbose_NULL <- nrow(significant_species_NULL)
survivors_20_Acarbose_NULL

# Adjusted order of magnitude check to include SD, only for significant species
significant_species$Predicted_magnitude_correct <- ifelse(
  (floor(log10(significant_species$lower_bound_pred)) <= floor(log10(significant_species$upper_bound_real)) &
     floor(log10(significant_species$upper_bound_pred)) >= floor(log10(significant_species$lower_bound_real))),
  1,
  0
)

#and for the Null model:
significant_species_NULL$Predicted_magnitude_correct <- ifelse(
  (floor(log10(significant_species_NULL$lower_bound_null)) <= floor(log10(significant_species_NULL$upper_bound_real)) &
     floor(log10(significant_species_NULL$upper_bound_null)) >= floor(log10(significant_species_NULL$lower_bound_real))),
  1,
  0
)

# Calculate the fraction of correctly predicted magnitudes for significant species
predicted_magnitude_correct_fraction_20_Acarbose <- sum(significant_species$Predicted_magnitude_correct) / nrow(significant_species)
predicted_magnitude_correct_fraction_20_Acarbose

predicted_magnitude_correct_fraction_20_Acarbose_NULL <- sum(significant_species_NULL$Predicted_magnitude_correct) / nrow(significant_species_NULL)
predicted_magnitude_correct_fraction_20_Acarbose_NULL

top_species_missing_20_Acarbose <- setdiff(top6_real_20_Acarbose_means, top6_predicted_20_Acarbose_means)
top_species_wrong_20_Acarbose <- setdiff(top6_predicted_20_Acarbose_means, top6_real_20_Acarbose_means)

Prediction_quality_20_Acarbose <- data.frame(
  Top_six_correct = paste(top_six_correct_20_Acarbose, sep=""),
  Top_six_correct_NULL = paste(top_six_correct_20_Acarbose_NULL, sep=""),
  Top_six_correct_means = paste(top_six_correct_20_Acarbose_means, sep=""),
  Top_six_correct_means_NULL = paste(top_six_correct_20_Acarbose_means_NULL, sep=""),
  Predicted_magnitude_correct = paste(round(predicted_magnitude_correct_fraction_20_Acarbose * 100, 2), "%", sep=""),
  Predicted_magnitude_correct_NULL = paste(round(predicted_magnitude_correct_fraction_20_Acarbose_NULL * 100, 2), "%", sep=""),
  survivors_total = survivors_20_Acarbose,
  top_species_missing <- top_species_missing_20_Acarbose,
  top_species_wrong <- top_species_wrong_20_Acarbose, 
  predicted_mean_final_OD <- predicted_mean_final_od_20_Acarbose,
  real_mean_final_OD <- real_mean_final_od_20_Acarbose,
  sims_total = length(successful_sim_ids)
)

Prediction_quality_20_Acarbose






##Next, for 80 uM:
# Get top 6 species from plot_data_80_endpoint
# Adjust the plot_data_80_endpoint with confidence bounds
plot_data_80_Acarbose_endpoint <- plot_data_80_Acarbose_endpoint %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)

# Adjust the Acarbose_16S_80uM_summarised with confidence bounds
Acarbose_16S_80uM_summarised <- Acarbose_16S_80uM_summarised %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)

#NULL model:
Null_model_summarised <- Niclosamide_16S_0uM_summarised %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)


# Get top 6 species based on the lower bound from plot_data_80_endpoint
top6_predicted_80_Acarbose <- plot_data_80_Acarbose_endpoint %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

# Get top 6 species based on the lower bound from Acarbose_16S_80uM_summarised
top6_real_80_Acarbose <- Acarbose_16S_80uM_summarised %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

top6_NULL <- Null_model_summarised %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

# Calculate the overlap of top 6 species
top_six_correct_80_Acarbose <- length(intersect(top6_predicted_80_Acarbose, top6_real_80_Acarbose))
#top_six_correct_80_Acarbose

top_six_correct_80_Acarbose_NULL <- length(intersect(top6_NULL, top6_real_80_Acarbose))
#top_six_correct_80_Acarbose_NULL

#top6_predicted_80_Acarbose
#top6_real_80_Acarbose




#Now by means:
top6_predicted_80_Acarbose_means <- plot_data_80_Acarbose_endpoint %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)

# Get top 6 species based on the lower bound from Acarbose_16S_80uM_summarised
top6_real_80_Acarbose_means <- Acarbose_16S_80uM_summarised %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)

top6_NULL_means <- Null_model_summarised %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)



top_six_correct_80_Acarbose_means <- length(intersect(top6_predicted_80_Acarbose_means, top6_real_80_Acarbose_means))
#top_six_correct_80_Acarbose_means

top_six_correct_80_Acarbose_means_NULL <- length(intersect(top6_NULL_means, top6_real_80_Acarbose_means))
#top_six_correct_80_Acarbose_means_NULL

#top6_predicted_80_Acarbose_means
#top6_real_80_Acarbose_means




# Merge dataframes by Species
merged_data_80_Acarbose <- merge(plot_data_80_Acarbose_endpoint, Acarbose_16S_80uM_summarised, by = "Species", suffixes = c(".pred", ".real"))
merged_data_80_Acarbose_NULL <- merge(Niclosamide_16S_0uM_summarised, Acarbose_16S_80uM_summarised, by = "Species", suffixes = c(".null", ".real"))



# Create lower and upper bounds considering mean ¬± sd
merged_data_80_Acarbose$lower_bound_pred <- merged_data_80_Acarbose$mean_rel_ab.pred - merged_data_80_Acarbose$sd_rel_ab.pred
merged_data_80_Acarbose$upper_bound_pred <- merged_data_80_Acarbose$mean_rel_ab.pred + merged_data_80_Acarbose$sd_rel_ab.pred
merged_data_80_Acarbose$lower_bound_real <- merged_data_80_Acarbose$mean_rel_ab.real - merged_data_80_Acarbose$sd_rel_ab.real
merged_data_80_Acarbose$upper_bound_real <- merged_data_80_Acarbose$mean_rel_ab.real + merged_data_80_Acarbose$sd_rel_ab.real

# Ensure lower and upper bounds are non-negative, adjusting as necessary
merged_data_80_Acarbose$lower_bound_pred[merged_data_80_Acarbose$lower_bound_pred <= 0] <- 1e-10
merged_data_80_Acarbose$lower_bound_real[merged_data_80_Acarbose$lower_bound_real <= 0] <- 1e-10
merged_data_80_Acarbose$upper_bound_pred[merged_data_80_Acarbose$upper_bound_pred <= 0] <- 1e-10
merged_data_80_Acarbose$upper_bound_real[merged_data_80_Acarbose$upper_bound_real <= 0] <- 1e-10

##and for NULL model:
# Create lower and upper bounds considering mean ¬± sd
merged_data_80_Acarbose_NULL$lower_bound_null <- merged_data_80_Acarbose_NULL$mean_rel_ab.null - merged_data_80_Acarbose_NULL$sd_rel_ab.null
merged_data_80_Acarbose_NULL$upper_bound_null <- merged_data_80_Acarbose_NULL$mean_rel_ab.null + merged_data_80_Acarbose_NULL$sd_rel_ab.null
merged_data_80_Acarbose_NULL$lower_bound_real <- merged_data_80_Acarbose_NULL$mean_rel_ab.real - merged_data_80_Acarbose_NULL$sd_rel_ab.real
merged_data_80_Acarbose_NULL$upper_bound_real <- merged_data_80_Acarbose_NULL$mean_rel_ab.real + merged_data_80_Acarbose_NULL$sd_rel_ab.real

# Ensure lower and upper bounds are non-negative, adjusting as necessary
merged_data_80_Acarbose_NULL$lower_bound_null[merged_data_80_Acarbose_NULL$lower_bound_null <= 0] <- 1e-10
merged_data_80_Acarbose_NULL$lower_bound_real[merged_data_80_Acarbose_NULL$lower_bound_real <= 0] <- 1e-10
merged_data_80_Acarbose_NULL$upper_bound_null[merged_data_80_Acarbose_NULL$upper_bound_null <= 0] <- 1e-10
merged_data_80_Acarbose_NULL$upper_bound_real[merged_data_80_Acarbose_NULL$upper_bound_real <= 0] <- 1e-10

# Filter to include only species with a mean relative abundance > 0.01 in the 'real' dataset
significant_species <- merged_data_80_Acarbose[merged_data_80_Acarbose$mean_rel_ab.real > 0.01, ]
survivors_80_Acarbose <- nrow(significant_species)
survivors_80_Acarbose

#should be the same as survivors defined above, since it is calculated from .real
significant_species_NULL <- merged_data_80_Acarbose_NULL[merged_data_80_Acarbose_NULL$mean_rel_ab.real > 0.01, ]
survivors_80_Acarbose_NULL <- nrow(significant_species_NULL)
survivors_80_Acarbose_NULL

# Adjusted order of magnitude check to include SD, only for significant species
significant_species$Predicted_magnitude_correct <- ifelse(
  (floor(log10(significant_species$lower_bound_pred)) <= floor(log10(significant_species$upper_bound_real)) &
     floor(log10(significant_species$upper_bound_pred)) >= floor(log10(significant_species$lower_bound_real))),
  1,
  0
)

#and for the Null model:
significant_species_NULL$Predicted_magnitude_correct <- ifelse(
  (floor(log10(significant_species_NULL$lower_bound_null)) <= floor(log10(significant_species_NULL$upper_bound_real)) &
     floor(log10(significant_species_NULL$upper_bound_null)) >= floor(log10(significant_species_NULL$lower_bound_real))),
  1,
  0
)

# Calculate the fraction of correctly predicted magnitudes for significant species
predicted_magnitude_correct_fraction_80_Acarbose <- sum(significant_species$Predicted_magnitude_correct) / nrow(significant_species)
predicted_magnitude_correct_fraction_80_Acarbose

predicted_magnitude_correct_fraction_80_Acarbose_NULL <- sum(significant_species_NULL$Predicted_magnitude_correct) / nrow(significant_species_NULL)
predicted_magnitude_correct_fraction_80_Acarbose_NULL


top_species_missing_80_Acarbose <- setdiff(top6_real_80_Acarbose_means, top6_predicted_80_Acarbose_means)
top_species_wrong_80_Acarbose <- setdiff(top6_predicted_80_Acarbose_means, top6_real_80_Acarbose_means)

Prediction_quality_80_Acarbose <- data.frame(
  Top_six_correct = paste(top_six_correct_80_Acarbose, sep=""),
  Top_six_correct_NULL = paste(top_six_correct_80_Acarbose_NULL, sep=""),
  Top_six_correct_means = paste(top_six_correct_80_Acarbose_means, sep=""),
  Top_six_correct_means_NULL = paste(top_six_correct_80_Acarbose_means_NULL, sep=""),
  Predicted_magnitude_correct = paste(round(predicted_magnitude_correct_fraction_80_Acarbose * 100, 2), "%", sep=""),
  Predicted_magnitude_correct_NULL = paste(round(predicted_magnitude_correct_fraction_80_Acarbose_NULL * 100, 2), "%", sep=""),
  survivors_total = survivors_80_Acarbose,
  top_species_missing <- top_species_missing_80_Acarbose,
  top_species_wrong <- top_species_wrong_80_Acarbose, 
  predicted_mean_final_OD <- predicted_mean_final_od_80_Acarbose,
  real_mean_final_OD <- real_mean_final_od_80_Acarbose,
  sims_total = length(successful_sim_ids)
)

Prediction_quality_80_Acarbose








##Amlodipine

combined_monoculture_aucs2_Amlodipine <- subset(combined_monoculture_aucs2, drug == "Amlodipine")


#drug sensitivity terms: define once outside of ODEs
y_function_B_vulgatus_Amlodipine <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("B_vulgatus", "Amlodipine", best_fitting_models_df_Amlodipine)), collapse = " ")))
y_function_B_uniformis_Amlodipine <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("B_uniformis", "Amlodipine", best_fitting_models_df_Amlodipine)), collapse = " ")))
y_function_B_fragilis_Amlodipine <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("B_fragilis", "Amlodipine", best_fitting_models_df_Amlodipine)), collapse = " ")))
y_function_B_thetaiotaomicron_Amlodipine <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("B_thetaiotaomicron", "Amlodipine", best_fitting_models_df_Amlodipine)), collapse = " ")))
y_function_C_ramosum_Amlodipine <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("C_ramosum", "Amlodipine", best_fitting_models_df_Amlodipine)), collapse = " ")))
y_function_E_rectale_Amlodipine <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("E_rectale", "Amlodipine", best_fitting_models_df_Amlodipine)), collapse = " ")))
y_function_R_intestinalis_Amlodipine <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("R_intestinalis", "Amlodipine", best_fitting_models_df_Amlodipine)), collapse = " ")))
y_function_V_parvula_Amlodipine <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("V_parvula", "Amlodipine", best_fitting_models_df_Amlodipine)), collapse = " ")))
y_function_E_lenta_Amlodipine <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("E_lenta", "Amlodipine", best_fitting_models_df_Amlodipine)), collapse = " ")))
y_function_F_nucleatum_Amlodipine <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("F_nucleatum", "Amlodipine", best_fitting_models_df_Amlodipine)), collapse = " ")))
y_function_C_bolteae_Amlodipine <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("C_bolteae", "Amlodipine", best_fitting_models_df_Amlodipine)), collapse = " ")))
y_function_C_perfringens_Amlodipine <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("C_perfringens", "Amlodipine", best_fitting_models_df_Amlodipine)), collapse = " ")))
y_function_C_saccharolyticum_Amlodipine <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("C_saccharolyticum", "Amlodipine", best_fitting_models_df_Amlodipine)), collapse = " ")))
y_function_S_salivarius_Amlodipine <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("S_salivarius", "Amlodipine", best_fitting_models_df_Amlodipine)), collapse = " ")))
y_function_R_gnavus_Amlodipine <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("R_gnavus", "Amlodipine", best_fitting_models_df_Amlodipine)), collapse = " ")))
y_function_C_comes_Amlodipine <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("C_comes", "Amlodipine", best_fitting_models_df_Amlodipine)), collapse = " ")))
y_function_P_merdae_Amlodipine <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("P_merdae", "Amlodipine", best_fitting_models_df_Amlodipine)), collapse = " ")))
y_function_S_parasanguinis_Amlodipine <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("S_parasanguinis", "Amlodipine", best_fitting_models_df_Amlodipine)), collapse = " ")))
y_function_C_aerofaciens_Amlodipine <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("C_aerofaciens", "Amlodipine", best_fitting_models_df_Amlodipine)), collapse = " ")))
y_function_D_formicigenerans_Amlodipine <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("D_formicigenerans", "Amlodipine", best_fitting_models_df_Amlodipine)), collapse = " ")))
y_function_E_coli_Amlodipine <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("E_coli", "Amlodipine", best_fitting_models_df_Amlodipine)), collapse = " ")))



y_function_B_vulgatus_Amlodipine_func <- eval(parse(text = paste("function(Drug) {", y_function_B_vulgatus_Amlodipine, "}")))
y_function_B_uniformis_Amlodipine_func <- eval(parse(text = paste("function(Drug) {", y_function_B_uniformis_Amlodipine, "}")))
y_function_B_fragilis_Amlodipine_func <- eval(parse(text = paste("function(Drug) {", y_function_B_fragilis_Amlodipine, "}")))
y_function_B_thetaiotaomicron_Amlodipine_func <- eval(parse(text = paste("function(Drug) {", y_function_B_thetaiotaomicron_Amlodipine, "}")))
y_function_C_ramosum_Amlodipine_func <- eval(parse(text = paste("function(Drug) {", y_function_C_ramosum_Amlodipine, "}")))
y_function_E_rectale_Amlodipine_func <- eval(parse(text = paste("function(Drug) {", y_function_E_rectale_Amlodipine, "}")))
y_function_R_intestinalis_Amlodipine_func <- eval(parse(text = paste("function(Drug) {", y_function_R_intestinalis_Amlodipine, "}")))
y_function_E_lenta_Amlodipine_func <- eval(parse(text = paste("function(Drug) {", y_function_E_lenta_Amlodipine, "}")))
y_function_F_nucleatum_Amlodipine_func <- eval(parse(text = paste("function(Drug) {", y_function_F_nucleatum_Amlodipine, "}")))
y_function_C_bolteae_Amlodipine_func <- eval(parse(text = paste("function(Drug) {", y_function_C_bolteae_Amlodipine, "}")))
y_function_C_perfringens_Amlodipine_func <- eval(parse(text = paste("function(Drug) {", y_function_C_perfringens_Amlodipine, "}")))
y_function_C_saccharolyticum_Amlodipine_func <- eval(parse(text = paste("function(Drug) {", y_function_C_saccharolyticum_Amlodipine, "}")))
y_function_S_salivarius_Amlodipine_func <- eval(parse(text = paste("function(Drug) {", y_function_S_salivarius_Amlodipine, "}")))
y_function_R_gnavus_Amlodipine_func <- eval(parse(text = paste("function(Drug) {", y_function_R_gnavus_Amlodipine, "}")))
y_function_C_comes_Amlodipine_func <- eval(parse(text = paste("function(Drug) {", y_function_C_comes_Amlodipine, "}")))
y_function_P_merdae_Amlodipine_func <- eval(parse(text = paste("function(Drug) {", y_function_P_merdae_Amlodipine, "}")))
y_function_S_parasanguinis_Amlodipine_func <- eval(parse(text = paste("function(Drug) {", y_function_S_parasanguinis_Amlodipine, "}")))
y_function_C_aerofaciens_Amlodipine_func <- eval(parse(text = paste("function(Drug) {", y_function_C_aerofaciens_Amlodipine, "}")))
y_function_D_formicigenerans_Amlodipine_func <- eval(parse(text = paste("function(Drug) {", y_function_D_formicigenerans_Amlodipine, "}")))
y_function_E_coli_Amlodipine_func <- eval(parse(text = paste("function(Drug) {", y_function_E_coli_Amlodipine, "}")))
y_function_V_parvula_Amlodipine_func <- eval(parse(text = paste("function(Drug) {", y_function_V_parvula_Amlodipine, "}")))



unique(combined_monoculture_aucs2_Amlodipine$conc)
##dictate drug concentration tested for simulation cycle here:
#drug_concentration_tested <- 20 #if manually or:
drug_concentration_tested <- unique(combined_monoculture_aucs2_Amlodipine$conc)[1] 
initial_conditions <- rep(0.01/32, 32)
initial_conditions <- c(initial_conditions, drug_concentration_tested)


##drug effect fitted for species showing sensitivity in monoculture:
#unique(combined_monoculture_aucs2_Amlodipine$Species)

##for more simple linear fits
closed.sir.model_Amlodipine <- function (t, x, params) {
  ## first extract the state variables
  A_muciniphila <- x[1]
  B_adolescentis <- x[2]
  B_fragilis <- x[3]
  B_longum <- x[4]
  B_obeum <- x[5]
  B_thetaiotaomicron <- x[6]
  B_uniformis <- x[7]
  B_vulgatus <- x[8]
  B_wadsworthia <- x[9]
  C_aerofaciens <- x[10]
  C_bolteae <- x[11]
  C_comes <- x[12]
  C_perfringens <- x[13]
  C_ramosum <- x[14]
  C_saccharolyticum <- x[15]
  D_formicigenerans <- x[16]
  E_coli <- x[17]
  E_lenta <- x[18]
  E_rectale <- x[19]
  F_nucleatum <- x[20]
  L_paracasei <- x[21]
  O_splanchnicus <- x[22]
  P_copri <- x[23]
  P_distasonis <- x[24]
  P_merdae <- x[25]
  R_bromii <- x[26]
  R_gnavus <- x[27]
  R_intestinalis <- x[28]
  R_torques <- x[29]
  S_parasanguinis <- x[30]
  S_salivarius <- x[31]
  V_parvula <- x[32]
  Drug <- x[33]
  
  
  ## now extract the parameters
  r_B_fragilis <- flat_params[["B._fragilis.r"]]
  K_B_fragilis <- flat_params[["B._fragilis.K"]]
  r_B_longum <- flat_params[["B._longum.r"]]
  K_B_longum <- flat_params[["B._longum.K"]]
  r_B_thetaiotaomicron <- flat_params[["B._thetaiotaomicron.r"]]
  K_B_thetaiotaomicron <- flat_params[["B._thetaiotaomicron.K"]]
  r_B_uniformis <- flat_params[["B._uniformis.r"]]
  K_B_uniformis <- flat_params[["B._uniformis.K"]]
  r_B_vulgatus <- flat_params[["B._vulgatus.r"]]
  K_B_vulgatus <- flat_params[["B._vulgatus.K"]]
  r_B_wadsworthia <- flat_params[["B._wadsworthia.r"]]
  K_B_wadsworthia <- flat_params[["B._wadsworthia.K"]]
  r_C_aerofaciens <- flat_params[["C._aerofaciens.r"]]
  K_C_aerofaciens <- flat_params[["C._aerofaciens.K"]]
  r_C_bolteae <- flat_params[["C._bolteae.r"]]
  K_C_bolteae <- flat_params[["C._bolteae.K"]]
  r_C_comes <- flat_params[["C._comes.r"]]
  K_C_comes <- flat_params[["C._comes.K"]]
  r_C_perfringens <- flat_params[["C._perfringens.r"]]
  K_C_perfringens <- flat_params[["C._perfringens.K"]]
  r_C_ramosum <- flat_params[["C._ramosum.r"]]
  K_C_ramosum <- flat_params[["C._ramosum.K"]]
  r_C_saccharolyticum <- flat_params[["C._saccharolyticum.r"]]
  K_C_saccharolyticum <- flat_params[["C._saccharolyticum.K"]]
  r_D_formicigenerans <- flat_params[["D._formicigenerans.r"]]
  K_D_formicigenerans <- flat_params[["D._formicigenerans.K"]]
  r_E_coli <- flat_params[["E._coli.r"]]
  K_E_coli <- flat_params[["E._coli.K"]]
  r_E_lenta <- flat_params[["E._lenta.r"]]
  K_E_lenta <- flat_params[["E._lenta.K"]]
  r_E_rectale <- flat_params[["E._rectale.r"]]
  K_E_rectale <- flat_params[["E._rectale.K"]]
  r_F_nucleatum <- flat_params[["F._nucleatum.r"]]
  K_F_nucleatum <- flat_params[["F._nucleatum.K"]]
  r_P_copri <- flat_params[["P._copri.r"]]
  K_P_copri <- flat_params[["P._copri.K"]]
  r_P_merdae <- flat_params[["P._merdae.r"]]
  K_P_merdae <- flat_params[["P._merdae.K"]]
  r_R_gnavus <- flat_params[["R._gnavus.r"]]
  K_R_gnavus <- flat_params[["R._gnavus.K"]]
  r_R_intestinalis <- flat_params[["R._intestinalis.r"]]
  K_R_intestinalis <- flat_params[["R._intestinalis.K"]]
  r_V_parvula <- flat_params[["V._parvula.r"]]
  K_V_parvula <- flat_params[["V._parvula.K"]]
  r_A_muciniphila <- flat_params[["A._muciniphila.r"]]
  K_A_muciniphila <- flat_params[["A._muciniphila.K"]]
  r_B_adolescentis <- flat_params[["B._adolescentis.r"]]
  K_B_adolescentis <- flat_params[["B._adolescentis.K"]]
  r_B_obeum <- flat_params[["B._obeum.r"]]
  K_B_obeum <- flat_params[["B._obeum.K"]]
  r_O_splanchnicus <- flat_params[["O._splanchnicus.r"]]
  K_O_splanchnicus <- flat_params[["O._splanchnicus.K"]]
  r_P_distasonis <- flat_params[["P._distasonis.r"]]
  K_P_distasonis <- flat_params[["P._distasonis.K"]]
  r_R_bromii <- flat_params[["R._bromii.r"]]
  K_R_bromii <- flat_params[["R._bromii.K"]]
  r_R_torques <- flat_params[["R._torques.r"]]
  K_R_torques <- flat_params[["R._torques.K"]]
  r_S_parasanguinis <- flat_params[["S._parasanguinis.r"]]
  K_S_parasanguinis <-flat_params[["S._parasanguinis.K"]]
  r_S_salivarius <- flat_params[["S._salivarius.r"]]
  K_S_salivarius <- flat_params[["S._salivarius.K"]]
  r_L_paracasei <- flat_params[["L._paracasei.r"]]
  K_L_paracasei <- flat_params[["L._paracasei.K"]]
  
  
  t_mod <- ifelse(t > 24.1, t - 24.1, t)
  
  
  ## now code the model equations
  dA_muciniphila_dt <- r_A_muciniphila * A_muciniphila * (1 - A_muciniphila / K_A_muciniphila)
  dB_adolescentis_dt <- r_B_adolescentis * B_adolescentis * (1 - B_adolescentis / K_B_adolescentis)
  dB_fragilis_dt <- r_B_fragilis * B_fragilis * (1 - B_fragilis / max(0.0001, K_B_fragilis * (y_function_B_fragilis_Amlodipine_func(Drug))))
  dB_longum_dt <- r_B_longum * B_longum * (1 - B_longum / K_B_longum)
  dB_obeum_dt <- r_B_obeum * B_obeum * (1 - B_obeum / K_B_obeum)
  dB_thetaiotaomicron_dt <- r_B_thetaiotaomicron * B_thetaiotaomicron * (1 - B_thetaiotaomicron / max(0.0001, K_B_thetaiotaomicron * (y_function_B_thetaiotaomicron_Amlodipine_func(Drug))))  
  dB_uniformis_dt <- r_B_uniformis * B_uniformis * (1 - B_uniformis / max(0.0001, K_B_uniformis * (y_function_B_uniformis_Amlodipine_func(Drug))))
  dB_vulgatus_dt <- r_B_vulgatus * B_vulgatus * (1 - B_vulgatus / max(0.0001, K_B_vulgatus * (y_function_B_vulgatus_Amlodipine_func(Drug))))
  dB_wadsworthia_dt <- r_B_wadsworthia * B_wadsworthia * (1 - B_wadsworthia / K_B_wadsworthia)
  dC_aerofaciens_dt <- r_C_aerofaciens * C_aerofaciens * (1 - C_aerofaciens / max(0.0001, K_C_aerofaciens * (y_function_C_aerofaciens_Amlodipine_func(Drug))))
  dC_bolteae_dt <- r_C_bolteae * C_bolteae * (1 - C_bolteae /  max(0.0001, K_C_bolteae * (y_function_C_bolteae_Amlodipine_func(Drug))))
  dC_comes_dt <- r_C_comes * C_comes * (1 - C_comes / max(0.0001, K_C_comes * (y_function_C_comes_Amlodipine_func(Drug))))
  dC_perfringens_dt <- r_C_perfringens * C_perfringens * (1 - C_perfringens / max(0.0001, K_C_perfringens * (y_function_C_perfringens_Amlodipine_func(Drug))))
  dC_ramosum_dt <- r_C_ramosum * C_ramosum * (1 - C_ramosum / max(0.0001, K_C_ramosum * (y_function_C_ramosum_Amlodipine_func(Drug))))
  dC_saccharolyticum_dt <- r_C_saccharolyticum * C_saccharolyticum * (1 - C_saccharolyticum / max(0.0001, K_C_saccharolyticum * (y_function_C_saccharolyticum_Amlodipine_func(Drug))))
  dD_formicigenerans_dt <- r_D_formicigenerans * D_formicigenerans * (1 - D_formicigenerans / max(0.0001, K_D_formicigenerans * (y_function_D_formicigenerans_Amlodipine_func(Drug))))
  dE_coli_dt <- r_E_coli * E_coli * (1 - E_coli / max(0.0001, K_E_coli * (y_function_E_coli_Amlodipine_func(Drug))))
  dE_lenta_dt <- r_E_lenta * E_lenta * (1 - E_lenta / max(0.0001, K_E_lenta * (y_function_E_lenta_Amlodipine_func(Drug))))
  dE_rectale_dt <- r_E_rectale * E_rectale * (1 - E_rectale / max(0.0001, K_E_rectale * (y_function_E_rectale_Amlodipine_func(Drug))))
  dF_nucleatum_dt <- r_F_nucleatum * F_nucleatum * (1 - F_nucleatum / max(0.0001, K_F_nucleatum * (y_function_F_nucleatum_Amlodipine_func(Drug))))
  dL_paracasei_dt <- r_L_paracasei * L_paracasei * (1 - L_paracasei / K_L_paracasei)  
  dO_splanchnicus_dt <- r_O_splanchnicus * O_splanchnicus * (1 - O_splanchnicus / K_O_splanchnicus)  
  dP_copri_dt <- r_P_copri * P_copri * (1 - P_copri / K_P_copri)
  dP_distasonis_dt <- r_P_distasonis * P_distasonis * (1 - P_distasonis / K_P_distasonis)  
  dP_merdae_dt <- r_P_merdae * P_merdae * (1 - P_merdae / max(0.0001, K_P_merdae * (y_function_P_merdae_Amlodipine_func(Drug))))
  dR_bromii_dt <- r_R_bromii * R_bromii * (1 - R_bromii / K_R_bromii) 
  dR_gnavus_dt <- r_R_gnavus * R_gnavus * (1 - R_gnavus / max(0.0001, K_R_gnavus * (y_function_R_gnavus_Amlodipine_func(Drug))))
  dR_intestinalis_dt <- r_R_intestinalis * R_intestinalis * (1 - R_intestinalis / max(0.0001, K_R_intestinalis * (y_function_R_intestinalis_Amlodipine_func(Drug))))
  dR_torques_dt <- r_R_torques * R_torques * (1 - R_torques /K_R_torques) 
  dS_parasanguinis_dt <- r_S_parasanguinis * S_parasanguinis * (1 - S_parasanguinis / max(0.0001, K_S_parasanguinis * (y_function_S_parasanguinis_Amlodipine_func(Drug))))
  dS_salivarius_dt <- r_S_salivarius * S_salivarius * (1 - S_salivarius / max(0.0001, K_S_salivarius * (y_function_S_salivarius_Amlodipine_func(Drug))))
  dV_parvula_dt <- r_V_parvula * V_parvula * (1 - V_parvula / max(0.0001, K_V_parvula * (y_function_V_parvula_Amlodipine_func(Drug))))
  
  
  
  #Drug differential:
  dDrug_dt <- (subset(drug_dynamics, Drug == "Amlodipine")$Steepness_param_community * exp(-subset(drug_dynamics, Drug == "Amlodipine")$Steepness_param_community * t_mod)) * (drug_concentration_tested * prop_left_Amlodipine - drug_concentration_tested)
  #dDrug_dt <- 0
  
  ## Combine results into a single vector
  dxdt <- c(dA_muciniphila_dt, dB_adolescentis_dt, dB_fragilis_dt, dB_longum_dt, dB_obeum_dt, dB_thetaiotaomicron_dt, dB_uniformis_dt, dB_vulgatus_dt, dB_wadsworthia_dt, dC_aerofaciens_dt, dC_bolteae_dt, dC_comes_dt, dC_perfringens_dt, dC_ramosum_dt, dC_saccharolyticum_dt, dD_formicigenerans_dt, dE_coli_dt, dE_lenta_dt, dE_rectale_dt, dF_nucleatum_dt, dL_paracasei_dt, dO_splanchnicus_dt, dP_copri_dt, dP_distasonis_dt, dP_merdae_dt, dR_bromii_dt, dR_gnavus_dt, dR_intestinalis_dt, dR_torques_dt, dS_parasanguinis_dt, dS_salivarius_dt, dV_parvula_dt, dDrug_dt)
  
  ## Return result as a list
  list(dxdt)
}




#calculate the co-culture correction factor per species based on community composition in absence of drug, just like done for Niclosamide

growth_data_all_0_Niclosamide
growth_data_all_0_Niclosamide1 <- growth_data_all_0_Niclosamide %>%
  dplyr::mutate(Species = gsub(" ", "_", Species))


# Merge rel_ab_control with growth_data_all_0_Niclosamide on Species
# Function to remove duplicated columns by name pattern
clean_columns_base <- function(df, pattern) {
  cols_to_keep <- !grepl(pattern, names(df))
  df <- df[, cols_to_keep]
  return(df)
}

# Use the new function to clean up your dataframe
rel_ab_control <- clean_columns_base(rel_ab_control, "mean_max_OD.[xy]")
str(rel_ab_control)


#rel_ab_control$correction_factor <- rel_ab_control$mean_rel_ab / (rel_ab_control$mean_max_OD/sum(rel_ab_control$mean_max_OD))
# Calculate correction factor with a minimum value of ~1
rel_ab_control$correction_factor <- pmax(rel_ab_control$mean_rel_ab / (rel_ab_control$mean_max_OD / sum(rel_ab_control$mean_max_OD)), 1.1)


# Create a new dataframe for co-culture correction
co_culture_correction <- data.frame(
  species = rel_ab_control$Species,
  correction_factor = rel_ab_control$correction_factor
)


#summarise community data
#Adjust based on tested concentrations for each drug
unique(Community_compositions_focus_drugs_Amlodipine$concentration)

Community_compositions_focus_drugs_Amlodipine_160uM <- subset(Community_compositions_focus_drugs_Amlodipine, concentration == 160)
Community_compositions_focus_drugs_Amlodipine_20uM <- subset(Community_compositions_focus_drugs_Amlodipine, concentration == 20)
Community_compositions_focus_drugs_Amlodipine_80uM <- subset(Community_compositions_focus_drugs_Amlodipine, concentration == 80)


#160 uM
Community_compositions_focus_drugs_Amlodipine_160uM_summarised <- Community_compositions_focus_drugs_Amlodipine_160uM %>%
  dplyr::group_by(species) %>%                                  
  dplyr::summarize(
    mean_rel_ab = mean(rel_abundance, na.rm = TRUE),     
    sd_rel_ab = sd(rel_abundance, na.rm = TRUE) ,
    mean_max_OD = mean(maxOD, na.rm = TRUE),
    sd_max_OD = sd(maxOD, na.rm = TRUE),
    mean_final_OD = mean(finalOD, na.rm = TRUE),
    sd_final_OD = sd(finalOD, na.rm = TRUE)
  ) %>%
  dplyr::ungroup() 


Community_compositions_focus_drugs_Amlodipine_160uM_summarised <- Community_compositions_focus_drugs_Amlodipine_160uM_summarised %>%
  dplyr::mutate(Species = sub("^(\\w)\\w*\\s(.*)", "\\1._\\2", species))

#remove (sub)strain info
Community_compositions_focus_drugs_Amlodipine_160uM_summarised <- Community_compositions_focus_drugs_Amlodipine_160uM_summarised %>%
  dplyr::mutate(Species = sub("^(\\w\\._\\w+).*", "\\1", Species))


#20 uM
Community_compositions_focus_drugs_Amlodipine_20uM_summarised <- Community_compositions_focus_drugs_Amlodipine_20uM %>%
  dplyr::group_by(species) %>%                                  
  dplyr::summarize(
    mean_rel_ab = mean(rel_abundance, na.rm = TRUE),     
    sd_rel_ab = sd(rel_abundance, na.rm = TRUE) ,
    mean_max_OD = mean(maxOD, na.rm = TRUE),
    sd_max_OD = sd(maxOD, na.rm = TRUE),
    mean_final_OD = mean(finalOD, na.rm = TRUE),
    sd_final_OD = sd(finalOD, na.rm = TRUE)
  ) %>%
  dplyr::ungroup() 


Community_compositions_focus_drugs_Amlodipine_20uM_summarised <- Community_compositions_focus_drugs_Amlodipine_20uM_summarised %>%
  dplyr::mutate(Species = sub("^(\\w)\\w*\\s(.*)", "\\1._\\2", species))

#remove (sub)strain info
Community_compositions_focus_drugs_Amlodipine_20uM_summarised <- Community_compositions_focus_drugs_Amlodipine_20uM_summarised %>%
  dplyr::mutate(Species = sub("^(\\w\\._\\w+).*", "\\1", Species))


#80 uM
Community_compositions_focus_drugs_Amlodipine_80uM_summarised <- Community_compositions_focus_drugs_Amlodipine_80uM %>%
  dplyr::group_by(species) %>%                                  
  dplyr::summarize(
    mean_rel_ab = mean(rel_abundance, na.rm = TRUE),     
    sd_rel_ab = sd(rel_abundance, na.rm = TRUE) ,
    mean_max_OD = mean(maxOD, na.rm = TRUE),
    sd_max_OD = sd(maxOD, na.rm = TRUE),    
    mean_final_OD = mean(finalOD, na.rm = TRUE),
    sd_final_OD = sd(finalOD, na.rm = TRUE)
  ) %>%
  dplyr::ungroup() 



Community_compositions_focus_drugs_Amlodipine_80uM_summarised <- Community_compositions_focus_drugs_Amlodipine_80uM_summarised %>%
  dplyr::mutate(Species = sub("^(\\w)\\w*\\s(.*)", "\\1._\\2", species))

#remove (sub)strain info
Community_compositions_focus_drugs_Amlodipine_80uM_summarised <- Community_compositions_focus_drugs_Amlodipine_80uM_summarised %>%
  dplyr::mutate(Species = sub("^(\\w\\._\\w+).*", "\\1", Species))


#Initialise data frames
sim_output <- data.frame()
input_params_list <- list() #Use a list to collect parameters for each simulation

#number of simulations
num_sims <- 250


for (i in 1:num_sims) {
  tryCatch({
    # generate model parameters
    set.seed(i) #set a different seed for each simulation for variation
    params <- lapply(1:nrow(growth_data_all_0_Niclosamide), function(idx) {
      species_params <- growth_data_all_0_Niclosamide[idx, ]
      list(
        r = rnorm(1, mean = species_params$mean_max_Growth_rate, sd = species_params$sd_max_Growth_rate),
        K = rnorm(1, mean = species_params$mean_max_OD, sd = species_params$sd_max_OD)
      )
    })
    names(params) <- gsub(" ", "_", growth_data_all_0_Niclosamide$Species)
    flat_params <- unlist(params)
    names(flat_params) <- gsub("\\.\\d$", "", names(flat_params))
    
    #replace spaces with underscores to match formatting
    co_culture_correction$species <- gsub(" ", "_", co_culture_correction$species, fixed = TRUE)
    
    #replace the species-specific K parameters extracted from monoculture growth data 
    #with drawn relative abundance values at Niclosamide = 0, scaled to K
    rel_ab_control$Species <- gsub(" ", "_", rel_ab_control$Species)
    
    #Initialise an empty vector to store drawn values
    drawn_values <- numeric(nrow(rel_ab_control))
    
    #draw values from their respective distributions
    for (k in 1:nrow(rel_ab_control)) {
      species_name <- rel_ab_control$Species[k]
      drawn_value <- rnorm(1, mean = rel_ab_control$mean_rel_ab[k], sd = rel_ab_control$sd_rel_ab[k])
      drawn_values[k] <- max(drawn_value, 0)  # Ensure no negative values
    }
    
    #Normalise drawn relative abundance values so they sum to 1 (to reflect a 'true' relative abundance distribution)
    #this is needed so when we convert the values into OD units by multiplying with the drawn community maxOD,
    # the sum of K_i parameters and the drawn K are equal
    normalised_values <- drawn_values / sum(drawn_values)
    
    #Pull community maxOD (K) at 0 drugs from respective normal distribution:
    K <- rnorm(n = 1, mean = rel_ab_control$mean_com_max_OD[1], sd = rel_ab_control$sd_com_max_OD[1])
    
    # Assign these normalised values to their respective species' .K parameters
    for (k in 1:nrow(rel_ab_control)) {
      species_name <- rel_ab_control$Species[k]
      k_index <- grep(paste0("^", species_name, "\\.K$"), names(flat_params))
      
      if (length(k_index) > 0) {
        old_value <- flat_params[k_index]
        flat_params[k_index] <- (normalised_values[k] + 0.0001) * K #add small value in case drawn K_i is 0, which would cause issues with the solver
        cat(sprintf("Updated %s from %f to %f using normalised value %f scaled by K %f\n", names(flat_params)[k_index], old_value, flat_params[k_index], normalised_values[k], K))
      }
    }
    
    #Accounting for variation in drug degradation by community, with standard deviation of end concentration (at 10h) around the fitted predicted (relative) end concentration at 24h
    #prop_left_Amlodipine <- abs(rnorm(1, (subset(drug_dynamics, Drug == "Amlodipine")$Prop_left_24h_community), (subset(drug_dynamics, Drug == "Amlodipine")$SD_drug_community))) 
    #below, we account for measurement error rather than ecological drivers that lead to the variability of degradation at the final point measured 
    prop_left_Amlodipine <- abs(rnorm(
      n = 1, 
      mean = subset(drug_dynamics, Drug == "Amlodipine")$Prop_left_24h_community, 
      sd = ifelse(
        subset(drug_dynamics, Drug == "Amlodipine")$SD_drug_community > subset(drug_dynamics, Drug == "Amlodipine")$SD_drug_community_start, 
        subset(drug_dynamics, Drug == "Amlodipine")$SD_drug_community - subset(drug_dynamics, Drug == "Amlodipine")$SD_drug_community_start, 
        subset(drug_dynamics, Drug == "Amlodipine")$SD_drug_community
      )
    ))
    
    
    #loop through each species in co_culture_correction
    for (j in 1:nrow(co_culture_correction)) {
      # Extract the species name and correction factor
      species_name <- co_culture_correction$species[j]
      correction_factor <- co_culture_correction$correction_factor[j]
      
      # Identify the corresponding growth rate parameter in flat_params
      #by matching the base species name (without .r)
      growth_rate_indices <- grep(paste0("^", species_name, "\\.r$"), names(flat_params))
      
      #take the growth rate parameter and apply the correction factor 
      for (index in growth_rate_indices) {
        flat_params[index] <- flat_params[index] * correction_factor
      }
    }
    
    flat_params
    # Store parameters for each simulation
    input_params_list[[i]] <- c(sim_ID = i, flat_params)
    
    # Run the model for the first 24-hour cycle
    solution_cycle_1 <- ode(y = initial_conditions, times = seq(from = 0, to = 24, by = 0.1), func = closed.sir.model_Amlodipine, parms = flat_params,   method = "lsoda", rtol = 1e-6, atol = 1e-6)
    
    # Dilution and second cycle
    end_of_cycle_1 <- solution_cycle_1[nrow(solution_cycle_1), -1]
    initial_conditions_cycle_2 <- end_of_cycle_1 / 50
    #accounting for the drugs being added with the new growth cycle as well:
    initial_conditions_cycle_2[33] <- initial_conditions_cycle_2[33] + drug_concentration_tested
    solution_cycle_2 <- ode(y = initial_conditions_cycle_2, times = seq(from = 24, to = 48, by = 0.1), func = closed.sir.model_Amlodipine, parms = flat_params,  method = "lsoda", rtol = 1e-6, atol = 1e-6)
    
    # Combine and format results
    combined_solution <- rbind(as.data.frame(solution_cycle_1), as.data.frame(solution_cycle_2)[-1,])
    combined_solution$sim_ID <- rep(i, nrow(combined_solution))
    combined_solution <- combined_solution %>%
      tidyr::gather(key = "Species", value = "Density", -time, -sim_ID) %>%
      dplyr::mutate(Hour = time) %>%
      dplyr::select(sim_ID, Hour, Species, Density)
    
    ##Append to sim_output
    sim_output <- rbind(sim_output, combined_solution)
  }, error = function(e) {
    cat(sprintf("Skipping simulation %d due to an error: %s\n", i, e$message))
  })
}



##Combine all parameter data into a single dataframe
input_params <- do.call(rbind, input_params_list)

# Add a "Species" column 
sim_output$Species_name <- species_names[as.numeric(as.character(sim_output$Species))]
sim_output$Species_name <- replace_na(sim_output$Species_name, "Drug")

#View(input_params)
#View(sim_output)

sim_output <- na.omit(sim_output)
successful_sim_ids <- unique(subset(sim_output, Hour == 48)$sim_ID)
length(successful_sim_ids)
sim_output1 <- sim_output[sim_output$sim_ID %in% successful_sim_ids, ]


#Transform sim_output so we have wide format by Species
sim_output_wide <- tidyr::pivot_wider(sim_output1, 
                                      names_from = Species_name, 
                                      values_from = Density,
                                      id_cols = c(sim_ID, Hour))

length(unique(sim_output_wide$sim_ID))
#calc community OD per timepoint
sim_output_wide$Total_OD <- rowSums(sim_output_wide[, 3:34], na.rm = TRUE)
#calculate and add relative abundances here as well:
species_columns <- colnames(sim_output_wide)[3:34] 

for (species in species_columns) {
  sim_output_wide[[paste0("rel_", species)]] <- sim_output_wide[[species]] / sim_output_wide$Total_OD
}


#assign sim_output_wide test conditions to dataframe name
drug_tested <- "Amlodipine"
variable_name_1 <- paste0("sim_output_wide_", ifelse(drug_concentration_tested == 1e-04, 0, drug_concentration_tested), "_", drug_tested)
assign(variable_name_1, sim_output_wide)

#turn back into long format if interested in plotting relative abundances
cols_needed <- c("sim_ID", "Hour")

sim_output_long <- sim_output_wide %>% 
  dplyr::select(sim_ID, Hour, Drug, starts_with("rel_")) %>% 
  tidyr::pivot_longer(
    cols = c(Drug, starts_with("rel_")),
    names_to = "Species", 
    values_to = "Relative_abundance",
    names_prefix = "rel_",
    names_transform = list(Species = ~ ifelse(.x == "Drug", "Drug", .x))
  ) 

str(sim_output_long)


species_names_1 <- c(
  "A_muciniphila",
  "B_adolescentis",
  "B_fragilis",
  "B_longum",
  "B_obeum",
  "B_thetaiotaomicron",
  "B_uniformis",
  "B_vulgatus",
  "B_wadsworthia",
  "C_aerofaciens",
  "C_bolteae",
  "C_comes",
  "C_perfringens",
  "C_ramosum",
  "C_saccharolyticum",
  "D_formicigenerans",
  "E_coli",
  "E_lenta",
  "E_rectale",
  "F_nucleatum",
  "L_paracasei",
  "O_splanchnicus",
  "P_copri",
  "P_distasonis",
  "P_merdae",
  "R_bromii",
  "R_gnavus",
  "R_intestinalis",
  "R_torques",
  "S_parasanguinis",
  "S_salivarius",
  "V_parvula",
  "Drug"
)

species_colours_1 <- c(
  "A_muciniphila" = "#1f77b4",
  "B_adolescentis" = "#ff7f0e",
  "B_fragilis" = "#2ca02c",
  "B_longum" = "#d62728",
  "B_obeum" = "#9467bd",
  "B_thetaiotaomicron" = "black",
  "B_uniformis" = "#e377c2",
  "B_vulgatus" = "#7f7f7f",
  "B_wadsworthia" = "gold1",
  "C_aerofaciens" = "#aec7e8",
  "C_bolteae" = "#ffbb78",
  "C_comes" = "magenta",
  "C_perfringens" = "#ff9896",
  "C_ramosum" = "#c5b0d5",
  "C_saccharolyticum" = "#c49c94",
  "D_formicigenerans" = "#f7b6d2",
  "E_coli" = "yellow",
  "E_lenta" = "turquoise",
  "E_rectale" = "#393b79",
  "F_nucleatum" = "royalblue2",
  "L_paracasei" = "blue",
  "O_splanchnicus" = "#637939",
  "P_copri" = "cyan",
  "P_distasonis" = "#8c6d31",
  "P_merdae" = "#c7c7c7",
  "R_bromii" = "#e6550d",
  "R_gnavus" = "#e7cb94",
  "R_intestinalis" = "#843c39",
  "R_torques" = "#d6616b",
  "S_parasanguinis" = "orange3",
  "S_salivarius" = "#7b4173",
  "V_parvula" = "#ce6dbd",
  "Drug" = "green"
)



##Plot output for any specific sim:
# ggplot(subset(sim_output, sim_ID == 1 & Species_name != "Drug"), aes(x = Hour, y = Density, group = Species_name, color = Species_name)) +
#   geom_line(size = 1, alpha = 0.7) +
#   scale_color_manual(values = species_colours_1) +
#   labs(title = paste0("Amlodipine = ", drug_concentration_tested),
#        x = "Time (hours)",
#        y = "Population Density (OD)",
#        color = "Species") +
#   theme_minimal() +
#   theme(legend.position = "right")
# 
# ggplot(subset(sim_output, sim_ID == 3 & Species_name != "Drug"), aes(x = Hour, y = Density, group = Species_name, color = Species_name)) +
#   geom_line(size = 1, alpha = 0.7) +
#   scale_color_manual(values = species_colours_1) +
#   labs(title = paste0("Amlodipine = ", drug_concentration_tested),
#        x = "Time (hours)",
#        y = "Population Density (OD)",
#        color = "Species") +
#   theme_minimal() +
#   theme(legend.position = "right")


ggplot(subset(sim_output_long, sim_ID == 1), aes(x = Hour, y = Relative_abundance, group = Species, color = Species)) +
  geom_line(size = 1, alpha = 0.7) +
  scale_color_manual(values = species_colours_1) +
  labs(title = paste0("Amlodipine = ", drug_concentration_tested),
       x = "Time (hours)",
       y = "Relative abundance",
       color = "Species") +
  theme_minimal() +
  theme(legend.position = "right")


ggplot(subset(sim_output_long, sim_ID == 3), aes(x = Hour, y = Relative_abundance, group = Species, color = Species)) +
  geom_line(size = 1, alpha = 0.7) +
  scale_color_manual(values = species_colours_1) +
  labs(title = paste0("Amlodipine = ", drug_concentration_tested),
       x = "Time (hours)",
       y = "Relative abundance",
       color = "Species") +
  theme_minimal() +
  theme(legend.position = "right")


#calc mean and standard deviation across sims
sim_stats <- sim_output_long %>%
  dplyr::group_by(Hour, Species) %>%
  dplyr::summarise(
    mean_rel_ab = mean(Relative_abundance),
    sd_rel_ab = sd(Relative_abundance),
    .groups = 'drop'
  )

# Prepare the data for plotting
plot_data <- sim_stats %>%
  dplyr::mutate(Upper = mean_rel_ab + sd_rel_ab, Lower = mean_rel_ab - sd_rel_ab)

ggplot(subset(plot_data, Species != "Drug"), aes(x = Hour, y = mean_rel_ab, group = Species, color = Species)) +
  geom_ribbon(aes(ymin = Lower, ymax = Upper, fill = Species), colour = NA, alpha = 0.2) +  
  geom_line(size = 1, alpha = 0.7) + 
  scale_color_manual(values = species_colours_1) +
  scale_fill_manual(values = species_colours_1) +  
  labs(title = "Mean and SD of Relative Abundance Across Simulations",
       subtitle = paste0("Amlodipine = ", drug_concentration_tested),       
       x = "Time (hours)",
       y = "Relative abundance",
       color = "Species",
       fill = "Species") +
  theme_minimal() +
  theme(legend.position = "right")

#log-scaled mean trends
ggplot(plot_data, aes(x = Hour, y = log10(mean_rel_ab + 0.0001), group = Species, color = Species)) +
  geom_line(size = 1, alpha = 0.7) +  # Mean line
  scale_color_manual(values = species_colours_1) +
  scale_fill_manual(values = species_colours_1) +  # Ensure consistent colors for lines and fills
  labs(title = "Mean and SD of Relative Abundance Across Simulations",
       subtitle = paste0("Amlodipine = ", drug_concentration_tested),
       x = "Time (hours)",
       y = "Relative abundance",
       color = "Species",
       fill = "Species") +
  theme_minimal() +
  theme(legend.position = "right")




##prediction quality evaluation
drug_tested <- "Amlodipine"
variable_name <- paste0("plot_data_", ifelse(drug_concentration_tested == 1e-04, 0, drug_concentration_tested), "_", drug_tested)
assign(variable_name, plot_data)


#extract total OD info:
predicted_mean_final_od_NULL <- Niclosamide_16S_0uM_summarised$mean_com_final_OD[1]
predicted_sd_final_od_NULL <- Niclosamide_16S_0uM_summarised$sd_com_final_OD[1]

predicted_mean_final_od_160_Amlodipine <- mean(subset(sim_output_wide_160_Amlodipine, Hour == 48)$Total_OD, na.rm = TRUE)
predicted_sd_final_od_160_Amlodipine <- sd(subset(sim_output_wide_160_Amlodipine, Hour == 48)$Total_OD, na.rm = TRUE)

real_mean_final_od_160_Amlodipine <- Community_compositions_focus_drugs_Amlodipine_160uM_summarised$mean_final_OD[1]
real_sd_final_od_160_Amlodipine <- Community_compositions_focus_drugs_Amlodipine_160uM_summarised$sd_final_OD[1]


predicted_mean_final_od_20_Amlodipine <- mean(subset(sim_output_wide_20_Amlodipine, Hour == 48)$Total_OD, na.rm = TRUE)
predicted_sd_final_od_20_Amlodipine <- sd(subset(sim_output_wide_20_Amlodipine, Hour == 48)$Total_OD, na.rm = TRUE)

real_mean_final_od_20_Amlodipine <- Community_compositions_focus_drugs_Amlodipine_20uM_summarised$mean_final_OD[1]
real_sd_final_od_20_Amlodipine <- Community_compositions_focus_drugs_Amlodipine_20uM_summarised$sd_final_OD[1]


predicted_mean_final_od_80_Amlodipine <- mean(subset(sim_output_wide_80_Amlodipine, Hour == 48)$Total_OD, na.rm = TRUE)
predicted_sd_final_od_80_Amlodipine <- sd(subset(sim_output_wide_80_Amlodipine, Hour == 48)$Total_OD, na.rm = TRUE)

real_mean_final_od_80_Amlodipine <- Community_compositions_focus_drugs_Amlodipine_80uM_summarised$mean_final_OD[1]
real_sd_final_od_80_Amlodipine <- Community_compositions_focus_drugs_Amlodipine_80uM_summarised$sd_final_OD[1]




#plot_data_0_Amlodipine_endpoint was used to test model performance at 0 drugs
#plot_data_0_Amlodipine_endpoint <- subset(plot_data_0_Amlodipine, Hour == 48 & Species != "Drug")
plot_data_160_Amlodipine_endpoint <- subset(plot_data_160_Amlodipine, Hour == 48 & Species != "Drug")
plot_data_20_Amlodipine_endpoint <- subset(plot_data_20_Amlodipine, Hour == 48 & Species != "Drug")
plot_data_80_Amlodipine_endpoint <- subset(plot_data_80_Amlodipine, Hour == 48 & Species != "Drug")

##Inspecting 'match' to real relative abundance distributions:
Niclosamide_16S_0uM_summarised <- rel_ab_control
Niclosamide_16S_0uM_summarised$Species <- gsub("\\.", "", Niclosamide_16S_0uM_summarised$Species)

Amlodipine_16S_160uM_summarised <- Community_compositions_focus_drugs_Amlodipine_160uM_summarised
Amlodipine_16S_20uM_summarised <- Community_compositions_focus_drugs_Amlodipine_20uM_summarised
Amlodipine_16S_80uM_summarised <- Community_compositions_focus_drugs_Amlodipine_80uM_summarised

Niclosamide_16S_0uM_summarised
Amlodipine_16S_160uM_summarised 
Amlodipine_16S_20uM_summarised 
Amlodipine_16S_80uM_summarised 

#Rename 'species' so the outputs become comparable
original_names_80 <- unique(Amlodipine_16S_80uM_summarised$species)
original_names_20 <- unique(Amlodipine_16S_20uM_summarised$species)
original_names_160 <- unique(Amlodipine_16S_160uM_summarised$species)


##Create a named vector with the original and new names mapping
name_changes <- c(
  "Akkermansia muciniphila" = "A_muciniphila",
  "Bacteroides fragilis" = "B_fragilis",
  "Bacteroides thetaiotaomicron" = "B_thetaiotaomicron",
  "Bacteroides uniformis" = "B_uniformis",
  "Bifidobacterium adolescentis" = "B_adolescentis",
  "Bifidobacterium longum subsp. longum" = "B_longum",
  "Bilophila wadsworthia" = "B_wadsworthia",
  "Blautia obeum" = "B_obeum",
  "Clostridium perfringens" = "C_perfringens",
  "Collinsella aerofaciens" = "C_aerofaciens",
  "Coprococcus comes" = "C_comes",
  "Dorea formicigenerans" = "D_formicigenerans",
  "Eggerthella lenta" = "E_lenta",
  "Enterocloster bolteae" = "C_bolteae",
  "Erysipelatoclostridium ramosum" = "C_ramosum",
  "Escherichia coli ED1a" = "E_coli",
  "Eubacterium rectale" = "E_rectale",
  "Fusobacterium nucleatum subsp. nucleatum" = "F_nucleatum",
  "Lacrimispora saccharolytica" = "C_saccharolyticum",
  "Lacticaseibacillus paracasei" = "L_paracasei",
  "Odoribacter splanchnicus" = "O_splanchnicus",
  "Parabacteroides distasonis" = "P_distasonis",
  "Parabacteroides merdae" = "P_merdae",
  "Phocaeicola vulgatus" = "B_vulgatus",
  "Prevotella copri" = "P_copri",
  "Roseburia intestinalis" = "R_intestinalis",
  "Ruminococcus bromii" = "R_bromii",
  "Ruminococcus gnavus" = "R_gnavus",
  "Ruminococcus torques" = "R_torques",
  "Streptococcus parasanguinis" = "S_parasanguinis",
  "Streptococcus salivarius" = "S_salivarius",
  "Veillonella parvula" = "V_parvula"
)

# Apply name changes to the species column in Amlodipine_16S_80uM_summarised

Amlodipine_16S_80uM_summarised$Species <- name_changes[Amlodipine_16S_80uM_summarised$species]
Amlodipine_16S_20uM_summarised$Species <- name_changes[Amlodipine_16S_20uM_summarised$species]
Amlodipine_16S_160uM_summarised$Species <- name_changes[Amlodipine_16S_160uM_summarised$species]

# Verify the changes
unique(Amlodipine_16S_80uM_summarised$Species)
unique(Amlodipine_16S_20uM_summarised$Species)
unique(Amlodipine_16S_160uM_summarised$Species)



##First, for 160 uM:
# Get top 6 species from plot_data_160_endpoint
# Adjust the plot_data_160_endpoint with confidence bounds

# #plot_data_0_Amlodipine_endpoint was used to test model performance at 0 drugs
# plot_data_0_Amlodipine_endpoint <- plot_data_0_Amlodipine_endpoint %>%
#   dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)

plot_data_160_Amlodipine_endpoint <- plot_data_160_Amlodipine_endpoint %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)

# Adjust the Amlodipine_16S_160uM_summarised with confidence bounds
Amlodipine_16S_160uM_summarised <- Amlodipine_16S_160uM_summarised %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)

#NULL model:
Null_model_summarised <- Niclosamide_16S_0uM_summarised %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)


# Get top 6 species based on the lower bound from plot_data_160_endpoint

#top6_predicted_0_Amlodipine was used to test model performance at 0 drugs
# top6_predicted_0_Amlodipine <- plot_data_0_Amlodipine_endpoint %>%
#    arrange(desc(lower_bound)) %>%
#    slice(1:6) %>%
#    pull(Species)

top6_predicted_160_Amlodipine <- plot_data_160_Amlodipine_endpoint %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

# Get top 6 species based on the lower bound from Amlodipine_16S_160uM_summarised
top6_real_160_Amlodipine <- Amlodipine_16S_160uM_summarised %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

top6_NULL <- Null_model_summarised %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

# Calculate the overlap of top 6 species

#top_six_correct_0_Amlodipine was used to assess model performance at 0 drugs
# top_six_correct_0_Amlodipine <- length(intersect(top6_predicted_0_Amlodipine, top6_NULL))
# top_six_correct_0_Amlodipine

top_six_correct_160_Amlodipine <- length(intersect(top6_predicted_160_Amlodipine, top6_real_160_Amlodipine))
top_six_correct_160_Amlodipine

top_six_correct_160_Amlodipine_NULL <- length(intersect(top6_NULL, top6_real_160_Amlodipine))
top_six_correct_160_Amlodipine_NULL

top6_predicted_160_Amlodipine
top6_real_160_Amlodipine

#top6_NULL

#Now by means:
# #top6_predicted_0_Amlodipine_means was used to assess model performance at 0 drugs
# top6_predicted_0_Amlodipine_means <- plot_data_0_Amlodipine_endpoint %>%
#    arrange(desc(mean_rel_ab)) %>%
#    slice(1:6) %>%
#    pull(Species)

top6_predicted_160_Amlodipine_means <- plot_data_160_Amlodipine_endpoint %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)

# Get top 6 species based on the lower bound from Amlodipine_16S_160uM_summarised
top6_real_160_Amlodipine_means <- Amlodipine_16S_160uM_summarised %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)

top6_NULL_means <- Null_model_summarised %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)


# #top_six_correct_0_Amlodipine_means was used to assess model performance at 0 drugs
# top_six_correct_0_Amlodipine_means <- length(intersect(top6_predicted_0_Amlodipine_means, top6_NULL_means))
# top_six_correct_0_Amlodipine_means

top_six_correct_160_Amlodipine_means <- length(intersect(top6_predicted_160_Amlodipine_means, top6_real_160_Amlodipine_means))
top_six_correct_160_Amlodipine_means

top_six_correct_160_Amlodipine_means_NULL <- length(intersect(top6_NULL_means, top6_real_160_Amlodipine_means))
top_six_correct_160_Amlodipine_means_NULL

top6_predicted_160_Amlodipine_means
top6_real_160_Amlodipine_means

#top6_NULL_means


# Merge dataframes by Species

#merged_data_0_Amlodipine was used to assess model performance at 0 drugs
#merged_data_0_Amlodipine <- merge(plot_data_0_Amlodipine_endpoint, Niclosamide_16S_0uM_summarised, by = "Species", suffixes = c(".pred", ".real"))
merged_data_160_Amlodipine <- merge(plot_data_160_Amlodipine_endpoint, Amlodipine_16S_160uM_summarised, by = "Species", suffixes = c(".pred", ".real"))
merged_data_160_Amlodipine_NULL <- merge(Niclosamide_16S_0uM_summarised, Amlodipine_16S_160uM_summarised, by = "Species", suffixes = c(".null", ".real"))


## Below lines used for assessing model performance at 0 drugs; ignore for nonzero concentrations
# # Create lower and upper bounds considering mean ¬± sd
# merged_data_0_Amlodipine$lower_bound_pred <- merged_data_0_Amlodipine$mean_rel_ab.pred - merged_data_0_Amlodipine$sd_rel_ab.pred
# merged_data_0_Amlodipine$upper_bound_pred <- merged_data_0_Amlodipine$mean_rel_ab.pred + merged_data_0_Amlodipine$sd_rel_ab.pred
# merged_data_0_Amlodipine$lower_bound_real <- merged_data_0_Amlodipine$mean_rel_ab.real - merged_data_0_Amlodipine$sd_rel_ab.real
# merged_data_0_Amlodipine$upper_bound_real <- merged_data_0_Amlodipine$mean_rel_ab.real + merged_data_0_Amlodipine$sd_rel_ab.real
# 
# # Ensure lower and upper bounds are non-negative, adjusting as necessary
# merged_data_0_Amlodipine$lower_bound_pred[merged_data_0_Amlodipine$lower_bound_pred <= 0] <- 1e-10
# merged_data_0_Amlodipine$lower_bound_real[merged_data_0_Amlodipine$lower_bound_real <= 0] <- 1e-10
# merged_data_0_Amlodipine$upper_bound_pred[merged_data_0_Amlodipine$upper_bound_pred <= 0] <- 1e-10
# merged_data_0_Amlodipine$upper_bound_real[merged_data_0_Amlodipine$upper_bound_real <= 0] <- 1e-10


# Create lower and upper bounds considering mean ¬± sd
merged_data_160_Amlodipine$lower_bound_pred <- merged_data_160_Amlodipine$mean_rel_ab.pred - merged_data_160_Amlodipine$sd_rel_ab.pred
merged_data_160_Amlodipine$upper_bound_pred <- merged_data_160_Amlodipine$mean_rel_ab.pred + merged_data_160_Amlodipine$sd_rel_ab.pred
merged_data_160_Amlodipine$lower_bound_real <- merged_data_160_Amlodipine$mean_rel_ab.real - merged_data_160_Amlodipine$sd_rel_ab.real
merged_data_160_Amlodipine$upper_bound_real <- merged_data_160_Amlodipine$mean_rel_ab.real + merged_data_160_Amlodipine$sd_rel_ab.real

# Ensure lower and upper bounds are non-negative, adjusting as necessary
merged_data_160_Amlodipine$lower_bound_pred[merged_data_160_Amlodipine$lower_bound_pred <= 0] <- 1e-10
merged_data_160_Amlodipine$lower_bound_real[merged_data_160_Amlodipine$lower_bound_real <= 0] <- 1e-10
merged_data_160_Amlodipine$upper_bound_pred[merged_data_160_Amlodipine$upper_bound_pred <= 0] <- 1e-10
merged_data_160_Amlodipine$upper_bound_real[merged_data_160_Amlodipine$upper_bound_real <= 0] <- 1e-10

##and for NULL model:
# Create lower and upper bounds considering mean ¬± sd
merged_data_160_Amlodipine_NULL$lower_bound_null <- merged_data_160_Amlodipine_NULL$mean_rel_ab.null - merged_data_160_Amlodipine_NULL$sd_rel_ab.null
merged_data_160_Amlodipine_NULL$upper_bound_null <- merged_data_160_Amlodipine_NULL$mean_rel_ab.null + merged_data_160_Amlodipine_NULL$sd_rel_ab.null
merged_data_160_Amlodipine_NULL$lower_bound_real <- merged_data_160_Amlodipine_NULL$mean_rel_ab.real - merged_data_160_Amlodipine_NULL$sd_rel_ab.real
merged_data_160_Amlodipine_NULL$upper_bound_real <- merged_data_160_Amlodipine_NULL$mean_rel_ab.real + merged_data_160_Amlodipine_NULL$sd_rel_ab.real

# Ensure lower and upper bounds are non-negative, adjusting as necessary
merged_data_160_Amlodipine_NULL$lower_bound_null[merged_data_160_Amlodipine_NULL$lower_bound_null <= 0] <- 1e-10
merged_data_160_Amlodipine_NULL$lower_bound_real[merged_data_160_Amlodipine_NULL$lower_bound_real <= 0] <- 1e-10
merged_data_160_Amlodipine_NULL$upper_bound_null[merged_data_160_Amlodipine_NULL$upper_bound_null <= 0] <- 1e-10
merged_data_160_Amlodipine_NULL$upper_bound_real[merged_data_160_Amlodipine_NULL$upper_bound_real <= 0] <- 1e-10

# Filter to include only species with a mean relative abundance > 0.01 in the 'real' dataset

## significant_species_0 was used to assess model performance at 0 drugs
#significant_species_0 <- merged_data_0_Amlodipine[merged_data_0_Amlodipine$mean_rel_ab.real > 0.01, ]
significant_species <- merged_data_160_Amlodipine[merged_data_160_Amlodipine$mean_rel_ab.real > 0.01, ]
survivors_160_Amlodipine <- nrow(significant_species)
survivors_160_Amlodipine

#should be the same as survivors defined above, since it is calculated from .real
significant_species_NULL <- merged_data_160_Amlodipine_NULL[merged_data_160_Amlodipine_NULL$mean_rel_ab.real > 0.01, ]
survivors_160_Amlodipine_NULL <- nrow(significant_species_NULL)
survivors_160_Amlodipine_NULL

# Adjusted order of magnitude check to include SD, only for significant species
## below code was used to assess model performance at 0 drugs
# significant_species_0$Predicted_magnitude_correct <- ifelse(
#   (floor(log10(significant_species_0$lower_bound_pred)) <= floor(log10(significant_species_0$upper_bound_real)) &
#      floor(log10(significant_species_0$upper_bound_pred)) >= floor(log10(significant_species_0$lower_bound_real))),
#   1,
#   0
# )

significant_species$Predicted_magnitude_correct <- ifelse(
  (floor(log10(significant_species$lower_bound_pred)) <= floor(log10(significant_species$upper_bound_real)) &
     floor(log10(significant_species$upper_bound_pred)) >= floor(log10(significant_species$lower_bound_real))),
  1,
  0
)

#and for the Null model:
significant_species_NULL$Predicted_magnitude_correct <- ifelse(
  (floor(log10(significant_species_NULL$lower_bound_null)) <= floor(log10(significant_species_NULL$upper_bound_real)) &
     floor(log10(significant_species_NULL$upper_bound_null)) >= floor(log10(significant_species_NULL$lower_bound_real))),
  1,
  0
)

# Calculate the fraction of correctly predicted magnitudes for significant species
## below code was used to assess model performance at 0 drugs
#predicted_magnitude_correct_fraction_0_Amlodipine <- sum(significant_species_0$Predicted_magnitude_correct) / nrow(significant_species_0)
#predicted_magnitude_correct_fraction_0_Amlodipine

predicted_magnitude_correct_fraction_160_Amlodipine <- sum(significant_species$Predicted_magnitude_correct) / nrow(significant_species)
predicted_magnitude_correct_fraction_160_Amlodipine

predicted_magnitude_correct_fraction_160_Amlodipine_NULL <- sum(significant_species_NULL$Predicted_magnitude_correct) / nrow(significant_species_NULL)
predicted_magnitude_correct_fraction_160_Amlodipine_NULL

top_species_missing_160_Amlodipine <- setdiff(top6_real_160_Amlodipine_means, top6_predicted_160_Amlodipine_means)
top_species_wrong_160_Amlodipine <- setdiff(top6_predicted_160_Amlodipine_means, top6_real_160_Amlodipine_means)


Prediction_quality_160_Amlodipine <- data.frame(
  Top_six_correct = paste(top_six_correct_160_Amlodipine, sep=""),
  Top_six_correct_NULL = paste(top_six_correct_160_Amlodipine_NULL, sep=""),
  Top_six_correct_means = paste(top_six_correct_160_Amlodipine_means, sep=""),
  Top_six_correct_means_NULL = paste(top_six_correct_160_Amlodipine_means_NULL, sep=""),
  Predicted_magnitude_correct = paste(round(predicted_magnitude_correct_fraction_160_Amlodipine * 100, 2), "%", sep=""),
  Predicted_magnitude_correct_NULL = paste(round(predicted_magnitude_correct_fraction_160_Amlodipine_NULL * 100, 2), "%", sep=""),
  survivors_total = survivors_160_Amlodipine,
  top_species_missing <- top_species_missing_160_Amlodipine,
  top_species_wrong <- top_species_wrong_160_Amlodipine, 
  predicted_mean_final_OD <- predicted_mean_final_od_160_Amlodipine,
  real_mean_final_OD <- real_mean_final_od_160_Amlodipine,
  sims_total = length(successful_sim_ids)
)



Prediction_quality_160_Amlodipine



##Next, for 20 uM:
# Get top 6 species from plot_data_20_endpoint
# Adjust the plot_data_20_endpoint with confidence bounds
plot_data_20_Amlodipine_endpoint <- plot_data_20_Amlodipine_endpoint %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)

# Adjust the Amlodipine_16S_20uM_summarised with confidence bounds
Amlodipine_16S_20uM_summarised <- Amlodipine_16S_20uM_summarised %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)

#NULL model:
Null_model_summarised <- Niclosamide_16S_0uM_summarised %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)


# Get top 6 species based on the lower bound from plot_data_20_endpoint
top6_predicted_20_Amlodipine <- plot_data_20_Amlodipine_endpoint %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

# Get top 6 species based on the lower bound from Amlodipine_16S_20uM_summarised
top6_real_20_Amlodipine <- Amlodipine_16S_20uM_summarised %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

top6_NULL <- Null_model_summarised %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

# Calculate the overlap of top 6 species
top_six_correct_20_Amlodipine <- length(intersect(top6_predicted_20_Amlodipine, top6_real_20_Amlodipine))
#top_six_correct_20_Amlodipine

top_six_correct_20_Amlodipine_NULL <- length(intersect(top6_NULL, top6_real_20_Amlodipine))
#top_six_correct_20_Amlodipine_NULL

#top6_predicted_20_Amlodipine
#top6_real_20_Amlodipine



#Now by means:
top6_predicted_20_Amlodipine_means <- plot_data_20_Amlodipine_endpoint %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)

# Get top 6 species based on the lower bound from Amlodipine_16S_20uM_summarised
top6_real_20_Amlodipine_means <- Amlodipine_16S_20uM_summarised %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)

top6_NULL_means <- Null_model_summarised %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)



top_six_correct_20_Amlodipine_means <- length(intersect(top6_predicted_20_Amlodipine_means, top6_real_20_Amlodipine_means))
#top_six_correct_20_Amlodipine_means

top_six_correct_20_Amlodipine_means_NULL <- length(intersect(top6_NULL_means, top6_real_20_Amlodipine_means))
#top_six_correct_20_Amlodipine_means_NULL

top6_predicted_20_Amlodipine_means
#top6_real_20_Amlodipine_means




# Merge dataframes by Species
merged_data_20_Amlodipine <- merge(plot_data_20_Amlodipine_endpoint, Amlodipine_16S_20uM_summarised, by = "Species", suffixes = c(".pred", ".real"))
merged_data_20_Amlodipine_NULL <- merge(Niclosamide_16S_0uM_summarised, Amlodipine_16S_20uM_summarised, by = "Species", suffixes = c(".null", ".real"))



# Create lower and upper bounds considering mean ¬± sd
merged_data_20_Amlodipine$lower_bound_pred <- merged_data_20_Amlodipine$mean_rel_ab.pred - merged_data_20_Amlodipine$sd_rel_ab.pred
merged_data_20_Amlodipine$upper_bound_pred <- merged_data_20_Amlodipine$mean_rel_ab.pred + merged_data_20_Amlodipine$sd_rel_ab.pred
merged_data_20_Amlodipine$lower_bound_real <- merged_data_20_Amlodipine$mean_rel_ab.real - merged_data_20_Amlodipine$sd_rel_ab.real
merged_data_20_Amlodipine$upper_bound_real <- merged_data_20_Amlodipine$mean_rel_ab.real + merged_data_20_Amlodipine$sd_rel_ab.real

# Ensure lower and upper bounds are non-negative, adjusting as necessary
merged_data_20_Amlodipine$lower_bound_pred[merged_data_20_Amlodipine$lower_bound_pred <= 0] <- 1e-10
merged_data_20_Amlodipine$lower_bound_real[merged_data_20_Amlodipine$lower_bound_real <= 0] <- 1e-10
merged_data_20_Amlodipine$upper_bound_pred[merged_data_20_Amlodipine$upper_bound_pred <= 0] <- 1e-10
merged_data_20_Amlodipine$upper_bound_real[merged_data_20_Amlodipine$upper_bound_real <= 0] <- 1e-10

##and for NULL model:
# Create lower and upper bounds considering mean ¬± sd
merged_data_20_Amlodipine_NULL$lower_bound_null <- merged_data_20_Amlodipine_NULL$mean_rel_ab.null - merged_data_20_Amlodipine_NULL$sd_rel_ab.null
merged_data_20_Amlodipine_NULL$upper_bound_null <- merged_data_20_Amlodipine_NULL$mean_rel_ab.null + merged_data_20_Amlodipine_NULL$sd_rel_ab.null
merged_data_20_Amlodipine_NULL$lower_bound_real <- merged_data_20_Amlodipine_NULL$mean_rel_ab.real - merged_data_20_Amlodipine_NULL$sd_rel_ab.real
merged_data_20_Amlodipine_NULL$upper_bound_real <- merged_data_20_Amlodipine_NULL$mean_rel_ab.real + merged_data_20_Amlodipine_NULL$sd_rel_ab.real

# Ensure lower and upper bounds are non-negative, adjusting as necessary
merged_data_20_Amlodipine_NULL$lower_bound_null[merged_data_20_Amlodipine_NULL$lower_bound_null <= 0] <- 1e-10
merged_data_20_Amlodipine_NULL$lower_bound_real[merged_data_20_Amlodipine_NULL$lower_bound_real <= 0] <- 1e-10
merged_data_20_Amlodipine_NULL$upper_bound_null[merged_data_20_Amlodipine_NULL$upper_bound_null <= 0] <- 1e-10
merged_data_20_Amlodipine_NULL$upper_bound_real[merged_data_20_Amlodipine_NULL$upper_bound_real <= 0] <- 1e-10

# Filter to include only species with a mean relative abundance > 0.01 in the 'real' dataset
significant_species <- merged_data_20_Amlodipine[merged_data_20_Amlodipine$mean_rel_ab.real > 0.01, ]
survivors_20_Amlodipine <- nrow(significant_species)
survivors_20_Amlodipine

#should be the same as survivors defined above, since it is calculated from .real
significant_species_NULL <- merged_data_20_Amlodipine_NULL[merged_data_20_Amlodipine_NULL$mean_rel_ab.real > 0.01, ]
survivors_20_Amlodipine_NULL <- nrow(significant_species_NULL)
survivors_20_Amlodipine_NULL

# Adjusted order of magnitude check to include SD, only for significant species
significant_species$Predicted_magnitude_correct <- ifelse(
  (floor(log10(significant_species$lower_bound_pred)) <= floor(log10(significant_species$upper_bound_real)) &
     floor(log10(significant_species$upper_bound_pred)) >= floor(log10(significant_species$lower_bound_real))),
  1,
  0
)

#and for the Null model:
significant_species_NULL$Predicted_magnitude_correct <- ifelse(
  (floor(log10(significant_species_NULL$lower_bound_null)) <= floor(log10(significant_species_NULL$upper_bound_real)) &
     floor(log10(significant_species_NULL$upper_bound_null)) >= floor(log10(significant_species_NULL$lower_bound_real))),
  1,
  0
)

# Calculate the fraction of correctly predicted magnitudes for significant species
predicted_magnitude_correct_fraction_20_Amlodipine <- sum(significant_species$Predicted_magnitude_correct) / nrow(significant_species)
predicted_magnitude_correct_fraction_20_Amlodipine

predicted_magnitude_correct_fraction_20_Amlodipine_NULL <- sum(significant_species_NULL$Predicted_magnitude_correct) / nrow(significant_species_NULL)
predicted_magnitude_correct_fraction_20_Amlodipine_NULL

top_species_missing_20_Amlodipine <- setdiff(top6_real_20_Amlodipine_means, top6_predicted_20_Amlodipine_means)
top_species_wrong_20_Amlodipine <- setdiff(top6_predicted_20_Amlodipine_means, top6_real_20_Amlodipine_means)

top_species_missing_20_Amlodipine <- if(length(top_species_missing_20_Amlodipine) == 0) "None" else top_species_missing_20_Amlodipine
top_species_wrong_20_Amlodipine <- if(length(top_species_wrong_20_Amlodipine) == 0) "None" else top_species_wrong_20_Amlodipine



Prediction_quality_20_Amlodipine <- data.frame(
  Top_six_correct = paste(top_six_correct_20_Amlodipine, sep=""),
  Top_six_correct_NULL = paste(top_six_correct_20_Amlodipine_NULL, sep=""),
  Top_six_correct_means = paste(top_six_correct_20_Amlodipine_means, sep=""),
  Top_six_correct_means_NULL = paste(top_six_correct_20_Amlodipine_means_NULL, sep=""),
  Predicted_magnitude_correct = paste(round(predicted_magnitude_correct_fraction_20_Amlodipine * 100, 2), "%", sep=""),
  Predicted_magnitude_correct_NULL = paste(round(predicted_magnitude_correct_fraction_20_Amlodipine_NULL * 100, 2), "%", sep=""),
  survivors_total = survivors_20_Amlodipine,
  top_species_missing <- top_species_missing_20_Amlodipine,
  top_species_wrong <- top_species_wrong_20_Amlodipine, 
  predicted_mean_final_OD <- predicted_mean_final_od_20_Amlodipine,
  real_mean_final_OD <- real_mean_final_od_20_Amlodipine,
  sims_total = length(successful_sim_ids)
)

Prediction_quality_20_Amlodipine






##Next, for 80 uM:
# Get top 6 species from plot_data_80_endpoint
# Adjust the plot_data_80_endpoint with confidence bounds
plot_data_80_Amlodipine_endpoint <- plot_data_80_Amlodipine_endpoint %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)

# Adjust the Amlodipine_16S_80uM_summarised with confidence bounds
Amlodipine_16S_80uM_summarised <- Amlodipine_16S_80uM_summarised %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)

#NULL model:
Null_model_summarised <- Niclosamide_16S_0uM_summarised %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)


# Get top 6 species based on the lower bound from plot_data_80_endpoint
top6_predicted_80_Amlodipine <- plot_data_80_Amlodipine_endpoint %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

# Get top 6 species based on the lower bound from Amlodipine_16S_80uM_summarised
top6_real_80_Amlodipine <- Amlodipine_16S_80uM_summarised %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

top6_NULL <- Null_model_summarised %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

# Calculate the overlap of top 6 species
top_six_correct_80_Amlodipine <- length(intersect(top6_predicted_80_Amlodipine, top6_real_80_Amlodipine))
#top_six_correct_80_Amlodipine

top_six_correct_80_Amlodipine_NULL <- length(intersect(top6_NULL, top6_real_80_Amlodipine))
#top_six_correct_80_Amlodipine_NULL

#top6_predicted_80_Amlodipine
#top6_real_80_Amlodipine




#Now by means:
top6_predicted_80_Amlodipine_means <- plot_data_80_Amlodipine_endpoint %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)

# Get top 6 species based on the lower bound from Amlodipine_16S_80uM_summarised
top6_real_80_Amlodipine_means <- Amlodipine_16S_80uM_summarised %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)

top6_NULL_means <- Null_model_summarised %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)



top_six_correct_80_Amlodipine_means <- length(intersect(top6_predicted_80_Amlodipine_means, top6_real_80_Amlodipine_means))
#top_six_correct_80_Amlodipine_means

top_six_correct_80_Amlodipine_means_NULL <- length(intersect(top6_NULL_means, top6_real_80_Amlodipine_means))
#top_six_correct_80_Amlodipine_means_NULL

#top6_predicted_80_Amlodipine_means
#top6_real_80_Amlodipine_means




# Merge dataframes by Species
merged_data_80_Amlodipine <- merge(plot_data_80_Amlodipine_endpoint, Amlodipine_16S_80uM_summarised, by = "Species", suffixes = c(".pred", ".real"))
merged_data_80_Amlodipine_NULL <- merge(Niclosamide_16S_0uM_summarised, Amlodipine_16S_80uM_summarised, by = "Species", suffixes = c(".null", ".real"))



# Create lower and upper bounds considering mean ¬± sd
merged_data_80_Amlodipine$lower_bound_pred <- merged_data_80_Amlodipine$mean_rel_ab.pred - merged_data_80_Amlodipine$sd_rel_ab.pred
merged_data_80_Amlodipine$upper_bound_pred <- merged_data_80_Amlodipine$mean_rel_ab.pred + merged_data_80_Amlodipine$sd_rel_ab.pred
merged_data_80_Amlodipine$lower_bound_real <- merged_data_80_Amlodipine$mean_rel_ab.real - merged_data_80_Amlodipine$sd_rel_ab.real
merged_data_80_Amlodipine$upper_bound_real <- merged_data_80_Amlodipine$mean_rel_ab.real + merged_data_80_Amlodipine$sd_rel_ab.real

# Ensure lower and upper bounds are non-negative, adjusting as necessary
merged_data_80_Amlodipine$lower_bound_pred[merged_data_80_Amlodipine$lower_bound_pred <= 0] <- 1e-10
merged_data_80_Amlodipine$lower_bound_real[merged_data_80_Amlodipine$lower_bound_real <= 0] <- 1e-10
merged_data_80_Amlodipine$upper_bound_pred[merged_data_80_Amlodipine$upper_bound_pred <= 0] <- 1e-10
merged_data_80_Amlodipine$upper_bound_real[merged_data_80_Amlodipine$upper_bound_real <= 0] <- 1e-10

##and for NULL model:
# Create lower and upper bounds considering mean ¬± sd
merged_data_80_Amlodipine_NULL$lower_bound_null <- merged_data_80_Amlodipine_NULL$mean_rel_ab.null - merged_data_80_Amlodipine_NULL$sd_rel_ab.null
merged_data_80_Amlodipine_NULL$upper_bound_null <- merged_data_80_Amlodipine_NULL$mean_rel_ab.null + merged_data_80_Amlodipine_NULL$sd_rel_ab.null
merged_data_80_Amlodipine_NULL$lower_bound_real <- merged_data_80_Amlodipine_NULL$mean_rel_ab.real - merged_data_80_Amlodipine_NULL$sd_rel_ab.real
merged_data_80_Amlodipine_NULL$upper_bound_real <- merged_data_80_Amlodipine_NULL$mean_rel_ab.real + merged_data_80_Amlodipine_NULL$sd_rel_ab.real

# Ensure lower and upper bounds are non-negative, adjusting as necessary
merged_data_80_Amlodipine_NULL$lower_bound_null[merged_data_80_Amlodipine_NULL$lower_bound_null <= 0] <- 1e-10
merged_data_80_Amlodipine_NULL$lower_bound_real[merged_data_80_Amlodipine_NULL$lower_bound_real <= 0] <- 1e-10
merged_data_80_Amlodipine_NULL$upper_bound_null[merged_data_80_Amlodipine_NULL$upper_bound_null <= 0] <- 1e-10
merged_data_80_Amlodipine_NULL$upper_bound_real[merged_data_80_Amlodipine_NULL$upper_bound_real <= 0] <- 1e-10

# Filter to include only species with a mean relative abundance > 0.01 in the 'real' dataset
significant_species <- merged_data_80_Amlodipine[merged_data_80_Amlodipine$mean_rel_ab.real > 0.01, ]
survivors_80_Amlodipine <- nrow(significant_species)
survivors_80_Amlodipine

#should be the same as survivors defined above, since it is calculated from .real
significant_species_NULL <- merged_data_80_Amlodipine_NULL[merged_data_80_Amlodipine_NULL$mean_rel_ab.real > 0.01, ]
survivors_80_Amlodipine_NULL <- nrow(significant_species_NULL)
survivors_80_Amlodipine_NULL

# Adjusted order of magnitude check to include SD, only for significant species
significant_species$Predicted_magnitude_correct <- ifelse(
  (floor(log10(significant_species$lower_bound_pred)) <= floor(log10(significant_species$upper_bound_real)) &
     floor(log10(significant_species$upper_bound_pred)) >= floor(log10(significant_species$lower_bound_real))),
  1,
  0
)

#and for the Null model:
significant_species_NULL$Predicted_magnitude_correct <- ifelse(
  (floor(log10(significant_species_NULL$lower_bound_null)) <= floor(log10(significant_species_NULL$upper_bound_real)) &
     floor(log10(significant_species_NULL$upper_bound_null)) >= floor(log10(significant_species_NULL$lower_bound_real))),
  1,
  0
)

# Calculate the fraction of correctly predicted magnitudes for significant species
predicted_magnitude_correct_fraction_80_Amlodipine <- sum(significant_species$Predicted_magnitude_correct) / nrow(significant_species)
predicted_magnitude_correct_fraction_80_Amlodipine

predicted_magnitude_correct_fraction_80_Amlodipine_NULL <- sum(significant_species_NULL$Predicted_magnitude_correct) / nrow(significant_species_NULL)
predicted_magnitude_correct_fraction_80_Amlodipine_NULL


top_species_missing_80_Amlodipine <- setdiff(top6_real_80_Amlodipine_means, top6_predicted_80_Amlodipine_means)
top_species_wrong_80_Amlodipine <- setdiff(top6_predicted_80_Amlodipine_means, top6_real_80_Amlodipine_means)

Prediction_quality_80_Amlodipine <- data.frame(
  Top_six_correct = paste(top_six_correct_80_Amlodipine, sep=""),
  Top_six_correct_NULL = paste(top_six_correct_80_Amlodipine_NULL, sep=""),
  Top_six_correct_means = paste(top_six_correct_80_Amlodipine_means, sep=""),
  Top_six_correct_means_NULL = paste(top_six_correct_80_Amlodipine_means_NULL, sep=""),
  Predicted_magnitude_correct = paste(round(predicted_magnitude_correct_fraction_80_Amlodipine * 100, 2), "%", sep=""),
  Predicted_magnitude_correct_NULL = paste(round(predicted_magnitude_correct_fraction_80_Amlodipine_NULL * 100, 2), "%", sep=""),
  survivors_total = survivors_80_Amlodipine,
  top_species_missing <- top_species_missing_80_Amlodipine,
  top_species_wrong <- top_species_wrong_80_Amlodipine, 
  predicted_mean_final_OD <- predicted_mean_final_od_80_Amlodipine,
  real_mean_final_OD <- real_mean_final_od_80_Amlodipine,
  sims_total = length(successful_sim_ids)
)

Prediction_quality_80_Amlodipine








##Aripiprazole

combined_monoculture_aucs2_Aripiprazole <- subset(combined_monoculture_aucs2, drug == "Aripiprazole")


#drug sensitivity terms: define once outside of ODEs
y_function_B_vulgatus_Aripiprazole <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("B_vulgatus", "Aripiprazole", best_fitting_models_df_Aripiprazole)), collapse = " ")))
y_function_B_uniformis_Aripiprazole <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("B_uniformis", "Aripiprazole", best_fitting_models_df_Aripiprazole)), collapse = " ")))
y_function_B_fragilis_Aripiprazole <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("B_fragilis", "Aripiprazole", best_fitting_models_df_Aripiprazole)), collapse = " ")))
y_function_B_thetaiotaomicron_Aripiprazole <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("B_thetaiotaomicron", "Aripiprazole", best_fitting_models_df_Aripiprazole)), collapse = " ")))
y_function_C_ramosum_Aripiprazole <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("C_ramosum", "Aripiprazole", best_fitting_models_df_Aripiprazole)), collapse = " ")))
y_function_E_rectale_Aripiprazole <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("E_rectale", "Aripiprazole", best_fitting_models_df_Aripiprazole)), collapse = " ")))
y_function_R_intestinalis_Aripiprazole <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("R_intestinalis", "Aripiprazole", best_fitting_models_df_Aripiprazole)), collapse = " ")))
y_function_V_parvula_Aripiprazole <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("V_parvula", "Aripiprazole", best_fitting_models_df_Aripiprazole)), collapse = " ")))
y_function_E_lenta_Aripiprazole <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("E_lenta", "Aripiprazole", best_fitting_models_df_Aripiprazole)), collapse = " ")))
y_function_F_nucleatum_Aripiprazole <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("F_nucleatum", "Aripiprazole", best_fitting_models_df_Aripiprazole)), collapse = " ")))
y_function_C_bolteae_Aripiprazole <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("C_bolteae", "Aripiprazole", best_fitting_models_df_Aripiprazole)), collapse = " ")))
y_function_C_perfringens_Aripiprazole <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("C_perfringens", "Aripiprazole", best_fitting_models_df_Aripiprazole)), collapse = " ")))
y_function_C_saccharolyticum_Aripiprazole <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("C_saccharolyticum", "Aripiprazole", best_fitting_models_df_Aripiprazole)), collapse = " ")))
y_function_S_salivarius_Aripiprazole <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("S_salivarius", "Aripiprazole", best_fitting_models_df_Aripiprazole)), collapse = " ")))
y_function_R_gnavus_Aripiprazole <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("R_gnavus", "Aripiprazole", best_fitting_models_df_Aripiprazole)), collapse = " ")))
y_function_C_comes_Aripiprazole <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("C_comes", "Aripiprazole", best_fitting_models_df_Aripiprazole)), collapse = " ")))
y_function_P_merdae_Aripiprazole <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("P_merdae", "Aripiprazole", best_fitting_models_df_Aripiprazole)), collapse = " ")))
y_function_S_parasanguinis_Aripiprazole <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("S_parasanguinis", "Aripiprazole", best_fitting_models_df_Aripiprazole)), collapse = " ")))
y_function_C_aerofaciens_Aripiprazole <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("C_aerofaciens", "Aripiprazole", best_fitting_models_df_Aripiprazole)), collapse = " ")))
y_function_D_formicigenerans_Aripiprazole <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("D_formicigenerans", "Aripiprazole", best_fitting_models_df_Aripiprazole)), collapse = " ")))
y_function_E_coli_Aripiprazole <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("E_coli", "Aripiprazole", best_fitting_models_df_Aripiprazole)), collapse = " ")))



y_function_B_vulgatus_Aripiprazole_func <- eval(parse(text = paste("function(Drug) {", y_function_B_vulgatus_Aripiprazole, "}")))
y_function_B_uniformis_Aripiprazole_func <- eval(parse(text = paste("function(Drug) {", y_function_B_uniformis_Aripiprazole, "}")))
y_function_B_fragilis_Aripiprazole_func <- eval(parse(text = paste("function(Drug) {", y_function_B_fragilis_Aripiprazole, "}")))
y_function_B_thetaiotaomicron_Aripiprazole_func <- eval(parse(text = paste("function(Drug) {", y_function_B_thetaiotaomicron_Aripiprazole, "}")))
y_function_C_ramosum_Aripiprazole_func <- eval(parse(text = paste("function(Drug) {", y_function_C_ramosum_Aripiprazole, "}")))
y_function_E_rectale_Aripiprazole_func <- eval(parse(text = paste("function(Drug) {", y_function_E_rectale_Aripiprazole, "}")))
y_function_R_intestinalis_Aripiprazole_func <- eval(parse(text = paste("function(Drug) {", y_function_R_intestinalis_Aripiprazole, "}")))
y_function_E_lenta_Aripiprazole_func <- eval(parse(text = paste("function(Drug) {", y_function_E_lenta_Aripiprazole, "}")))
y_function_F_nucleatum_Aripiprazole_func <- eval(parse(text = paste("function(Drug) {", y_function_F_nucleatum_Aripiprazole, "}")))
y_function_C_bolteae_Aripiprazole_func <- eval(parse(text = paste("function(Drug) {", y_function_C_bolteae_Aripiprazole, "}")))
y_function_C_perfringens_Aripiprazole_func <- eval(parse(text = paste("function(Drug) {", y_function_C_perfringens_Aripiprazole, "}")))
y_function_C_saccharolyticum_Aripiprazole_func <- eval(parse(text = paste("function(Drug) {", y_function_C_saccharolyticum_Aripiprazole, "}")))
y_function_S_salivarius_Aripiprazole_func <- eval(parse(text = paste("function(Drug) {", y_function_S_salivarius_Aripiprazole, "}")))
y_function_R_gnavus_Aripiprazole_func <- eval(parse(text = paste("function(Drug) {", y_function_R_gnavus_Aripiprazole, "}")))
y_function_C_comes_Aripiprazole_func <- eval(parse(text = paste("function(Drug) {", y_function_C_comes_Aripiprazole, "}")))
y_function_P_merdae_Aripiprazole_func <- eval(parse(text = paste("function(Drug) {", y_function_P_merdae_Aripiprazole, "}")))
y_function_S_parasanguinis_Aripiprazole_func <- eval(parse(text = paste("function(Drug) {", y_function_S_parasanguinis_Aripiprazole, "}")))
y_function_C_aerofaciens_Aripiprazole_func <- eval(parse(text = paste("function(Drug) {", y_function_C_aerofaciens_Aripiprazole, "}")))
y_function_D_formicigenerans_Aripiprazole_func <- eval(parse(text = paste("function(Drug) {", y_function_D_formicigenerans_Aripiprazole, "}")))
y_function_E_coli_Aripiprazole_func <- eval(parse(text = paste("function(Drug) {", y_function_E_coli_Aripiprazole, "}")))
y_function_V_parvula_Aripiprazole_func <- eval(parse(text = paste("function(Drug) {", y_function_V_parvula_Aripiprazole, "}")))



unique(combined_monoculture_aucs2_Aripiprazole$conc)
##dictate drug concentration tested for simulation cycle here:
#drug_concentration_tested <- 5 #if manually or:
drug_concentration_tested <- unique(combined_monoculture_aucs2_Aripiprazole$conc)[1] 
initial_conditions <- rep(0.01/32, 32)
initial_conditions <- c(initial_conditions, drug_concentration_tested)


##drug effect fitted for species showing sensitivity in monoculture:
#unique(combined_monoculture_aucs2_Aripiprazole$Species)

##for more simple linear fits
closed.sir.model_Aripiprazole <- function (t, x, params) {
  ## first extract the state variables
  A_muciniphila <- x[1]
  B_adolescentis <- x[2]
  B_fragilis <- x[3]
  B_longum <- x[4]
  B_obeum <- x[5]
  B_thetaiotaomicron <- x[6]
  B_uniformis <- x[7]
  B_vulgatus <- x[8]
  B_wadsworthia <- x[9]
  C_aerofaciens <- x[10]
  C_bolteae <- x[11]
  C_comes <- x[12]
  C_perfringens <- x[13]
  C_ramosum <- x[14]
  C_saccharolyticum <- x[15]
  D_formicigenerans <- x[16]
  E_coli <- x[17]
  E_lenta <- x[18]
  E_rectale <- x[19]
  F_nucleatum <- x[20]
  L_paracasei <- x[21]
  O_splanchnicus <- x[22]
  P_copri <- x[23]
  P_distasonis <- x[24]
  P_merdae <- x[25]
  R_bromii <- x[26]
  R_gnavus <- x[27]
  R_intestinalis <- x[28]
  R_torques <- x[29]
  S_parasanguinis <- x[30]
  S_salivarius <- x[31]
  V_parvula <- x[32]
  Drug <- x[33]
  
  
  ## now extract the parameters
  r_B_fragilis <- flat_params[["B._fragilis.r"]]
  K_B_fragilis <- flat_params[["B._fragilis.K"]]
  r_B_longum <- flat_params[["B._longum.r"]]
  K_B_longum <- flat_params[["B._longum.K"]]
  r_B_thetaiotaomicron <- flat_params[["B._thetaiotaomicron.r"]]
  K_B_thetaiotaomicron <- flat_params[["B._thetaiotaomicron.K"]]
  r_B_uniformis <- flat_params[["B._uniformis.r"]]
  K_B_uniformis <- flat_params[["B._uniformis.K"]]
  r_B_vulgatus <- flat_params[["B._vulgatus.r"]]
  K_B_vulgatus <- flat_params[["B._vulgatus.K"]]
  r_B_wadsworthia <- flat_params[["B._wadsworthia.r"]]
  K_B_wadsworthia <- flat_params[["B._wadsworthia.K"]]
  r_C_aerofaciens <- flat_params[["C._aerofaciens.r"]]
  K_C_aerofaciens <- flat_params[["C._aerofaciens.K"]]
  r_C_bolteae <- flat_params[["C._bolteae.r"]]
  K_C_bolteae <- flat_params[["C._bolteae.K"]]
  r_C_comes <- flat_params[["C._comes.r"]]
  K_C_comes <- flat_params[["C._comes.K"]]
  r_C_perfringens <- flat_params[["C._perfringens.r"]]
  K_C_perfringens <- flat_params[["C._perfringens.K"]]
  r_C_ramosum <- flat_params[["C._ramosum.r"]]
  K_C_ramosum <- flat_params[["C._ramosum.K"]]
  r_C_saccharolyticum <- flat_params[["C._saccharolyticum.r"]]
  K_C_saccharolyticum <- flat_params[["C._saccharolyticum.K"]]
  r_D_formicigenerans <- flat_params[["D._formicigenerans.r"]]
  K_D_formicigenerans <- flat_params[["D._formicigenerans.K"]]
  r_E_coli <- flat_params[["E._coli.r"]]
  K_E_coli <- flat_params[["E._coli.K"]]
  r_E_lenta <- flat_params[["E._lenta.r"]]
  K_E_lenta <- flat_params[["E._lenta.K"]]
  r_E_rectale <- flat_params[["E._rectale.r"]]
  K_E_rectale <- flat_params[["E._rectale.K"]]
  r_F_nucleatum <- flat_params[["F._nucleatum.r"]]
  K_F_nucleatum <- flat_params[["F._nucleatum.K"]]
  r_P_copri <- flat_params[["P._copri.r"]]
  K_P_copri <- flat_params[["P._copri.K"]]
  r_P_merdae <- flat_params[["P._merdae.r"]]
  K_P_merdae <- flat_params[["P._merdae.K"]]
  r_R_gnavus <- flat_params[["R._gnavus.r"]]
  K_R_gnavus <- flat_params[["R._gnavus.K"]]
  r_R_intestinalis <- flat_params[["R._intestinalis.r"]]
  K_R_intestinalis <- flat_params[["R._intestinalis.K"]]
  r_V_parvula <- flat_params[["V._parvula.r"]]
  K_V_parvula <- flat_params[["V._parvula.K"]]
  r_A_muciniphila <- flat_params[["A._muciniphila.r"]]
  K_A_muciniphila <- flat_params[["A._muciniphila.K"]]
  r_B_adolescentis <- flat_params[["B._adolescentis.r"]]
  K_B_adolescentis <- flat_params[["B._adolescentis.K"]]
  r_B_obeum <- flat_params[["B._obeum.r"]]
  K_B_obeum <- flat_params[["B._obeum.K"]]
  r_O_splanchnicus <- flat_params[["O._splanchnicus.r"]]
  K_O_splanchnicus <- flat_params[["O._splanchnicus.K"]]
  r_P_distasonis <- flat_params[["P._distasonis.r"]]
  K_P_distasonis <- flat_params[["P._distasonis.K"]]
  r_R_bromii <- flat_params[["R._bromii.r"]]
  K_R_bromii <- flat_params[["R._bromii.K"]]
  r_R_torques <- flat_params[["R._torques.r"]]
  K_R_torques <- flat_params[["R._torques.K"]]
  r_S_parasanguinis <- flat_params[["S._parasanguinis.r"]]
  K_S_parasanguinis <-flat_params[["S._parasanguinis.K"]]
  r_S_salivarius <- flat_params[["S._salivarius.r"]]
  K_S_salivarius <- flat_params[["S._salivarius.K"]]
  r_L_paracasei <- flat_params[["L._paracasei.r"]]
  K_L_paracasei <- flat_params[["L._paracasei.K"]]
  
  
  t_mod <- ifelse(t > 24.1, t - 24.1, t)
  
  
  ## now code the model equations
  dA_muciniphila_dt <- r_A_muciniphila * A_muciniphila * (1 - A_muciniphila / K_A_muciniphila)
  dB_adolescentis_dt <- r_B_adolescentis * B_adolescentis * (1 - B_adolescentis / K_B_adolescentis)
  dB_fragilis_dt <- r_B_fragilis * B_fragilis * (1 - B_fragilis / max(0.0001, K_B_fragilis * (y_function_B_fragilis_Aripiprazole_func(Drug))))
  dB_longum_dt <- r_B_longum * B_longum * (1 - B_longum / K_B_longum)
  dB_obeum_dt <- r_B_obeum * B_obeum * (1 - B_obeum / K_B_obeum)
  dB_thetaiotaomicron_dt <- r_B_thetaiotaomicron * B_thetaiotaomicron * (1 - B_thetaiotaomicron / max(0.0001, K_B_thetaiotaomicron * (y_function_B_thetaiotaomicron_Aripiprazole_func(Drug))))  
  dB_uniformis_dt <- r_B_uniformis * B_uniformis * (1 - B_uniformis / max(0.0001, K_B_uniformis * (y_function_B_uniformis_Aripiprazole_func(Drug))))
  dB_vulgatus_dt <- r_B_vulgatus * B_vulgatus * (1 - B_vulgatus / max(0.0001, K_B_vulgatus * (y_function_B_vulgatus_Aripiprazole_func(Drug))))
  dB_wadsworthia_dt <- r_B_wadsworthia * B_wadsworthia * (1 - B_wadsworthia / K_B_wadsworthia)
  dC_aerofaciens_dt <- r_C_aerofaciens * C_aerofaciens * (1 - C_aerofaciens / max(0.0001, K_C_aerofaciens * (y_function_C_aerofaciens_Aripiprazole_func(Drug))))
  dC_bolteae_dt <- r_C_bolteae * C_bolteae * (1 - C_bolteae /  max(0.0001, K_C_bolteae * (y_function_C_bolteae_Aripiprazole_func(Drug))))
  dC_comes_dt <- r_C_comes * C_comes * (1 - C_comes / max(0.0001, K_C_comes * (y_function_C_comes_Aripiprazole_func(Drug))))
  dC_perfringens_dt <- r_C_perfringens * C_perfringens * (1 - C_perfringens / max(0.0001, K_C_perfringens * (y_function_C_perfringens_Aripiprazole_func(Drug))))
  dC_ramosum_dt <- r_C_ramosum * C_ramosum * (1 - C_ramosum / max(0.0001, K_C_ramosum * (y_function_C_ramosum_Aripiprazole_func(Drug))))
  dC_saccharolyticum_dt <- r_C_saccharolyticum * C_saccharolyticum * (1 - C_saccharolyticum / max(0.0001, K_C_saccharolyticum * (y_function_C_saccharolyticum_Aripiprazole_func(Drug))))
  dD_formicigenerans_dt <- r_D_formicigenerans * D_formicigenerans * (1 - D_formicigenerans / max(0.0001, K_D_formicigenerans * (y_function_D_formicigenerans_Aripiprazole_func(Drug))))
  dE_coli_dt <- r_E_coli * E_coli * (1 - E_coli / max(0.0001, K_E_coli * (y_function_E_coli_Aripiprazole_func(Drug))))
  dE_lenta_dt <- r_E_lenta * E_lenta * (1 - E_lenta / max(0.0001, K_E_lenta * (y_function_E_lenta_Aripiprazole_func(Drug))))
  dE_rectale_dt <- r_E_rectale * E_rectale * (1 - E_rectale / max(0.0001, K_E_rectale * (y_function_E_rectale_Aripiprazole_func(Drug))))
  dF_nucleatum_dt <- r_F_nucleatum * F_nucleatum * (1 - F_nucleatum / max(0.0001, K_F_nucleatum * (y_function_F_nucleatum_Aripiprazole_func(Drug))))
  dL_paracasei_dt <- r_L_paracasei * L_paracasei * (1 - L_paracasei / K_L_paracasei)  
  dO_splanchnicus_dt <- r_O_splanchnicus * O_splanchnicus * (1 - O_splanchnicus / K_O_splanchnicus)  
  dP_copri_dt <- r_P_copri * P_copri * (1 - P_copri / K_P_copri)
  dP_distasonis_dt <- r_P_distasonis * P_distasonis * (1 - P_distasonis / K_P_distasonis)  
  dP_merdae_dt <- r_P_merdae * P_merdae * (1 - P_merdae / max(0.0001, K_P_merdae * (y_function_P_merdae_Aripiprazole_func(Drug))))
  dR_bromii_dt <- r_R_bromii * R_bromii * (1 - R_bromii / K_R_bromii) 
  dR_gnavus_dt <- r_R_gnavus * R_gnavus * (1 - R_gnavus / max(0.0001, K_R_gnavus * (y_function_R_gnavus_Aripiprazole_func(Drug))))
  dR_intestinalis_dt <- r_R_intestinalis * R_intestinalis * (1 - R_intestinalis / max(0.0001, K_R_intestinalis * (y_function_R_intestinalis_Aripiprazole_func(Drug))))
  dR_torques_dt <- r_R_torques * R_torques * (1 - R_torques /K_R_torques) 
  dS_parasanguinis_dt <- r_S_parasanguinis * S_parasanguinis * (1 - S_parasanguinis / max(0.0001, K_S_parasanguinis * (y_function_S_parasanguinis_Aripiprazole_func(Drug))))
  dS_salivarius_dt <- r_S_salivarius * S_salivarius * (1 - S_salivarius / max(0.0001, K_S_salivarius * (y_function_S_salivarius_Aripiprazole_func(Drug))))
  dV_parvula_dt <- r_V_parvula * V_parvula * (1 - V_parvula / max(0.0001, K_V_parvula * (y_function_V_parvula_Aripiprazole_func(Drug))))
  
  
  
  #Drug differential:
  dDrug_dt <- (subset(drug_dynamics, Drug == "Aripiprazole")$Steepness_param_community * exp(-subset(drug_dynamics, Drug == "Aripiprazole")$Steepness_param_community * t_mod)) * (drug_concentration_tested * prop_left_Aripiprazole - drug_concentration_tested)
  #dDrug_dt <- 0
  
  ## Combine results into a single vector
  dxdt <- c(dA_muciniphila_dt, dB_adolescentis_dt, dB_fragilis_dt, dB_longum_dt, dB_obeum_dt, dB_thetaiotaomicron_dt, dB_uniformis_dt, dB_vulgatus_dt, dB_wadsworthia_dt, dC_aerofaciens_dt, dC_bolteae_dt, dC_comes_dt, dC_perfringens_dt, dC_ramosum_dt, dC_saccharolyticum_dt, dD_formicigenerans_dt, dE_coli_dt, dE_lenta_dt, dE_rectale_dt, dF_nucleatum_dt, dL_paracasei_dt, dO_splanchnicus_dt, dP_copri_dt, dP_distasonis_dt, dP_merdae_dt, dR_bromii_dt, dR_gnavus_dt, dR_intestinalis_dt, dR_torques_dt, dS_parasanguinis_dt, dS_salivarius_dt, dV_parvula_dt, dDrug_dt)
  
  ## Return result as a list
  list(dxdt)
}




#calculate the co-culture correction factor per species based on community composition in absence of drug, just like done for Niclosamide

growth_data_all_0_Niclosamide
growth_data_all_0_Niclosamide1 <- growth_data_all_0_Niclosamide %>%
  dplyr::mutate(Species = gsub(" ", "_", Species))


# Merge rel_ab_control with growth_data_all_0_Niclosamide on Species
# Function to remove duplicated columns by name pattern
clean_columns_base <- function(df, pattern) {
  cols_to_keep <- !grepl(pattern, names(df))
  df <- df[, cols_to_keep]
  return(df)
}

# Use the new function to clean up your dataframe
rel_ab_control <- clean_columns_base(rel_ab_control, "mean_max_OD.[xy]")
str(rel_ab_control)


#rel_ab_control$correction_factor <- rel_ab_control$mean_rel_ab / (rel_ab_control$mean_max_OD/sum(rel_ab_control$mean_max_OD))
# Calculate correction factor with a minimum value of ~1
rel_ab_control$correction_factor <- pmax(rel_ab_control$mean_rel_ab / (rel_ab_control$mean_max_OD / sum(rel_ab_control$mean_max_OD)), 1.1)


# Create a new dataframe for co-culture correction
co_culture_correction <- data.frame(
  species = rel_ab_control$Species,
  correction_factor = rel_ab_control$correction_factor
)


#summarise community data
#Adjust based on tested concentrations for each drug
unique(Community_compositions_focus_drugs_Aripiprazole$concentration)

Community_compositions_focus_drugs_Aripiprazole_5uM <- subset(Community_compositions_focus_drugs_Aripiprazole, concentration == 5)
Community_compositions_focus_drugs_Aripiprazole_20uM <- subset(Community_compositions_focus_drugs_Aripiprazole, concentration == 20)
Community_compositions_focus_drugs_Aripiprazole_80uM <- subset(Community_compositions_focus_drugs_Aripiprazole, concentration == 80)


#5 uM
Community_compositions_focus_drugs_Aripiprazole_5uM_summarised <- Community_compositions_focus_drugs_Aripiprazole_5uM %>%
  dplyr::group_by(species) %>%                                  
  dplyr::summarize(
    mean_rel_ab = mean(rel_abundance, na.rm = TRUE),     
    sd_rel_ab = sd(rel_abundance, na.rm = TRUE) ,
    mean_max_OD = mean(maxOD, na.rm = TRUE),
    sd_max_OD = sd(maxOD, na.rm = TRUE),
    mean_final_OD = mean(finalOD, na.rm = TRUE),
    sd_final_OD = sd(finalOD, na.rm = TRUE)
  ) %>%
  dplyr::ungroup() 


Community_compositions_focus_drugs_Aripiprazole_5uM_summarised <- Community_compositions_focus_drugs_Aripiprazole_5uM_summarised %>%
  dplyr::mutate(Species = sub("^(\\w)\\w*\\s(.*)", "\\1._\\2", species))

#remove (sub)strain info
Community_compositions_focus_drugs_Aripiprazole_5uM_summarised <- Community_compositions_focus_drugs_Aripiprazole_5uM_summarised %>%
  dplyr::mutate(Species = sub("^(\\w\\._\\w+).*", "\\1", Species))


#20 uM
Community_compositions_focus_drugs_Aripiprazole_20uM_summarised <- Community_compositions_focus_drugs_Aripiprazole_20uM %>%
  dplyr::group_by(species) %>%                                  
  dplyr::summarize(
    mean_rel_ab = mean(rel_abundance, na.rm = TRUE),     
    sd_rel_ab = sd(rel_abundance, na.rm = TRUE) ,
    mean_max_OD = mean(maxOD, na.rm = TRUE),
    sd_max_OD = sd(maxOD, na.rm = TRUE),
    mean_final_OD = mean(finalOD, na.rm = TRUE),
    sd_final_OD = sd(finalOD, na.rm = TRUE)
  ) %>%
  dplyr::ungroup() 


Community_compositions_focus_drugs_Aripiprazole_20uM_summarised <- Community_compositions_focus_drugs_Aripiprazole_20uM_summarised %>%
  dplyr::mutate(Species = sub("^(\\w)\\w*\\s(.*)", "\\1._\\2", species))

#remove (sub)strain info
Community_compositions_focus_drugs_Aripiprazole_20uM_summarised <- Community_compositions_focus_drugs_Aripiprazole_20uM_summarised %>%
  dplyr::mutate(Species = sub("^(\\w\\._\\w+).*", "\\1", Species))


#80 uM
Community_compositions_focus_drugs_Aripiprazole_80uM_summarised <- Community_compositions_focus_drugs_Aripiprazole_80uM %>%
  dplyr::group_by(species) %>%                                  
  dplyr::summarize(
    mean_rel_ab = mean(rel_abundance, na.rm = TRUE),     
    sd_rel_ab = sd(rel_abundance, na.rm = TRUE) ,
    mean_max_OD = mean(maxOD, na.rm = TRUE),
    sd_max_OD = sd(maxOD, na.rm = TRUE),    
    mean_final_OD = mean(finalOD, na.rm = TRUE),
    sd_final_OD = sd(finalOD, na.rm = TRUE)
  ) %>%
  dplyr::ungroup() 



Community_compositions_focus_drugs_Aripiprazole_80uM_summarised <- Community_compositions_focus_drugs_Aripiprazole_80uM_summarised %>%
  dplyr::mutate(Species = sub("^(\\w)\\w*\\s(.*)", "\\1._\\2", species))

#remove (sub)strain info
Community_compositions_focus_drugs_Aripiprazole_80uM_summarised <- Community_compositions_focus_drugs_Aripiprazole_80uM_summarised %>%
  dplyr::mutate(Species = sub("^(\\w\\._\\w+).*", "\\1", Species))


#Initialise data frames
sim_output <- data.frame()
input_params_list <- list() #Use a list to collect parameters for each simulation

#number of simulations
num_sims <- 250


for (i in 1:num_sims) {
  tryCatch({
    # generate model parameters
    set.seed(i) #set a different seed for each simulation for variation
    params <- lapply(1:nrow(growth_data_all_0_Niclosamide), function(idx) {
      species_params <- growth_data_all_0_Niclosamide[idx, ]
      list(
        r = rnorm(1, mean = species_params$mean_max_Growth_rate, sd = species_params$sd_max_Growth_rate),
        K = rnorm(1, mean = species_params$mean_max_OD, sd = species_params$sd_max_OD)
      )
    })
    names(params) <- gsub(" ", "_", growth_data_all_0_Niclosamide$Species)
    flat_params <- unlist(params)
    names(flat_params) <- gsub("\\.\\d$", "", names(flat_params))
    
    #replace spaces with underscores to match formatting
    co_culture_correction$species <- gsub(" ", "_", co_culture_correction$species, fixed = TRUE)
    
    #replace the species-specific K parameters extracted from monoculture growth data 
    #with drawn relative abundance values at Niclosamide = 0, scaled to K
    rel_ab_control$Species <- gsub(" ", "_", rel_ab_control$Species)
    
    #Initialise an empty vector to store drawn values
    drawn_values <- numeric(nrow(rel_ab_control))
    
    #draw values from their respective distributions
    for (k in 1:nrow(rel_ab_control)) {
      species_name <- rel_ab_control$Species[k]
      drawn_value <- rnorm(1, mean = rel_ab_control$mean_rel_ab[k], sd = rel_ab_control$sd_rel_ab[k])
      drawn_values[k] <- max(drawn_value, 0)  # Ensure no negative values
    }
    
    #Normalise drawn relative abundance values so they sum to 1 (to reflect a 'true' relative abundance distribution)
    #this is needed so when we convert the values into OD units by multiplying with the drawn community maxOD,
    # the sum of K_i parameters and the drawn K are equal
    normalised_values <- drawn_values / sum(drawn_values)
    
    #Pull community maxOD (K) at 0 drugs from respective normal distribution:
    K <- rnorm(n = 1, mean = rel_ab_control$mean_com_max_OD[1], sd = rel_ab_control$sd_com_max_OD[1])
    
    # Assign these normalised values to their respective species' .K parameters
    for (k in 1:nrow(rel_ab_control)) {
      species_name <- rel_ab_control$Species[k]
      k_index <- grep(paste0("^", species_name, "\\.K$"), names(flat_params))
      
      if (length(k_index) > 0) {
        old_value <- flat_params[k_index]
        flat_params[k_index] <- (normalised_values[k] + 0.0001) * K #add small value in case drawn K_i is 0, which would cause issues with the solver
        cat(sprintf("Updated %s from %f to %f using normalised value %f scaled by K %f\n", names(flat_params)[k_index], old_value, flat_params[k_index], normalised_values[k], K))
      }
    }
    
    #Accounting for variation in drug degradation by community, with standard deviation of end concentration (at 10h) around the fitted predicted (relative) end concentration at 24h
    #prop_left_Aripiprazole <- abs(rnorm(1, (subset(drug_dynamics, Drug == "Aripiprazole")$Prop_left_24h_community), (subset(drug_dynamics, Drug == "Aripiprazole")$SD_drug_community))) 
    #below, we account for measurement error rather than ecological drivers that lead to the variability of degradation at the final point measured 
    prop_left_Aripiprazole <- abs(rnorm(
      n = 1, 
      mean = subset(drug_dynamics, Drug == "Aripiprazole")$Prop_left_24h_community, 
      sd = ifelse(
        subset(drug_dynamics, Drug == "Aripiprazole")$SD_drug_community > subset(drug_dynamics, Drug == "Aripiprazole")$SD_drug_community_start, 
        subset(drug_dynamics, Drug == "Aripiprazole")$SD_drug_community - subset(drug_dynamics, Drug == "Aripiprazole")$SD_drug_community_start, 
        subset(drug_dynamics, Drug == "Aripiprazole")$SD_drug_community
      )
    ))
    
    
    #loop through each species in co_culture_correction
    for (j in 1:nrow(co_culture_correction)) {
      # Extract the species name and correction factor
      species_name <- co_culture_correction$species[j]
      correction_factor <- co_culture_correction$correction_factor[j]
      
      # Identify the corresponding growth rate parameter in flat_params
      #by matching the base species name (without .r)
      growth_rate_indices <- grep(paste0("^", species_name, "\\.r$"), names(flat_params))
      
      #take the growth rate parameter and apply the correction factor 
      for (index in growth_rate_indices) {
        flat_params[index] <- flat_params[index] * correction_factor
      }
    }
    
    flat_params
    # Store parameters for each simulation
    input_params_list[[i]] <- c(sim_ID = i, flat_params)
    
    # Run the model for the first 24-hour cycle
    solution_cycle_1 <- ode(y = initial_conditions, times = seq(from = 0, to = 24, by = 0.1), func = closed.sir.model_Aripiprazole, parms = flat_params,   method = "lsoda", rtol = 1e-6, atol = 1e-6)
    
    # Dilution and second cycle
    end_of_cycle_1 <- solution_cycle_1[nrow(solution_cycle_1), -1]
    initial_conditions_cycle_2 <- end_of_cycle_1 / 50
    #accounting for the drugs being added with the new growth cycle as well:
    initial_conditions_cycle_2[33] <- initial_conditions_cycle_2[33] + drug_concentration_tested
    solution_cycle_2 <- ode(y = initial_conditions_cycle_2, times = seq(from = 24, to = 48, by = 0.1), func = closed.sir.model_Aripiprazole, parms = flat_params,  method = "lsoda", rtol = 1e-6, atol = 1e-6)
    
    # Combine and format results
    combined_solution <- rbind(as.data.frame(solution_cycle_1), as.data.frame(solution_cycle_2)[-1,])
    combined_solution$sim_ID <- rep(i, nrow(combined_solution))
    combined_solution <- combined_solution %>%
      tidyr::gather(key = "Species", value = "Density", -time, -sim_ID) %>%
      dplyr::mutate(Hour = time) %>%
      dplyr::select(sim_ID, Hour, Species, Density)
    
    ##Append to sim_output
    sim_output <- rbind(sim_output, combined_solution)
  }, error = function(e) {
    cat(sprintf("Skipping simulation %d due to an error: %s\n", i, e$message))
  })
}



##Combine all parameter data into a single dataframe
input_params <- do.call(rbind, input_params_list)

# Add a "Species" column 
sim_output$Species_name <- species_names[as.numeric(as.character(sim_output$Species))]
sim_output$Species_name <- replace_na(sim_output$Species_name, "Drug")

#View(input_params)
#View(sim_output)

sim_output <- na.omit(sim_output)
successful_sim_ids <- unique(subset(sim_output, Hour == 48)$sim_ID)
length(successful_sim_ids)
sim_output1 <- sim_output[sim_output$sim_ID %in% successful_sim_ids, ]


#Transform sim_output so we have wide format by Species
sim_output_wide <- tidyr::pivot_wider(sim_output1, 
                                      names_from = Species_name, 
                                      values_from = Density,
                                      id_cols = c(sim_ID, Hour))

length(unique(sim_output_wide$sim_ID))
#calc community OD per timepoint
sim_output_wide$Total_OD <- rowSums(sim_output_wide[, 3:34], na.rm = TRUE)
#calculate and add relative abundances here as well:
species_columns <- colnames(sim_output_wide)[3:34] 

for (species in species_columns) {
  sim_output_wide[[paste0("rel_", species)]] <- sim_output_wide[[species]] / sim_output_wide$Total_OD
}


#assign sim_output_wide test conditions to dataframe name
drug_tested <- "Aripiprazole"
variable_name_1 <- paste0("sim_output_wide_", ifelse(drug_concentration_tested == 1e-04, 0, drug_concentration_tested), "_", drug_tested)
assign(variable_name_1, sim_output_wide)

#turn back into long format if interested in plotting relative abundances
cols_needed <- c("sim_ID", "Hour")

sim_output_long <- sim_output_wide %>% 
  dplyr::select(sim_ID, Hour, Drug, starts_with("rel_")) %>% 
  tidyr::pivot_longer(
    cols = c(Drug, starts_with("rel_")),
    names_to = "Species", 
    values_to = "Relative_abundance",
    names_prefix = "rel_",
    names_transform = list(Species = ~ ifelse(.x == "Drug", "Drug", .x))
  ) 

str(sim_output_long)


species_names_1 <- c(
  "A_muciniphila",
  "B_adolescentis",
  "B_fragilis",
  "B_longum",
  "B_obeum",
  "B_thetaiotaomicron",
  "B_uniformis",
  "B_vulgatus",
  "B_wadsworthia",
  "C_aerofaciens",
  "C_bolteae",
  "C_comes",
  "C_perfringens",
  "C_ramosum",
  "C_saccharolyticum",
  "D_formicigenerans",
  "E_coli",
  "E_lenta",
  "E_rectale",
  "F_nucleatum",
  "L_paracasei",
  "O_splanchnicus",
  "P_copri",
  "P_distasonis",
  "P_merdae",
  "R_bromii",
  "R_gnavus",
  "R_intestinalis",
  "R_torques",
  "S_parasanguinis",
  "S_salivarius",
  "V_parvula",
  "Drug"
)

species_colours_1 <- c(
  "A_muciniphila" = "#1f77b4",
  "B_adolescentis" = "#ff7f0e",
  "B_fragilis" = "#2ca02c",
  "B_longum" = "#d62728",
  "B_obeum" = "#9467bd",
  "B_thetaiotaomicron" = "black",
  "B_uniformis" = "#e377c2",
  "B_vulgatus" = "#7f7f7f",
  "B_wadsworthia" = "gold1",
  "C_aerofaciens" = "#aec7e8",
  "C_bolteae" = "#ffbb78",
  "C_comes" = "magenta",
  "C_perfringens" = "#ff9896",
  "C_ramosum" = "#c5b0d5",
  "C_saccharolyticum" = "#c49c94",
  "D_formicigenerans" = "#f7b6d2",
  "E_coli" = "yellow",
  "E_lenta" = "turquoise",
  "E_rectale" = "#393b79",
  "F_nucleatum" = "royalblue2",
  "L_paracasei" = "blue",
  "O_splanchnicus" = "#637939",
  "P_copri" = "cyan",
  "P_distasonis" = "#8c6d31",
  "P_merdae" = "#c7c7c7",
  "R_bromii" = "#e6550d",
  "R_gnavus" = "#e7cb94",
  "R_intestinalis" = "#843c39",
  "R_torques" = "#d6616b",
  "S_parasanguinis" = "orange3",
  "S_salivarius" = "#7b4173",
  "V_parvula" = "#ce6dbd",
  "Drug" = "green"
)



##Plot output for any specific sim:
# ggplot(subset(sim_output, sim_ID == 1 & Species_name != "Drug"), aes(x = Hour, y = Density, group = Species_name, color = Species_name)) +
#   geom_line(size = 1, alpha = 0.7) +
#   scale_color_manual(values = species_colours_1) +
#   labs(title = paste0("Aripiprazole = ", drug_concentration_tested),
#        x = "Time (hours)",
#        y = "Population Density (OD)",
#        color = "Species") +
#   theme_minimal() +
#   theme(legend.position = "right")
# 
# ggplot(subset(sim_output, sim_ID == 3 & Species_name != "Drug"), aes(x = Hour, y = Density, group = Species_name, color = Species_name)) +
#   geom_line(size = 1, alpha = 0.7) +
#   scale_color_manual(values = species_colours_1) +
#   labs(title = paste0("Aripiprazole = ", drug_concentration_tested),
#        x = "Time (hours)",
#        y = "Population Density (OD)",
#        color = "Species") +
#   theme_minimal() +
#   theme(legend.position = "right")


ggplot(subset(sim_output_long, sim_ID == 1), aes(x = Hour, y = Relative_abundance, group = Species, color = Species)) +
  geom_line(size = 1, alpha = 0.7) +
  scale_color_manual(values = species_colours_1) +
  labs(title = paste0("Aripiprazole = ", drug_concentration_tested),
       x = "Time (hours)",
       y = "Relative abundance",
       color = "Species") +
  theme_minimal() +
  theme(legend.position = "right")


ggplot(subset(sim_output_long, sim_ID == 3), aes(x = Hour, y = Relative_abundance, group = Species, color = Species)) +
  geom_line(size = 1, alpha = 0.7) +
  scale_color_manual(values = species_colours_1) +
  labs(title = paste0("Aripiprazole = ", drug_concentration_tested),
       x = "Time (hours)",
       y = "Relative abundance",
       color = "Species") +
  theme_minimal() +
  theme(legend.position = "right")


#calc mean and standard deviation across sims
sim_stats <- sim_output_long %>%
  dplyr::group_by(Hour, Species) %>%
  dplyr::summarise(
    mean_rel_ab = mean(Relative_abundance),
    sd_rel_ab = sd(Relative_abundance),
    .groups = 'drop'
  )

# Prepare the data for plotting
plot_data <- sim_stats %>%
  dplyr::mutate(Upper = mean_rel_ab + sd_rel_ab, Lower = mean_rel_ab - sd_rel_ab)

ggplot(subset(plot_data, Species != "Drug"), aes(x = Hour, y = mean_rel_ab, group = Species, color = Species)) +
  geom_ribbon(aes(ymin = Lower, ymax = Upper, fill = Species), colour = NA, alpha = 0.2) +  
  geom_line(size = 1, alpha = 0.7) + 
  scale_color_manual(values = species_colours_1) +
  scale_fill_manual(values = species_colours_1) +  
  labs(title = "Mean and SD of Relative Abundance Across Simulations",
       subtitle = paste0("Aripiprazole = ", drug_concentration_tested),       
       x = "Time (hours)",
       y = "Relative abundance",
       color = "Species",
       fill = "Species") +
  theme_minimal() +
  theme(legend.position = "right")

#log-scaled mean trends
ggplot(plot_data, aes(x = Hour, y = log10(mean_rel_ab + 0.0001), group = Species, color = Species)) +
  geom_line(size = 1, alpha = 0.7) +  # Mean line
  scale_color_manual(values = species_colours_1) +
  scale_fill_manual(values = species_colours_1) +  # Ensure consistent colors for lines and fills
  labs(title = "Mean and SD of Relative Abundance Across Simulations",
       subtitle = paste0("Aripiprazole = ", drug_concentration_tested),
       x = "Time (hours)",
       y = "Relative abundance",
       color = "Species",
       fill = "Species") +
  theme_minimal() +
  theme(legend.position = "right")




##prediction quality evaluation
drug_tested <- "Aripiprazole"
variable_name <- paste0("plot_data_", ifelse(drug_concentration_tested == 1e-04, 0, drug_concentration_tested), "_", drug_tested)
assign(variable_name, plot_data)


#extract total OD info:
predicted_mean_final_od_NULL <- Niclosamide_16S_0uM_summarised$mean_com_final_OD[1]
predicted_sd_final_od_NULL <- Niclosamide_16S_0uM_summarised$sd_com_final_OD[1]

predicted_mean_final_od_5_Aripiprazole <- mean(subset(sim_output_wide_5_Aripiprazole, Hour == 48)$Total_OD, na.rm = TRUE)
predicted_sd_final_od_5_Aripiprazole <- sd(subset(sim_output_wide_5_Aripiprazole, Hour == 48)$Total_OD, na.rm = TRUE)

real_mean_final_od_5_Aripiprazole <- Community_compositions_focus_drugs_Aripiprazole_5uM_summarised$mean_final_OD[1]
real_sd_final_od_5_Aripiprazole <- Community_compositions_focus_drugs_Aripiprazole_5uM_summarised$sd_final_OD[1]


predicted_mean_final_od_20_Aripiprazole <- mean(subset(sim_output_wide_20_Aripiprazole, Hour == 48)$Total_OD, na.rm = TRUE)
predicted_sd_final_od_20_Aripiprazole <- sd(subset(sim_output_wide_20_Aripiprazole, Hour == 48)$Total_OD, na.rm = TRUE)

real_mean_final_od_20_Aripiprazole <- Community_compositions_focus_drugs_Aripiprazole_20uM_summarised$mean_final_OD[1]
real_sd_final_od_20_Aripiprazole <- Community_compositions_focus_drugs_Aripiprazole_20uM_summarised$sd_final_OD[1]


predicted_mean_final_od_80_Aripiprazole <- mean(subset(sim_output_wide_80_Aripiprazole, Hour == 48)$Total_OD, na.rm = TRUE)
predicted_sd_final_od_80_Aripiprazole <- sd(subset(sim_output_wide_80_Aripiprazole, Hour == 48)$Total_OD, na.rm = TRUE)

real_mean_final_od_80_Aripiprazole <- Community_compositions_focus_drugs_Aripiprazole_80uM_summarised$mean_final_OD[1]
real_sd_final_od_80_Aripiprazole <- Community_compositions_focus_drugs_Aripiprazole_80uM_summarised$sd_final_OD[1]




#plot_data_0_Aripiprazole_endpoint was used to test model performance at 0 drugs
#plot_data_0_Aripiprazole_endpoint <- subset(plot_data_0_Aripiprazole, Hour == 48 & Species != "Drug")
plot_data_5_Aripiprazole_endpoint <- subset(plot_data_5_Aripiprazole, Hour == 48 & Species != "Drug")
plot_data_20_Aripiprazole_endpoint <- subset(plot_data_20_Aripiprazole, Hour == 48 & Species != "Drug")
plot_data_80_Aripiprazole_endpoint <- subset(plot_data_80_Aripiprazole, Hour == 48 & Species != "Drug")

##Inspecting 'match' to real relative abundance distributions:
Niclosamide_16S_0uM_summarised <- rel_ab_control
Niclosamide_16S_0uM_summarised$Species <- gsub("\\.", "", Niclosamide_16S_0uM_summarised$Species)

Aripiprazole_16S_5uM_summarised <- Community_compositions_focus_drugs_Aripiprazole_5uM_summarised
Aripiprazole_16S_20uM_summarised <- Community_compositions_focus_drugs_Aripiprazole_20uM_summarised
Aripiprazole_16S_80uM_summarised <- Community_compositions_focus_drugs_Aripiprazole_80uM_summarised

Niclosamide_16S_0uM_summarised
Aripiprazole_16S_5uM_summarised 
Aripiprazole_16S_20uM_summarised 
Aripiprazole_16S_80uM_summarised 

#Rename 'species' so the outputs become comparable
original_names_80 <- unique(Aripiprazole_16S_80uM_summarised$species)
original_names_20 <- unique(Aripiprazole_16S_20uM_summarised$species)
original_names_5 <- unique(Aripiprazole_16S_5uM_summarised$species)


##Create a named vector with the original and new names mapping
name_changes <- c(
  "Akkermansia muciniphila" = "A_muciniphila",
  "Bacteroides fragilis" = "B_fragilis",
  "Bacteroides thetaiotaomicron" = "B_thetaiotaomicron",
  "Bacteroides uniformis" = "B_uniformis",
  "Bifidobacterium adolescentis" = "B_adolescentis",
  "Bifidobacterium longum subsp. longum" = "B_longum",
  "Bilophila wadsworthia" = "B_wadsworthia",
  "Blautia obeum" = "B_obeum",
  "Clostridium perfringens" = "C_perfringens",
  "Collinsella aerofaciens" = "C_aerofaciens",
  "Coprococcus comes" = "C_comes",
  "Dorea formicigenerans" = "D_formicigenerans",
  "Eggerthella lenta" = "E_lenta",
  "Enterocloster bolteae" = "C_bolteae",
  "Erysipelatoclostridium ramosum" = "C_ramosum",
  "Escherichia coli ED1a" = "E_coli",
  "Eubacterium rectale" = "E_rectale",
  "Fusobacterium nucleatum subsp. nucleatum" = "F_nucleatum",
  "Lacrimispora saccharolytica" = "C_saccharolyticum",
  "Lacticaseibacillus paracasei" = "L_paracasei",
  "Odoribacter splanchnicus" = "O_splanchnicus",
  "Parabacteroides distasonis" = "P_distasonis",
  "Parabacteroides merdae" = "P_merdae",
  "Phocaeicola vulgatus" = "B_vulgatus",
  "Prevotella copri" = "P_copri",
  "Roseburia intestinalis" = "R_intestinalis",
  "Ruminococcus bromii" = "R_bromii",
  "Ruminococcus gnavus" = "R_gnavus",
  "Ruminococcus torques" = "R_torques",
  "Streptococcus parasanguinis" = "S_parasanguinis",
  "Streptococcus salivarius" = "S_salivarius",
  "Veillonella parvula" = "V_parvula"
)

# Apply name changes to the species column in Aripiprazole_16S_80uM_summarised

Aripiprazole_16S_80uM_summarised$Species <- name_changes[Aripiprazole_16S_80uM_summarised$species]
Aripiprazole_16S_20uM_summarised$Species <- name_changes[Aripiprazole_16S_20uM_summarised$species]
Aripiprazole_16S_5uM_summarised$Species <- name_changes[Aripiprazole_16S_5uM_summarised$species]

# Verify the changes
unique(Aripiprazole_16S_80uM_summarised$Species)
unique(Aripiprazole_16S_20uM_summarised$Species)
unique(Aripiprazole_16S_5uM_summarised$Species)



##First, for 5 uM:
# Get top 6 species from plot_data_5_endpoint
# Adjust the plot_data_5_endpoint with confidence bounds

# #plot_data_0_Aripiprazole_endpoint was used to test model performance at 0 drugs
# plot_data_0_Aripiprazole_endpoint <- plot_data_0_Aripiprazole_endpoint %>%
#   dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)

plot_data_5_Aripiprazole_endpoint <- plot_data_5_Aripiprazole_endpoint %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)

# Adjust the Aripiprazole_16S_5uM_summarised with confidence bounds
Aripiprazole_16S_5uM_summarised <- Aripiprazole_16S_5uM_summarised %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)

#NULL model:
Null_model_summarised <- Niclosamide_16S_0uM_summarised %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)


# Get top 6 species based on the lower bound from plot_data_5_endpoint

#top6_predicted_0_Aripiprazole was used to test model performance at 0 drugs
# top6_predicted_0_Aripiprazole <- plot_data_0_Aripiprazole_endpoint %>%
#    arrange(desc(lower_bound)) %>%
#    slice(1:6) %>%
#    pull(Species)

top6_predicted_5_Aripiprazole <- plot_data_5_Aripiprazole_endpoint %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

# Get top 6 species based on the lower bound from Aripiprazole_16S_5uM_summarised
top6_real_5_Aripiprazole <- Aripiprazole_16S_5uM_summarised %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

top6_NULL <- Null_model_summarised %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

# Calculate the overlap of top 6 species

#top_six_correct_0_Aripiprazole was used to assess model performance at 0 drugs
# top_six_correct_0_Aripiprazole <- length(intersect(top6_predicted_0_Aripiprazole, top6_NULL))
# top_six_correct_0_Aripiprazole

top_six_correct_5_Aripiprazole <- length(intersect(top6_predicted_5_Aripiprazole, top6_real_5_Aripiprazole))
top_six_correct_5_Aripiprazole

top_six_correct_5_Aripiprazole_NULL <- length(intersect(top6_NULL, top6_real_5_Aripiprazole))
top_six_correct_5_Aripiprazole_NULL

top6_predicted_5_Aripiprazole
top6_real_5_Aripiprazole

#top6_NULL

#Now by means:
# #top6_predicted_0_Aripiprazole_means was used to assess model performance at 0 drugs
# top6_predicted_0_Aripiprazole_means <- plot_data_0_Aripiprazole_endpoint %>%
#    arrange(desc(mean_rel_ab)) %>%
#    slice(1:6) %>%
#    pull(Species)

top6_predicted_5_Aripiprazole_means <- plot_data_5_Aripiprazole_endpoint %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)

# Get top 6 species based on the lower bound from Aripiprazole_16S_5uM_summarised
top6_real_5_Aripiprazole_means <- Aripiprazole_16S_5uM_summarised %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)

top6_NULL_means <- Null_model_summarised %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)


# #top_six_correct_0_Aripiprazole_means was used to assess model performance at 0 drugs
# top_six_correct_0_Aripiprazole_means <- length(intersect(top6_predicted_0_Aripiprazole_means, top6_NULL_means))
# top_six_correct_0_Aripiprazole_means

top_six_correct_5_Aripiprazole_means <- length(intersect(top6_predicted_5_Aripiprazole_means, top6_real_5_Aripiprazole_means))
top_six_correct_5_Aripiprazole_means

top_six_correct_5_Aripiprazole_means_NULL <- length(intersect(top6_NULL_means, top6_real_5_Aripiprazole_means))
top_six_correct_5_Aripiprazole_means_NULL

top6_predicted_5_Aripiprazole_means
top6_real_5_Aripiprazole_means

#top6_NULL_means


# Merge dataframes by Species

#merged_data_0_Aripiprazole was used to assess model performance at 0 drugs
#merged_data_0_Aripiprazole <- merge(plot_data_0_Aripiprazole_endpoint, Niclosamide_16S_0uM_summarised, by = "Species", suffixes = c(".pred", ".real"))
merged_data_5_Aripiprazole <- merge(plot_data_5_Aripiprazole_endpoint, Aripiprazole_16S_5uM_summarised, by = "Species", suffixes = c(".pred", ".real"))
merged_data_5_Aripiprazole_NULL <- merge(Niclosamide_16S_0uM_summarised, Aripiprazole_16S_5uM_summarised, by = "Species", suffixes = c(".null", ".real"))


## Below lines used for assessing model performance at 0 drugs; ignore for nonzero concentrations
# # Create lower and upper bounds considering mean ¬± sd
# merged_data_0_Aripiprazole$lower_bound_pred <- merged_data_0_Aripiprazole$mean_rel_ab.pred - merged_data_0_Aripiprazole$sd_rel_ab.pred
# merged_data_0_Aripiprazole$upper_bound_pred <- merged_data_0_Aripiprazole$mean_rel_ab.pred + merged_data_0_Aripiprazole$sd_rel_ab.pred
# merged_data_0_Aripiprazole$lower_bound_real <- merged_data_0_Aripiprazole$mean_rel_ab.real - merged_data_0_Aripiprazole$sd_rel_ab.real
# merged_data_0_Aripiprazole$upper_bound_real <- merged_data_0_Aripiprazole$mean_rel_ab.real + merged_data_0_Aripiprazole$sd_rel_ab.real
# 
# # Ensure lower and upper bounds are non-negative, adjusting as necessary
# merged_data_0_Aripiprazole$lower_bound_pred[merged_data_0_Aripiprazole$lower_bound_pred <= 0] <- 1e-10
# merged_data_0_Aripiprazole$lower_bound_real[merged_data_0_Aripiprazole$lower_bound_real <= 0] <- 1e-10
# merged_data_0_Aripiprazole$upper_bound_pred[merged_data_0_Aripiprazole$upper_bound_pred <= 0] <- 1e-10
# merged_data_0_Aripiprazole$upper_bound_real[merged_data_0_Aripiprazole$upper_bound_real <= 0] <- 1e-10


# Create lower and upper bounds considering mean ¬± sd
merged_data_5_Aripiprazole$lower_bound_pred <- merged_data_5_Aripiprazole$mean_rel_ab.pred - merged_data_5_Aripiprazole$sd_rel_ab.pred
merged_data_5_Aripiprazole$upper_bound_pred <- merged_data_5_Aripiprazole$mean_rel_ab.pred + merged_data_5_Aripiprazole$sd_rel_ab.pred
merged_data_5_Aripiprazole$lower_bound_real <- merged_data_5_Aripiprazole$mean_rel_ab.real - merged_data_5_Aripiprazole$sd_rel_ab.real
merged_data_5_Aripiprazole$upper_bound_real <- merged_data_5_Aripiprazole$mean_rel_ab.real + merged_data_5_Aripiprazole$sd_rel_ab.real

# Ensure lower and upper bounds are non-negative, adjusting as necessary
merged_data_5_Aripiprazole$lower_bound_pred[merged_data_5_Aripiprazole$lower_bound_pred <= 0] <- 1e-10
merged_data_5_Aripiprazole$lower_bound_real[merged_data_5_Aripiprazole$lower_bound_real <= 0] <- 1e-10
merged_data_5_Aripiprazole$upper_bound_pred[merged_data_5_Aripiprazole$upper_bound_pred <= 0] <- 1e-10
merged_data_5_Aripiprazole$upper_bound_real[merged_data_5_Aripiprazole$upper_bound_real <= 0] <- 1e-10

##and for NULL model:
# Create lower and upper bounds considering mean ¬± sd
merged_data_5_Aripiprazole_NULL$lower_bound_null <- merged_data_5_Aripiprazole_NULL$mean_rel_ab.null - merged_data_5_Aripiprazole_NULL$sd_rel_ab.null
merged_data_5_Aripiprazole_NULL$upper_bound_null <- merged_data_5_Aripiprazole_NULL$mean_rel_ab.null + merged_data_5_Aripiprazole_NULL$sd_rel_ab.null
merged_data_5_Aripiprazole_NULL$lower_bound_real <- merged_data_5_Aripiprazole_NULL$mean_rel_ab.real - merged_data_5_Aripiprazole_NULL$sd_rel_ab.real
merged_data_5_Aripiprazole_NULL$upper_bound_real <- merged_data_5_Aripiprazole_NULL$mean_rel_ab.real + merged_data_5_Aripiprazole_NULL$sd_rel_ab.real

# Ensure lower and upper bounds are non-negative, adjusting as necessary
merged_data_5_Aripiprazole_NULL$lower_bound_null[merged_data_5_Aripiprazole_NULL$lower_bound_null <= 0] <- 1e-10
merged_data_5_Aripiprazole_NULL$lower_bound_real[merged_data_5_Aripiprazole_NULL$lower_bound_real <= 0] <- 1e-10
merged_data_5_Aripiprazole_NULL$upper_bound_null[merged_data_5_Aripiprazole_NULL$upper_bound_null <= 0] <- 1e-10
merged_data_5_Aripiprazole_NULL$upper_bound_real[merged_data_5_Aripiprazole_NULL$upper_bound_real <= 0] <- 1e-10

# Filter to include only species with a mean relative abundance > 0.01 in the 'real' dataset

## significant_species_0 was used to assess model performance at 0 drugs
#significant_species_0 <- merged_data_0_Aripiprazole[merged_data_0_Aripiprazole$mean_rel_ab.real > 0.01, ]
significant_species <- merged_data_5_Aripiprazole[merged_data_5_Aripiprazole$mean_rel_ab.real > 0.01, ]
survivors_5_Aripiprazole <- nrow(significant_species)
survivors_5_Aripiprazole

#should be the same as survivors defined above, since it is calculated from .real
significant_species_NULL <- merged_data_5_Aripiprazole_NULL[merged_data_5_Aripiprazole_NULL$mean_rel_ab.real > 0.01, ]
survivors_5_Aripiprazole_NULL <- nrow(significant_species_NULL)
survivors_5_Aripiprazole_NULL

# Adjusted order of magnitude check to include SD, only for significant species
## below code was used to assess model performance at 0 drugs
# significant_species_0$Predicted_magnitude_correct <- ifelse(
#   (floor(log10(significant_species_0$lower_bound_pred)) <= floor(log10(significant_species_0$upper_bound_real)) &
#      floor(log10(significant_species_0$upper_bound_pred)) >= floor(log10(significant_species_0$lower_bound_real))),
#   1,
#   0
# )

significant_species$Predicted_magnitude_correct <- ifelse(
  (floor(log10(significant_species$lower_bound_pred)) <= floor(log10(significant_species$upper_bound_real)) &
     floor(log10(significant_species$upper_bound_pred)) >= floor(log10(significant_species$lower_bound_real))),
  1,
  0
)

#and for the Null model:
significant_species_NULL$Predicted_magnitude_correct <- ifelse(
  (floor(log10(significant_species_NULL$lower_bound_null)) <= floor(log10(significant_species_NULL$upper_bound_real)) &
     floor(log10(significant_species_NULL$upper_bound_null)) >= floor(log10(significant_species_NULL$lower_bound_real))),
  1,
  0
)

# Calculate the fraction of correctly predicted magnitudes for significant species
## below code was used to assess model performance at 0 drugs
#predicted_magnitude_correct_fraction_0_Aripiprazole <- sum(significant_species_0$Predicted_magnitude_correct) / nrow(significant_species_0)
#predicted_magnitude_correct_fraction_0_Aripiprazole

predicted_magnitude_correct_fraction_5_Aripiprazole <- sum(significant_species$Predicted_magnitude_correct) / nrow(significant_species)
predicted_magnitude_correct_fraction_5_Aripiprazole

predicted_magnitude_correct_fraction_5_Aripiprazole_NULL <- sum(significant_species_NULL$Predicted_magnitude_correct) / nrow(significant_species_NULL)
predicted_magnitude_correct_fraction_5_Aripiprazole_NULL

top_species_missing_5_Aripiprazole <- setdiff(top6_real_5_Aripiprazole_means, top6_predicted_5_Aripiprazole_means)
top_species_wrong_5_Aripiprazole <- setdiff(top6_predicted_5_Aripiprazole_means, top6_real_5_Aripiprazole_means)

top_species_missing_5_Aripiprazole <- if(length(top_species_missing_5_Aripiprazole) == 0) "None" else top_species_missing_5_Aripiprazole
top_species_wrong_5_Aripiprazole <- if(length(top_species_wrong_5_Aripiprazole) == 0) "None" else top_species_wrong_5_Aripiprazole



Prediction_quality_5_Aripiprazole <- data.frame(
  Top_six_correct = paste(top_six_correct_5_Aripiprazole, sep=""),
  Top_six_correct_NULL = paste(top_six_correct_5_Aripiprazole_NULL, sep=""),
  Top_six_correct_means = paste(top_six_correct_5_Aripiprazole_means, sep=""),
  Top_six_correct_means_NULL = paste(top_six_correct_5_Aripiprazole_means_NULL, sep=""),
  Predicted_magnitude_correct = paste(round(predicted_magnitude_correct_fraction_5_Aripiprazole * 100, 2), "%", sep=""),
  Predicted_magnitude_correct_NULL = paste(round(predicted_magnitude_correct_fraction_5_Aripiprazole_NULL * 100, 2), "%", sep=""),
  survivors_total = survivors_5_Aripiprazole,
  top_species_missing <- top_species_missing_5_Aripiprazole,
  top_species_wrong <- top_species_wrong_5_Aripiprazole, 
  predicted_mean_final_OD <- predicted_mean_final_od_5_Aripiprazole,
  real_mean_final_OD <- real_mean_final_od_5_Aripiprazole,
  sims_total = length(successful_sim_ids)
)



Prediction_quality_5_Aripiprazole



##Next, for 20 uM:
# Get top 6 species from plot_data_20_endpoint
# Adjust the plot_data_20_endpoint with confidence bounds
plot_data_20_Aripiprazole_endpoint <- plot_data_20_Aripiprazole_endpoint %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)

# Adjust the Aripiprazole_16S_20uM_summarised with confidence bounds
Aripiprazole_16S_20uM_summarised <- Aripiprazole_16S_20uM_summarised %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)

#NULL model:
Null_model_summarised <- Niclosamide_16S_0uM_summarised %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)


# Get top 6 species based on the lower bound from plot_data_20_endpoint
top6_predicted_20_Aripiprazole <- plot_data_20_Aripiprazole_endpoint %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

# Get top 6 species based on the lower bound from Aripiprazole_16S_20uM_summarised
top6_real_20_Aripiprazole <- Aripiprazole_16S_20uM_summarised %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

top6_NULL <- Null_model_summarised %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

# Calculate the overlap of top 6 species
top_six_correct_20_Aripiprazole <- length(intersect(top6_predicted_20_Aripiprazole, top6_real_20_Aripiprazole))
#top_six_correct_20_Aripiprazole

top_six_correct_20_Aripiprazole_NULL <- length(intersect(top6_NULL, top6_real_20_Aripiprazole))
#top_six_correct_20_Aripiprazole_NULL

#top6_predicted_20_Aripiprazole
#top6_real_20_Aripiprazole



#Now by means:
top6_predicted_20_Aripiprazole_means <- plot_data_20_Aripiprazole_endpoint %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)

# Get top 6 species based on the lower bound from Aripiprazole_16S_20uM_summarised
top6_real_20_Aripiprazole_means <- Aripiprazole_16S_20uM_summarised %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)

top6_NULL_means <- Null_model_summarised %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)



top_six_correct_20_Aripiprazole_means <- length(intersect(top6_predicted_20_Aripiprazole_means, top6_real_20_Aripiprazole_means))
#top_six_correct_20_Aripiprazole_means

top_six_correct_20_Aripiprazole_means_NULL <- length(intersect(top6_NULL_means, top6_real_20_Aripiprazole_means))
#top_six_correct_20_Aripiprazole_means_NULL

top6_predicted_20_Aripiprazole_means
#top6_real_20_Aripiprazole_means




# Merge dataframes by Species
merged_data_20_Aripiprazole <- merge(plot_data_20_Aripiprazole_endpoint, Aripiprazole_16S_20uM_summarised, by = "Species", suffixes = c(".pred", ".real"))
merged_data_20_Aripiprazole_NULL <- merge(Niclosamide_16S_0uM_summarised, Aripiprazole_16S_20uM_summarised, by = "Species", suffixes = c(".null", ".real"))



# Create lower and upper bounds considering mean ¬± sd
merged_data_20_Aripiprazole$lower_bound_pred <- merged_data_20_Aripiprazole$mean_rel_ab.pred - merged_data_20_Aripiprazole$sd_rel_ab.pred
merged_data_20_Aripiprazole$upper_bound_pred <- merged_data_20_Aripiprazole$mean_rel_ab.pred + merged_data_20_Aripiprazole$sd_rel_ab.pred
merged_data_20_Aripiprazole$lower_bound_real <- merged_data_20_Aripiprazole$mean_rel_ab.real - merged_data_20_Aripiprazole$sd_rel_ab.real
merged_data_20_Aripiprazole$upper_bound_real <- merged_data_20_Aripiprazole$mean_rel_ab.real + merged_data_20_Aripiprazole$sd_rel_ab.real

# Ensure lower and upper bounds are non-negative, adjusting as necessary
merged_data_20_Aripiprazole$lower_bound_pred[merged_data_20_Aripiprazole$lower_bound_pred <= 0] <- 1e-10
merged_data_20_Aripiprazole$lower_bound_real[merged_data_20_Aripiprazole$lower_bound_real <= 0] <- 1e-10
merged_data_20_Aripiprazole$upper_bound_pred[merged_data_20_Aripiprazole$upper_bound_pred <= 0] <- 1e-10
merged_data_20_Aripiprazole$upper_bound_real[merged_data_20_Aripiprazole$upper_bound_real <= 0] <- 1e-10

##and for NULL model:
# Create lower and upper bounds considering mean ¬± sd
merged_data_20_Aripiprazole_NULL$lower_bound_null <- merged_data_20_Aripiprazole_NULL$mean_rel_ab.null - merged_data_20_Aripiprazole_NULL$sd_rel_ab.null
merged_data_20_Aripiprazole_NULL$upper_bound_null <- merged_data_20_Aripiprazole_NULL$mean_rel_ab.null + merged_data_20_Aripiprazole_NULL$sd_rel_ab.null
merged_data_20_Aripiprazole_NULL$lower_bound_real <- merged_data_20_Aripiprazole_NULL$mean_rel_ab.real - merged_data_20_Aripiprazole_NULL$sd_rel_ab.real
merged_data_20_Aripiprazole_NULL$upper_bound_real <- merged_data_20_Aripiprazole_NULL$mean_rel_ab.real + merged_data_20_Aripiprazole_NULL$sd_rel_ab.real

# Ensure lower and upper bounds are non-negative, adjusting as necessary
merged_data_20_Aripiprazole_NULL$lower_bound_null[merged_data_20_Aripiprazole_NULL$lower_bound_null <= 0] <- 1e-10
merged_data_20_Aripiprazole_NULL$lower_bound_real[merged_data_20_Aripiprazole_NULL$lower_bound_real <= 0] <- 1e-10
merged_data_20_Aripiprazole_NULL$upper_bound_null[merged_data_20_Aripiprazole_NULL$upper_bound_null <= 0] <- 1e-10
merged_data_20_Aripiprazole_NULL$upper_bound_real[merged_data_20_Aripiprazole_NULL$upper_bound_real <= 0] <- 1e-10

# Filter to include only species with a mean relative abundance > 0.01 in the 'real' dataset
significant_species <- merged_data_20_Aripiprazole[merged_data_20_Aripiprazole$mean_rel_ab.real > 0.01, ]
survivors_20_Aripiprazole <- nrow(significant_species)
survivors_20_Aripiprazole

#should be the same as survivors defined above, since it is calculated from .real
significant_species_NULL <- merged_data_20_Aripiprazole_NULL[merged_data_20_Aripiprazole_NULL$mean_rel_ab.real > 0.01, ]
survivors_20_Aripiprazole_NULL <- nrow(significant_species_NULL)
survivors_20_Aripiprazole_NULL

# Adjusted order of magnitude check to include SD, only for significant species
significant_species$Predicted_magnitude_correct <- ifelse(
  (floor(log10(significant_species$lower_bound_pred)) <= floor(log10(significant_species$upper_bound_real)) &
     floor(log10(significant_species$upper_bound_pred)) >= floor(log10(significant_species$lower_bound_real))),
  1,
  0
)

#and for the Null model:
significant_species_NULL$Predicted_magnitude_correct <- ifelse(
  (floor(log10(significant_species_NULL$lower_bound_null)) <= floor(log10(significant_species_NULL$upper_bound_real)) &
     floor(log10(significant_species_NULL$upper_bound_null)) >= floor(log10(significant_species_NULL$lower_bound_real))),
  1,
  0
)

# Calculate the fraction of correctly predicted magnitudes for significant species
predicted_magnitude_correct_fraction_20_Aripiprazole <- sum(significant_species$Predicted_magnitude_correct) / nrow(significant_species)
predicted_magnitude_correct_fraction_20_Aripiprazole

predicted_magnitude_correct_fraction_20_Aripiprazole_NULL <- sum(significant_species_NULL$Predicted_magnitude_correct) / nrow(significant_species_NULL)
predicted_magnitude_correct_fraction_20_Aripiprazole_NULL

top_species_missing_20_Aripiprazole <- setdiff(top6_real_20_Aripiprazole_means, top6_predicted_20_Aripiprazole_means)
top_species_wrong_20_Aripiprazole <- setdiff(top6_predicted_20_Aripiprazole_means, top6_real_20_Aripiprazole_means)

top_species_missing_20_Aripiprazole <- if(length(top_species_missing_20_Aripiprazole) == 0) "None" else top_species_missing_20_Aripiprazole
top_species_wrong_20_Aripiprazole <- if(length(top_species_wrong_20_Aripiprazole) == 0) "None" else top_species_wrong_20_Aripiprazole

Prediction_quality_20_Aripiprazole <- data.frame(
  Top_six_correct = paste(top_six_correct_20_Aripiprazole, sep=""),
  Top_six_correct_NULL = paste(top_six_correct_20_Aripiprazole_NULL, sep=""),
  Top_six_correct_means = paste(top_six_correct_20_Aripiprazole_means, sep=""),
  Top_six_correct_means_NULL = paste(top_six_correct_20_Aripiprazole_means_NULL, sep=""),
  Predicted_magnitude_correct = paste(round(predicted_magnitude_correct_fraction_20_Aripiprazole * 100, 2), "%", sep=""),
  Predicted_magnitude_correct_NULL = paste(round(predicted_magnitude_correct_fraction_20_Aripiprazole_NULL * 100, 2), "%", sep=""),
  survivors_total = survivors_20_Aripiprazole,
  top_species_missing <- top_species_missing_20_Aripiprazole,
  top_species_wrong <- top_species_wrong_20_Aripiprazole, 
  predicted_mean_final_OD <- predicted_mean_final_od_20_Aripiprazole,
  real_mean_final_OD <- real_mean_final_od_20_Aripiprazole,
  sims_total = length(successful_sim_ids)
)

Prediction_quality_20_Aripiprazole






##Next, for 80 uM:
# Get top 6 species from plot_data_80_endpoint
# Adjust the plot_data_80_endpoint with confidence bounds
plot_data_80_Aripiprazole_endpoint <- plot_data_80_Aripiprazole_endpoint %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)

# Adjust the Aripiprazole_16S_80uM_summarised with confidence bounds
Aripiprazole_16S_80uM_summarised <- Aripiprazole_16S_80uM_summarised %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)

#NULL model:
Null_model_summarised <- Niclosamide_16S_0uM_summarised %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)


# Get top 6 species based on the lower bound from plot_data_80_endpoint
top6_predicted_80_Aripiprazole <- plot_data_80_Aripiprazole_endpoint %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

# Get top 6 species based on the lower bound from Aripiprazole_16S_80uM_summarised
top6_real_80_Aripiprazole <- Aripiprazole_16S_80uM_summarised %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

top6_NULL <- Null_model_summarised %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

# Calculate the overlap of top 6 species
top_six_correct_80_Aripiprazole <- length(intersect(top6_predicted_80_Aripiprazole, top6_real_80_Aripiprazole))
#top_six_correct_80_Aripiprazole

top_six_correct_80_Aripiprazole_NULL <- length(intersect(top6_NULL, top6_real_80_Aripiprazole))
#top_six_correct_80_Aripiprazole_NULL

#top6_predicted_80_Aripiprazole
#top6_real_80_Aripiprazole




#Now by means:
top6_predicted_80_Aripiprazole_means <- plot_data_80_Aripiprazole_endpoint %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)

# Get top 6 species based on the lower bound from Aripiprazole_16S_80uM_summarised
top6_real_80_Aripiprazole_means <- Aripiprazole_16S_80uM_summarised %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)

top6_NULL_means <- Null_model_summarised %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)



top_six_correct_80_Aripiprazole_means <- length(intersect(top6_predicted_80_Aripiprazole_means, top6_real_80_Aripiprazole_means))
#top_six_correct_80_Aripiprazole_means

top_six_correct_80_Aripiprazole_means_NULL <- length(intersect(top6_NULL_means, top6_real_80_Aripiprazole_means))
#top_six_correct_80_Aripiprazole_means_NULL

#top6_predicted_80_Aripiprazole_means
#top6_real_80_Aripiprazole_means




# Merge dataframes by Species
merged_data_80_Aripiprazole <- merge(plot_data_80_Aripiprazole_endpoint, Aripiprazole_16S_80uM_summarised, by = "Species", suffixes = c(".pred", ".real"))
merged_data_80_Aripiprazole_NULL <- merge(Niclosamide_16S_0uM_summarised, Aripiprazole_16S_80uM_summarised, by = "Species", suffixes = c(".null", ".real"))



# Create lower and upper bounds considering mean ¬± sd
merged_data_80_Aripiprazole$lower_bound_pred <- merged_data_80_Aripiprazole$mean_rel_ab.pred - merged_data_80_Aripiprazole$sd_rel_ab.pred
merged_data_80_Aripiprazole$upper_bound_pred <- merged_data_80_Aripiprazole$mean_rel_ab.pred + merged_data_80_Aripiprazole$sd_rel_ab.pred
merged_data_80_Aripiprazole$lower_bound_real <- merged_data_80_Aripiprazole$mean_rel_ab.real - merged_data_80_Aripiprazole$sd_rel_ab.real
merged_data_80_Aripiprazole$upper_bound_real <- merged_data_80_Aripiprazole$mean_rel_ab.real + merged_data_80_Aripiprazole$sd_rel_ab.real

# Ensure lower and upper bounds are non-negative, adjusting as necessary
merged_data_80_Aripiprazole$lower_bound_pred[merged_data_80_Aripiprazole$lower_bound_pred <= 0] <- 1e-10
merged_data_80_Aripiprazole$lower_bound_real[merged_data_80_Aripiprazole$lower_bound_real <= 0] <- 1e-10
merged_data_80_Aripiprazole$upper_bound_pred[merged_data_80_Aripiprazole$upper_bound_pred <= 0] <- 1e-10
merged_data_80_Aripiprazole$upper_bound_real[merged_data_80_Aripiprazole$upper_bound_real <= 0] <- 1e-10

##and for NULL model:
# Create lower and upper bounds considering mean ¬± sd
merged_data_80_Aripiprazole_NULL$lower_bound_null <- merged_data_80_Aripiprazole_NULL$mean_rel_ab.null - merged_data_80_Aripiprazole_NULL$sd_rel_ab.null
merged_data_80_Aripiprazole_NULL$upper_bound_null <- merged_data_80_Aripiprazole_NULL$mean_rel_ab.null + merged_data_80_Aripiprazole_NULL$sd_rel_ab.null
merged_data_80_Aripiprazole_NULL$lower_bound_real <- merged_data_80_Aripiprazole_NULL$mean_rel_ab.real - merged_data_80_Aripiprazole_NULL$sd_rel_ab.real
merged_data_80_Aripiprazole_NULL$upper_bound_real <- merged_data_80_Aripiprazole_NULL$mean_rel_ab.real + merged_data_80_Aripiprazole_NULL$sd_rel_ab.real

# Ensure lower and upper bounds are non-negative, adjusting as necessary
merged_data_80_Aripiprazole_NULL$lower_bound_null[merged_data_80_Aripiprazole_NULL$lower_bound_null <= 0] <- 1e-10
merged_data_80_Aripiprazole_NULL$lower_bound_real[merged_data_80_Aripiprazole_NULL$lower_bound_real <= 0] <- 1e-10
merged_data_80_Aripiprazole_NULL$upper_bound_null[merged_data_80_Aripiprazole_NULL$upper_bound_null <= 0] <- 1e-10
merged_data_80_Aripiprazole_NULL$upper_bound_real[merged_data_80_Aripiprazole_NULL$upper_bound_real <= 0] <- 1e-10

# Filter to include only species with a mean relative abundance > 0.01 in the 'real' dataset
significant_species <- merged_data_80_Aripiprazole[merged_data_80_Aripiprazole$mean_rel_ab.real > 0.01, ]
survivors_80_Aripiprazole <- nrow(significant_species)
survivors_80_Aripiprazole

#should be the same as survivors defined above, since it is calculated from .real
significant_species_NULL <- merged_data_80_Aripiprazole_NULL[merged_data_80_Aripiprazole_NULL$mean_rel_ab.real > 0.01, ]
survivors_80_Aripiprazole_NULL <- nrow(significant_species_NULL)
survivors_80_Aripiprazole_NULL

# Adjusted order of magnitude check to include SD, only for significant species
significant_species$Predicted_magnitude_correct <- ifelse(
  (floor(log10(significant_species$lower_bound_pred)) <= floor(log10(significant_species$upper_bound_real)) &
     floor(log10(significant_species$upper_bound_pred)) >= floor(log10(significant_species$lower_bound_real))),
  1,
  0
)

#and for the Null model:
significant_species_NULL$Predicted_magnitude_correct <- ifelse(
  (floor(log10(significant_species_NULL$lower_bound_null)) <= floor(log10(significant_species_NULL$upper_bound_real)) &
     floor(log10(significant_species_NULL$upper_bound_null)) >= floor(log10(significant_species_NULL$lower_bound_real))),
  1,
  0
)

# Calculate the fraction of correctly predicted magnitudes for significant species
predicted_magnitude_correct_fraction_80_Aripiprazole <- sum(significant_species$Predicted_magnitude_correct) / nrow(significant_species)
predicted_magnitude_correct_fraction_80_Aripiprazole

predicted_magnitude_correct_fraction_80_Aripiprazole_NULL <- sum(significant_species_NULL$Predicted_magnitude_correct) / nrow(significant_species_NULL)
predicted_magnitude_correct_fraction_80_Aripiprazole_NULL


top_species_missing_80_Aripiprazole <- setdiff(top6_real_80_Aripiprazole_means, top6_predicted_80_Aripiprazole_means)
top_species_wrong_80_Aripiprazole <- setdiff(top6_predicted_80_Aripiprazole_means, top6_real_80_Aripiprazole_means)

top_species_missing_80_Aripiprazole <- if(length(top_species_missing_80_Aripiprazole) == 0) "None" else top_species_missing_80_Aripiprazole
top_species_wrong_80_Aripiprazole <- if(length(top_species_wrong_80_Aripiprazole) == 0) "None" else top_species_wrong_80_Aripiprazole


Prediction_quality_80_Aripiprazole <- data.frame(
  Top_six_correct = paste(top_six_correct_80_Aripiprazole, sep=""),
  Top_six_correct_NULL = paste(top_six_correct_80_Aripiprazole_NULL, sep=""),
  Top_six_correct_means = paste(top_six_correct_80_Aripiprazole_means, sep=""),
  Top_six_correct_means_NULL = paste(top_six_correct_80_Aripiprazole_means_NULL, sep=""),
  Predicted_magnitude_correct = paste(round(predicted_magnitude_correct_fraction_80_Aripiprazole * 100, 2), "%", sep=""),
  Predicted_magnitude_correct_NULL = paste(round(predicted_magnitude_correct_fraction_80_Aripiprazole_NULL * 100, 2), "%", sep=""),
  survivors_total = survivors_80_Aripiprazole,
  top_species_missing <- top_species_missing_80_Aripiprazole,
  top_species_wrong <- top_species_wrong_80_Aripiprazole, 
  predicted_mean_final_OD <- predicted_mean_final_od_80_Aripiprazole,
  real_mean_final_OD <- real_mean_final_od_80_Aripiprazole,
  sims_total = length(successful_sim_ids)
)

Prediction_quality_80_Aripiprazole











##Azithromycin

combined_monoculture_aucs2_Azithromycin <- subset(combined_monoculture_aucs2, drug == "Azithromycin")


#drug sensitivity terms: define once outside of ODEs
y_function_B_vulgatus_Azithromycin <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("B_vulgatus", "Azithromycin", best_fitting_models_df_Azithromycin)), collapse = " ")))
y_function_B_uniformis_Azithromycin <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("B_uniformis", "Azithromycin", best_fitting_models_df_Azithromycin)), collapse = " ")))
y_function_B_fragilis_Azithromycin <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("B_fragilis", "Azithromycin", best_fitting_models_df_Azithromycin)), collapse = " ")))
y_function_B_thetaiotaomicron_Azithromycin <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("B_thetaiotaomicron", "Azithromycin", best_fitting_models_df_Azithromycin)), collapse = " ")))
y_function_C_ramosum_Azithromycin <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("C_ramosum", "Azithromycin", best_fitting_models_df_Azithromycin)), collapse = " ")))
y_function_E_rectale_Azithromycin <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("E_rectale", "Azithromycin", best_fitting_models_df_Azithromycin)), collapse = " ")))
y_function_R_intestinalis_Azithromycin <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("R_intestinalis", "Azithromycin", best_fitting_models_df_Azithromycin)), collapse = " ")))
y_function_V_parvula_Azithromycin <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("V_parvula", "Azithromycin", best_fitting_models_df_Azithromycin)), collapse = " ")))
y_function_E_lenta_Azithromycin <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("E_lenta", "Azithromycin", best_fitting_models_df_Azithromycin)), collapse = " ")))
y_function_F_nucleatum_Azithromycin <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("F_nucleatum", "Azithromycin", best_fitting_models_df_Azithromycin)), collapse = " ")))
y_function_C_bolteae_Azithromycin <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("C_bolteae", "Azithromycin", best_fitting_models_df_Azithromycin)), collapse = " ")))
y_function_C_perfringens_Azithromycin <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("C_perfringens", "Azithromycin", best_fitting_models_df_Azithromycin)), collapse = " ")))
y_function_C_saccharolyticum_Azithromycin <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("C_saccharolyticum", "Azithromycin", best_fitting_models_df_Azithromycin)), collapse = " ")))
y_function_S_salivarius_Azithromycin <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("S_salivarius", "Azithromycin", best_fitting_models_df_Azithromycin)), collapse = " ")))
y_function_R_gnavus_Azithromycin <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("R_gnavus", "Azithromycin", best_fitting_models_df_Azithromycin)), collapse = " ")))
y_function_C_comes_Azithromycin <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("C_comes", "Azithromycin", best_fitting_models_df_Azithromycin)), collapse = " ")))
y_function_P_merdae_Azithromycin <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("P_merdae", "Azithromycin", best_fitting_models_df_Azithromycin)), collapse = " ")))
y_function_S_parasanguinis_Azithromycin <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("S_parasanguinis", "Azithromycin", best_fitting_models_df_Azithromycin)), collapse = " ")))
y_function_C_aerofaciens_Azithromycin <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("C_aerofaciens", "Azithromycin", best_fitting_models_df_Azithromycin)), collapse = " ")))
y_function_D_formicigenerans_Azithromycin <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("D_formicigenerans", "Azithromycin", best_fitting_models_df_Azithromycin)), collapse = " ")))
y_function_E_coli_Azithromycin <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("E_coli", "Azithromycin", best_fitting_models_df_Azithromycin)), collapse = " ")))



y_function_B_vulgatus_Azithromycin_func <- eval(parse(text = paste("function(Drug) {", y_function_B_vulgatus_Azithromycin, "}")))
y_function_B_uniformis_Azithromycin_func <- eval(parse(text = paste("function(Drug) {", y_function_B_uniformis_Azithromycin, "}")))
y_function_B_fragilis_Azithromycin_func <- eval(parse(text = paste("function(Drug) {", y_function_B_fragilis_Azithromycin, "}")))
y_function_B_thetaiotaomicron_Azithromycin_func <- eval(parse(text = paste("function(Drug) {", y_function_B_thetaiotaomicron_Azithromycin, "}")))
y_function_C_ramosum_Azithromycin_func <- eval(parse(text = paste("function(Drug) {", y_function_C_ramosum_Azithromycin, "}")))
y_function_E_rectale_Azithromycin_func <- eval(parse(text = paste("function(Drug) {", y_function_E_rectale_Azithromycin, "}")))
y_function_R_intestinalis_Azithromycin_func <- eval(parse(text = paste("function(Drug) {", y_function_R_intestinalis_Azithromycin, "}")))
y_function_E_lenta_Azithromycin_func <- eval(parse(text = paste("function(Drug) {", y_function_E_lenta_Azithromycin, "}")))
y_function_F_nucleatum_Azithromycin_func <- eval(parse(text = paste("function(Drug) {", y_function_F_nucleatum_Azithromycin, "}")))
y_function_C_bolteae_Azithromycin_func <- eval(parse(text = paste("function(Drug) {", y_function_C_bolteae_Azithromycin, "}")))
y_function_C_perfringens_Azithromycin_func <- eval(parse(text = paste("function(Drug) {", y_function_C_perfringens_Azithromycin, "}")))
y_function_C_saccharolyticum_Azithromycin_func <- eval(parse(text = paste("function(Drug) {", y_function_C_saccharolyticum_Azithromycin, "}")))
y_function_S_salivarius_Azithromycin_func <- eval(parse(text = paste("function(Drug) {", y_function_S_salivarius_Azithromycin, "}")))
y_function_R_gnavus_Azithromycin_func <- eval(parse(text = paste("function(Drug) {", y_function_R_gnavus_Azithromycin, "}")))
y_function_C_comes_Azithromycin_func <- eval(parse(text = paste("function(Drug) {", y_function_C_comes_Azithromycin, "}")))
y_function_P_merdae_Azithromycin_func <- eval(parse(text = paste("function(Drug) {", y_function_P_merdae_Azithromycin, "}")))
y_function_S_parasanguinis_Azithromycin_func <- eval(parse(text = paste("function(Drug) {", y_function_S_parasanguinis_Azithromycin, "}")))
y_function_C_aerofaciens_Azithromycin_func <- eval(parse(text = paste("function(Drug) {", y_function_C_aerofaciens_Azithromycin, "}")))
y_function_D_formicigenerans_Azithromycin_func <- eval(parse(text = paste("function(Drug) {", y_function_D_formicigenerans_Azithromycin, "}")))
y_function_E_coli_Azithromycin_func <- eval(parse(text = paste("function(Drug) {", y_function_E_coli_Azithromycin, "}")))
y_function_V_parvula_Azithromycin_func <- eval(parse(text = paste("function(Drug) {", y_function_V_parvula_Azithromycin, "}")))



unique(combined_monoculture_aucs2_Azithromycin$conc)
##dictate drug concentration tested for simulation cycle here:
#drug_concentration_tested <- 2.5 #if manually or:
drug_concentration_tested <- unique(combined_monoculture_aucs2_Azithromycin$conc)[1] 
initial_conditions <- rep(0.01/32, 32)
initial_conditions <- c(initial_conditions, drug_concentration_tested)


##drug effect fitted for species showing sensitivity in monoculture:
#unique(combined_monoculture_aucs2_Azithromycin$Species)

##for more simple linear fits
closed.sir.model_Azithromycin <- function (t, x, params) {
  ## first extract the state variables
  A_muciniphila <- x[1]
  B_adolescentis <- x[2]
  B_fragilis <- x[3]
  B_longum <- x[4]
  B_obeum <- x[5]
  B_thetaiotaomicron <- x[6]
  B_uniformis <- x[7]
  B_vulgatus <- x[8]
  B_wadsworthia <- x[9]
  C_aerofaciens <- x[10]
  C_bolteae <- x[11]
  C_comes <- x[12]
  C_perfringens <- x[13]
  C_ramosum <- x[14]
  C_saccharolyticum <- x[15]
  D_formicigenerans <- x[16]
  E_coli <- x[17]
  E_lenta <- x[18]
  E_rectale <- x[19]
  F_nucleatum <- x[20]
  L_paracasei <- x[21]
  O_splanchnicus <- x[22]
  P_copri <- x[23]
  P_distasonis <- x[24]
  P_merdae <- x[25]
  R_bromii <- x[26]
  R_gnavus <- x[27]
  R_intestinalis <- x[28]
  R_torques <- x[29]
  S_parasanguinis <- x[30]
  S_salivarius <- x[31]
  V_parvula <- x[32]
  Drug <- x[33]
  
  
  ## now extract the parameters
  r_B_fragilis <- flat_params[["B._fragilis.r"]]
  K_B_fragilis <- flat_params[["B._fragilis.K"]]
  r_B_longum <- flat_params[["B._longum.r"]]
  K_B_longum <- flat_params[["B._longum.K"]]
  r_B_thetaiotaomicron <- flat_params[["B._thetaiotaomicron.r"]]
  K_B_thetaiotaomicron <- flat_params[["B._thetaiotaomicron.K"]]
  r_B_uniformis <- flat_params[["B._uniformis.r"]]
  K_B_uniformis <- flat_params[["B._uniformis.K"]]
  r_B_vulgatus <- flat_params[["B._vulgatus.r"]]
  K_B_vulgatus <- flat_params[["B._vulgatus.K"]]
  r_B_wadsworthia <- flat_params[["B._wadsworthia.r"]]
  K_B_wadsworthia <- flat_params[["B._wadsworthia.K"]]
  r_C_aerofaciens <- flat_params[["C._aerofaciens.r"]]
  K_C_aerofaciens <- flat_params[["C._aerofaciens.K"]]
  r_C_bolteae <- flat_params[["C._bolteae.r"]]
  K_C_bolteae <- flat_params[["C._bolteae.K"]]
  r_C_comes <- flat_params[["C._comes.r"]]
  K_C_comes <- flat_params[["C._comes.K"]]
  r_C_perfringens <- flat_params[["C._perfringens.r"]]
  K_C_perfringens <- flat_params[["C._perfringens.K"]]
  r_C_ramosum <- flat_params[["C._ramosum.r"]]
  K_C_ramosum <- flat_params[["C._ramosum.K"]]
  r_C_saccharolyticum <- flat_params[["C._saccharolyticum.r"]]
  K_C_saccharolyticum <- flat_params[["C._saccharolyticum.K"]]
  r_D_formicigenerans <- flat_params[["D._formicigenerans.r"]]
  K_D_formicigenerans <- flat_params[["D._formicigenerans.K"]]
  r_E_coli <- flat_params[["E._coli.r"]]
  K_E_coli <- flat_params[["E._coli.K"]]
  r_E_lenta <- flat_params[["E._lenta.r"]]
  K_E_lenta <- flat_params[["E._lenta.K"]]
  r_E_rectale <- flat_params[["E._rectale.r"]]
  K_E_rectale <- flat_params[["E._rectale.K"]]
  r_F_nucleatum <- flat_params[["F._nucleatum.r"]]
  K_F_nucleatum <- flat_params[["F._nucleatum.K"]]
  r_P_copri <- flat_params[["P._copri.r"]]
  K_P_copri <- flat_params[["P._copri.K"]]
  r_P_merdae <- flat_params[["P._merdae.r"]]
  K_P_merdae <- flat_params[["P._merdae.K"]]
  r_R_gnavus <- flat_params[["R._gnavus.r"]]
  K_R_gnavus <- flat_params[["R._gnavus.K"]]
  r_R_intestinalis <- flat_params[["R._intestinalis.r"]]
  K_R_intestinalis <- flat_params[["R._intestinalis.K"]]
  r_V_parvula <- flat_params[["V._parvula.r"]]
  K_V_parvula <- flat_params[["V._parvula.K"]]
  r_A_muciniphila <- flat_params[["A._muciniphila.r"]]
  K_A_muciniphila <- flat_params[["A._muciniphila.K"]]
  r_B_adolescentis <- flat_params[["B._adolescentis.r"]]
  K_B_adolescentis <- flat_params[["B._adolescentis.K"]]
  r_B_obeum <- flat_params[["B._obeum.r"]]
  K_B_obeum <- flat_params[["B._obeum.K"]]
  r_O_splanchnicus <- flat_params[["O._splanchnicus.r"]]
  K_O_splanchnicus <- flat_params[["O._splanchnicus.K"]]
  r_P_distasonis <- flat_params[["P._distasonis.r"]]
  K_P_distasonis <- flat_params[["P._distasonis.K"]]
  r_R_bromii <- flat_params[["R._bromii.r"]]
  K_R_bromii <- flat_params[["R._bromii.K"]]
  r_R_torques <- flat_params[["R._torques.r"]]
  K_R_torques <- flat_params[["R._torques.K"]]
  r_S_parasanguinis <- flat_params[["S._parasanguinis.r"]]
  K_S_parasanguinis <-flat_params[["S._parasanguinis.K"]]
  r_S_salivarius <- flat_params[["S._salivarius.r"]]
  K_S_salivarius <- flat_params[["S._salivarius.K"]]
  r_L_paracasei <- flat_params[["L._paracasei.r"]]
  K_L_paracasei <- flat_params[["L._paracasei.K"]]
  
  
  t_mod <- ifelse(t > 24.1, t - 24.1, t)
  
  
  ## now code the model equations
  dA_muciniphila_dt <- r_A_muciniphila * A_muciniphila * (1 - A_muciniphila / K_A_muciniphila)
  dB_adolescentis_dt <- r_B_adolescentis * B_adolescentis * (1 - B_adolescentis / K_B_adolescentis)
  dB_fragilis_dt <- r_B_fragilis * B_fragilis * (1 - B_fragilis / max(0.0001, K_B_fragilis * (y_function_B_fragilis_Azithromycin_func(Drug))))
  dB_longum_dt <- r_B_longum * B_longum * (1 - B_longum / K_B_longum)
  dB_obeum_dt <- r_B_obeum * B_obeum * (1 - B_obeum / K_B_obeum)
  dB_thetaiotaomicron_dt <- r_B_thetaiotaomicron * B_thetaiotaomicron * (1 - B_thetaiotaomicron / max(0.0001, K_B_thetaiotaomicron * (y_function_B_thetaiotaomicron_Azithromycin_func(Drug))))  
  dB_uniformis_dt <- r_B_uniformis * B_uniformis * (1 - B_uniformis / max(0.0001, K_B_uniformis * (y_function_B_uniformis_Azithromycin_func(Drug))))
  dB_vulgatus_dt <- r_B_vulgatus * B_vulgatus * (1 - B_vulgatus / max(0.0001, K_B_vulgatus * (y_function_B_vulgatus_Azithromycin_func(Drug))))
  dB_wadsworthia_dt <- r_B_wadsworthia * B_wadsworthia * (1 - B_wadsworthia / K_B_wadsworthia)
  dC_aerofaciens_dt <- r_C_aerofaciens * C_aerofaciens * (1 - C_aerofaciens / max(0.0001, K_C_aerofaciens * (y_function_C_aerofaciens_Azithromycin_func(Drug))))
  dC_bolteae_dt <- r_C_bolteae * C_bolteae * (1 - C_bolteae /  max(0.0001, K_C_bolteae * (y_function_C_bolteae_Azithromycin_func(Drug))))
  dC_comes_dt <- r_C_comes * C_comes * (1 - C_comes / max(0.0001, K_C_comes * (y_function_C_comes_Azithromycin_func(Drug))))
  dC_perfringens_dt <- r_C_perfringens * C_perfringens * (1 - C_perfringens / max(0.0001, K_C_perfringens * (y_function_C_perfringens_Azithromycin_func(Drug))))
  dC_ramosum_dt <- r_C_ramosum * C_ramosum * (1 - C_ramosum / max(0.0001, K_C_ramosum * (y_function_C_ramosum_Azithromycin_func(Drug))))
  dC_saccharolyticum_dt <- r_C_saccharolyticum * C_saccharolyticum * (1 - C_saccharolyticum / max(0.0001, K_C_saccharolyticum * (y_function_C_saccharolyticum_Azithromycin_func(Drug))))
  dD_formicigenerans_dt <- r_D_formicigenerans * D_formicigenerans * (1 - D_formicigenerans / max(0.0001, K_D_formicigenerans * (y_function_D_formicigenerans_Azithromycin_func(Drug))))
  dE_coli_dt <- r_E_coli * E_coli * (1 - E_coli / max(0.0001, K_E_coli * (y_function_E_coli_Azithromycin_func(Drug))))
  dE_lenta_dt <- r_E_lenta * E_lenta * (1 - E_lenta / max(0.0001, K_E_lenta * (y_function_E_lenta_Azithromycin_func(Drug))))
  dE_rectale_dt <- r_E_rectale * E_rectale * (1 - E_rectale / max(0.0001, K_E_rectale * (y_function_E_rectale_Azithromycin_func(Drug))))
  dF_nucleatum_dt <- r_F_nucleatum * F_nucleatum * (1 - F_nucleatum / max(0.0001, K_F_nucleatum * (y_function_F_nucleatum_Azithromycin_func(Drug))))
  dL_paracasei_dt <- r_L_paracasei * L_paracasei * (1 - L_paracasei / K_L_paracasei)  
  dO_splanchnicus_dt <- r_O_splanchnicus * O_splanchnicus * (1 - O_splanchnicus / K_O_splanchnicus)  
  dP_copri_dt <- r_P_copri * P_copri * (1 - P_copri / K_P_copri)
  dP_distasonis_dt <- r_P_distasonis * P_distasonis * (1 - P_distasonis / K_P_distasonis)  
  dP_merdae_dt <- r_P_merdae * P_merdae * (1 - P_merdae / max(0.0001, K_P_merdae * (y_function_P_merdae_Azithromycin_func(Drug))))
  dR_bromii_dt <- r_R_bromii * R_bromii * (1 - R_bromii / K_R_bromii) 
  dR_gnavus_dt <- r_R_gnavus * R_gnavus * (1 - R_gnavus / max(0.0001, K_R_gnavus * (y_function_R_gnavus_Azithromycin_func(Drug))))
  dR_intestinalis_dt <- r_R_intestinalis * R_intestinalis * (1 - R_intestinalis / max(0.0001, K_R_intestinalis * (y_function_R_intestinalis_Azithromycin_func(Drug))))
  dR_torques_dt <- r_R_torques * R_torques * (1 - R_torques /K_R_torques) 
  dS_parasanguinis_dt <- r_S_parasanguinis * S_parasanguinis * (1 - S_parasanguinis / max(0.0001, K_S_parasanguinis * (y_function_S_parasanguinis_Azithromycin_func(Drug))))
  dS_salivarius_dt <- r_S_salivarius * S_salivarius * (1 - S_salivarius / max(0.0001, K_S_salivarius * (y_function_S_salivarius_Azithromycin_func(Drug))))
  dV_parvula_dt <- r_V_parvula * V_parvula * (1 - V_parvula / max(0.0001, K_V_parvula * (y_function_V_parvula_Azithromycin_func(Drug))))
  
  
  
  #Drug differential:
  dDrug_dt <- (subset(drug_dynamics, Drug == "Azithromycin")$Steepness_param_community * exp(-subset(drug_dynamics, Drug == "Azithromycin")$Steepness_param_community * t_mod)) * (drug_concentration_tested * prop_left_Azithromycin - drug_concentration_tested)
  #dDrug_dt <- 0
  
  ## Combine results into a single vector
  dxdt <- c(dA_muciniphila_dt, dB_adolescentis_dt, dB_fragilis_dt, dB_longum_dt, dB_obeum_dt, dB_thetaiotaomicron_dt, dB_uniformis_dt, dB_vulgatus_dt, dB_wadsworthia_dt, dC_aerofaciens_dt, dC_bolteae_dt, dC_comes_dt, dC_perfringens_dt, dC_ramosum_dt, dC_saccharolyticum_dt, dD_formicigenerans_dt, dE_coli_dt, dE_lenta_dt, dE_rectale_dt, dF_nucleatum_dt, dL_paracasei_dt, dO_splanchnicus_dt, dP_copri_dt, dP_distasonis_dt, dP_merdae_dt, dR_bromii_dt, dR_gnavus_dt, dR_intestinalis_dt, dR_torques_dt, dS_parasanguinis_dt, dS_salivarius_dt, dV_parvula_dt, dDrug_dt)
  
  ## Return result as a list
  list(dxdt)
}




#calculate the co-culture correction factor per species based on community composition in absence of drug, just like done for Niclosamide

growth_data_all_0_Niclosamide
growth_data_all_0_Niclosamide1 <- growth_data_all_0_Niclosamide %>%
  dplyr::mutate(Species = gsub(" ", "_", Species))


# Merge rel_ab_control with growth_data_all_0_Niclosamide on Species
# Function to remove duplicated columns by name pattern
clean_columns_base <- function(df, pattern) {
  cols_to_keep <- !grepl(pattern, names(df))
  df <- df[, cols_to_keep]
  return(df)
}

# Use the new function to clean up your dataframe
rel_ab_control <- clean_columns_base(rel_ab_control, "mean_max_OD.[xy]")
str(rel_ab_control)


#rel_ab_control$correction_factor <- rel_ab_control$mean_rel_ab / (rel_ab_control$mean_max_OD/sum(rel_ab_control$mean_max_OD))
# Calculate correction factor with a minimum value of ~1
rel_ab_control$correction_factor <- pmax(rel_ab_control$mean_rel_ab / (rel_ab_control$mean_max_OD / sum(rel_ab_control$mean_max_OD)), 1.1)


# Create a new dataframe for co-culture correction
co_culture_correction <- data.frame(
  species = rel_ab_control$Species,
  correction_factor = rel_ab_control$correction_factor
)


#summarise community data
#Adjust based on tested concentrations for each drug
unique(Community_compositions_focus_drugs_Azithromycin$concentration)

Community_compositions_focus_drugs_Azithromycin_2.5uM <- subset(Community_compositions_focus_drugs_Azithromycin, concentration == 2.5)
Community_compositions_focus_drugs_Azithromycin_20uM <- subset(Community_compositions_focus_drugs_Azithromycin, concentration == 20)
Community_compositions_focus_drugs_Azithromycin_50uM <- subset(Community_compositions_focus_drugs_Azithromycin, concentration == 50)


#2.5 uM
Community_compositions_focus_drugs_Azithromycin_2.5uM_summarised <- Community_compositions_focus_drugs_Azithromycin_2.5uM %>%
  dplyr::group_by(species) %>%                                  
  dplyr::summarize(
    mean_rel_ab = mean(rel_abundance, na.rm = TRUE),     
    sd_rel_ab = sd(rel_abundance, na.rm = TRUE) ,
    mean_max_OD = mean(maxOD, na.rm = TRUE),
    sd_max_OD = sd(maxOD, na.rm = TRUE),
    mean_final_OD = mean(finalOD, na.rm = TRUE),
    sd_final_OD = sd(finalOD, na.rm = TRUE)
  ) %>%
  dplyr::ungroup() 


Community_compositions_focus_drugs_Azithromycin_2.5uM_summarised <- Community_compositions_focus_drugs_Azithromycin_2.5uM_summarised %>%
  dplyr::mutate(Species = sub("^(\\w)\\w*\\s(.*)", "\\1._\\2", species))

#remove (sub)strain info
Community_compositions_focus_drugs_Azithromycin_2.5uM_summarised <- Community_compositions_focus_drugs_Azithromycin_2.5uM_summarised %>%
  dplyr::mutate(Species = sub("^(\\w\\._\\w+).*", "\\1", Species))


#20 uM
Community_compositions_focus_drugs_Azithromycin_20uM_summarised <- Community_compositions_focus_drugs_Azithromycin_20uM %>%
  dplyr::group_by(species) %>%                                  
  dplyr::summarize(
    mean_rel_ab = mean(rel_abundance, na.rm = TRUE),     
    sd_rel_ab = sd(rel_abundance, na.rm = TRUE) ,
    mean_max_OD = mean(maxOD, na.rm = TRUE),
    sd_max_OD = sd(maxOD, na.rm = TRUE),
    mean_final_OD = mean(finalOD, na.rm = TRUE),
    sd_final_OD = sd(finalOD, na.rm = TRUE)
  ) %>%
  dplyr::ungroup() 


Community_compositions_focus_drugs_Azithromycin_20uM_summarised <- Community_compositions_focus_drugs_Azithromycin_20uM_summarised %>%
  dplyr::mutate(Species = sub("^(\\w)\\w*\\s(.*)", "\\1._\\2", species))

#remove (sub)strain info
Community_compositions_focus_drugs_Azithromycin_20uM_summarised <- Community_compositions_focus_drugs_Azithromycin_20uM_summarised %>%
  dplyr::mutate(Species = sub("^(\\w\\._\\w+).*", "\\1", Species))


#50 uM
Community_compositions_focus_drugs_Azithromycin_50uM_summarised <- Community_compositions_focus_drugs_Azithromycin_50uM %>%
  dplyr::group_by(species) %>%                                  
  dplyr::summarize(
    mean_rel_ab = mean(rel_abundance, na.rm = TRUE),     
    sd_rel_ab = sd(rel_abundance, na.rm = TRUE) ,
    mean_max_OD = mean(maxOD, na.rm = TRUE),
    sd_max_OD = sd(maxOD, na.rm = TRUE),    
    mean_final_OD = mean(finalOD, na.rm = TRUE),
    sd_final_OD = sd(finalOD, na.rm = TRUE)
  ) %>%
  dplyr::ungroup() 



Community_compositions_focus_drugs_Azithromycin_50uM_summarised <- Community_compositions_focus_drugs_Azithromycin_50uM_summarised %>%
  dplyr::mutate(Species = sub("^(\\w)\\w*\\s(.*)", "\\1._\\2", species))

#remove (sub)strain info
Community_compositions_focus_drugs_Azithromycin_50uM_summarised <- Community_compositions_focus_drugs_Azithromycin_50uM_summarised %>%
  dplyr::mutate(Species = sub("^(\\w\\._\\w+).*", "\\1", Species))


#Initialise data frames
sim_output <- data.frame()
input_params_list <- list() #Use a list to collect parameters for each simulation

#number of simulations
num_sims <- 250


for (i in 1:num_sims) {
  tryCatch({
    # generate model parameters
    set.seed(i) #set a different seed for each simulation for variation
    params <- lapply(1:nrow(growth_data_all_0_Niclosamide), function(idx) {
      species_params <- growth_data_all_0_Niclosamide[idx, ]
      list(
        r = rnorm(1, mean = species_params$mean_max_Growth_rate, sd = species_params$sd_max_Growth_rate),
        K = rnorm(1, mean = species_params$mean_max_OD, sd = species_params$sd_max_OD)
      )
    })
    names(params) <- gsub(" ", "_", growth_data_all_0_Niclosamide$Species)
    flat_params <- unlist(params)
    names(flat_params) <- gsub("\\.\\d$", "", names(flat_params))
    
    #replace spaces with underscores to match formatting
    co_culture_correction$species <- gsub(" ", "_", co_culture_correction$species, fixed = TRUE)
    
    #replace the species-specific K parameters extracted from monoculture growth data 
    #with drawn relative abundance values at Niclosamide = 0, scaled to K
    rel_ab_control$Species <- gsub(" ", "_", rel_ab_control$Species)
    
    #Initialise an empty vector to store drawn values
    drawn_values <- numeric(nrow(rel_ab_control))
    
    #draw values from their respective distributions
    for (k in 1:nrow(rel_ab_control)) {
      species_name <- rel_ab_control$Species[k]
      drawn_value <- rnorm(1, mean = rel_ab_control$mean_rel_ab[k], sd = rel_ab_control$sd_rel_ab[k])
      drawn_values[k] <- max(drawn_value, 0)  # Ensure no negative values
    }
    
    #Normalise drawn relative abundance values so they sum to 1 (to reflect a 'true' relative abundance distribution)
    #this is needed so when we convert the values into OD units by multiplying with the drawn community maxOD,
    # the sum of K_i parameters and the drawn K are equal
    normalised_values <- drawn_values / sum(drawn_values)
    
    #Pull community maxOD (K) at 0 drugs from respective normal distribution:
    K <- rnorm(n = 1, mean = rel_ab_control$mean_com_max_OD[1], sd = rel_ab_control$sd_com_max_OD[1])
    
    # Assign these normalised values to their respective species' .K parameters
    for (k in 1:nrow(rel_ab_control)) {
      species_name <- rel_ab_control$Species[k]
      k_index <- grep(paste0("^", species_name, "\\.K$"), names(flat_params))
      
      if (length(k_index) > 0) {
        old_value <- flat_params[k_index]
        flat_params[k_index] <- (normalised_values[k] + 0.0001) * K #add small value in case drawn K_i is 0, which would cause issues with the solver
        cat(sprintf("Updated %s from %f to %f using normalised value %f scaled by K %f\n", names(flat_params)[k_index], old_value, flat_params[k_index], normalised_values[k], K))
      }
    }
    
    #Accounting for variation in drug degradation by community, with standard deviation of end concentration (at 10h) around the fitted predicted (relative) end concentration at 24h
    #prop_left_Azithromycin <- abs(rnorm(1, (subset(drug_dynamics, Drug == "Azithromycin")$Prop_left_24h_community), (subset(drug_dynamics, Drug == "Azithromycin")$SD_drug_community))) 
    #below, we account for measurement error rather than ecological drivers that lead to the variability of degradation at the final point measured 
    prop_left_Azithromycin <- abs(rnorm(
      n = 1, 
      mean = subset(drug_dynamics, Drug == "Azithromycin")$Prop_left_24h_community, 
      sd = ifelse(
        subset(drug_dynamics, Drug == "Azithromycin")$SD_drug_community > subset(drug_dynamics, Drug == "Azithromycin")$SD_drug_community_start, 
        subset(drug_dynamics, Drug == "Azithromycin")$SD_drug_community - subset(drug_dynamics, Drug == "Azithromycin")$SD_drug_community_start, 
        subset(drug_dynamics, Drug == "Azithromycin")$SD_drug_community
      )
    ))
    
    
    #loop through each species in co_culture_correction
    for (j in 1:nrow(co_culture_correction)) {
      # Extract the species name and correction factor
      species_name <- co_culture_correction$species[j]
      correction_factor <- co_culture_correction$correction_factor[j]
      
      # Identify the corresponding growth rate parameter in flat_params
      #by matching the base species name (without .r)
      growth_rate_indices <- grep(paste0("^", species_name, "\\.r$"), names(flat_params))
      
      #take the growth rate parameter and apply the correction factor 
      for (index in growth_rate_indices) {
        flat_params[index] <- flat_params[index] * correction_factor
      }
    }
    
    flat_params
    # Store parameters for each simulation
    input_params_list[[i]] <- c(sim_ID = i, flat_params)
    
    # Run the model for the first 24-hour cycle
    solution_cycle_1 <- ode(y = initial_conditions, times = seq(from = 0, to = 24, by = 0.1), func = closed.sir.model_Azithromycin, parms = flat_params,   method = "lsoda", rtol = 1e-6, atol = 1e-6)
    
    # Dilution and second cycle
    end_of_cycle_1 <- solution_cycle_1[nrow(solution_cycle_1), -1]
    initial_conditions_cycle_2 <- end_of_cycle_1 / 50
    #accounting for the drugs being added with the new growth cycle as well:
    initial_conditions_cycle_2[33] <- initial_conditions_cycle_2[33] + drug_concentration_tested
    solution_cycle_2 <- ode(y = initial_conditions_cycle_2, times = seq(from = 24, to = 48, by = 0.1), func = closed.sir.model_Azithromycin, parms = flat_params,  method = "lsoda", rtol = 1e-6, atol = 1e-6)
    
    # Combine and format results
    combined_solution <- rbind(as.data.frame(solution_cycle_1), as.data.frame(solution_cycle_2)[-1,])
    combined_solution$sim_ID <- rep(i, nrow(combined_solution))
    combined_solution <- combined_solution %>%
      tidyr::gather(key = "Species", value = "Density", -time, -sim_ID) %>%
      dplyr::mutate(Hour = time) %>%
      dplyr::select(sim_ID, Hour, Species, Density)
    
    ##Append to sim_output
    sim_output <- rbind(sim_output, combined_solution)
  }, error = function(e) {
    cat(sprintf("Skipping simulation %d due to an error: %s\n", i, e$message))
  })
}



##Combine all parameter data into a single dataframe
input_params <- do.call(rbind, input_params_list)

# Add a "Species" column 
sim_output$Species_name <- species_names[as.numeric(as.character(sim_output$Species))]
sim_output$Species_name <- replace_na(sim_output$Species_name, "Drug")

#View(input_params)
#View(sim_output)

sim_output <- na.omit(sim_output)
successful_sim_ids <- unique(subset(sim_output, Hour == 48)$sim_ID)
length(successful_sim_ids)
sim_output1 <- sim_output[sim_output$sim_ID %in% successful_sim_ids, ]


#Transform sim_output so we have wide format by Species
sim_output_wide <- tidyr::pivot_wider(sim_output1, 
                                      names_from = Species_name, 
                                      values_from = Density,
                                      id_cols = c(sim_ID, Hour))

length(unique(sim_output_wide$sim_ID))
#calc community OD per timepoint
sim_output_wide$Total_OD <- rowSums(sim_output_wide[, 3:34], na.rm = TRUE)
#calculate and add relative abundances here as well:
species_columns <- colnames(sim_output_wide)[3:34] 

for (species in species_columns) {
  sim_output_wide[[paste0("rel_", species)]] <- sim_output_wide[[species]] / sim_output_wide$Total_OD
}


#assign sim_output_wide test conditions to dataframe name
drug_tested <- "Azithromycin"
variable_name_1 <- paste0("sim_output_wide_", ifelse(drug_concentration_tested == 1e-04, 0, drug_concentration_tested), "_", drug_tested)
assign(variable_name_1, sim_output_wide)

#turn back into long format if interested in plotting relative abundances
cols_needed <- c("sim_ID", "Hour")

sim_output_long <- sim_output_wide %>% 
  dplyr::select(sim_ID, Hour, Drug, starts_with("rel_")) %>% 
  tidyr::pivot_longer(
    cols = c(Drug, starts_with("rel_")),
    names_to = "Species", 
    values_to = "Relative_abundance",
    names_prefix = "rel_",
    names_transform = list(Species = ~ ifelse(.x == "Drug", "Drug", .x))
  ) 

str(sim_output_long)


species_names_1 <- c(
  "A_muciniphila",
  "B_adolescentis",
  "B_fragilis",
  "B_longum",
  "B_obeum",
  "B_thetaiotaomicron",
  "B_uniformis",
  "B_vulgatus",
  "B_wadsworthia",
  "C_aerofaciens",
  "C_bolteae",
  "C_comes",
  "C_perfringens",
  "C_ramosum",
  "C_saccharolyticum",
  "D_formicigenerans",
  "E_coli",
  "E_lenta",
  "E_rectale",
  "F_nucleatum",
  "L_paracasei",
  "O_splanchnicus",
  "P_copri",
  "P_distasonis",
  "P_merdae",
  "R_bromii",
  "R_gnavus",
  "R_intestinalis",
  "R_torques",
  "S_parasanguinis",
  "S_salivarius",
  "V_parvula",
  "Drug"
)

species_colours_1 <- c(
  "A_muciniphila" = "#1f77b4",
  "B_adolescentis" = "#ff7f0e",
  "B_fragilis" = "#2ca02c",
  "B_longum" = "#d62728",
  "B_obeum" = "#9467bd",
  "B_thetaiotaomicron" = "black",
  "B_uniformis" = "#e377c2",
  "B_vulgatus" = "#7f7f7f",
  "B_wadsworthia" = "gold1",
  "C_aerofaciens" = "#aec7e8",
  "C_bolteae" = "#ffbb78",
  "C_comes" = "magenta",
  "C_perfringens" = "#ff9896",
  "C_ramosum" = "#c5b0d5",
  "C_saccharolyticum" = "#c49c94",
  "D_formicigenerans" = "#f7b6d2",
  "E_coli" = "yellow",
  "E_lenta" = "turquoise",
  "E_rectale" = "#393b79",
  "F_nucleatum" = "royalblue2",
  "L_paracasei" = "blue",
  "O_splanchnicus" = "#637939",
  "P_copri" = "cyan",
  "P_distasonis" = "#8c6d31",
  "P_merdae" = "#c7c7c7",
  "R_bromii" = "#e6550d",
  "R_gnavus" = "#e7cb94",
  "R_intestinalis" = "#843c39",
  "R_torques" = "#d6616b",
  "S_parasanguinis" = "orange3",
  "S_salivarius" = "#7b4173",
  "V_parvula" = "#ce6dbd",
  "Drug" = "green"
)



##Plot output for any specific sim:
# ggplot(subset(sim_output, sim_ID == 1 & Species_name != "Drug"), aes(x = Hour, y = Density, group = Species_name, color = Species_name)) +
#   geom_line(size = 1, alpha = 0.7) +
#   scale_color_manual(values = species_colours_1) +
#   labs(title = paste0("Azithromycin = ", drug_concentration_tested),
#        x = "Time (hours)",
#        y = "Population Density (OD)",
#        color = "Species") +
#   theme_minimal() +
#   theme(legend.position = "right")
# 
# ggplot(subset(sim_output, sim_ID == 3 & Species_name != "Drug"), aes(x = Hour, y = Density, group = Species_name, color = Species_name)) +
#   geom_line(size = 1, alpha = 0.7) +
#   scale_color_manual(values = species_colours_1) +
#   labs(title = paste0("Azithromycin = ", drug_concentration_tested),
#        x = "Time (hours)",
#        y = "Population Density (OD)",
#        color = "Species") +
#   theme_minimal() +
#   theme(legend.position = "right")


ggplot(subset(sim_output_long, sim_ID == 1), aes(x = Hour, y = Relative_abundance, group = Species, color = Species)) +
  geom_line(size = 1, alpha = 0.7) +
  scale_color_manual(values = species_colours_1) +
  labs(title = paste0("Azithromycin = ", drug_concentration_tested),
       x = "Time (hours)",
       y = "Relative abundance",
       color = "Species") +
  theme_minimal() +
  theme(legend.position = "right")


ggplot(subset(sim_output_long, sim_ID == 3), aes(x = Hour, y = Relative_abundance, group = Species, color = Species)) +
  geom_line(size = 1, alpha = 0.7) +
  scale_color_manual(values = species_colours_1) +
  labs(title = paste0("Azithromycin = ", drug_concentration_tested),
       x = "Time (hours)",
       y = "Relative abundance",
       color = "Species") +
  theme_minimal() +
  theme(legend.position = "right")


#calc mean and standard deviation across sims
sim_stats <- sim_output_long %>%
  dplyr::group_by(Hour, Species) %>%
  dplyr::summarise(
    mean_rel_ab = mean(Relative_abundance),
    sd_rel_ab = sd(Relative_abundance),
    .groups = 'drop'
  )

# Prepare the data for plotting
plot_data <- sim_stats %>%
  dplyr::mutate(Upper = mean_rel_ab + sd_rel_ab, Lower = mean_rel_ab - sd_rel_ab)

ggplot(subset(plot_data, Species != "Drug"), aes(x = Hour, y = mean_rel_ab, group = Species, color = Species)) +
  geom_ribbon(aes(ymin = Lower, ymax = Upper, fill = Species), colour = NA, alpha = 0.2) +  
  geom_line(size = 1, alpha = 0.7) + 
  scale_color_manual(values = species_colours_1) +
  scale_fill_manual(values = species_colours_1) +  
  labs(title = "Mean and SD of Relative Abundance Across Simulations",
       subtitle = paste0("Azithromycin = ", drug_concentration_tested),       
       x = "Time (hours)",
       y = "Relative abundance",
       color = "Species",
       fill = "Species") +
  theme_minimal() +
  theme(legend.position = "right")

#log-scaled mean trends
ggplot(plot_data, aes(x = Hour, y = log10(mean_rel_ab + 0.0001), group = Species, color = Species)) +
  geom_line(size = 1, alpha = 0.7) +  # Mean line
  scale_color_manual(values = species_colours_1) +
  scale_fill_manual(values = species_colours_1) +  # Ensure consistent colors for lines and fills
  labs(title = "Mean and SD of Relative Abundance Across Simulations",
       subtitle = paste0("Azithromycin = ", drug_concentration_tested),
       x = "Time (hours)",
       y = "Relative abundance",
       color = "Species",
       fill = "Species") +
  theme_minimal() +
  theme(legend.position = "right")




##prediction quality evaluation
drug_tested <- "Azithromycin"
variable_name <- paste0("plot_data_", ifelse(drug_concentration_tested == 1e-04, 0, drug_concentration_tested), "_", drug_tested)
assign(variable_name, plot_data)


#extract total OD info:
predicted_mean_final_od_NULL <- Niclosamide_16S_0uM_summarised$mean_com_final_OD[1]
predicted_sd_final_od_NULL <- Niclosamide_16S_0uM_summarised$sd_com_final_OD[1]

predicted_mean_final_od_2.5_Azithromycin <- mean(subset(sim_output_wide_2.5_Azithromycin, Hour == 48)$Total_OD, na.rm = TRUE)
predicted_sd_final_od_2.5_Azithromycin <- sd(subset(sim_output_wide_2.5_Azithromycin, Hour == 48)$Total_OD, na.rm = TRUE)

real_mean_final_od_2.5_Azithromycin <- Community_compositions_focus_drugs_Azithromycin_2.5uM_summarised$mean_final_OD[1]
real_sd_final_od_2.5_Azithromycin <- Community_compositions_focus_drugs_Azithromycin_2.5uM_summarised$sd_final_OD[1]


predicted_mean_final_od_20_Azithromycin <- mean(subset(sim_output_wide_20_Azithromycin, Hour == 48)$Total_OD, na.rm = TRUE)
predicted_sd_final_od_20_Azithromycin <- sd(subset(sim_output_wide_20_Azithromycin, Hour == 48)$Total_OD, na.rm = TRUE)

real_mean_final_od_20_Azithromycin <- Community_compositions_focus_drugs_Azithromycin_20uM_summarised$mean_final_OD[1]
real_sd_final_od_20_Azithromycin <- Community_compositions_focus_drugs_Azithromycin_20uM_summarised$sd_final_OD[1]


predicted_mean_final_od_50_Azithromycin <- mean(subset(sim_output_wide_50_Azithromycin, Hour == 48)$Total_OD, na.rm = TRUE)
predicted_sd_final_od_50_Azithromycin <- sd(subset(sim_output_wide_50_Azithromycin, Hour == 48)$Total_OD, na.rm = TRUE)

real_mean_final_od_50_Azithromycin <- Community_compositions_focus_drugs_Azithromycin_50uM_summarised$mean_final_OD[1]
real_sd_final_od_50_Azithromycin <- Community_compositions_focus_drugs_Azithromycin_50uM_summarised$sd_final_OD[1]




#plot_data_0_Azithromycin_endpoint was used to test model performance at 0 drugs
#plot_data_0_Azithromycin_endpoint <- subset(plot_data_0_Azithromycin, Hour == 48 & Species != "Drug")
plot_data_2.5_Azithromycin_endpoint <- subset(plot_data_2.5_Azithromycin, Hour == 48 & Species != "Drug")
plot_data_20_Azithromycin_endpoint <- subset(plot_data_20_Azithromycin, Hour == 48 & Species != "Drug")
plot_data_50_Azithromycin_endpoint <- subset(plot_data_50_Azithromycin, Hour == 48 & Species != "Drug")

##Inspecting 'match' to real relative abundance distributions:
Niclosamide_16S_0uM_summarised <- rel_ab_control
Niclosamide_16S_0uM_summarised$Species <- gsub("\\.", "", Niclosamide_16S_0uM_summarised$Species)

Azithromycin_16S_2.5uM_summarised <- Community_compositions_focus_drugs_Azithromycin_2.5uM_summarised
Azithromycin_16S_20uM_summarised <- Community_compositions_focus_drugs_Azithromycin_20uM_summarised
Azithromycin_16S_50uM_summarised <- Community_compositions_focus_drugs_Azithromycin_50uM_summarised

Niclosamide_16S_0uM_summarised
Azithromycin_16S_2.5uM_summarised 
Azithromycin_16S_20uM_summarised 
Azithromycin_16S_50uM_summarised 

#Rename 'species' so the outputs become comparable
original_names_50 <- unique(Azithromycin_16S_50uM_summarised$species)
original_names_20 <- unique(Azithromycin_16S_20uM_summarised$species)
original_names_2.5 <- unique(Azithromycin_16S_2.5uM_summarised$species)


##Create a named vector with the original and new names mapping
name_changes <- c(
  "Akkermansia muciniphila" = "A_muciniphila",
  "Bacteroides fragilis" = "B_fragilis",
  "Bacteroides thetaiotaomicron" = "B_thetaiotaomicron",
  "Bacteroides uniformis" = "B_uniformis",
  "Bifidobacterium adolescentis" = "B_adolescentis",
  "Bifidobacterium longum subsp. longum" = "B_longum",
  "Bilophila wadsworthia" = "B_wadsworthia",
  "Blautia obeum" = "B_obeum",
  "Clostridium perfringens" = "C_perfringens",
  "Collinsella aerofaciens" = "C_aerofaciens",
  "Coprococcus comes" = "C_comes",
  "Dorea formicigenerans" = "D_formicigenerans",
  "Eggerthella lenta" = "E_lenta",
  "Enterocloster bolteae" = "C_bolteae",
  "Erysipelatoclostridium ramosum" = "C_ramosum",
  "Escherichia coli ED1a" = "E_coli",
  "Eubacterium rectale" = "E_rectale",
  "Fusobacterium nucleatum subsp. nucleatum" = "F_nucleatum",
  "Lacrimispora saccharolytica" = "C_saccharolyticum",
  "Lacticaseibacillus paracasei" = "L_paracasei",
  "Odoribacter splanchnicus" = "O_splanchnicus",
  "Parabacteroides distasonis" = "P_distasonis",
  "Parabacteroides merdae" = "P_merdae",
  "Phocaeicola vulgatus" = "B_vulgatus",
  "Prevotella copri" = "P_copri",
  "Roseburia intestinalis" = "R_intestinalis",
  "Ruminococcus bromii" = "R_bromii",
  "Ruminococcus gnavus" = "R_gnavus",
  "Ruminococcus torques" = "R_torques",
  "Streptococcus parasanguinis" = "S_parasanguinis",
  "Streptococcus salivarius" = "S_salivarius",
  "Veillonella parvula" = "V_parvula"
)

# Apply name changes to the species column in Azithromycin_16S_50uM_summarised

Azithromycin_16S_50uM_summarised$Species <- name_changes[Azithromycin_16S_50uM_summarised$species]
Azithromycin_16S_20uM_summarised$Species <- name_changes[Azithromycin_16S_20uM_summarised$species]
Azithromycin_16S_2.5uM_summarised$Species <- name_changes[Azithromycin_16S_2.5uM_summarised$species]

# Verify the changes
unique(Azithromycin_16S_50uM_summarised$Species)
unique(Azithromycin_16S_20uM_summarised$Species)
unique(Azithromycin_16S_2.5uM_summarised$Species)



##First, for 2.5 uM:
# Get top 6 species from plot_data_2.5_endpoint
# Adjust the plot_data_2.5_endpoint with confidence bounds

# #plot_data_0_Azithromycin_endpoint was used to test model performance at 0 drugs
# plot_data_0_Azithromycin_endpoint <- plot_data_0_Azithromycin_endpoint %>%
#   dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)

plot_data_2.5_Azithromycin_endpoint <- plot_data_2.5_Azithromycin_endpoint %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)

# Adjust the Azithromycin_16S_2.5uM_summarised with confidence bounds
Azithromycin_16S_2.5uM_summarised <- Azithromycin_16S_2.5uM_summarised %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)

#NULL model:
Null_model_summarised <- Niclosamide_16S_0uM_summarised %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)


# Get top 6 species based on the lower bound from plot_data_2.5_endpoint

#top6_predicted_0_Azithromycin was used to test model performance at 0 drugs
# top6_predicted_0_Azithromycin <- plot_data_0_Azithromycin_endpoint %>%
#    arrange(desc(lower_bound)) %>%
#    slice(1:6) %>%
#    pull(Species)

top6_predicted_2.5_Azithromycin <- plot_data_2.5_Azithromycin_endpoint %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

# Get top 6 species based on the lower bound from Azithromycin_16S_2.5uM_summarised
top6_real_2.5_Azithromycin <- Azithromycin_16S_2.5uM_summarised %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

top6_NULL <- Null_model_summarised %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

# Calculate the overlap of top 6 species

#top_six_correct_0_Azithromycin was used to assess model performance at 0 drugs
# top_six_correct_0_Azithromycin <- length(intersect(top6_predicted_0_Azithromycin, top6_NULL))
# top_six_correct_0_Azithromycin

top_six_correct_2.5_Azithromycin <- length(intersect(top6_predicted_2.5_Azithromycin, top6_real_2.5_Azithromycin))
top_six_correct_2.5_Azithromycin

top_six_correct_2.5_Azithromycin_NULL <- length(intersect(top6_NULL, top6_real_2.5_Azithromycin))
top_six_correct_2.5_Azithromycin_NULL

top6_predicted_2.5_Azithromycin
top6_real_2.5_Azithromycin

#top6_NULL

#Now by means:
# #top6_predicted_0_Azithromycin_means was used to assess model performance at 0 drugs
# top6_predicted_0_Azithromycin_means <- plot_data_0_Azithromycin_endpoint %>%
#    arrange(desc(mean_rel_ab)) %>%
#    slice(1:6) %>%
#    pull(Species)

top6_predicted_2.5_Azithromycin_means <- plot_data_2.5_Azithromycin_endpoint %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)

# Get top 6 species based on the lower bound from Azithromycin_16S_2.5uM_summarised
top6_real_2.5_Azithromycin_means <- Azithromycin_16S_2.5uM_summarised %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)

top6_NULL_means <- Null_model_summarised %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)


# #top_six_correct_0_Azithromycin_means was used to assess model performance at 0 drugs
# top_six_correct_0_Azithromycin_means <- length(intersect(top6_predicted_0_Azithromycin_means, top6_NULL_means))
# top_six_correct_0_Azithromycin_means

top_six_correct_2.5_Azithromycin_means <- length(intersect(top6_predicted_2.5_Azithromycin_means, top6_real_2.5_Azithromycin_means))
top_six_correct_2.5_Azithromycin_means

top_six_correct_2.5_Azithromycin_means_NULL <- length(intersect(top6_NULL_means, top6_real_2.5_Azithromycin_means))
top_six_correct_2.5_Azithromycin_means_NULL

top6_predicted_2.5_Azithromycin_means
top6_real_2.5_Azithromycin_means

#top6_NULL_means


# Merge dataframes by Species

#merged_data_0_Azithromycin was used to assess model performance at 0 drugs
#merged_data_0_Azithromycin <- merge(plot_data_0_Azithromycin_endpoint, Niclosamide_16S_0uM_summarised, by = "Species", suffixes = c(".pred", ".real"))
merged_data_2.5_Azithromycin <- merge(plot_data_2.5_Azithromycin_endpoint, Azithromycin_16S_2.5uM_summarised, by = "Species", suffixes = c(".pred", ".real"))
merged_data_2.5_Azithromycin_NULL <- merge(Niclosamide_16S_0uM_summarised, Azithromycin_16S_2.5uM_summarised, by = "Species", suffixes = c(".null", ".real"))


## Below lines used for assessing model performance at 0 drugs; ignore for nonzero concentrations
# # Create lower and upper bounds considering mean ¬± sd
# merged_data_0_Azithromycin$lower_bound_pred <- merged_data_0_Azithromycin$mean_rel_ab.pred - merged_data_0_Azithromycin$sd_rel_ab.pred
# merged_data_0_Azithromycin$upper_bound_pred <- merged_data_0_Azithromycin$mean_rel_ab.pred + merged_data_0_Azithromycin$sd_rel_ab.pred
# merged_data_0_Azithromycin$lower_bound_real <- merged_data_0_Azithromycin$mean_rel_ab.real - merged_data_0_Azithromycin$sd_rel_ab.real
# merged_data_0_Azithromycin$upper_bound_real <- merged_data_0_Azithromycin$mean_rel_ab.real + merged_data_0_Azithromycin$sd_rel_ab.real
# 
# # Ensure lower and upper bounds are non-negative, adjusting as necessary
# merged_data_0_Azithromycin$lower_bound_pred[merged_data_0_Azithromycin$lower_bound_pred <= 0] <- 1e-10
# merged_data_0_Azithromycin$lower_bound_real[merged_data_0_Azithromycin$lower_bound_real <= 0] <- 1e-10
# merged_data_0_Azithromycin$upper_bound_pred[merged_data_0_Azithromycin$upper_bound_pred <= 0] <- 1e-10
# merged_data_0_Azithromycin$upper_bound_real[merged_data_0_Azithromycin$upper_bound_real <= 0] <- 1e-10


# Create lower and upper bounds considering mean ¬± sd
merged_data_2.5_Azithromycin$lower_bound_pred <- merged_data_2.5_Azithromycin$mean_rel_ab.pred - merged_data_2.5_Azithromycin$sd_rel_ab.pred
merged_data_2.5_Azithromycin$upper_bound_pred <- merged_data_2.5_Azithromycin$mean_rel_ab.pred + merged_data_2.5_Azithromycin$sd_rel_ab.pred
merged_data_2.5_Azithromycin$lower_bound_real <- merged_data_2.5_Azithromycin$mean_rel_ab.real - merged_data_2.5_Azithromycin$sd_rel_ab.real
merged_data_2.5_Azithromycin$upper_bound_real <- merged_data_2.5_Azithromycin$mean_rel_ab.real + merged_data_2.5_Azithromycin$sd_rel_ab.real

# Ensure lower and upper bounds are non-negative, adjusting as necessary
merged_data_2.5_Azithromycin$lower_bound_pred[merged_data_2.5_Azithromycin$lower_bound_pred <= 0] <- 1e-10
merged_data_2.5_Azithromycin$lower_bound_real[merged_data_2.5_Azithromycin$lower_bound_real <= 0] <- 1e-10
merged_data_2.5_Azithromycin$upper_bound_pred[merged_data_2.5_Azithromycin$upper_bound_pred <= 0] <- 1e-10
merged_data_2.5_Azithromycin$upper_bound_real[merged_data_2.5_Azithromycin$upper_bound_real <= 0] <- 1e-10

##and for NULL model:
# Create lower and upper bounds considering mean ¬± sd
merged_data_2.5_Azithromycin_NULL$lower_bound_null <- merged_data_2.5_Azithromycin_NULL$mean_rel_ab.null - merged_data_2.5_Azithromycin_NULL$sd_rel_ab.null
merged_data_2.5_Azithromycin_NULL$upper_bound_null <- merged_data_2.5_Azithromycin_NULL$mean_rel_ab.null + merged_data_2.5_Azithromycin_NULL$sd_rel_ab.null
merged_data_2.5_Azithromycin_NULL$lower_bound_real <- merged_data_2.5_Azithromycin_NULL$mean_rel_ab.real - merged_data_2.5_Azithromycin_NULL$sd_rel_ab.real
merged_data_2.5_Azithromycin_NULL$upper_bound_real <- merged_data_2.5_Azithromycin_NULL$mean_rel_ab.real + merged_data_2.5_Azithromycin_NULL$sd_rel_ab.real

# Ensure lower and upper bounds are non-negative, adjusting as necessary
merged_data_2.5_Azithromycin_NULL$lower_bound_null[merged_data_2.5_Azithromycin_NULL$lower_bound_null <= 0] <- 1e-10
merged_data_2.5_Azithromycin_NULL$lower_bound_real[merged_data_2.5_Azithromycin_NULL$lower_bound_real <= 0] <- 1e-10
merged_data_2.5_Azithromycin_NULL$upper_bound_null[merged_data_2.5_Azithromycin_NULL$upper_bound_null <= 0] <- 1e-10
merged_data_2.5_Azithromycin_NULL$upper_bound_real[merged_data_2.5_Azithromycin_NULL$upper_bound_real <= 0] <- 1e-10

# Filter to include only species with a mean relative abundance > 0.01 in the 'real' dataset

## significant_species_0 was used to assess model performance at 0 drugs
#significant_species_0 <- merged_data_0_Azithromycin[merged_data_0_Azithromycin$mean_rel_ab.real > 0.01, ]
significant_species <- merged_data_2.5_Azithromycin[merged_data_2.5_Azithromycin$mean_rel_ab.real > 0.01, ]
survivors_2.5_Azithromycin <- nrow(significant_species)
survivors_2.5_Azithromycin

#should be the same as survivors defined above, since it is calculated from .real
significant_species_NULL <- merged_data_2.5_Azithromycin_NULL[merged_data_2.5_Azithromycin_NULL$mean_rel_ab.real > 0.01, ]
survivors_2.5_Azithromycin_NULL <- nrow(significant_species_NULL)
survivors_2.5_Azithromycin_NULL

# Adjusted order of magnitude check to include SD, only for significant species
## below code was used to assess model performance at 0 drugs
# significant_species_0$Predicted_magnitude_correct <- ifelse(
#   (floor(log10(significant_species_0$lower_bound_pred)) <= floor(log10(significant_species_0$upper_bound_real)) &
#      floor(log10(significant_species_0$upper_bound_pred)) >= floor(log10(significant_species_0$lower_bound_real))),
#   1,
#   0
# )

significant_species$Predicted_magnitude_correct <- ifelse(
  (floor(log10(significant_species$lower_bound_pred)) <= floor(log10(significant_species$upper_bound_real)) &
     floor(log10(significant_species$upper_bound_pred)) >= floor(log10(significant_species$lower_bound_real))),
  1,
  0
)

#and for the Null model:
significant_species_NULL$Predicted_magnitude_correct <- ifelse(
  (floor(log10(significant_species_NULL$lower_bound_null)) <= floor(log10(significant_species_NULL$upper_bound_real)) &
     floor(log10(significant_species_NULL$upper_bound_null)) >= floor(log10(significant_species_NULL$lower_bound_real))),
  1,
  0
)

# Calculate the fraction of correctly predicted magnitudes for significant species
## below code was used to assess model performance at 0 drugs
#predicted_magnitude_correct_fraction_0_Azithromycin <- sum(significant_species_0$Predicted_magnitude_correct) / nrow(significant_species_0)
#predicted_magnitude_correct_fraction_0_Azithromycin

predicted_magnitude_correct_fraction_2.5_Azithromycin <- sum(significant_species$Predicted_magnitude_correct) / nrow(significant_species)
predicted_magnitude_correct_fraction_2.5_Azithromycin

predicted_magnitude_correct_fraction_2.5_Azithromycin_NULL <- sum(significant_species_NULL$Predicted_magnitude_correct) / nrow(significant_species_NULL)
predicted_magnitude_correct_fraction_2.5_Azithromycin_NULL

top_species_missing_2.5_Azithromycin <- setdiff(top6_real_2.5_Azithromycin_means, top6_predicted_2.5_Azithromycin_means)
top_species_wrong_2.5_Azithromycin <- setdiff(top6_predicted_2.5_Azithromycin_means, top6_real_2.5_Azithromycin_means)


Prediction_quality_2.5_Azithromycin <- data.frame(
  Top_six_correct = paste(top_six_correct_2.5_Azithromycin, sep=""),
  Top_six_correct_NULL = paste(top_six_correct_2.5_Azithromycin_NULL, sep=""),
  Top_six_correct_means = paste(top_six_correct_2.5_Azithromycin_means, sep=""),
  Top_six_correct_means_NULL = paste(top_six_correct_2.5_Azithromycin_means_NULL, sep=""),
  Predicted_magnitude_correct = paste(round(predicted_magnitude_correct_fraction_2.5_Azithromycin * 100, 2), "%", sep=""),
  Predicted_magnitude_correct_NULL = paste(round(predicted_magnitude_correct_fraction_2.5_Azithromycin_NULL * 100, 2), "%", sep=""),
  survivors_total = survivors_2.5_Azithromycin,
  top_species_missing <- top_species_missing_2.5_Azithromycin,
  top_species_wrong <- top_species_wrong_2.5_Azithromycin, 
  predicted_mean_final_OD <- predicted_mean_final_od_2.5_Azithromycin,
  real_mean_final_OD <- real_mean_final_od_2.5_Azithromycin,
  sims_total = length(successful_sim_ids)
)



Prediction_quality_2.5_Azithromycin



##Next, for 20 uM:
# Get top 6 species from plot_data_20_endpoint
# Adjust the plot_data_20_endpoint with confidence bounds
plot_data_20_Azithromycin_endpoint <- plot_data_20_Azithromycin_endpoint %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)

# Adjust the Azithromycin_16S_20uM_summarised with confidence bounds
Azithromycin_16S_20uM_summarised <- Azithromycin_16S_20uM_summarised %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)

#NULL model:
Null_model_summarised <- Niclosamide_16S_0uM_summarised %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)


# Get top 6 species based on the lower bound from plot_data_20_endpoint
top6_predicted_20_Azithromycin <- plot_data_20_Azithromycin_endpoint %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

# Get top 6 species based on the lower bound from Azithromycin_16S_20uM_summarised
top6_real_20_Azithromycin <- Azithromycin_16S_20uM_summarised %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

top6_NULL <- Null_model_summarised %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

# Calculate the overlap of top 6 species
top_six_correct_20_Azithromycin <- length(intersect(top6_predicted_20_Azithromycin, top6_real_20_Azithromycin))
#top_six_correct_20_Azithromycin

top_six_correct_20_Azithromycin_NULL <- length(intersect(top6_NULL, top6_real_20_Azithromycin))
#top_six_correct_20_Azithromycin_NULL

#top6_predicted_20_Azithromycin
#top6_real_20_Azithromycin



#Now by means:
top6_predicted_20_Azithromycin_means <- plot_data_20_Azithromycin_endpoint %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)

# Get top 6 species based on the lower bound from Azithromycin_16S_20uM_summarised
top6_real_20_Azithromycin_means <- Azithromycin_16S_20uM_summarised %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)

top6_NULL_means <- Null_model_summarised %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)



top_six_correct_20_Azithromycin_means <- length(intersect(top6_predicted_20_Azithromycin_means, top6_real_20_Azithromycin_means))
#top_six_correct_20_Azithromycin_means

top_six_correct_20_Azithromycin_means_NULL <- length(intersect(top6_NULL_means, top6_real_20_Azithromycin_means))
#top_six_correct_20_Azithromycin_means_NULL

top6_predicted_20_Azithromycin_means
#top6_real_20_Azithromycin_means




# Merge dataframes by Species
merged_data_20_Azithromycin <- merge(plot_data_20_Azithromycin_endpoint, Azithromycin_16S_20uM_summarised, by = "Species", suffixes = c(".pred", ".real"))
merged_data_20_Azithromycin_NULL <- merge(Niclosamide_16S_0uM_summarised, Azithromycin_16S_20uM_summarised, by = "Species", suffixes = c(".null", ".real"))



# Create lower and upper bounds considering mean ¬± sd
merged_data_20_Azithromycin$lower_bound_pred <- merged_data_20_Azithromycin$mean_rel_ab.pred - merged_data_20_Azithromycin$sd_rel_ab.pred
merged_data_20_Azithromycin$upper_bound_pred <- merged_data_20_Azithromycin$mean_rel_ab.pred + merged_data_20_Azithromycin$sd_rel_ab.pred
merged_data_20_Azithromycin$lower_bound_real <- merged_data_20_Azithromycin$mean_rel_ab.real - merged_data_20_Azithromycin$sd_rel_ab.real
merged_data_20_Azithromycin$upper_bound_real <- merged_data_20_Azithromycin$mean_rel_ab.real + merged_data_20_Azithromycin$sd_rel_ab.real

# Ensure lower and upper bounds are non-negative, adjusting as necessary
merged_data_20_Azithromycin$lower_bound_pred[merged_data_20_Azithromycin$lower_bound_pred <= 0] <- 1e-10
merged_data_20_Azithromycin$lower_bound_real[merged_data_20_Azithromycin$lower_bound_real <= 0] <- 1e-10
merged_data_20_Azithromycin$upper_bound_pred[merged_data_20_Azithromycin$upper_bound_pred <= 0] <- 1e-10
merged_data_20_Azithromycin$upper_bound_real[merged_data_20_Azithromycin$upper_bound_real <= 0] <- 1e-10

##and for NULL model:
# Create lower and upper bounds considering mean ¬± sd
merged_data_20_Azithromycin_NULL$lower_bound_null <- merged_data_20_Azithromycin_NULL$mean_rel_ab.null - merged_data_20_Azithromycin_NULL$sd_rel_ab.null
merged_data_20_Azithromycin_NULL$upper_bound_null <- merged_data_20_Azithromycin_NULL$mean_rel_ab.null + merged_data_20_Azithromycin_NULL$sd_rel_ab.null
merged_data_20_Azithromycin_NULL$lower_bound_real <- merged_data_20_Azithromycin_NULL$mean_rel_ab.real - merged_data_20_Azithromycin_NULL$sd_rel_ab.real
merged_data_20_Azithromycin_NULL$upper_bound_real <- merged_data_20_Azithromycin_NULL$mean_rel_ab.real + merged_data_20_Azithromycin_NULL$sd_rel_ab.real

# Ensure lower and upper bounds are non-negative, adjusting as necessary
merged_data_20_Azithromycin_NULL$lower_bound_null[merged_data_20_Azithromycin_NULL$lower_bound_null <= 0] <- 1e-10
merged_data_20_Azithromycin_NULL$lower_bound_real[merged_data_20_Azithromycin_NULL$lower_bound_real <= 0] <- 1e-10
merged_data_20_Azithromycin_NULL$upper_bound_null[merged_data_20_Azithromycin_NULL$upper_bound_null <= 0] <- 1e-10
merged_data_20_Azithromycin_NULL$upper_bound_real[merged_data_20_Azithromycin_NULL$upper_bound_real <= 0] <- 1e-10

# Filter to include only species with a mean relative abundance > 0.01 in the 'real' dataset
significant_species <- merged_data_20_Azithromycin[merged_data_20_Azithromycin$mean_rel_ab.real > 0.01, ]
survivors_20_Azithromycin <- nrow(significant_species)
survivors_20_Azithromycin

#should be the same as survivors defined above, since it is calculated from .real
significant_species_NULL <- merged_data_20_Azithromycin_NULL[merged_data_20_Azithromycin_NULL$mean_rel_ab.real > 0.01, ]
survivors_20_Azithromycin_NULL <- nrow(significant_species_NULL)
survivors_20_Azithromycin_NULL

# Adjusted order of magnitude check to include SD, only for significant species
significant_species$Predicted_magnitude_correct <- ifelse(
  (floor(log10(significant_species$lower_bound_pred)) <= floor(log10(significant_species$upper_bound_real)) &
     floor(log10(significant_species$upper_bound_pred)) >= floor(log10(significant_species$lower_bound_real))),
  1,
  0
)

#and for the Null model:
significant_species_NULL$Predicted_magnitude_correct <- ifelse(
  (floor(log10(significant_species_NULL$lower_bound_null)) <= floor(log10(significant_species_NULL$upper_bound_real)) &
     floor(log10(significant_species_NULL$upper_bound_null)) >= floor(log10(significant_species_NULL$lower_bound_real))),
  1,
  0
)

# Calculate the fraction of correctly predicted magnitudes for significant species
predicted_magnitude_correct_fraction_20_Azithromycin <- sum(significant_species$Predicted_magnitude_correct) / nrow(significant_species)
predicted_magnitude_correct_fraction_20_Azithromycin

predicted_magnitude_correct_fraction_20_Azithromycin_NULL <- sum(significant_species_NULL$Predicted_magnitude_correct) / nrow(significant_species_NULL)
predicted_magnitude_correct_fraction_20_Azithromycin_NULL

top_species_missing_20_Azithromycin <- setdiff(top6_real_20_Azithromycin_means, top6_predicted_20_Azithromycin_means)
top_species_wrong_20_Azithromycin <- setdiff(top6_predicted_20_Azithromycin_means, top6_real_20_Azithromycin_means)

Prediction_quality_20_Azithromycin <- data.frame(
  Top_six_correct = paste(top_six_correct_20_Azithromycin, sep=""),
  Top_six_correct_NULL = paste(top_six_correct_20_Azithromycin_NULL, sep=""),
  Top_six_correct_means = paste(top_six_correct_20_Azithromycin_means, sep=""),
  Top_six_correct_means_NULL = paste(top_six_correct_20_Azithromycin_means_NULL, sep=""),
  Predicted_magnitude_correct = paste(round(predicted_magnitude_correct_fraction_20_Azithromycin * 100, 2), "%", sep=""),
  Predicted_magnitude_correct_NULL = paste(round(predicted_magnitude_correct_fraction_20_Azithromycin_NULL * 100, 2), "%", sep=""),
  survivors_total = survivors_20_Azithromycin,
  top_species_missing <- top_species_missing_20_Azithromycin,
  top_species_wrong <- top_species_wrong_20_Azithromycin, 
  predicted_mean_final_OD <- predicted_mean_final_od_20_Azithromycin,
  real_mean_final_OD <- real_mean_final_od_20_Azithromycin,
  sims_total = length(successful_sim_ids)
)

Prediction_quality_20_Azithromycin






##Next, for 50 uM:
# Get top 6 species from plot_data_50_endpoint
# Adjust the plot_data_50_endpoint with confidence bounds
plot_data_50_Azithromycin_endpoint <- plot_data_50_Azithromycin_endpoint %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)

# Adjust the Azithromycin_16S_50uM_summarised with confidence bounds
Azithromycin_16S_50uM_summarised <- Azithromycin_16S_50uM_summarised %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)

#NULL model:
Null_model_summarised <- Niclosamide_16S_0uM_summarised %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)


# Get top 6 species based on the lower bound from plot_data_50_endpoint
top6_predicted_50_Azithromycin <- plot_data_50_Azithromycin_endpoint %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

# Get top 6 species based on the lower bound from Azithromycin_16S_50uM_summarised
top6_real_50_Azithromycin <- Azithromycin_16S_50uM_summarised %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

top6_NULL <- Null_model_summarised %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

# Calculate the overlap of top 6 species
top_six_correct_50_Azithromycin <- length(intersect(top6_predicted_50_Azithromycin, top6_real_50_Azithromycin))
#top_six_correct_50_Azithromycin

top_six_correct_50_Azithromycin_NULL <- length(intersect(top6_NULL, top6_real_50_Azithromycin))
#top_six_correct_50_Azithromycin_NULL

#top6_predicted_50_Azithromycin
#top6_real_50_Azithromycin




#Now by means:
top6_predicted_50_Azithromycin_means <- plot_data_50_Azithromycin_endpoint %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)

# Get top 6 species based on the lower bound from Azithromycin_16S_50uM_summarised
top6_real_50_Azithromycin_means <- Azithromycin_16S_50uM_summarised %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)

top6_NULL_means <- Null_model_summarised %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)



top_six_correct_50_Azithromycin_means <- length(intersect(top6_predicted_50_Azithromycin_means, top6_real_50_Azithromycin_means))
#top_six_correct_50_Azithromycin_means

top_six_correct_50_Azithromycin_means_NULL <- length(intersect(top6_NULL_means, top6_real_50_Azithromycin_means))
#top_six_correct_50_Azithromycin_means_NULL

#top6_predicted_50_Azithromycin_means
#top6_real_50_Azithromycin_means




# Merge dataframes by Species
merged_data_50_Azithromycin <- merge(plot_data_50_Azithromycin_endpoint, Azithromycin_16S_50uM_summarised, by = "Species", suffixes = c(".pred", ".real"))
merged_data_50_Azithromycin_NULL <- merge(Niclosamide_16S_0uM_summarised, Azithromycin_16S_50uM_summarised, by = "Species", suffixes = c(".null", ".real"))



# Create lower and upper bounds considering mean ¬± sd
merged_data_50_Azithromycin$lower_bound_pred <- merged_data_50_Azithromycin$mean_rel_ab.pred - merged_data_50_Azithromycin$sd_rel_ab.pred
merged_data_50_Azithromycin$upper_bound_pred <- merged_data_50_Azithromycin$mean_rel_ab.pred + merged_data_50_Azithromycin$sd_rel_ab.pred
merged_data_50_Azithromycin$lower_bound_real <- merged_data_50_Azithromycin$mean_rel_ab.real - merged_data_50_Azithromycin$sd_rel_ab.real
merged_data_50_Azithromycin$upper_bound_real <- merged_data_50_Azithromycin$mean_rel_ab.real + merged_data_50_Azithromycin$sd_rel_ab.real

# Ensure lower and upper bounds are non-negative, adjusting as necessary
merged_data_50_Azithromycin$lower_bound_pred[merged_data_50_Azithromycin$lower_bound_pred <= 0] <- 1e-10
merged_data_50_Azithromycin$lower_bound_real[merged_data_50_Azithromycin$lower_bound_real <= 0] <- 1e-10
merged_data_50_Azithromycin$upper_bound_pred[merged_data_50_Azithromycin$upper_bound_pred <= 0] <- 1e-10
merged_data_50_Azithromycin$upper_bound_real[merged_data_50_Azithromycin$upper_bound_real <= 0] <- 1e-10

##and for NULL model:
# Create lower and upper bounds considering mean ¬± sd
merged_data_50_Azithromycin_NULL$lower_bound_null <- merged_data_50_Azithromycin_NULL$mean_rel_ab.null - merged_data_50_Azithromycin_NULL$sd_rel_ab.null
merged_data_50_Azithromycin_NULL$upper_bound_null <- merged_data_50_Azithromycin_NULL$mean_rel_ab.null + merged_data_50_Azithromycin_NULL$sd_rel_ab.null
merged_data_50_Azithromycin_NULL$lower_bound_real <- merged_data_50_Azithromycin_NULL$mean_rel_ab.real - merged_data_50_Azithromycin_NULL$sd_rel_ab.real
merged_data_50_Azithromycin_NULL$upper_bound_real <- merged_data_50_Azithromycin_NULL$mean_rel_ab.real + merged_data_50_Azithromycin_NULL$sd_rel_ab.real

# Ensure lower and upper bounds are non-negative, adjusting as necessary
merged_data_50_Azithromycin_NULL$lower_bound_null[merged_data_50_Azithromycin_NULL$lower_bound_null <= 0] <- 1e-10
merged_data_50_Azithromycin_NULL$lower_bound_real[merged_data_50_Azithromycin_NULL$lower_bound_real <= 0] <- 1e-10
merged_data_50_Azithromycin_NULL$upper_bound_null[merged_data_50_Azithromycin_NULL$upper_bound_null <= 0] <- 1e-10
merged_data_50_Azithromycin_NULL$upper_bound_real[merged_data_50_Azithromycin_NULL$upper_bound_real <= 0] <- 1e-10

# Filter to include only species with a mean relative abundance > 0.01 in the 'real' dataset
significant_species <- merged_data_50_Azithromycin[merged_data_50_Azithromycin$mean_rel_ab.real > 0.01, ]
survivors_50_Azithromycin <- nrow(significant_species)
survivors_50_Azithromycin

#should be the same as survivors defined above, since it is calculated from .real
significant_species_NULL <- merged_data_50_Azithromycin_NULL[merged_data_50_Azithromycin_NULL$mean_rel_ab.real > 0.01, ]
survivors_50_Azithromycin_NULL <- nrow(significant_species_NULL)
survivors_50_Azithromycin_NULL

# Adjusted order of magnitude check to include SD, only for significant species
significant_species$Predicted_magnitude_correct <- ifelse(
  (floor(log10(significant_species$lower_bound_pred)) <= floor(log10(significant_species$upper_bound_real)) &
     floor(log10(significant_species$upper_bound_pred)) >= floor(log10(significant_species$lower_bound_real))),
  1,
  0
)

#and for the Null model:
significant_species_NULL$Predicted_magnitude_correct <- ifelse(
  (floor(log10(significant_species_NULL$lower_bound_null)) <= floor(log10(significant_species_NULL$upper_bound_real)) &
     floor(log10(significant_species_NULL$upper_bound_null)) >= floor(log10(significant_species_NULL$lower_bound_real))),
  1,
  0
)

# Calculate the fraction of correctly predicted magnitudes for significant species
predicted_magnitude_correct_fraction_50_Azithromycin <- sum(significant_species$Predicted_magnitude_correct) / nrow(significant_species)
predicted_magnitude_correct_fraction_50_Azithromycin

predicted_magnitude_correct_fraction_50_Azithromycin_NULL <- sum(significant_species_NULL$Predicted_magnitude_correct) / nrow(significant_species_NULL)
predicted_magnitude_correct_fraction_50_Azithromycin_NULL


top_species_missing_50_Azithromycin <- setdiff(top6_real_50_Azithromycin_means, top6_predicted_50_Azithromycin_means)
top_species_wrong_50_Azithromycin <- setdiff(top6_predicted_50_Azithromycin_means, top6_real_50_Azithromycin_means)

Prediction_quality_50_Azithromycin <- data.frame(
  Top_six_correct = paste(top_six_correct_50_Azithromycin, sep=""),
  Top_six_correct_NULL = paste(top_six_correct_50_Azithromycin_NULL, sep=""),
  Top_six_correct_means = paste(top_six_correct_50_Azithromycin_means, sep=""),
  Top_six_correct_means_NULL = paste(top_six_correct_50_Azithromycin_means_NULL, sep=""),
  Predicted_magnitude_correct = paste(round(predicted_magnitude_correct_fraction_50_Azithromycin * 100, 2), "%", sep=""),
  Predicted_magnitude_correct_NULL = paste(round(predicted_magnitude_correct_fraction_50_Azithromycin_NULL * 100, 2), "%", sep=""),
  survivors_total = survivors_50_Azithromycin,
  top_species_missing <- top_species_missing_50_Azithromycin,
  top_species_wrong <- top_species_wrong_50_Azithromycin, 
  predicted_mean_final_OD <- predicted_mean_final_od_50_Azithromycin,
  real_mean_final_OD <- real_mean_final_od_50_Azithromycin,
  sims_total = length(successful_sim_ids)
)

Prediction_quality_50_Azithromycin










##beta_estradiol_17_valerate

combined_monoculture_aucs2_beta_estradiol_17_valerate <- subset(combined_monoculture_aucs2, drug == "beta-estradiol 17-valerate")


#drug sensitivity terms: define once outside of ODEs
y_function_B_vulgatus_beta_estradiol_17_valerate <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("B_vulgatus", "beta-estradiol 17-valerate", best_fitting_models_df_beta_estradiol_17_valerate)), collapse = " ")))
y_function_B_uniformis_beta_estradiol_17_valerate <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("B_uniformis", "beta-estradiol 17-valerate", best_fitting_models_df_beta_estradiol_17_valerate)), collapse = " ")))
y_function_B_fragilis_beta_estradiol_17_valerate <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("B_fragilis", "beta-estradiol 17-valerate", best_fitting_models_df_beta_estradiol_17_valerate)), collapse = " ")))
y_function_B_thetaiotaomicron_beta_estradiol_17_valerate <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("B_thetaiotaomicron", "beta-estradiol 17-valerate", best_fitting_models_df_beta_estradiol_17_valerate)), collapse = " ")))
y_function_C_ramosum_beta_estradiol_17_valerate <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("C_ramosum", "beta-estradiol 17-valerate", best_fitting_models_df_beta_estradiol_17_valerate)), collapse = " ")))
y_function_E_rectale_beta_estradiol_17_valerate <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("E_rectale", "beta-estradiol 17-valerate", best_fitting_models_df_beta_estradiol_17_valerate)), collapse = " ")))
y_function_R_intestinalis_beta_estradiol_17_valerate <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("R_intestinalis", "beta-estradiol 17-valerate", best_fitting_models_df_beta_estradiol_17_valerate)), collapse = " ")))
y_function_V_parvula_beta_estradiol_17_valerate <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("V_parvula", "beta-estradiol 17-valerate", best_fitting_models_df_beta_estradiol_17_valerate)), collapse = " ")))
y_function_E_lenta_beta_estradiol_17_valerate <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("E_lenta", "beta-estradiol 17-valerate", best_fitting_models_df_beta_estradiol_17_valerate)), collapse = " ")))
y_function_F_nucleatum_beta_estradiol_17_valerate <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("F_nucleatum", "beta-estradiol 17-valerate", best_fitting_models_df_beta_estradiol_17_valerate)), collapse = " ")))
y_function_C_bolteae_beta_estradiol_17_valerate <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("C_bolteae", "beta-estradiol 17-valerate", best_fitting_models_df_beta_estradiol_17_valerate)), collapse = " ")))
y_function_C_perfringens_beta_estradiol_17_valerate <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("C_perfringens", "beta-estradiol 17-valerate", best_fitting_models_df_beta_estradiol_17_valerate)), collapse = " ")))
y_function_C_saccharolyticum_beta_estradiol_17_valerate <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("C_saccharolyticum", "beta-estradiol 17-valerate", best_fitting_models_df_beta_estradiol_17_valerate)), collapse = " ")))
y_function_S_salivarius_beta_estradiol_17_valerate <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("S_salivarius", "beta-estradiol 17-valerate", best_fitting_models_df_beta_estradiol_17_valerate)), collapse = " ")))
y_function_R_gnavus_beta_estradiol_17_valerate <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("R_gnavus", "beta-estradiol 17-valerate", best_fitting_models_df_beta_estradiol_17_valerate)), collapse = " ")))
y_function_C_comes_beta_estradiol_17_valerate <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("C_comes", "beta-estradiol 17-valerate", best_fitting_models_df_beta_estradiol_17_valerate)), collapse = " ")))
y_function_P_merdae_beta_estradiol_17_valerate <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("P_merdae", "beta-estradiol 17-valerate", best_fitting_models_df_beta_estradiol_17_valerate)), collapse = " ")))
y_function_S_parasanguinis_beta_estradiol_17_valerate <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("S_parasanguinis", "beta-estradiol 17-valerate", best_fitting_models_df_beta_estradiol_17_valerate)), collapse = " ")))
y_function_C_aerofaciens_beta_estradiol_17_valerate <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("C_aerofaciens", "beta-estradiol 17-valerate", best_fitting_models_df_beta_estradiol_17_valerate)), collapse = " ")))
y_function_D_formicigenerans_beta_estradiol_17_valerate <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("D_formicigenerans", "beta-estradiol 17-valerate", best_fitting_models_df_beta_estradiol_17_valerate)), collapse = " ")))
y_function_E_coli_beta_estradiol_17_valerate <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("E_coli", "beta-estradiol 17-valerate", best_fitting_models_df_beta_estradiol_17_valerate)), collapse = " ")))



y_function_B_vulgatus_beta_estradiol_17_valerate_func <- eval(parse(text = paste("function(Drug) {", y_function_B_vulgatus_beta_estradiol_17_valerate, "}")))
y_function_B_uniformis_beta_estradiol_17_valerate_func <- eval(parse(text = paste("function(Drug) {", y_function_B_uniformis_beta_estradiol_17_valerate, "}")))
y_function_B_fragilis_beta_estradiol_17_valerate_func <- eval(parse(text = paste("function(Drug) {", y_function_B_fragilis_beta_estradiol_17_valerate, "}")))
y_function_B_thetaiotaomicron_beta_estradiol_17_valerate_func <- eval(parse(text = paste("function(Drug) {", y_function_B_thetaiotaomicron_beta_estradiol_17_valerate, "}")))
y_function_C_ramosum_beta_estradiol_17_valerate_func <- eval(parse(text = paste("function(Drug) {", y_function_C_ramosum_beta_estradiol_17_valerate, "}")))
y_function_E_rectale_beta_estradiol_17_valerate_func <- eval(parse(text = paste("function(Drug) {", y_function_E_rectale_beta_estradiol_17_valerate, "}")))
y_function_R_intestinalis_beta_estradiol_17_valerate_func <- eval(parse(text = paste("function(Drug) {", y_function_R_intestinalis_beta_estradiol_17_valerate, "}")))
y_function_E_lenta_beta_estradiol_17_valerate_func <- eval(parse(text = paste("function(Drug) {", y_function_E_lenta_beta_estradiol_17_valerate, "}")))
y_function_F_nucleatum_beta_estradiol_17_valerate_func <- eval(parse(text = paste("function(Drug) {", y_function_F_nucleatum_beta_estradiol_17_valerate, "}")))
y_function_C_bolteae_beta_estradiol_17_valerate_func <- eval(parse(text = paste("function(Drug) {", y_function_C_bolteae_beta_estradiol_17_valerate, "}")))
y_function_C_perfringens_beta_estradiol_17_valerate_func <- eval(parse(text = paste("function(Drug) {", y_function_C_perfringens_beta_estradiol_17_valerate, "}")))
y_function_C_saccharolyticum_beta_estradiol_17_valerate_func <- eval(parse(text = paste("function(Drug) {", y_function_C_saccharolyticum_beta_estradiol_17_valerate, "}")))
y_function_S_salivarius_beta_estradiol_17_valerate_func <- eval(parse(text = paste("function(Drug) {", y_function_S_salivarius_beta_estradiol_17_valerate, "}")))
y_function_R_gnavus_beta_estradiol_17_valerate_func <- eval(parse(text = paste("function(Drug) {", y_function_R_gnavus_beta_estradiol_17_valerate, "}")))
y_function_C_comes_beta_estradiol_17_valerate_func <- eval(parse(text = paste("function(Drug) {", y_function_C_comes_beta_estradiol_17_valerate, "}")))
y_function_P_merdae_beta_estradiol_17_valerate_func <- eval(parse(text = paste("function(Drug) {", y_function_P_merdae_beta_estradiol_17_valerate, "}")))
y_function_S_parasanguinis_beta_estradiol_17_valerate_func <- eval(parse(text = paste("function(Drug) {", y_function_S_parasanguinis_beta_estradiol_17_valerate, "}")))
y_function_C_aerofaciens_beta_estradiol_17_valerate_func <- eval(parse(text = paste("function(Drug) {", y_function_C_aerofaciens_beta_estradiol_17_valerate, "}")))
y_function_D_formicigenerans_beta_estradiol_17_valerate_func <- eval(parse(text = paste("function(Drug) {", y_function_D_formicigenerans_beta_estradiol_17_valerate, "}")))
y_function_E_coli_beta_estradiol_17_valerate_func <- eval(parse(text = paste("function(Drug) {", y_function_E_coli_beta_estradiol_17_valerate, "}")))
y_function_V_parvula_beta_estradiol_17_valerate_func <- eval(parse(text = paste("function(Drug) {", y_function_V_parvula_beta_estradiol_17_valerate, "}")))



unique(combined_monoculture_aucs2_beta_estradiol_17_valerate$conc)
##dictate drug concentration tested for simulation cycle here:
#drug_concentration_tested <- 5 #if manually or:
drug_concentration_tested <- unique(combined_monoculture_aucs2_beta_estradiol_17_valerate$conc)[1] 
initial_conditions <- rep(0.01/32, 32)
initial_conditions <- c(initial_conditions, drug_concentration_tested)


##drug effect fitted for species showing sensitivity in monoculture:
#unique(combined_monoculture_aucs2_beta_estradiol_17_valerate$Species)

##for more simple linear fits
closed.sir.model_beta_estradiol_17_valerate <- function (t, x, params) {
  ## first extract the state variables
  A_muciniphila <- x[1]
  B_adolescentis <- x[2]
  B_fragilis <- x[3]
  B_longum <- x[4]
  B_obeum <- x[5]
  B_thetaiotaomicron <- x[6]
  B_uniformis <- x[7]
  B_vulgatus <- x[8]
  B_wadsworthia <- x[9]
  C_aerofaciens <- x[10]
  C_bolteae <- x[11]
  C_comes <- x[12]
  C_perfringens <- x[13]
  C_ramosum <- x[14]
  C_saccharolyticum <- x[15]
  D_formicigenerans <- x[16]
  E_coli <- x[17]
  E_lenta <- x[18]
  E_rectale <- x[19]
  F_nucleatum <- x[20]
  L_paracasei <- x[21]
  O_splanchnicus <- x[22]
  P_copri <- x[23]
  P_distasonis <- x[24]
  P_merdae <- x[25]
  R_bromii <- x[26]
  R_gnavus <- x[27]
  R_intestinalis <- x[28]
  R_torques <- x[29]
  S_parasanguinis <- x[30]
  S_salivarius <- x[31]
  V_parvula <- x[32]
  Drug <- x[33]
  
  
  ## now extract the parameters
  r_B_fragilis <- flat_params[["B._fragilis.r"]]
  K_B_fragilis <- flat_params[["B._fragilis.K"]]
  r_B_longum <- flat_params[["B._longum.r"]]
  K_B_longum <- flat_params[["B._longum.K"]]
  r_B_thetaiotaomicron <- flat_params[["B._thetaiotaomicron.r"]]
  K_B_thetaiotaomicron <- flat_params[["B._thetaiotaomicron.K"]]
  r_B_uniformis <- flat_params[["B._uniformis.r"]]
  K_B_uniformis <- flat_params[["B._uniformis.K"]]
  r_B_vulgatus <- flat_params[["B._vulgatus.r"]]
  K_B_vulgatus <- flat_params[["B._vulgatus.K"]]
  r_B_wadsworthia <- flat_params[["B._wadsworthia.r"]]
  K_B_wadsworthia <- flat_params[["B._wadsworthia.K"]]
  r_C_aerofaciens <- flat_params[["C._aerofaciens.r"]]
  K_C_aerofaciens <- flat_params[["C._aerofaciens.K"]]
  r_C_bolteae <- flat_params[["C._bolteae.r"]]
  K_C_bolteae <- flat_params[["C._bolteae.K"]]
  r_C_comes <- flat_params[["C._comes.r"]]
  K_C_comes <- flat_params[["C._comes.K"]]
  r_C_perfringens <- flat_params[["C._perfringens.r"]]
  K_C_perfringens <- flat_params[["C._perfringens.K"]]
  r_C_ramosum <- flat_params[["C._ramosum.r"]]
  K_C_ramosum <- flat_params[["C._ramosum.K"]]
  r_C_saccharolyticum <- flat_params[["C._saccharolyticum.r"]]
  K_C_saccharolyticum <- flat_params[["C._saccharolyticum.K"]]
  r_D_formicigenerans <- flat_params[["D._formicigenerans.r"]]
  K_D_formicigenerans <- flat_params[["D._formicigenerans.K"]]
  r_E_coli <- flat_params[["E._coli.r"]]
  K_E_coli <- flat_params[["E._coli.K"]]
  r_E_lenta <- flat_params[["E._lenta.r"]]
  K_E_lenta <- flat_params[["E._lenta.K"]]
  r_E_rectale <- flat_params[["E._rectale.r"]]
  K_E_rectale <- flat_params[["E._rectale.K"]]
  r_F_nucleatum <- flat_params[["F._nucleatum.r"]]
  K_F_nucleatum <- flat_params[["F._nucleatum.K"]]
  r_P_copri <- flat_params[["P._copri.r"]]
  K_P_copri <- flat_params[["P._copri.K"]]
  r_P_merdae <- flat_params[["P._merdae.r"]]
  K_P_merdae <- flat_params[["P._merdae.K"]]
  r_R_gnavus <- flat_params[["R._gnavus.r"]]
  K_R_gnavus <- flat_params[["R._gnavus.K"]]
  r_R_intestinalis <- flat_params[["R._intestinalis.r"]]
  K_R_intestinalis <- flat_params[["R._intestinalis.K"]]
  r_V_parvula <- flat_params[["V._parvula.r"]]
  K_V_parvula <- flat_params[["V._parvula.K"]]
  r_A_muciniphila <- flat_params[["A._muciniphila.r"]]
  K_A_muciniphila <- flat_params[["A._muciniphila.K"]]
  r_B_adolescentis <- flat_params[["B._adolescentis.r"]]
  K_B_adolescentis <- flat_params[["B._adolescentis.K"]]
  r_B_obeum <- flat_params[["B._obeum.r"]]
  K_B_obeum <- flat_params[["B._obeum.K"]]
  r_O_splanchnicus <- flat_params[["O._splanchnicus.r"]]
  K_O_splanchnicus <- flat_params[["O._splanchnicus.K"]]
  r_P_distasonis <- flat_params[["P._distasonis.r"]]
  K_P_distasonis <- flat_params[["P._distasonis.K"]]
  r_R_bromii <- flat_params[["R._bromii.r"]]
  K_R_bromii <- flat_params[["R._bromii.K"]]
  r_R_torques <- flat_params[["R._torques.r"]]
  K_R_torques <- flat_params[["R._torques.K"]]
  r_S_parasanguinis <- flat_params[["S._parasanguinis.r"]]
  K_S_parasanguinis <-flat_params[["S._parasanguinis.K"]]
  r_S_salivarius <- flat_params[["S._salivarius.r"]]
  K_S_salivarius <- flat_params[["S._salivarius.K"]]
  r_L_paracasei <- flat_params[["L._paracasei.r"]]
  K_L_paracasei <- flat_params[["L._paracasei.K"]]
  
  
  t_mod <- ifelse(t > 24.1, t - 24.1, t)
  
  
  ## now code the model equations
  dA_muciniphila_dt <- r_A_muciniphila * A_muciniphila * (1 - A_muciniphila / K_A_muciniphila)
  dB_adolescentis_dt <- r_B_adolescentis * B_adolescentis * (1 - B_adolescentis / K_B_adolescentis)
  dB_fragilis_dt <- r_B_fragilis * B_fragilis * (1 - B_fragilis / max(0.0001, K_B_fragilis * (y_function_B_fragilis_beta_estradiol_17_valerate_func(Drug))))
  dB_longum_dt <- r_B_longum * B_longum * (1 - B_longum / K_B_longum)
  dB_obeum_dt <- r_B_obeum * B_obeum * (1 - B_obeum / K_B_obeum)
  dB_thetaiotaomicron_dt <- r_B_thetaiotaomicron * B_thetaiotaomicron * (1 - B_thetaiotaomicron / max(0.0001, K_B_thetaiotaomicron * (y_function_B_thetaiotaomicron_beta_estradiol_17_valerate_func(Drug))))  
  dB_uniformis_dt <- r_B_uniformis * B_uniformis * (1 - B_uniformis / max(0.0001, K_B_uniformis * (y_function_B_uniformis_beta_estradiol_17_valerate_func(Drug))))
  dB_vulgatus_dt <- r_B_vulgatus * B_vulgatus * (1 - B_vulgatus / max(0.0001, K_B_vulgatus * (y_function_B_vulgatus_beta_estradiol_17_valerate_func(Drug))))
  dB_wadsworthia_dt <- r_B_wadsworthia * B_wadsworthia * (1 - B_wadsworthia / K_B_wadsworthia)
  dC_aerofaciens_dt <- r_C_aerofaciens * C_aerofaciens * (1 - C_aerofaciens / max(0.0001, K_C_aerofaciens * (y_function_C_aerofaciens_beta_estradiol_17_valerate_func(Drug))))
  dC_bolteae_dt <- r_C_bolteae * C_bolteae * (1 - C_bolteae /  max(0.0001, K_C_bolteae * (y_function_C_bolteae_beta_estradiol_17_valerate_func(Drug))))
  dC_comes_dt <- r_C_comes * C_comes * (1 - C_comes / max(0.0001, K_C_comes * (y_function_C_comes_beta_estradiol_17_valerate_func(Drug))))
  dC_perfringens_dt <- r_C_perfringens * C_perfringens * (1 - C_perfringens / max(0.0001, K_C_perfringens * (y_function_C_perfringens_beta_estradiol_17_valerate_func(Drug))))
  dC_ramosum_dt <- r_C_ramosum * C_ramosum * (1 - C_ramosum / max(0.0001, K_C_ramosum * (y_function_C_ramosum_beta_estradiol_17_valerate_func(Drug))))
  dC_saccharolyticum_dt <- r_C_saccharolyticum * C_saccharolyticum * (1 - C_saccharolyticum / max(0.0001, K_C_saccharolyticum * (y_function_C_saccharolyticum_beta_estradiol_17_valerate_func(Drug))))
  dD_formicigenerans_dt <- r_D_formicigenerans * D_formicigenerans * (1 - D_formicigenerans / max(0.0001, K_D_formicigenerans * (y_function_D_formicigenerans_beta_estradiol_17_valerate_func(Drug))))
  dE_coli_dt <- r_E_coli * E_coli * (1 - E_coli / max(0.0001, K_E_coli * (y_function_E_coli_beta_estradiol_17_valerate_func(Drug))))
  dE_lenta_dt <- r_E_lenta * E_lenta * (1 - E_lenta / max(0.0001, K_E_lenta * (y_function_E_lenta_beta_estradiol_17_valerate_func(Drug))))
  dE_rectale_dt <- r_E_rectale * E_rectale * (1 - E_rectale / max(0.0001, K_E_rectale * (y_function_E_rectale_beta_estradiol_17_valerate_func(Drug))))
  dF_nucleatum_dt <- r_F_nucleatum * F_nucleatum * (1 - F_nucleatum / max(0.0001, K_F_nucleatum * (y_function_F_nucleatum_beta_estradiol_17_valerate_func(Drug))))
  dL_paracasei_dt <- r_L_paracasei * L_paracasei * (1 - L_paracasei / K_L_paracasei)  
  dO_splanchnicus_dt <- r_O_splanchnicus * O_splanchnicus * (1 - O_splanchnicus / K_O_splanchnicus)  
  dP_copri_dt <- r_P_copri * P_copri * (1 - P_copri / K_P_copri)
  dP_distasonis_dt <- r_P_distasonis * P_distasonis * (1 - P_distasonis / K_P_distasonis)  
  dP_merdae_dt <- r_P_merdae * P_merdae * (1 - P_merdae / max(0.0001, K_P_merdae * (y_function_P_merdae_beta_estradiol_17_valerate_func(Drug))))
  dR_bromii_dt <- r_R_bromii * R_bromii * (1 - R_bromii / K_R_bromii) 
  dR_gnavus_dt <- r_R_gnavus * R_gnavus * (1 - R_gnavus / max(0.0001, K_R_gnavus * (y_function_R_gnavus_beta_estradiol_17_valerate_func(Drug))))
  dR_intestinalis_dt <- r_R_intestinalis * R_intestinalis * (1 - R_intestinalis / max(0.0001, K_R_intestinalis * (y_function_R_intestinalis_beta_estradiol_17_valerate_func(Drug))))
  dR_torques_dt <- r_R_torques * R_torques * (1 - R_torques /K_R_torques) 
  dS_parasanguinis_dt <- r_S_parasanguinis * S_parasanguinis * (1 - S_parasanguinis / max(0.0001, K_S_parasanguinis * (y_function_S_parasanguinis_beta_estradiol_17_valerate_func(Drug))))
  dS_salivarius_dt <- r_S_salivarius * S_salivarius * (1 - S_salivarius / max(0.0001, K_S_salivarius * (y_function_S_salivarius_beta_estradiol_17_valerate_func(Drug))))
  dV_parvula_dt <- r_V_parvula * V_parvula * (1 - V_parvula / max(0.0001, K_V_parvula * (y_function_V_parvula_beta_estradiol_17_valerate_func(Drug))))
  
  
  
  #Drug differential (no metabolomics for this drug):
  dDrug_dt <- (mean(drug_dynamics$Steepness_param_community) * exp(-mean(drug_dynamics$Steepness_param_community) * t_mod)) * (drug_concentration_tested * prop_left_beta_estradiol_17_valerate - drug_concentration_tested)
  #dDrug_dt <- 0
  
  ## Combine results into a single vector
  dxdt <- c(dA_muciniphila_dt, dB_adolescentis_dt, dB_fragilis_dt, dB_longum_dt, dB_obeum_dt, dB_thetaiotaomicron_dt, dB_uniformis_dt, dB_vulgatus_dt, dB_wadsworthia_dt, dC_aerofaciens_dt, dC_bolteae_dt, dC_comes_dt, dC_perfringens_dt, dC_ramosum_dt, dC_saccharolyticum_dt, dD_formicigenerans_dt, dE_coli_dt, dE_lenta_dt, dE_rectale_dt, dF_nucleatum_dt, dL_paracasei_dt, dO_splanchnicus_dt, dP_copri_dt, dP_distasonis_dt, dP_merdae_dt, dR_bromii_dt, dR_gnavus_dt, dR_intestinalis_dt, dR_torques_dt, dS_parasanguinis_dt, dS_salivarius_dt, dV_parvula_dt, dDrug_dt)
  
  ## Return result as a list
  list(dxdt)
}




#calculate the co-culture correction factor per species based on community composition in absence of drug, just like done for Niclosamide

growth_data_all_0_Niclosamide
growth_data_all_0_Niclosamide1 <- growth_data_all_0_Niclosamide %>%
  dplyr::mutate(Species = gsub(" ", "_", Species))


# Merge rel_ab_control with growth_data_all_0_Niclosamide on Species
# Function to remove duplicated columns by name pattern
clean_columns_base <- function(df, pattern) {
  cols_to_keep <- !grepl(pattern, names(df))
  df <- df[, cols_to_keep]
  return(df)
}

# Use the new function to clean up your dataframe
rel_ab_control <- clean_columns_base(rel_ab_control, "mean_max_OD.[xy]")
str(rel_ab_control)


#rel_ab_control$correction_factor <- rel_ab_control$mean_rel_ab / (rel_ab_control$mean_max_OD/sum(rel_ab_control$mean_max_OD))
# Calculate correction factor with a minimum value of ~1
rel_ab_control$correction_factor <- pmax(rel_ab_control$mean_rel_ab / (rel_ab_control$mean_max_OD / sum(rel_ab_control$mean_max_OD)), 1.1)


# Create a new dataframe for co-culture correction
co_culture_correction <- data.frame(
  species = rel_ab_control$Species,
  correction_factor = rel_ab_control$correction_factor
)


#summarise community data
#Adjust based on tested concentrations for each drug
unique(Community_compositions_focus_drugs_beta_estradiol_17_valerate$concentration)

Community_compositions_focus_drugs_beta_estradiol_17_valerate_5uM <- subset(Community_compositions_focus_drugs_beta_estradiol_17_valerate, concentration == 5)
Community_compositions_focus_drugs_beta_estradiol_17_valerate_20uM <- subset(Community_compositions_focus_drugs_beta_estradiol_17_valerate, concentration == 20)
Community_compositions_focus_drugs_beta_estradiol_17_valerate_80uM <- subset(Community_compositions_focus_drugs_beta_estradiol_17_valerate, concentration == 80)


#5 uM
Community_compositions_focus_drugs_beta_estradiol_17_valerate_5uM_summarised <- Community_compositions_focus_drugs_beta_estradiol_17_valerate_5uM %>%
  dplyr::group_by(species) %>%                                  
  dplyr::summarize(
    mean_rel_ab = mean(rel_abundance, na.rm = TRUE),     
    sd_rel_ab = sd(rel_abundance, na.rm = TRUE) ,
    mean_max_OD = mean(maxOD, na.rm = TRUE),
    sd_max_OD = sd(maxOD, na.rm = TRUE),
    mean_final_OD = mean(finalOD, na.rm = TRUE),
    sd_final_OD = sd(finalOD, na.rm = TRUE)
  ) %>%
  dplyr::ungroup() 


Community_compositions_focus_drugs_beta_estradiol_17_valerate_5uM_summarised <- Community_compositions_focus_drugs_beta_estradiol_17_valerate_5uM_summarised %>%
  dplyr::mutate(Species = sub("^(\\w)\\w*\\s(.*)", "\\1._\\2", species))

#remove (sub)strain info
Community_compositions_focus_drugs_beta_estradiol_17_valerate_5uM_summarised <- Community_compositions_focus_drugs_beta_estradiol_17_valerate_5uM_summarised %>%
  dplyr::mutate(Species = sub("^(\\w\\._\\w+).*", "\\1", Species))


#20 uM
Community_compositions_focus_drugs_beta_estradiol_17_valerate_20uM_summarised <- Community_compositions_focus_drugs_beta_estradiol_17_valerate_20uM %>%
  dplyr::group_by(species) %>%                                  
  dplyr::summarize(
    mean_rel_ab = mean(rel_abundance, na.rm = TRUE),     
    sd_rel_ab = sd(rel_abundance, na.rm = TRUE) ,
    mean_max_OD = mean(maxOD, na.rm = TRUE),
    sd_max_OD = sd(maxOD, na.rm = TRUE),
    mean_final_OD = mean(finalOD, na.rm = TRUE),
    sd_final_OD = sd(finalOD, na.rm = TRUE)
  ) %>%
  dplyr::ungroup() 


Community_compositions_focus_drugs_beta_estradiol_17_valerate_20uM_summarised <- Community_compositions_focus_drugs_beta_estradiol_17_valerate_20uM_summarised %>%
  dplyr::mutate(Species = sub("^(\\w)\\w*\\s(.*)", "\\1._\\2", species))

#remove (sub)strain info
Community_compositions_focus_drugs_beta_estradiol_17_valerate_20uM_summarised <- Community_compositions_focus_drugs_beta_estradiol_17_valerate_20uM_summarised %>%
  dplyr::mutate(Species = sub("^(\\w\\._\\w+).*", "\\1", Species))


#80 uM
Community_compositions_focus_drugs_beta_estradiol_17_valerate_80uM_summarised <- Community_compositions_focus_drugs_beta_estradiol_17_valerate_80uM %>%
  dplyr::group_by(species) %>%                                  
  dplyr::summarize(
    mean_rel_ab = mean(rel_abundance, na.rm = TRUE),     
    sd_rel_ab = sd(rel_abundance, na.rm = TRUE) ,
    mean_max_OD = mean(maxOD, na.rm = TRUE),
    sd_max_OD = sd(maxOD, na.rm = TRUE),    
    mean_final_OD = mean(finalOD, na.rm = TRUE),
    sd_final_OD = sd(finalOD, na.rm = TRUE)
  ) %>%
  dplyr::ungroup() 



Community_compositions_focus_drugs_beta_estradiol_17_valerate_80uM_summarised <- Community_compositions_focus_drugs_beta_estradiol_17_valerate_80uM_summarised %>%
  dplyr::mutate(Species = sub("^(\\w)\\w*\\s(.*)", "\\1._\\2", species))

#remove (sub)strain info
Community_compositions_focus_drugs_beta_estradiol_17_valerate_80uM_summarised <- Community_compositions_focus_drugs_beta_estradiol_17_valerate_80uM_summarised %>%
  dplyr::mutate(Species = sub("^(\\w\\._\\w+).*", "\\1", Species))


#Initialise data frames
sim_output <- data.frame()
input_params_list <- list() #Use a list to collect parameters for each simulation

#number of simulations
num_sims <- 500


for (i in 1:num_sims) {
  tryCatch({
    # generate model parameters
    set.seed(i) #set a different seed for each simulation for variation
    params <- lapply(1:nrow(growth_data_all_0_Niclosamide), function(idx) {
      species_params <- growth_data_all_0_Niclosamide[idx, ]
      list(
        r = rnorm(1, mean = species_params$mean_max_Growth_rate, sd = species_params$sd_max_Growth_rate),
        K = rnorm(1, mean = species_params$mean_max_OD, sd = species_params$sd_max_OD)
      )
    })
    names(params) <- gsub(" ", "_", growth_data_all_0_Niclosamide$Species)
    flat_params <- unlist(params)
    names(flat_params) <- gsub("\\.\\d$", "", names(flat_params))
    
    #replace spaces with underscores to match formatting
    co_culture_correction$species <- gsub(" ", "_", co_culture_correction$species, fixed = TRUE)
    
    #replace the species-specific K parameters extracted from monoculture growth data 
    #with drawn relative abundance values at Niclosamide = 0, scaled to K
    rel_ab_control$Species <- gsub(" ", "_", rel_ab_control$Species)
    
    #Initialise an empty vector to store drawn values
    drawn_values <- numeric(nrow(rel_ab_control))
    
    #draw values from their respective distributions
    for (k in 1:nrow(rel_ab_control)) {
      species_name <- rel_ab_control$Species[k]
      drawn_value <- rnorm(1, mean = rel_ab_control$mean_rel_ab[k], sd = rel_ab_control$sd_rel_ab[k])
      drawn_values[k] <- max(drawn_value, 0)  # Ensure no negative values
    }
    
    #Normalise drawn relative abundance values so they sum to 1 (to reflect a 'true' relative abundance distribution)
    #this is needed so when we convert the values into OD units by multiplying with the drawn community maxOD,
    # the sum of K_i parameters and the drawn K are equal
    normalised_values <- drawn_values / sum(drawn_values)
    
    #Pull community maxOD (K) at 0 drugs from respective normal distribution:
    K <- rnorm(n = 1, mean = rel_ab_control$mean_com_max_OD[1], sd = rel_ab_control$sd_com_max_OD[1])
    
    # Assign these normalised values to their respective species' .K parameters
    for (k in 1:nrow(rel_ab_control)) {
      species_name <- rel_ab_control$Species[k]
      k_index <- grep(paste0("^", species_name, "\\.K$"), names(flat_params))
      
      if (length(k_index) > 0) {
        old_value <- flat_params[k_index]
        flat_params[k_index] <- (normalised_values[k] + 0.0001) * K #add small value in case drawn K_i is 0, which would cause issues with the solver
        cat(sprintf("Updated %s from %f to %f using normalised value %f scaled by K %f\n", names(flat_params)[k_index], old_value, flat_params[k_index], normalised_values[k], K))
      }
    }
    
    #Accounting for variation in drug degradation by community, with standard deviation of end concentration (at 10h) around the fitted predicted (relative) end concentration at 24h
    #This drug (beta_estradiol_17_valerate) does not have metabolomics data available.
    #Taking averages of degradation and variability thereof observed across all 27 drugs that did have metabolomics data
    #prop_left_beta_estradiol_17_valerate <- abs(rnorm(1, mean(drug_dynamics$Prop_left_24h_community), mean(drug_dynamics$SD_drug_community))) 
    prop_left_beta_estradiol_17_valerate <- runif(1, min(drug_dynamics$Prop_left_24h_community), max(drug_dynamics$Prop_left_24h_community))
    
    #loop through each species in co_culture_correction
    for (j in 1:nrow(co_culture_correction)) {
      # Extract the species name and correction factor
      species_name <- co_culture_correction$species[j]
      correction_factor <- co_culture_correction$correction_factor[j]
      
      # Identify the corresponding growth rate parameter in flat_params
      #by matching the base species name (without .r)
      growth_rate_indices <- grep(paste0("^", species_name, "\\.r$"), names(flat_params))
      
      #take the growth rate parameter and apply the correction factor 
      for (index in growth_rate_indices) {
        flat_params[index] <- flat_params[index] * correction_factor
      }
    }
    
    flat_params
    # Store parameters for each simulation
    input_params_list[[i]] <- c(sim_ID = i, flat_params)
    
    # Run the model for the first 24-hour cycle
    solution_cycle_1 <- ode(y = initial_conditions, times = seq(from = 0, to = 24, by = 0.1), func = closed.sir.model_beta_estradiol_17_valerate, parms = flat_params,   method = "lsoda", rtol = 1e-6, atol = 1e-6)
    
    # Dilution and second cycle
    end_of_cycle_1 <- solution_cycle_1[nrow(solution_cycle_1), -1]
    initial_conditions_cycle_2 <- end_of_cycle_1 / 50
    #accounting for the drugs being added with the new growth cycle as well:
    initial_conditions_cycle_2[33] <- initial_conditions_cycle_2[33] + drug_concentration_tested
    solution_cycle_2 <- ode(y = initial_conditions_cycle_2, times = seq(from = 24, to = 48, by = 0.1), func = closed.sir.model_beta_estradiol_17_valerate, parms = flat_params,  method = "lsoda", rtol = 1e-6, atol = 1e-6)
    
    # Combine and format results
    combined_solution <- rbind(as.data.frame(solution_cycle_1), as.data.frame(solution_cycle_2)[-1,])
    combined_solution$sim_ID <- rep(i, nrow(combined_solution))
    combined_solution <- combined_solution %>%
      tidyr::gather(key = "Species", value = "Density", -time, -sim_ID) %>%
      dplyr::mutate(Hour = time) %>%
      dplyr::select(sim_ID, Hour, Species, Density)
    
    ##Append to sim_output
    sim_output <- rbind(sim_output, combined_solution)
  }, error = function(e) {
    cat(sprintf("Skipping simulation %d due to an error: %s\n", i, e$message))
  })
}



##Combine all parameter data into a single dataframe
input_params <- do.call(rbind, input_params_list)

# Add a "Species" column 
sim_output$Species_name <- species_names[as.numeric(as.character(sim_output$Species))]
sim_output$Species_name <- replace_na(sim_output$Species_name, "Drug")

#View(input_params)
#View(sim_output)

sim_output <- na.omit(sim_output)
successful_sim_ids <- unique(subset(sim_output, Hour == 48)$sim_ID)
length(successful_sim_ids)
sim_output1 <- sim_output[sim_output$sim_ID %in% successful_sim_ids, ]


#Transform sim_output so we have wide format by Species
sim_output_wide <- tidyr::pivot_wider(sim_output1, 
                                      names_from = Species_name, 
                                      values_from = Density,
                                      id_cols = c(sim_ID, Hour))

length(unique(sim_output_wide$sim_ID))
#calc community OD per timepoint
sim_output_wide$Total_OD <- rowSums(sim_output_wide[, 3:34], na.rm = TRUE)
#calculate and add relative abundances here as well:
species_columns <- colnames(sim_output_wide)[3:34] 

for (species in species_columns) {
  sim_output_wide[[paste0("rel_", species)]] <- sim_output_wide[[species]] / sim_output_wide$Total_OD
}


#assign sim_output_wide test conditions to dataframe name
drug_tested <- "beta_estradiol_17_valerate"
variable_name_1 <- paste0("sim_output_wide_", ifelse(drug_concentration_tested == 1e-04, 0, drug_concentration_tested), "_", drug_tested)
assign(variable_name_1, sim_output_wide)

#turn back into long format if interested in plotting relative abundances
cols_needed <- c("sim_ID", "Hour")

sim_output_long <- sim_output_wide %>% 
  dplyr::select(sim_ID, Hour, Drug, starts_with("rel_")) %>% 
  tidyr::pivot_longer(
    cols = c(Drug, starts_with("rel_")),
    names_to = "Species", 
    values_to = "Relative_abundance",
    names_prefix = "rel_",
    names_transform = list(Species = ~ ifelse(.x == "Drug", "Drug", .x))
  ) 

str(sim_output_long)


species_names_1 <- c(
  "A_muciniphila",
  "B_adolescentis",
  "B_fragilis",
  "B_longum",
  "B_obeum",
  "B_thetaiotaomicron",
  "B_uniformis",
  "B_vulgatus",
  "B_wadsworthia",
  "C_aerofaciens",
  "C_bolteae",
  "C_comes",
  "C_perfringens",
  "C_ramosum",
  "C_saccharolyticum",
  "D_formicigenerans",
  "E_coli",
  "E_lenta",
  "E_rectale",
  "F_nucleatum",
  "L_paracasei",
  "O_splanchnicus",
  "P_copri",
  "P_distasonis",
  "P_merdae",
  "R_bromii",
  "R_gnavus",
  "R_intestinalis",
  "R_torques",
  "S_parasanguinis",
  "S_salivarius",
  "V_parvula",
  "Drug"
)

species_colours_1 <- c(
  "A_muciniphila" = "#1f77b4",
  "B_adolescentis" = "#ff7f0e",
  "B_fragilis" = "#2ca02c",
  "B_longum" = "#d62728",
  "B_obeum" = "#9467bd",
  "B_thetaiotaomicron" = "black",
  "B_uniformis" = "#e377c2",
  "B_vulgatus" = "#7f7f7f",
  "B_wadsworthia" = "gold1",
  "C_aerofaciens" = "#aec7e8",
  "C_bolteae" = "#ffbb78",
  "C_comes" = "magenta",
  "C_perfringens" = "#ff9896",
  "C_ramosum" = "#c5b0d5",
  "C_saccharolyticum" = "#c49c94",
  "D_formicigenerans" = "#f7b6d2",
  "E_coli" = "yellow",
  "E_lenta" = "turquoise",
  "E_rectale" = "#393b79",
  "F_nucleatum" = "royalblue2",
  "L_paracasei" = "blue",
  "O_splanchnicus" = "#637939",
  "P_copri" = "cyan",
  "P_distasonis" = "#8c6d31",
  "P_merdae" = "#c7c7c7",
  "R_bromii" = "#e6550d",
  "R_gnavus" = "#e7cb94",
  "R_intestinalis" = "#843c39",
  "R_torques" = "#d6616b",
  "S_parasanguinis" = "orange3",
  "S_salivarius" = "#7b4173",
  "V_parvula" = "#ce6dbd",
  "Drug" = "green"
)



##Plot output for any specific sim:
# ggplot(subset(sim_output, sim_ID == 1 & Species_name != "Drug"), aes(x = Hour, y = Density, group = Species_name, color = Species_name)) +
#   geom_line(size = 1, alpha = 0.7) +
#   scale_color_manual(values = species_colours_1) +
#   labs(title = paste0("beta_estradiol_17_valerate = ", drug_concentration_tested),
#        x = "Time (hours)",
#        y = "Population Density (OD)",
#        color = "Species") +
#   theme_minimal() +
#   theme(legend.position = "right")
# 
# ggplot(subset(sim_output, sim_ID == 3 & Species_name != "Drug"), aes(x = Hour, y = Density, group = Species_name, color = Species_name)) +
#   geom_line(size = 1, alpha = 0.7) +
#   scale_color_manual(values = species_colours_1) +
#   labs(title = paste0("beta_estradiol_17_valerate = ", drug_concentration_tested),
#        x = "Time (hours)",
#        y = "Population Density (OD)",
#        color = "Species") +
#   theme_minimal() +
#   theme(legend.position = "right")


ggplot(subset(sim_output_long, sim_ID == 1), aes(x = Hour, y = Relative_abundance, group = Species, color = Species)) +
  geom_line(size = 1, alpha = 0.7) +
  scale_color_manual(values = species_colours_1) +
  labs(title = paste0("beta_estradiol_17_valerate = ", drug_concentration_tested),
       x = "Time (hours)",
       y = "Relative abundance",
       color = "Species") +
  theme_minimal() +
  theme(legend.position = "right")


ggplot(subset(sim_output_long, sim_ID == 3), aes(x = Hour, y = Relative_abundance, group = Species, color = Species)) +
  geom_line(size = 1, alpha = 0.7) +
  scale_color_manual(values = species_colours_1) +
  labs(title = paste0("beta_estradiol_17_valerate = ", drug_concentration_tested),
       x = "Time (hours)",
       y = "Relative abundance",
       color = "Species") +
  theme_minimal() +
  theme(legend.position = "right")


#calc mean and standard deviation across sims
sim_stats <- sim_output_long %>%
  dplyr::group_by(Hour, Species) %>%
  dplyr::summarise(
    mean_rel_ab = mean(Relative_abundance),
    sd_rel_ab = sd(Relative_abundance),
    .groups = 'drop'
  )

# Prepare the data for plotting
plot_data <- sim_stats %>%
  dplyr::mutate(Upper = mean_rel_ab + sd_rel_ab, Lower = mean_rel_ab - sd_rel_ab)

ggplot(subset(plot_data, Species != "Drug"), aes(x = Hour, y = mean_rel_ab, group = Species, color = Species)) +
  geom_ribbon(aes(ymin = Lower, ymax = Upper, fill = Species), colour = NA, alpha = 0.2) +  
  geom_line(size = 1, alpha = 0.7) + 
  scale_color_manual(values = species_colours_1) +
  scale_fill_manual(values = species_colours_1) +  
  labs(title = "Mean and SD of Relative Abundance Across Simulations",
       subtitle = paste0("beta_estradiol_17_valerate = ", drug_concentration_tested),       
       x = "Time (hours)",
       y = "Relative abundance",
       color = "Species",
       fill = "Species") +
  theme_minimal() +
  theme(legend.position = "right")

#log-scaled mean trends
ggplot(plot_data, aes(x = Hour, y = log10(mean_rel_ab + 0.0001), group = Species, color = Species)) +
  geom_line(size = 1, alpha = 0.7) +  # Mean line
  scale_color_manual(values = species_colours_1) +
  scale_fill_manual(values = species_colours_1) +  # Ensure consistent colors for lines and fills
  labs(title = "Mean and SD of Relative Abundance Across Simulations",
       subtitle = paste0("beta_estradiol_17_valerate = ", drug_concentration_tested),
       x = "Time (hours)",
       y = "Relative abundance",
       color = "Species",
       fill = "Species") +
  theme_minimal() +
  theme(legend.position = "right")




##prediction quality evaluation
drug_tested <- "beta_estradiol_17_valerate"
variable_name <- paste0("plot_data_", ifelse(drug_concentration_tested == 1e-04, 0, drug_concentration_tested), "_", drug_tested)
assign(variable_name, plot_data)


#extract total OD info:
predicted_mean_final_od_NULL <- Niclosamide_16S_0uM_summarised$mean_com_final_OD[1]
predicted_sd_final_od_NULL <- Niclosamide_16S_0uM_summarised$sd_com_final_OD[1]

predicted_mean_final_od_5_beta_estradiol_17_valerate <- mean(subset(sim_output_wide_5_beta_estradiol_17_valerate, Hour == 48)$Total_OD, na.rm = TRUE)
predicted_sd_final_od_5_beta_estradiol_17_valerate <- sd(subset(sim_output_wide_5_beta_estradiol_17_valerate, Hour == 48)$Total_OD, na.rm = TRUE)

real_mean_final_od_5_beta_estradiol_17_valerate <- Community_compositions_focus_drugs_beta_estradiol_17_valerate_5uM_summarised$mean_final_OD[1]
real_sd_final_od_5_beta_estradiol_17_valerate <- Community_compositions_focus_drugs_beta_estradiol_17_valerate_5uM_summarised$sd_final_OD[1]


predicted_mean_final_od_20_beta_estradiol_17_valerate <- mean(subset(sim_output_wide_20_beta_estradiol_17_valerate, Hour == 48)$Total_OD, na.rm = TRUE)
predicted_sd_final_od_20_beta_estradiol_17_valerate <- sd(subset(sim_output_wide_20_beta_estradiol_17_valerate, Hour == 48)$Total_OD, na.rm = TRUE)

real_mean_final_od_20_beta_estradiol_17_valerate <- Community_compositions_focus_drugs_beta_estradiol_17_valerate_20uM_summarised$mean_final_OD[1]
real_sd_final_od_20_beta_estradiol_17_valerate <- Community_compositions_focus_drugs_beta_estradiol_17_valerate_20uM_summarised$sd_final_OD[1]


predicted_mean_final_od_80_beta_estradiol_17_valerate <- mean(subset(sim_output_wide_80_beta_estradiol_17_valerate, Hour == 48)$Total_OD, na.rm = TRUE)
predicted_sd_final_od_80_beta_estradiol_17_valerate <- sd(subset(sim_output_wide_80_beta_estradiol_17_valerate, Hour == 48)$Total_OD, na.rm = TRUE)

real_mean_final_od_80_beta_estradiol_17_valerate <- Community_compositions_focus_drugs_beta_estradiol_17_valerate_80uM_summarised$mean_final_OD[1]
real_sd_final_od_80_beta_estradiol_17_valerate <- Community_compositions_focus_drugs_beta_estradiol_17_valerate_80uM_summarised$sd_final_OD[1]




#plot_data_0_beta_estradiol_17_valerate_endpoint was used to test model performance at 0 drugs
#plot_data_0_beta_estradiol_17_valerate_endpoint <- subset(plot_data_0_beta_estradiol_17_valerate, Hour == 48 & Species != "Drug")
plot_data_5_beta_estradiol_17_valerate_endpoint <- subset(plot_data_5_beta_estradiol_17_valerate, Hour == 48 & Species != "Drug")
plot_data_20_beta_estradiol_17_valerate_endpoint <- subset(plot_data_20_beta_estradiol_17_valerate, Hour == 48 & Species != "Drug")
plot_data_80_beta_estradiol_17_valerate_endpoint <- subset(plot_data_80_beta_estradiol_17_valerate, Hour == 48 & Species != "Drug")

##Inspecting 'match' to real relative abundance distributions:
Niclosamide_16S_0uM_summarised <- rel_ab_control
Niclosamide_16S_0uM_summarised$Species <- gsub("\\.", "", Niclosamide_16S_0uM_summarised$Species)

beta_estradiol_17_valerate_16S_5uM_summarised <- Community_compositions_focus_drugs_beta_estradiol_17_valerate_5uM_summarised
beta_estradiol_17_valerate_16S_20uM_summarised <- Community_compositions_focus_drugs_beta_estradiol_17_valerate_20uM_summarised
beta_estradiol_17_valerate_16S_80uM_summarised <- Community_compositions_focus_drugs_beta_estradiol_17_valerate_80uM_summarised

Niclosamide_16S_0uM_summarised
beta_estradiol_17_valerate_16S_5uM_summarised 
beta_estradiol_17_valerate_16S_20uM_summarised 
beta_estradiol_17_valerate_16S_80uM_summarised 

#Rename 'species' so the outputs become comparable
original_names_80 <- unique(beta_estradiol_17_valerate_16S_80uM_summarised$species)
original_names_20 <- unique(beta_estradiol_17_valerate_16S_20uM_summarised$species)
original_names_5 <- unique(beta_estradiol_17_valerate_16S_5uM_summarised$species)


##Create a named vector with the original and new names mapping
name_changes <- c(
  "Akkermansia muciniphila" = "A_muciniphila",
  "Bacteroides fragilis" = "B_fragilis",
  "Bacteroides thetaiotaomicron" = "B_thetaiotaomicron",
  "Bacteroides uniformis" = "B_uniformis",
  "Bifidobacterium adolescentis" = "B_adolescentis",
  "Bifidobacterium longum subsp. longum" = "B_longum",
  "Bilophila wadsworthia" = "B_wadsworthia",
  "Blautia obeum" = "B_obeum",
  "Clostridium perfringens" = "C_perfringens",
  "Collinsella aerofaciens" = "C_aerofaciens",
  "Coprococcus comes" = "C_comes",
  "Dorea formicigenerans" = "D_formicigenerans",
  "Eggerthella lenta" = "E_lenta",
  "Enterocloster bolteae" = "C_bolteae",
  "Erysipelatoclostridium ramosum" = "C_ramosum",
  "Escherichia coli ED1a" = "E_coli",
  "Eubacterium rectale" = "E_rectale",
  "Fusobacterium nucleatum subsp. nucleatum" = "F_nucleatum",
  "Lacrimispora saccharolytica" = "C_saccharolyticum",
  "Lacticaseibacillus paracasei" = "L_paracasei",
  "Odoribacter splanchnicus" = "O_splanchnicus",
  "Parabacteroides distasonis" = "P_distasonis",
  "Parabacteroides merdae" = "P_merdae",
  "Phocaeicola vulgatus" = "B_vulgatus",
  "Prevotella copri" = "P_copri",
  "Roseburia intestinalis" = "R_intestinalis",
  "Ruminococcus bromii" = "R_bromii",
  "Ruminococcus gnavus" = "R_gnavus",
  "Ruminococcus torques" = "R_torques",
  "Streptococcus parasanguinis" = "S_parasanguinis",
  "Streptococcus salivarius" = "S_salivarius",
  "Veillonella parvula" = "V_parvula"
)

# Apply name changes to the species column in beta_estradiol_17_valerate_16S_80uM_summarised

beta_estradiol_17_valerate_16S_80uM_summarised$Species <- name_changes[beta_estradiol_17_valerate_16S_80uM_summarised$species]
beta_estradiol_17_valerate_16S_20uM_summarised$Species <- name_changes[beta_estradiol_17_valerate_16S_20uM_summarised$species]
beta_estradiol_17_valerate_16S_5uM_summarised$Species <- name_changes[beta_estradiol_17_valerate_16S_5uM_summarised$species]

# Verify the changes
unique(beta_estradiol_17_valerate_16S_80uM_summarised$Species)
unique(beta_estradiol_17_valerate_16S_20uM_summarised$Species)
unique(beta_estradiol_17_valerate_16S_5uM_summarised$Species)



##First, for 5 uM:
# Get top 6 species from plot_data_5_endpoint
# Adjust the plot_data_5_endpoint with confidence bounds

# #plot_data_0_beta_estradiol_17_valerate_endpoint was used to test model performance at 0 drugs
# plot_data_0_beta_estradiol_17_valerate_endpoint <- plot_data_0_beta_estradiol_17_valerate_endpoint %>%
#   dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)

plot_data_5_beta_estradiol_17_valerate_endpoint <- plot_data_5_beta_estradiol_17_valerate_endpoint %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)

# Adjust the beta_estradiol_17_valerate_16S_5uM_summarised with confidence bounds
beta_estradiol_17_valerate_16S_5uM_summarised <- beta_estradiol_17_valerate_16S_5uM_summarised %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)

#NULL model:
Null_model_summarised <- Niclosamide_16S_0uM_summarised %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)


# Get top 6 species based on the lower bound from plot_data_5_endpoint

#top6_predicted_0_beta_estradiol_17_valerate was used to test model performance at 0 drugs
# top6_predicted_0_beta_estradiol_17_valerate <- plot_data_0_beta_estradiol_17_valerate_endpoint %>%
#    arrange(desc(lower_bound)) %>%
#    slice(1:6) %>%
#    pull(Species)

top6_predicted_5_beta_estradiol_17_valerate <- plot_data_5_beta_estradiol_17_valerate_endpoint %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

# Get top 6 species based on the lower bound from beta_estradiol_17_valerate_16S_5uM_summarised
top6_real_5_beta_estradiol_17_valerate <- beta_estradiol_17_valerate_16S_5uM_summarised %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

top6_NULL <- Null_model_summarised %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

# Calculate the overlap of top 6 species

#top_six_correct_0_beta_estradiol_17_valerate was used to assess model performance at 0 drugs
# top_six_correct_0_beta_estradiol_17_valerate <- length(intersect(top6_predicted_0_beta_estradiol_17_valerate, top6_NULL))
# top_six_correct_0_beta_estradiol_17_valerate

top_six_correct_5_beta_estradiol_17_valerate <- length(intersect(top6_predicted_5_beta_estradiol_17_valerate, top6_real_5_beta_estradiol_17_valerate))
top_six_correct_5_beta_estradiol_17_valerate

top_six_correct_5_beta_estradiol_17_valerate_NULL <- length(intersect(top6_NULL, top6_real_5_beta_estradiol_17_valerate))
top_six_correct_5_beta_estradiol_17_valerate_NULL

top6_predicted_5_beta_estradiol_17_valerate
top6_real_5_beta_estradiol_17_valerate

#top6_NULL

#Now by means:
# #top6_predicted_0_beta_estradiol_17_valerate_means was used to assess model performance at 0 drugs
# top6_predicted_0_beta_estradiol_17_valerate_means <- plot_data_0_beta_estradiol_17_valerate_endpoint %>%
#    arrange(desc(mean_rel_ab)) %>%
#    slice(1:6) %>%
#    pull(Species)

top6_predicted_5_beta_estradiol_17_valerate_means <- plot_data_5_beta_estradiol_17_valerate_endpoint %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)

# Get top 6 species based on the lower bound from beta_estradiol_17_valerate_16S_5uM_summarised
top6_real_5_beta_estradiol_17_valerate_means <- beta_estradiol_17_valerate_16S_5uM_summarised %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)

top6_NULL_means <- Null_model_summarised %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)


# #top_six_correct_0_beta_estradiol_17_valerate_means was used to assess model performance at 0 drugs
# top_six_correct_0_beta_estradiol_17_valerate_means <- length(intersect(top6_predicted_0_beta_estradiol_17_valerate_means, top6_NULL_means))
# top_six_correct_0_beta_estradiol_17_valerate_means

top_six_correct_5_beta_estradiol_17_valerate_means <- length(intersect(top6_predicted_5_beta_estradiol_17_valerate_means, top6_real_5_beta_estradiol_17_valerate_means))
top_six_correct_5_beta_estradiol_17_valerate_means

top_six_correct_5_beta_estradiol_17_valerate_means_NULL <- length(intersect(top6_NULL_means, top6_real_5_beta_estradiol_17_valerate_means))
top_six_correct_5_beta_estradiol_17_valerate_means_NULL

top6_predicted_5_beta_estradiol_17_valerate_means
top6_real_5_beta_estradiol_17_valerate_means

#top6_NULL_means


# Merge dataframes by Species

#merged_data_0_beta_estradiol_17_valerate was used to assess model performance at 0 drugs
#merged_data_0_beta_estradiol_17_valerate <- merge(plot_data_0_beta_estradiol_17_valerate_endpoint, Niclosamide_16S_0uM_summarised, by = "Species", suffixes = c(".pred", ".real"))
merged_data_5_beta_estradiol_17_valerate <- merge(plot_data_5_beta_estradiol_17_valerate_endpoint, beta_estradiol_17_valerate_16S_5uM_summarised, by = "Species", suffixes = c(".pred", ".real"))
merged_data_5_beta_estradiol_17_valerate_NULL <- merge(Niclosamide_16S_0uM_summarised, beta_estradiol_17_valerate_16S_5uM_summarised, by = "Species", suffixes = c(".null", ".real"))


## Below lines used for assessing model performance at 0 drugs; ignore for nonzero concentrations
# # Create lower and upper bounds considering mean ¬± sd
# merged_data_0_beta_estradiol_17_valerate$lower_bound_pred <- merged_data_0_beta_estradiol_17_valerate$mean_rel_ab.pred - merged_data_0_beta_estradiol_17_valerate$sd_rel_ab.pred
# merged_data_0_beta_estradiol_17_valerate$upper_bound_pred <- merged_data_0_beta_estradiol_17_valerate$mean_rel_ab.pred + merged_data_0_beta_estradiol_17_valerate$sd_rel_ab.pred
# merged_data_0_beta_estradiol_17_valerate$lower_bound_real <- merged_data_0_beta_estradiol_17_valerate$mean_rel_ab.real - merged_data_0_beta_estradiol_17_valerate$sd_rel_ab.real
# merged_data_0_beta_estradiol_17_valerate$upper_bound_real <- merged_data_0_beta_estradiol_17_valerate$mean_rel_ab.real + merged_data_0_beta_estradiol_17_valerate$sd_rel_ab.real
# 
# # Ensure lower and upper bounds are non-negative, adjusting as necessary
# merged_data_0_beta_estradiol_17_valerate$lower_bound_pred[merged_data_0_beta_estradiol_17_valerate$lower_bound_pred <= 0] <- 1e-10
# merged_data_0_beta_estradiol_17_valerate$lower_bound_real[merged_data_0_beta_estradiol_17_valerate$lower_bound_real <= 0] <- 1e-10
# merged_data_0_beta_estradiol_17_valerate$upper_bound_pred[merged_data_0_beta_estradiol_17_valerate$upper_bound_pred <= 0] <- 1e-10
# merged_data_0_beta_estradiol_17_valerate$upper_bound_real[merged_data_0_beta_estradiol_17_valerate$upper_bound_real <= 0] <- 1e-10


# Create lower and upper bounds considering mean ¬± sd
merged_data_5_beta_estradiol_17_valerate$lower_bound_pred <- merged_data_5_beta_estradiol_17_valerate$mean_rel_ab.pred - merged_data_5_beta_estradiol_17_valerate$sd_rel_ab.pred
merged_data_5_beta_estradiol_17_valerate$upper_bound_pred <- merged_data_5_beta_estradiol_17_valerate$mean_rel_ab.pred + merged_data_5_beta_estradiol_17_valerate$sd_rel_ab.pred
merged_data_5_beta_estradiol_17_valerate$lower_bound_real <- merged_data_5_beta_estradiol_17_valerate$mean_rel_ab.real - merged_data_5_beta_estradiol_17_valerate$sd_rel_ab.real
merged_data_5_beta_estradiol_17_valerate$upper_bound_real <- merged_data_5_beta_estradiol_17_valerate$mean_rel_ab.real + merged_data_5_beta_estradiol_17_valerate$sd_rel_ab.real

# Ensure lower and upper bounds are non-negative, adjusting as necessary
merged_data_5_beta_estradiol_17_valerate$lower_bound_pred[merged_data_5_beta_estradiol_17_valerate$lower_bound_pred <= 0] <- 1e-10
merged_data_5_beta_estradiol_17_valerate$lower_bound_real[merged_data_5_beta_estradiol_17_valerate$lower_bound_real <= 0] <- 1e-10
merged_data_5_beta_estradiol_17_valerate$upper_bound_pred[merged_data_5_beta_estradiol_17_valerate$upper_bound_pred <= 0] <- 1e-10
merged_data_5_beta_estradiol_17_valerate$upper_bound_real[merged_data_5_beta_estradiol_17_valerate$upper_bound_real <= 0] <- 1e-10

##and for NULL model:
# Create lower and upper bounds considering mean ¬± sd
merged_data_5_beta_estradiol_17_valerate_NULL$lower_bound_null <- merged_data_5_beta_estradiol_17_valerate_NULL$mean_rel_ab.null - merged_data_5_beta_estradiol_17_valerate_NULL$sd_rel_ab.null
merged_data_5_beta_estradiol_17_valerate_NULL$upper_bound_null <- merged_data_5_beta_estradiol_17_valerate_NULL$mean_rel_ab.null + merged_data_5_beta_estradiol_17_valerate_NULL$sd_rel_ab.null
merged_data_5_beta_estradiol_17_valerate_NULL$lower_bound_real <- merged_data_5_beta_estradiol_17_valerate_NULL$mean_rel_ab.real - merged_data_5_beta_estradiol_17_valerate_NULL$sd_rel_ab.real
merged_data_5_beta_estradiol_17_valerate_NULL$upper_bound_real <- merged_data_5_beta_estradiol_17_valerate_NULL$mean_rel_ab.real + merged_data_5_beta_estradiol_17_valerate_NULL$sd_rel_ab.real

# Ensure lower and upper bounds are non-negative, adjusting as necessary
merged_data_5_beta_estradiol_17_valerate_NULL$lower_bound_null[merged_data_5_beta_estradiol_17_valerate_NULL$lower_bound_null <= 0] <- 1e-10
merged_data_5_beta_estradiol_17_valerate_NULL$lower_bound_real[merged_data_5_beta_estradiol_17_valerate_NULL$lower_bound_real <= 0] <- 1e-10
merged_data_5_beta_estradiol_17_valerate_NULL$upper_bound_null[merged_data_5_beta_estradiol_17_valerate_NULL$upper_bound_null <= 0] <- 1e-10
merged_data_5_beta_estradiol_17_valerate_NULL$upper_bound_real[merged_data_5_beta_estradiol_17_valerate_NULL$upper_bound_real <= 0] <- 1e-10

# Filter to include only species with a mean relative abundance > 0.01 in the 'real' dataset

## significant_species_0 was used to assess model performance at 0 drugs
#significant_species_0 <- merged_data_0_beta_estradiol_17_valerate[merged_data_0_beta_estradiol_17_valerate$mean_rel_ab.real > 0.01, ]
significant_species <- merged_data_5_beta_estradiol_17_valerate[merged_data_5_beta_estradiol_17_valerate$mean_rel_ab.real > 0.01, ]
survivors_5_beta_estradiol_17_valerate <- nrow(significant_species)
survivors_5_beta_estradiol_17_valerate

#should be the same as survivors defined above, since it is calculated from .real
significant_species_NULL <- merged_data_5_beta_estradiol_17_valerate_NULL[merged_data_5_beta_estradiol_17_valerate_NULL$mean_rel_ab.real > 0.01, ]
survivors_5_beta_estradiol_17_valerate_NULL <- nrow(significant_species_NULL)
survivors_5_beta_estradiol_17_valerate_NULL

# Adjusted order of magnitude check to include SD, only for significant species
## below code was used to assess model performance at 0 drugs
# significant_species_0$Predicted_magnitude_correct <- ifelse(
#   (floor(log10(significant_species_0$lower_bound_pred)) <= floor(log10(significant_species_0$upper_bound_real)) &
#      floor(log10(significant_species_0$upper_bound_pred)) >= floor(log10(significant_species_0$lower_bound_real))),
#   1,
#   0
# )

significant_species$Predicted_magnitude_correct <- ifelse(
  (floor(log10(significant_species$lower_bound_pred)) <= floor(log10(significant_species$upper_bound_real)) &
     floor(log10(significant_species$upper_bound_pred)) >= floor(log10(significant_species$lower_bound_real))),
  1,
  0
)

#and for the Null model:
significant_species_NULL$Predicted_magnitude_correct <- ifelse(
  (floor(log10(significant_species_NULL$lower_bound_null)) <= floor(log10(significant_species_NULL$upper_bound_real)) &
     floor(log10(significant_species_NULL$upper_bound_null)) >= floor(log10(significant_species_NULL$lower_bound_real))),
  1,
  0
)

# Calculate the fraction of correctly predicted magnitudes for significant species
## below code was used to assess model performance at 0 drugs
#predicted_magnitude_correct_fraction_0_beta_estradiol_17_valerate <- sum(significant_species_0$Predicted_magnitude_correct) / nrow(significant_species_0)
#predicted_magnitude_correct_fraction_0_beta_estradiol_17_valerate

predicted_magnitude_correct_fraction_5_beta_estradiol_17_valerate <- sum(significant_species$Predicted_magnitude_correct) / nrow(significant_species)
predicted_magnitude_correct_fraction_5_beta_estradiol_17_valerate

predicted_magnitude_correct_fraction_5_beta_estradiol_17_valerate_NULL <- sum(significant_species_NULL$Predicted_magnitude_correct) / nrow(significant_species_NULL)
predicted_magnitude_correct_fraction_5_beta_estradiol_17_valerate_NULL

top_species_missing_5_beta_estradiol_17_valerate <- setdiff(top6_real_5_beta_estradiol_17_valerate_means, top6_predicted_5_beta_estradiol_17_valerate_means)
top_species_wrong_5_beta_estradiol_17_valerate <- setdiff(top6_predicted_5_beta_estradiol_17_valerate_means, top6_real_5_beta_estradiol_17_valerate_means)

top_species_missing_5_beta_estradiol_17_valerate <- if(length(top_species_missing_5_beta_estradiol_17_valerate) == 0) "None" else top_species_missing_5_beta_estradiol_17_valerate
top_species_wrong_5_beta_estradiol_17_valerate <- if(length(top_species_wrong_5_beta_estradiol_17_valerate) == 0) "None" else top_species_wrong_5_beta_estradiol_17_valerate

Prediction_quality_5_beta_estradiol_17_valerate <- data.frame(
  Top_six_correct = paste(top_six_correct_5_beta_estradiol_17_valerate, sep=""),
  Top_six_correct_NULL = paste(top_six_correct_5_beta_estradiol_17_valerate_NULL, sep=""),
  Top_six_correct_means = paste(top_six_correct_5_beta_estradiol_17_valerate_means, sep=""),
  Top_six_correct_means_NULL = paste(top_six_correct_5_beta_estradiol_17_valerate_means_NULL, sep=""),
  Predicted_magnitude_correct = paste(round(predicted_magnitude_correct_fraction_5_beta_estradiol_17_valerate * 100, 2), "%", sep=""),
  Predicted_magnitude_correct_NULL = paste(round(predicted_magnitude_correct_fraction_5_beta_estradiol_17_valerate_NULL * 100, 2), "%", sep=""),
  survivors_total = survivors_5_beta_estradiol_17_valerate,
  top_species_missing <- top_species_missing_5_beta_estradiol_17_valerate,
  top_species_wrong <- top_species_wrong_5_beta_estradiol_17_valerate, 
  predicted_mean_final_OD <- predicted_mean_final_od_5_beta_estradiol_17_valerate,
  real_mean_final_OD <- real_mean_final_od_5_beta_estradiol_17_valerate,
  sims_total = length(successful_sim_ids)
)



Prediction_quality_5_beta_estradiol_17_valerate



##Next, for 20 uM:
# Get top 6 species from plot_data_20_endpoint
# Adjust the plot_data_20_endpoint with confidence bounds
plot_data_20_beta_estradiol_17_valerate_endpoint <- plot_data_20_beta_estradiol_17_valerate_endpoint %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)

# Adjust the beta_estradiol_17_valerate_16S_20uM_summarised with confidence bounds
beta_estradiol_17_valerate_16S_20uM_summarised <- beta_estradiol_17_valerate_16S_20uM_summarised %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)

#NULL model:
Null_model_summarised <- Niclosamide_16S_0uM_summarised %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)


# Get top 6 species based on the lower bound from plot_data_20_endpoint
top6_predicted_20_beta_estradiol_17_valerate <- plot_data_20_beta_estradiol_17_valerate_endpoint %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

# Get top 6 species based on the lower bound from beta_estradiol_17_valerate_16S_20uM_summarised
top6_real_20_beta_estradiol_17_valerate <- beta_estradiol_17_valerate_16S_20uM_summarised %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

top6_NULL <- Null_model_summarised %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

# Calculate the overlap of top 6 species
top_six_correct_20_beta_estradiol_17_valerate <- length(intersect(top6_predicted_20_beta_estradiol_17_valerate, top6_real_20_beta_estradiol_17_valerate))
#top_six_correct_20_beta_estradiol_17_valerate

top_six_correct_20_beta_estradiol_17_valerate_NULL <- length(intersect(top6_NULL, top6_real_20_beta_estradiol_17_valerate))
#top_six_correct_20_beta_estradiol_17_valerate_NULL

#top6_predicted_20_beta_estradiol_17_valerate
#top6_real_20_beta_estradiol_17_valerate



#Now by means:
top6_predicted_20_beta_estradiol_17_valerate_means <- plot_data_20_beta_estradiol_17_valerate_endpoint %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)

# Get top 6 species based on the lower bound from beta_estradiol_17_valerate_16S_20uM_summarised
top6_real_20_beta_estradiol_17_valerate_means <- beta_estradiol_17_valerate_16S_20uM_summarised %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)

top6_NULL_means <- Null_model_summarised %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)



top_six_correct_20_beta_estradiol_17_valerate_means <- length(intersect(top6_predicted_20_beta_estradiol_17_valerate_means, top6_real_20_beta_estradiol_17_valerate_means))
#top_six_correct_20_beta_estradiol_17_valerate_means

top_six_correct_20_beta_estradiol_17_valerate_means_NULL <- length(intersect(top6_NULL_means, top6_real_20_beta_estradiol_17_valerate_means))
#top_six_correct_20_beta_estradiol_17_valerate_means_NULL

top6_predicted_20_beta_estradiol_17_valerate_means
#top6_real_20_beta_estradiol_17_valerate_means




# Merge dataframes by Species
merged_data_20_beta_estradiol_17_valerate <- merge(plot_data_20_beta_estradiol_17_valerate_endpoint, beta_estradiol_17_valerate_16S_20uM_summarised, by = "Species", suffixes = c(".pred", ".real"))
merged_data_20_beta_estradiol_17_valerate_NULL <- merge(Niclosamide_16S_0uM_summarised, beta_estradiol_17_valerate_16S_20uM_summarised, by = "Species", suffixes = c(".null", ".real"))



# Create lower and upper bounds considering mean ¬± sd
merged_data_20_beta_estradiol_17_valerate$lower_bound_pred <- merged_data_20_beta_estradiol_17_valerate$mean_rel_ab.pred - merged_data_20_beta_estradiol_17_valerate$sd_rel_ab.pred
merged_data_20_beta_estradiol_17_valerate$upper_bound_pred <- merged_data_20_beta_estradiol_17_valerate$mean_rel_ab.pred + merged_data_20_beta_estradiol_17_valerate$sd_rel_ab.pred
merged_data_20_beta_estradiol_17_valerate$lower_bound_real <- merged_data_20_beta_estradiol_17_valerate$mean_rel_ab.real - merged_data_20_beta_estradiol_17_valerate$sd_rel_ab.real
merged_data_20_beta_estradiol_17_valerate$upper_bound_real <- merged_data_20_beta_estradiol_17_valerate$mean_rel_ab.real + merged_data_20_beta_estradiol_17_valerate$sd_rel_ab.real

# Ensure lower and upper bounds are non-negative, adjusting as necessary
merged_data_20_beta_estradiol_17_valerate$lower_bound_pred[merged_data_20_beta_estradiol_17_valerate$lower_bound_pred <= 0] <- 1e-10
merged_data_20_beta_estradiol_17_valerate$lower_bound_real[merged_data_20_beta_estradiol_17_valerate$lower_bound_real <= 0] <- 1e-10
merged_data_20_beta_estradiol_17_valerate$upper_bound_pred[merged_data_20_beta_estradiol_17_valerate$upper_bound_pred <= 0] <- 1e-10
merged_data_20_beta_estradiol_17_valerate$upper_bound_real[merged_data_20_beta_estradiol_17_valerate$upper_bound_real <= 0] <- 1e-10

##and for NULL model:
# Create lower and upper bounds considering mean ¬± sd
merged_data_20_beta_estradiol_17_valerate_NULL$lower_bound_null <- merged_data_20_beta_estradiol_17_valerate_NULL$mean_rel_ab.null - merged_data_20_beta_estradiol_17_valerate_NULL$sd_rel_ab.null
merged_data_20_beta_estradiol_17_valerate_NULL$upper_bound_null <- merged_data_20_beta_estradiol_17_valerate_NULL$mean_rel_ab.null + merged_data_20_beta_estradiol_17_valerate_NULL$sd_rel_ab.null
merged_data_20_beta_estradiol_17_valerate_NULL$lower_bound_real <- merged_data_20_beta_estradiol_17_valerate_NULL$mean_rel_ab.real - merged_data_20_beta_estradiol_17_valerate_NULL$sd_rel_ab.real
merged_data_20_beta_estradiol_17_valerate_NULL$upper_bound_real <- merged_data_20_beta_estradiol_17_valerate_NULL$mean_rel_ab.real + merged_data_20_beta_estradiol_17_valerate_NULL$sd_rel_ab.real

# Ensure lower and upper bounds are non-negative, adjusting as necessary
merged_data_20_beta_estradiol_17_valerate_NULL$lower_bound_null[merged_data_20_beta_estradiol_17_valerate_NULL$lower_bound_null <= 0] <- 1e-10
merged_data_20_beta_estradiol_17_valerate_NULL$lower_bound_real[merged_data_20_beta_estradiol_17_valerate_NULL$lower_bound_real <= 0] <- 1e-10
merged_data_20_beta_estradiol_17_valerate_NULL$upper_bound_null[merged_data_20_beta_estradiol_17_valerate_NULL$upper_bound_null <= 0] <- 1e-10
merged_data_20_beta_estradiol_17_valerate_NULL$upper_bound_real[merged_data_20_beta_estradiol_17_valerate_NULL$upper_bound_real <= 0] <- 1e-10

# Filter to include only species with a mean relative abundance > 0.01 in the 'real' dataset
significant_species <- merged_data_20_beta_estradiol_17_valerate[merged_data_20_beta_estradiol_17_valerate$mean_rel_ab.real > 0.01, ]
survivors_20_beta_estradiol_17_valerate <- nrow(significant_species)
survivors_20_beta_estradiol_17_valerate

#should be the same as survivors defined above, since it is calculated from .real
significant_species_NULL <- merged_data_20_beta_estradiol_17_valerate_NULL[merged_data_20_beta_estradiol_17_valerate_NULL$mean_rel_ab.real > 0.01, ]
survivors_20_beta_estradiol_17_valerate_NULL <- nrow(significant_species_NULL)
survivors_20_beta_estradiol_17_valerate_NULL

# Adjusted order of magnitude check to include SD, only for significant species
significant_species$Predicted_magnitude_correct <- ifelse(
  (floor(log10(significant_species$lower_bound_pred)) <= floor(log10(significant_species$upper_bound_real)) &
     floor(log10(significant_species$upper_bound_pred)) >= floor(log10(significant_species$lower_bound_real))),
  1,
  0
)

#and for the Null model:
significant_species_NULL$Predicted_magnitude_correct <- ifelse(
  (floor(log10(significant_species_NULL$lower_bound_null)) <= floor(log10(significant_species_NULL$upper_bound_real)) &
     floor(log10(significant_species_NULL$upper_bound_null)) >= floor(log10(significant_species_NULL$lower_bound_real))),
  1,
  0
)

# Calculate the fraction of correctly predicted magnitudes for significant species
predicted_magnitude_correct_fraction_20_beta_estradiol_17_valerate <- sum(significant_species$Predicted_magnitude_correct) / nrow(significant_species)
predicted_magnitude_correct_fraction_20_beta_estradiol_17_valerate

predicted_magnitude_correct_fraction_20_beta_estradiol_17_valerate_NULL <- sum(significant_species_NULL$Predicted_magnitude_correct) / nrow(significant_species_NULL)
predicted_magnitude_correct_fraction_20_beta_estradiol_17_valerate_NULL

top_species_missing_20_beta_estradiol_17_valerate <- setdiff(top6_real_20_beta_estradiol_17_valerate_means, top6_predicted_20_beta_estradiol_17_valerate_means)
top_species_wrong_20_beta_estradiol_17_valerate <- setdiff(top6_predicted_20_beta_estradiol_17_valerate_means, top6_real_20_beta_estradiol_17_valerate_means)

Prediction_quality_20_beta_estradiol_17_valerate <- data.frame(
  Top_six_correct = paste(top_six_correct_20_beta_estradiol_17_valerate, sep=""),
  Top_six_correct_NULL = paste(top_six_correct_20_beta_estradiol_17_valerate_NULL, sep=""),
  Top_six_correct_means = paste(top_six_correct_20_beta_estradiol_17_valerate_means, sep=""),
  Top_six_correct_means_NULL = paste(top_six_correct_20_beta_estradiol_17_valerate_means_NULL, sep=""),
  Predicted_magnitude_correct = paste(round(predicted_magnitude_correct_fraction_20_beta_estradiol_17_valerate * 100, 2), "%", sep=""),
  Predicted_magnitude_correct_NULL = paste(round(predicted_magnitude_correct_fraction_20_beta_estradiol_17_valerate_NULL * 100, 2), "%", sep=""),
  survivors_total = survivors_20_beta_estradiol_17_valerate,
  top_species_missing <- top_species_missing_20_beta_estradiol_17_valerate,
  top_species_wrong <- top_species_wrong_20_beta_estradiol_17_valerate, 
  predicted_mean_final_OD <- predicted_mean_final_od_20_beta_estradiol_17_valerate,
  real_mean_final_OD <- real_mean_final_od_20_beta_estradiol_17_valerate,
  sims_total = length(successful_sim_ids)
)

Prediction_quality_20_beta_estradiol_17_valerate






##Next, for 80 uM:
# Get top 6 species from plot_data_80_endpoint
# Adjust the plot_data_80_endpoint with confidence bounds
plot_data_80_beta_estradiol_17_valerate_endpoint <- plot_data_80_beta_estradiol_17_valerate_endpoint %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)

# Adjust the beta_estradiol_17_valerate_16S_80uM_summarised with confidence bounds
beta_estradiol_17_valerate_16S_80uM_summarised <- beta_estradiol_17_valerate_16S_80uM_summarised %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)

#NULL model:
Null_model_summarised <- Niclosamide_16S_0uM_summarised %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)


# Get top 6 species based on the lower bound from plot_data_80_endpoint
top6_predicted_80_beta_estradiol_17_valerate <- plot_data_80_beta_estradiol_17_valerate_endpoint %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

# Get top 6 species based on the lower bound from beta_estradiol_17_valerate_16S_80uM_summarised
top6_real_80_beta_estradiol_17_valerate <- beta_estradiol_17_valerate_16S_80uM_summarised %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

top6_NULL <- Null_model_summarised %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

# Calculate the overlap of top 6 species
top_six_correct_80_beta_estradiol_17_valerate <- length(intersect(top6_predicted_80_beta_estradiol_17_valerate, top6_real_80_beta_estradiol_17_valerate))
#top_six_correct_80_beta_estradiol_17_valerate

top_six_correct_80_beta_estradiol_17_valerate_NULL <- length(intersect(top6_NULL, top6_real_80_beta_estradiol_17_valerate))
#top_six_correct_80_beta_estradiol_17_valerate_NULL

#top6_predicted_80_beta_estradiol_17_valerate
#top6_real_80_beta_estradiol_17_valerate




#Now by means:
top6_predicted_80_beta_estradiol_17_valerate_means <- plot_data_80_beta_estradiol_17_valerate_endpoint %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)

# Get top 6 species based on the lower bound from beta_estradiol_17_valerate_16S_80uM_summarised
top6_real_80_beta_estradiol_17_valerate_means <- beta_estradiol_17_valerate_16S_80uM_summarised %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)

top6_NULL_means <- Null_model_summarised %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)



top_six_correct_80_beta_estradiol_17_valerate_means <- length(intersect(top6_predicted_80_beta_estradiol_17_valerate_means, top6_real_80_beta_estradiol_17_valerate_means))
#top_six_correct_80_beta_estradiol_17_valerate_means

top_six_correct_80_beta_estradiol_17_valerate_means_NULL <- length(intersect(top6_NULL_means, top6_real_80_beta_estradiol_17_valerate_means))
#top_six_correct_80_beta_estradiol_17_valerate_means_NULL

#top6_predicted_80_beta_estradiol_17_valerate_means
#top6_real_80_beta_estradiol_17_valerate_means




# Merge dataframes by Species
merged_data_80_beta_estradiol_17_valerate <- merge(plot_data_80_beta_estradiol_17_valerate_endpoint, beta_estradiol_17_valerate_16S_80uM_summarised, by = "Species", suffixes = c(".pred", ".real"))
merged_data_80_beta_estradiol_17_valerate_NULL <- merge(Niclosamide_16S_0uM_summarised, beta_estradiol_17_valerate_16S_80uM_summarised, by = "Species", suffixes = c(".null", ".real"))



# Create lower and upper bounds considering mean ¬± sd
merged_data_80_beta_estradiol_17_valerate$lower_bound_pred <- merged_data_80_beta_estradiol_17_valerate$mean_rel_ab.pred - merged_data_80_beta_estradiol_17_valerate$sd_rel_ab.pred
merged_data_80_beta_estradiol_17_valerate$upper_bound_pred <- merged_data_80_beta_estradiol_17_valerate$mean_rel_ab.pred + merged_data_80_beta_estradiol_17_valerate$sd_rel_ab.pred
merged_data_80_beta_estradiol_17_valerate$lower_bound_real <- merged_data_80_beta_estradiol_17_valerate$mean_rel_ab.real - merged_data_80_beta_estradiol_17_valerate$sd_rel_ab.real
merged_data_80_beta_estradiol_17_valerate$upper_bound_real <- merged_data_80_beta_estradiol_17_valerate$mean_rel_ab.real + merged_data_80_beta_estradiol_17_valerate$sd_rel_ab.real

# Ensure lower and upper bounds are non-negative, adjusting as necessary
merged_data_80_beta_estradiol_17_valerate$lower_bound_pred[merged_data_80_beta_estradiol_17_valerate$lower_bound_pred <= 0] <- 1e-10
merged_data_80_beta_estradiol_17_valerate$lower_bound_real[merged_data_80_beta_estradiol_17_valerate$lower_bound_real <= 0] <- 1e-10
merged_data_80_beta_estradiol_17_valerate$upper_bound_pred[merged_data_80_beta_estradiol_17_valerate$upper_bound_pred <= 0] <- 1e-10
merged_data_80_beta_estradiol_17_valerate$upper_bound_real[merged_data_80_beta_estradiol_17_valerate$upper_bound_real <= 0] <- 1e-10

##and for NULL model:
# Create lower and upper bounds considering mean ¬± sd
merged_data_80_beta_estradiol_17_valerate_NULL$lower_bound_null <- merged_data_80_beta_estradiol_17_valerate_NULL$mean_rel_ab.null - merged_data_80_beta_estradiol_17_valerate_NULL$sd_rel_ab.null
merged_data_80_beta_estradiol_17_valerate_NULL$upper_bound_null <- merged_data_80_beta_estradiol_17_valerate_NULL$mean_rel_ab.null + merged_data_80_beta_estradiol_17_valerate_NULL$sd_rel_ab.null
merged_data_80_beta_estradiol_17_valerate_NULL$lower_bound_real <- merged_data_80_beta_estradiol_17_valerate_NULL$mean_rel_ab.real - merged_data_80_beta_estradiol_17_valerate_NULL$sd_rel_ab.real
merged_data_80_beta_estradiol_17_valerate_NULL$upper_bound_real <- merged_data_80_beta_estradiol_17_valerate_NULL$mean_rel_ab.real + merged_data_80_beta_estradiol_17_valerate_NULL$sd_rel_ab.real

# Ensure lower and upper bounds are non-negative, adjusting as necessary
merged_data_80_beta_estradiol_17_valerate_NULL$lower_bound_null[merged_data_80_beta_estradiol_17_valerate_NULL$lower_bound_null <= 0] <- 1e-10
merged_data_80_beta_estradiol_17_valerate_NULL$lower_bound_real[merged_data_80_beta_estradiol_17_valerate_NULL$lower_bound_real <= 0] <- 1e-10
merged_data_80_beta_estradiol_17_valerate_NULL$upper_bound_null[merged_data_80_beta_estradiol_17_valerate_NULL$upper_bound_null <= 0] <- 1e-10
merged_data_80_beta_estradiol_17_valerate_NULL$upper_bound_real[merged_data_80_beta_estradiol_17_valerate_NULL$upper_bound_real <= 0] <- 1e-10

# Filter to include only species with a mean relative abundance > 0.01 in the 'real' dataset
significant_species <- merged_data_80_beta_estradiol_17_valerate[merged_data_80_beta_estradiol_17_valerate$mean_rel_ab.real > 0.01, ]
survivors_80_beta_estradiol_17_valerate <- nrow(significant_species)
survivors_80_beta_estradiol_17_valerate

#should be the same as survivors defined above, since it is calculated from .real
significant_species_NULL <- merged_data_80_beta_estradiol_17_valerate_NULL[merged_data_80_beta_estradiol_17_valerate_NULL$mean_rel_ab.real > 0.01, ]
survivors_80_beta_estradiol_17_valerate_NULL <- nrow(significant_species_NULL)
survivors_80_beta_estradiol_17_valerate_NULL

# Adjusted order of magnitude check to include SD, only for significant species
significant_species$Predicted_magnitude_correct <- ifelse(
  (floor(log10(significant_species$lower_bound_pred)) <= floor(log10(significant_species$upper_bound_real)) &
     floor(log10(significant_species$upper_bound_pred)) >= floor(log10(significant_species$lower_bound_real))),
  1,
  0
)

#and for the Null model:
significant_species_NULL$Predicted_magnitude_correct <- ifelse(
  (floor(log10(significant_species_NULL$lower_bound_null)) <= floor(log10(significant_species_NULL$upper_bound_real)) &
     floor(log10(significant_species_NULL$upper_bound_null)) >= floor(log10(significant_species_NULL$lower_bound_real))),
  1,
  0
)

# Calculate the fraction of correctly predicted magnitudes for significant species
predicted_magnitude_correct_fraction_80_beta_estradiol_17_valerate <- sum(significant_species$Predicted_magnitude_correct) / nrow(significant_species)
predicted_magnitude_correct_fraction_80_beta_estradiol_17_valerate

predicted_magnitude_correct_fraction_80_beta_estradiol_17_valerate_NULL <- sum(significant_species_NULL$Predicted_magnitude_correct) / nrow(significant_species_NULL)
predicted_magnitude_correct_fraction_80_beta_estradiol_17_valerate_NULL


top_species_missing_80_beta_estradiol_17_valerate <- setdiff(top6_real_80_beta_estradiol_17_valerate_means, top6_predicted_80_beta_estradiol_17_valerate_means)
top_species_wrong_80_beta_estradiol_17_valerate <- setdiff(top6_predicted_80_beta_estradiol_17_valerate_means, top6_real_80_beta_estradiol_17_valerate_means)

Prediction_quality_80_beta_estradiol_17_valerate <- data.frame(
  Top_six_correct = paste(top_six_correct_80_beta_estradiol_17_valerate, sep=""),
  Top_six_correct_NULL = paste(top_six_correct_80_beta_estradiol_17_valerate_NULL, sep=""),
  Top_six_correct_means = paste(top_six_correct_80_beta_estradiol_17_valerate_means, sep=""),
  Top_six_correct_means_NULL = paste(top_six_correct_80_beta_estradiol_17_valerate_means_NULL, sep=""),
  Predicted_magnitude_correct = paste(round(predicted_magnitude_correct_fraction_80_beta_estradiol_17_valerate * 100, 2), "%", sep=""),
  Predicted_magnitude_correct_NULL = paste(round(predicted_magnitude_correct_fraction_80_beta_estradiol_17_valerate_NULL * 100, 2), "%", sep=""),
  survivors_total = survivors_80_beta_estradiol_17_valerate,
  top_species_missing <- top_species_missing_80_beta_estradiol_17_valerate,
  top_species_wrong <- top_species_wrong_80_beta_estradiol_17_valerate, 
  predicted_mean_final_OD <- predicted_mean_final_od_80_beta_estradiol_17_valerate,
  real_mean_final_OD <- real_mean_final_od_80_beta_estradiol_17_valerate,
  sims_total = length(successful_sim_ids)
)

Prediction_quality_80_beta_estradiol_17_valerate









##Chlorpromazine

combined_monoculture_aucs2_Chlorpromazine <- subset(combined_monoculture_aucs2, drug == "Chlorpromazine")


#drug sensitivity terms: define once outside of ODEs
y_function_B_vulgatus_Chlorpromazine <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("B_vulgatus", "Chlorpromazine", best_fitting_models_df_Chlorpromazine)), collapse = " ")))
y_function_B_uniformis_Chlorpromazine <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("B_uniformis", "Chlorpromazine", best_fitting_models_df_Chlorpromazine)), collapse = " ")))
y_function_B_fragilis_Chlorpromazine <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("B_fragilis", "Chlorpromazine", best_fitting_models_df_Chlorpromazine)), collapse = " ")))
y_function_B_thetaiotaomicron_Chlorpromazine <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("B_thetaiotaomicron", "Chlorpromazine", best_fitting_models_df_Chlorpromazine)), collapse = " ")))
y_function_C_ramosum_Chlorpromazine <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("C_ramosum", "Chlorpromazine", best_fitting_models_df_Chlorpromazine)), collapse = " ")))
y_function_E_rectale_Chlorpromazine <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("E_rectale", "Chlorpromazine", best_fitting_models_df_Chlorpromazine)), collapse = " ")))
y_function_R_intestinalis_Chlorpromazine <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("R_intestinalis", "Chlorpromazine", best_fitting_models_df_Chlorpromazine)), collapse = " ")))
y_function_V_parvula_Chlorpromazine <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("V_parvula", "Chlorpromazine", best_fitting_models_df_Chlorpromazine)), collapse = " ")))
y_function_E_lenta_Chlorpromazine <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("E_lenta", "Chlorpromazine", best_fitting_models_df_Chlorpromazine)), collapse = " ")))
y_function_F_nucleatum_Chlorpromazine <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("F_nucleatum", "Chlorpromazine", best_fitting_models_df_Chlorpromazine)), collapse = " ")))
y_function_C_bolteae_Chlorpromazine <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("C_bolteae", "Chlorpromazine", best_fitting_models_df_Chlorpromazine)), collapse = " ")))
y_function_C_perfringens_Chlorpromazine <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("C_perfringens", "Chlorpromazine", best_fitting_models_df_Chlorpromazine)), collapse = " ")))
y_function_C_saccharolyticum_Chlorpromazine <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("C_saccharolyticum", "Chlorpromazine", best_fitting_models_df_Chlorpromazine)), collapse = " ")))
y_function_S_salivarius_Chlorpromazine <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("S_salivarius", "Chlorpromazine", best_fitting_models_df_Chlorpromazine)), collapse = " ")))
y_function_R_gnavus_Chlorpromazine <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("R_gnavus", "Chlorpromazine", best_fitting_models_df_Chlorpromazine)), collapse = " ")))
y_function_C_comes_Chlorpromazine <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("C_comes", "Chlorpromazine", best_fitting_models_df_Chlorpromazine)), collapse = " ")))
y_function_P_merdae_Chlorpromazine <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("P_merdae", "Chlorpromazine", best_fitting_models_df_Chlorpromazine)), collapse = " ")))
y_function_S_parasanguinis_Chlorpromazine <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("S_parasanguinis", "Chlorpromazine", best_fitting_models_df_Chlorpromazine)), collapse = " ")))
y_function_C_aerofaciens_Chlorpromazine <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("C_aerofaciens", "Chlorpromazine", best_fitting_models_df_Chlorpromazine)), collapse = " ")))
y_function_D_formicigenerans_Chlorpromazine <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("D_formicigenerans", "Chlorpromazine", best_fitting_models_df_Chlorpromazine)), collapse = " ")))
y_function_E_coli_Chlorpromazine <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("E_coli", "Chlorpromazine", best_fitting_models_df_Chlorpromazine)), collapse = " ")))



y_function_B_vulgatus_Chlorpromazine_func <- eval(parse(text = paste("function(Drug) {", y_function_B_vulgatus_Chlorpromazine, "}")))
y_function_B_uniformis_Chlorpromazine_func <- eval(parse(text = paste("function(Drug) {", y_function_B_uniformis_Chlorpromazine, "}")))
y_function_B_fragilis_Chlorpromazine_func <- eval(parse(text = paste("function(Drug) {", y_function_B_fragilis_Chlorpromazine, "}")))
y_function_B_thetaiotaomicron_Chlorpromazine_func <- eval(parse(text = paste("function(Drug) {", y_function_B_thetaiotaomicron_Chlorpromazine, "}")))
y_function_C_ramosum_Chlorpromazine_func <- eval(parse(text = paste("function(Drug) {", y_function_C_ramosum_Chlorpromazine, "}")))
y_function_E_rectale_Chlorpromazine_func <- eval(parse(text = paste("function(Drug) {", y_function_E_rectale_Chlorpromazine, "}")))
y_function_R_intestinalis_Chlorpromazine_func <- eval(parse(text = paste("function(Drug) {", y_function_R_intestinalis_Chlorpromazine, "}")))
y_function_E_lenta_Chlorpromazine_func <- eval(parse(text = paste("function(Drug) {", y_function_E_lenta_Chlorpromazine, "}")))
y_function_F_nucleatum_Chlorpromazine_func <- eval(parse(text = paste("function(Drug) {", y_function_F_nucleatum_Chlorpromazine, "}")))
y_function_C_bolteae_Chlorpromazine_func <- eval(parse(text = paste("function(Drug) {", y_function_C_bolteae_Chlorpromazine, "}")))
y_function_C_perfringens_Chlorpromazine_func <- eval(parse(text = paste("function(Drug) {", y_function_C_perfringens_Chlorpromazine, "}")))
y_function_C_saccharolyticum_Chlorpromazine_func <- eval(parse(text = paste("function(Drug) {", y_function_C_saccharolyticum_Chlorpromazine, "}")))
y_function_S_salivarius_Chlorpromazine_func <- eval(parse(text = paste("function(Drug) {", y_function_S_salivarius_Chlorpromazine, "}")))
y_function_R_gnavus_Chlorpromazine_func <- eval(parse(text = paste("function(Drug) {", y_function_R_gnavus_Chlorpromazine, "}")))
y_function_C_comes_Chlorpromazine_func <- eval(parse(text = paste("function(Drug) {", y_function_C_comes_Chlorpromazine, "}")))
y_function_P_merdae_Chlorpromazine_func <- eval(parse(text = paste("function(Drug) {", y_function_P_merdae_Chlorpromazine, "}")))
y_function_S_parasanguinis_Chlorpromazine_func <- eval(parse(text = paste("function(Drug) {", y_function_S_parasanguinis_Chlorpromazine, "}")))
y_function_C_aerofaciens_Chlorpromazine_func <- eval(parse(text = paste("function(Drug) {", y_function_C_aerofaciens_Chlorpromazine, "}")))
y_function_D_formicigenerans_Chlorpromazine_func <- eval(parse(text = paste("function(Drug) {", y_function_D_formicigenerans_Chlorpromazine, "}")))
y_function_E_coli_Chlorpromazine_func <- eval(parse(text = paste("function(Drug) {", y_function_E_coli_Chlorpromazine, "}")))
y_function_V_parvula_Chlorpromazine_func <- eval(parse(text = paste("function(Drug) {", y_function_V_parvula_Chlorpromazine, "}")))



unique(combined_monoculture_aucs2_Chlorpromazine$conc)
##dictate drug concentration tested for simulation cycle here:
#drug_concentration_tested <- 5 #if manually or:
drug_concentration_tested <- unique(combined_monoculture_aucs2_Chlorpromazine$conc)[1] 
initial_conditions <- rep(0.01/32, 32)
initial_conditions <- c(initial_conditions, drug_concentration_tested)


##drug effect fitted for species showing sensitivity in monoculture:
#unique(combined_monoculture_aucs2_Chlorpromazine$Species)

##for more simple linear fits
closed.sir.model_Chlorpromazine <- function (t, x, params) {
  ## first extract the state variables
  A_muciniphila <- x[1]
  B_adolescentis <- x[2]
  B_fragilis <- x[3]
  B_longum <- x[4]
  B_obeum <- x[5]
  B_thetaiotaomicron <- x[6]
  B_uniformis <- x[7]
  B_vulgatus <- x[8]
  B_wadsworthia <- x[9]
  C_aerofaciens <- x[10]
  C_bolteae <- x[11]
  C_comes <- x[12]
  C_perfringens <- x[13]
  C_ramosum <- x[14]
  C_saccharolyticum <- x[15]
  D_formicigenerans <- x[16]
  E_coli <- x[17]
  E_lenta <- x[18]
  E_rectale <- x[19]
  F_nucleatum <- x[20]
  L_paracasei <- x[21]
  O_splanchnicus <- x[22]
  P_copri <- x[23]
  P_distasonis <- x[24]
  P_merdae <- x[25]
  R_bromii <- x[26]
  R_gnavus <- x[27]
  R_intestinalis <- x[28]
  R_torques <- x[29]
  S_parasanguinis <- x[30]
  S_salivarius <- x[31]
  V_parvula <- x[32]
  Drug <- x[33]
  
  
  ## now extract the parameters
  r_B_fragilis <- flat_params[["B._fragilis.r"]]
  K_B_fragilis <- flat_params[["B._fragilis.K"]]
  r_B_longum <- flat_params[["B._longum.r"]]
  K_B_longum <- flat_params[["B._longum.K"]]
  r_B_thetaiotaomicron <- flat_params[["B._thetaiotaomicron.r"]]
  K_B_thetaiotaomicron <- flat_params[["B._thetaiotaomicron.K"]]
  r_B_uniformis <- flat_params[["B._uniformis.r"]]
  K_B_uniformis <- flat_params[["B._uniformis.K"]]
  r_B_vulgatus <- flat_params[["B._vulgatus.r"]]
  K_B_vulgatus <- flat_params[["B._vulgatus.K"]]
  r_B_wadsworthia <- flat_params[["B._wadsworthia.r"]]
  K_B_wadsworthia <- flat_params[["B._wadsworthia.K"]]
  r_C_aerofaciens <- flat_params[["C._aerofaciens.r"]]
  K_C_aerofaciens <- flat_params[["C._aerofaciens.K"]]
  r_C_bolteae <- flat_params[["C._bolteae.r"]]
  K_C_bolteae <- flat_params[["C._bolteae.K"]]
  r_C_comes <- flat_params[["C._comes.r"]]
  K_C_comes <- flat_params[["C._comes.K"]]
  r_C_perfringens <- flat_params[["C._perfringens.r"]]
  K_C_perfringens <- flat_params[["C._perfringens.K"]]
  r_C_ramosum <- flat_params[["C._ramosum.r"]]
  K_C_ramosum <- flat_params[["C._ramosum.K"]]
  r_C_saccharolyticum <- flat_params[["C._saccharolyticum.r"]]
  K_C_saccharolyticum <- flat_params[["C._saccharolyticum.K"]]
  r_D_formicigenerans <- flat_params[["D._formicigenerans.r"]]
  K_D_formicigenerans <- flat_params[["D._formicigenerans.K"]]
  r_E_coli <- flat_params[["E._coli.r"]]
  K_E_coli <- flat_params[["E._coli.K"]]
  r_E_lenta <- flat_params[["E._lenta.r"]]
  K_E_lenta <- flat_params[["E._lenta.K"]]
  r_E_rectale <- flat_params[["E._rectale.r"]]
  K_E_rectale <- flat_params[["E._rectale.K"]]
  r_F_nucleatum <- flat_params[["F._nucleatum.r"]]
  K_F_nucleatum <- flat_params[["F._nucleatum.K"]]
  r_P_copri <- flat_params[["P._copri.r"]]
  K_P_copri <- flat_params[["P._copri.K"]]
  r_P_merdae <- flat_params[["P._merdae.r"]]
  K_P_merdae <- flat_params[["P._merdae.K"]]
  r_R_gnavus <- flat_params[["R._gnavus.r"]]
  K_R_gnavus <- flat_params[["R._gnavus.K"]]
  r_R_intestinalis <- flat_params[["R._intestinalis.r"]]
  K_R_intestinalis <- flat_params[["R._intestinalis.K"]]
  r_V_parvula <- flat_params[["V._parvula.r"]]
  K_V_parvula <- flat_params[["V._parvula.K"]]
  r_A_muciniphila <- flat_params[["A._muciniphila.r"]]
  K_A_muciniphila <- flat_params[["A._muciniphila.K"]]
  r_B_adolescentis <- flat_params[["B._adolescentis.r"]]
  K_B_adolescentis <- flat_params[["B._adolescentis.K"]]
  r_B_obeum <- flat_params[["B._obeum.r"]]
  K_B_obeum <- flat_params[["B._obeum.K"]]
  r_O_splanchnicus <- flat_params[["O._splanchnicus.r"]]
  K_O_splanchnicus <- flat_params[["O._splanchnicus.K"]]
  r_P_distasonis <- flat_params[["P._distasonis.r"]]
  K_P_distasonis <- flat_params[["P._distasonis.K"]]
  r_R_bromii <- flat_params[["R._bromii.r"]]
  K_R_bromii <- flat_params[["R._bromii.K"]]
  r_R_torques <- flat_params[["R._torques.r"]]
  K_R_torques <- flat_params[["R._torques.K"]]
  r_S_parasanguinis <- flat_params[["S._parasanguinis.r"]]
  K_S_parasanguinis <-flat_params[["S._parasanguinis.K"]]
  r_S_salivarius <- flat_params[["S._salivarius.r"]]
  K_S_salivarius <- flat_params[["S._salivarius.K"]]
  r_L_paracasei <- flat_params[["L._paracasei.r"]]
  K_L_paracasei <- flat_params[["L._paracasei.K"]]
  
  
  t_mod <- ifelse(t > 24.1, t - 24.1, t)
  
  
  ## now code the model equations
  dA_muciniphila_dt <- r_A_muciniphila * A_muciniphila * (1 - A_muciniphila / K_A_muciniphila)
  dB_adolescentis_dt <- r_B_adolescentis * B_adolescentis * (1 - B_adolescentis / K_B_adolescentis)
  dB_fragilis_dt <- r_B_fragilis * B_fragilis * (1 - B_fragilis / max(0.0001, K_B_fragilis * (y_function_B_fragilis_Chlorpromazine_func(Drug))))
  dB_longum_dt <- r_B_longum * B_longum * (1 - B_longum / K_B_longum)
  dB_obeum_dt <- r_B_obeum * B_obeum * (1 - B_obeum / K_B_obeum)
  dB_thetaiotaomicron_dt <- r_B_thetaiotaomicron * B_thetaiotaomicron * (1 - B_thetaiotaomicron / max(0.0001, K_B_thetaiotaomicron * (y_function_B_thetaiotaomicron_Chlorpromazine_func(Drug))))  
  dB_uniformis_dt <- r_B_uniformis * B_uniformis * (1 - B_uniformis / max(0.0001, K_B_uniformis * (y_function_B_uniformis_Chlorpromazine_func(Drug))))
  dB_vulgatus_dt <- r_B_vulgatus * B_vulgatus * (1 - B_vulgatus / max(0.0001, K_B_vulgatus * (y_function_B_vulgatus_Chlorpromazine_func(Drug))))
  dB_wadsworthia_dt <- r_B_wadsworthia * B_wadsworthia * (1 - B_wadsworthia / K_B_wadsworthia)
  dC_aerofaciens_dt <- r_C_aerofaciens * C_aerofaciens * (1 - C_aerofaciens / max(0.0001, K_C_aerofaciens * (y_function_C_aerofaciens_Chlorpromazine_func(Drug))))
  dC_bolteae_dt <- r_C_bolteae * C_bolteae * (1 - C_bolteae /  max(0.0001, K_C_bolteae * (y_function_C_bolteae_Chlorpromazine_func(Drug))))
  dC_comes_dt <- r_C_comes * C_comes * (1 - C_comes / max(0.0001, K_C_comes * (y_function_C_comes_Chlorpromazine_func(Drug))))
  dC_perfringens_dt <- r_C_perfringens * C_perfringens * (1 - C_perfringens / max(0.0001, K_C_perfringens * (y_function_C_perfringens_Chlorpromazine_func(Drug))))
  dC_ramosum_dt <- r_C_ramosum * C_ramosum * (1 - C_ramosum / max(0.0001, K_C_ramosum * (y_function_C_ramosum_Chlorpromazine_func(Drug))))
  dC_saccharolyticum_dt <- r_C_saccharolyticum * C_saccharolyticum * (1 - C_saccharolyticum / max(0.0001, K_C_saccharolyticum * (y_function_C_saccharolyticum_Chlorpromazine_func(Drug))))
  dD_formicigenerans_dt <- r_D_formicigenerans * D_formicigenerans * (1 - D_formicigenerans / max(0.0001, K_D_formicigenerans * (y_function_D_formicigenerans_Chlorpromazine_func(Drug))))
  dE_coli_dt <- r_E_coli * E_coli * (1 - E_coli / max(0.0001, K_E_coli * (y_function_E_coli_Chlorpromazine_func(Drug))))
  dE_lenta_dt <- r_E_lenta * E_lenta * (1 - E_lenta / max(0.0001, K_E_lenta * (y_function_E_lenta_Chlorpromazine_func(Drug))))
  dE_rectale_dt <- r_E_rectale * E_rectale * (1 - E_rectale / max(0.0001, K_E_rectale * (y_function_E_rectale_Chlorpromazine_func(Drug))))
  dF_nucleatum_dt <- r_F_nucleatum * F_nucleatum * (1 - F_nucleatum / max(0.0001, K_F_nucleatum * (y_function_F_nucleatum_Chlorpromazine_func(Drug))))
  dL_paracasei_dt <- r_L_paracasei * L_paracasei * (1 - L_paracasei / K_L_paracasei)  
  dO_splanchnicus_dt <- r_O_splanchnicus * O_splanchnicus * (1 - O_splanchnicus / K_O_splanchnicus)  
  dP_copri_dt <- r_P_copri * P_copri * (1 - P_copri / K_P_copri)
  dP_distasonis_dt <- r_P_distasonis * P_distasonis * (1 - P_distasonis / K_P_distasonis)  
  dP_merdae_dt <- r_P_merdae * P_merdae * (1 - P_merdae / max(0.0001, K_P_merdae * (y_function_P_merdae_Chlorpromazine_func(Drug))))
  dR_bromii_dt <- r_R_bromii * R_bromii * (1 - R_bromii / K_R_bromii) 
  dR_gnavus_dt <- r_R_gnavus * R_gnavus * (1 - R_gnavus / max(0.0001, K_R_gnavus * (y_function_R_gnavus_Chlorpromazine_func(Drug))))
  dR_intestinalis_dt <- r_R_intestinalis * R_intestinalis * (1 - R_intestinalis / max(0.0001, K_R_intestinalis * (y_function_R_intestinalis_Chlorpromazine_func(Drug))))
  dR_torques_dt <- r_R_torques * R_torques * (1 - R_torques /K_R_torques) 
  dS_parasanguinis_dt <- r_S_parasanguinis * S_parasanguinis * (1 - S_parasanguinis / max(0.0001, K_S_parasanguinis * (y_function_S_parasanguinis_Chlorpromazine_func(Drug))))
  dS_salivarius_dt <- r_S_salivarius * S_salivarius * (1 - S_salivarius / max(0.0001, K_S_salivarius * (y_function_S_salivarius_Chlorpromazine_func(Drug))))
  dV_parvula_dt <- r_V_parvula * V_parvula * (1 - V_parvula / max(0.0001, K_V_parvula * (y_function_V_parvula_Chlorpromazine_func(Drug))))
  
  
  
  #Drug differential:
  dDrug_dt <- (subset(drug_dynamics, Drug == "Chlorpromazine")$Steepness_param_community * exp(-subset(drug_dynamics, Drug == "Chlorpromazine")$Steepness_param_community * t_mod)) * (drug_concentration_tested * prop_left_Chlorpromazine - drug_concentration_tested)
  #dDrug_dt <- 0
  
  ## Combine results into a single vector
  dxdt <- c(dA_muciniphila_dt, dB_adolescentis_dt, dB_fragilis_dt, dB_longum_dt, dB_obeum_dt, dB_thetaiotaomicron_dt, dB_uniformis_dt, dB_vulgatus_dt, dB_wadsworthia_dt, dC_aerofaciens_dt, dC_bolteae_dt, dC_comes_dt, dC_perfringens_dt, dC_ramosum_dt, dC_saccharolyticum_dt, dD_formicigenerans_dt, dE_coli_dt, dE_lenta_dt, dE_rectale_dt, dF_nucleatum_dt, dL_paracasei_dt, dO_splanchnicus_dt, dP_copri_dt, dP_distasonis_dt, dP_merdae_dt, dR_bromii_dt, dR_gnavus_dt, dR_intestinalis_dt, dR_torques_dt, dS_parasanguinis_dt, dS_salivarius_dt, dV_parvula_dt, dDrug_dt)
  
  ## Return result as a list
  list(dxdt)
}




#calculate the co-culture correction factor per species based on community composition in absence of drug, just like done for Niclosamide

growth_data_all_0_Niclosamide
growth_data_all_0_Niclosamide1 <- growth_data_all_0_Niclosamide %>%
  dplyr::mutate(Species = gsub(" ", "_", Species))


# Merge rel_ab_control with growth_data_all_0_Niclosamide on Species
# Function to remove duplicated columns by name pattern
clean_columns_base <- function(df, pattern) {
  cols_to_keep <- !grepl(pattern, names(df))
  df <- df[, cols_to_keep]
  return(df)
}

# Use the new function to clean up your dataframe
rel_ab_control <- clean_columns_base(rel_ab_control, "mean_max_OD.[xy]")
str(rel_ab_control)


#rel_ab_control$correction_factor <- rel_ab_control$mean_rel_ab / (rel_ab_control$mean_max_OD/sum(rel_ab_control$mean_max_OD))
# Calculate correction factor with a minimum value of ~1
rel_ab_control$correction_factor <- pmax(rel_ab_control$mean_rel_ab / (rel_ab_control$mean_max_OD / sum(rel_ab_control$mean_max_OD)), 1.1)


# Create a new dataframe for co-culture correction
co_culture_correction <- data.frame(
  species = rel_ab_control$Species,
  correction_factor = rel_ab_control$correction_factor
)


#summarise community data
#Adjust based on tested concentrations for each drug
unique(Community_compositions_focus_drugs_Chlorpromazine$concentration)

Community_compositions_focus_drugs_Chlorpromazine_5uM <- subset(Community_compositions_focus_drugs_Chlorpromazine, concentration == 5)
Community_compositions_focus_drugs_Chlorpromazine_20uM <- subset(Community_compositions_focus_drugs_Chlorpromazine, concentration == 20)


#5 uM
Community_compositions_focus_drugs_Chlorpromazine_5uM_summarised <- Community_compositions_focus_drugs_Chlorpromazine_5uM %>%
  dplyr::group_by(species) %>%                                  
  dplyr::summarize(
    mean_rel_ab = mean(rel_abundance, na.rm = TRUE),     
    sd_rel_ab = sd(rel_abundance, na.rm = TRUE) ,
    mean_max_OD = mean(maxOD, na.rm = TRUE),
    sd_max_OD = sd(maxOD, na.rm = TRUE),
    mean_final_OD = mean(finalOD, na.rm = TRUE),
    sd_final_OD = sd(finalOD, na.rm = TRUE)
  ) %>%
  dplyr::ungroup() 


Community_compositions_focus_drugs_Chlorpromazine_5uM_summarised <- Community_compositions_focus_drugs_Chlorpromazine_5uM_summarised %>%
  dplyr::mutate(Species = sub("^(\\w)\\w*\\s(.*)", "\\1._\\2", species))

#remove (sub)strain info
Community_compositions_focus_drugs_Chlorpromazine_5uM_summarised <- Community_compositions_focus_drugs_Chlorpromazine_5uM_summarised %>%
  dplyr::mutate(Species = sub("^(\\w\\._\\w+).*", "\\1", Species))


#20 uM
Community_compositions_focus_drugs_Chlorpromazine_20uM_summarised <- Community_compositions_focus_drugs_Chlorpromazine_20uM %>%
  dplyr::group_by(species) %>%                                  
  dplyr::summarize(
    mean_rel_ab = mean(rel_abundance, na.rm = TRUE),     
    sd_rel_ab = sd(rel_abundance, na.rm = TRUE) ,
    mean_max_OD = mean(maxOD, na.rm = TRUE),
    sd_max_OD = sd(maxOD, na.rm = TRUE),
    mean_final_OD = mean(finalOD, na.rm = TRUE),
    sd_final_OD = sd(finalOD, na.rm = TRUE)
  ) %>%
  dplyr::ungroup() 


Community_compositions_focus_drugs_Chlorpromazine_20uM_summarised <- Community_compositions_focus_drugs_Chlorpromazine_20uM_summarised %>%
  dplyr::mutate(Species = sub("^(\\w)\\w*\\s(.*)", "\\1._\\2", species))

#remove (sub)strain info
Community_compositions_focus_drugs_Chlorpromazine_20uM_summarised <- Community_compositions_focus_drugs_Chlorpromazine_20uM_summarised %>%
  dplyr::mutate(Species = sub("^(\\w\\._\\w+).*", "\\1", Species))



#Initialise data frames
sim_output <- data.frame()
input_params_list <- list() #Use a list to collect parameters for each simulation

#number of simulations
num_sims <- 250


for (i in 1:num_sims) {
  tryCatch({
    # generate model parameters
    set.seed(i) #set a different seed for each simulation for variation
    params <- lapply(1:nrow(growth_data_all_0_Niclosamide), function(idx) {
      species_params <- growth_data_all_0_Niclosamide[idx, ]
      list(
        r = rnorm(1, mean = species_params$mean_max_Growth_rate, sd = species_params$sd_max_Growth_rate),
        K = rnorm(1, mean = species_params$mean_max_OD, sd = species_params$sd_max_OD)
      )
    })
    names(params) <- gsub(" ", "_", growth_data_all_0_Niclosamide$Species)
    flat_params <- unlist(params)
    names(flat_params) <- gsub("\\.\\d$", "", names(flat_params))
    
    #replace spaces with underscores to match formatting
    co_culture_correction$species <- gsub(" ", "_", co_culture_correction$species, fixed = TRUE)
    
    #replace the species-specific K parameters extracted from monoculture growth data 
    #with drawn relative abundance values at Niclosamide = 0, scaled to K
    rel_ab_control$Species <- gsub(" ", "_", rel_ab_control$Species)
    
    #Initialise an empty vector to store drawn values
    drawn_values <- numeric(nrow(rel_ab_control))
    
    #draw values from their respective distributions
    for (k in 1:nrow(rel_ab_control)) {
      species_name <- rel_ab_control$Species[k]
      drawn_value <- rnorm(1, mean = rel_ab_control$mean_rel_ab[k], sd = rel_ab_control$sd_rel_ab[k])
      drawn_values[k] <- max(drawn_value, 0)  # Ensure no negative values
    }
    
    #Normalise drawn relative abundance values so they sum to 1 (to reflect a 'true' relative abundance distribution)
    #this is needed so when we convert the values into OD units by multiplying with the drawn community maxOD,
    # the sum of K_i parameters and the drawn K are equal
    normalised_values <- drawn_values / sum(drawn_values)
    
    #Pull community maxOD (K) at 0 drugs from respective normal distribution:
    K <- rnorm(n = 1, mean = rel_ab_control$mean_com_max_OD[1], sd = rel_ab_control$sd_com_max_OD[1])
    
    # Assign these normalised values to their respective species' .K parameters
    for (k in 1:nrow(rel_ab_control)) {
      species_name <- rel_ab_control$Species[k]
      k_index <- grep(paste0("^", species_name, "\\.K$"), names(flat_params))
      
      if (length(k_index) > 0) {
        old_value <- flat_params[k_index]
        flat_params[k_index] <- (normalised_values[k] + 0.0001) * K #add small value in case drawn K_i is 0, which would cause issues with the solver
        cat(sprintf("Updated %s from %f to %f using normalised value %f scaled by K %f\n", names(flat_params)[k_index], old_value, flat_params[k_index], normalised_values[k], K))
      }
    }
    
    #Accounting for variation in drug degradation by community, with standard deviation of end concentration (at 10h) around the fitted predicted (relative) end concentration at 24h
    #prop_left_Chlorpromazine <- abs(rnorm(1, (subset(drug_dynamics, Drug == "Chlorpromazine")$Prop_left_24h_community), (subset(drug_dynamics, Drug == "Chlorpromazine")$SD_drug_community))) 
    #below, we account for measurement error rather than ecological drivers that lead to the variability of degradation at the final point measured 
    prop_left_Chlorpromazine <- abs(rnorm(
      n = 1, 
      mean = subset(drug_dynamics, Drug == "Chlorpromazine")$Prop_left_24h_community, 
      sd = ifelse(
        subset(drug_dynamics, Drug == "Chlorpromazine")$SD_drug_community > subset(drug_dynamics, Drug == "Chlorpromazine")$SD_drug_community_start, 
        subset(drug_dynamics, Drug == "Chlorpromazine")$SD_drug_community - subset(drug_dynamics, Drug == "Chlorpromazine")$SD_drug_community_start, 
        subset(drug_dynamics, Drug == "Chlorpromazine")$SD_drug_community
      )
    ))
    
    
    #loop through each species in co_culture_correction
    for (j in 1:nrow(co_culture_correction)) {
      # Extract the species name and correction factor
      species_name <- co_culture_correction$species[j]
      correction_factor <- co_culture_correction$correction_factor[j]
      
      # Identify the corresponding growth rate parameter in flat_params
      #by matching the base species name (without .r)
      growth_rate_indices <- grep(paste0("^", species_name, "\\.r$"), names(flat_params))
      
      #take the growth rate parameter and apply the correction factor 
      for (index in growth_rate_indices) {
        flat_params[index] <- flat_params[index] * correction_factor
      }
    }
    
    flat_params
    # Store parameters for each simulation
    input_params_list[[i]] <- c(sim_ID = i, flat_params)
    
    # Run the model for the first 24-hour cycle
    solution_cycle_1 <- ode(y = initial_conditions, times = seq(from = 0, to = 24, by = 0.1), func = closed.sir.model_Chlorpromazine, parms = flat_params,   method = "lsoda", rtol = 1e-6, atol = 1e-6)
    
    # Dilution and second cycle
    end_of_cycle_1 <- solution_cycle_1[nrow(solution_cycle_1), -1]
    initial_conditions_cycle_2 <- end_of_cycle_1 / 50
    #accounting for the drugs being added with the new growth cycle as well:
    initial_conditions_cycle_2[33] <- initial_conditions_cycle_2[33] + drug_concentration_tested
    solution_cycle_2 <- ode(y = initial_conditions_cycle_2, times = seq(from = 24, to = 48, by = 0.1), func = closed.sir.model_Chlorpromazine, parms = flat_params,  method = "lsoda", rtol = 1e-6, atol = 1e-6)
    
    # Combine and format results
    combined_solution <- rbind(as.data.frame(solution_cycle_1), as.data.frame(solution_cycle_2)[-1,])
    combined_solution$sim_ID <- rep(i, nrow(combined_solution))
    combined_solution <- combined_solution %>%
      tidyr::gather(key = "Species", value = "Density", -time, -sim_ID) %>%
      dplyr::mutate(Hour = time) %>%
      dplyr::select(sim_ID, Hour, Species, Density)
    
    ##Append to sim_output
    sim_output <- rbind(sim_output, combined_solution)
  }, error = function(e) {
    cat(sprintf("Skipping simulation %d due to an error: %s\n", i, e$message))
  })
}



##Combine all parameter data into a single dataframe
input_params <- do.call(rbind, input_params_list)

# Add a "Species" column 
sim_output$Species_name <- species_names[as.numeric(as.character(sim_output$Species))]
sim_output$Species_name <- replace_na(sim_output$Species_name, "Drug")

#View(input_params)
#View(sim_output)

sim_output <- na.omit(sim_output)
successful_sim_ids <- unique(subset(sim_output, Hour == 48)$sim_ID)
length(successful_sim_ids)
sim_output1 <- sim_output[sim_output$sim_ID %in% successful_sim_ids, ]


#Transform sim_output so we have wide format by Species
sim_output_wide <- tidyr::pivot_wider(sim_output1, 
                                      names_from = Species_name, 
                                      values_from = Density,
                                      id_cols = c(sim_ID, Hour))

length(unique(sim_output_wide$sim_ID))
#calc community OD per timepoint
sim_output_wide$Total_OD <- rowSums(sim_output_wide[, 3:34], na.rm = TRUE)
#calculate and add relative abundances here as well:
species_columns <- colnames(sim_output_wide)[3:34] 

for (species in species_columns) {
  sim_output_wide[[paste0("rel_", species)]] <- sim_output_wide[[species]] / sim_output_wide$Total_OD
}


#assign sim_output_wide test conditions to dataframe name
drug_tested <- "Chlorpromazine"
variable_name_1 <- paste0("sim_output_wide_", ifelse(drug_concentration_tested == 1e-04, 0, drug_concentration_tested), "_", drug_tested)
assign(variable_name_1, sim_output_wide)

#turn back into long format if interested in plotting relative abundances
cols_needed <- c("sim_ID", "Hour")

sim_output_long <- sim_output_wide %>% 
  dplyr::select(sim_ID, Hour, Drug, starts_with("rel_")) %>% 
  tidyr::pivot_longer(
    cols = c(Drug, starts_with("rel_")),
    names_to = "Species", 
    values_to = "Relative_abundance",
    names_prefix = "rel_",
    names_transform = list(Species = ~ ifelse(.x == "Drug", "Drug", .x))
  ) 

str(sim_output_long)


species_names_1 <- c(
  "A_muciniphila",
  "B_adolescentis",
  "B_fragilis",
  "B_longum",
  "B_obeum",
  "B_thetaiotaomicron",
  "B_uniformis",
  "B_vulgatus",
  "B_wadsworthia",
  "C_aerofaciens",
  "C_bolteae",
  "C_comes",
  "C_perfringens",
  "C_ramosum",
  "C_saccharolyticum",
  "D_formicigenerans",
  "E_coli",
  "E_lenta",
  "E_rectale",
  "F_nucleatum",
  "L_paracasei",
  "O_splanchnicus",
  "P_copri",
  "P_distasonis",
  "P_merdae",
  "R_bromii",
  "R_gnavus",
  "R_intestinalis",
  "R_torques",
  "S_parasanguinis",
  "S_salivarius",
  "V_parvula",
  "Drug"
)

species_colours_1 <- c(
  "A_muciniphila" = "#1f77b4",
  "B_adolescentis" = "#ff7f0e",
  "B_fragilis" = "#2ca02c",
  "B_longum" = "#d62728",
  "B_obeum" = "#9467bd",
  "B_thetaiotaomicron" = "black",
  "B_uniformis" = "#e377c2",
  "B_vulgatus" = "#7f7f7f",
  "B_wadsworthia" = "gold1",
  "C_aerofaciens" = "#aec7e8",
  "C_bolteae" = "#ffbb78",
  "C_comes" = "magenta",
  "C_perfringens" = "#ff9896",
  "C_ramosum" = "#c5b0d5",
  "C_saccharolyticum" = "#c49c94",
  "D_formicigenerans" = "#f7b6d2",
  "E_coli" = "yellow",
  "E_lenta" = "turquoise",
  "E_rectale" = "#393b79",
  "F_nucleatum" = "royalblue2",
  "L_paracasei" = "blue",
  "O_splanchnicus" = "#637939",
  "P_copri" = "cyan",
  "P_distasonis" = "#8c6d31",
  "P_merdae" = "#c7c7c7",
  "R_bromii" = "#e6550d",
  "R_gnavus" = "#e7cb94",
  "R_intestinalis" = "#843c39",
  "R_torques" = "#d6616b",
  "S_parasanguinis" = "orange3",
  "S_salivarius" = "#7b4173",
  "V_parvula" = "#ce6dbd",
  "Drug" = "green"
)



##Plot output for any specific sim:
# ggplot(subset(sim_output, sim_ID == 1 & Species_name != "Drug"), aes(x = Hour, y = Density, group = Species_name, color = Species_name)) +
#   geom_line(size = 1, alpha = 0.7) +
#   scale_color_manual(values = species_colours_1) +
#   labs(title = paste0("Chlorpromazine = ", drug_concentration_tested),
#        x = "Time (hours)",
#        y = "Population Density (OD)",
#        color = "Species") +
#   theme_minimal() +
#   theme(legend.position = "right")
# 
# ggplot(subset(sim_output, sim_ID == 3 & Species_name != "Drug"), aes(x = Hour, y = Density, group = Species_name, color = Species_name)) +
#   geom_line(size = 1, alpha = 0.7) +
#   scale_color_manual(values = species_colours_1) +
#   labs(title = paste0("Chlorpromazine = ", drug_concentration_tested),
#        x = "Time (hours)",
#        y = "Population Density (OD)",
#        color = "Species") +
#   theme_minimal() +
#   theme(legend.position = "right")


ggplot(subset(sim_output_long, sim_ID == 1), aes(x = Hour, y = Relative_abundance, group = Species, color = Species)) +
  geom_line(size = 1, alpha = 0.7) +
  scale_color_manual(values = species_colours_1) +
  labs(title = paste0("Chlorpromazine = ", drug_concentration_tested),
       x = "Time (hours)",
       y = "Relative abundance",
       color = "Species") +
  theme_minimal() +
  theme(legend.position = "right")


ggplot(subset(sim_output_long, sim_ID == 3), aes(x = Hour, y = Relative_abundance, group = Species, color = Species)) +
  geom_line(size = 1, alpha = 0.7) +
  scale_color_manual(values = species_colours_1) +
  labs(title = paste0("Chlorpromazine = ", drug_concentration_tested),
       x = "Time (hours)",
       y = "Relative abundance",
       color = "Species") +
  theme_minimal() +
  theme(legend.position = "right")


#calc mean and standard deviation across sims
sim_stats <- sim_output_long %>%
  dplyr::group_by(Hour, Species) %>%
  dplyr::summarise(
    mean_rel_ab = mean(Relative_abundance),
    sd_rel_ab = sd(Relative_abundance),
    .groups = 'drop'
  )

# Prepare the data for plotting
plot_data <- sim_stats %>%
  dplyr::mutate(Upper = mean_rel_ab + sd_rel_ab, Lower = mean_rel_ab - sd_rel_ab)

ggplot(subset(plot_data, Species != "Drug"), aes(x = Hour, y = mean_rel_ab, group = Species, color = Species)) +
  geom_ribbon(aes(ymin = Lower, ymax = Upper, fill = Species), colour = NA, alpha = 0.2) +  
  geom_line(size = 1, alpha = 0.7) + 
  scale_color_manual(values = species_colours_1) +
  scale_fill_manual(values = species_colours_1) +  
  labs(title = "Mean and SD of Relative Abundance Across Simulations",
       subtitle = paste0("Chlorpromazine = ", drug_concentration_tested),       
       x = "Time (hours)",
       y = "Relative abundance",
       color = "Species",
       fill = "Species") +
  theme_minimal() +
  theme(legend.position = "right")

#log-scaled mean trends
ggplot(plot_data, aes(x = Hour, y = log10(mean_rel_ab + 0.0001), group = Species, color = Species)) +
  geom_line(size = 1, alpha = 0.7) +  # Mean line
  scale_color_manual(values = species_colours_1) +
  scale_fill_manual(values = species_colours_1) +  # Ensure consistent colors for lines and fills
  labs(title = "Mean and SD of Relative Abundance Across Simulations",
       subtitle = paste0("Chlorpromazine = ", drug_concentration_tested),
       x = "Time (hours)",
       y = "Relative abundance",
       color = "Species",
       fill = "Species") +
  theme_minimal() +
  theme(legend.position = "right")




##prediction quality evaluation
drug_tested <- "Chlorpromazine"
variable_name <- paste0("plot_data_", ifelse(drug_concentration_tested == 1e-04, 0, drug_concentration_tested), "_", drug_tested)
assign(variable_name, plot_data)


#extract total OD info:
predicted_mean_final_od_NULL <- Niclosamide_16S_0uM_summarised$mean_com_final_OD[1]
predicted_sd_final_od_NULL <- Niclosamide_16S_0uM_summarised$sd_com_final_OD[1]

predicted_mean_final_od_5_Chlorpromazine <- mean(subset(sim_output_wide_5_Chlorpromazine, Hour == 48)$Total_OD, na.rm = TRUE)
predicted_sd_final_od_5_Chlorpromazine <- sd(subset(sim_output_wide_5_Chlorpromazine, Hour == 48)$Total_OD, na.rm = TRUE)

real_mean_final_od_5_Chlorpromazine <- Community_compositions_focus_drugs_Chlorpromazine_5uM_summarised$mean_final_OD[1]
real_sd_final_od_5_Chlorpromazine <- Community_compositions_focus_drugs_Chlorpromazine_5uM_summarised$sd_final_OD[1]


predicted_mean_final_od_20_Chlorpromazine <- mean(subset(sim_output_wide_20_Chlorpromazine, Hour == 48)$Total_OD, na.rm = TRUE)
predicted_sd_final_od_20_Chlorpromazine <- sd(subset(sim_output_wide_20_Chlorpromazine, Hour == 48)$Total_OD, na.rm = TRUE)

real_mean_final_od_20_Chlorpromazine <- Community_compositions_focus_drugs_Chlorpromazine_20uM_summarised$mean_final_OD[1]
real_sd_final_od_20_Chlorpromazine <- Community_compositions_focus_drugs_Chlorpromazine_20uM_summarised$sd_final_OD[1]





#plot_data_0_Chlorpromazine_endpoint was used to test model performance at 0 drugs
#plot_data_0_Chlorpromazine_endpoint <- subset(plot_data_0_Chlorpromazine, Hour == 48 & Species != "Drug")
plot_data_5_Chlorpromazine_endpoint <- subset(plot_data_5_Chlorpromazine, Hour == 48 & Species != "Drug")
plot_data_20_Chlorpromazine_endpoint <- subset(plot_data_20_Chlorpromazine, Hour == 48 & Species != "Drug")

##Inspecting 'match' to real relative abundance distributions:
Niclosamide_16S_0uM_summarised <- rel_ab_control
Niclosamide_16S_0uM_summarised$Species <- gsub("\\.", "", Niclosamide_16S_0uM_summarised$Species)

Chlorpromazine_16S_5uM_summarised <- Community_compositions_focus_drugs_Chlorpromazine_5uM_summarised
Chlorpromazine_16S_20uM_summarised <- Community_compositions_focus_drugs_Chlorpromazine_20uM_summarised

Niclosamide_16S_0uM_summarised
Chlorpromazine_16S_5uM_summarised 
Chlorpromazine_16S_20uM_summarised 

#Rename 'species' so the outputs become comparable
original_names_20 <- unique(Chlorpromazine_16S_20uM_summarised$species)
original_names_5 <- unique(Chlorpromazine_16S_5uM_summarised$species)


##Create a named vector with the original and new names mapping
name_changes <- c(
  "Akkermansia muciniphila" = "A_muciniphila",
  "Bacteroides fragilis" = "B_fragilis",
  "Bacteroides thetaiotaomicron" = "B_thetaiotaomicron",
  "Bacteroides uniformis" = "B_uniformis",
  "Bifidobacterium adolescentis" = "B_adolescentis",
  "Bifidobacterium longum subsp. longum" = "B_longum",
  "Bilophila wadsworthia" = "B_wadsworthia",
  "Blautia obeum" = "B_obeum",
  "Clostridium perfringens" = "C_perfringens",
  "Collinsella aerofaciens" = "C_aerofaciens",
  "Coprococcus comes" = "C_comes",
  "Dorea formicigenerans" = "D_formicigenerans",
  "Eggerthella lenta" = "E_lenta",
  "Enterocloster bolteae" = "C_bolteae",
  "Erysipelatoclostridium ramosum" = "C_ramosum",
  "Escherichia coli ED1a" = "E_coli",
  "Eubacterium rectale" = "E_rectale",
  "Fusobacterium nucleatum subsp. nucleatum" = "F_nucleatum",
  "Lacrimispora saccharolytica" = "C_saccharolyticum",
  "Lacticaseibacillus paracasei" = "L_paracasei",
  "Odoribacter splanchnicus" = "O_splanchnicus",
  "Parabacteroides distasonis" = "P_distasonis",
  "Parabacteroides merdae" = "P_merdae",
  "Phocaeicola vulgatus" = "B_vulgatus",
  "Prevotella copri" = "P_copri",
  "Roseburia intestinalis" = "R_intestinalis",
  "Ruminococcus bromii" = "R_bromii",
  "Ruminococcus gnavus" = "R_gnavus",
  "Ruminococcus torques" = "R_torques",
  "Streptococcus parasanguinis" = "S_parasanguinis",
  "Streptococcus salivarius" = "S_salivarius",
  "Veillonella parvula" = "V_parvula"
)

# Apply name changes to the species column in Chlorpromazine_16S_80uM_summarised

Chlorpromazine_16S_20uM_summarised$Species <- name_changes[Chlorpromazine_16S_20uM_summarised$species]
Chlorpromazine_16S_5uM_summarised$Species <- name_changes[Chlorpromazine_16S_5uM_summarised$species]

# Verify the changes
unique(Chlorpromazine_16S_20uM_summarised$Species)
unique(Chlorpromazine_16S_5uM_summarised$Species)



##First, for 5 uM:
# Get top 6 species from plot_data_5_endpoint
# Adjust the plot_data_5_endpoint with confidence bounds

# #plot_data_0_Chlorpromazine_endpoint was used to test model performance at 0 drugs
# plot_data_0_Chlorpromazine_endpoint <- plot_data_0_Chlorpromazine_endpoint %>%
#   dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)

plot_data_5_Chlorpromazine_endpoint <- plot_data_5_Chlorpromazine_endpoint %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)

# Adjust the Chlorpromazine_16S_5uM_summarised with confidence bounds
Chlorpromazine_16S_5uM_summarised <- Chlorpromazine_16S_5uM_summarised %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)

#NULL model:
Null_model_summarised <- Niclosamide_16S_0uM_summarised %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)


# Get top 6 species based on the lower bound from plot_data_5_endpoint

#top6_predicted_0_Chlorpromazine was used to test model performance at 0 drugs
# top6_predicted_0_Chlorpromazine <- plot_data_0_Chlorpromazine_endpoint %>%
#    arrange(desc(lower_bound)) %>%
#    slice(1:6) %>%
#    pull(Species)

top6_predicted_5_Chlorpromazine <- plot_data_5_Chlorpromazine_endpoint %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

# Get top 6 species based on the lower bound from Chlorpromazine_16S_5uM_summarised
top6_real_5_Chlorpromazine <- Chlorpromazine_16S_5uM_summarised %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

top6_NULL <- Null_model_summarised %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

# Calculate the overlap of top 6 species

#top_six_correct_0_Chlorpromazine was used to assess model performance at 0 drugs
# top_six_correct_0_Chlorpromazine <- length(intersect(top6_predicted_0_Chlorpromazine, top6_NULL))
# top_six_correct_0_Chlorpromazine

top_six_correct_5_Chlorpromazine <- length(intersect(top6_predicted_5_Chlorpromazine, top6_real_5_Chlorpromazine))
top_six_correct_5_Chlorpromazine

top_six_correct_5_Chlorpromazine_NULL <- length(intersect(top6_NULL, top6_real_5_Chlorpromazine))
top_six_correct_5_Chlorpromazine_NULL

top6_predicted_5_Chlorpromazine
top6_real_5_Chlorpromazine

#top6_NULL

#Now by means:
# #top6_predicted_0_Chlorpromazine_means was used to assess model performance at 0 drugs
# top6_predicted_0_Chlorpromazine_means <- plot_data_0_Chlorpromazine_endpoint %>%
#    arrange(desc(mean_rel_ab)) %>%
#    slice(1:6) %>%
#    pull(Species)

top6_predicted_5_Chlorpromazine_means <- plot_data_5_Chlorpromazine_endpoint %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)

# Get top 6 species based on the lower bound from Chlorpromazine_16S_5uM_summarised
top6_real_5_Chlorpromazine_means <- Chlorpromazine_16S_5uM_summarised %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)

top6_NULL_means <- Null_model_summarised %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)


# #top_six_correct_0_Chlorpromazine_means was used to assess model performance at 0 drugs
# top_six_correct_0_Chlorpromazine_means <- length(intersect(top6_predicted_0_Chlorpromazine_means, top6_NULL_means))
# top_six_correct_0_Chlorpromazine_means

top_six_correct_5_Chlorpromazine_means <- length(intersect(top6_predicted_5_Chlorpromazine_means, top6_real_5_Chlorpromazine_means))
top_six_correct_5_Chlorpromazine_means

top_six_correct_5_Chlorpromazine_means_NULL <- length(intersect(top6_NULL_means, top6_real_5_Chlorpromazine_means))
top_six_correct_5_Chlorpromazine_means_NULL

top6_predicted_5_Chlorpromazine_means
top6_real_5_Chlorpromazine_means

#top6_NULL_means


# Merge dataframes by Species

#merged_data_0_Chlorpromazine was used to assess model performance at 0 drugs
#merged_data_0_Chlorpromazine <- merge(plot_data_0_Chlorpromazine_endpoint, Niclosamide_16S_0uM_summarised, by = "Species", suffixes = c(".pred", ".real"))
merged_data_5_Chlorpromazine <- merge(plot_data_5_Chlorpromazine_endpoint, Chlorpromazine_16S_5uM_summarised, by = "Species", suffixes = c(".pred", ".real"))
merged_data_5_Chlorpromazine_NULL <- merge(Niclosamide_16S_0uM_summarised, Chlorpromazine_16S_5uM_summarised, by = "Species", suffixes = c(".null", ".real"))


## Below lines used for assessing model performance at 0 drugs; ignore for nonzero concentrations
# # Create lower and upper bounds considering mean ¬± sd
# merged_data_0_Chlorpromazine$lower_bound_pred <- merged_data_0_Chlorpromazine$mean_rel_ab.pred - merged_data_0_Chlorpromazine$sd_rel_ab.pred
# merged_data_0_Chlorpromazine$upper_bound_pred <- merged_data_0_Chlorpromazine$mean_rel_ab.pred + merged_data_0_Chlorpromazine$sd_rel_ab.pred
# merged_data_0_Chlorpromazine$lower_bound_real <- merged_data_0_Chlorpromazine$mean_rel_ab.real - merged_data_0_Chlorpromazine$sd_rel_ab.real
# merged_data_0_Chlorpromazine$upper_bound_real <- merged_data_0_Chlorpromazine$mean_rel_ab.real + merged_data_0_Chlorpromazine$sd_rel_ab.real
# 
# # Ensure lower and upper bounds are non-negative, adjusting as necessary
# merged_data_0_Chlorpromazine$lower_bound_pred[merged_data_0_Chlorpromazine$lower_bound_pred <= 0] <- 1e-10
# merged_data_0_Chlorpromazine$lower_bound_real[merged_data_0_Chlorpromazine$lower_bound_real <= 0] <- 1e-10
# merged_data_0_Chlorpromazine$upper_bound_pred[merged_data_0_Chlorpromazine$upper_bound_pred <= 0] <- 1e-10
# merged_data_0_Chlorpromazine$upper_bound_real[merged_data_0_Chlorpromazine$upper_bound_real <= 0] <- 1e-10


# Create lower and upper bounds considering mean ¬± sd
merged_data_5_Chlorpromazine$lower_bound_pred <- merged_data_5_Chlorpromazine$mean_rel_ab.pred - merged_data_5_Chlorpromazine$sd_rel_ab.pred
merged_data_5_Chlorpromazine$upper_bound_pred <- merged_data_5_Chlorpromazine$mean_rel_ab.pred + merged_data_5_Chlorpromazine$sd_rel_ab.pred
merged_data_5_Chlorpromazine$lower_bound_real <- merged_data_5_Chlorpromazine$mean_rel_ab.real - merged_data_5_Chlorpromazine$sd_rel_ab.real
merged_data_5_Chlorpromazine$upper_bound_real <- merged_data_5_Chlorpromazine$mean_rel_ab.real + merged_data_5_Chlorpromazine$sd_rel_ab.real

# Ensure lower and upper bounds are non-negative, adjusting as necessary
merged_data_5_Chlorpromazine$lower_bound_pred[merged_data_5_Chlorpromazine$lower_bound_pred <= 0] <- 1e-10
merged_data_5_Chlorpromazine$lower_bound_real[merged_data_5_Chlorpromazine$lower_bound_real <= 0] <- 1e-10
merged_data_5_Chlorpromazine$upper_bound_pred[merged_data_5_Chlorpromazine$upper_bound_pred <= 0] <- 1e-10
merged_data_5_Chlorpromazine$upper_bound_real[merged_data_5_Chlorpromazine$upper_bound_real <= 0] <- 1e-10

##and for NULL model:
# Create lower and upper bounds considering mean ¬± sd
merged_data_5_Chlorpromazine_NULL$lower_bound_null <- merged_data_5_Chlorpromazine_NULL$mean_rel_ab.null - merged_data_5_Chlorpromazine_NULL$sd_rel_ab.null
merged_data_5_Chlorpromazine_NULL$upper_bound_null <- merged_data_5_Chlorpromazine_NULL$mean_rel_ab.null + merged_data_5_Chlorpromazine_NULL$sd_rel_ab.null
merged_data_5_Chlorpromazine_NULL$lower_bound_real <- merged_data_5_Chlorpromazine_NULL$mean_rel_ab.real - merged_data_5_Chlorpromazine_NULL$sd_rel_ab.real
merged_data_5_Chlorpromazine_NULL$upper_bound_real <- merged_data_5_Chlorpromazine_NULL$mean_rel_ab.real + merged_data_5_Chlorpromazine_NULL$sd_rel_ab.real

# Ensure lower and upper bounds are non-negative, adjusting as necessary
merged_data_5_Chlorpromazine_NULL$lower_bound_null[merged_data_5_Chlorpromazine_NULL$lower_bound_null <= 0] <- 1e-10
merged_data_5_Chlorpromazine_NULL$lower_bound_real[merged_data_5_Chlorpromazine_NULL$lower_bound_real <= 0] <- 1e-10
merged_data_5_Chlorpromazine_NULL$upper_bound_null[merged_data_5_Chlorpromazine_NULL$upper_bound_null <= 0] <- 1e-10
merged_data_5_Chlorpromazine_NULL$upper_bound_real[merged_data_5_Chlorpromazine_NULL$upper_bound_real <= 0] <- 1e-10

# Filter to include only species with a mean relative abundance > 0.01 in the 'real' dataset

## significant_species_0 was used to assess model performance at 0 drugs
#significant_species_0 <- merged_data_0_Chlorpromazine[merged_data_0_Chlorpromazine$mean_rel_ab.real > 0.01, ]
significant_species <- merged_data_5_Chlorpromazine[merged_data_5_Chlorpromazine$mean_rel_ab.real > 0.01, ]
survivors_5_Chlorpromazine <- nrow(significant_species)
survivors_5_Chlorpromazine

#should be the same as survivors defined above, since it is calculated from .real
significant_species_NULL <- merged_data_5_Chlorpromazine_NULL[merged_data_5_Chlorpromazine_NULL$mean_rel_ab.real > 0.01, ]
survivors_5_Chlorpromazine_NULL <- nrow(significant_species_NULL)
survivors_5_Chlorpromazine_NULL

# Adjusted order of magnitude check to include SD, only for significant species
## below code was used to assess model performance at 0 drugs
# significant_species_0$Predicted_magnitude_correct <- ifelse(
#   (floor(log10(significant_species_0$lower_bound_pred)) <= floor(log10(significant_species_0$upper_bound_real)) &
#      floor(log10(significant_species_0$upper_bound_pred)) >= floor(log10(significant_species_0$lower_bound_real))),
#   1,
#   0
# )

significant_species$Predicted_magnitude_correct <- ifelse(
  (floor(log10(significant_species$lower_bound_pred)) <= floor(log10(significant_species$upper_bound_real)) &
     floor(log10(significant_species$upper_bound_pred)) >= floor(log10(significant_species$lower_bound_real))),
  1,
  0
)

#and for the Null model:
significant_species_NULL$Predicted_magnitude_correct <- ifelse(
  (floor(log10(significant_species_NULL$lower_bound_null)) <= floor(log10(significant_species_NULL$upper_bound_real)) &
     floor(log10(significant_species_NULL$upper_bound_null)) >= floor(log10(significant_species_NULL$lower_bound_real))),
  1,
  0
)

# Calculate the fraction of correctly predicted magnitudes for significant species
## below code was used to assess model performance at 0 drugs
#predicted_magnitude_correct_fraction_0_Chlorpromazine <- sum(significant_species_0$Predicted_magnitude_correct) / nrow(significant_species_0)
#predicted_magnitude_correct_fraction_0_Chlorpromazine

predicted_magnitude_correct_fraction_5_Chlorpromazine <- sum(significant_species$Predicted_magnitude_correct) / nrow(significant_species)
predicted_magnitude_correct_fraction_5_Chlorpromazine

predicted_magnitude_correct_fraction_5_Chlorpromazine_NULL <- sum(significant_species_NULL$Predicted_magnitude_correct) / nrow(significant_species_NULL)
predicted_magnitude_correct_fraction_5_Chlorpromazine_NULL

top_species_missing_5_Chlorpromazine <- setdiff(top6_real_5_Chlorpromazine_means, top6_predicted_5_Chlorpromazine_means)
top_species_wrong_5_Chlorpromazine <- setdiff(top6_predicted_5_Chlorpromazine_means, top6_real_5_Chlorpromazine_means)

top_species_missing_5_Chlorpromazine <- if(length(top_species_missing_5_Chlorpromazine) == 0) "None" else top_species_missing_5_Chlorpromazine
top_species_wrong_5_Chlorpromazine <- if(length(top_species_wrong_5_Chlorpromazine) == 0) "None" else top_species_wrong_5_Chlorpromazine

Prediction_quality_5_Chlorpromazine <- data.frame(
  Top_six_correct = paste(top_six_correct_5_Chlorpromazine, sep=""),
  Top_six_correct_NULL = paste(top_six_correct_5_Chlorpromazine_NULL, sep=""),
  Top_six_correct_means = paste(top_six_correct_5_Chlorpromazine_means, sep=""),
  Top_six_correct_means_NULL = paste(top_six_correct_5_Chlorpromazine_means_NULL, sep=""),
  Predicted_magnitude_correct = paste(round(predicted_magnitude_correct_fraction_5_Chlorpromazine * 100, 2), "%", sep=""),
  Predicted_magnitude_correct_NULL = paste(round(predicted_magnitude_correct_fraction_5_Chlorpromazine_NULL * 100, 2), "%", sep=""),
  survivors_total = survivors_5_Chlorpromazine,
  top_species_missing <- top_species_missing_5_Chlorpromazine,
  top_species_wrong <- top_species_wrong_5_Chlorpromazine, 
  predicted_mean_final_OD <- predicted_mean_final_od_5_Chlorpromazine,
  real_mean_final_OD <- real_mean_final_od_5_Chlorpromazine,
  sims_total = length(successful_sim_ids)
)



Prediction_quality_5_Chlorpromazine



##Next, for 20 uM:
# Get top 6 species from plot_data_20_endpoint
# Adjust the plot_data_20_endpoint with confidence bounds
plot_data_20_Chlorpromazine_endpoint <- plot_data_20_Chlorpromazine_endpoint %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)

# Adjust the Chlorpromazine_16S_20uM_summarised with confidence bounds
Chlorpromazine_16S_20uM_summarised <- Chlorpromazine_16S_20uM_summarised %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)

#NULL model:
Null_model_summarised <- Niclosamide_16S_0uM_summarised %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)


# Get top 6 species based on the lower bound from plot_data_20_endpoint
top6_predicted_20_Chlorpromazine <- plot_data_20_Chlorpromazine_endpoint %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

# Get top 6 species based on the lower bound from Chlorpromazine_16S_20uM_summarised
top6_real_20_Chlorpromazine <- Chlorpromazine_16S_20uM_summarised %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

top6_NULL <- Null_model_summarised %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

# Calculate the overlap of top 6 species
top_six_correct_20_Chlorpromazine <- length(intersect(top6_predicted_20_Chlorpromazine, top6_real_20_Chlorpromazine))
#top_six_correct_20_Chlorpromazine

top_six_correct_20_Chlorpromazine_NULL <- length(intersect(top6_NULL, top6_real_20_Chlorpromazine))
#top_six_correct_20_Chlorpromazine_NULL

#top6_predicted_20_Chlorpromazine
#top6_real_20_Chlorpromazine



#Now by means:
top6_predicted_20_Chlorpromazine_means <- plot_data_20_Chlorpromazine_endpoint %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)

# Get top 6 species based on the lower bound from Chlorpromazine_16S_20uM_summarised
top6_real_20_Chlorpromazine_means <- Chlorpromazine_16S_20uM_summarised %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)

top6_NULL_means <- Null_model_summarised %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)



top_six_correct_20_Chlorpromazine_means <- length(intersect(top6_predicted_20_Chlorpromazine_means, top6_real_20_Chlorpromazine_means))
#top_six_correct_20_Chlorpromazine_means

top_six_correct_20_Chlorpromazine_means_NULL <- length(intersect(top6_NULL_means, top6_real_20_Chlorpromazine_means))
#top_six_correct_20_Chlorpromazine_means_NULL

top6_predicted_20_Chlorpromazine_means
#top6_real_20_Chlorpromazine_means




# Merge dataframes by Species
merged_data_20_Chlorpromazine <- merge(plot_data_20_Chlorpromazine_endpoint, Chlorpromazine_16S_20uM_summarised, by = "Species", suffixes = c(".pred", ".real"))
merged_data_20_Chlorpromazine_NULL <- merge(Niclosamide_16S_0uM_summarised, Chlorpromazine_16S_20uM_summarised, by = "Species", suffixes = c(".null", ".real"))



# Create lower and upper bounds considering mean ¬± sd
merged_data_20_Chlorpromazine$lower_bound_pred <- merged_data_20_Chlorpromazine$mean_rel_ab.pred - merged_data_20_Chlorpromazine$sd_rel_ab.pred
merged_data_20_Chlorpromazine$upper_bound_pred <- merged_data_20_Chlorpromazine$mean_rel_ab.pred + merged_data_20_Chlorpromazine$sd_rel_ab.pred
merged_data_20_Chlorpromazine$lower_bound_real <- merged_data_20_Chlorpromazine$mean_rel_ab.real - merged_data_20_Chlorpromazine$sd_rel_ab.real
merged_data_20_Chlorpromazine$upper_bound_real <- merged_data_20_Chlorpromazine$mean_rel_ab.real + merged_data_20_Chlorpromazine$sd_rel_ab.real

# Ensure lower and upper bounds are non-negative, adjusting as necessary
merged_data_20_Chlorpromazine$lower_bound_pred[merged_data_20_Chlorpromazine$lower_bound_pred <= 0] <- 1e-10
merged_data_20_Chlorpromazine$lower_bound_real[merged_data_20_Chlorpromazine$lower_bound_real <= 0] <- 1e-10
merged_data_20_Chlorpromazine$upper_bound_pred[merged_data_20_Chlorpromazine$upper_bound_pred <= 0] <- 1e-10
merged_data_20_Chlorpromazine$upper_bound_real[merged_data_20_Chlorpromazine$upper_bound_real <= 0] <- 1e-10

##and for NULL model:
# Create lower and upper bounds considering mean ¬± sd
merged_data_20_Chlorpromazine_NULL$lower_bound_null <- merged_data_20_Chlorpromazine_NULL$mean_rel_ab.null - merged_data_20_Chlorpromazine_NULL$sd_rel_ab.null
merged_data_20_Chlorpromazine_NULL$upper_bound_null <- merged_data_20_Chlorpromazine_NULL$mean_rel_ab.null + merged_data_20_Chlorpromazine_NULL$sd_rel_ab.null
merged_data_20_Chlorpromazine_NULL$lower_bound_real <- merged_data_20_Chlorpromazine_NULL$mean_rel_ab.real - merged_data_20_Chlorpromazine_NULL$sd_rel_ab.real
merged_data_20_Chlorpromazine_NULL$upper_bound_real <- merged_data_20_Chlorpromazine_NULL$mean_rel_ab.real + merged_data_20_Chlorpromazine_NULL$sd_rel_ab.real

# Ensure lower and upper bounds are non-negative, adjusting as necessary
merged_data_20_Chlorpromazine_NULL$lower_bound_null[merged_data_20_Chlorpromazine_NULL$lower_bound_null <= 0] <- 1e-10
merged_data_20_Chlorpromazine_NULL$lower_bound_real[merged_data_20_Chlorpromazine_NULL$lower_bound_real <= 0] <- 1e-10
merged_data_20_Chlorpromazine_NULL$upper_bound_null[merged_data_20_Chlorpromazine_NULL$upper_bound_null <= 0] <- 1e-10
merged_data_20_Chlorpromazine_NULL$upper_bound_real[merged_data_20_Chlorpromazine_NULL$upper_bound_real <= 0] <- 1e-10

# Filter to include only species with a mean relative abundance > 0.01 in the 'real' dataset
significant_species <- merged_data_20_Chlorpromazine[merged_data_20_Chlorpromazine$mean_rel_ab.real > 0.01, ]
survivors_20_Chlorpromazine <- nrow(significant_species)
survivors_20_Chlorpromazine

#should be the same as survivors defined above, since it is calculated from .real
significant_species_NULL <- merged_data_20_Chlorpromazine_NULL[merged_data_20_Chlorpromazine_NULL$mean_rel_ab.real > 0.01, ]
survivors_20_Chlorpromazine_NULL <- nrow(significant_species_NULL)
survivors_20_Chlorpromazine_NULL

# Adjusted order of magnitude check to include SD, only for significant species
significant_species$Predicted_magnitude_correct <- ifelse(
  (floor(log10(significant_species$lower_bound_pred)) <= floor(log10(significant_species$upper_bound_real)) &
     floor(log10(significant_species$upper_bound_pred)) >= floor(log10(significant_species$lower_bound_real))),
  1,
  0
)

#and for the Null model:
significant_species_NULL$Predicted_magnitude_correct <- ifelse(
  (floor(log10(significant_species_NULL$lower_bound_null)) <= floor(log10(significant_species_NULL$upper_bound_real)) &
     floor(log10(significant_species_NULL$upper_bound_null)) >= floor(log10(significant_species_NULL$lower_bound_real))),
  1,
  0
)

# Calculate the fraction of correctly predicted magnitudes for significant species
predicted_magnitude_correct_fraction_20_Chlorpromazine <- sum(significant_species$Predicted_magnitude_correct) / nrow(significant_species)
predicted_magnitude_correct_fraction_20_Chlorpromazine

predicted_magnitude_correct_fraction_20_Chlorpromazine_NULL <- sum(significant_species_NULL$Predicted_magnitude_correct) / nrow(significant_species_NULL)
predicted_magnitude_correct_fraction_20_Chlorpromazine_NULL

top_species_missing_20_Chlorpromazine <- setdiff(top6_real_20_Chlorpromazine_means, top6_predicted_20_Chlorpromazine_means)
top_species_wrong_20_Chlorpromazine <- setdiff(top6_predicted_20_Chlorpromazine_means, top6_real_20_Chlorpromazine_means)

Prediction_quality_20_Chlorpromazine <- data.frame(
  Top_six_correct = paste(top_six_correct_20_Chlorpromazine, sep=""),
  Top_six_correct_NULL = paste(top_six_correct_20_Chlorpromazine_NULL, sep=""),
  Top_six_correct_means = paste(top_six_correct_20_Chlorpromazine_means, sep=""),
  Top_six_correct_means_NULL = paste(top_six_correct_20_Chlorpromazine_means_NULL, sep=""),
  Predicted_magnitude_correct = paste(round(predicted_magnitude_correct_fraction_20_Chlorpromazine * 100, 2), "%", sep=""),
  Predicted_magnitude_correct_NULL = paste(round(predicted_magnitude_correct_fraction_20_Chlorpromazine_NULL * 100, 2), "%", sep=""),
  survivors_total = survivors_20_Chlorpromazine,
  top_species_missing <- top_species_missing_20_Chlorpromazine,
  top_species_wrong <- top_species_wrong_20_Chlorpromazine, 
  predicted_mean_final_OD <- predicted_mean_final_od_20_Chlorpromazine,
  real_mean_final_OD <- real_mean_final_od_20_Chlorpromazine,
  sims_total = length(successful_sim_ids)
)

Prediction_quality_20_Chlorpromazine













##Ciprofloxacin

combined_monoculture_aucs2_Ciprofloxacin <- subset(combined_monoculture_aucs2, drug == "Ciprofloxacin")


#drug sensitivity terms: define once outside of ODEs
y_function_B_vulgatus_Ciprofloxacin <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("B_vulgatus", "Ciprofloxacin", best_fitting_models_df_Ciprofloxacin)), collapse = " ")))
y_function_B_uniformis_Ciprofloxacin <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("B_uniformis", "Ciprofloxacin", best_fitting_models_df_Ciprofloxacin)), collapse = " ")))
y_function_B_fragilis_Ciprofloxacin <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("B_fragilis", "Ciprofloxacin", best_fitting_models_df_Ciprofloxacin)), collapse = " ")))
y_function_B_thetaiotaomicron_Ciprofloxacin <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("B_thetaiotaomicron", "Ciprofloxacin", best_fitting_models_df_Ciprofloxacin)), collapse = " ")))
y_function_C_ramosum_Ciprofloxacin <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("C_ramosum", "Ciprofloxacin", best_fitting_models_df_Ciprofloxacin)), collapse = " ")))
y_function_E_rectale_Ciprofloxacin <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("E_rectale", "Ciprofloxacin", best_fitting_models_df_Ciprofloxacin)), collapse = " ")))
y_function_R_intestinalis_Ciprofloxacin <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("R_intestinalis", "Ciprofloxacin", best_fitting_models_df_Ciprofloxacin)), collapse = " ")))
y_function_V_parvula_Ciprofloxacin <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("V_parvula", "Ciprofloxacin", best_fitting_models_df_Ciprofloxacin)), collapse = " ")))
y_function_E_lenta_Ciprofloxacin <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("E_lenta", "Ciprofloxacin", best_fitting_models_df_Ciprofloxacin)), collapse = " ")))
y_function_F_nucleatum_Ciprofloxacin <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("F_nucleatum", "Ciprofloxacin", best_fitting_models_df_Ciprofloxacin)), collapse = " ")))
y_function_C_bolteae_Ciprofloxacin <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("C_bolteae", "Ciprofloxacin", best_fitting_models_df_Ciprofloxacin)), collapse = " ")))
y_function_C_perfringens_Ciprofloxacin <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("C_perfringens", "Ciprofloxacin", best_fitting_models_df_Ciprofloxacin)), collapse = " ")))
y_function_C_saccharolyticum_Ciprofloxacin <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("C_saccharolyticum", "Ciprofloxacin", best_fitting_models_df_Ciprofloxacin)), collapse = " ")))
y_function_S_salivarius_Ciprofloxacin <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("S_salivarius", "Ciprofloxacin", best_fitting_models_df_Ciprofloxacin)), collapse = " ")))
y_function_R_gnavus_Ciprofloxacin <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("R_gnavus", "Ciprofloxacin", best_fitting_models_df_Ciprofloxacin)), collapse = " ")))
y_function_C_comes_Ciprofloxacin <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("C_comes", "Ciprofloxacin", best_fitting_models_df_Ciprofloxacin)), collapse = " ")))
y_function_P_merdae_Ciprofloxacin <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("P_merdae", "Ciprofloxacin", best_fitting_models_df_Ciprofloxacin)), collapse = " ")))
y_function_S_parasanguinis_Ciprofloxacin <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("S_parasanguinis", "Ciprofloxacin", best_fitting_models_df_Ciprofloxacin)), collapse = " ")))
y_function_C_aerofaciens_Ciprofloxacin <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("C_aerofaciens", "Ciprofloxacin", best_fitting_models_df_Ciprofloxacin)), collapse = " ")))
y_function_D_formicigenerans_Ciprofloxacin <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("D_formicigenerans", "Ciprofloxacin", best_fitting_models_df_Ciprofloxacin)), collapse = " ")))
y_function_E_coli_Ciprofloxacin <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("E_coli", "Ciprofloxacin", best_fitting_models_df_Ciprofloxacin)), collapse = " ")))



y_function_B_vulgatus_Ciprofloxacin_func <- eval(parse(text = paste("function(Drug) {", y_function_B_vulgatus_Ciprofloxacin, "}")))
y_function_B_uniformis_Ciprofloxacin_func <- eval(parse(text = paste("function(Drug) {", y_function_B_uniformis_Ciprofloxacin, "}")))
y_function_B_fragilis_Ciprofloxacin_func <- eval(parse(text = paste("function(Drug) {", y_function_B_fragilis_Ciprofloxacin, "}")))
y_function_B_thetaiotaomicron_Ciprofloxacin_func <- eval(parse(text = paste("function(Drug) {", y_function_B_thetaiotaomicron_Ciprofloxacin, "}")))
y_function_C_ramosum_Ciprofloxacin_func <- eval(parse(text = paste("function(Drug) {", y_function_C_ramosum_Ciprofloxacin, "}")))
y_function_E_rectale_Ciprofloxacin_func <- eval(parse(text = paste("function(Drug) {", y_function_E_rectale_Ciprofloxacin, "}")))
y_function_R_intestinalis_Ciprofloxacin_func <- eval(parse(text = paste("function(Drug) {", y_function_R_intestinalis_Ciprofloxacin, "}")))
y_function_E_lenta_Ciprofloxacin_func <- eval(parse(text = paste("function(Drug) {", y_function_E_lenta_Ciprofloxacin, "}")))
y_function_F_nucleatum_Ciprofloxacin_func <- eval(parse(text = paste("function(Drug) {", y_function_F_nucleatum_Ciprofloxacin, "}")))
y_function_C_bolteae_Ciprofloxacin_func <- eval(parse(text = paste("function(Drug) {", y_function_C_bolteae_Ciprofloxacin, "}")))
y_function_C_perfringens_Ciprofloxacin_func <- eval(parse(text = paste("function(Drug) {", y_function_C_perfringens_Ciprofloxacin, "}")))
y_function_C_saccharolyticum_Ciprofloxacin_func <- eval(parse(text = paste("function(Drug) {", y_function_C_saccharolyticum_Ciprofloxacin, "}")))
y_function_S_salivarius_Ciprofloxacin_func <- eval(parse(text = paste("function(Drug) {", y_function_S_salivarius_Ciprofloxacin, "}")))
y_function_R_gnavus_Ciprofloxacin_func <- eval(parse(text = paste("function(Drug) {", y_function_R_gnavus_Ciprofloxacin, "}")))
y_function_C_comes_Ciprofloxacin_func <- eval(parse(text = paste("function(Drug) {", y_function_C_comes_Ciprofloxacin, "}")))
y_function_P_merdae_Ciprofloxacin_func <- eval(parse(text = paste("function(Drug) {", y_function_P_merdae_Ciprofloxacin, "}")))
y_function_S_parasanguinis_Ciprofloxacin_func <- eval(parse(text = paste("function(Drug) {", y_function_S_parasanguinis_Ciprofloxacin, "}")))
y_function_C_aerofaciens_Ciprofloxacin_func <- eval(parse(text = paste("function(Drug) {", y_function_C_aerofaciens_Ciprofloxacin, "}")))
y_function_D_formicigenerans_Ciprofloxacin_func <- eval(parse(text = paste("function(Drug) {", y_function_D_formicigenerans_Ciprofloxacin, "}")))
y_function_E_coli_Ciprofloxacin_func <- eval(parse(text = paste("function(Drug) {", y_function_E_coli_Ciprofloxacin, "}")))
y_function_V_parvula_Ciprofloxacin_func <- eval(parse(text = paste("function(Drug) {", y_function_V_parvula_Ciprofloxacin, "}")))



unique(combined_monoculture_aucs2_Ciprofloxacin$conc)
##dictate drug concentration tested for simulation cycle here:
#drug_concentration_tested <- 20 #if manually or:
drug_concentration_tested <- unique(combined_monoculture_aucs2_Ciprofloxacin$conc)[1] 
initial_conditions <- rep(0.01/32, 32)
initial_conditions <- c(initial_conditions, drug_concentration_tested)


##drug effect fitted for species showing sensitivity in monoculture:
#unique(combined_monoculture_aucs2_Ciprofloxacin$Species)

##for more simple linear fits
closed.sir.model_Ciprofloxacin <- function (t, x, params) {
  ## first extract the state variables
  A_muciniphila <- x[1]
  B_adolescentis <- x[2]
  B_fragilis <- x[3]
  B_longum <- x[4]
  B_obeum <- x[5]
  B_thetaiotaomicron <- x[6]
  B_uniformis <- x[7]
  B_vulgatus <- x[8]
  B_wadsworthia <- x[9]
  C_aerofaciens <- x[10]
  C_bolteae <- x[11]
  C_comes <- x[12]
  C_perfringens <- x[13]
  C_ramosum <- x[14]
  C_saccharolyticum <- x[15]
  D_formicigenerans <- x[16]
  E_coli <- x[17]
  E_lenta <- x[18]
  E_rectale <- x[19]
  F_nucleatum <- x[20]
  L_paracasei <- x[21]
  O_splanchnicus <- x[22]
  P_copri <- x[23]
  P_distasonis <- x[24]
  P_merdae <- x[25]
  R_bromii <- x[26]
  R_gnavus <- x[27]
  R_intestinalis <- x[28]
  R_torques <- x[29]
  S_parasanguinis <- x[30]
  S_salivarius <- x[31]
  V_parvula <- x[32]
  Drug <- x[33]
  
  
  ## now extract the parameters
  r_B_fragilis <- flat_params[["B._fragilis.r"]]
  K_B_fragilis <- flat_params[["B._fragilis.K"]]
  r_B_longum <- flat_params[["B._longum.r"]]
  K_B_longum <- flat_params[["B._longum.K"]]
  r_B_thetaiotaomicron <- flat_params[["B._thetaiotaomicron.r"]]
  K_B_thetaiotaomicron <- flat_params[["B._thetaiotaomicron.K"]]
  r_B_uniformis <- flat_params[["B._uniformis.r"]]
  K_B_uniformis <- flat_params[["B._uniformis.K"]]
  r_B_vulgatus <- flat_params[["B._vulgatus.r"]]
  K_B_vulgatus <- flat_params[["B._vulgatus.K"]]
  r_B_wadsworthia <- flat_params[["B._wadsworthia.r"]]
  K_B_wadsworthia <- flat_params[["B._wadsworthia.K"]]
  r_C_aerofaciens <- flat_params[["C._aerofaciens.r"]]
  K_C_aerofaciens <- flat_params[["C._aerofaciens.K"]]
  r_C_bolteae <- flat_params[["C._bolteae.r"]]
  K_C_bolteae <- flat_params[["C._bolteae.K"]]
  r_C_comes <- flat_params[["C._comes.r"]]
  K_C_comes <- flat_params[["C._comes.K"]]
  r_C_perfringens <- flat_params[["C._perfringens.r"]]
  K_C_perfringens <- flat_params[["C._perfringens.K"]]
  r_C_ramosum <- flat_params[["C._ramosum.r"]]
  K_C_ramosum <- flat_params[["C._ramosum.K"]]
  r_C_saccharolyticum <- flat_params[["C._saccharolyticum.r"]]
  K_C_saccharolyticum <- flat_params[["C._saccharolyticum.K"]]
  r_D_formicigenerans <- flat_params[["D._formicigenerans.r"]]
  K_D_formicigenerans <- flat_params[["D._formicigenerans.K"]]
  r_E_coli <- flat_params[["E._coli.r"]]
  K_E_coli <- flat_params[["E._coli.K"]]
  r_E_lenta <- flat_params[["E._lenta.r"]]
  K_E_lenta <- flat_params[["E._lenta.K"]]
  r_E_rectale <- flat_params[["E._rectale.r"]]
  K_E_rectale <- flat_params[["E._rectale.K"]]
  r_F_nucleatum <- flat_params[["F._nucleatum.r"]]
  K_F_nucleatum <- flat_params[["F._nucleatum.K"]]
  r_P_copri <- flat_params[["P._copri.r"]]
  K_P_copri <- flat_params[["P._copri.K"]]
  r_P_merdae <- flat_params[["P._merdae.r"]]
  K_P_merdae <- flat_params[["P._merdae.K"]]
  r_R_gnavus <- flat_params[["R._gnavus.r"]]
  K_R_gnavus <- flat_params[["R._gnavus.K"]]
  r_R_intestinalis <- flat_params[["R._intestinalis.r"]]
  K_R_intestinalis <- flat_params[["R._intestinalis.K"]]
  r_V_parvula <- flat_params[["V._parvula.r"]]
  K_V_parvula <- flat_params[["V._parvula.K"]]
  r_A_muciniphila <- flat_params[["A._muciniphila.r"]]
  K_A_muciniphila <- flat_params[["A._muciniphila.K"]]
  r_B_adolescentis <- flat_params[["B._adolescentis.r"]]
  K_B_adolescentis <- flat_params[["B._adolescentis.K"]]
  r_B_obeum <- flat_params[["B._obeum.r"]]
  K_B_obeum <- flat_params[["B._obeum.K"]]
  r_O_splanchnicus <- flat_params[["O._splanchnicus.r"]]
  K_O_splanchnicus <- flat_params[["O._splanchnicus.K"]]
  r_P_distasonis <- flat_params[["P._distasonis.r"]]
  K_P_distasonis <- flat_params[["P._distasonis.K"]]
  r_R_bromii <- flat_params[["R._bromii.r"]]
  K_R_bromii <- flat_params[["R._bromii.K"]]
  r_R_torques <- flat_params[["R._torques.r"]]
  K_R_torques <- flat_params[["R._torques.K"]]
  r_S_parasanguinis <- flat_params[["S._parasanguinis.r"]]
  K_S_parasanguinis <-flat_params[["S._parasanguinis.K"]]
  r_S_salivarius <- flat_params[["S._salivarius.r"]]
  K_S_salivarius <- flat_params[["S._salivarius.K"]]
  r_L_paracasei <- flat_params[["L._paracasei.r"]]
  K_L_paracasei <- flat_params[["L._paracasei.K"]]
  
  
  t_mod <- ifelse(t > 24.1, t - 24.1, t)
  
  
  ## now code the model equations
  dA_muciniphila_dt <- r_A_muciniphila * A_muciniphila * (1 - A_muciniphila / K_A_muciniphila)
  dB_adolescentis_dt <- r_B_adolescentis * B_adolescentis * (1 - B_adolescentis / K_B_adolescentis)
  dB_fragilis_dt <- r_B_fragilis * B_fragilis * (1 - B_fragilis / max(0.0001, K_B_fragilis * (y_function_B_fragilis_Ciprofloxacin_func(Drug))))
  dB_longum_dt <- r_B_longum * B_longum * (1 - B_longum / K_B_longum)
  dB_obeum_dt <- r_B_obeum * B_obeum * (1 - B_obeum / K_B_obeum)
  dB_thetaiotaomicron_dt <- r_B_thetaiotaomicron * B_thetaiotaomicron * (1 - B_thetaiotaomicron / max(0.0001, K_B_thetaiotaomicron * (y_function_B_thetaiotaomicron_Ciprofloxacin_func(Drug))))  
  dB_uniformis_dt <- r_B_uniformis * B_uniformis * (1 - B_uniformis / max(0.0001, K_B_uniformis * (y_function_B_uniformis_Ciprofloxacin_func(Drug))))
  dB_vulgatus_dt <- r_B_vulgatus * B_vulgatus * (1 - B_vulgatus / max(0.0001, K_B_vulgatus * (y_function_B_vulgatus_Ciprofloxacin_func(Drug))))
  dB_wadsworthia_dt <- r_B_wadsworthia * B_wadsworthia * (1 - B_wadsworthia / K_B_wadsworthia)
  dC_aerofaciens_dt <- r_C_aerofaciens * C_aerofaciens * (1 - C_aerofaciens / max(0.0001, K_C_aerofaciens * (y_function_C_aerofaciens_Ciprofloxacin_func(Drug))))
  dC_bolteae_dt <- r_C_bolteae * C_bolteae * (1 - C_bolteae /  max(0.0001, K_C_bolteae * (y_function_C_bolteae_Ciprofloxacin_func(Drug))))
  dC_comes_dt <- r_C_comes * C_comes * (1 - C_comes / max(0.0001, K_C_comes * (y_function_C_comes_Ciprofloxacin_func(Drug))))
  dC_perfringens_dt <- r_C_perfringens * C_perfringens * (1 - C_perfringens / max(0.0001, K_C_perfringens * (y_function_C_perfringens_Ciprofloxacin_func(Drug))))
  dC_ramosum_dt <- r_C_ramosum * C_ramosum * (1 - C_ramosum / max(0.0001, K_C_ramosum * (y_function_C_ramosum_Ciprofloxacin_func(Drug))))
  dC_saccharolyticum_dt <- r_C_saccharolyticum * C_saccharolyticum * (1 - C_saccharolyticum / max(0.0001, K_C_saccharolyticum * (y_function_C_saccharolyticum_Ciprofloxacin_func(Drug))))
  dD_formicigenerans_dt <- r_D_formicigenerans * D_formicigenerans * (1 - D_formicigenerans / max(0.0001, K_D_formicigenerans * (y_function_D_formicigenerans_Ciprofloxacin_func(Drug))))
  dE_coli_dt <- r_E_coli * E_coli * (1 - E_coli / max(0.0001, K_E_coli * (y_function_E_coli_Ciprofloxacin_func(Drug))))
  dE_lenta_dt <- r_E_lenta * E_lenta * (1 - E_lenta / max(0.0001, K_E_lenta * (y_function_E_lenta_Ciprofloxacin_func(Drug))))
  dE_rectale_dt <- r_E_rectale * E_rectale * (1 - E_rectale / max(0.0001, K_E_rectale * (y_function_E_rectale_Ciprofloxacin_func(Drug))))
  dF_nucleatum_dt <- r_F_nucleatum * F_nucleatum * (1 - F_nucleatum / max(0.0001, K_F_nucleatum * (y_function_F_nucleatum_Ciprofloxacin_func(Drug))))
  dL_paracasei_dt <- r_L_paracasei * L_paracasei * (1 - L_paracasei / K_L_paracasei)  
  dO_splanchnicus_dt <- r_O_splanchnicus * O_splanchnicus * (1 - O_splanchnicus / K_O_splanchnicus)  
  dP_copri_dt <- r_P_copri * P_copri * (1 - P_copri / K_P_copri)
  dP_distasonis_dt <- r_P_distasonis * P_distasonis * (1 - P_distasonis / K_P_distasonis)  
  dP_merdae_dt <- r_P_merdae * P_merdae * (1 - P_merdae / max(0.0001, K_P_merdae * (y_function_P_merdae_Ciprofloxacin_func(Drug))))
  dR_bromii_dt <- r_R_bromii * R_bromii * (1 - R_bromii / K_R_bromii) 
  dR_gnavus_dt <- r_R_gnavus * R_gnavus * (1 - R_gnavus / max(0.0001, K_R_gnavus * (y_function_R_gnavus_Ciprofloxacin_func(Drug))))
  dR_intestinalis_dt <- r_R_intestinalis * R_intestinalis * (1 - R_intestinalis / max(0.0001, K_R_intestinalis * (y_function_R_intestinalis_Ciprofloxacin_func(Drug))))
  dR_torques_dt <- r_R_torques * R_torques * (1 - R_torques /K_R_torques) 
  dS_parasanguinis_dt <- r_S_parasanguinis * S_parasanguinis * (1 - S_parasanguinis / max(0.0001, K_S_parasanguinis * (y_function_S_parasanguinis_Ciprofloxacin_func(Drug))))
  dS_salivarius_dt <- r_S_salivarius * S_salivarius * (1 - S_salivarius / max(0.0001, K_S_salivarius * (y_function_S_salivarius_Ciprofloxacin_func(Drug))))
  dV_parvula_dt <- r_V_parvula * V_parvula * (1 - V_parvula / max(0.0001, K_V_parvula * (y_function_V_parvula_Ciprofloxacin_func(Drug))))
  
  
  
  #Drug differential:
  dDrug_dt <- (subset(drug_dynamics, Drug == "Ciprofloxacin")$Steepness_param_community * exp(-subset(drug_dynamics, Drug == "Ciprofloxacin")$Steepness_param_community * t_mod)) * (drug_concentration_tested * prop_left_Ciprofloxacin - drug_concentration_tested)
  #dDrug_dt <- 0
  
  ## Combine results into a single vector
  dxdt <- c(dA_muciniphila_dt, dB_adolescentis_dt, dB_fragilis_dt, dB_longum_dt, dB_obeum_dt, dB_thetaiotaomicron_dt, dB_uniformis_dt, dB_vulgatus_dt, dB_wadsworthia_dt, dC_aerofaciens_dt, dC_bolteae_dt, dC_comes_dt, dC_perfringens_dt, dC_ramosum_dt, dC_saccharolyticum_dt, dD_formicigenerans_dt, dE_coli_dt, dE_lenta_dt, dE_rectale_dt, dF_nucleatum_dt, dL_paracasei_dt, dO_splanchnicus_dt, dP_copri_dt, dP_distasonis_dt, dP_merdae_dt, dR_bromii_dt, dR_gnavus_dt, dR_intestinalis_dt, dR_torques_dt, dS_parasanguinis_dt, dS_salivarius_dt, dV_parvula_dt, dDrug_dt)
  
  ## Return result as a list
  list(dxdt)
}




#calculate the co-culture correction factor per species based on community composition in absence of drug, just like done for Niclosamide

growth_data_all_0_Niclosamide
growth_data_all_0_Niclosamide1 <- growth_data_all_0_Niclosamide %>%
  dplyr::mutate(Species = gsub(" ", "_", Species))


# Merge rel_ab_control with growth_data_all_0_Niclosamide on Species
# Function to remove duplicated columns by name pattern
clean_columns_base <- function(df, pattern) {
  cols_to_keep <- !grepl(pattern, names(df))
  df <- df[, cols_to_keep]
  return(df)
}

# Use the new function to clean up your dataframe
rel_ab_control <- clean_columns_base(rel_ab_control, "mean_max_OD.[xy]")
str(rel_ab_control)


#rel_ab_control$correction_factor <- rel_ab_control$mean_rel_ab / (rel_ab_control$mean_max_OD/sum(rel_ab_control$mean_max_OD))
# Calculate correction factor with a minimum value of ~1
rel_ab_control$correction_factor <- pmax(rel_ab_control$mean_rel_ab / (rel_ab_control$mean_max_OD / sum(rel_ab_control$mean_max_OD)), 1.1)


# Create a new dataframe for co-culture correction
co_culture_correction <- data.frame(
  species = rel_ab_control$Species,
  correction_factor = rel_ab_control$correction_factor
)


#summarise community data
#Adjust based on tested concentrations for each drug
unique(Community_compositions_focus_drugs_Ciprofloxacin$concentration)

Community_compositions_focus_drugs_Ciprofloxacin_20uM <- subset(Community_compositions_focus_drugs_Ciprofloxacin, concentration == 20)
Community_compositions_focus_drugs_Ciprofloxacin_80uM <- subset(Community_compositions_focus_drugs_Ciprofloxacin, concentration == 80)


#20 uM
Community_compositions_focus_drugs_Ciprofloxacin_20uM_summarised <- Community_compositions_focus_drugs_Ciprofloxacin_20uM %>%
  dplyr::group_by(species) %>%                                  
  dplyr::summarize(
    mean_rel_ab = mean(rel_abundance, na.rm = TRUE),     
    sd_rel_ab = sd(rel_abundance, na.rm = TRUE) ,
    mean_max_OD = mean(maxOD, na.rm = TRUE),
    sd_max_OD = sd(maxOD, na.rm = TRUE),
    mean_final_OD = mean(finalOD, na.rm = TRUE),
    sd_final_OD = sd(finalOD, na.rm = TRUE)
  ) %>%
  dplyr::ungroup() 


Community_compositions_focus_drugs_Ciprofloxacin_20uM_summarised <- Community_compositions_focus_drugs_Ciprofloxacin_20uM_summarised %>%
  dplyr::mutate(Species = sub("^(\\w)\\w*\\s(.*)", "\\1._\\2", species))

#remove (sub)strain info
Community_compositions_focus_drugs_Ciprofloxacin_20uM_summarised <- Community_compositions_focus_drugs_Ciprofloxacin_20uM_summarised %>%
  dplyr::mutate(Species = sub("^(\\w\\._\\w+).*", "\\1", Species))


#80 uM
Community_compositions_focus_drugs_Ciprofloxacin_80uM_summarised <- Community_compositions_focus_drugs_Ciprofloxacin_80uM %>%
  dplyr::group_by(species) %>%                                  
  dplyr::summarize(
    mean_rel_ab = mean(rel_abundance, na.rm = TRUE),     
    sd_rel_ab = sd(rel_abundance, na.rm = TRUE) ,
    mean_max_OD = mean(maxOD, na.rm = TRUE),
    sd_max_OD = sd(maxOD, na.rm = TRUE),    
    mean_final_OD = mean(finalOD, na.rm = TRUE),
    sd_final_OD = sd(finalOD, na.rm = TRUE)
  ) %>%
  dplyr::ungroup() 



Community_compositions_focus_drugs_Ciprofloxacin_80uM_summarised <- Community_compositions_focus_drugs_Ciprofloxacin_80uM_summarised %>%
  dplyr::mutate(Species = sub("^(\\w)\\w*\\s(.*)", "\\1._\\2", species))

#remove (sub)strain info
Community_compositions_focus_drugs_Ciprofloxacin_80uM_summarised <- Community_compositions_focus_drugs_Ciprofloxacin_80uM_summarised %>%
  dplyr::mutate(Species = sub("^(\\w\\._\\w+).*", "\\1", Species))


#Initialise data frames
sim_output <- data.frame()
input_params_list <- list() #Use a list to collect parameters for each simulation

#number of simulations
num_sims <- 250


for (i in 1:num_sims) {
  tryCatch({
    # generate model parameters
    set.seed(i) #set a different seed for each simulation for variation
    params <- lapply(1:nrow(growth_data_all_0_Niclosamide), function(idx) {
      species_params <- growth_data_all_0_Niclosamide[idx, ]
      list(
        r = rnorm(1, mean = species_params$mean_max_Growth_rate, sd = species_params$sd_max_Growth_rate),
        K = rnorm(1, mean = species_params$mean_max_OD, sd = species_params$sd_max_OD)
      )
    })
    names(params) <- gsub(" ", "_", growth_data_all_0_Niclosamide$Species)
    flat_params <- unlist(params)
    names(flat_params) <- gsub("\\.\\d$", "", names(flat_params))
    
    #replace spaces with underscores to match formatting
    co_culture_correction$species <- gsub(" ", "_", co_culture_correction$species, fixed = TRUE)
    
    #replace the species-specific K parameters extracted from monoculture growth data 
    #with drawn relative abundance values at Niclosamide = 0, scaled to K
    rel_ab_control$Species <- gsub(" ", "_", rel_ab_control$Species)
    
    #Initialise an empty vector to store drawn values
    drawn_values <- numeric(nrow(rel_ab_control))
    
    #draw values from their respective distributions
    for (k in 1:nrow(rel_ab_control)) {
      species_name <- rel_ab_control$Species[k]
      drawn_value <- rnorm(1, mean = rel_ab_control$mean_rel_ab[k], sd = rel_ab_control$sd_rel_ab[k])
      drawn_values[k] <- max(drawn_value, 0)  # Ensure no negative values
    }
    
    #Normalise drawn relative abundance values so they sum to 1 (to reflect a 'true' relative abundance distribution)
    #this is needed so when we convert the values into OD units by multiplying with the drawn community maxOD,
    # the sum of K_i parameters and the drawn K are equal
    normalised_values <- drawn_values / sum(drawn_values)
    
    #Pull community maxOD (K) at 0 drugs from respective normal distribution:
    K <- rnorm(n = 1, mean = rel_ab_control$mean_com_max_OD[1], sd = rel_ab_control$sd_com_max_OD[1])
    
    # Assign these normalised values to their respective species' .K parameters
    for (k in 1:nrow(rel_ab_control)) {
      species_name <- rel_ab_control$Species[k]
      k_index <- grep(paste0("^", species_name, "\\.K$"), names(flat_params))
      
      if (length(k_index) > 0) {
        old_value <- flat_params[k_index]
        flat_params[k_index] <- (normalised_values[k] + 0.0001) * K #add small value in case drawn K_i is 0, which would cause issues with the solver
        cat(sprintf("Updated %s from %f to %f using normalised value %f scaled by K %f\n", names(flat_params)[k_index], old_value, flat_params[k_index], normalised_values[k], K))
      }
    }
    
    #Accounting for variation in drug degradation by community, with standard deviation of end concentration (at 10h) around the fitted predicted (relative) end concentration at 24h
    #prop_left_Ciprofloxacin <- abs(rnorm(1, (subset(drug_dynamics, Drug == "Ciprofloxacin")$Prop_left_24h_community), (subset(drug_dynamics, Drug == "Ciprofloxacin")$SD_drug_community))) 
    #below, we account for measurement error rather than ecological drivers that lead to the variability of degradation at the final point measured 
    prop_left_Ciprofloxacin <- abs(rnorm(
      n = 1, 
      mean = subset(drug_dynamics, Drug == "Ciprofloxacin")$Prop_left_24h_community, 
      sd = ifelse(
        subset(drug_dynamics, Drug == "Ciprofloxacin")$SD_drug_community > subset(drug_dynamics, Drug == "Ciprofloxacin")$SD_drug_community_start, 
        subset(drug_dynamics, Drug == "Ciprofloxacin")$SD_drug_community - subset(drug_dynamics, Drug == "Ciprofloxacin")$SD_drug_community_start, 
        subset(drug_dynamics, Drug == "Ciprofloxacin")$SD_drug_community
      )
    ))
    
    
    #loop through each species in co_culture_correction
    for (j in 1:nrow(co_culture_correction)) {
      # Extract the species name and correction factor
      species_name <- co_culture_correction$species[j]
      correction_factor <- co_culture_correction$correction_factor[j]
      
      # Identify the corresponding growth rate parameter in flat_params
      #by matching the base species name (without .r)
      growth_rate_indices <- grep(paste0("^", species_name, "\\.r$"), names(flat_params))
      
      #take the growth rate parameter and apply the correction factor 
      for (index in growth_rate_indices) {
        flat_params[index] <- flat_params[index] * correction_factor
      }
    }
    
    flat_params
    # Store parameters for each simulation
    input_params_list[[i]] <- c(sim_ID = i, flat_params)
    
    # Run the model for the first 24-hour cycle
    solution_cycle_1 <- ode(y = initial_conditions, times = seq(from = 0, to = 24, by = 0.1), func = closed.sir.model_Ciprofloxacin, parms = flat_params,   method = "lsoda", rtol = 1e-6, atol = 1e-6)
    
    # Dilution and second cycle
    end_of_cycle_1 <- solution_cycle_1[nrow(solution_cycle_1), -1]
    initial_conditions_cycle_2 <- end_of_cycle_1 / 50
    #accounting for the drugs being added with the new growth cycle as well:
    initial_conditions_cycle_2[33] <- initial_conditions_cycle_2[33] + drug_concentration_tested
    solution_cycle_2 <- ode(y = initial_conditions_cycle_2, times = seq(from = 24, to = 48, by = 0.1), func = closed.sir.model_Ciprofloxacin, parms = flat_params,  method = "lsoda", rtol = 1e-6, atol = 1e-6)
    
    # Combine and format results
    combined_solution <- rbind(as.data.frame(solution_cycle_1), as.data.frame(solution_cycle_2)[-1,])
    combined_solution$sim_ID <- rep(i, nrow(combined_solution))
    combined_solution <- combined_solution %>%
      tidyr::gather(key = "Species", value = "Density", -time, -sim_ID) %>%
      dplyr::mutate(Hour = time) %>%
      dplyr::select(sim_ID, Hour, Species, Density)
    
    ##Append to sim_output
    sim_output <- rbind(sim_output, combined_solution)
  }, error = function(e) {
    cat(sprintf("Skipping simulation %d due to an error: %s\n", i, e$message))
  })
}



##Combine all parameter data into a single dataframe
input_params <- do.call(rbind, input_params_list)

# Add a "Species" column 
sim_output$Species_name <- species_names[as.numeric(as.character(sim_output$Species))]
sim_output$Species_name <- replace_na(sim_output$Species_name, "Drug")

#View(input_params)
#View(sim_output)

sim_output <- na.omit(sim_output)
successful_sim_ids <- unique(subset(sim_output, Hour == 48)$sim_ID)
length(successful_sim_ids)
sim_output1 <- sim_output[sim_output$sim_ID %in% successful_sim_ids, ]


#Transform sim_output so we have wide format by Species
sim_output_wide <- tidyr::pivot_wider(sim_output1, 
                                      names_from = Species_name, 
                                      values_from = Density,
                                      id_cols = c(sim_ID, Hour))

length(unique(sim_output_wide$sim_ID))
#calc community OD per timepoint
sim_output_wide$Total_OD <- rowSums(sim_output_wide[, 3:34], na.rm = TRUE)
#calculate and add relative abundances here as well:
species_columns <- colnames(sim_output_wide)[3:34] 

for (species in species_columns) {
  sim_output_wide[[paste0("rel_", species)]] <- sim_output_wide[[species]] / sim_output_wide$Total_OD
}


#assign sim_output_wide test conditions to dataframe name
drug_tested <- "Ciprofloxacin"
variable_name_1 <- paste0("sim_output_wide_", ifelse(drug_concentration_tested == 1e-04, 0, drug_concentration_tested), "_", drug_tested)
assign(variable_name_1, sim_output_wide)

#turn back into long format if interested in plotting relative abundances
cols_needed <- c("sim_ID", "Hour")

sim_output_long <- sim_output_wide %>% 
  dplyr::select(sim_ID, Hour, Drug, starts_with("rel_")) %>% 
  tidyr::pivot_longer(
    cols = c(Drug, starts_with("rel_")),
    names_to = "Species", 
    values_to = "Relative_abundance",
    names_prefix = "rel_",
    names_transform = list(Species = ~ ifelse(.x == "Drug", "Drug", .x))
  ) 

str(sim_output_long)


species_names_1 <- c(
  "A_muciniphila",
  "B_adolescentis",
  "B_fragilis",
  "B_longum",
  "B_obeum",
  "B_thetaiotaomicron",
  "B_uniformis",
  "B_vulgatus",
  "B_wadsworthia",
  "C_aerofaciens",
  "C_bolteae",
  "C_comes",
  "C_perfringens",
  "C_ramosum",
  "C_saccharolyticum",
  "D_formicigenerans",
  "E_coli",
  "E_lenta",
  "E_rectale",
  "F_nucleatum",
  "L_paracasei",
  "O_splanchnicus",
  "P_copri",
  "P_distasonis",
  "P_merdae",
  "R_bromii",
  "R_gnavus",
  "R_intestinalis",
  "R_torques",
  "S_parasanguinis",
  "S_salivarius",
  "V_parvula",
  "Drug"
)

species_colours_1 <- c(
  "A_muciniphila" = "#1f77b4",
  "B_adolescentis" = "#ff7f0e",
  "B_fragilis" = "#2ca02c",
  "B_longum" = "#d62728",
  "B_obeum" = "#9467bd",
  "B_thetaiotaomicron" = "black",
  "B_uniformis" = "#e377c2",
  "B_vulgatus" = "#7f7f7f",
  "B_wadsworthia" = "gold1",
  "C_aerofaciens" = "#aec7e8",
  "C_bolteae" = "#ffbb78",
  "C_comes" = "magenta",
  "C_perfringens" = "#ff9896",
  "C_ramosum" = "#c5b0d5",
  "C_saccharolyticum" = "#c49c94",
  "D_formicigenerans" = "#f7b6d2",
  "E_coli" = "yellow",
  "E_lenta" = "turquoise",
  "E_rectale" = "#393b79",
  "F_nucleatum" = "royalblue2",
  "L_paracasei" = "blue",
  "O_splanchnicus" = "#637939",
  "P_copri" = "cyan",
  "P_distasonis" = "#8c6d31",
  "P_merdae" = "#c7c7c7",
  "R_bromii" = "#e6550d",
  "R_gnavus" = "#e7cb94",
  "R_intestinalis" = "#843c39",
  "R_torques" = "#d6616b",
  "S_parasanguinis" = "orange3",
  "S_salivarius" = "#7b4173",
  "V_parvula" = "#ce6dbd",
  "Drug" = "green"
)



##Plot output for any specific sim:
# ggplot(subset(sim_output, sim_ID == 1 & Species_name != "Drug"), aes(x = Hour, y = Density, group = Species_name, color = Species_name)) +
#   geom_line(size = 1, alpha = 0.7) +
#   scale_color_manual(values = species_colours_1) +
#   labs(title = paste0("Ciprofloxacin = ", drug_concentration_tested),
#        x = "Time (hours)",
#        y = "Population Density (OD)",
#        color = "Species") +
#   theme_minimal() +
#   theme(legend.position = "right")
# 
# ggplot(subset(sim_output, sim_ID == 3 & Species_name != "Drug"), aes(x = Hour, y = Density, group = Species_name, color = Species_name)) +
#   geom_line(size = 1, alpha = 0.7) +
#   scale_color_manual(values = species_colours_1) +
#   labs(title = paste0("Ciprofloxacin = ", drug_concentration_tested),
#        x = "Time (hours)",
#        y = "Population Density (OD)",
#        color = "Species") +
#   theme_minimal() +
#   theme(legend.position = "right")


ggplot(subset(sim_output_long, sim_ID == 1), aes(x = Hour, y = Relative_abundance, group = Species, color = Species)) +
  geom_line(size = 1, alpha = 0.7) +
  scale_color_manual(values = species_colours_1) +
  labs(title = paste0("Ciprofloxacin = ", drug_concentration_tested),
       x = "Time (hours)",
       y = "Relative abundance",
       color = "Species") +
  theme_minimal() +
  theme(legend.position = "right")


ggplot(subset(sim_output_long, sim_ID == 3), aes(x = Hour, y = Relative_abundance, group = Species, color = Species)) +
  geom_line(size = 1, alpha = 0.7) +
  scale_color_manual(values = species_colours_1) +
  labs(title = paste0("Ciprofloxacin = ", drug_concentration_tested),
       x = "Time (hours)",
       y = "Relative abundance",
       color = "Species") +
  theme_minimal() +
  theme(legend.position = "right")


#calc mean and standard deviation across sims
sim_stats <- sim_output_long %>%
  dplyr::group_by(Hour, Species) %>%
  dplyr::summarise(
    mean_rel_ab = mean(Relative_abundance),
    sd_rel_ab = sd(Relative_abundance),
    .groups = 'drop'
  )

# Prepare the data for plotting
plot_data <- sim_stats %>%
  dplyr::mutate(Upper = mean_rel_ab + sd_rel_ab, Lower = mean_rel_ab - sd_rel_ab)

ggplot(subset(plot_data, Species != "Drug"), aes(x = Hour, y = mean_rel_ab, group = Species, color = Species)) +
  geom_ribbon(aes(ymin = Lower, ymax = Upper, fill = Species), colour = NA, alpha = 0.2) +  
  geom_line(size = 1, alpha = 0.7) + 
  scale_color_manual(values = species_colours_1) +
  scale_fill_manual(values = species_colours_1) +  
  labs(title = "Mean and SD of Relative Abundance Across Simulations",
       subtitle = paste0("Ciprofloxacin = ", drug_concentration_tested),       
       x = "Time (hours)",
       y = "Relative abundance",
       color = "Species",
       fill = "Species") +
  theme_minimal() +
  theme(legend.position = "right")

#log-scaled mean trends
ggplot(plot_data, aes(x = Hour, y = log10(mean_rel_ab + 0.0001), group = Species, color = Species)) +
  geom_line(size = 1, alpha = 0.7) +  # Mean line
  scale_color_manual(values = species_colours_1) +
  scale_fill_manual(values = species_colours_1) +  # Ensure consistent colors for lines and fills
  labs(title = "Mean and SD of Relative Abundance Across Simulations",
       subtitle = paste0("Ciprofloxacin = ", drug_concentration_tested),
       x = "Time (hours)",
       y = "Relative abundance",
       color = "Species",
       fill = "Species") +
  theme_minimal() +
  theme(legend.position = "right")




##prediction quality evaluation
drug_tested <- "Ciprofloxacin"
variable_name <- paste0("plot_data_", ifelse(drug_concentration_tested == 1e-04, 0, drug_concentration_tested), "_", drug_tested)
assign(variable_name, plot_data)


#extract total OD info:
predicted_mean_final_od_NULL <- Niclosamide_16S_0uM_summarised$mean_com_final_OD[1]
predicted_sd_final_od_NULL <- Niclosamide_16S_0uM_summarised$sd_com_final_OD[1]


predicted_mean_final_od_20_Ciprofloxacin <- mean(subset(sim_output_wide_20_Ciprofloxacin, Hour == 48)$Total_OD, na.rm = TRUE)
predicted_sd_final_od_20_Ciprofloxacin <- sd(subset(sim_output_wide_20_Ciprofloxacin, Hour == 48)$Total_OD, na.rm = TRUE)

real_mean_final_od_20_Ciprofloxacin <- Community_compositions_focus_drugs_Ciprofloxacin_20uM_summarised$mean_final_OD[1]
real_sd_final_od_20_Ciprofloxacin <- Community_compositions_focus_drugs_Ciprofloxacin_20uM_summarised$sd_final_OD[1]


predicted_mean_final_od_80_Ciprofloxacin <- mean(subset(sim_output_wide_80_Ciprofloxacin, Hour == 48)$Total_OD, na.rm = TRUE)
predicted_sd_final_od_80_Ciprofloxacin <- sd(subset(sim_output_wide_80_Ciprofloxacin, Hour == 48)$Total_OD, na.rm = TRUE)

real_mean_final_od_80_Ciprofloxacin <- Community_compositions_focus_drugs_Ciprofloxacin_80uM_summarised$mean_final_OD[1]
real_sd_final_od_80_Ciprofloxacin <- Community_compositions_focus_drugs_Ciprofloxacin_80uM_summarised$sd_final_OD[1]




#plot_data_0_Ciprofloxacin_endpoint was used to test model performance at 0 drugs
#plot_data_0_Ciprofloxacin_endpoint <- subset(plot_data_0_Ciprofloxacin, Hour == 48 & Species != "Drug")
plot_data_20_Ciprofloxacin_endpoint <- subset(plot_data_20_Ciprofloxacin, Hour == 48 & Species != "Drug")
plot_data_80_Ciprofloxacin_endpoint <- subset(plot_data_80_Ciprofloxacin, Hour == 48 & Species != "Drug")

##Inspecting 'match' to real relative abundance distributions:
Niclosamide_16S_0uM_summarised <- rel_ab_control
Niclosamide_16S_0uM_summarised$Species <- gsub("\\.", "", Niclosamide_16S_0uM_summarised$Species)

Ciprofloxacin_16S_20uM_summarised <- Community_compositions_focus_drugs_Ciprofloxacin_20uM_summarised
Ciprofloxacin_16S_80uM_summarised <- Community_compositions_focus_drugs_Ciprofloxacin_80uM_summarised

Niclosamide_16S_0uM_summarised
Ciprofloxacin_16S_20uM_summarised 
Ciprofloxacin_16S_80uM_summarised 

#Rename 'species' so the outputs become comparable
original_names_80 <- unique(Ciprofloxacin_16S_80uM_summarised$species)
original_names_20 <- unique(Ciprofloxacin_16S_20uM_summarised$species)



##Create a named vector with the original and new names mapping
name_changes <- c(
  "Akkermansia muciniphila" = "A_muciniphila",
  "Bacteroides fragilis" = "B_fragilis",
  "Bacteroides thetaiotaomicron" = "B_thetaiotaomicron",
  "Bacteroides uniformis" = "B_uniformis",
  "Bifidobacterium adolescentis" = "B_adolescentis",
  "Bifidobacterium longum subsp. longum" = "B_longum",
  "Bilophila wadsworthia" = "B_wadsworthia",
  "Blautia obeum" = "B_obeum",
  "Clostridium perfringens" = "C_perfringens",
  "Collinsella aerofaciens" = "C_aerofaciens",
  "Coprococcus comes" = "C_comes",
  "Dorea formicigenerans" = "D_formicigenerans",
  "Eggerthella lenta" = "E_lenta",
  "Enterocloster bolteae" = "C_bolteae",
  "Erysipelatoclostridium ramosum" = "C_ramosum",
  "Escherichia coli ED1a" = "E_coli",
  "Eubacterium rectale" = "E_rectale",
  "Fusobacterium nucleatum subsp. nucleatum" = "F_nucleatum",
  "Lacrimispora saccharolytica" = "C_saccharolyticum",
  "Lacticaseibacillus paracasei" = "L_paracasei",
  "Odoribacter splanchnicus" = "O_splanchnicus",
  "Parabacteroides distasonis" = "P_distasonis",
  "Parabacteroides merdae" = "P_merdae",
  "Phocaeicola vulgatus" = "B_vulgatus",
  "Prevotella copri" = "P_copri",
  "Roseburia intestinalis" = "R_intestinalis",
  "Ruminococcus bromii" = "R_bromii",
  "Ruminococcus gnavus" = "R_gnavus",
  "Ruminococcus torques" = "R_torques",
  "Streptococcus parasanguinis" = "S_parasanguinis",
  "Streptococcus salivarius" = "S_salivarius",
  "Veillonella parvula" = "V_parvula"
)

# Apply name changes to the species column in Ciprofloxacin_16S_80uM_summarised

Ciprofloxacin_16S_80uM_summarised$Species <- name_changes[Ciprofloxacin_16S_80uM_summarised$species]
Ciprofloxacin_16S_20uM_summarised$Species <- name_changes[Ciprofloxacin_16S_20uM_summarised$species]

# Verify the changes
unique(Ciprofloxacin_16S_80uM_summarised$Species)
unique(Ciprofloxacin_16S_20uM_summarised$Species)


##First, for 20 uM:
# Get top 6 species from plot_data_20_endpoint
# Adjust the plot_data_20_endpoint with confidence bounds
plot_data_20_Ciprofloxacin_endpoint <- plot_data_20_Ciprofloxacin_endpoint %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)

# Adjust the Ciprofloxacin_16S_20uM_summarised with confidence bounds
Ciprofloxacin_16S_20uM_summarised <- Ciprofloxacin_16S_20uM_summarised %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)

#NULL model:
Null_model_summarised <- Niclosamide_16S_0uM_summarised %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)


# Get top 6 species based on the lower bound from plot_data_20_endpoint
top6_predicted_20_Ciprofloxacin <- plot_data_20_Ciprofloxacin_endpoint %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

# Get top 6 species based on the lower bound from Ciprofloxacin_16S_20uM_summarised
top6_real_20_Ciprofloxacin <- Ciprofloxacin_16S_20uM_summarised %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

top6_NULL <- Null_model_summarised %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

# Calculate the overlap of top 6 species
top_six_correct_20_Ciprofloxacin <- length(intersect(top6_predicted_20_Ciprofloxacin, top6_real_20_Ciprofloxacin))
#top_six_correct_20_Ciprofloxacin

top_six_correct_20_Ciprofloxacin_NULL <- length(intersect(top6_NULL, top6_real_20_Ciprofloxacin))
#top_six_correct_20_Ciprofloxacin_NULL

#top6_predicted_20_Ciprofloxacin
#top6_real_20_Ciprofloxacin



#Now by means:
top6_predicted_20_Ciprofloxacin_means <- plot_data_20_Ciprofloxacin_endpoint %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)

# Get top 6 species based on the lower bound from Ciprofloxacin_16S_20uM_summarised
top6_real_20_Ciprofloxacin_means <- Ciprofloxacin_16S_20uM_summarised %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)

top6_NULL_means <- Null_model_summarised %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)



top_six_correct_20_Ciprofloxacin_means <- length(intersect(top6_predicted_20_Ciprofloxacin_means, top6_real_20_Ciprofloxacin_means))
#top_six_correct_20_Ciprofloxacin_means

top_six_correct_20_Ciprofloxacin_means_NULL <- length(intersect(top6_NULL_means, top6_real_20_Ciprofloxacin_means))
#top_six_correct_20_Ciprofloxacin_means_NULL

top6_predicted_20_Ciprofloxacin_means
#top6_real_20_Ciprofloxacin_means



# Merge dataframes by Species
merged_data_20_Ciprofloxacin <- merge(plot_data_20_Ciprofloxacin_endpoint, Ciprofloxacin_16S_20uM_summarised, by = "Species", suffixes = c(".pred", ".real"))
merged_data_20_Ciprofloxacin_NULL <- merge(Niclosamide_16S_0uM_summarised, Ciprofloxacin_16S_20uM_summarised, by = "Species", suffixes = c(".null", ".real"))


# Create lower and upper bounds considering mean ¬± sd
merged_data_20_Ciprofloxacin$lower_bound_pred <- merged_data_20_Ciprofloxacin$mean_rel_ab.pred - merged_data_20_Ciprofloxacin$sd_rel_ab.pred
merged_data_20_Ciprofloxacin$upper_bound_pred <- merged_data_20_Ciprofloxacin$mean_rel_ab.pred + merged_data_20_Ciprofloxacin$sd_rel_ab.pred
merged_data_20_Ciprofloxacin$lower_bound_real <- merged_data_20_Ciprofloxacin$mean_rel_ab.real - merged_data_20_Ciprofloxacin$sd_rel_ab.real
merged_data_20_Ciprofloxacin$upper_bound_real <- merged_data_20_Ciprofloxacin$mean_rel_ab.real + merged_data_20_Ciprofloxacin$sd_rel_ab.real

# Ensure lower and upper bounds are non-negative, adjusting as necessary
merged_data_20_Ciprofloxacin$lower_bound_pred[merged_data_20_Ciprofloxacin$lower_bound_pred <= 0] <- 1e-10
merged_data_20_Ciprofloxacin$lower_bound_real[merged_data_20_Ciprofloxacin$lower_bound_real <= 0] <- 1e-10
merged_data_20_Ciprofloxacin$upper_bound_pred[merged_data_20_Ciprofloxacin$upper_bound_pred <= 0] <- 1e-10
merged_data_20_Ciprofloxacin$upper_bound_real[merged_data_20_Ciprofloxacin$upper_bound_real <= 0] <- 1e-10

##and for NULL model:
# Create lower and upper bounds considering mean ¬± sd
merged_data_20_Ciprofloxacin_NULL$lower_bound_null <- merged_data_20_Ciprofloxacin_NULL$mean_rel_ab.null - merged_data_20_Ciprofloxacin_NULL$sd_rel_ab.null
merged_data_20_Ciprofloxacin_NULL$upper_bound_null <- merged_data_20_Ciprofloxacin_NULL$mean_rel_ab.null + merged_data_20_Ciprofloxacin_NULL$sd_rel_ab.null
merged_data_20_Ciprofloxacin_NULL$lower_bound_real <- merged_data_20_Ciprofloxacin_NULL$mean_rel_ab.real - merged_data_20_Ciprofloxacin_NULL$sd_rel_ab.real
merged_data_20_Ciprofloxacin_NULL$upper_bound_real <- merged_data_20_Ciprofloxacin_NULL$mean_rel_ab.real + merged_data_20_Ciprofloxacin_NULL$sd_rel_ab.real

# Ensure lower and upper bounds are non-negative, adjusting as necessary
merged_data_20_Ciprofloxacin_NULL$lower_bound_null[merged_data_20_Ciprofloxacin_NULL$lower_bound_null <= 0] <- 1e-10
merged_data_20_Ciprofloxacin_NULL$lower_bound_real[merged_data_20_Ciprofloxacin_NULL$lower_bound_real <= 0] <- 1e-10
merged_data_20_Ciprofloxacin_NULL$upper_bound_null[merged_data_20_Ciprofloxacin_NULL$upper_bound_null <= 0] <- 1e-10
merged_data_20_Ciprofloxacin_NULL$upper_bound_real[merged_data_20_Ciprofloxacin_NULL$upper_bound_real <= 0] <- 1e-10

# Filter to include only species with a mean relative abundance > 0.01 in the 'real' dataset
significant_species <- merged_data_20_Ciprofloxacin[merged_data_20_Ciprofloxacin$mean_rel_ab.real > 0.01, ]
survivors_20_Ciprofloxacin <- nrow(significant_species)
survivors_20_Ciprofloxacin

#should be the same as survivors defined above, since it is calculated from .real
significant_species_NULL <- merged_data_20_Ciprofloxacin_NULL[merged_data_20_Ciprofloxacin_NULL$mean_rel_ab.real > 0.01, ]
survivors_20_Ciprofloxacin_NULL <- nrow(significant_species_NULL)
survivors_20_Ciprofloxacin_NULL

# Adjusted order of magnitude check to include SD, only for significant species
significant_species$Predicted_magnitude_correct <- ifelse(
  (floor(log10(significant_species$lower_bound_pred)) <= floor(log10(significant_species$upper_bound_real)) &
     floor(log10(significant_species$upper_bound_pred)) >= floor(log10(significant_species$lower_bound_real))),
  1,
  0
)

#and for the Null model:
significant_species_NULL$Predicted_magnitude_correct <- ifelse(
  (floor(log10(significant_species_NULL$lower_bound_null)) <= floor(log10(significant_species_NULL$upper_bound_real)) &
     floor(log10(significant_species_NULL$upper_bound_null)) >= floor(log10(significant_species_NULL$lower_bound_real))),
  1,
  0
)

# Calculate the fraction of correctly predicted magnitudes for significant species
predicted_magnitude_correct_fraction_20_Ciprofloxacin <- sum(significant_species$Predicted_magnitude_correct) / nrow(significant_species)
predicted_magnitude_correct_fraction_20_Ciprofloxacin

predicted_magnitude_correct_fraction_20_Ciprofloxacin_NULL <- sum(significant_species_NULL$Predicted_magnitude_correct) / nrow(significant_species_NULL)
predicted_magnitude_correct_fraction_20_Ciprofloxacin_NULL

top_species_missing_20_Ciprofloxacin <- setdiff(top6_real_20_Ciprofloxacin_means, top6_predicted_20_Ciprofloxacin_means)
top_species_wrong_20_Ciprofloxacin <- setdiff(top6_predicted_20_Ciprofloxacin_means, top6_real_20_Ciprofloxacin_means)

Prediction_quality_20_Ciprofloxacin <- data.frame(
  Top_six_correct = paste(top_six_correct_20_Ciprofloxacin, sep=""),
  Top_six_correct_NULL = paste(top_six_correct_20_Ciprofloxacin_NULL, sep=""),
  Top_six_correct_means = paste(top_six_correct_20_Ciprofloxacin_means, sep=""),
  Top_six_correct_means_NULL = paste(top_six_correct_20_Ciprofloxacin_means_NULL, sep=""),
  Predicted_magnitude_correct = paste(round(predicted_magnitude_correct_fraction_20_Ciprofloxacin * 100, 2), "%", sep=""),
  Predicted_magnitude_correct_NULL = paste(round(predicted_magnitude_correct_fraction_20_Ciprofloxacin_NULL * 100, 2), "%", sep=""),
  survivors_total = survivors_20_Ciprofloxacin,
  top_species_missing <- top_species_missing_20_Ciprofloxacin,
  top_species_wrong <- top_species_wrong_20_Ciprofloxacin, 
  predicted_mean_final_OD <- predicted_mean_final_od_20_Ciprofloxacin,
  real_mean_final_OD <- real_mean_final_od_20_Ciprofloxacin,
  sims_total = length(successful_sim_ids)
)

Prediction_quality_20_Ciprofloxacin






##Next, for 80 uM:
# Get top 6 species from plot_data_80_endpoint
# Adjust the plot_data_80_endpoint with confidence bounds
plot_data_80_Ciprofloxacin_endpoint <- plot_data_80_Ciprofloxacin_endpoint %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)

# Adjust the Ciprofloxacin_16S_80uM_summarised with confidence bounds
Ciprofloxacin_16S_80uM_summarised <- Ciprofloxacin_16S_80uM_summarised %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)

#NULL model:
Null_model_summarised <- Niclosamide_16S_0uM_summarised %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)


# Get top 6 species based on the lower bound from plot_data_80_endpoint
top6_predicted_80_Ciprofloxacin <- plot_data_80_Ciprofloxacin_endpoint %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

# Get top 6 species based on the lower bound from Ciprofloxacin_16S_80uM_summarised
top6_real_80_Ciprofloxacin <- Ciprofloxacin_16S_80uM_summarised %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

top6_NULL <- Null_model_summarised %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

# Calculate the overlap of top 6 species
top_six_correct_80_Ciprofloxacin <- length(intersect(top6_predicted_80_Ciprofloxacin, top6_real_80_Ciprofloxacin))
#top_six_correct_80_Ciprofloxacin

top_six_correct_80_Ciprofloxacin_NULL <- length(intersect(top6_NULL, top6_real_80_Ciprofloxacin))
#top_six_correct_80_Ciprofloxacin_NULL

#top6_predicted_80_Ciprofloxacin
#top6_real_80_Ciprofloxacin




#Now by means:
top6_predicted_80_Ciprofloxacin_means <- plot_data_80_Ciprofloxacin_endpoint %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)

# Get top 6 species based on the lower bound from Ciprofloxacin_16S_80uM_summarised
top6_real_80_Ciprofloxacin_means <- Ciprofloxacin_16S_80uM_summarised %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)

top6_NULL_means <- Null_model_summarised %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)



top_six_correct_80_Ciprofloxacin_means <- length(intersect(top6_predicted_80_Ciprofloxacin_means, top6_real_80_Ciprofloxacin_means))
#top_six_correct_80_Ciprofloxacin_means

top_six_correct_80_Ciprofloxacin_means_NULL <- length(intersect(top6_NULL_means, top6_real_80_Ciprofloxacin_means))
#top_six_correct_80_Ciprofloxacin_means_NULL

#top6_predicted_80_Ciprofloxacin_means
#top6_real_80_Ciprofloxacin_means




# Merge dataframes by Species
merged_data_80_Ciprofloxacin <- merge(plot_data_80_Ciprofloxacin_endpoint, Ciprofloxacin_16S_80uM_summarised, by = "Species", suffixes = c(".pred", ".real"))
merged_data_80_Ciprofloxacin_NULL <- merge(Niclosamide_16S_0uM_summarised, Ciprofloxacin_16S_80uM_summarised, by = "Species", suffixes = c(".null", ".real"))



# Create lower and upper bounds considering mean ¬± sd
merged_data_80_Ciprofloxacin$lower_bound_pred <- merged_data_80_Ciprofloxacin$mean_rel_ab.pred - merged_data_80_Ciprofloxacin$sd_rel_ab.pred
merged_data_80_Ciprofloxacin$upper_bound_pred <- merged_data_80_Ciprofloxacin$mean_rel_ab.pred + merged_data_80_Ciprofloxacin$sd_rel_ab.pred
merged_data_80_Ciprofloxacin$lower_bound_real <- merged_data_80_Ciprofloxacin$mean_rel_ab.real - merged_data_80_Ciprofloxacin$sd_rel_ab.real
merged_data_80_Ciprofloxacin$upper_bound_real <- merged_data_80_Ciprofloxacin$mean_rel_ab.real + merged_data_80_Ciprofloxacin$sd_rel_ab.real

# Ensure lower and upper bounds are non-negative, adjusting as necessary
merged_data_80_Ciprofloxacin$lower_bound_pred[merged_data_80_Ciprofloxacin$lower_bound_pred <= 0] <- 1e-10
merged_data_80_Ciprofloxacin$lower_bound_real[merged_data_80_Ciprofloxacin$lower_bound_real <= 0] <- 1e-10
merged_data_80_Ciprofloxacin$upper_bound_pred[merged_data_80_Ciprofloxacin$upper_bound_pred <= 0] <- 1e-10
merged_data_80_Ciprofloxacin$upper_bound_real[merged_data_80_Ciprofloxacin$upper_bound_real <= 0] <- 1e-10

##and for NULL model:
# Create lower and upper bounds considering mean ¬± sd
merged_data_80_Ciprofloxacin_NULL$lower_bound_null <- merged_data_80_Ciprofloxacin_NULL$mean_rel_ab.null - merged_data_80_Ciprofloxacin_NULL$sd_rel_ab.null
merged_data_80_Ciprofloxacin_NULL$upper_bound_null <- merged_data_80_Ciprofloxacin_NULL$mean_rel_ab.null + merged_data_80_Ciprofloxacin_NULL$sd_rel_ab.null
merged_data_80_Ciprofloxacin_NULL$lower_bound_real <- merged_data_80_Ciprofloxacin_NULL$mean_rel_ab.real - merged_data_80_Ciprofloxacin_NULL$sd_rel_ab.real
merged_data_80_Ciprofloxacin_NULL$upper_bound_real <- merged_data_80_Ciprofloxacin_NULL$mean_rel_ab.real + merged_data_80_Ciprofloxacin_NULL$sd_rel_ab.real

# Ensure lower and upper bounds are non-negative, adjusting as necessary
merged_data_80_Ciprofloxacin_NULL$lower_bound_null[merged_data_80_Ciprofloxacin_NULL$lower_bound_null <= 0] <- 1e-10
merged_data_80_Ciprofloxacin_NULL$lower_bound_real[merged_data_80_Ciprofloxacin_NULL$lower_bound_real <= 0] <- 1e-10
merged_data_80_Ciprofloxacin_NULL$upper_bound_null[merged_data_80_Ciprofloxacin_NULL$upper_bound_null <= 0] <- 1e-10
merged_data_80_Ciprofloxacin_NULL$upper_bound_real[merged_data_80_Ciprofloxacin_NULL$upper_bound_real <= 0] <- 1e-10

# Filter to include only species with a mean relative abundance > 0.01 in the 'real' dataset
significant_species <- merged_data_80_Ciprofloxacin[merged_data_80_Ciprofloxacin$mean_rel_ab.real > 0.01, ]
survivors_80_Ciprofloxacin <- nrow(significant_species)
survivors_80_Ciprofloxacin

#should be the same as survivors defined above, since it is calculated from .real
significant_species_NULL <- merged_data_80_Ciprofloxacin_NULL[merged_data_80_Ciprofloxacin_NULL$mean_rel_ab.real > 0.01, ]
survivors_80_Ciprofloxacin_NULL <- nrow(significant_species_NULL)
survivors_80_Ciprofloxacin_NULL

# Adjusted order of magnitude check to include SD, only for significant species
significant_species$Predicted_magnitude_correct <- ifelse(
  (floor(log10(significant_species$lower_bound_pred)) <= floor(log10(significant_species$upper_bound_real)) &
     floor(log10(significant_species$upper_bound_pred)) >= floor(log10(significant_species$lower_bound_real))),
  1,
  0
)

#and for the Null model:
significant_species_NULL$Predicted_magnitude_correct <- ifelse(
  (floor(log10(significant_species_NULL$lower_bound_null)) <= floor(log10(significant_species_NULL$upper_bound_real)) &
     floor(log10(significant_species_NULL$upper_bound_null)) >= floor(log10(significant_species_NULL$lower_bound_real))),
  1,
  0
)

# Calculate the fraction of correctly predicted magnitudes for significant species
predicted_magnitude_correct_fraction_80_Ciprofloxacin <- sum(significant_species$Predicted_magnitude_correct) / nrow(significant_species)
predicted_magnitude_correct_fraction_80_Ciprofloxacin

predicted_magnitude_correct_fraction_80_Ciprofloxacin_NULL <- sum(significant_species_NULL$Predicted_magnitude_correct) / nrow(significant_species_NULL)
predicted_magnitude_correct_fraction_80_Ciprofloxacin_NULL


top_species_missing_80_Ciprofloxacin <- setdiff(top6_real_80_Ciprofloxacin_means, top6_predicted_80_Ciprofloxacin_means)
top_species_wrong_80_Ciprofloxacin <- setdiff(top6_predicted_80_Ciprofloxacin_means, top6_real_80_Ciprofloxacin_means)

Prediction_quality_80_Ciprofloxacin <- data.frame(
  Top_six_correct = paste(top_six_correct_80_Ciprofloxacin, sep=""),
  Top_six_correct_NULL = paste(top_six_correct_80_Ciprofloxacin_NULL, sep=""),
  Top_six_correct_means = paste(top_six_correct_80_Ciprofloxacin_means, sep=""),
  Top_six_correct_means_NULL = paste(top_six_correct_80_Ciprofloxacin_means_NULL, sep=""),
  Predicted_magnitude_correct = paste(round(predicted_magnitude_correct_fraction_80_Ciprofloxacin * 100, 2), "%", sep=""),
  Predicted_magnitude_correct_NULL = paste(round(predicted_magnitude_correct_fraction_80_Ciprofloxacin_NULL * 100, 2), "%", sep=""),
  survivors_total = survivors_80_Ciprofloxacin,
  top_species_missing <- top_species_missing_80_Ciprofloxacin,
  top_species_wrong <- top_species_wrong_80_Ciprofloxacin, 
  predicted_mean_final_OD <- predicted_mean_final_od_80_Ciprofloxacin,
  real_mean_final_OD <- real_mean_final_od_80_Ciprofloxacin,
  sims_total = length(successful_sim_ids)
)

Prediction_quality_80_Ciprofloxacin











##Clomiphene

combined_monoculture_aucs2_Clomiphene <- subset(combined_monoculture_aucs2, drug == "Clomiphene")


#drug sensitivity terms: define once outside of ODEs
y_function_B_vulgatus_Clomiphene <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("B_vulgatus", "Clomiphene", best_fitting_models_df_Clomiphene)), collapse = " ")))
y_function_B_uniformis_Clomiphene <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("B_uniformis", "Clomiphene", best_fitting_models_df_Clomiphene)), collapse = " ")))
y_function_B_fragilis_Clomiphene <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("B_fragilis", "Clomiphene", best_fitting_models_df_Clomiphene)), collapse = " ")))
y_function_B_thetaiotaomicron_Clomiphene <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("B_thetaiotaomicron", "Clomiphene", best_fitting_models_df_Clomiphene)), collapse = " ")))
y_function_C_ramosum_Clomiphene <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("C_ramosum", "Clomiphene", best_fitting_models_df_Clomiphene)), collapse = " ")))
y_function_E_rectale_Clomiphene <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("E_rectale", "Clomiphene", best_fitting_models_df_Clomiphene)), collapse = " ")))
y_function_R_intestinalis_Clomiphene <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("R_intestinalis", "Clomiphene", best_fitting_models_df_Clomiphene)), collapse = " ")))
y_function_V_parvula_Clomiphene <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("V_parvula", "Clomiphene", best_fitting_models_df_Clomiphene)), collapse = " ")))
y_function_E_lenta_Clomiphene <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("E_lenta", "Clomiphene", best_fitting_models_df_Clomiphene)), collapse = " ")))
y_function_F_nucleatum_Clomiphene <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("F_nucleatum", "Clomiphene", best_fitting_models_df_Clomiphene)), collapse = " ")))
y_function_C_bolteae_Clomiphene <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("C_bolteae", "Clomiphene", best_fitting_models_df_Clomiphene)), collapse = " ")))
y_function_C_perfringens_Clomiphene <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("C_perfringens", "Clomiphene", best_fitting_models_df_Clomiphene)), collapse = " ")))
y_function_C_saccharolyticum_Clomiphene <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("C_saccharolyticum", "Clomiphene", best_fitting_models_df_Clomiphene)), collapse = " ")))
y_function_S_salivarius_Clomiphene <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("S_salivarius", "Clomiphene", best_fitting_models_df_Clomiphene)), collapse = " ")))
y_function_R_gnavus_Clomiphene <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("R_gnavus", "Clomiphene", best_fitting_models_df_Clomiphene)), collapse = " ")))
y_function_C_comes_Clomiphene <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("C_comes", "Clomiphene", best_fitting_models_df_Clomiphene)), collapse = " ")))
y_function_P_merdae_Clomiphene <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("P_merdae", "Clomiphene", best_fitting_models_df_Clomiphene)), collapse = " ")))
y_function_S_parasanguinis_Clomiphene <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("S_parasanguinis", "Clomiphene", best_fitting_models_df_Clomiphene)), collapse = " ")))
y_function_C_aerofaciens_Clomiphene <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("C_aerofaciens", "Clomiphene", best_fitting_models_df_Clomiphene)), collapse = " ")))
y_function_D_formicigenerans_Clomiphene <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("D_formicigenerans", "Clomiphene", best_fitting_models_df_Clomiphene)), collapse = " ")))
y_function_E_coli_Clomiphene <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("E_coli", "Clomiphene", best_fitting_models_df_Clomiphene)), collapse = " ")))



y_function_B_vulgatus_Clomiphene_func <- eval(parse(text = paste("function(Drug) {", y_function_B_vulgatus_Clomiphene, "}")))
y_function_B_uniformis_Clomiphene_func <- eval(parse(text = paste("function(Drug) {", y_function_B_uniformis_Clomiphene, "}")))
y_function_B_fragilis_Clomiphene_func <- eval(parse(text = paste("function(Drug) {", y_function_B_fragilis_Clomiphene, "}")))
y_function_B_thetaiotaomicron_Clomiphene_func <- eval(parse(text = paste("function(Drug) {", y_function_B_thetaiotaomicron_Clomiphene, "}")))
y_function_C_ramosum_Clomiphene_func <- eval(parse(text = paste("function(Drug) {", y_function_C_ramosum_Clomiphene, "}")))
y_function_E_rectale_Clomiphene_func <- eval(parse(text = paste("function(Drug) {", y_function_E_rectale_Clomiphene, "}")))
y_function_R_intestinalis_Clomiphene_func <- eval(parse(text = paste("function(Drug) {", y_function_R_intestinalis_Clomiphene, "}")))
y_function_E_lenta_Clomiphene_func <- eval(parse(text = paste("function(Drug) {", y_function_E_lenta_Clomiphene, "}")))
y_function_F_nucleatum_Clomiphene_func <- eval(parse(text = paste("function(Drug) {", y_function_F_nucleatum_Clomiphene, "}")))
y_function_C_bolteae_Clomiphene_func <- eval(parse(text = paste("function(Drug) {", y_function_C_bolteae_Clomiphene, "}")))
y_function_C_perfringens_Clomiphene_func <- eval(parse(text = paste("function(Drug) {", y_function_C_perfringens_Clomiphene, "}")))
y_function_C_saccharolyticum_Clomiphene_func <- eval(parse(text = paste("function(Drug) {", y_function_C_saccharolyticum_Clomiphene, "}")))
y_function_S_salivarius_Clomiphene_func <- eval(parse(text = paste("function(Drug) {", y_function_S_salivarius_Clomiphene, "}")))
y_function_R_gnavus_Clomiphene_func <- eval(parse(text = paste("function(Drug) {", y_function_R_gnavus_Clomiphene, "}")))
y_function_C_comes_Clomiphene_func <- eval(parse(text = paste("function(Drug) {", y_function_C_comes_Clomiphene, "}")))
y_function_P_merdae_Clomiphene_func <- eval(parse(text = paste("function(Drug) {", y_function_P_merdae_Clomiphene, "}")))
y_function_S_parasanguinis_Clomiphene_func <- eval(parse(text = paste("function(Drug) {", y_function_S_parasanguinis_Clomiphene, "}")))
y_function_C_aerofaciens_Clomiphene_func <- eval(parse(text = paste("function(Drug) {", y_function_C_aerofaciens_Clomiphene, "}")))
y_function_D_formicigenerans_Clomiphene_func <- eval(parse(text = paste("function(Drug) {", y_function_D_formicigenerans_Clomiphene, "}")))
y_function_E_coli_Clomiphene_func <- eval(parse(text = paste("function(Drug) {", y_function_E_coli_Clomiphene, "}")))
y_function_V_parvula_Clomiphene_func <- eval(parse(text = paste("function(Drug) {", y_function_V_parvula_Clomiphene, "}")))



unique(combined_monoculture_aucs2_Clomiphene$conc)
##dictate drug concentration tested for simulation cycle here:
#drug_concentration_tested <- 5 #if manually or:
drug_concentration_tested <- unique(combined_monoculture_aucs2_Clomiphene$conc)[1] 
initial_conditions <- rep(0.01/32, 32)
initial_conditions <- c(initial_conditions, drug_concentration_tested)


##drug effect fitted for species showing sensitivity in monoculture:
#unique(combined_monoculture_aucs2_Clomiphene$Species)

##for more simple linear fits
closed.sir.model_Clomiphene <- function (t, x, params) {
  ## first extract the state variables
  A_muciniphila <- x[1]
  B_adolescentis <- x[2]
  B_fragilis <- x[3]
  B_longum <- x[4]
  B_obeum <- x[5]
  B_thetaiotaomicron <- x[6]
  B_uniformis <- x[7]
  B_vulgatus <- x[8]
  B_wadsworthia <- x[9]
  C_aerofaciens <- x[10]
  C_bolteae <- x[11]
  C_comes <- x[12]
  C_perfringens <- x[13]
  C_ramosum <- x[14]
  C_saccharolyticum <- x[15]
  D_formicigenerans <- x[16]
  E_coli <- x[17]
  E_lenta <- x[18]
  E_rectale <- x[19]
  F_nucleatum <- x[20]
  L_paracasei <- x[21]
  O_splanchnicus <- x[22]
  P_copri <- x[23]
  P_distasonis <- x[24]
  P_merdae <- x[25]
  R_bromii <- x[26]
  R_gnavus <- x[27]
  R_intestinalis <- x[28]
  R_torques <- x[29]
  S_parasanguinis <- x[30]
  S_salivarius <- x[31]
  V_parvula <- x[32]
  Drug <- x[33]
  
  
  ## now extract the parameters
  r_B_fragilis <- flat_params[["B._fragilis.r"]]
  K_B_fragilis <- flat_params[["B._fragilis.K"]]
  r_B_longum <- flat_params[["B._longum.r"]]
  K_B_longum <- flat_params[["B._longum.K"]]
  r_B_thetaiotaomicron <- flat_params[["B._thetaiotaomicron.r"]]
  K_B_thetaiotaomicron <- flat_params[["B._thetaiotaomicron.K"]]
  r_B_uniformis <- flat_params[["B._uniformis.r"]]
  K_B_uniformis <- flat_params[["B._uniformis.K"]]
  r_B_vulgatus <- flat_params[["B._vulgatus.r"]]
  K_B_vulgatus <- flat_params[["B._vulgatus.K"]]
  r_B_wadsworthia <- flat_params[["B._wadsworthia.r"]]
  K_B_wadsworthia <- flat_params[["B._wadsworthia.K"]]
  r_C_aerofaciens <- flat_params[["C._aerofaciens.r"]]
  K_C_aerofaciens <- flat_params[["C._aerofaciens.K"]]
  r_C_bolteae <- flat_params[["C._bolteae.r"]]
  K_C_bolteae <- flat_params[["C._bolteae.K"]]
  r_C_comes <- flat_params[["C._comes.r"]]
  K_C_comes <- flat_params[["C._comes.K"]]
  r_C_perfringens <- flat_params[["C._perfringens.r"]]
  K_C_perfringens <- flat_params[["C._perfringens.K"]]
  r_C_ramosum <- flat_params[["C._ramosum.r"]]
  K_C_ramosum <- flat_params[["C._ramosum.K"]]
  r_C_saccharolyticum <- flat_params[["C._saccharolyticum.r"]]
  K_C_saccharolyticum <- flat_params[["C._saccharolyticum.K"]]
  r_D_formicigenerans <- flat_params[["D._formicigenerans.r"]]
  K_D_formicigenerans <- flat_params[["D._formicigenerans.K"]]
  r_E_coli <- flat_params[["E._coli.r"]]
  K_E_coli <- flat_params[["E._coli.K"]]
  r_E_lenta <- flat_params[["E._lenta.r"]]
  K_E_lenta <- flat_params[["E._lenta.K"]]
  r_E_rectale <- flat_params[["E._rectale.r"]]
  K_E_rectale <- flat_params[["E._rectale.K"]]
  r_F_nucleatum <- flat_params[["F._nucleatum.r"]]
  K_F_nucleatum <- flat_params[["F._nucleatum.K"]]
  r_P_copri <- flat_params[["P._copri.r"]]
  K_P_copri <- flat_params[["P._copri.K"]]
  r_P_merdae <- flat_params[["P._merdae.r"]]
  K_P_merdae <- flat_params[["P._merdae.K"]]
  r_R_gnavus <- flat_params[["R._gnavus.r"]]
  K_R_gnavus <- flat_params[["R._gnavus.K"]]
  r_R_intestinalis <- flat_params[["R._intestinalis.r"]]
  K_R_intestinalis <- flat_params[["R._intestinalis.K"]]
  r_V_parvula <- flat_params[["V._parvula.r"]]
  K_V_parvula <- flat_params[["V._parvula.K"]]
  r_A_muciniphila <- flat_params[["A._muciniphila.r"]]
  K_A_muciniphila <- flat_params[["A._muciniphila.K"]]
  r_B_adolescentis <- flat_params[["B._adolescentis.r"]]
  K_B_adolescentis <- flat_params[["B._adolescentis.K"]]
  r_B_obeum <- flat_params[["B._obeum.r"]]
  K_B_obeum <- flat_params[["B._obeum.K"]]
  r_O_splanchnicus <- flat_params[["O._splanchnicus.r"]]
  K_O_splanchnicus <- flat_params[["O._splanchnicus.K"]]
  r_P_distasonis <- flat_params[["P._distasonis.r"]]
  K_P_distasonis <- flat_params[["P._distasonis.K"]]
  r_R_bromii <- flat_params[["R._bromii.r"]]
  K_R_bromii <- flat_params[["R._bromii.K"]]
  r_R_torques <- flat_params[["R._torques.r"]]
  K_R_torques <- flat_params[["R._torques.K"]]
  r_S_parasanguinis <- flat_params[["S._parasanguinis.r"]]
  K_S_parasanguinis <-flat_params[["S._parasanguinis.K"]]
  r_S_salivarius <- flat_params[["S._salivarius.r"]]
  K_S_salivarius <- flat_params[["S._salivarius.K"]]
  r_L_paracasei <- flat_params[["L._paracasei.r"]]
  K_L_paracasei <- flat_params[["L._paracasei.K"]]
  
  
  t_mod <- ifelse(t > 24.1, t - 24.1, t)
  
  
  ## now code the model equations
  dA_muciniphila_dt <- r_A_muciniphila * A_muciniphila * (1 - A_muciniphila / K_A_muciniphila)
  dB_adolescentis_dt <- r_B_adolescentis * B_adolescentis * (1 - B_adolescentis / K_B_adolescentis)
  dB_fragilis_dt <- r_B_fragilis * B_fragilis * (1 - B_fragilis / max(0.0001, K_B_fragilis * (y_function_B_fragilis_Clomiphene_func(Drug))))
  dB_longum_dt <- r_B_longum * B_longum * (1 - B_longum / K_B_longum)
  dB_obeum_dt <- r_B_obeum * B_obeum * (1 - B_obeum / K_B_obeum)
  dB_thetaiotaomicron_dt <- r_B_thetaiotaomicron * B_thetaiotaomicron * (1 - B_thetaiotaomicron / max(0.0001, K_B_thetaiotaomicron * (y_function_B_thetaiotaomicron_Clomiphene_func(Drug))))  
  dB_uniformis_dt <- r_B_uniformis * B_uniformis * (1 - B_uniformis / max(0.0001, K_B_uniformis * (y_function_B_uniformis_Clomiphene_func(Drug))))
  dB_vulgatus_dt <- r_B_vulgatus * B_vulgatus * (1 - B_vulgatus / max(0.0001, K_B_vulgatus * (y_function_B_vulgatus_Clomiphene_func(Drug))))
  dB_wadsworthia_dt <- r_B_wadsworthia * B_wadsworthia * (1 - B_wadsworthia / K_B_wadsworthia)
  dC_aerofaciens_dt <- r_C_aerofaciens * C_aerofaciens * (1 - C_aerofaciens / max(0.0001, K_C_aerofaciens * (y_function_C_aerofaciens_Clomiphene_func(Drug))))
  dC_bolteae_dt <- r_C_bolteae * C_bolteae * (1 - C_bolteae /  max(0.0001, K_C_bolteae * (y_function_C_bolteae_Clomiphene_func(Drug))))
  dC_comes_dt <- r_C_comes * C_comes * (1 - C_comes / max(0.0001, K_C_comes * (y_function_C_comes_Clomiphene_func(Drug))))
  dC_perfringens_dt <- r_C_perfringens * C_perfringens * (1 - C_perfringens / max(0.0001, K_C_perfringens * (y_function_C_perfringens_Clomiphene_func(Drug))))
  dC_ramosum_dt <- r_C_ramosum * C_ramosum * (1 - C_ramosum / max(0.0001, K_C_ramosum * (y_function_C_ramosum_Clomiphene_func(Drug))))
  dC_saccharolyticum_dt <- r_C_saccharolyticum * C_saccharolyticum * (1 - C_saccharolyticum / max(0.0001, K_C_saccharolyticum * (y_function_C_saccharolyticum_Clomiphene_func(Drug))))
  dD_formicigenerans_dt <- r_D_formicigenerans * D_formicigenerans * (1 - D_formicigenerans / max(0.0001, K_D_formicigenerans * (y_function_D_formicigenerans_Clomiphene_func(Drug))))
  dE_coli_dt <- r_E_coli * E_coli * (1 - E_coli / max(0.0001, K_E_coli * (y_function_E_coli_Clomiphene_func(Drug))))
  dE_lenta_dt <- r_E_lenta * E_lenta * (1 - E_lenta / max(0.0001, K_E_lenta * (y_function_E_lenta_Clomiphene_func(Drug))))
  dE_rectale_dt <- r_E_rectale * E_rectale * (1 - E_rectale / max(0.0001, K_E_rectale * (y_function_E_rectale_Clomiphene_func(Drug))))
  dF_nucleatum_dt <- r_F_nucleatum * F_nucleatum * (1 - F_nucleatum / max(0.0001, K_F_nucleatum * (y_function_F_nucleatum_Clomiphene_func(Drug))))
  dL_paracasei_dt <- r_L_paracasei * L_paracasei * (1 - L_paracasei / K_L_paracasei)  
  dO_splanchnicus_dt <- r_O_splanchnicus * O_splanchnicus * (1 - O_splanchnicus / K_O_splanchnicus)  
  dP_copri_dt <- r_P_copri * P_copri * (1 - P_copri / K_P_copri)
  dP_distasonis_dt <- r_P_distasonis * P_distasonis * (1 - P_distasonis / K_P_distasonis)  
  dP_merdae_dt <- r_P_merdae * P_merdae * (1 - P_merdae / max(0.0001, K_P_merdae * (y_function_P_merdae_Clomiphene_func(Drug))))
  dR_bromii_dt <- r_R_bromii * R_bromii * (1 - R_bromii / K_R_bromii) 
  dR_gnavus_dt <- r_R_gnavus * R_gnavus * (1 - R_gnavus / max(0.0001, K_R_gnavus * (y_function_R_gnavus_Clomiphene_func(Drug))))
  dR_intestinalis_dt <- r_R_intestinalis * R_intestinalis * (1 - R_intestinalis / max(0.0001, K_R_intestinalis * (y_function_R_intestinalis_Clomiphene_func(Drug))))
  dR_torques_dt <- r_R_torques * R_torques * (1 - R_torques /K_R_torques) 
  dS_parasanguinis_dt <- r_S_parasanguinis * S_parasanguinis * (1 - S_parasanguinis / max(0.0001, K_S_parasanguinis * (y_function_S_parasanguinis_Clomiphene_func(Drug))))
  dS_salivarius_dt <- r_S_salivarius * S_salivarius * (1 - S_salivarius / max(0.0001, K_S_salivarius * (y_function_S_salivarius_Clomiphene_func(Drug))))
  dV_parvula_dt <- r_V_parvula * V_parvula * (1 - V_parvula / max(0.0001, K_V_parvula * (y_function_V_parvula_Clomiphene_func(Drug))))
  
  
  
  #Drug differential:
  dDrug_dt <- (subset(drug_dynamics, Drug == "Clomiphene")$Steepness_param_community * exp(-subset(drug_dynamics, Drug == "Clomiphene")$Steepness_param_community * t_mod)) * (drug_concentration_tested * prop_left_Clomiphene - drug_concentration_tested)
  #dDrug_dt <- 0
  
  ## Combine results into a single vector
  dxdt <- c(dA_muciniphila_dt, dB_adolescentis_dt, dB_fragilis_dt, dB_longum_dt, dB_obeum_dt, dB_thetaiotaomicron_dt, dB_uniformis_dt, dB_vulgatus_dt, dB_wadsworthia_dt, dC_aerofaciens_dt, dC_bolteae_dt, dC_comes_dt, dC_perfringens_dt, dC_ramosum_dt, dC_saccharolyticum_dt, dD_formicigenerans_dt, dE_coli_dt, dE_lenta_dt, dE_rectale_dt, dF_nucleatum_dt, dL_paracasei_dt, dO_splanchnicus_dt, dP_copri_dt, dP_distasonis_dt, dP_merdae_dt, dR_bromii_dt, dR_gnavus_dt, dR_intestinalis_dt, dR_torques_dt, dS_parasanguinis_dt, dS_salivarius_dt, dV_parvula_dt, dDrug_dt)
  
  ## Return result as a list
  list(dxdt)
}




#calculate the co-culture correction factor per species based on community composition in absence of drug, just like done for Niclosamide

growth_data_all_0_Niclosamide
growth_data_all_0_Niclosamide1 <- growth_data_all_0_Niclosamide %>%
  dplyr::mutate(Species = gsub(" ", "_", Species))


# Merge rel_ab_control with growth_data_all_0_Niclosamide on Species
# Function to remove duplicated columns by name pattern
clean_columns_base <- function(df, pattern) {
  cols_to_keep <- !grepl(pattern, names(df))
  df <- df[, cols_to_keep]
  return(df)
}

# Use the new function to clean up your dataframe
rel_ab_control <- clean_columns_base(rel_ab_control, "mean_max_OD.[xy]")
str(rel_ab_control)


#rel_ab_control$correction_factor <- rel_ab_control$mean_rel_ab / (rel_ab_control$mean_max_OD/sum(rel_ab_control$mean_max_OD))
# Calculate correction factor with a minimum value of ~1
rel_ab_control$correction_factor <- pmax(rel_ab_control$mean_rel_ab / (rel_ab_control$mean_max_OD / sum(rel_ab_control$mean_max_OD)), 1.1)


# Create a new dataframe for co-culture correction
co_culture_correction <- data.frame(
  species = rel_ab_control$Species,
  correction_factor = rel_ab_control$correction_factor
)


#summarise community data
#Adjust based on tested concentrations for each drug
unique(Community_compositions_focus_drugs_Clomiphene$concentration)

Community_compositions_focus_drugs_Clomiphene_5uM <- subset(Community_compositions_focus_drugs_Clomiphene, concentration == 5)
Community_compositions_focus_drugs_Clomiphene_20uM <- subset(Community_compositions_focus_drugs_Clomiphene, concentration == 20)
Community_compositions_focus_drugs_Clomiphene_80uM <- subset(Community_compositions_focus_drugs_Clomiphene, concentration == 80)


#5 uM
Community_compositions_focus_drugs_Clomiphene_5uM_summarised <- Community_compositions_focus_drugs_Clomiphene_5uM %>%
  dplyr::group_by(species) %>%                                  
  dplyr::summarize(
    mean_rel_ab = mean(rel_abundance, na.rm = TRUE),     
    sd_rel_ab = sd(rel_abundance, na.rm = TRUE) ,
    mean_max_OD = mean(maxOD, na.rm = TRUE),
    sd_max_OD = sd(maxOD, na.rm = TRUE),
    mean_final_OD = mean(finalOD, na.rm = TRUE),
    sd_final_OD = sd(finalOD, na.rm = TRUE)
  ) %>%
  dplyr::ungroup() 


Community_compositions_focus_drugs_Clomiphene_5uM_summarised <- Community_compositions_focus_drugs_Clomiphene_5uM_summarised %>%
  dplyr::mutate(Species = sub("^(\\w)\\w*\\s(.*)", "\\1._\\2", species))

#remove (sub)strain info
Community_compositions_focus_drugs_Clomiphene_5uM_summarised <- Community_compositions_focus_drugs_Clomiphene_5uM_summarised %>%
  dplyr::mutate(Species = sub("^(\\w\\._\\w+).*", "\\1", Species))


#20 uM
Community_compositions_focus_drugs_Clomiphene_20uM_summarised <- Community_compositions_focus_drugs_Clomiphene_20uM %>%
  dplyr::group_by(species) %>%                                  
  dplyr::summarize(
    mean_rel_ab = mean(rel_abundance, na.rm = TRUE),     
    sd_rel_ab = sd(rel_abundance, na.rm = TRUE) ,
    mean_max_OD = mean(maxOD, na.rm = TRUE),
    sd_max_OD = sd(maxOD, na.rm = TRUE),
    mean_final_OD = mean(finalOD, na.rm = TRUE),
    sd_final_OD = sd(finalOD, na.rm = TRUE)
  ) %>%
  dplyr::ungroup() 


Community_compositions_focus_drugs_Clomiphene_20uM_summarised <- Community_compositions_focus_drugs_Clomiphene_20uM_summarised %>%
  dplyr::mutate(Species = sub("^(\\w)\\w*\\s(.*)", "\\1._\\2", species))

#remove (sub)strain info
Community_compositions_focus_drugs_Clomiphene_20uM_summarised <- Community_compositions_focus_drugs_Clomiphene_20uM_summarised %>%
  dplyr::mutate(Species = sub("^(\\w\\._\\w+).*", "\\1", Species))


#80 uM
Community_compositions_focus_drugs_Clomiphene_80uM_summarised <- Community_compositions_focus_drugs_Clomiphene_80uM %>%
  dplyr::group_by(species) %>%                                  
  dplyr::summarize(
    mean_rel_ab = mean(rel_abundance, na.rm = TRUE),     
    sd_rel_ab = sd(rel_abundance, na.rm = TRUE) ,
    mean_max_OD = mean(maxOD, na.rm = TRUE),
    sd_max_OD = sd(maxOD, na.rm = TRUE),    
    mean_final_OD = mean(finalOD, na.rm = TRUE),
    sd_final_OD = sd(finalOD, na.rm = TRUE)
  ) %>%
  dplyr::ungroup() 



Community_compositions_focus_drugs_Clomiphene_80uM_summarised <- Community_compositions_focus_drugs_Clomiphene_80uM_summarised %>%
  dplyr::mutate(Species = sub("^(\\w)\\w*\\s(.*)", "\\1._\\2", species))

#remove (sub)strain info
Community_compositions_focus_drugs_Clomiphene_80uM_summarised <- Community_compositions_focus_drugs_Clomiphene_80uM_summarised %>%
  dplyr::mutate(Species = sub("^(\\w\\._\\w+).*", "\\1", Species))


#Initialise data frames
sim_output <- data.frame()
input_params_list <- list() #Use a list to collect parameters for each simulation

#number of simulations
num_sims <- 250


for (i in 1:num_sims) {
  tryCatch({
    # generate model parameters
    set.seed(i) #set a different seed for each simulation for variation
    params <- lapply(1:nrow(growth_data_all_0_Niclosamide), function(idx) {
      species_params <- growth_data_all_0_Niclosamide[idx, ]
      list(
        r = rnorm(1, mean = species_params$mean_max_Growth_rate, sd = species_params$sd_max_Growth_rate),
        K = rnorm(1, mean = species_params$mean_max_OD, sd = species_params$sd_max_OD)
      )
    })
    names(params) <- gsub(" ", "_", growth_data_all_0_Niclosamide$Species)
    flat_params <- unlist(params)
    names(flat_params) <- gsub("\\.\\d$", "", names(flat_params))
    
    #replace spaces with underscores to match formatting
    co_culture_correction$species <- gsub(" ", "_", co_culture_correction$species, fixed = TRUE)
    
    #replace the species-specific K parameters extracted from monoculture growth data 
    #with drawn relative abundance values at Niclosamide = 0, scaled to K
    rel_ab_control$Species <- gsub(" ", "_", rel_ab_control$Species)
    
    #Initialise an empty vector to store drawn values
    drawn_values <- numeric(nrow(rel_ab_control))
    
    #draw values from their respective distributions
    for (k in 1:nrow(rel_ab_control)) {
      species_name <- rel_ab_control$Species[k]
      drawn_value <- rnorm(1, mean = rel_ab_control$mean_rel_ab[k], sd = rel_ab_control$sd_rel_ab[k])
      drawn_values[k] <- max(drawn_value, 0)  # Ensure no negative values
    }
    
    #Normalise drawn relative abundance values so they sum to 1 (to reflect a 'true' relative abundance distribution)
    #this is needed so when we convert the values into OD units by multiplying with the drawn community maxOD,
    # the sum of K_i parameters and the drawn K are equal
    normalised_values <- drawn_values / sum(drawn_values)
    
    #Pull community maxOD (K) at 0 drugs from respective normal distribution:
    K <- rnorm(n = 1, mean = rel_ab_control$mean_com_max_OD[1], sd = rel_ab_control$sd_com_max_OD[1])
    
    # Assign these normalised values to their respective species' .K parameters
    for (k in 1:nrow(rel_ab_control)) {
      species_name <- rel_ab_control$Species[k]
      k_index <- grep(paste0("^", species_name, "\\.K$"), names(flat_params))
      
      if (length(k_index) > 0) {
        old_value <- flat_params[k_index]
        flat_params[k_index] <- (normalised_values[k] + 0.0001) * K #add small value in case drawn K_i is 0, which would cause issues with the solver
        cat(sprintf("Updated %s from %f to %f using normalised value %f scaled by K %f\n", names(flat_params)[k_index], old_value, flat_params[k_index], normalised_values[k], K))
      }
    }
    
    #Accounting for variation in drug degradation by community, with standard deviation of end concentration (at 10h) around the fitted predicted (relative) end concentration at 24h
    #prop_left_Clomiphene <- abs(rnorm(1, (subset(drug_dynamics, Drug == "Clomiphene")$Prop_left_24h_community), (subset(drug_dynamics, Drug == "Clomiphene")$SD_drug_community))) 
    #below, we account for measurement error rather than ecological drivers that lead to the variability of degradation at the final point measured 
    prop_left_Clomiphene <- abs(rnorm(
      n = 1, 
      mean = subset(drug_dynamics, Drug == "Clomiphene")$Prop_left_24h_community, 
      sd = ifelse(
        subset(drug_dynamics, Drug == "Clomiphene")$SD_drug_community > subset(drug_dynamics, Drug == "Clomiphene")$SD_drug_community_start, 
        subset(drug_dynamics, Drug == "Clomiphene")$SD_drug_community - subset(drug_dynamics, Drug == "Clomiphene")$SD_drug_community_start, 
        subset(drug_dynamics, Drug == "Clomiphene")$SD_drug_community
      )
    ))
    
    
    #loop through each species in co_culture_correction
    for (j in 1:nrow(co_culture_correction)) {
      # Extract the species name and correction factor
      species_name <- co_culture_correction$species[j]
      correction_factor <- co_culture_correction$correction_factor[j]
      
      # Identify the corresponding growth rate parameter in flat_params
      #by matching the base species name (without .r)
      growth_rate_indices <- grep(paste0("^", species_name, "\\.r$"), names(flat_params))
      
      #take the growth rate parameter and apply the correction factor 
      for (index in growth_rate_indices) {
        flat_params[index] <- flat_params[index] * correction_factor
      }
    }
    
    flat_params
    # Store parameters for each simulation
    input_params_list[[i]] <- c(sim_ID = i, flat_params)
    
    # Run the model for the first 24-hour cycle
    solution_cycle_1 <- ode(y = initial_conditions, times = seq(from = 0, to = 24, by = 0.1), func = closed.sir.model_Clomiphene, parms = flat_params,   method = "lsoda", rtol = 1e-6, atol = 1e-6)
    
    # Dilution and second cycle
    end_of_cycle_1 <- solution_cycle_1[nrow(solution_cycle_1), -1]
    initial_conditions_cycle_2 <- end_of_cycle_1 / 50
    #accounting for the drugs being added with the new growth cycle as well:
    initial_conditions_cycle_2[33] <- initial_conditions_cycle_2[33] + drug_concentration_tested
    solution_cycle_2 <- ode(y = initial_conditions_cycle_2, times = seq(from = 24, to = 48, by = 0.1), func = closed.sir.model_Clomiphene, parms = flat_params,  method = "lsoda", rtol = 1e-6, atol = 1e-6)
    
    # Combine and format results
    combined_solution <- rbind(as.data.frame(solution_cycle_1), as.data.frame(solution_cycle_2)[-1,])
    combined_solution$sim_ID <- rep(i, nrow(combined_solution))
    combined_solution <- combined_solution %>%
      tidyr::gather(key = "Species", value = "Density", -time, -sim_ID) %>%
      dplyr::mutate(Hour = time) %>%
      dplyr::select(sim_ID, Hour, Species, Density)
    
    ##Append to sim_output
    sim_output <- rbind(sim_output, combined_solution)
  }, error = function(e) {
    cat(sprintf("Skipping simulation %d due to an error: %s\n", i, e$message))
  })
}



##Combine all parameter data into a single dataframe
input_params <- do.call(rbind, input_params_list)

# Add a "Species" column 
sim_output$Species_name <- species_names[as.numeric(as.character(sim_output$Species))]
sim_output$Species_name <- replace_na(sim_output$Species_name, "Drug")

#View(input_params)
#View(sim_output)

sim_output <- na.omit(sim_output)
successful_sim_ids <- unique(subset(sim_output, Hour == 48)$sim_ID)
length(successful_sim_ids)
sim_output1 <- sim_output[sim_output$sim_ID %in% successful_sim_ids, ]


#Transform sim_output so we have wide format by Species
sim_output_wide <- tidyr::pivot_wider(sim_output1, 
                                      names_from = Species_name, 
                                      values_from = Density,
                                      id_cols = c(sim_ID, Hour))

length(unique(sim_output_wide$sim_ID))
#calc community OD per timepoint
sim_output_wide$Total_OD <- rowSums(sim_output_wide[, 3:34], na.rm = TRUE)
#calculate and add relative abundances here as well:
species_columns <- colnames(sim_output_wide)[3:34] 

for (species in species_columns) {
  sim_output_wide[[paste0("rel_", species)]] <- sim_output_wide[[species]] / sim_output_wide$Total_OD
}


#assign sim_output_wide test conditions to dataframe name
drug_tested <- "Clomiphene"
variable_name_1 <- paste0("sim_output_wide_", ifelse(drug_concentration_tested == 1e-04, 0, drug_concentration_tested), "_", drug_tested)
assign(variable_name_1, sim_output_wide)

#turn back into long format if interested in plotting relative abundances
cols_needed <- c("sim_ID", "Hour")

sim_output_long <- sim_output_wide %>% 
  dplyr::select(sim_ID, Hour, Drug, starts_with("rel_")) %>% 
  tidyr::pivot_longer(
    cols = c(Drug, starts_with("rel_")),
    names_to = "Species", 
    values_to = "Relative_abundance",
    names_prefix = "rel_",
    names_transform = list(Species = ~ ifelse(.x == "Drug", "Drug", .x))
  ) 

str(sim_output_long)


species_names_1 <- c(
  "A_muciniphila",
  "B_adolescentis",
  "B_fragilis",
  "B_longum",
  "B_obeum",
  "B_thetaiotaomicron",
  "B_uniformis",
  "B_vulgatus",
  "B_wadsworthia",
  "C_aerofaciens",
  "C_bolteae",
  "C_comes",
  "C_perfringens",
  "C_ramosum",
  "C_saccharolyticum",
  "D_formicigenerans",
  "E_coli",
  "E_lenta",
  "E_rectale",
  "F_nucleatum",
  "L_paracasei",
  "O_splanchnicus",
  "P_copri",
  "P_distasonis",
  "P_merdae",
  "R_bromii",
  "R_gnavus",
  "R_intestinalis",
  "R_torques",
  "S_parasanguinis",
  "S_salivarius",
  "V_parvula",
  "Drug"
)

species_colours_1 <- c(
  "A_muciniphila" = "#1f77b4",
  "B_adolescentis" = "#ff7f0e",
  "B_fragilis" = "#2ca02c",
  "B_longum" = "#d62728",
  "B_obeum" = "#9467bd",
  "B_thetaiotaomicron" = "black",
  "B_uniformis" = "#e377c2",
  "B_vulgatus" = "#7f7f7f",
  "B_wadsworthia" = "gold1",
  "C_aerofaciens" = "#aec7e8",
  "C_bolteae" = "#ffbb78",
  "C_comes" = "magenta",
  "C_perfringens" = "#ff9896",
  "C_ramosum" = "#c5b0d5",
  "C_saccharolyticum" = "#c49c94",
  "D_formicigenerans" = "#f7b6d2",
  "E_coli" = "yellow",
  "E_lenta" = "turquoise",
  "E_rectale" = "#393b79",
  "F_nucleatum" = "royalblue2",
  "L_paracasei" = "blue",
  "O_splanchnicus" = "#637939",
  "P_copri" = "cyan",
  "P_distasonis" = "#8c6d31",
  "P_merdae" = "#c7c7c7",
  "R_bromii" = "#e6550d",
  "R_gnavus" = "#e7cb94",
  "R_intestinalis" = "#843c39",
  "R_torques" = "#d6616b",
  "S_parasanguinis" = "orange3",
  "S_salivarius" = "#7b4173",
  "V_parvula" = "#ce6dbd",
  "Drug" = "green"
)



##Plot output for any specific sim:
# ggplot(subset(sim_output, sim_ID == 1 & Species_name != "Drug"), aes(x = Hour, y = Density, group = Species_name, color = Species_name)) +
#   geom_line(size = 1, alpha = 0.7) +
#   scale_color_manual(values = species_colours_1) +
#   labs(title = paste0("Clomiphene = ", drug_concentration_tested),
#        x = "Time (hours)",
#        y = "Population Density (OD)",
#        color = "Species") +
#   theme_minimal() +
#   theme(legend.position = "right")
# 
# ggplot(subset(sim_output, sim_ID == 3 & Species_name != "Drug"), aes(x = Hour, y = Density, group = Species_name, color = Species_name)) +
#   geom_line(size = 1, alpha = 0.7) +
#   scale_color_manual(values = species_colours_1) +
#   labs(title = paste0("Clomiphene = ", drug_concentration_tested),
#        x = "Time (hours)",
#        y = "Population Density (OD)",
#        color = "Species") +
#   theme_minimal() +
#   theme(legend.position = "right")


ggplot(subset(sim_output_long, sim_ID == 1), aes(x = Hour, y = Relative_abundance, group = Species, color = Species)) +
  geom_line(size = 1, alpha = 0.7) +
  scale_color_manual(values = species_colours_1) +
  labs(title = paste0("Clomiphene = ", drug_concentration_tested),
       x = "Time (hours)",
       y = "Relative abundance",
       color = "Species") +
  theme_minimal() +
  theme(legend.position = "right")


ggplot(subset(sim_output_long, sim_ID == 3), aes(x = Hour, y = Relative_abundance, group = Species, color = Species)) +
  geom_line(size = 1, alpha = 0.7) +
  scale_color_manual(values = species_colours_1) +
  labs(title = paste0("Clomiphene = ", drug_concentration_tested),
       x = "Time (hours)",
       y = "Relative abundance",
       color = "Species") +
  theme_minimal() +
  theme(legend.position = "right")


#calc mean and standard deviation across sims
sim_stats <- sim_output_long %>%
  dplyr::group_by(Hour, Species) %>%
  dplyr::summarise(
    mean_rel_ab = mean(Relative_abundance),
    sd_rel_ab = sd(Relative_abundance),
    .groups = 'drop'
  )

# Prepare the data for plotting
plot_data <- sim_stats %>%
  dplyr::mutate(Upper = mean_rel_ab + sd_rel_ab, Lower = mean_rel_ab - sd_rel_ab)

ggplot(subset(plot_data, Species != "Drug"), aes(x = Hour, y = mean_rel_ab, group = Species, color = Species)) +
  geom_ribbon(aes(ymin = Lower, ymax = Upper, fill = Species), colour = NA, alpha = 0.2) +  
  geom_line(size = 1, alpha = 0.7) + 
  scale_color_manual(values = species_colours_1) +
  scale_fill_manual(values = species_colours_1) +  
  labs(title = "Mean and SD of Relative Abundance Across Simulations",
       subtitle = paste0("Clomiphene = ", drug_concentration_tested),       
       x = "Time (hours)",
       y = "Relative abundance",
       color = "Species",
       fill = "Species") +
  theme_minimal() +
  theme(legend.position = "right")

#log-scaled mean trends
ggplot(plot_data, aes(x = Hour, y = log10(mean_rel_ab + 0.0001), group = Species, color = Species)) +
  geom_line(size = 1, alpha = 0.7) +  # Mean line
  scale_color_manual(values = species_colours_1) +
  scale_fill_manual(values = species_colours_1) +  # Ensure consistent colors for lines and fills
  labs(title = "Mean and SD of Relative Abundance Across Simulations",
       subtitle = paste0("Clomiphene = ", drug_concentration_tested),
       x = "Time (hours)",
       y = "Relative abundance",
       color = "Species",
       fill = "Species") +
  theme_minimal() +
  theme(legend.position = "right")




##prediction quality evaluation
drug_tested <- "Clomiphene"
variable_name <- paste0("plot_data_", ifelse(drug_concentration_tested == 1e-04, 0, drug_concentration_tested), "_", drug_tested)
assign(variable_name, plot_data)


#extract total OD info:
predicted_mean_final_od_NULL <- Niclosamide_16S_0uM_summarised$mean_com_final_OD[1]
predicted_sd_final_od_NULL <- Niclosamide_16S_0uM_summarised$sd_com_final_OD[1]

predicted_mean_final_od_5_Clomiphene <- mean(subset(sim_output_wide_5_Clomiphene, Hour == 48)$Total_OD, na.rm = TRUE)
predicted_sd_final_od_5_Clomiphene <- sd(subset(sim_output_wide_5_Clomiphene, Hour == 48)$Total_OD, na.rm = TRUE)

real_mean_final_od_5_Clomiphene <- Community_compositions_focus_drugs_Clomiphene_5uM_summarised$mean_final_OD[1]
real_sd_final_od_5_Clomiphene <- Community_compositions_focus_drugs_Clomiphene_5uM_summarised$sd_final_OD[1]


predicted_mean_final_od_20_Clomiphene <- mean(subset(sim_output_wide_20_Clomiphene, Hour == 48)$Total_OD, na.rm = TRUE)
predicted_sd_final_od_20_Clomiphene <- sd(subset(sim_output_wide_20_Clomiphene, Hour == 48)$Total_OD, na.rm = TRUE)

real_mean_final_od_20_Clomiphene <- Community_compositions_focus_drugs_Clomiphene_20uM_summarised$mean_final_OD[1]
real_sd_final_od_20_Clomiphene <- Community_compositions_focus_drugs_Clomiphene_20uM_summarised$sd_final_OD[1]


predicted_mean_final_od_80_Clomiphene <- mean(subset(sim_output_wide_80_Clomiphene, Hour == 48)$Total_OD, na.rm = TRUE)
predicted_sd_final_od_80_Clomiphene <- sd(subset(sim_output_wide_80_Clomiphene, Hour == 48)$Total_OD, na.rm = TRUE)

real_mean_final_od_80_Clomiphene <- Community_compositions_focus_drugs_Clomiphene_80uM_summarised$mean_final_OD[1]
real_sd_final_od_80_Clomiphene <- Community_compositions_focus_drugs_Clomiphene_80uM_summarised$sd_final_OD[1]




#plot_data_0_Clomiphene_endpoint was used to test model performance at 0 drugs
#plot_data_0_Clomiphene_endpoint <- subset(plot_data_0_Clomiphene, Hour == 48 & Species != "Drug")
plot_data_5_Clomiphene_endpoint <- subset(plot_data_5_Clomiphene, Hour == 48 & Species != "Drug")
plot_data_20_Clomiphene_endpoint <- subset(plot_data_20_Clomiphene, Hour == 48 & Species != "Drug")
plot_data_80_Clomiphene_endpoint <- subset(plot_data_80_Clomiphene, Hour == 48 & Species != "Drug")

##Inspecting 'match' to real relative abundance distributions:
Niclosamide_16S_0uM_summarised <- rel_ab_control
Niclosamide_16S_0uM_summarised$Species <- gsub("\\.", "", Niclosamide_16S_0uM_summarised$Species)

Clomiphene_16S_5uM_summarised <- Community_compositions_focus_drugs_Clomiphene_5uM_summarised
Clomiphene_16S_20uM_summarised <- Community_compositions_focus_drugs_Clomiphene_20uM_summarised
Clomiphene_16S_80uM_summarised <- Community_compositions_focus_drugs_Clomiphene_80uM_summarised

Niclosamide_16S_0uM_summarised
Clomiphene_16S_5uM_summarised 
Clomiphene_16S_20uM_summarised 
Clomiphene_16S_80uM_summarised 

#Rename 'species' so the outputs become comparable
original_names_80 <- unique(Clomiphene_16S_80uM_summarised$species)
original_names_20 <- unique(Clomiphene_16S_20uM_summarised$species)
original_names_5 <- unique(Clomiphene_16S_5uM_summarised$species)


##Create a named vector with the original and new names mapping
name_changes <- c(
  "Akkermansia muciniphila" = "A_muciniphila",
  "Bacteroides fragilis" = "B_fragilis",
  "Bacteroides thetaiotaomicron" = "B_thetaiotaomicron",
  "Bacteroides uniformis" = "B_uniformis",
  "Bifidobacterium adolescentis" = "B_adolescentis",
  "Bifidobacterium longum subsp. longum" = "B_longum",
  "Bilophila wadsworthia" = "B_wadsworthia",
  "Blautia obeum" = "B_obeum",
  "Clostridium perfringens" = "C_perfringens",
  "Collinsella aerofaciens" = "C_aerofaciens",
  "Coprococcus comes" = "C_comes",
  "Dorea formicigenerans" = "D_formicigenerans",
  "Eggerthella lenta" = "E_lenta",
  "Enterocloster bolteae" = "C_bolteae",
  "Erysipelatoclostridium ramosum" = "C_ramosum",
  "Escherichia coli ED1a" = "E_coli",
  "Eubacterium rectale" = "E_rectale",
  "Fusobacterium nucleatum subsp. nucleatum" = "F_nucleatum",
  "Lacrimispora saccharolytica" = "C_saccharolyticum",
  "Lacticaseibacillus paracasei" = "L_paracasei",
  "Odoribacter splanchnicus" = "O_splanchnicus",
  "Parabacteroides distasonis" = "P_distasonis",
  "Parabacteroides merdae" = "P_merdae",
  "Phocaeicola vulgatus" = "B_vulgatus",
  "Prevotella copri" = "P_copri",
  "Roseburia intestinalis" = "R_intestinalis",
  "Ruminococcus bromii" = "R_bromii",
  "Ruminococcus gnavus" = "R_gnavus",
  "Ruminococcus torques" = "R_torques",
  "Streptococcus parasanguinis" = "S_parasanguinis",
  "Streptococcus salivarius" = "S_salivarius",
  "Veillonella parvula" = "V_parvula"
)

# Apply name changes to the species column in Clomiphene_16S_80uM_summarised

Clomiphene_16S_80uM_summarised$Species <- name_changes[Clomiphene_16S_80uM_summarised$species]
Clomiphene_16S_20uM_summarised$Species <- name_changes[Clomiphene_16S_20uM_summarised$species]
Clomiphene_16S_5uM_summarised$Species <- name_changes[Clomiphene_16S_5uM_summarised$species]

# Verify the changes
unique(Clomiphene_16S_80uM_summarised$Species)
unique(Clomiphene_16S_20uM_summarised$Species)
unique(Clomiphene_16S_5uM_summarised$Species)



##First, for 5 uM:
# Get top 6 species from plot_data_5_endpoint
# Adjust the plot_data_5_endpoint with confidence bounds

# #plot_data_0_Clomiphene_endpoint was used to test model performance at 0 drugs
# plot_data_0_Clomiphene_endpoint <- plot_data_0_Clomiphene_endpoint %>%
#   dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)

plot_data_5_Clomiphene_endpoint <- plot_data_5_Clomiphene_endpoint %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)

# Adjust the Clomiphene_16S_5uM_summarised with confidence bounds
Clomiphene_16S_5uM_summarised <- Clomiphene_16S_5uM_summarised %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)

#NULL model:
Null_model_summarised <- Niclosamide_16S_0uM_summarised %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)


# Get top 6 species based on the lower bound from plot_data_5_endpoint

#top6_predicted_0_Clomiphene was used to test model performance at 0 drugs
# top6_predicted_0_Clomiphene <- plot_data_0_Clomiphene_endpoint %>%
#    arrange(desc(lower_bound)) %>%
#    slice(1:6) %>%
#    pull(Species)

top6_predicted_5_Clomiphene <- plot_data_5_Clomiphene_endpoint %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

# Get top 6 species based on the lower bound from Clomiphene_16S_5uM_summarised
top6_real_5_Clomiphene <- Clomiphene_16S_5uM_summarised %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

top6_NULL <- Null_model_summarised %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

# Calculate the overlap of top 6 species

#top_six_correct_0_Clomiphene was used to assess model performance at 0 drugs
# top_six_correct_0_Clomiphene <- length(intersect(top6_predicted_0_Clomiphene, top6_NULL))
# top_six_correct_0_Clomiphene

top_six_correct_5_Clomiphene <- length(intersect(top6_predicted_5_Clomiphene, top6_real_5_Clomiphene))
top_six_correct_5_Clomiphene

top_six_correct_5_Clomiphene_NULL <- length(intersect(top6_NULL, top6_real_5_Clomiphene))
top_six_correct_5_Clomiphene_NULL

top6_predicted_5_Clomiphene
top6_real_5_Clomiphene

#top6_NULL

#Now by means:
# #top6_predicted_0_Clomiphene_means was used to assess model performance at 0 drugs
# top6_predicted_0_Clomiphene_means <- plot_data_0_Clomiphene_endpoint %>%
#    arrange(desc(mean_rel_ab)) %>%
#    slice(1:6) %>%
#    pull(Species)

top6_predicted_5_Clomiphene_means <- plot_data_5_Clomiphene_endpoint %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)

# Get top 6 species based on the lower bound from Clomiphene_16S_5uM_summarised
top6_real_5_Clomiphene_means <- Clomiphene_16S_5uM_summarised %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)

top6_NULL_means <- Null_model_summarised %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)


# #top_six_correct_0_Clomiphene_means was used to assess model performance at 0 drugs
# top_six_correct_0_Clomiphene_means <- length(intersect(top6_predicted_0_Clomiphene_means, top6_NULL_means))
# top_six_correct_0_Clomiphene_means

top_six_correct_5_Clomiphene_means <- length(intersect(top6_predicted_5_Clomiphene_means, top6_real_5_Clomiphene_means))
top_six_correct_5_Clomiphene_means

top_six_correct_5_Clomiphene_means_NULL <- length(intersect(top6_NULL_means, top6_real_5_Clomiphene_means))
top_six_correct_5_Clomiphene_means_NULL

top6_predicted_5_Clomiphene_means
top6_real_5_Clomiphene_means

#top6_NULL_means


# Merge dataframes by Species

#merged_data_0_Clomiphene was used to assess model performance at 0 drugs
#merged_data_0_Clomiphene <- merge(plot_data_0_Clomiphene_endpoint, Niclosamide_16S_0uM_summarised, by = "Species", suffixes = c(".pred", ".real"))
merged_data_5_Clomiphene <- merge(plot_data_5_Clomiphene_endpoint, Clomiphene_16S_5uM_summarised, by = "Species", suffixes = c(".pred", ".real"))
merged_data_5_Clomiphene_NULL <- merge(Niclosamide_16S_0uM_summarised, Clomiphene_16S_5uM_summarised, by = "Species", suffixes = c(".null", ".real"))


## Below lines used for assessing model performance at 0 drugs; ignore for nonzero concentrations
# # Create lower and upper bounds considering mean ¬± sd
# merged_data_0_Clomiphene$lower_bound_pred <- merged_data_0_Clomiphene$mean_rel_ab.pred - merged_data_0_Clomiphene$sd_rel_ab.pred
# merged_data_0_Clomiphene$upper_bound_pred <- merged_data_0_Clomiphene$mean_rel_ab.pred + merged_data_0_Clomiphene$sd_rel_ab.pred
# merged_data_0_Clomiphene$lower_bound_real <- merged_data_0_Clomiphene$mean_rel_ab.real - merged_data_0_Clomiphene$sd_rel_ab.real
# merged_data_0_Clomiphene$upper_bound_real <- merged_data_0_Clomiphene$mean_rel_ab.real + merged_data_0_Clomiphene$sd_rel_ab.real
# 
# # Ensure lower and upper bounds are non-negative, adjusting as necessary
# merged_data_0_Clomiphene$lower_bound_pred[merged_data_0_Clomiphene$lower_bound_pred <= 0] <- 1e-10
# merged_data_0_Clomiphene$lower_bound_real[merged_data_0_Clomiphene$lower_bound_real <= 0] <- 1e-10
# merged_data_0_Clomiphene$upper_bound_pred[merged_data_0_Clomiphene$upper_bound_pred <= 0] <- 1e-10
# merged_data_0_Clomiphene$upper_bound_real[merged_data_0_Clomiphene$upper_bound_real <= 0] <- 1e-10


# Create lower and upper bounds considering mean ¬± sd
merged_data_5_Clomiphene$lower_bound_pred <- merged_data_5_Clomiphene$mean_rel_ab.pred - merged_data_5_Clomiphene$sd_rel_ab.pred
merged_data_5_Clomiphene$upper_bound_pred <- merged_data_5_Clomiphene$mean_rel_ab.pred + merged_data_5_Clomiphene$sd_rel_ab.pred
merged_data_5_Clomiphene$lower_bound_real <- merged_data_5_Clomiphene$mean_rel_ab.real - merged_data_5_Clomiphene$sd_rel_ab.real
merged_data_5_Clomiphene$upper_bound_real <- merged_data_5_Clomiphene$mean_rel_ab.real + merged_data_5_Clomiphene$sd_rel_ab.real

# Ensure lower and upper bounds are non-negative, adjusting as necessary
merged_data_5_Clomiphene$lower_bound_pred[merged_data_5_Clomiphene$lower_bound_pred <= 0] <- 1e-10
merged_data_5_Clomiphene$lower_bound_real[merged_data_5_Clomiphene$lower_bound_real <= 0] <- 1e-10
merged_data_5_Clomiphene$upper_bound_pred[merged_data_5_Clomiphene$upper_bound_pred <= 0] <- 1e-10
merged_data_5_Clomiphene$upper_bound_real[merged_data_5_Clomiphene$upper_bound_real <= 0] <- 1e-10

##and for NULL model:
# Create lower and upper bounds considering mean ¬± sd
merged_data_5_Clomiphene_NULL$lower_bound_null <- merged_data_5_Clomiphene_NULL$mean_rel_ab.null - merged_data_5_Clomiphene_NULL$sd_rel_ab.null
merged_data_5_Clomiphene_NULL$upper_bound_null <- merged_data_5_Clomiphene_NULL$mean_rel_ab.null + merged_data_5_Clomiphene_NULL$sd_rel_ab.null
merged_data_5_Clomiphene_NULL$lower_bound_real <- merged_data_5_Clomiphene_NULL$mean_rel_ab.real - merged_data_5_Clomiphene_NULL$sd_rel_ab.real
merged_data_5_Clomiphene_NULL$upper_bound_real <- merged_data_5_Clomiphene_NULL$mean_rel_ab.real + merged_data_5_Clomiphene_NULL$sd_rel_ab.real

# Ensure lower and upper bounds are non-negative, adjusting as necessary
merged_data_5_Clomiphene_NULL$lower_bound_null[merged_data_5_Clomiphene_NULL$lower_bound_null <= 0] <- 1e-10
merged_data_5_Clomiphene_NULL$lower_bound_real[merged_data_5_Clomiphene_NULL$lower_bound_real <= 0] <- 1e-10
merged_data_5_Clomiphene_NULL$upper_bound_null[merged_data_5_Clomiphene_NULL$upper_bound_null <= 0] <- 1e-10
merged_data_5_Clomiphene_NULL$upper_bound_real[merged_data_5_Clomiphene_NULL$upper_bound_real <= 0] <- 1e-10

# Filter to include only species with a mean relative abundance > 0.01 in the 'real' dataset

## significant_species_0 was used to assess model performance at 0 drugs
#significant_species_0 <- merged_data_0_Clomiphene[merged_data_0_Clomiphene$mean_rel_ab.real > 0.01, ]
significant_species <- merged_data_5_Clomiphene[merged_data_5_Clomiphene$mean_rel_ab.real > 0.01, ]
survivors_5_Clomiphene <- nrow(significant_species)
survivors_5_Clomiphene

#should be the same as survivors defined above, since it is calculated from .real
significant_species_NULL <- merged_data_5_Clomiphene_NULL[merged_data_5_Clomiphene_NULL$mean_rel_ab.real > 0.01, ]
survivors_5_Clomiphene_NULL <- nrow(significant_species_NULL)
survivors_5_Clomiphene_NULL

# Adjusted order of magnitude check to include SD, only for significant species
## below code was used to assess model performance at 0 drugs
# significant_species_0$Predicted_magnitude_correct <- ifelse(
#   (floor(log10(significant_species_0$lower_bound_pred)) <= floor(log10(significant_species_0$upper_bound_real)) &
#      floor(log10(significant_species_0$upper_bound_pred)) >= floor(log10(significant_species_0$lower_bound_real))),
#   1,
#   0
# )

significant_species$Predicted_magnitude_correct <- ifelse(
  (floor(log10(significant_species$lower_bound_pred)) <= floor(log10(significant_species$upper_bound_real)) &
     floor(log10(significant_species$upper_bound_pred)) >= floor(log10(significant_species$lower_bound_real))),
  1,
  0
)

#and for the Null model:
significant_species_NULL$Predicted_magnitude_correct <- ifelse(
  (floor(log10(significant_species_NULL$lower_bound_null)) <= floor(log10(significant_species_NULL$upper_bound_real)) &
     floor(log10(significant_species_NULL$upper_bound_null)) >= floor(log10(significant_species_NULL$lower_bound_real))),
  1,
  0
)

# Calculate the fraction of correctly predicted magnitudes for significant species
## below code was used to assess model performance at 0 drugs
#predicted_magnitude_correct_fraction_0_Clomiphene <- sum(significant_species_0$Predicted_magnitude_correct) / nrow(significant_species_0)
#predicted_magnitude_correct_fraction_0_Clomiphene

predicted_magnitude_correct_fraction_5_Clomiphene <- sum(significant_species$Predicted_magnitude_correct) / nrow(significant_species)
predicted_magnitude_correct_fraction_5_Clomiphene

predicted_magnitude_correct_fraction_5_Clomiphene_NULL <- sum(significant_species_NULL$Predicted_magnitude_correct) / nrow(significant_species_NULL)
predicted_magnitude_correct_fraction_5_Clomiphene_NULL

top_species_missing_5_Clomiphene <- setdiff(top6_real_5_Clomiphene_means, top6_predicted_5_Clomiphene_means)
top_species_wrong_5_Clomiphene <- setdiff(top6_predicted_5_Clomiphene_means, top6_real_5_Clomiphene_means)

top_species_missing_5_Clomiphene <- if(length(top_species_missing_5_Clomiphene) == 0) "None" else top_species_missing_5_Clomiphene
top_species_wrong_5_Clomiphene <- if(length(top_species_wrong_5_Clomiphene) == 0) "None" else top_species_wrong_5_Clomiphene

Prediction_quality_5_Clomiphene <- data.frame(
  Top_six_correct = paste(top_six_correct_5_Clomiphene, sep=""),
  Top_six_correct_NULL = paste(top_six_correct_5_Clomiphene_NULL, sep=""),
  Top_six_correct_means = paste(top_six_correct_5_Clomiphene_means, sep=""),
  Top_six_correct_means_NULL = paste(top_six_correct_5_Clomiphene_means_NULL, sep=""),
  Predicted_magnitude_correct = paste(round(predicted_magnitude_correct_fraction_5_Clomiphene * 100, 2), "%", sep=""),
  Predicted_magnitude_correct_NULL = paste(round(predicted_magnitude_correct_fraction_5_Clomiphene_NULL * 100, 2), "%", sep=""),
  survivors_total = survivors_5_Clomiphene,
  top_species_missing <- top_species_missing_5_Clomiphene,
  top_species_wrong <- top_species_wrong_5_Clomiphene, 
  predicted_mean_final_OD <- predicted_mean_final_od_5_Clomiphene,
  real_mean_final_OD <- real_mean_final_od_5_Clomiphene,
  sims_total = length(successful_sim_ids)
)



Prediction_quality_5_Clomiphene



##Next, for 20 uM:
# Get top 6 species from plot_data_20_endpoint
# Adjust the plot_data_20_endpoint with confidence bounds
plot_data_20_Clomiphene_endpoint <- plot_data_20_Clomiphene_endpoint %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)

# Adjust the Clomiphene_16S_20uM_summarised with confidence bounds
Clomiphene_16S_20uM_summarised <- Clomiphene_16S_20uM_summarised %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)

#NULL model:
Null_model_summarised <- Niclosamide_16S_0uM_summarised %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)


# Get top 6 species based on the lower bound from plot_data_20_endpoint
top6_predicted_20_Clomiphene <- plot_data_20_Clomiphene_endpoint %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

# Get top 6 species based on the lower bound from Clomiphene_16S_20uM_summarised
top6_real_20_Clomiphene <- Clomiphene_16S_20uM_summarised %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

top6_NULL <- Null_model_summarised %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

# Calculate the overlap of top 6 species
top_six_correct_20_Clomiphene <- length(intersect(top6_predicted_20_Clomiphene, top6_real_20_Clomiphene))
#top_six_correct_20_Clomiphene

top_six_correct_20_Clomiphene_NULL <- length(intersect(top6_NULL, top6_real_20_Clomiphene))
#top_six_correct_20_Clomiphene_NULL

#top6_predicted_20_Clomiphene
#top6_real_20_Clomiphene



#Now by means:
top6_predicted_20_Clomiphene_means <- plot_data_20_Clomiphene_endpoint %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)

# Get top 6 species based on the lower bound from Clomiphene_16S_20uM_summarised
top6_real_20_Clomiphene_means <- Clomiphene_16S_20uM_summarised %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)

top6_NULL_means <- Null_model_summarised %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)



top_six_correct_20_Clomiphene_means <- length(intersect(top6_predicted_20_Clomiphene_means, top6_real_20_Clomiphene_means))
#top_six_correct_20_Clomiphene_means

top_six_correct_20_Clomiphene_means_NULL <- length(intersect(top6_NULL_means, top6_real_20_Clomiphene_means))
#top_six_correct_20_Clomiphene_means_NULL

top6_predicted_20_Clomiphene_means
#top6_real_20_Clomiphene_means




# Merge dataframes by Species
merged_data_20_Clomiphene <- merge(plot_data_20_Clomiphene_endpoint, Clomiphene_16S_20uM_summarised, by = "Species", suffixes = c(".pred", ".real"))
merged_data_20_Clomiphene_NULL <- merge(Niclosamide_16S_0uM_summarised, Clomiphene_16S_20uM_summarised, by = "Species", suffixes = c(".null", ".real"))



# Create lower and upper bounds considering mean ¬± sd
merged_data_20_Clomiphene$lower_bound_pred <- merged_data_20_Clomiphene$mean_rel_ab.pred - merged_data_20_Clomiphene$sd_rel_ab.pred
merged_data_20_Clomiphene$upper_bound_pred <- merged_data_20_Clomiphene$mean_rel_ab.pred + merged_data_20_Clomiphene$sd_rel_ab.pred
merged_data_20_Clomiphene$lower_bound_real <- merged_data_20_Clomiphene$mean_rel_ab.real - merged_data_20_Clomiphene$sd_rel_ab.real
merged_data_20_Clomiphene$upper_bound_real <- merged_data_20_Clomiphene$mean_rel_ab.real + merged_data_20_Clomiphene$sd_rel_ab.real

# Ensure lower and upper bounds are non-negative, adjusting as necessary
merged_data_20_Clomiphene$lower_bound_pred[merged_data_20_Clomiphene$lower_bound_pred <= 0] <- 1e-10
merged_data_20_Clomiphene$lower_bound_real[merged_data_20_Clomiphene$lower_bound_real <= 0] <- 1e-10
merged_data_20_Clomiphene$upper_bound_pred[merged_data_20_Clomiphene$upper_bound_pred <= 0] <- 1e-10
merged_data_20_Clomiphene$upper_bound_real[merged_data_20_Clomiphene$upper_bound_real <= 0] <- 1e-10

##and for NULL model:
# Create lower and upper bounds considering mean ¬± sd
merged_data_20_Clomiphene_NULL$lower_bound_null <- merged_data_20_Clomiphene_NULL$mean_rel_ab.null - merged_data_20_Clomiphene_NULL$sd_rel_ab.null
merged_data_20_Clomiphene_NULL$upper_bound_null <- merged_data_20_Clomiphene_NULL$mean_rel_ab.null + merged_data_20_Clomiphene_NULL$sd_rel_ab.null
merged_data_20_Clomiphene_NULL$lower_bound_real <- merged_data_20_Clomiphene_NULL$mean_rel_ab.real - merged_data_20_Clomiphene_NULL$sd_rel_ab.real
merged_data_20_Clomiphene_NULL$upper_bound_real <- merged_data_20_Clomiphene_NULL$mean_rel_ab.real + merged_data_20_Clomiphene_NULL$sd_rel_ab.real

# Ensure lower and upper bounds are non-negative, adjusting as necessary
merged_data_20_Clomiphene_NULL$lower_bound_null[merged_data_20_Clomiphene_NULL$lower_bound_null <= 0] <- 1e-10
merged_data_20_Clomiphene_NULL$lower_bound_real[merged_data_20_Clomiphene_NULL$lower_bound_real <= 0] <- 1e-10
merged_data_20_Clomiphene_NULL$upper_bound_null[merged_data_20_Clomiphene_NULL$upper_bound_null <= 0] <- 1e-10
merged_data_20_Clomiphene_NULL$upper_bound_real[merged_data_20_Clomiphene_NULL$upper_bound_real <= 0] <- 1e-10

# Filter to include only species with a mean relative abundance > 0.01 in the 'real' dataset
significant_species <- merged_data_20_Clomiphene[merged_data_20_Clomiphene$mean_rel_ab.real > 0.01, ]
survivors_20_Clomiphene <- nrow(significant_species)
survivors_20_Clomiphene

#should be the same as survivors defined above, since it is calculated from .real
significant_species_NULL <- merged_data_20_Clomiphene_NULL[merged_data_20_Clomiphene_NULL$mean_rel_ab.real > 0.01, ]
survivors_20_Clomiphene_NULL <- nrow(significant_species_NULL)
survivors_20_Clomiphene_NULL

# Adjusted order of magnitude check to include SD, only for significant species
significant_species$Predicted_magnitude_correct <- ifelse(
  (floor(log10(significant_species$lower_bound_pred)) <= floor(log10(significant_species$upper_bound_real)) &
     floor(log10(significant_species$upper_bound_pred)) >= floor(log10(significant_species$lower_bound_real))),
  1,
  0
)

#and for the Null model:
significant_species_NULL$Predicted_magnitude_correct <- ifelse(
  (floor(log10(significant_species_NULL$lower_bound_null)) <= floor(log10(significant_species_NULL$upper_bound_real)) &
     floor(log10(significant_species_NULL$upper_bound_null)) >= floor(log10(significant_species_NULL$lower_bound_real))),
  1,
  0
)

# Calculate the fraction of correctly predicted magnitudes for significant species
predicted_magnitude_correct_fraction_20_Clomiphene <- sum(significant_species$Predicted_magnitude_correct) / nrow(significant_species)
predicted_magnitude_correct_fraction_20_Clomiphene

predicted_magnitude_correct_fraction_20_Clomiphene_NULL <- sum(significant_species_NULL$Predicted_magnitude_correct) / nrow(significant_species_NULL)
predicted_magnitude_correct_fraction_20_Clomiphene_NULL

top_species_missing_20_Clomiphene <- setdiff(top6_real_20_Clomiphene_means, top6_predicted_20_Clomiphene_means)
top_species_wrong_20_Clomiphene <- setdiff(top6_predicted_20_Clomiphene_means, top6_real_20_Clomiphene_means)

top_species_missing_20_Clomiphene <- if(length(top_species_missing_20_Clomiphene) == 0) "None" else top_species_missing_20_Clomiphene
top_species_wrong_20_Clomiphene <- if(length(top_species_wrong_20_Clomiphene) == 0) "None" else top_species_wrong_20_Clomiphene

Prediction_quality_20_Clomiphene <- data.frame(
  Top_six_correct = paste(top_six_correct_20_Clomiphene, sep=""),
  Top_six_correct_NULL = paste(top_six_correct_20_Clomiphene_NULL, sep=""),
  Top_six_correct_means = paste(top_six_correct_20_Clomiphene_means, sep=""),
  Top_six_correct_means_NULL = paste(top_six_correct_20_Clomiphene_means_NULL, sep=""),
  Predicted_magnitude_correct = paste(round(predicted_magnitude_correct_fraction_20_Clomiphene * 100, 2), "%", sep=""),
  Predicted_magnitude_correct_NULL = paste(round(predicted_magnitude_correct_fraction_20_Clomiphene_NULL * 100, 2), "%", sep=""),
  survivors_total = survivors_20_Clomiphene,
  top_species_missing <- top_species_missing_20_Clomiphene,
  top_species_wrong <- top_species_wrong_20_Clomiphene, 
  predicted_mean_final_OD <- predicted_mean_final_od_20_Clomiphene,
  real_mean_final_OD <- real_mean_final_od_20_Clomiphene,
  sims_total = length(successful_sim_ids)
)

Prediction_quality_20_Clomiphene






##Next, for 80 uM:
# Get top 6 species from plot_data_80_endpoint
# Adjust the plot_data_80_endpoint with confidence bounds
plot_data_80_Clomiphene_endpoint <- plot_data_80_Clomiphene_endpoint %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)

# Adjust the Clomiphene_16S_80uM_summarised with confidence bounds
Clomiphene_16S_80uM_summarised <- Clomiphene_16S_80uM_summarised %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)

#NULL model:
Null_model_summarised <- Niclosamide_16S_0uM_summarised %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)


# Get top 6 species based on the lower bound from plot_data_80_endpoint
top6_predicted_80_Clomiphene <- plot_data_80_Clomiphene_endpoint %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

# Get top 6 species based on the lower bound from Clomiphene_16S_80uM_summarised
top6_real_80_Clomiphene <- Clomiphene_16S_80uM_summarised %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

top6_NULL <- Null_model_summarised %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

# Calculate the overlap of top 6 species
top_six_correct_80_Clomiphene <- length(intersect(top6_predicted_80_Clomiphene, top6_real_80_Clomiphene))
#top_six_correct_80_Clomiphene

top_six_correct_80_Clomiphene_NULL <- length(intersect(top6_NULL, top6_real_80_Clomiphene))
#top_six_correct_80_Clomiphene_NULL

#top6_predicted_80_Clomiphene
#top6_real_80_Clomiphene




#Now by means:
top6_predicted_80_Clomiphene_means <- plot_data_80_Clomiphene_endpoint %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)

# Get top 6 species based on the lower bound from Clomiphene_16S_80uM_summarised
top6_real_80_Clomiphene_means <- Clomiphene_16S_80uM_summarised %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)

top6_NULL_means <- Null_model_summarised %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)



top_six_correct_80_Clomiphene_means <- length(intersect(top6_predicted_80_Clomiphene_means, top6_real_80_Clomiphene_means))
#top_six_correct_80_Clomiphene_means

top_six_correct_80_Clomiphene_means_NULL <- length(intersect(top6_NULL_means, top6_real_80_Clomiphene_means))
#top_six_correct_80_Clomiphene_means_NULL

#top6_predicted_80_Clomiphene_means
#top6_real_80_Clomiphene_means




# Merge dataframes by Species
merged_data_80_Clomiphene <- merge(plot_data_80_Clomiphene_endpoint, Clomiphene_16S_80uM_summarised, by = "Species", suffixes = c(".pred", ".real"))
merged_data_80_Clomiphene_NULL <- merge(Niclosamide_16S_0uM_summarised, Clomiphene_16S_80uM_summarised, by = "Species", suffixes = c(".null", ".real"))



# Create lower and upper bounds considering mean ¬± sd
merged_data_80_Clomiphene$lower_bound_pred <- merged_data_80_Clomiphene$mean_rel_ab.pred - merged_data_80_Clomiphene$sd_rel_ab.pred
merged_data_80_Clomiphene$upper_bound_pred <- merged_data_80_Clomiphene$mean_rel_ab.pred + merged_data_80_Clomiphene$sd_rel_ab.pred
merged_data_80_Clomiphene$lower_bound_real <- merged_data_80_Clomiphene$mean_rel_ab.real - merged_data_80_Clomiphene$sd_rel_ab.real
merged_data_80_Clomiphene$upper_bound_real <- merged_data_80_Clomiphene$mean_rel_ab.real + merged_data_80_Clomiphene$sd_rel_ab.real

# Ensure lower and upper bounds are non-negative, adjusting as necessary
merged_data_80_Clomiphene$lower_bound_pred[merged_data_80_Clomiphene$lower_bound_pred <= 0] <- 1e-10
merged_data_80_Clomiphene$lower_bound_real[merged_data_80_Clomiphene$lower_bound_real <= 0] <- 1e-10
merged_data_80_Clomiphene$upper_bound_pred[merged_data_80_Clomiphene$upper_bound_pred <= 0] <- 1e-10
merged_data_80_Clomiphene$upper_bound_real[merged_data_80_Clomiphene$upper_bound_real <= 0] <- 1e-10

##and for NULL model:
# Create lower and upper bounds considering mean ¬± sd
merged_data_80_Clomiphene_NULL$lower_bound_null <- merged_data_80_Clomiphene_NULL$mean_rel_ab.null - merged_data_80_Clomiphene_NULL$sd_rel_ab.null
merged_data_80_Clomiphene_NULL$upper_bound_null <- merged_data_80_Clomiphene_NULL$mean_rel_ab.null + merged_data_80_Clomiphene_NULL$sd_rel_ab.null
merged_data_80_Clomiphene_NULL$lower_bound_real <- merged_data_80_Clomiphene_NULL$mean_rel_ab.real - merged_data_80_Clomiphene_NULL$sd_rel_ab.real
merged_data_80_Clomiphene_NULL$upper_bound_real <- merged_data_80_Clomiphene_NULL$mean_rel_ab.real + merged_data_80_Clomiphene_NULL$sd_rel_ab.real

# Ensure lower and upper bounds are non-negative, adjusting as necessary
merged_data_80_Clomiphene_NULL$lower_bound_null[merged_data_80_Clomiphene_NULL$lower_bound_null <= 0] <- 1e-10
merged_data_80_Clomiphene_NULL$lower_bound_real[merged_data_80_Clomiphene_NULL$lower_bound_real <= 0] <- 1e-10
merged_data_80_Clomiphene_NULL$upper_bound_null[merged_data_80_Clomiphene_NULL$upper_bound_null <= 0] <- 1e-10
merged_data_80_Clomiphene_NULL$upper_bound_real[merged_data_80_Clomiphene_NULL$upper_bound_real <= 0] <- 1e-10

# Filter to include only species with a mean relative abundance > 0.01 in the 'real' dataset
significant_species <- merged_data_80_Clomiphene[merged_data_80_Clomiphene$mean_rel_ab.real > 0.01, ]
survivors_80_Clomiphene <- nrow(significant_species)
survivors_80_Clomiphene

#should be the same as survivors defined above, since it is calculated from .real
significant_species_NULL <- merged_data_80_Clomiphene_NULL[merged_data_80_Clomiphene_NULL$mean_rel_ab.real > 0.01, ]
survivors_80_Clomiphene_NULL <- nrow(significant_species_NULL)
survivors_80_Clomiphene_NULL

# Adjusted order of magnitude check to include SD, only for significant species
significant_species$Predicted_magnitude_correct <- ifelse(
  (floor(log10(significant_species$lower_bound_pred)) <= floor(log10(significant_species$upper_bound_real)) &
     floor(log10(significant_species$upper_bound_pred)) >= floor(log10(significant_species$lower_bound_real))),
  1,
  0
)

#and for the Null model:
significant_species_NULL$Predicted_magnitude_correct <- ifelse(
  (floor(log10(significant_species_NULL$lower_bound_null)) <= floor(log10(significant_species_NULL$upper_bound_real)) &
     floor(log10(significant_species_NULL$upper_bound_null)) >= floor(log10(significant_species_NULL$lower_bound_real))),
  1,
  0
)

# Calculate the fraction of correctly predicted magnitudes for significant species
predicted_magnitude_correct_fraction_80_Clomiphene <- sum(significant_species$Predicted_magnitude_correct) / nrow(significant_species)
predicted_magnitude_correct_fraction_80_Clomiphene

predicted_magnitude_correct_fraction_80_Clomiphene_NULL <- sum(significant_species_NULL$Predicted_magnitude_correct) / nrow(significant_species_NULL)
predicted_magnitude_correct_fraction_80_Clomiphene_NULL


top_species_missing_80_Clomiphene <- setdiff(top6_real_80_Clomiphene_means, top6_predicted_80_Clomiphene_means)
top_species_wrong_80_Clomiphene <- setdiff(top6_predicted_80_Clomiphene_means, top6_real_80_Clomiphene_means)

Prediction_quality_80_Clomiphene <- data.frame(
  Top_six_correct = paste(top_six_correct_80_Clomiphene, sep=""),
  Top_six_correct_NULL = paste(top_six_correct_80_Clomiphene_NULL, sep=""),
  Top_six_correct_means = paste(top_six_correct_80_Clomiphene_means, sep=""),
  Top_six_correct_means_NULL = paste(top_six_correct_80_Clomiphene_means_NULL, sep=""),
  Predicted_magnitude_correct = paste(round(predicted_magnitude_correct_fraction_80_Clomiphene * 100, 2), "%", sep=""),
  Predicted_magnitude_correct_NULL = paste(round(predicted_magnitude_correct_fraction_80_Clomiphene_NULL * 100, 2), "%", sep=""),
  survivors_total = survivors_80_Clomiphene,
  top_species_missing <- top_species_missing_80_Clomiphene,
  top_species_wrong <- top_species_wrong_80_Clomiphene, 
  predicted_mean_final_OD <- predicted_mean_final_od_80_Clomiphene,
  real_mean_final_OD <- real_mean_final_od_80_Clomiphene,
  sims_total = length(successful_sim_ids)
)

Prediction_quality_80_Clomiphene










##Diacerein

combined_monoculture_aucs2_Diacerein <- subset(combined_monoculture_aucs2, drug == "Diacerein")


#drug sensitivity terms: define once outside of ODEs
y_function_B_vulgatus_Diacerein <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("B_vulgatus", "Diacerein", best_fitting_models_df_Diacerein)), collapse = " ")))
y_function_B_uniformis_Diacerein <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("B_uniformis", "Diacerein", best_fitting_models_df_Diacerein)), collapse = " ")))
y_function_B_fragilis_Diacerein <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("B_fragilis", "Diacerein", best_fitting_models_df_Diacerein)), collapse = " ")))
y_function_B_thetaiotaomicron_Diacerein <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("B_thetaiotaomicron", "Diacerein", best_fitting_models_df_Diacerein)), collapse = " ")))
y_function_C_ramosum_Diacerein <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("C_ramosum", "Diacerein", best_fitting_models_df_Diacerein)), collapse = " ")))
y_function_E_rectale_Diacerein <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("E_rectale", "Diacerein", best_fitting_models_df_Diacerein)), collapse = " ")))
y_function_R_intestinalis_Diacerein <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("R_intestinalis", "Diacerein", best_fitting_models_df_Diacerein)), collapse = " ")))
y_function_V_parvula_Diacerein <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("V_parvula", "Diacerein", best_fitting_models_df_Diacerein)), collapse = " ")))
y_function_E_lenta_Diacerein <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("E_lenta", "Diacerein", best_fitting_models_df_Diacerein)), collapse = " ")))
y_function_F_nucleatum_Diacerein <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("F_nucleatum", "Diacerein", best_fitting_models_df_Diacerein)), collapse = " ")))
y_function_C_bolteae_Diacerein <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("C_bolteae", "Diacerein", best_fitting_models_df_Diacerein)), collapse = " ")))
y_function_C_perfringens_Diacerein <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("C_perfringens", "Diacerein", best_fitting_models_df_Diacerein)), collapse = " ")))
y_function_C_saccharolyticum_Diacerein <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("C_saccharolyticum", "Diacerein", best_fitting_models_df_Diacerein)), collapse = " ")))
y_function_S_salivarius_Diacerein <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("S_salivarius", "Diacerein", best_fitting_models_df_Diacerein)), collapse = " ")))
y_function_R_gnavus_Diacerein <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("R_gnavus", "Diacerein", best_fitting_models_df_Diacerein)), collapse = " ")))
y_function_C_comes_Diacerein <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("C_comes", "Diacerein", best_fitting_models_df_Diacerein)), collapse = " ")))
y_function_P_merdae_Diacerein <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("P_merdae", "Diacerein", best_fitting_models_df_Diacerein)), collapse = " ")))
y_function_S_parasanguinis_Diacerein <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("S_parasanguinis", "Diacerein", best_fitting_models_df_Diacerein)), collapse = " ")))
y_function_C_aerofaciens_Diacerein <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("C_aerofaciens", "Diacerein", best_fitting_models_df_Diacerein)), collapse = " ")))
y_function_D_formicigenerans_Diacerein <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("D_formicigenerans", "Diacerein", best_fitting_models_df_Diacerein)), collapse = " ")))
y_function_E_coli_Diacerein <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("E_coli", "Diacerein", best_fitting_models_df_Diacerein)), collapse = " ")))



y_function_B_vulgatus_Diacerein_func <- eval(parse(text = paste("function(Drug) {", y_function_B_vulgatus_Diacerein, "}")))
y_function_B_uniformis_Diacerein_func <- eval(parse(text = paste("function(Drug) {", y_function_B_uniformis_Diacerein, "}")))
y_function_B_fragilis_Diacerein_func <- eval(parse(text = paste("function(Drug) {", y_function_B_fragilis_Diacerein, "}")))
y_function_B_thetaiotaomicron_Diacerein_func <- eval(parse(text = paste("function(Drug) {", y_function_B_thetaiotaomicron_Diacerein, "}")))
y_function_C_ramosum_Diacerein_func <- eval(parse(text = paste("function(Drug) {", y_function_C_ramosum_Diacerein, "}")))
y_function_E_rectale_Diacerein_func <- eval(parse(text = paste("function(Drug) {", y_function_E_rectale_Diacerein, "}")))
y_function_R_intestinalis_Diacerein_func <- eval(parse(text = paste("function(Drug) {", y_function_R_intestinalis_Diacerein, "}")))
y_function_E_lenta_Diacerein_func <- eval(parse(text = paste("function(Drug) {", y_function_E_lenta_Diacerein, "}")))
y_function_F_nucleatum_Diacerein_func <- eval(parse(text = paste("function(Drug) {", y_function_F_nucleatum_Diacerein, "}")))
y_function_C_bolteae_Diacerein_func <- eval(parse(text = paste("function(Drug) {", y_function_C_bolteae_Diacerein, "}")))
y_function_C_perfringens_Diacerein_func <- eval(parse(text = paste("function(Drug) {", y_function_C_perfringens_Diacerein, "}")))
y_function_C_saccharolyticum_Diacerein_func <- eval(parse(text = paste("function(Drug) {", y_function_C_saccharolyticum_Diacerein, "}")))
y_function_S_salivarius_Diacerein_func <- eval(parse(text = paste("function(Drug) {", y_function_S_salivarius_Diacerein, "}")))
y_function_R_gnavus_Diacerein_func <- eval(parse(text = paste("function(Drug) {", y_function_R_gnavus_Diacerein, "}")))
y_function_C_comes_Diacerein_func <- eval(parse(text = paste("function(Drug) {", y_function_C_comes_Diacerein, "}")))
y_function_P_merdae_Diacerein_func <- eval(parse(text = paste("function(Drug) {", y_function_P_merdae_Diacerein, "}")))
y_function_S_parasanguinis_Diacerein_func <- eval(parse(text = paste("function(Drug) {", y_function_S_parasanguinis_Diacerein, "}")))
y_function_C_aerofaciens_Diacerein_func <- eval(parse(text = paste("function(Drug) {", y_function_C_aerofaciens_Diacerein, "}")))
y_function_D_formicigenerans_Diacerein_func <- eval(parse(text = paste("function(Drug) {", y_function_D_formicigenerans_Diacerein, "}")))
y_function_E_coli_Diacerein_func <- eval(parse(text = paste("function(Drug) {", y_function_E_coli_Diacerein, "}")))
y_function_V_parvula_Diacerein_func <- eval(parse(text = paste("function(Drug) {", y_function_V_parvula_Diacerein, "}")))



unique(combined_monoculture_aucs2_Diacerein$conc)
##dictate drug concentration tested for simulation cycle here:
#drug_concentration_tested <- 20 #if manually or:
drug_concentration_tested <- unique(combined_monoculture_aucs2_Diacerein$conc)[1] 
initial_conditions <- rep(0.01/32, 32)
initial_conditions <- c(initial_conditions, drug_concentration_tested)


##drug effect fitted for species showing sensitivity in monoculture:
#unique(combined_monoculture_aucs2_Diacerein$Species)

##for more simple linear fits
closed.sir.model_Diacerein <- function (t, x, params) {
  ## first extract the state variables
  A_muciniphila <- x[1]
  B_adolescentis <- x[2]
  B_fragilis <- x[3]
  B_longum <- x[4]
  B_obeum <- x[5]
  B_thetaiotaomicron <- x[6]
  B_uniformis <- x[7]
  B_vulgatus <- x[8]
  B_wadsworthia <- x[9]
  C_aerofaciens <- x[10]
  C_bolteae <- x[11]
  C_comes <- x[12]
  C_perfringens <- x[13]
  C_ramosum <- x[14]
  C_saccharolyticum <- x[15]
  D_formicigenerans <- x[16]
  E_coli <- x[17]
  E_lenta <- x[18]
  E_rectale <- x[19]
  F_nucleatum <- x[20]
  L_paracasei <- x[21]
  O_splanchnicus <- x[22]
  P_copri <- x[23]
  P_distasonis <- x[24]
  P_merdae <- x[25]
  R_bromii <- x[26]
  R_gnavus <- x[27]
  R_intestinalis <- x[28]
  R_torques <- x[29]
  S_parasanguinis <- x[30]
  S_salivarius <- x[31]
  V_parvula <- x[32]
  Drug <- x[33]
  
  
  ## now extract the parameters
  r_B_fragilis <- flat_params[["B._fragilis.r"]]
  K_B_fragilis <- flat_params[["B._fragilis.K"]]
  r_B_longum <- flat_params[["B._longum.r"]]
  K_B_longum <- flat_params[["B._longum.K"]]
  r_B_thetaiotaomicron <- flat_params[["B._thetaiotaomicron.r"]]
  K_B_thetaiotaomicron <- flat_params[["B._thetaiotaomicron.K"]]
  r_B_uniformis <- flat_params[["B._uniformis.r"]]
  K_B_uniformis <- flat_params[["B._uniformis.K"]]
  r_B_vulgatus <- flat_params[["B._vulgatus.r"]]
  K_B_vulgatus <- flat_params[["B._vulgatus.K"]]
  r_B_wadsworthia <- flat_params[["B._wadsworthia.r"]]
  K_B_wadsworthia <- flat_params[["B._wadsworthia.K"]]
  r_C_aerofaciens <- flat_params[["C._aerofaciens.r"]]
  K_C_aerofaciens <- flat_params[["C._aerofaciens.K"]]
  r_C_bolteae <- flat_params[["C._bolteae.r"]]
  K_C_bolteae <- flat_params[["C._bolteae.K"]]
  r_C_comes <- flat_params[["C._comes.r"]]
  K_C_comes <- flat_params[["C._comes.K"]]
  r_C_perfringens <- flat_params[["C._perfringens.r"]]
  K_C_perfringens <- flat_params[["C._perfringens.K"]]
  r_C_ramosum <- flat_params[["C._ramosum.r"]]
  K_C_ramosum <- flat_params[["C._ramosum.K"]]
  r_C_saccharolyticum <- flat_params[["C._saccharolyticum.r"]]
  K_C_saccharolyticum <- flat_params[["C._saccharolyticum.K"]]
  r_D_formicigenerans <- flat_params[["D._formicigenerans.r"]]
  K_D_formicigenerans <- flat_params[["D._formicigenerans.K"]]
  r_E_coli <- flat_params[["E._coli.r"]]
  K_E_coli <- flat_params[["E._coli.K"]]
  r_E_lenta <- flat_params[["E._lenta.r"]]
  K_E_lenta <- flat_params[["E._lenta.K"]]
  r_E_rectale <- flat_params[["E._rectale.r"]]
  K_E_rectale <- flat_params[["E._rectale.K"]]
  r_F_nucleatum <- flat_params[["F._nucleatum.r"]]
  K_F_nucleatum <- flat_params[["F._nucleatum.K"]]
  r_P_copri <- flat_params[["P._copri.r"]]
  K_P_copri <- flat_params[["P._copri.K"]]
  r_P_merdae <- flat_params[["P._merdae.r"]]
  K_P_merdae <- flat_params[["P._merdae.K"]]
  r_R_gnavus <- flat_params[["R._gnavus.r"]]
  K_R_gnavus <- flat_params[["R._gnavus.K"]]
  r_R_intestinalis <- flat_params[["R._intestinalis.r"]]
  K_R_intestinalis <- flat_params[["R._intestinalis.K"]]
  r_V_parvula <- flat_params[["V._parvula.r"]]
  K_V_parvula <- flat_params[["V._parvula.K"]]
  r_A_muciniphila <- flat_params[["A._muciniphila.r"]]
  K_A_muciniphila <- flat_params[["A._muciniphila.K"]]
  r_B_adolescentis <- flat_params[["B._adolescentis.r"]]
  K_B_adolescentis <- flat_params[["B._adolescentis.K"]]
  r_B_obeum <- flat_params[["B._obeum.r"]]
  K_B_obeum <- flat_params[["B._obeum.K"]]
  r_O_splanchnicus <- flat_params[["O._splanchnicus.r"]]
  K_O_splanchnicus <- flat_params[["O._splanchnicus.K"]]
  r_P_distasonis <- flat_params[["P._distasonis.r"]]
  K_P_distasonis <- flat_params[["P._distasonis.K"]]
  r_R_bromii <- flat_params[["R._bromii.r"]]
  K_R_bromii <- flat_params[["R._bromii.K"]]
  r_R_torques <- flat_params[["R._torques.r"]]
  K_R_torques <- flat_params[["R._torques.K"]]
  r_S_parasanguinis <- flat_params[["S._parasanguinis.r"]]
  K_S_parasanguinis <-flat_params[["S._parasanguinis.K"]]
  r_S_salivarius <- flat_params[["S._salivarius.r"]]
  K_S_salivarius <- flat_params[["S._salivarius.K"]]
  r_L_paracasei <- flat_params[["L._paracasei.r"]]
  K_L_paracasei <- flat_params[["L._paracasei.K"]]
  
  
  t_mod <- ifelse(t > 24.1, t - 24.1, t)
  
  
  ## now code the model equations
  dA_muciniphila_dt <- r_A_muciniphila * A_muciniphila * (1 - A_muciniphila / K_A_muciniphila)
  dB_adolescentis_dt <- r_B_adolescentis * B_adolescentis * (1 - B_adolescentis / K_B_adolescentis)
  dB_fragilis_dt <- r_B_fragilis * B_fragilis * (1 - B_fragilis / max(0.0001, K_B_fragilis * (y_function_B_fragilis_Diacerein_func(Drug))))
  dB_longum_dt <- r_B_longum * B_longum * (1 - B_longum / K_B_longum)
  dB_obeum_dt <- r_B_obeum * B_obeum * (1 - B_obeum / K_B_obeum)
  dB_thetaiotaomicron_dt <- r_B_thetaiotaomicron * B_thetaiotaomicron * (1 - B_thetaiotaomicron / max(0.0001, K_B_thetaiotaomicron * (y_function_B_thetaiotaomicron_Diacerein_func(Drug))))  
  dB_uniformis_dt <- r_B_uniformis * B_uniformis * (1 - B_uniformis / max(0.0001, K_B_uniformis * (y_function_B_uniformis_Diacerein_func(Drug))))
  dB_vulgatus_dt <- r_B_vulgatus * B_vulgatus * (1 - B_vulgatus / max(0.0001, K_B_vulgatus * (y_function_B_vulgatus_Diacerein_func(Drug))))
  dB_wadsworthia_dt <- r_B_wadsworthia * B_wadsworthia * (1 - B_wadsworthia / K_B_wadsworthia)
  dC_aerofaciens_dt <- r_C_aerofaciens * C_aerofaciens * (1 - C_aerofaciens / max(0.0001, K_C_aerofaciens * (y_function_C_aerofaciens_Diacerein_func(Drug))))
  dC_bolteae_dt <- r_C_bolteae * C_bolteae * (1 - C_bolteae /  max(0.0001, K_C_bolteae * (y_function_C_bolteae_Diacerein_func(Drug))))
  dC_comes_dt <- r_C_comes * C_comes * (1 - C_comes / max(0.0001, K_C_comes * (y_function_C_comes_Diacerein_func(Drug))))
  dC_perfringens_dt <- r_C_perfringens * C_perfringens * (1 - C_perfringens / max(0.0001, K_C_perfringens * (y_function_C_perfringens_Diacerein_func(Drug))))
  dC_ramosum_dt <- r_C_ramosum * C_ramosum * (1 - C_ramosum / max(0.0001, K_C_ramosum * (y_function_C_ramosum_Diacerein_func(Drug))))
  dC_saccharolyticum_dt <- r_C_saccharolyticum * C_saccharolyticum * (1 - C_saccharolyticum / max(0.0001, K_C_saccharolyticum * (y_function_C_saccharolyticum_Diacerein_func(Drug))))
  dD_formicigenerans_dt <- r_D_formicigenerans * D_formicigenerans * (1 - D_formicigenerans / max(0.0001, K_D_formicigenerans * (y_function_D_formicigenerans_Diacerein_func(Drug))))
  dE_coli_dt <- r_E_coli * E_coli * (1 - E_coli / max(0.0001, K_E_coli * (y_function_E_coli_Diacerein_func(Drug))))
  dE_lenta_dt <- r_E_lenta * E_lenta * (1 - E_lenta / max(0.0001, K_E_lenta * (y_function_E_lenta_Diacerein_func(Drug))))
  dE_rectale_dt <- r_E_rectale * E_rectale * (1 - E_rectale / max(0.0001, K_E_rectale * (y_function_E_rectale_Diacerein_func(Drug))))
  dF_nucleatum_dt <- r_F_nucleatum * F_nucleatum * (1 - F_nucleatum / max(0.0001, K_F_nucleatum * (y_function_F_nucleatum_Diacerein_func(Drug))))
  dL_paracasei_dt <- r_L_paracasei * L_paracasei * (1 - L_paracasei / K_L_paracasei)  
  dO_splanchnicus_dt <- r_O_splanchnicus * O_splanchnicus * (1 - O_splanchnicus / K_O_splanchnicus)  
  dP_copri_dt <- r_P_copri * P_copri * (1 - P_copri / K_P_copri)
  dP_distasonis_dt <- r_P_distasonis * P_distasonis * (1 - P_distasonis / K_P_distasonis)  
  dP_merdae_dt <- r_P_merdae * P_merdae * (1 - P_merdae / max(0.0001, K_P_merdae * (y_function_P_merdae_Diacerein_func(Drug))))
  dR_bromii_dt <- r_R_bromii * R_bromii * (1 - R_bromii / K_R_bromii) 
  dR_gnavus_dt <- r_R_gnavus * R_gnavus * (1 - R_gnavus / max(0.0001, K_R_gnavus * (y_function_R_gnavus_Diacerein_func(Drug))))
  dR_intestinalis_dt <- r_R_intestinalis * R_intestinalis * (1 - R_intestinalis / max(0.0001, K_R_intestinalis * (y_function_R_intestinalis_Diacerein_func(Drug))))
  dR_torques_dt <- r_R_torques * R_torques * (1 - R_torques /K_R_torques) 
  dS_parasanguinis_dt <- r_S_parasanguinis * S_parasanguinis * (1 - S_parasanguinis / max(0.0001, K_S_parasanguinis * (y_function_S_parasanguinis_Diacerein_func(Drug))))
  dS_salivarius_dt <- r_S_salivarius * S_salivarius * (1 - S_salivarius / max(0.0001, K_S_salivarius * (y_function_S_salivarius_Diacerein_func(Drug))))
  dV_parvula_dt <- r_V_parvula * V_parvula * (1 - V_parvula / max(0.0001, K_V_parvula * (y_function_V_parvula_Diacerein_func(Drug))))
  
  
  
  #Drug differential (no metabolomics for this drug):
  dDrug_dt <- (mean(drug_dynamics$Steepness_param_community) * exp(-mean(drug_dynamics$Steepness_param_community) * t_mod)) * (drug_concentration_tested * prop_left_Diacerein - drug_concentration_tested)
  #dDrug_dt <- 0
  
  ## Combine results into a single vector
  dxdt <- c(dA_muciniphila_dt, dB_adolescentis_dt, dB_fragilis_dt, dB_longum_dt, dB_obeum_dt, dB_thetaiotaomicron_dt, dB_uniformis_dt, dB_vulgatus_dt, dB_wadsworthia_dt, dC_aerofaciens_dt, dC_bolteae_dt, dC_comes_dt, dC_perfringens_dt, dC_ramosum_dt, dC_saccharolyticum_dt, dD_formicigenerans_dt, dE_coli_dt, dE_lenta_dt, dE_rectale_dt, dF_nucleatum_dt, dL_paracasei_dt, dO_splanchnicus_dt, dP_copri_dt, dP_distasonis_dt, dP_merdae_dt, dR_bromii_dt, dR_gnavus_dt, dR_intestinalis_dt, dR_torques_dt, dS_parasanguinis_dt, dS_salivarius_dt, dV_parvula_dt, dDrug_dt)
  
  ## Return result as a list
  list(dxdt)
}




#calculate the co-culture correction factor per species based on community composition in absence of drug, just like done for Niclosamide

growth_data_all_0_Niclosamide
growth_data_all_0_Niclosamide1 <- growth_data_all_0_Niclosamide %>%
  dplyr::mutate(Species = gsub(" ", "_", Species))


# Merge rel_ab_control with growth_data_all_0_Niclosamide on Species
# Function to remove duplicated columns by name pattern
clean_columns_base <- function(df, pattern) {
  cols_to_keep <- !grepl(pattern, names(df))
  df <- df[, cols_to_keep]
  return(df)
}

# Use the new function to clean up your dataframe
rel_ab_control <- clean_columns_base(rel_ab_control, "mean_max_OD.[xy]")
str(rel_ab_control)


#rel_ab_control$correction_factor <- rel_ab_control$mean_rel_ab / (rel_ab_control$mean_max_OD/sum(rel_ab_control$mean_max_OD))
# Calculate correction factor with a minimum value of ~1
rel_ab_control$correction_factor <- pmax(rel_ab_control$mean_rel_ab / (rel_ab_control$mean_max_OD / sum(rel_ab_control$mean_max_OD)), 1.1)


# Create a new dataframe for co-culture correction
co_culture_correction <- data.frame(
  species = rel_ab_control$Species,
  correction_factor = rel_ab_control$correction_factor
)


#summarise community data
#Adjust based on tested concentrations for each drug
unique(Community_compositions_focus_drugs_Diacerein$concentration)

Community_compositions_focus_drugs_Diacerein_320uM <- subset(Community_compositions_focus_drugs_Diacerein, concentration == 320)
Community_compositions_focus_drugs_Diacerein_20uM <- subset(Community_compositions_focus_drugs_Diacerein, concentration == 20)
Community_compositions_focus_drugs_Diacerein_80uM <- subset(Community_compositions_focus_drugs_Diacerein, concentration == 80)


#320 uM
Community_compositions_focus_drugs_Diacerein_320uM_summarised <- Community_compositions_focus_drugs_Diacerein_320uM %>%
  dplyr::group_by(species) %>%                                  
  dplyr::summarize(
    mean_rel_ab = mean(rel_abundance, na.rm = TRUE),     
    sd_rel_ab = sd(rel_abundance, na.rm = TRUE) ,
    mean_max_OD = mean(maxOD, na.rm = TRUE),
    sd_max_OD = sd(maxOD, na.rm = TRUE),
    mean_final_OD = mean(finalOD, na.rm = TRUE),
    sd_final_OD = sd(finalOD, na.rm = TRUE)
  ) %>%
  dplyr::ungroup() 


Community_compositions_focus_drugs_Diacerein_320uM_summarised <- Community_compositions_focus_drugs_Diacerein_320uM_summarised %>%
  dplyr::mutate(Species = sub("^(\\w)\\w*\\s(.*)", "\\1._\\2", species))

#remove (sub)strain info
Community_compositions_focus_drugs_Diacerein_320uM_summarised <- Community_compositions_focus_drugs_Diacerein_320uM_summarised %>%
  dplyr::mutate(Species = sub("^(\\w\\._\\w+).*", "\\1", Species))


#20 uM
Community_compositions_focus_drugs_Diacerein_20uM_summarised <- Community_compositions_focus_drugs_Diacerein_20uM %>%
  dplyr::group_by(species) %>%                                  
  dplyr::summarize(
    mean_rel_ab = mean(rel_abundance, na.rm = TRUE),     
    sd_rel_ab = sd(rel_abundance, na.rm = TRUE) ,
    mean_max_OD = mean(maxOD, na.rm = TRUE),
    sd_max_OD = sd(maxOD, na.rm = TRUE),
    mean_final_OD = mean(finalOD, na.rm = TRUE),
    sd_final_OD = sd(finalOD, na.rm = TRUE)
  ) %>%
  dplyr::ungroup() 


Community_compositions_focus_drugs_Diacerein_20uM_summarised <- Community_compositions_focus_drugs_Diacerein_20uM_summarised %>%
  dplyr::mutate(Species = sub("^(\\w)\\w*\\s(.*)", "\\1._\\2", species))

#remove (sub)strain info
Community_compositions_focus_drugs_Diacerein_20uM_summarised <- Community_compositions_focus_drugs_Diacerein_20uM_summarised %>%
  dplyr::mutate(Species = sub("^(\\w\\._\\w+).*", "\\1", Species))


#80 uM
Community_compositions_focus_drugs_Diacerein_80uM_summarised <- Community_compositions_focus_drugs_Diacerein_80uM %>%
  dplyr::group_by(species) %>%                                  
  dplyr::summarize(
    mean_rel_ab = mean(rel_abundance, na.rm = TRUE),     
    sd_rel_ab = sd(rel_abundance, na.rm = TRUE) ,
    mean_max_OD = mean(maxOD, na.rm = TRUE),
    sd_max_OD = sd(maxOD, na.rm = TRUE),    
    mean_final_OD = mean(finalOD, na.rm = TRUE),
    sd_final_OD = sd(finalOD, na.rm = TRUE)
  ) %>%
  dplyr::ungroup() 



Community_compositions_focus_drugs_Diacerein_80uM_summarised <- Community_compositions_focus_drugs_Diacerein_80uM_summarised %>%
  dplyr::mutate(Species = sub("^(\\w)\\w*\\s(.*)", "\\1._\\2", species))

#remove (sub)strain info
Community_compositions_focus_drugs_Diacerein_80uM_summarised <- Community_compositions_focus_drugs_Diacerein_80uM_summarised %>%
  dplyr::mutate(Species = sub("^(\\w\\._\\w+).*", "\\1", Species))


#Initialise data frames
sim_output <- data.frame()
input_params_list <- list() #Use a list to collect parameters for each simulation

#number of simulations
num_sims <- 500


for (i in 1:num_sims) {
  tryCatch({
    # generate model parameters
    set.seed(i) #set a different seed for each simulation for variation
    params <- lapply(1:nrow(growth_data_all_0_Niclosamide), function(idx) {
      species_params <- growth_data_all_0_Niclosamide[idx, ]
      list(
        r = rnorm(1, mean = species_params$mean_max_Growth_rate, sd = species_params$sd_max_Growth_rate),
        K = rnorm(1, mean = species_params$mean_max_OD, sd = species_params$sd_max_OD)
      )
    })
    names(params) <- gsub(" ", "_", growth_data_all_0_Niclosamide$Species)
    flat_params <- unlist(params)
    names(flat_params) <- gsub("\\.\\d$", "", names(flat_params))
    
    #replace spaces with underscores to match formatting
    co_culture_correction$species <- gsub(" ", "_", co_culture_correction$species, fixed = TRUE)
    
    #replace the species-specific K parameters extracted from monoculture growth data 
    #with drawn relative abundance values at Niclosamide = 0, scaled to K
    rel_ab_control$Species <- gsub(" ", "_", rel_ab_control$Species)
    
    #Initialise an empty vector to store drawn values
    drawn_values <- numeric(nrow(rel_ab_control))
    
    #draw values from their respective distributions
    for (k in 1:nrow(rel_ab_control)) {
      species_name <- rel_ab_control$Species[k]
      drawn_value <- rnorm(1, mean = rel_ab_control$mean_rel_ab[k], sd = rel_ab_control$sd_rel_ab[k])
      drawn_values[k] <- max(drawn_value, 0)  # Ensure no negative values
    }
    
    #Normalise drawn relative abundance values so they sum to 1 (to reflect a 'true' relative abundance distribution)
    #this is needed so when we convert the values into OD units by multiplying with the drawn community maxOD,
    # the sum of K_i parameters and the drawn K are equal
    normalised_values <- drawn_values / sum(drawn_values)
    
    #Pull community maxOD (K) at 0 drugs from respective normal distribution:
    K <- rnorm(n = 1, mean = rel_ab_control$mean_com_max_OD[1], sd = rel_ab_control$sd_com_max_OD[1])
    
    # Assign these normalised values to their respective species' .K parameters
    for (k in 1:nrow(rel_ab_control)) {
      species_name <- rel_ab_control$Species[k]
      k_index <- grep(paste0("^", species_name, "\\.K$"), names(flat_params))
      
      if (length(k_index) > 0) {
        old_value <- flat_params[k_index]
        flat_params[k_index] <- (normalised_values[k] + 0.0001) * K #add small value in case drawn K_i is 0, which would cause issues with the solver
        cat(sprintf("Updated %s from %f to %f using normalised value %f scaled by K %f\n", names(flat_params)[k_index], old_value, flat_params[k_index], normalised_values[k], K))
      }
    }
    
    #Accounting for variation in drug degradation by community, with standard deviation of end concentration (at 10h) around the fitted predicted (relative) end concentration at 24h
    #This drug (Diacerein) does not have metabolomics data available.
    #Taking averages of degradation and variability thereof observed across all 27 drugs that did have metabolomics data
    #prop_left_Diacerein <- abs(rnorm(1, mean(drug_dynamics$Prop_left_24h_community), mean(drug_dynamics$SD_drug_community))) 
    prop_left_Diacerein <- runif(1, min(drug_dynamics$Prop_left_24h_community), max(drug_dynamics$Prop_left_24h_community))
    
    #loop through each species in co_culture_correction
    for (j in 1:nrow(co_culture_correction)) {
      # Extract the species name and correction factor
      species_name <- co_culture_correction$species[j]
      correction_factor <- co_culture_correction$correction_factor[j]
      
      # Identify the corresponding growth rate parameter in flat_params
      #by matching the base species name (without .r)
      growth_rate_indices <- grep(paste0("^", species_name, "\\.r$"), names(flat_params))
      
      #take the growth rate parameter and apply the correction factor 
      for (index in growth_rate_indices) {
        flat_params[index] <- flat_params[index] * correction_factor
      }
    }
    
    flat_params
    # Store parameters for each simulation
    input_params_list[[i]] <- c(sim_ID = i, flat_params)
    
    # Run the model for the first 24-hour cycle
    solution_cycle_1 <- ode(y = initial_conditions, times = seq(from = 0, to = 24, by = 0.1), func = closed.sir.model_Diacerein, parms = flat_params,   method = "lsoda", rtol = 1e-6, atol = 1e-6)
    
    # Dilution and second cycle
    end_of_cycle_1 <- solution_cycle_1[nrow(solution_cycle_1), -1]
    initial_conditions_cycle_2 <- end_of_cycle_1 / 50
    #accounting for the drugs being added with the new growth cycle as well:
    initial_conditions_cycle_2[33] <- initial_conditions_cycle_2[33] + drug_concentration_tested
    solution_cycle_2 <- ode(y = initial_conditions_cycle_2, times = seq(from = 24, to = 48, by = 0.1), func = closed.sir.model_Diacerein, parms = flat_params,  method = "lsoda", rtol = 1e-6, atol = 1e-6)
    
    # Combine and format results
    combined_solution <- rbind(as.data.frame(solution_cycle_1), as.data.frame(solution_cycle_2)[-1,])
    combined_solution$sim_ID <- rep(i, nrow(combined_solution))
    combined_solution <- combined_solution %>%
      tidyr::gather(key = "Species", value = "Density", -time, -sim_ID) %>%
      dplyr::mutate(Hour = time) %>%
      dplyr::select(sim_ID, Hour, Species, Density)
    
    ##Append to sim_output
    sim_output <- rbind(sim_output, combined_solution)
  }, error = function(e) {
    cat(sprintf("Skipping simulation %d due to an error: %s\n", i, e$message))
  })
}



##Combine all parameter data into a single dataframe
input_params <- do.call(rbind, input_params_list)

# Add a "Species" column 
sim_output$Species_name <- species_names[as.numeric(as.character(sim_output$Species))]
sim_output$Species_name <- replace_na(sim_output$Species_name, "Drug")

#View(input_params)
#View(sim_output)

sim_output <- na.omit(sim_output)
successful_sim_ids <- unique(subset(sim_output, Hour == 48)$sim_ID)
length(successful_sim_ids)
sim_output1 <- sim_output[sim_output$sim_ID %in% successful_sim_ids, ]


#Transform sim_output so we have wide format by Species
sim_output_wide <- tidyr::pivot_wider(sim_output1, 
                                      names_from = Species_name, 
                                      values_from = Density,
                                      id_cols = c(sim_ID, Hour))

length(unique(sim_output_wide$sim_ID))
#calc community OD per timepoint
sim_output_wide$Total_OD <- rowSums(sim_output_wide[, 3:34], na.rm = TRUE)
#calculate and add relative abundances here as well:
species_columns <- colnames(sim_output_wide)[3:34] 

for (species in species_columns) {
  sim_output_wide[[paste0("rel_", species)]] <- sim_output_wide[[species]] / sim_output_wide$Total_OD
}


#assign sim_output_wide test conditions to dataframe name
drug_tested <- "Diacerein"
variable_name_1 <- paste0("sim_output_wide_", ifelse(drug_concentration_tested == 1e-04, 0, drug_concentration_tested), "_", drug_tested)
assign(variable_name_1, sim_output_wide)

#turn back into long format if interested in plotting relative abundances
cols_needed <- c("sim_ID", "Hour")

sim_output_long <- sim_output_wide %>% 
  dplyr::select(sim_ID, Hour, Drug, starts_with("rel_")) %>% 
  tidyr::pivot_longer(
    cols = c(Drug, starts_with("rel_")),
    names_to = "Species", 
    values_to = "Relative_abundance",
    names_prefix = "rel_",
    names_transform = list(Species = ~ ifelse(.x == "Drug", "Drug", .x))
  ) 

str(sim_output_long)


species_names_1 <- c(
  "A_muciniphila",
  "B_adolescentis",
  "B_fragilis",
  "B_longum",
  "B_obeum",
  "B_thetaiotaomicron",
  "B_uniformis",
  "B_vulgatus",
  "B_wadsworthia",
  "C_aerofaciens",
  "C_bolteae",
  "C_comes",
  "C_perfringens",
  "C_ramosum",
  "C_saccharolyticum",
  "D_formicigenerans",
  "E_coli",
  "E_lenta",
  "E_rectale",
  "F_nucleatum",
  "L_paracasei",
  "O_splanchnicus",
  "P_copri",
  "P_distasonis",
  "P_merdae",
  "R_bromii",
  "R_gnavus",
  "R_intestinalis",
  "R_torques",
  "S_parasanguinis",
  "S_salivarius",
  "V_parvula",
  "Drug"
)

species_colours_1 <- c(
  "A_muciniphila" = "#1f77b4",
  "B_adolescentis" = "#ff7f0e",
  "B_fragilis" = "#2ca02c",
  "B_longum" = "#d62728",
  "B_obeum" = "#9467bd",
  "B_thetaiotaomicron" = "black",
  "B_uniformis" = "#e377c2",
  "B_vulgatus" = "#7f7f7f",
  "B_wadsworthia" = "gold1",
  "C_aerofaciens" = "#aec7e8",
  "C_bolteae" = "#ffbb78",
  "C_comes" = "magenta",
  "C_perfringens" = "#ff9896",
  "C_ramosum" = "#c5b0d5",
  "C_saccharolyticum" = "#c49c94",
  "D_formicigenerans" = "#f7b6d2",
  "E_coli" = "yellow",
  "E_lenta" = "turquoise",
  "E_rectale" = "#393b79",
  "F_nucleatum" = "royalblue2",
  "L_paracasei" = "blue",
  "O_splanchnicus" = "#637939",
  "P_copri" = "cyan",
  "P_distasonis" = "#8c6d31",
  "P_merdae" = "#c7c7c7",
  "R_bromii" = "#e6550d",
  "R_gnavus" = "#e7cb94",
  "R_intestinalis" = "#843c39",
  "R_torques" = "#d6616b",
  "S_parasanguinis" = "orange3",
  "S_salivarius" = "#7b4173",
  "V_parvula" = "#ce6dbd",
  "Drug" = "green"
)



##Plot output for any specific sim:
# ggplot(subset(sim_output, sim_ID == 1 & Species_name != "Drug"), aes(x = Hour, y = Density, group = Species_name, color = Species_name)) +
#   geom_line(size = 1, alpha = 0.7) +
#   scale_color_manual(values = species_colours_1) +
#   labs(title = paste0("Diacerein = ", drug_concentration_tested),
#        x = "Time (hours)",
#        y = "Population Density (OD)",
#        color = "Species") +
#   theme_minimal() +
#   theme(legend.position = "right")
# 
# ggplot(subset(sim_output, sim_ID == 3 & Species_name != "Drug"), aes(x = Hour, y = Density, group = Species_name, color = Species_name)) +
#   geom_line(size = 1, alpha = 0.7) +
#   scale_color_manual(values = species_colours_1) +
#   labs(title = paste0("Diacerein = ", drug_concentration_tested),
#        x = "Time (hours)",
#        y = "Population Density (OD)",
#        color = "Species") +
#   theme_minimal() +
#   theme(legend.position = "right")


ggplot(subset(sim_output_long, sim_ID == 1), aes(x = Hour, y = Relative_abundance, group = Species, color = Species)) +
  geom_line(size = 1, alpha = 0.7) +
  scale_color_manual(values = species_colours_1) +
  labs(title = paste0("Diacerein = ", drug_concentration_tested),
       x = "Time (hours)",
       y = "Relative abundance",
       color = "Species") +
  theme_minimal() +
  theme(legend.position = "right")


ggplot(subset(sim_output_long, sim_ID == 3), aes(x = Hour, y = Relative_abundance, group = Species, color = Species)) +
  geom_line(size = 1, alpha = 0.7) +
  scale_color_manual(values = species_colours_1) +
  labs(title = paste0("Diacerein = ", drug_concentration_tested),
       x = "Time (hours)",
       y = "Relative abundance",
       color = "Species") +
  theme_minimal() +
  theme(legend.position = "right")


#calc mean and standard deviation across sims
sim_stats <- sim_output_long %>%
  dplyr::group_by(Hour, Species) %>%
  dplyr::summarise(
    mean_rel_ab = mean(Relative_abundance),
    sd_rel_ab = sd(Relative_abundance),
    .groups = 'drop'
  )

# Prepare the data for plotting
plot_data <- sim_stats %>%
  dplyr::mutate(Upper = mean_rel_ab + sd_rel_ab, Lower = mean_rel_ab - sd_rel_ab)

ggplot(subset(plot_data, Species != "Drug"), aes(x = Hour, y = mean_rel_ab, group = Species, color = Species)) +
  geom_ribbon(aes(ymin = Lower, ymax = Upper, fill = Species), colour = NA, alpha = 0.2) +  
  geom_line(size = 1, alpha = 0.7) + 
  scale_color_manual(values = species_colours_1) +
  scale_fill_manual(values = species_colours_1) +  
  labs(title = "Mean and SD of Relative Abundance Across Simulations",
       subtitle = paste0("Diacerein = ", drug_concentration_tested),       
       x = "Time (hours)",
       y = "Relative abundance",
       color = "Species",
       fill = "Species") +
  theme_minimal() +
  theme(legend.position = "right")

#log-scaled mean trends
ggplot(plot_data, aes(x = Hour, y = log10(mean_rel_ab + 0.0001), group = Species, color = Species)) +
  geom_line(size = 1, alpha = 0.7) +  # Mean line
  scale_color_manual(values = species_colours_1) +
  scale_fill_manual(values = species_colours_1) +  # Ensure consistent colors for lines and fills
  labs(title = "Mean and SD of Relative Abundance Across Simulations",
       subtitle = paste0("Diacerein = ", drug_concentration_tested),
       x = "Time (hours)",
       y = "Relative abundance",
       color = "Species",
       fill = "Species") +
  theme_minimal() +
  theme(legend.position = "right")




##prediction quality evaluation
drug_tested <- "Diacerein"
variable_name <- paste0("plot_data_", ifelse(drug_concentration_tested == 1e-04, 0, drug_concentration_tested), "_", drug_tested)
assign(variable_name, plot_data)


#extract total OD info:
predicted_mean_final_od_NULL <- Niclosamide_16S_0uM_summarised$mean_com_final_OD[1]
predicted_sd_final_od_NULL <- Niclosamide_16S_0uM_summarised$sd_com_final_OD[1]

predicted_mean_final_od_320_Diacerein <- mean(subset(sim_output_wide_320_Diacerein, Hour == 48)$Total_OD, na.rm = TRUE)
predicted_sd_final_od_320_Diacerein <- sd(subset(sim_output_wide_320_Diacerein, Hour == 48)$Total_OD, na.rm = TRUE)

real_mean_final_od_320_Diacerein <- Community_compositions_focus_drugs_Diacerein_320uM_summarised$mean_final_OD[1]
real_sd_final_od_320_Diacerein <- Community_compositions_focus_drugs_Diacerein_320uM_summarised$sd_final_OD[1]


predicted_mean_final_od_20_Diacerein <- mean(subset(sim_output_wide_20_Diacerein, Hour == 48)$Total_OD, na.rm = TRUE)
predicted_sd_final_od_20_Diacerein <- sd(subset(sim_output_wide_20_Diacerein, Hour == 48)$Total_OD, na.rm = TRUE)

real_mean_final_od_20_Diacerein <- Community_compositions_focus_drugs_Diacerein_20uM_summarised$mean_final_OD[1]
real_sd_final_od_20_Diacerein <- Community_compositions_focus_drugs_Diacerein_20uM_summarised$sd_final_OD[1]


predicted_mean_final_od_80_Diacerein <- mean(subset(sim_output_wide_80_Diacerein, Hour == 48)$Total_OD, na.rm = TRUE)
predicted_sd_final_od_80_Diacerein <- sd(subset(sim_output_wide_80_Diacerein, Hour == 48)$Total_OD, na.rm = TRUE)

real_mean_final_od_80_Diacerein <- Community_compositions_focus_drugs_Diacerein_80uM_summarised$mean_final_OD[1]
real_sd_final_od_80_Diacerein <- Community_compositions_focus_drugs_Diacerein_80uM_summarised$sd_final_OD[1]




#plot_data_0_Diacerein_endpoint was used to test model performance at 0 drugs
#plot_data_0_Diacerein_endpoint <- subset(plot_data_0_Diacerein, Hour == 48 & Species != "Drug")
plot_data_320_Diacerein_endpoint <- subset(plot_data_320_Diacerein, Hour == 48 & Species != "Drug")
plot_data_20_Diacerein_endpoint <- subset(plot_data_20_Diacerein, Hour == 48 & Species != "Drug")
plot_data_80_Diacerein_endpoint <- subset(plot_data_80_Diacerein, Hour == 48 & Species != "Drug")

##Inspecting 'match' to real relative abundance distributions:
Niclosamide_16S_0uM_summarised <- rel_ab_control
Niclosamide_16S_0uM_summarised$Species <- gsub("\\.", "", Niclosamide_16S_0uM_summarised$Species)

Diacerein_16S_320uM_summarised <- Community_compositions_focus_drugs_Diacerein_320uM_summarised
Diacerein_16S_20uM_summarised <- Community_compositions_focus_drugs_Diacerein_20uM_summarised
Diacerein_16S_80uM_summarised <- Community_compositions_focus_drugs_Diacerein_80uM_summarised

Niclosamide_16S_0uM_summarised
Diacerein_16S_320uM_summarised 
Diacerein_16S_20uM_summarised 
Diacerein_16S_80uM_summarised 

#Rename 'species' so the outputs become comparable
original_names_80 <- unique(Diacerein_16S_80uM_summarised$species)
original_names_20 <- unique(Diacerein_16S_20uM_summarised$species)
original_names_320 <- unique(Diacerein_16S_320uM_summarised$species)


##Create a named vector with the original and new names mapping
name_changes <- c(
  "Akkermansia muciniphila" = "A_muciniphila",
  "Bacteroides fragilis" = "B_fragilis",
  "Bacteroides thetaiotaomicron" = "B_thetaiotaomicron",
  "Bacteroides uniformis" = "B_uniformis",
  "Bifidobacterium adolescentis" = "B_adolescentis",
  "Bifidobacterium longum subsp. longum" = "B_longum",
  "Bilophila wadsworthia" = "B_wadsworthia",
  "Blautia obeum" = "B_obeum",
  "Clostridium perfringens" = "C_perfringens",
  "Collinsella aerofaciens" = "C_aerofaciens",
  "Coprococcus comes" = "C_comes",
  "Dorea formicigenerans" = "D_formicigenerans",
  "Eggerthella lenta" = "E_lenta",
  "Enterocloster bolteae" = "C_bolteae",
  "Erysipelatoclostridium ramosum" = "C_ramosum",
  "Escherichia coli ED1a" = "E_coli",
  "Eubacterium rectale" = "E_rectale",
  "Fusobacterium nucleatum subsp. nucleatum" = "F_nucleatum",
  "Lacrimispora saccharolytica" = "C_saccharolyticum",
  "Lacticaseibacillus paracasei" = "L_paracasei",
  "Odoribacter splanchnicus" = "O_splanchnicus",
  "Parabacteroides distasonis" = "P_distasonis",
  "Parabacteroides merdae" = "P_merdae",
  "Phocaeicola vulgatus" = "B_vulgatus",
  "Prevotella copri" = "P_copri",
  "Roseburia intestinalis" = "R_intestinalis",
  "Ruminococcus bromii" = "R_bromii",
  "Ruminococcus gnavus" = "R_gnavus",
  "Ruminococcus torques" = "R_torques",
  "Streptococcus parasanguinis" = "S_parasanguinis",
  "Streptococcus salivarius" = "S_salivarius",
  "Veillonella parvula" = "V_parvula"
)

# Apply name changes to the species column in Diacerein_16S_80uM_summarised

Diacerein_16S_80uM_summarised$Species <- name_changes[Diacerein_16S_80uM_summarised$species]
Diacerein_16S_20uM_summarised$Species <- name_changes[Diacerein_16S_20uM_summarised$species]
Diacerein_16S_320uM_summarised$Species <- name_changes[Diacerein_16S_320uM_summarised$species]

# Verify the changes
unique(Diacerein_16S_80uM_summarised$Species)
unique(Diacerein_16S_20uM_summarised$Species)
unique(Diacerein_16S_320uM_summarised$Species)



##First, for 320 uM:
# Get top 6 species from plot_data_320_endpoint
# Adjust the plot_data_320_endpoint with confidence bounds

# #plot_data_0_Diacerein_endpoint was used to test model performance at 0 drugs
# plot_data_0_Diacerein_endpoint <- plot_data_0_Diacerein_endpoint %>%
#   dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)

plot_data_320_Diacerein_endpoint <- plot_data_320_Diacerein_endpoint %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)

# Adjust the Diacerein_16S_320uM_summarised with confidence bounds
Diacerein_16S_320uM_summarised <- Diacerein_16S_320uM_summarised %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)

#NULL model:
Null_model_summarised <- Niclosamide_16S_0uM_summarised %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)


# Get top 6 species based on the lower bound from plot_data_320_endpoint

#top6_predicted_0_Diacerein was used to test model performance at 0 drugs
# top6_predicted_0_Diacerein <- plot_data_0_Diacerein_endpoint %>%
#    arrange(desc(lower_bound)) %>%
#    slice(1:6) %>%
#    pull(Species)

top6_predicted_320_Diacerein <- plot_data_320_Diacerein_endpoint %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

# Get top 6 species based on the lower bound from Diacerein_16S_320uM_summarised
top6_real_320_Diacerein <- Diacerein_16S_320uM_summarised %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

top6_NULL <- Null_model_summarised %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

# Calculate the overlap of top 6 species

#top_six_correct_0_Diacerein was used to assess model performance at 0 drugs
# top_six_correct_0_Diacerein <- length(intersect(top6_predicted_0_Diacerein, top6_NULL))
# top_six_correct_0_Diacerein

top_six_correct_320_Diacerein <- length(intersect(top6_predicted_320_Diacerein, top6_real_320_Diacerein))
top_six_correct_320_Diacerein

top_six_correct_320_Diacerein_NULL <- length(intersect(top6_NULL, top6_real_320_Diacerein))
top_six_correct_320_Diacerein_NULL

top6_predicted_320_Diacerein
top6_real_320_Diacerein

#top6_NULL

#Now by means:
# #top6_predicted_0_Diacerein_means was used to assess model performance at 0 drugs
# top6_predicted_0_Diacerein_means <- plot_data_0_Diacerein_endpoint %>%
#    arrange(desc(mean_rel_ab)) %>%
#    slice(1:6) %>%
#    pull(Species)

top6_predicted_320_Diacerein_means <- plot_data_320_Diacerein_endpoint %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)

# Get top 6 species based on the lower bound from Diacerein_16S_320uM_summarised
top6_real_320_Diacerein_means <- Diacerein_16S_320uM_summarised %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)

top6_NULL_means <- Null_model_summarised %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)


# #top_six_correct_0_Diacerein_means was used to assess model performance at 0 drugs
# top_six_correct_0_Diacerein_means <- length(intersect(top6_predicted_0_Diacerein_means, top6_NULL_means))
# top_six_correct_0_Diacerein_means

top_six_correct_320_Diacerein_means <- length(intersect(top6_predicted_320_Diacerein_means, top6_real_320_Diacerein_means))
top_six_correct_320_Diacerein_means

top_six_correct_320_Diacerein_means_NULL <- length(intersect(top6_NULL_means, top6_real_320_Diacerein_means))
top_six_correct_320_Diacerein_means_NULL

top6_predicted_320_Diacerein_means
top6_real_320_Diacerein_means

#top6_NULL_means


# Merge dataframes by Species

#merged_data_0_Diacerein was used to assess model performance at 0 drugs
#merged_data_0_Diacerein <- merge(plot_data_0_Diacerein_endpoint, Niclosamide_16S_0uM_summarised, by = "Species", suffixes = c(".pred", ".real"))
merged_data_320_Diacerein <- merge(plot_data_320_Diacerein_endpoint, Diacerein_16S_320uM_summarised, by = "Species", suffixes = c(".pred", ".real"))
merged_data_320_Diacerein_NULL <- merge(Niclosamide_16S_0uM_summarised, Diacerein_16S_320uM_summarised, by = "Species", suffixes = c(".null", ".real"))


## Below lines used for assessing model performance at 0 drugs; ignore for nonzero concentrations
# # Create lower and upper bounds considering mean ¬± sd
# merged_data_0_Diacerein$lower_bound_pred <- merged_data_0_Diacerein$mean_rel_ab.pred - merged_data_0_Diacerein$sd_rel_ab.pred
# merged_data_0_Diacerein$upper_bound_pred <- merged_data_0_Diacerein$mean_rel_ab.pred + merged_data_0_Diacerein$sd_rel_ab.pred
# merged_data_0_Diacerein$lower_bound_real <- merged_data_0_Diacerein$mean_rel_ab.real - merged_data_0_Diacerein$sd_rel_ab.real
# merged_data_0_Diacerein$upper_bound_real <- merged_data_0_Diacerein$mean_rel_ab.real + merged_data_0_Diacerein$sd_rel_ab.real
# 
# # Ensure lower and upper bounds are non-negative, adjusting as necessary
# merged_data_0_Diacerein$lower_bound_pred[merged_data_0_Diacerein$lower_bound_pred <= 0] <- 1e-10
# merged_data_0_Diacerein$lower_bound_real[merged_data_0_Diacerein$lower_bound_real <= 0] <- 1e-10
# merged_data_0_Diacerein$upper_bound_pred[merged_data_0_Diacerein$upper_bound_pred <= 0] <- 1e-10
# merged_data_0_Diacerein$upper_bound_real[merged_data_0_Diacerein$upper_bound_real <= 0] <- 1e-10


# Create lower and upper bounds considering mean ¬± sd
merged_data_320_Diacerein$lower_bound_pred <- merged_data_320_Diacerein$mean_rel_ab.pred - merged_data_320_Diacerein$sd_rel_ab.pred
merged_data_320_Diacerein$upper_bound_pred <- merged_data_320_Diacerein$mean_rel_ab.pred + merged_data_320_Diacerein$sd_rel_ab.pred
merged_data_320_Diacerein$lower_bound_real <- merged_data_320_Diacerein$mean_rel_ab.real - merged_data_320_Diacerein$sd_rel_ab.real
merged_data_320_Diacerein$upper_bound_real <- merged_data_320_Diacerein$mean_rel_ab.real + merged_data_320_Diacerein$sd_rel_ab.real

# Ensure lower and upper bounds are non-negative, adjusting as necessary
merged_data_320_Diacerein$lower_bound_pred[merged_data_320_Diacerein$lower_bound_pred <= 0] <- 1e-10
merged_data_320_Diacerein$lower_bound_real[merged_data_320_Diacerein$lower_bound_real <= 0] <- 1e-10
merged_data_320_Diacerein$upper_bound_pred[merged_data_320_Diacerein$upper_bound_pred <= 0] <- 1e-10
merged_data_320_Diacerein$upper_bound_real[merged_data_320_Diacerein$upper_bound_real <= 0] <- 1e-10

##and for NULL model:
# Create lower and upper bounds considering mean ¬± sd
merged_data_320_Diacerein_NULL$lower_bound_null <- merged_data_320_Diacerein_NULL$mean_rel_ab.null - merged_data_320_Diacerein_NULL$sd_rel_ab.null
merged_data_320_Diacerein_NULL$upper_bound_null <- merged_data_320_Diacerein_NULL$mean_rel_ab.null + merged_data_320_Diacerein_NULL$sd_rel_ab.null
merged_data_320_Diacerein_NULL$lower_bound_real <- merged_data_320_Diacerein_NULL$mean_rel_ab.real - merged_data_320_Diacerein_NULL$sd_rel_ab.real
merged_data_320_Diacerein_NULL$upper_bound_real <- merged_data_320_Diacerein_NULL$mean_rel_ab.real + merged_data_320_Diacerein_NULL$sd_rel_ab.real

# Ensure lower and upper bounds are non-negative, adjusting as necessary
merged_data_320_Diacerein_NULL$lower_bound_null[merged_data_320_Diacerein_NULL$lower_bound_null <= 0] <- 1e-10
merged_data_320_Diacerein_NULL$lower_bound_real[merged_data_320_Diacerein_NULL$lower_bound_real <= 0] <- 1e-10
merged_data_320_Diacerein_NULL$upper_bound_null[merged_data_320_Diacerein_NULL$upper_bound_null <= 0] <- 1e-10
merged_data_320_Diacerein_NULL$upper_bound_real[merged_data_320_Diacerein_NULL$upper_bound_real <= 0] <- 1e-10

# Filter to include only species with a mean relative abundance > 0.01 in the 'real' dataset

## significant_species_0 was used to assess model performance at 0 drugs
#significant_species_0 <- merged_data_0_Diacerein[merged_data_0_Diacerein$mean_rel_ab.real > 0.01, ]
significant_species <- merged_data_320_Diacerein[merged_data_320_Diacerein$mean_rel_ab.real > 0.01, ]
survivors_320_Diacerein <- nrow(significant_species)
survivors_320_Diacerein

#should be the same as survivors defined above, since it is calculated from .real
significant_species_NULL <- merged_data_320_Diacerein_NULL[merged_data_320_Diacerein_NULL$mean_rel_ab.real > 0.01, ]
survivors_320_Diacerein_NULL <- nrow(significant_species_NULL)
survivors_320_Diacerein_NULL

# Adjusted order of magnitude check to include SD, only for significant species
## below code was used to assess model performance at 0 drugs
# significant_species_0$Predicted_magnitude_correct <- ifelse(
#   (floor(log10(significant_species_0$lower_bound_pred)) <= floor(log10(significant_species_0$upper_bound_real)) &
#      floor(log10(significant_species_0$upper_bound_pred)) >= floor(log10(significant_species_0$lower_bound_real))),
#   1,
#   0
# )

significant_species$Predicted_magnitude_correct <- ifelse(
  (floor(log10(significant_species$lower_bound_pred)) <= floor(log10(significant_species$upper_bound_real)) &
     floor(log10(significant_species$upper_bound_pred)) >= floor(log10(significant_species$lower_bound_real))),
  1,
  0
)

#and for the Null model:
significant_species_NULL$Predicted_magnitude_correct <- ifelse(
  (floor(log10(significant_species_NULL$lower_bound_null)) <= floor(log10(significant_species_NULL$upper_bound_real)) &
     floor(log10(significant_species_NULL$upper_bound_null)) >= floor(log10(significant_species_NULL$lower_bound_real))),
  1,
  0
)

# Calculate the fraction of correctly predicted magnitudes for significant species
## below code was used to assess model performance at 0 drugs
#predicted_magnitude_correct_fraction_0_Diacerein <- sum(significant_species_0$Predicted_magnitude_correct) / nrow(significant_species_0)
#predicted_magnitude_correct_fraction_0_Diacerein

predicted_magnitude_correct_fraction_320_Diacerein <- sum(significant_species$Predicted_magnitude_correct) / nrow(significant_species)
predicted_magnitude_correct_fraction_320_Diacerein

predicted_magnitude_correct_fraction_320_Diacerein_NULL <- sum(significant_species_NULL$Predicted_magnitude_correct) / nrow(significant_species_NULL)
predicted_magnitude_correct_fraction_320_Diacerein_NULL

top_species_missing_320_Diacerein <- setdiff(top6_real_320_Diacerein_means, top6_predicted_320_Diacerein_means)
top_species_wrong_320_Diacerein <- setdiff(top6_predicted_320_Diacerein_means, top6_real_320_Diacerein_means)


Prediction_quality_320_Diacerein <- data.frame(
  Top_six_correct = paste(top_six_correct_320_Diacerein, sep=""),
  Top_six_correct_NULL = paste(top_six_correct_320_Diacerein_NULL, sep=""),
  Top_six_correct_means = paste(top_six_correct_320_Diacerein_means, sep=""),
  Top_six_correct_means_NULL = paste(top_six_correct_320_Diacerein_means_NULL, sep=""),
  Predicted_magnitude_correct = paste(round(predicted_magnitude_correct_fraction_320_Diacerein * 100, 2), "%", sep=""),
  Predicted_magnitude_correct_NULL = paste(round(predicted_magnitude_correct_fraction_320_Diacerein_NULL * 100, 2), "%", sep=""),
  survivors_total = survivors_320_Diacerein,
  top_species_missing <- top_species_missing_320_Diacerein,
  top_species_wrong <- top_species_wrong_320_Diacerein, 
  predicted_mean_final_OD <- predicted_mean_final_od_320_Diacerein,
  real_mean_final_OD <- real_mean_final_od_320_Diacerein,
  sims_total = length(successful_sim_ids)
)



Prediction_quality_320_Diacerein



##Next, for 20 uM:
# Get top 6 species from plot_data_20_endpoint
# Adjust the plot_data_20_endpoint with confidence bounds
plot_data_20_Diacerein_endpoint <- plot_data_20_Diacerein_endpoint %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)

# Adjust the Diacerein_16S_20uM_summarised with confidence bounds
Diacerein_16S_20uM_summarised <- Diacerein_16S_20uM_summarised %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)

#NULL model:
Null_model_summarised <- Niclosamide_16S_0uM_summarised %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)


# Get top 6 species based on the lower bound from plot_data_20_endpoint
top6_predicted_20_Diacerein <- plot_data_20_Diacerein_endpoint %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

# Get top 6 species based on the lower bound from Diacerein_16S_20uM_summarised
top6_real_20_Diacerein <- Diacerein_16S_20uM_summarised %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

top6_NULL <- Null_model_summarised %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

# Calculate the overlap of top 6 species
top_six_correct_20_Diacerein <- length(intersect(top6_predicted_20_Diacerein, top6_real_20_Diacerein))
#top_six_correct_20_Diacerein

top_six_correct_20_Diacerein_NULL <- length(intersect(top6_NULL, top6_real_20_Diacerein))
#top_six_correct_20_Diacerein_NULL

#top6_predicted_20_Diacerein
#top6_real_20_Diacerein



#Now by means:
top6_predicted_20_Diacerein_means <- plot_data_20_Diacerein_endpoint %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)

# Get top 6 species based on the lower bound from Diacerein_16S_20uM_summarised
top6_real_20_Diacerein_means <- Diacerein_16S_20uM_summarised %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)

top6_NULL_means <- Null_model_summarised %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)



top_six_correct_20_Diacerein_means <- length(intersect(top6_predicted_20_Diacerein_means, top6_real_20_Diacerein_means))
#top_six_correct_20_Diacerein_means

top_six_correct_20_Diacerein_means_NULL <- length(intersect(top6_NULL_means, top6_real_20_Diacerein_means))
#top_six_correct_20_Diacerein_means_NULL

top6_predicted_20_Diacerein_means
#top6_real_20_Diacerein_means




# Merge dataframes by Species
merged_data_20_Diacerein <- merge(plot_data_20_Diacerein_endpoint, Diacerein_16S_20uM_summarised, by = "Species", suffixes = c(".pred", ".real"))
merged_data_20_Diacerein_NULL <- merge(Niclosamide_16S_0uM_summarised, Diacerein_16S_20uM_summarised, by = "Species", suffixes = c(".null", ".real"))



# Create lower and upper bounds considering mean ¬± sd
merged_data_20_Diacerein$lower_bound_pred <- merged_data_20_Diacerein$mean_rel_ab.pred - merged_data_20_Diacerein$sd_rel_ab.pred
merged_data_20_Diacerein$upper_bound_pred <- merged_data_20_Diacerein$mean_rel_ab.pred + merged_data_20_Diacerein$sd_rel_ab.pred
merged_data_20_Diacerein$lower_bound_real <- merged_data_20_Diacerein$mean_rel_ab.real - merged_data_20_Diacerein$sd_rel_ab.real
merged_data_20_Diacerein$upper_bound_real <- merged_data_20_Diacerein$mean_rel_ab.real + merged_data_20_Diacerein$sd_rel_ab.real

# Ensure lower and upper bounds are non-negative, adjusting as necessary
merged_data_20_Diacerein$lower_bound_pred[merged_data_20_Diacerein$lower_bound_pred <= 0] <- 1e-10
merged_data_20_Diacerein$lower_bound_real[merged_data_20_Diacerein$lower_bound_real <= 0] <- 1e-10
merged_data_20_Diacerein$upper_bound_pred[merged_data_20_Diacerein$upper_bound_pred <= 0] <- 1e-10
merged_data_20_Diacerein$upper_bound_real[merged_data_20_Diacerein$upper_bound_real <= 0] <- 1e-10

##and for NULL model:
# Create lower and upper bounds considering mean ¬± sd
merged_data_20_Diacerein_NULL$lower_bound_null <- merged_data_20_Diacerein_NULL$mean_rel_ab.null - merged_data_20_Diacerein_NULL$sd_rel_ab.null
merged_data_20_Diacerein_NULL$upper_bound_null <- merged_data_20_Diacerein_NULL$mean_rel_ab.null + merged_data_20_Diacerein_NULL$sd_rel_ab.null
merged_data_20_Diacerein_NULL$lower_bound_real <- merged_data_20_Diacerein_NULL$mean_rel_ab.real - merged_data_20_Diacerein_NULL$sd_rel_ab.real
merged_data_20_Diacerein_NULL$upper_bound_real <- merged_data_20_Diacerein_NULL$mean_rel_ab.real + merged_data_20_Diacerein_NULL$sd_rel_ab.real

# Ensure lower and upper bounds are non-negative, adjusting as necessary
merged_data_20_Diacerein_NULL$lower_bound_null[merged_data_20_Diacerein_NULL$lower_bound_null <= 0] <- 1e-10
merged_data_20_Diacerein_NULL$lower_bound_real[merged_data_20_Diacerein_NULL$lower_bound_real <= 0] <- 1e-10
merged_data_20_Diacerein_NULL$upper_bound_null[merged_data_20_Diacerein_NULL$upper_bound_null <= 0] <- 1e-10
merged_data_20_Diacerein_NULL$upper_bound_real[merged_data_20_Diacerein_NULL$upper_bound_real <= 0] <- 1e-10

# Filter to include only species with a mean relative abundance > 0.01 in the 'real' dataset
significant_species <- merged_data_20_Diacerein[merged_data_20_Diacerein$mean_rel_ab.real > 0.01, ]
survivors_20_Diacerein <- nrow(significant_species)
survivors_20_Diacerein

#should be the same as survivors defined above, since it is calculated from .real
significant_species_NULL <- merged_data_20_Diacerein_NULL[merged_data_20_Diacerein_NULL$mean_rel_ab.real > 0.01, ]
survivors_20_Diacerein_NULL <- nrow(significant_species_NULL)
survivors_20_Diacerein_NULL

# Adjusted order of magnitude check to include SD, only for significant species
significant_species$Predicted_magnitude_correct <- ifelse(
  (floor(log10(significant_species$lower_bound_pred)) <= floor(log10(significant_species$upper_bound_real)) &
     floor(log10(significant_species$upper_bound_pred)) >= floor(log10(significant_species$lower_bound_real))),
  1,
  0
)

#and for the Null model:
significant_species_NULL$Predicted_magnitude_correct <- ifelse(
  (floor(log10(significant_species_NULL$lower_bound_null)) <= floor(log10(significant_species_NULL$upper_bound_real)) &
     floor(log10(significant_species_NULL$upper_bound_null)) >= floor(log10(significant_species_NULL$lower_bound_real))),
  1,
  0
)

# Calculate the fraction of correctly predicted magnitudes for significant species
predicted_magnitude_correct_fraction_20_Diacerein <- sum(significant_species$Predicted_magnitude_correct) / nrow(significant_species)
predicted_magnitude_correct_fraction_20_Diacerein

predicted_magnitude_correct_fraction_20_Diacerein_NULL <- sum(significant_species_NULL$Predicted_magnitude_correct) / nrow(significant_species_NULL)
predicted_magnitude_correct_fraction_20_Diacerein_NULL

top_species_missing_20_Diacerein <- setdiff(top6_real_20_Diacerein_means, top6_predicted_20_Diacerein_means)
top_species_wrong_20_Diacerein <- setdiff(top6_predicted_20_Diacerein_means, top6_real_20_Diacerein_means)

top_species_missing_20_Diacerein <- if(length(top_species_missing_20_Diacerein) == 0) "None" else top_species_missing_20_Diacerein
top_species_wrong_20_Diacerein <- if(length(top_species_wrong_20_Diacerein) == 0) "None" else top_species_wrong_20_Diacerein


Prediction_quality_20_Diacerein <- data.frame(
  Top_six_correct = paste(top_six_correct_20_Diacerein, sep=""),
  Top_six_correct_NULL = paste(top_six_correct_20_Diacerein_NULL, sep=""),
  Top_six_correct_means = paste(top_six_correct_20_Diacerein_means, sep=""),
  Top_six_correct_means_NULL = paste(top_six_correct_20_Diacerein_means_NULL, sep=""),
  Predicted_magnitude_correct = paste(round(predicted_magnitude_correct_fraction_20_Diacerein * 100, 2), "%", sep=""),
  Predicted_magnitude_correct_NULL = paste(round(predicted_magnitude_correct_fraction_20_Diacerein_NULL * 100, 2), "%", sep=""),
  survivors_total = survivors_20_Diacerein,
  top_species_missing <- top_species_missing_20_Diacerein,
  top_species_wrong <- top_species_wrong_20_Diacerein, 
  predicted_mean_final_OD <- predicted_mean_final_od_20_Diacerein,
  real_mean_final_OD <- real_mean_final_od_20_Diacerein,
  sims_total = length(successful_sim_ids)
)

Prediction_quality_20_Diacerein






##Next, for 80 uM:
# Get top 6 species from plot_data_80_endpoint
# Adjust the plot_data_80_endpoint with confidence bounds
plot_data_80_Diacerein_endpoint <- plot_data_80_Diacerein_endpoint %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)

# Adjust the Diacerein_16S_80uM_summarised with confidence bounds
Diacerein_16S_80uM_summarised <- Diacerein_16S_80uM_summarised %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)

#NULL model:
Null_model_summarised <- Niclosamide_16S_0uM_summarised %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)


# Get top 6 species based on the lower bound from plot_data_80_endpoint
top6_predicted_80_Diacerein <- plot_data_80_Diacerein_endpoint %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

# Get top 6 species based on the lower bound from Diacerein_16S_80uM_summarised
top6_real_80_Diacerein <- Diacerein_16S_80uM_summarised %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

top6_NULL <- Null_model_summarised %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

# Calculate the overlap of top 6 species
top_six_correct_80_Diacerein <- length(intersect(top6_predicted_80_Diacerein, top6_real_80_Diacerein))
#top_six_correct_80_Diacerein

top_six_correct_80_Diacerein_NULL <- length(intersect(top6_NULL, top6_real_80_Diacerein))
#top_six_correct_80_Diacerein_NULL

#top6_predicted_80_Diacerein
#top6_real_80_Diacerein




#Now by means:
top6_predicted_80_Diacerein_means <- plot_data_80_Diacerein_endpoint %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)

# Get top 6 species based on the lower bound from Diacerein_16S_80uM_summarised
top6_real_80_Diacerein_means <- Diacerein_16S_80uM_summarised %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)

top6_NULL_means <- Null_model_summarised %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)



top_six_correct_80_Diacerein_means <- length(intersect(top6_predicted_80_Diacerein_means, top6_real_80_Diacerein_means))
#top_six_correct_80_Diacerein_means

top_six_correct_80_Diacerein_means_NULL <- length(intersect(top6_NULL_means, top6_real_80_Diacerein_means))
#top_six_correct_80_Diacerein_means_NULL

#top6_predicted_80_Diacerein_means
#top6_real_80_Diacerein_means




# Merge dataframes by Species
merged_data_80_Diacerein <- merge(plot_data_80_Diacerein_endpoint, Diacerein_16S_80uM_summarised, by = "Species", suffixes = c(".pred", ".real"))
merged_data_80_Diacerein_NULL <- merge(Niclosamide_16S_0uM_summarised, Diacerein_16S_80uM_summarised, by = "Species", suffixes = c(".null", ".real"))



# Create lower and upper bounds considering mean ¬± sd
merged_data_80_Diacerein$lower_bound_pred <- merged_data_80_Diacerein$mean_rel_ab.pred - merged_data_80_Diacerein$sd_rel_ab.pred
merged_data_80_Diacerein$upper_bound_pred <- merged_data_80_Diacerein$mean_rel_ab.pred + merged_data_80_Diacerein$sd_rel_ab.pred
merged_data_80_Diacerein$lower_bound_real <- merged_data_80_Diacerein$mean_rel_ab.real - merged_data_80_Diacerein$sd_rel_ab.real
merged_data_80_Diacerein$upper_bound_real <- merged_data_80_Diacerein$mean_rel_ab.real + merged_data_80_Diacerein$sd_rel_ab.real

# Ensure lower and upper bounds are non-negative, adjusting as necessary
merged_data_80_Diacerein$lower_bound_pred[merged_data_80_Diacerein$lower_bound_pred <= 0] <- 1e-10
merged_data_80_Diacerein$lower_bound_real[merged_data_80_Diacerein$lower_bound_real <= 0] <- 1e-10
merged_data_80_Diacerein$upper_bound_pred[merged_data_80_Diacerein$upper_bound_pred <= 0] <- 1e-10
merged_data_80_Diacerein$upper_bound_real[merged_data_80_Diacerein$upper_bound_real <= 0] <- 1e-10

##and for NULL model:
# Create lower and upper bounds considering mean ¬± sd
merged_data_80_Diacerein_NULL$lower_bound_null <- merged_data_80_Diacerein_NULL$mean_rel_ab.null - merged_data_80_Diacerein_NULL$sd_rel_ab.null
merged_data_80_Diacerein_NULL$upper_bound_null <- merged_data_80_Diacerein_NULL$mean_rel_ab.null + merged_data_80_Diacerein_NULL$sd_rel_ab.null
merged_data_80_Diacerein_NULL$lower_bound_real <- merged_data_80_Diacerein_NULL$mean_rel_ab.real - merged_data_80_Diacerein_NULL$sd_rel_ab.real
merged_data_80_Diacerein_NULL$upper_bound_real <- merged_data_80_Diacerein_NULL$mean_rel_ab.real + merged_data_80_Diacerein_NULL$sd_rel_ab.real

# Ensure lower and upper bounds are non-negative, adjusting as necessary
merged_data_80_Diacerein_NULL$lower_bound_null[merged_data_80_Diacerein_NULL$lower_bound_null <= 0] <- 1e-10
merged_data_80_Diacerein_NULL$lower_bound_real[merged_data_80_Diacerein_NULL$lower_bound_real <= 0] <- 1e-10
merged_data_80_Diacerein_NULL$upper_bound_null[merged_data_80_Diacerein_NULL$upper_bound_null <= 0] <- 1e-10
merged_data_80_Diacerein_NULL$upper_bound_real[merged_data_80_Diacerein_NULL$upper_bound_real <= 0] <- 1e-10

# Filter to include only species with a mean relative abundance > 0.01 in the 'real' dataset
significant_species <- merged_data_80_Diacerein[merged_data_80_Diacerein$mean_rel_ab.real > 0.01, ]
survivors_80_Diacerein <- nrow(significant_species)
survivors_80_Diacerein

#should be the same as survivors defined above, since it is calculated from .real
significant_species_NULL <- merged_data_80_Diacerein_NULL[merged_data_80_Diacerein_NULL$mean_rel_ab.real > 0.01, ]
survivors_80_Diacerein_NULL <- nrow(significant_species_NULL)
survivors_80_Diacerein_NULL

# Adjusted order of magnitude check to include SD, only for significant species
significant_species$Predicted_magnitude_correct <- ifelse(
  (floor(log10(significant_species$lower_bound_pred)) <= floor(log10(significant_species$upper_bound_real)) &
     floor(log10(significant_species$upper_bound_pred)) >= floor(log10(significant_species$lower_bound_real))),
  1,
  0
)

#and for the Null model:
significant_species_NULL$Predicted_magnitude_correct <- ifelse(
  (floor(log10(significant_species_NULL$lower_bound_null)) <= floor(log10(significant_species_NULL$upper_bound_real)) &
     floor(log10(significant_species_NULL$upper_bound_null)) >= floor(log10(significant_species_NULL$lower_bound_real))),
  1,
  0
)

# Calculate the fraction of correctly predicted magnitudes for significant species
predicted_magnitude_correct_fraction_80_Diacerein <- sum(significant_species$Predicted_magnitude_correct) / nrow(significant_species)
predicted_magnitude_correct_fraction_80_Diacerein

predicted_magnitude_correct_fraction_80_Diacerein_NULL <- sum(significant_species_NULL$Predicted_magnitude_correct) / nrow(significant_species_NULL)
predicted_magnitude_correct_fraction_80_Diacerein_NULL


top_species_missing_80_Diacerein <- setdiff(top6_real_80_Diacerein_means, top6_predicted_80_Diacerein_means)
top_species_wrong_80_Diacerein <- setdiff(top6_predicted_80_Diacerein_means, top6_real_80_Diacerein_means)

Prediction_quality_80_Diacerein <- data.frame(
  Top_six_correct = paste(top_six_correct_80_Diacerein, sep=""),
  Top_six_correct_NULL = paste(top_six_correct_80_Diacerein_NULL, sep=""),
  Top_six_correct_means = paste(top_six_correct_80_Diacerein_means, sep=""),
  Top_six_correct_means_NULL = paste(top_six_correct_80_Diacerein_means_NULL, sep=""),
  Predicted_magnitude_correct = paste(round(predicted_magnitude_correct_fraction_80_Diacerein * 100, 2), "%", sep=""),
  Predicted_magnitude_correct_NULL = paste(round(predicted_magnitude_correct_fraction_80_Diacerein_NULL * 100, 2), "%", sep=""),
  survivors_total = survivors_80_Diacerein,
  top_species_missing <- top_species_missing_80_Diacerein,
  top_species_wrong <- top_species_wrong_80_Diacerein, 
  predicted_mean_final_OD <- predicted_mean_final_od_80_Diacerein,
  real_mean_final_OD <- real_mean_final_od_80_Diacerein,
  sims_total = length(successful_sim_ids)
)

Prediction_quality_80_Diacerein










##Dienestrol

combined_monoculture_aucs2_Dienestrol <- subset(combined_monoculture_aucs2, drug == "Dienestrol")


#drug sensitivity terms: define once outside of ODEs
y_function_B_vulgatus_Dienestrol <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("B_vulgatus", "Dienestrol", best_fitting_models_df_Dienestrol)), collapse = " ")))
y_function_B_uniformis_Dienestrol <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("B_uniformis", "Dienestrol", best_fitting_models_df_Dienestrol)), collapse = " ")))
y_function_B_fragilis_Dienestrol <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("B_fragilis", "Dienestrol", best_fitting_models_df_Dienestrol)), collapse = " ")))
y_function_B_thetaiotaomicron_Dienestrol <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("B_thetaiotaomicron", "Dienestrol", best_fitting_models_df_Dienestrol)), collapse = " ")))
y_function_C_ramosum_Dienestrol <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("C_ramosum", "Dienestrol", best_fitting_models_df_Dienestrol)), collapse = " ")))
y_function_E_rectale_Dienestrol <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("E_rectale", "Dienestrol", best_fitting_models_df_Dienestrol)), collapse = " ")))
y_function_R_intestinalis_Dienestrol <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("R_intestinalis", "Dienestrol", best_fitting_models_df_Dienestrol)), collapse = " ")))
y_function_V_parvula_Dienestrol <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("V_parvula", "Dienestrol", best_fitting_models_df_Dienestrol)), collapse = " ")))
y_function_E_lenta_Dienestrol <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("E_lenta", "Dienestrol", best_fitting_models_df_Dienestrol)), collapse = " ")))
y_function_F_nucleatum_Dienestrol <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("F_nucleatum", "Dienestrol", best_fitting_models_df_Dienestrol)), collapse = " ")))
y_function_C_bolteae_Dienestrol <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("C_bolteae", "Dienestrol", best_fitting_models_df_Dienestrol)), collapse = " ")))
y_function_C_perfringens_Dienestrol <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("C_perfringens", "Dienestrol", best_fitting_models_df_Dienestrol)), collapse = " ")))
y_function_C_saccharolyticum_Dienestrol <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("C_saccharolyticum", "Dienestrol", best_fitting_models_df_Dienestrol)), collapse = " ")))
y_function_S_salivarius_Dienestrol <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("S_salivarius", "Dienestrol", best_fitting_models_df_Dienestrol)), collapse = " ")))
y_function_R_gnavus_Dienestrol <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("R_gnavus", "Dienestrol", best_fitting_models_df_Dienestrol)), collapse = " ")))
y_function_C_comes_Dienestrol <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("C_comes", "Dienestrol", best_fitting_models_df_Dienestrol)), collapse = " ")))
y_function_P_merdae_Dienestrol <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("P_merdae", "Dienestrol", best_fitting_models_df_Dienestrol)), collapse = " ")))
y_function_S_parasanguinis_Dienestrol <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("S_parasanguinis", "Dienestrol", best_fitting_models_df_Dienestrol)), collapse = " ")))
y_function_C_aerofaciens_Dienestrol <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("C_aerofaciens", "Dienestrol", best_fitting_models_df_Dienestrol)), collapse = " ")))
y_function_D_formicigenerans_Dienestrol <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("D_formicigenerans", "Dienestrol", best_fitting_models_df_Dienestrol)), collapse = " ")))
y_function_E_coli_Dienestrol <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("E_coli", "Dienestrol", best_fitting_models_df_Dienestrol)), collapse = " ")))



y_function_B_vulgatus_Dienestrol_func <- eval(parse(text = paste("function(Drug) {", y_function_B_vulgatus_Dienestrol, "}")))
y_function_B_uniformis_Dienestrol_func <- eval(parse(text = paste("function(Drug) {", y_function_B_uniformis_Dienestrol, "}")))
y_function_B_fragilis_Dienestrol_func <- eval(parse(text = paste("function(Drug) {", y_function_B_fragilis_Dienestrol, "}")))
y_function_B_thetaiotaomicron_Dienestrol_func <- eval(parse(text = paste("function(Drug) {", y_function_B_thetaiotaomicron_Dienestrol, "}")))
y_function_C_ramosum_Dienestrol_func <- eval(parse(text = paste("function(Drug) {", y_function_C_ramosum_Dienestrol, "}")))
y_function_E_rectale_Dienestrol_func <- eval(parse(text = paste("function(Drug) {", y_function_E_rectale_Dienestrol, "}")))
y_function_R_intestinalis_Dienestrol_func <- eval(parse(text = paste("function(Drug) {", y_function_R_intestinalis_Dienestrol, "}")))
y_function_E_lenta_Dienestrol_func <- eval(parse(text = paste("function(Drug) {", y_function_E_lenta_Dienestrol, "}")))
y_function_F_nucleatum_Dienestrol_func <- eval(parse(text = paste("function(Drug) {", y_function_F_nucleatum_Dienestrol, "}")))
y_function_C_bolteae_Dienestrol_func <- eval(parse(text = paste("function(Drug) {", y_function_C_bolteae_Dienestrol, "}")))
y_function_C_perfringens_Dienestrol_func <- eval(parse(text = paste("function(Drug) {", y_function_C_perfringens_Dienestrol, "}")))
y_function_C_saccharolyticum_Dienestrol_func <- eval(parse(text = paste("function(Drug) {", y_function_C_saccharolyticum_Dienestrol, "}")))
y_function_S_salivarius_Dienestrol_func <- eval(parse(text = paste("function(Drug) {", y_function_S_salivarius_Dienestrol, "}")))
y_function_R_gnavus_Dienestrol_func <- eval(parse(text = paste("function(Drug) {", y_function_R_gnavus_Dienestrol, "}")))
y_function_C_comes_Dienestrol_func <- eval(parse(text = paste("function(Drug) {", y_function_C_comes_Dienestrol, "}")))
y_function_P_merdae_Dienestrol_func <- eval(parse(text = paste("function(Drug) {", y_function_P_merdae_Dienestrol, "}")))
y_function_S_parasanguinis_Dienestrol_func <- eval(parse(text = paste("function(Drug) {", y_function_S_parasanguinis_Dienestrol, "}")))
y_function_C_aerofaciens_Dienestrol_func <- eval(parse(text = paste("function(Drug) {", y_function_C_aerofaciens_Dienestrol, "}")))
y_function_D_formicigenerans_Dienestrol_func <- eval(parse(text = paste("function(Drug) {", y_function_D_formicigenerans_Dienestrol, "}")))
y_function_E_coli_Dienestrol_func <- eval(parse(text = paste("function(Drug) {", y_function_E_coli_Dienestrol, "}")))
y_function_V_parvula_Dienestrol_func <- eval(parse(text = paste("function(Drug) {", y_function_V_parvula_Dienestrol, "}")))



unique(combined_monoculture_aucs2_Dienestrol$conc)
##dictate drug concentration tested for simulation cycle here:
#drug_concentration_tested <- 5 #if manually or:
drug_concentration_tested <- unique(combined_monoculture_aucs2_Dienestrol$conc)[1] 
initial_conditions <- rep(0.01/32, 32)
initial_conditions <- c(initial_conditions, drug_concentration_tested)


##drug effect fitted for species showing sensitivity in monoculture:
#unique(combined_monoculture_aucs2_Dienestrol$Species)

##for more simple linear fits
closed.sir.model_Dienestrol <- function (t, x, params) {
  ## first extract the state variables
  A_muciniphila <- x[1]
  B_adolescentis <- x[2]
  B_fragilis <- x[3]
  B_longum <- x[4]
  B_obeum <- x[5]
  B_thetaiotaomicron <- x[6]
  B_uniformis <- x[7]
  B_vulgatus <- x[8]
  B_wadsworthia <- x[9]
  C_aerofaciens <- x[10]
  C_bolteae <- x[11]
  C_comes <- x[12]
  C_perfringens <- x[13]
  C_ramosum <- x[14]
  C_saccharolyticum <- x[15]
  D_formicigenerans <- x[16]
  E_coli <- x[17]
  E_lenta <- x[18]
  E_rectale <- x[19]
  F_nucleatum <- x[20]
  L_paracasei <- x[21]
  O_splanchnicus <- x[22]
  P_copri <- x[23]
  P_distasonis <- x[24]
  P_merdae <- x[25]
  R_bromii <- x[26]
  R_gnavus <- x[27]
  R_intestinalis <- x[28]
  R_torques <- x[29]
  S_parasanguinis <- x[30]
  S_salivarius <- x[31]
  V_parvula <- x[32]
  Drug <- x[33]
  
  
  ## now extract the parameters
  r_B_fragilis <- flat_params[["B._fragilis.r"]]
  K_B_fragilis <- flat_params[["B._fragilis.K"]]
  r_B_longum <- flat_params[["B._longum.r"]]
  K_B_longum <- flat_params[["B._longum.K"]]
  r_B_thetaiotaomicron <- flat_params[["B._thetaiotaomicron.r"]]
  K_B_thetaiotaomicron <- flat_params[["B._thetaiotaomicron.K"]]
  r_B_uniformis <- flat_params[["B._uniformis.r"]]
  K_B_uniformis <- flat_params[["B._uniformis.K"]]
  r_B_vulgatus <- flat_params[["B._vulgatus.r"]]
  K_B_vulgatus <- flat_params[["B._vulgatus.K"]]
  r_B_wadsworthia <- flat_params[["B._wadsworthia.r"]]
  K_B_wadsworthia <- flat_params[["B._wadsworthia.K"]]
  r_C_aerofaciens <- flat_params[["C._aerofaciens.r"]]
  K_C_aerofaciens <- flat_params[["C._aerofaciens.K"]]
  r_C_bolteae <- flat_params[["C._bolteae.r"]]
  K_C_bolteae <- flat_params[["C._bolteae.K"]]
  r_C_comes <- flat_params[["C._comes.r"]]
  K_C_comes <- flat_params[["C._comes.K"]]
  r_C_perfringens <- flat_params[["C._perfringens.r"]]
  K_C_perfringens <- flat_params[["C._perfringens.K"]]
  r_C_ramosum <- flat_params[["C._ramosum.r"]]
  K_C_ramosum <- flat_params[["C._ramosum.K"]]
  r_C_saccharolyticum <- flat_params[["C._saccharolyticum.r"]]
  K_C_saccharolyticum <- flat_params[["C._saccharolyticum.K"]]
  r_D_formicigenerans <- flat_params[["D._formicigenerans.r"]]
  K_D_formicigenerans <- flat_params[["D._formicigenerans.K"]]
  r_E_coli <- flat_params[["E._coli.r"]]
  K_E_coli <- flat_params[["E._coli.K"]]
  r_E_lenta <- flat_params[["E._lenta.r"]]
  K_E_lenta <- flat_params[["E._lenta.K"]]
  r_E_rectale <- flat_params[["E._rectale.r"]]
  K_E_rectale <- flat_params[["E._rectale.K"]]
  r_F_nucleatum <- flat_params[["F._nucleatum.r"]]
  K_F_nucleatum <- flat_params[["F._nucleatum.K"]]
  r_P_copri <- flat_params[["P._copri.r"]]
  K_P_copri <- flat_params[["P._copri.K"]]
  r_P_merdae <- flat_params[["P._merdae.r"]]
  K_P_merdae <- flat_params[["P._merdae.K"]]
  r_R_gnavus <- flat_params[["R._gnavus.r"]]
  K_R_gnavus <- flat_params[["R._gnavus.K"]]
  r_R_intestinalis <- flat_params[["R._intestinalis.r"]]
  K_R_intestinalis <- flat_params[["R._intestinalis.K"]]
  r_V_parvula <- flat_params[["V._parvula.r"]]
  K_V_parvula <- flat_params[["V._parvula.K"]]
  r_A_muciniphila <- flat_params[["A._muciniphila.r"]]
  K_A_muciniphila <- flat_params[["A._muciniphila.K"]]
  r_B_adolescentis <- flat_params[["B._adolescentis.r"]]
  K_B_adolescentis <- flat_params[["B._adolescentis.K"]]
  r_B_obeum <- flat_params[["B._obeum.r"]]
  K_B_obeum <- flat_params[["B._obeum.K"]]
  r_O_splanchnicus <- flat_params[["O._splanchnicus.r"]]
  K_O_splanchnicus <- flat_params[["O._splanchnicus.K"]]
  r_P_distasonis <- flat_params[["P._distasonis.r"]]
  K_P_distasonis <- flat_params[["P._distasonis.K"]]
  r_R_bromii <- flat_params[["R._bromii.r"]]
  K_R_bromii <- flat_params[["R._bromii.K"]]
  r_R_torques <- flat_params[["R._torques.r"]]
  K_R_torques <- flat_params[["R._torques.K"]]
  r_S_parasanguinis <- flat_params[["S._parasanguinis.r"]]
  K_S_parasanguinis <-flat_params[["S._parasanguinis.K"]]
  r_S_salivarius <- flat_params[["S._salivarius.r"]]
  K_S_salivarius <- flat_params[["S._salivarius.K"]]
  r_L_paracasei <- flat_params[["L._paracasei.r"]]
  K_L_paracasei <- flat_params[["L._paracasei.K"]]
  
  
  t_mod <- ifelse(t > 24.1, t - 24.1, t)
  
  
  ## now code the model equations
  dA_muciniphila_dt <- r_A_muciniphila * A_muciniphila * (1 - A_muciniphila / K_A_muciniphila)
  dB_adolescentis_dt <- r_B_adolescentis * B_adolescentis * (1 - B_adolescentis / K_B_adolescentis)
  dB_fragilis_dt <- r_B_fragilis * B_fragilis * (1 - B_fragilis / max(0.0001, K_B_fragilis * (y_function_B_fragilis_Dienestrol_func(Drug))))
  dB_longum_dt <- r_B_longum * B_longum * (1 - B_longum / K_B_longum)
  dB_obeum_dt <- r_B_obeum * B_obeum * (1 - B_obeum / K_B_obeum)
  dB_thetaiotaomicron_dt <- r_B_thetaiotaomicron * B_thetaiotaomicron * (1 - B_thetaiotaomicron / max(0.0001, K_B_thetaiotaomicron * (y_function_B_thetaiotaomicron_Dienestrol_func(Drug))))  
  dB_uniformis_dt <- r_B_uniformis * B_uniformis * (1 - B_uniformis / max(0.0001, K_B_uniformis * (y_function_B_uniformis_Dienestrol_func(Drug))))
  dB_vulgatus_dt <- r_B_vulgatus * B_vulgatus * (1 - B_vulgatus / max(0.0001, K_B_vulgatus * (y_function_B_vulgatus_Dienestrol_func(Drug))))
  dB_wadsworthia_dt <- r_B_wadsworthia * B_wadsworthia * (1 - B_wadsworthia / K_B_wadsworthia)
  dC_aerofaciens_dt <- r_C_aerofaciens * C_aerofaciens * (1 - C_aerofaciens / max(0.0001, K_C_aerofaciens * (y_function_C_aerofaciens_Dienestrol_func(Drug))))
  dC_bolteae_dt <- r_C_bolteae * C_bolteae * (1 - C_bolteae /  max(0.0001, K_C_bolteae * (y_function_C_bolteae_Dienestrol_func(Drug))))
  dC_comes_dt <- r_C_comes * C_comes * (1 - C_comes / max(0.0001, K_C_comes * (y_function_C_comes_Dienestrol_func(Drug))))
  dC_perfringens_dt <- r_C_perfringens * C_perfringens * (1 - C_perfringens / max(0.0001, K_C_perfringens * (y_function_C_perfringens_Dienestrol_func(Drug))))
  dC_ramosum_dt <- r_C_ramosum * C_ramosum * (1 - C_ramosum / max(0.0001, K_C_ramosum * (y_function_C_ramosum_Dienestrol_func(Drug))))
  dC_saccharolyticum_dt <- r_C_saccharolyticum * C_saccharolyticum * (1 - C_saccharolyticum / max(0.0001, K_C_saccharolyticum * (y_function_C_saccharolyticum_Dienestrol_func(Drug))))
  dD_formicigenerans_dt <- r_D_formicigenerans * D_formicigenerans * (1 - D_formicigenerans / max(0.0001, K_D_formicigenerans * (y_function_D_formicigenerans_Dienestrol_func(Drug))))
  dE_coli_dt <- r_E_coli * E_coli * (1 - E_coli / max(0.0001, K_E_coli * (y_function_E_coli_Dienestrol_func(Drug))))
  dE_lenta_dt <- r_E_lenta * E_lenta * (1 - E_lenta / max(0.0001, K_E_lenta * (y_function_E_lenta_Dienestrol_func(Drug))))
  dE_rectale_dt <- r_E_rectale * E_rectale * (1 - E_rectale / max(0.0001, K_E_rectale * (y_function_E_rectale_Dienestrol_func(Drug))))
  dF_nucleatum_dt <- r_F_nucleatum * F_nucleatum * (1 - F_nucleatum / max(0.0001, K_F_nucleatum * (y_function_F_nucleatum_Dienestrol_func(Drug))))
  dL_paracasei_dt <- r_L_paracasei * L_paracasei * (1 - L_paracasei / K_L_paracasei)  
  dO_splanchnicus_dt <- r_O_splanchnicus * O_splanchnicus * (1 - O_splanchnicus / K_O_splanchnicus)  
  dP_copri_dt <- r_P_copri * P_copri * (1 - P_copri / K_P_copri)
  dP_distasonis_dt <- r_P_distasonis * P_distasonis * (1 - P_distasonis / K_P_distasonis)  
  dP_merdae_dt <- r_P_merdae * P_merdae * (1 - P_merdae / max(0.0001, K_P_merdae * (y_function_P_merdae_Dienestrol_func(Drug))))
  dR_bromii_dt <- r_R_bromii * R_bromii * (1 - R_bromii / K_R_bromii) 
  dR_gnavus_dt <- r_R_gnavus * R_gnavus * (1 - R_gnavus / max(0.0001, K_R_gnavus * (y_function_R_gnavus_Dienestrol_func(Drug))))
  dR_intestinalis_dt <- r_R_intestinalis * R_intestinalis * (1 - R_intestinalis / max(0.0001, K_R_intestinalis * (y_function_R_intestinalis_Dienestrol_func(Drug))))
  dR_torques_dt <- r_R_torques * R_torques * (1 - R_torques /K_R_torques) 
  dS_parasanguinis_dt <- r_S_parasanguinis * S_parasanguinis * (1 - S_parasanguinis / max(0.0001, K_S_parasanguinis * (y_function_S_parasanguinis_Dienestrol_func(Drug))))
  dS_salivarius_dt <- r_S_salivarius * S_salivarius * (1 - S_salivarius / max(0.0001, K_S_salivarius * (y_function_S_salivarius_Dienestrol_func(Drug))))
  dV_parvula_dt <- r_V_parvula * V_parvula * (1 - V_parvula / max(0.0001, K_V_parvula * (y_function_V_parvula_Dienestrol_func(Drug))))
  
  
  
  #Drug differential:
  dDrug_dt <- (subset(drug_dynamics, Drug == "Dienestrol")$Steepness_param_community * exp(-subset(drug_dynamics, Drug == "Dienestrol")$Steepness_param_community * t_mod)) * (drug_concentration_tested * prop_left_Dienestrol - drug_concentration_tested)
  #dDrug_dt <- 0
  
  ## Combine results into a single vector
  dxdt <- c(dA_muciniphila_dt, dB_adolescentis_dt, dB_fragilis_dt, dB_longum_dt, dB_obeum_dt, dB_thetaiotaomicron_dt, dB_uniformis_dt, dB_vulgatus_dt, dB_wadsworthia_dt, dC_aerofaciens_dt, dC_bolteae_dt, dC_comes_dt, dC_perfringens_dt, dC_ramosum_dt, dC_saccharolyticum_dt, dD_formicigenerans_dt, dE_coli_dt, dE_lenta_dt, dE_rectale_dt, dF_nucleatum_dt, dL_paracasei_dt, dO_splanchnicus_dt, dP_copri_dt, dP_distasonis_dt, dP_merdae_dt, dR_bromii_dt, dR_gnavus_dt, dR_intestinalis_dt, dR_torques_dt, dS_parasanguinis_dt, dS_salivarius_dt, dV_parvula_dt, dDrug_dt)
  
  ## Return result as a list
  list(dxdt)
}




#calculate the co-culture correction factor per species based on community composition in absence of drug, just like done for Niclosamide

growth_data_all_0_Niclosamide
growth_data_all_0_Niclosamide1 <- growth_data_all_0_Niclosamide %>%
  dplyr::mutate(Species = gsub(" ", "_", Species))


# Merge rel_ab_control with growth_data_all_0_Niclosamide on Species
# Function to remove duplicated columns by name pattern
clean_columns_base <- function(df, pattern) {
  cols_to_keep <- !grepl(pattern, names(df))
  df <- df[, cols_to_keep]
  return(df)
}

# Use the new function to clean up your dataframe
rel_ab_control <- clean_columns_base(rel_ab_control, "mean_max_OD.[xy]")
str(rel_ab_control)


#rel_ab_control$correction_factor <- rel_ab_control$mean_rel_ab / (rel_ab_control$mean_max_OD/sum(rel_ab_control$mean_max_OD))
# Calculate correction factor with a minimum value of ~1
rel_ab_control$correction_factor <- pmax(rel_ab_control$mean_rel_ab / (rel_ab_control$mean_max_OD / sum(rel_ab_control$mean_max_OD)), 1.1)


# Create a new dataframe for co-culture correction
co_culture_correction <- data.frame(
  species = rel_ab_control$Species,
  correction_factor = rel_ab_control$correction_factor
)


#summarise community data
#Adjust based on tested concentrations for each drug
unique(Community_compositions_focus_drugs_Dienestrol$concentration)

Community_compositions_focus_drugs_Dienestrol_5uM <- subset(Community_compositions_focus_drugs_Dienestrol, concentration == 5)
Community_compositions_focus_drugs_Dienestrol_20uM <- subset(Community_compositions_focus_drugs_Dienestrol, concentration == 20)
Community_compositions_focus_drugs_Dienestrol_80uM <- subset(Community_compositions_focus_drugs_Dienestrol, concentration == 80)


#5 uM
Community_compositions_focus_drugs_Dienestrol_5uM_summarised <- Community_compositions_focus_drugs_Dienestrol_5uM %>%
  dplyr::group_by(species) %>%                                  
  dplyr::summarize(
    mean_rel_ab = mean(rel_abundance, na.rm = TRUE),     
    sd_rel_ab = sd(rel_abundance, na.rm = TRUE) ,
    mean_max_OD = mean(maxOD, na.rm = TRUE),
    sd_max_OD = sd(maxOD, na.rm = TRUE),
    mean_final_OD = mean(finalOD, na.rm = TRUE),
    sd_final_OD = sd(finalOD, na.rm = TRUE)
  ) %>%
  dplyr::ungroup() 


Community_compositions_focus_drugs_Dienestrol_5uM_summarised <- Community_compositions_focus_drugs_Dienestrol_5uM_summarised %>%
  dplyr::mutate(Species = sub("^(\\w)\\w*\\s(.*)", "\\1._\\2", species))

#remove (sub)strain info
Community_compositions_focus_drugs_Dienestrol_5uM_summarised <- Community_compositions_focus_drugs_Dienestrol_5uM_summarised %>%
  dplyr::mutate(Species = sub("^(\\w\\._\\w+).*", "\\1", Species))


#20 uM
Community_compositions_focus_drugs_Dienestrol_20uM_summarised <- Community_compositions_focus_drugs_Dienestrol_20uM %>%
  dplyr::group_by(species) %>%                                  
  dplyr::summarize(
    mean_rel_ab = mean(rel_abundance, na.rm = TRUE),     
    sd_rel_ab = sd(rel_abundance, na.rm = TRUE) ,
    mean_max_OD = mean(maxOD, na.rm = TRUE),
    sd_max_OD = sd(maxOD, na.rm = TRUE),
    mean_final_OD = mean(finalOD, na.rm = TRUE),
    sd_final_OD = sd(finalOD, na.rm = TRUE)
  ) %>%
  dplyr::ungroup() 


Community_compositions_focus_drugs_Dienestrol_20uM_summarised <- Community_compositions_focus_drugs_Dienestrol_20uM_summarised %>%
  dplyr::mutate(Species = sub("^(\\w)\\w*\\s(.*)", "\\1._\\2", species))

#remove (sub)strain info
Community_compositions_focus_drugs_Dienestrol_20uM_summarised <- Community_compositions_focus_drugs_Dienestrol_20uM_summarised %>%
  dplyr::mutate(Species = sub("^(\\w\\._\\w+).*", "\\1", Species))


#80 uM
Community_compositions_focus_drugs_Dienestrol_80uM_summarised <- Community_compositions_focus_drugs_Dienestrol_80uM %>%
  dplyr::group_by(species) %>%                                  
  dplyr::summarize(
    mean_rel_ab = mean(rel_abundance, na.rm = TRUE),     
    sd_rel_ab = sd(rel_abundance, na.rm = TRUE) ,
    mean_max_OD = mean(maxOD, na.rm = TRUE),
    sd_max_OD = sd(maxOD, na.rm = TRUE),    
    mean_final_OD = mean(finalOD, na.rm = TRUE),
    sd_final_OD = sd(finalOD, na.rm = TRUE)
  ) %>%
  dplyr::ungroup() 



Community_compositions_focus_drugs_Dienestrol_80uM_summarised <- Community_compositions_focus_drugs_Dienestrol_80uM_summarised %>%
  dplyr::mutate(Species = sub("^(\\w)\\w*\\s(.*)", "\\1._\\2", species))

#remove (sub)strain info
Community_compositions_focus_drugs_Dienestrol_80uM_summarised <- Community_compositions_focus_drugs_Dienestrol_80uM_summarised %>%
  dplyr::mutate(Species = sub("^(\\w\\._\\w+).*", "\\1", Species))


#Initialise data frames
sim_output <- data.frame()
input_params_list <- list() #Use a list to collect parameters for each simulation

#number of simulations
num_sims <- 250


for (i in 1:num_sims) {
  tryCatch({
    # generate model parameters
    set.seed(i) #set a different seed for each simulation for variation
    params <- lapply(1:nrow(growth_data_all_0_Niclosamide), function(idx) {
      species_params <- growth_data_all_0_Niclosamide[idx, ]
      list(
        r = rnorm(1, mean = species_params$mean_max_Growth_rate, sd = species_params$sd_max_Growth_rate),
        K = rnorm(1, mean = species_params$mean_max_OD, sd = species_params$sd_max_OD)
      )
    })
    names(params) <- gsub(" ", "_", growth_data_all_0_Niclosamide$Species)
    flat_params <- unlist(params)
    names(flat_params) <- gsub("\\.\\d$", "", names(flat_params))
    
    #replace spaces with underscores to match formatting
    co_culture_correction$species <- gsub(" ", "_", co_culture_correction$species, fixed = TRUE)
    
    #replace the species-specific K parameters extracted from monoculture growth data 
    #with drawn relative abundance values at Niclosamide = 0, scaled to K
    rel_ab_control$Species <- gsub(" ", "_", rel_ab_control$Species)
    
    #Initialise an empty vector to store drawn values
    drawn_values <- numeric(nrow(rel_ab_control))
    
    #draw values from their respective distributions
    for (k in 1:nrow(rel_ab_control)) {
      species_name <- rel_ab_control$Species[k]
      drawn_value <- rnorm(1, mean = rel_ab_control$mean_rel_ab[k], sd = rel_ab_control$sd_rel_ab[k])
      drawn_values[k] <- max(drawn_value, 0)  # Ensure no negative values
    }
    
    #Normalise drawn relative abundance values so they sum to 1 (to reflect a 'true' relative abundance distribution)
    #this is needed so when we convert the values into OD units by multiplying with the drawn community maxOD,
    # the sum of K_i parameters and the drawn K are equal
    normalised_values <- drawn_values / sum(drawn_values)
    
    #Pull community maxOD (K) at 0 drugs from respective normal distribution:
    K <- rnorm(n = 1, mean = rel_ab_control$mean_com_max_OD[1], sd = rel_ab_control$sd_com_max_OD[1])
    
    # Assign these normalised values to their respective species' .K parameters
    for (k in 1:nrow(rel_ab_control)) {
      species_name <- rel_ab_control$Species[k]
      k_index <- grep(paste0("^", species_name, "\\.K$"), names(flat_params))
      
      if (length(k_index) > 0) {
        old_value <- flat_params[k_index]
        flat_params[k_index] <- (normalised_values[k] + 0.0001) * K #add small value in case drawn K_i is 0, which would cause issues with the solver
        cat(sprintf("Updated %s from %f to %f using normalised value %f scaled by K %f\n", names(flat_params)[k_index], old_value, flat_params[k_index], normalised_values[k], K))
      }
    }
    
    #Accounting for variation in drug degradation by community, with standard deviation of end concentration (at 10h) around the fitted predicted (relative) end concentration at 24h
    #prop_left_Dienestrol <- abs(rnorm(1, (subset(drug_dynamics, Drug == "Dienestrol")$Prop_left_24h_community), (subset(drug_dynamics, Drug == "Dienestrol")$SD_drug_community))) 
    #below, we account for measurement error rather than ecological drivers that lead to the variability of degradation at the final point measured 
    prop_left_Dienestrol <- abs(rnorm(
      n = 1, 
      mean = subset(drug_dynamics, Drug == "Dienestrol")$Prop_left_24h_community, 
      sd = ifelse(
        subset(drug_dynamics, Drug == "Dienestrol")$SD_drug_community > subset(drug_dynamics, Drug == "Dienestrol")$SD_drug_community_start, 
        subset(drug_dynamics, Drug == "Dienestrol")$SD_drug_community - subset(drug_dynamics, Drug == "Dienestrol")$SD_drug_community_start, 
        subset(drug_dynamics, Drug == "Dienestrol")$SD_drug_community
      )
    ))
    
    
    #loop through each species in co_culture_correction
    for (j in 1:nrow(co_culture_correction)) {
      # Extract the species name and correction factor
      species_name <- co_culture_correction$species[j]
      correction_factor <- co_culture_correction$correction_factor[j]
      
      # Identify the corresponding growth rate parameter in flat_params
      #by matching the base species name (without .r)
      growth_rate_indices <- grep(paste0("^", species_name, "\\.r$"), names(flat_params))
      
      #take the growth rate parameter and apply the correction factor 
      for (index in growth_rate_indices) {
        flat_params[index] <- flat_params[index] * correction_factor
      }
    }
    
    flat_params
    # Store parameters for each simulation
    input_params_list[[i]] <- c(sim_ID = i, flat_params)
    
    # Run the model for the first 24-hour cycle
    solution_cycle_1 <- ode(y = initial_conditions, times = seq(from = 0, to = 24, by = 0.1), func = closed.sir.model_Dienestrol, parms = flat_params,   method = "lsoda", rtol = 1e-6, atol = 1e-6)
    
    # Dilution and second cycle
    end_of_cycle_1 <- solution_cycle_1[nrow(solution_cycle_1), -1]
    initial_conditions_cycle_2 <- end_of_cycle_1 / 50
    #accounting for the drugs being added with the new growth cycle as well:
    initial_conditions_cycle_2[33] <- initial_conditions_cycle_2[33] + drug_concentration_tested
    solution_cycle_2 <- ode(y = initial_conditions_cycle_2, times = seq(from = 24, to = 48, by = 0.1), func = closed.sir.model_Dienestrol, parms = flat_params,  method = "lsoda", rtol = 1e-6, atol = 1e-6)
    
    # Combine and format results
    combined_solution <- rbind(as.data.frame(solution_cycle_1), as.data.frame(solution_cycle_2)[-1,])
    combined_solution$sim_ID <- rep(i, nrow(combined_solution))
    combined_solution <- combined_solution %>%
      tidyr::gather(key = "Species", value = "Density", -time, -sim_ID) %>%
      dplyr::mutate(Hour = time) %>%
      dplyr::select(sim_ID, Hour, Species, Density)
    
    ##Append to sim_output
    sim_output <- rbind(sim_output, combined_solution)
  }, error = function(e) {
    cat(sprintf("Skipping simulation %d due to an error: %s\n", i, e$message))
  })
}



##Combine all parameter data into a single dataframe
input_params <- do.call(rbind, input_params_list)

# Add a "Species" column 
sim_output$Species_name <- species_names[as.numeric(as.character(sim_output$Species))]
sim_output$Species_name <- replace_na(sim_output$Species_name, "Drug")

#View(input_params)
#View(sim_output)

sim_output <- na.omit(sim_output)
successful_sim_ids <- unique(subset(sim_output, Hour == 48)$sim_ID)
length(successful_sim_ids)
sim_output1 <- sim_output[sim_output$sim_ID %in% successful_sim_ids, ]


#Transform sim_output so we have wide format by Species
sim_output_wide <- tidyr::pivot_wider(sim_output1, 
                                      names_from = Species_name, 
                                      values_from = Density,
                                      id_cols = c(sim_ID, Hour))

length(unique(sim_output_wide$sim_ID))
#calc community OD per timepoint
sim_output_wide$Total_OD <- rowSums(sim_output_wide[, 3:34], na.rm = TRUE)
#calculate and add relative abundances here as well:
species_columns <- colnames(sim_output_wide)[3:34] 

for (species in species_columns) {
  sim_output_wide[[paste0("rel_", species)]] <- sim_output_wide[[species]] / sim_output_wide$Total_OD
}


#assign sim_output_wide test conditions to dataframe name
drug_tested <- "Dienestrol"
variable_name_1 <- paste0("sim_output_wide_", ifelse(drug_concentration_tested == 1e-04, 0, drug_concentration_tested), "_", drug_tested)
assign(variable_name_1, sim_output_wide)

#turn back into long format if interested in plotting relative abundances
cols_needed <- c("sim_ID", "Hour")

sim_output_long <- sim_output_wide %>% 
  dplyr::select(sim_ID, Hour, Drug, starts_with("rel_")) %>% 
  tidyr::pivot_longer(
    cols = c(Drug, starts_with("rel_")),
    names_to = "Species", 
    values_to = "Relative_abundance",
    names_prefix = "rel_",
    names_transform = list(Species = ~ ifelse(.x == "Drug", "Drug", .x))
  ) 

str(sim_output_long)


species_names_1 <- c(
  "A_muciniphila",
  "B_adolescentis",
  "B_fragilis",
  "B_longum",
  "B_obeum",
  "B_thetaiotaomicron",
  "B_uniformis",
  "B_vulgatus",
  "B_wadsworthia",
  "C_aerofaciens",
  "C_bolteae",
  "C_comes",
  "C_perfringens",
  "C_ramosum",
  "C_saccharolyticum",
  "D_formicigenerans",
  "E_coli",
  "E_lenta",
  "E_rectale",
  "F_nucleatum",
  "L_paracasei",
  "O_splanchnicus",
  "P_copri",
  "P_distasonis",
  "P_merdae",
  "R_bromii",
  "R_gnavus",
  "R_intestinalis",
  "R_torques",
  "S_parasanguinis",
  "S_salivarius",
  "V_parvula",
  "Drug"
)

species_colours_1 <- c(
  "A_muciniphila" = "#1f77b4",
  "B_adolescentis" = "#ff7f0e",
  "B_fragilis" = "#2ca02c",
  "B_longum" = "#d62728",
  "B_obeum" = "#9467bd",
  "B_thetaiotaomicron" = "black",
  "B_uniformis" = "#e377c2",
  "B_vulgatus" = "#7f7f7f",
  "B_wadsworthia" = "gold1",
  "C_aerofaciens" = "#aec7e8",
  "C_bolteae" = "#ffbb78",
  "C_comes" = "magenta",
  "C_perfringens" = "#ff9896",
  "C_ramosum" = "#c5b0d5",
  "C_saccharolyticum" = "#c49c94",
  "D_formicigenerans" = "#f7b6d2",
  "E_coli" = "yellow",
  "E_lenta" = "turquoise",
  "E_rectale" = "#393b79",
  "F_nucleatum" = "royalblue2",
  "L_paracasei" = "blue",
  "O_splanchnicus" = "#637939",
  "P_copri" = "cyan",
  "P_distasonis" = "#8c6d31",
  "P_merdae" = "#c7c7c7",
  "R_bromii" = "#e6550d",
  "R_gnavus" = "#e7cb94",
  "R_intestinalis" = "#843c39",
  "R_torques" = "#d6616b",
  "S_parasanguinis" = "orange3",
  "S_salivarius" = "#7b4173",
  "V_parvula" = "#ce6dbd",
  "Drug" = "green"
)



##Plot output for any specific sim:
# ggplot(subset(sim_output, sim_ID == 1 & Species_name != "Drug"), aes(x = Hour, y = Density, group = Species_name, color = Species_name)) +
#   geom_line(size = 1, alpha = 0.7) +
#   scale_color_manual(values = species_colours_1) +
#   labs(title = paste0("Dienestrol = ", drug_concentration_tested),
#        x = "Time (hours)",
#        y = "Population Density (OD)",
#        color = "Species") +
#   theme_minimal() +
#   theme(legend.position = "right")
# 
# ggplot(subset(sim_output, sim_ID == 3 & Species_name != "Drug"), aes(x = Hour, y = Density, group = Species_name, color = Species_name)) +
#   geom_line(size = 1, alpha = 0.7) +
#   scale_color_manual(values = species_colours_1) +
#   labs(title = paste0("Dienestrol = ", drug_concentration_tested),
#        x = "Time (hours)",
#        y = "Population Density (OD)",
#        color = "Species") +
#   theme_minimal() +
#   theme(legend.position = "right")


ggplot(subset(sim_output_long, sim_ID == 1), aes(x = Hour, y = Relative_abundance, group = Species, color = Species)) +
  geom_line(size = 1, alpha = 0.7) +
  scale_color_manual(values = species_colours_1) +
  labs(title = paste0("Dienestrol = ", drug_concentration_tested),
       x = "Time (hours)",
       y = "Relative abundance",
       color = "Species") +
  theme_minimal() +
  theme(legend.position = "right")


ggplot(subset(sim_output_long, sim_ID == 3), aes(x = Hour, y = Relative_abundance, group = Species, color = Species)) +
  geom_line(size = 1, alpha = 0.7) +
  scale_color_manual(values = species_colours_1) +
  labs(title = paste0("Dienestrol = ", drug_concentration_tested),
       x = "Time (hours)",
       y = "Relative abundance",
       color = "Species") +
  theme_minimal() +
  theme(legend.position = "right")


#calc mean and standard deviation across sims
sim_stats <- sim_output_long %>%
  dplyr::group_by(Hour, Species) %>%
  dplyr::summarise(
    mean_rel_ab = mean(Relative_abundance),
    sd_rel_ab = sd(Relative_abundance),
    .groups = 'drop'
  )

# Prepare the data for plotting
plot_data <- sim_stats %>%
  dplyr::mutate(Upper = mean_rel_ab + sd_rel_ab, Lower = mean_rel_ab - sd_rel_ab)

ggplot(subset(plot_data, Species != "Drug"), aes(x = Hour, y = mean_rel_ab, group = Species, color = Species)) +
  geom_ribbon(aes(ymin = Lower, ymax = Upper, fill = Species), colour = NA, alpha = 0.2) +  
  geom_line(size = 1, alpha = 0.7) + 
  scale_color_manual(values = species_colours_1) +
  scale_fill_manual(values = species_colours_1) +  
  labs(title = "Mean and SD of Relative Abundance Across Simulations",
       subtitle = paste0("Dienestrol = ", drug_concentration_tested),       
       x = "Time (hours)",
       y = "Relative abundance",
       color = "Species",
       fill = "Species") +
  theme_minimal() +
  theme(legend.position = "right")

#log-scaled mean trends
ggplot(plot_data, aes(x = Hour, y = log10(mean_rel_ab + 0.0001), group = Species, color = Species)) +
  geom_line(size = 1, alpha = 0.7) +  # Mean line
  scale_color_manual(values = species_colours_1) +
  scale_fill_manual(values = species_colours_1) +  # Ensure consistent colors for lines and fills
  labs(title = "Mean and SD of Relative Abundance Across Simulations",
       subtitle = paste0("Dienestrol = ", drug_concentration_tested),
       x = "Time (hours)",
       y = "Relative abundance",
       color = "Species",
       fill = "Species") +
  theme_minimal() +
  theme(legend.position = "right")




##prediction quality evaluation
drug_tested <- "Dienestrol"
variable_name <- paste0("plot_data_", ifelse(drug_concentration_tested == 1e-04, 0, drug_concentration_tested), "_", drug_tested)
assign(variable_name, plot_data)


#extract total OD info:
predicted_mean_final_od_NULL <- Niclosamide_16S_0uM_summarised$mean_com_final_OD[1]
predicted_sd_final_od_NULL <- Niclosamide_16S_0uM_summarised$sd_com_final_OD[1]

predicted_mean_final_od_5_Dienestrol <- mean(subset(sim_output_wide_5_Dienestrol, Hour == 48)$Total_OD, na.rm = TRUE)
predicted_sd_final_od_5_Dienestrol <- sd(subset(sim_output_wide_5_Dienestrol, Hour == 48)$Total_OD, na.rm = TRUE)

real_mean_final_od_5_Dienestrol <- Community_compositions_focus_drugs_Dienestrol_5uM_summarised$mean_final_OD[1]
real_sd_final_od_5_Dienestrol <- Community_compositions_focus_drugs_Dienestrol_5uM_summarised$sd_final_OD[1]


predicted_mean_final_od_20_Dienestrol <- mean(subset(sim_output_wide_20_Dienestrol, Hour == 48)$Total_OD, na.rm = TRUE)
predicted_sd_final_od_20_Dienestrol <- sd(subset(sim_output_wide_20_Dienestrol, Hour == 48)$Total_OD, na.rm = TRUE)

real_mean_final_od_20_Dienestrol <- Community_compositions_focus_drugs_Dienestrol_20uM_summarised$mean_final_OD[1]
real_sd_final_od_20_Dienestrol <- Community_compositions_focus_drugs_Dienestrol_20uM_summarised$sd_final_OD[1]


predicted_mean_final_od_80_Dienestrol <- mean(subset(sim_output_wide_80_Dienestrol, Hour == 48)$Total_OD, na.rm = TRUE)
predicted_sd_final_od_80_Dienestrol <- sd(subset(sim_output_wide_80_Dienestrol, Hour == 48)$Total_OD, na.rm = TRUE)

real_mean_final_od_80_Dienestrol <- Community_compositions_focus_drugs_Dienestrol_80uM_summarised$mean_final_OD[1]
real_sd_final_od_80_Dienestrol <- Community_compositions_focus_drugs_Dienestrol_80uM_summarised$sd_final_OD[1]




#plot_data_0_Dienestrol_endpoint was used to test model performance at 0 drugs
#plot_data_0_Dienestrol_endpoint <- subset(plot_data_0_Dienestrol, Hour == 48 & Species != "Drug")
plot_data_5_Dienestrol_endpoint <- subset(plot_data_5_Dienestrol, Hour == 48 & Species != "Drug")
plot_data_20_Dienestrol_endpoint <- subset(plot_data_20_Dienestrol, Hour == 48 & Species != "Drug")
plot_data_80_Dienestrol_endpoint <- subset(plot_data_80_Dienestrol, Hour == 48 & Species != "Drug")

##Inspecting 'match' to real relative abundance distributions:
Niclosamide_16S_0uM_summarised <- rel_ab_control
Niclosamide_16S_0uM_summarised$Species <- gsub("\\.", "", Niclosamide_16S_0uM_summarised$Species)

Dienestrol_16S_5uM_summarised <- Community_compositions_focus_drugs_Dienestrol_5uM_summarised
Dienestrol_16S_20uM_summarised <- Community_compositions_focus_drugs_Dienestrol_20uM_summarised
Dienestrol_16S_80uM_summarised <- Community_compositions_focus_drugs_Dienestrol_80uM_summarised

Niclosamide_16S_0uM_summarised
Dienestrol_16S_5uM_summarised 
Dienestrol_16S_20uM_summarised 
Dienestrol_16S_80uM_summarised 

#Rename 'species' so the outputs become comparable
original_names_80 <- unique(Dienestrol_16S_80uM_summarised$species)
original_names_20 <- unique(Dienestrol_16S_20uM_summarised$species)
original_names_5 <- unique(Dienestrol_16S_5uM_summarised$species)


##Create a named vector with the original and new names mapping
name_changes <- c(
  "Akkermansia muciniphila" = "A_muciniphila",
  "Bacteroides fragilis" = "B_fragilis",
  "Bacteroides thetaiotaomicron" = "B_thetaiotaomicron",
  "Bacteroides uniformis" = "B_uniformis",
  "Bifidobacterium adolescentis" = "B_adolescentis",
  "Bifidobacterium longum subsp. longum" = "B_longum",
  "Bilophila wadsworthia" = "B_wadsworthia",
  "Blautia obeum" = "B_obeum",
  "Clostridium perfringens" = "C_perfringens",
  "Collinsella aerofaciens" = "C_aerofaciens",
  "Coprococcus comes" = "C_comes",
  "Dorea formicigenerans" = "D_formicigenerans",
  "Eggerthella lenta" = "E_lenta",
  "Enterocloster bolteae" = "C_bolteae",
  "Erysipelatoclostridium ramosum" = "C_ramosum",
  "Escherichia coli ED1a" = "E_coli",
  "Eubacterium rectale" = "E_rectale",
  "Fusobacterium nucleatum subsp. nucleatum" = "F_nucleatum",
  "Lacrimispora saccharolytica" = "C_saccharolyticum",
  "Lacticaseibacillus paracasei" = "L_paracasei",
  "Odoribacter splanchnicus" = "O_splanchnicus",
  "Parabacteroides distasonis" = "P_distasonis",
  "Parabacteroides merdae" = "P_merdae",
  "Phocaeicola vulgatus" = "B_vulgatus",
  "Prevotella copri" = "P_copri",
  "Roseburia intestinalis" = "R_intestinalis",
  "Ruminococcus bromii" = "R_bromii",
  "Ruminococcus gnavus" = "R_gnavus",
  "Ruminococcus torques" = "R_torques",
  "Streptococcus parasanguinis" = "S_parasanguinis",
  "Streptococcus salivarius" = "S_salivarius",
  "Veillonella parvula" = "V_parvula"
)

# Apply name changes to the species column in Dienestrol_16S_80uM_summarised

Dienestrol_16S_80uM_summarised$Species <- name_changes[Dienestrol_16S_80uM_summarised$species]
Dienestrol_16S_20uM_summarised$Species <- name_changes[Dienestrol_16S_20uM_summarised$species]
Dienestrol_16S_5uM_summarised$Species <- name_changes[Dienestrol_16S_5uM_summarised$species]

# Verify the changes
unique(Dienestrol_16S_80uM_summarised$Species)
unique(Dienestrol_16S_20uM_summarised$Species)
unique(Dienestrol_16S_5uM_summarised$Species)



##First, for 5 uM:
# Get top 6 species from plot_data_5_endpoint
# Adjust the plot_data_5_endpoint with confidence bounds

# #plot_data_0_Dienestrol_endpoint was used to test model performance at 0 drugs
# plot_data_0_Dienestrol_endpoint <- plot_data_0_Dienestrol_endpoint %>%
#   dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)

plot_data_5_Dienestrol_endpoint <- plot_data_5_Dienestrol_endpoint %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)

# Adjust the Dienestrol_16S_5uM_summarised with confidence bounds
Dienestrol_16S_5uM_summarised <- Dienestrol_16S_5uM_summarised %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)

#NULL model:
Null_model_summarised <- Niclosamide_16S_0uM_summarised %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)


# Get top 6 species based on the lower bound from plot_data_5_endpoint

#top6_predicted_0_Dienestrol was used to test model performance at 0 drugs
# top6_predicted_0_Dienestrol <- plot_data_0_Dienestrol_endpoint %>%
#    arrange(desc(lower_bound)) %>%
#    slice(1:6) %>%
#    pull(Species)

top6_predicted_5_Dienestrol <- plot_data_5_Dienestrol_endpoint %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

# Get top 6 species based on the lower bound from Dienestrol_16S_5uM_summarised
top6_real_5_Dienestrol <- Dienestrol_16S_5uM_summarised %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

top6_NULL <- Null_model_summarised %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

# Calculate the overlap of top 6 species

#top_six_correct_0_Dienestrol was used to assess model performance at 0 drugs
# top_six_correct_0_Dienestrol <- length(intersect(top6_predicted_0_Dienestrol, top6_NULL))
# top_six_correct_0_Dienestrol

top_six_correct_5_Dienestrol <- length(intersect(top6_predicted_5_Dienestrol, top6_real_5_Dienestrol))
top_six_correct_5_Dienestrol

top_six_correct_5_Dienestrol_NULL <- length(intersect(top6_NULL, top6_real_5_Dienestrol))
top_six_correct_5_Dienestrol_NULL

top6_predicted_5_Dienestrol
top6_real_5_Dienestrol

#top6_NULL

#Now by means:
# #top6_predicted_0_Dienestrol_means was used to assess model performance at 0 drugs
# top6_predicted_0_Dienestrol_means <- plot_data_0_Dienestrol_endpoint %>%
#    arrange(desc(mean_rel_ab)) %>%
#    slice(1:6) %>%
#    pull(Species)

top6_predicted_5_Dienestrol_means <- plot_data_5_Dienestrol_endpoint %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)

# Get top 6 species based on the lower bound from Dienestrol_16S_5uM_summarised
top6_real_5_Dienestrol_means <- Dienestrol_16S_5uM_summarised %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)

top6_NULL_means <- Null_model_summarised %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)


# #top_six_correct_0_Dienestrol_means was used to assess model performance at 0 drugs
# top_six_correct_0_Dienestrol_means <- length(intersect(top6_predicted_0_Dienestrol_means, top6_NULL_means))
# top_six_correct_0_Dienestrol_means

top_six_correct_5_Dienestrol_means <- length(intersect(top6_predicted_5_Dienestrol_means, top6_real_5_Dienestrol_means))
top_six_correct_5_Dienestrol_means

top_six_correct_5_Dienestrol_means_NULL <- length(intersect(top6_NULL_means, top6_real_5_Dienestrol_means))
top_six_correct_5_Dienestrol_means_NULL

top6_predicted_5_Dienestrol_means
top6_real_5_Dienestrol_means

#top6_NULL_means


# Merge dataframes by Species

#merged_data_0_Dienestrol was used to assess model performance at 0 drugs
#merged_data_0_Dienestrol <- merge(plot_data_0_Dienestrol_endpoint, Niclosamide_16S_0uM_summarised, by = "Species", suffixes = c(".pred", ".real"))
merged_data_5_Dienestrol <- merge(plot_data_5_Dienestrol_endpoint, Dienestrol_16S_5uM_summarised, by = "Species", suffixes = c(".pred", ".real"))
merged_data_5_Dienestrol_NULL <- merge(Niclosamide_16S_0uM_summarised, Dienestrol_16S_5uM_summarised, by = "Species", suffixes = c(".null", ".real"))


## Below lines used for assessing model performance at 0 drugs; ignore for nonzero concentrations
# # Create lower and upper bounds considering mean ¬± sd
# merged_data_0_Dienestrol$lower_bound_pred <- merged_data_0_Dienestrol$mean_rel_ab.pred - merged_data_0_Dienestrol$sd_rel_ab.pred
# merged_data_0_Dienestrol$upper_bound_pred <- merged_data_0_Dienestrol$mean_rel_ab.pred + merged_data_0_Dienestrol$sd_rel_ab.pred
# merged_data_0_Dienestrol$lower_bound_real <- merged_data_0_Dienestrol$mean_rel_ab.real - merged_data_0_Dienestrol$sd_rel_ab.real
# merged_data_0_Dienestrol$upper_bound_real <- merged_data_0_Dienestrol$mean_rel_ab.real + merged_data_0_Dienestrol$sd_rel_ab.real
# 
# # Ensure lower and upper bounds are non-negative, adjusting as necessary
# merged_data_0_Dienestrol$lower_bound_pred[merged_data_0_Dienestrol$lower_bound_pred <= 0] <- 1e-10
# merged_data_0_Dienestrol$lower_bound_real[merged_data_0_Dienestrol$lower_bound_real <= 0] <- 1e-10
# merged_data_0_Dienestrol$upper_bound_pred[merged_data_0_Dienestrol$upper_bound_pred <= 0] <- 1e-10
# merged_data_0_Dienestrol$upper_bound_real[merged_data_0_Dienestrol$upper_bound_real <= 0] <- 1e-10


# Create lower and upper bounds considering mean ¬± sd
merged_data_5_Dienestrol$lower_bound_pred <- merged_data_5_Dienestrol$mean_rel_ab.pred - merged_data_5_Dienestrol$sd_rel_ab.pred
merged_data_5_Dienestrol$upper_bound_pred <- merged_data_5_Dienestrol$mean_rel_ab.pred + merged_data_5_Dienestrol$sd_rel_ab.pred
merged_data_5_Dienestrol$lower_bound_real <- merged_data_5_Dienestrol$mean_rel_ab.real - merged_data_5_Dienestrol$sd_rel_ab.real
merged_data_5_Dienestrol$upper_bound_real <- merged_data_5_Dienestrol$mean_rel_ab.real + merged_data_5_Dienestrol$sd_rel_ab.real

# Ensure lower and upper bounds are non-negative, adjusting as necessary
merged_data_5_Dienestrol$lower_bound_pred[merged_data_5_Dienestrol$lower_bound_pred <= 0] <- 1e-10
merged_data_5_Dienestrol$lower_bound_real[merged_data_5_Dienestrol$lower_bound_real <= 0] <- 1e-10
merged_data_5_Dienestrol$upper_bound_pred[merged_data_5_Dienestrol$upper_bound_pred <= 0] <- 1e-10
merged_data_5_Dienestrol$upper_bound_real[merged_data_5_Dienestrol$upper_bound_real <= 0] <- 1e-10

##and for NULL model:
# Create lower and upper bounds considering mean ¬± sd
merged_data_5_Dienestrol_NULL$lower_bound_null <- merged_data_5_Dienestrol_NULL$mean_rel_ab.null - merged_data_5_Dienestrol_NULL$sd_rel_ab.null
merged_data_5_Dienestrol_NULL$upper_bound_null <- merged_data_5_Dienestrol_NULL$mean_rel_ab.null + merged_data_5_Dienestrol_NULL$sd_rel_ab.null
merged_data_5_Dienestrol_NULL$lower_bound_real <- merged_data_5_Dienestrol_NULL$mean_rel_ab.real - merged_data_5_Dienestrol_NULL$sd_rel_ab.real
merged_data_5_Dienestrol_NULL$upper_bound_real <- merged_data_5_Dienestrol_NULL$mean_rel_ab.real + merged_data_5_Dienestrol_NULL$sd_rel_ab.real

# Ensure lower and upper bounds are non-negative, adjusting as necessary
merged_data_5_Dienestrol_NULL$lower_bound_null[merged_data_5_Dienestrol_NULL$lower_bound_null <= 0] <- 1e-10
merged_data_5_Dienestrol_NULL$lower_bound_real[merged_data_5_Dienestrol_NULL$lower_bound_real <= 0] <- 1e-10
merged_data_5_Dienestrol_NULL$upper_bound_null[merged_data_5_Dienestrol_NULL$upper_bound_null <= 0] <- 1e-10
merged_data_5_Dienestrol_NULL$upper_bound_real[merged_data_5_Dienestrol_NULL$upper_bound_real <= 0] <- 1e-10

# Filter to include only species with a mean relative abundance > 0.01 in the 'real' dataset

## significant_species_0 was used to assess model performance at 0 drugs
#significant_species_0 <- merged_data_0_Dienestrol[merged_data_0_Dienestrol$mean_rel_ab.real > 0.01, ]
significant_species <- merged_data_5_Dienestrol[merged_data_5_Dienestrol$mean_rel_ab.real > 0.01, ]
survivors_5_Dienestrol <- nrow(significant_species)
survivors_5_Dienestrol

#should be the same as survivors defined above, since it is calculated from .real
significant_species_NULL <- merged_data_5_Dienestrol_NULL[merged_data_5_Dienestrol_NULL$mean_rel_ab.real > 0.01, ]
survivors_5_Dienestrol_NULL <- nrow(significant_species_NULL)
survivors_5_Dienestrol_NULL

# Adjusted order of magnitude check to include SD, only for significant species
## below code was used to assess model performance at 0 drugs
# significant_species_0$Predicted_magnitude_correct <- ifelse(
#   (floor(log10(significant_species_0$lower_bound_pred)) <= floor(log10(significant_species_0$upper_bound_real)) &
#      floor(log10(significant_species_0$upper_bound_pred)) >= floor(log10(significant_species_0$lower_bound_real))),
#   1,
#   0
# )

significant_species$Predicted_magnitude_correct <- ifelse(
  (floor(log10(significant_species$lower_bound_pred)) <= floor(log10(significant_species$upper_bound_real)) &
     floor(log10(significant_species$upper_bound_pred)) >= floor(log10(significant_species$lower_bound_real))),
  1,
  0
)

#and for the Null model:
significant_species_NULL$Predicted_magnitude_correct <- ifelse(
  (floor(log10(significant_species_NULL$lower_bound_null)) <= floor(log10(significant_species_NULL$upper_bound_real)) &
     floor(log10(significant_species_NULL$upper_bound_null)) >= floor(log10(significant_species_NULL$lower_bound_real))),
  1,
  0
)

# Calculate the fraction of correctly predicted magnitudes for significant species
## below code was used to assess model performance at 0 drugs
#predicted_magnitude_correct_fraction_0_Dienestrol <- sum(significant_species_0$Predicted_magnitude_correct) / nrow(significant_species_0)
#predicted_magnitude_correct_fraction_0_Dienestrol

predicted_magnitude_correct_fraction_5_Dienestrol <- sum(significant_species$Predicted_magnitude_correct) / nrow(significant_species)
predicted_magnitude_correct_fraction_5_Dienestrol

predicted_magnitude_correct_fraction_5_Dienestrol_NULL <- sum(significant_species_NULL$Predicted_magnitude_correct) / nrow(significant_species_NULL)
predicted_magnitude_correct_fraction_5_Dienestrol_NULL

top_species_missing_5_Dienestrol <- setdiff(top6_real_5_Dienestrol_means, top6_predicted_5_Dienestrol_means)
top_species_wrong_5_Dienestrol <- setdiff(top6_predicted_5_Dienestrol_means, top6_real_5_Dienestrol_means)

top_species_missing_5_Dienestrol <- if(length(top_species_missing_5_Dienestrol) == 0) "None" else top_species_missing_5_Dienestrol
top_species_wrong_5_Dienestrol <- if(length(top_species_wrong_5_Dienestrol) == 0) "None" else top_species_wrong_5_Dienestrol


Prediction_quality_5_Dienestrol <- data.frame(
  Top_six_correct = paste(top_six_correct_5_Dienestrol, sep=""),
  Top_six_correct_NULL = paste(top_six_correct_5_Dienestrol_NULL, sep=""),
  Top_six_correct_means = paste(top_six_correct_5_Dienestrol_means, sep=""),
  Top_six_correct_means_NULL = paste(top_six_correct_5_Dienestrol_means_NULL, sep=""),
  Predicted_magnitude_correct = paste(round(predicted_magnitude_correct_fraction_5_Dienestrol * 100, 2), "%", sep=""),
  Predicted_magnitude_correct_NULL = paste(round(predicted_magnitude_correct_fraction_5_Dienestrol_NULL * 100, 2), "%", sep=""),
  survivors_total = survivors_5_Dienestrol,
  top_species_missing <- top_species_missing_5_Dienestrol,
  top_species_wrong <- top_species_wrong_5_Dienestrol, 
  predicted_mean_final_OD <- predicted_mean_final_od_5_Dienestrol,
  real_mean_final_OD <- real_mean_final_od_5_Dienestrol,
  sims_total = length(successful_sim_ids)
)



Prediction_quality_5_Dienestrol



##Next, for 20 uM:
# Get top 6 species from plot_data_20_endpoint
# Adjust the plot_data_20_endpoint with confidence bounds
plot_data_20_Dienestrol_endpoint <- plot_data_20_Dienestrol_endpoint %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)

# Adjust the Dienestrol_16S_20uM_summarised with confidence bounds
Dienestrol_16S_20uM_summarised <- Dienestrol_16S_20uM_summarised %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)

#NULL model:
Null_model_summarised <- Niclosamide_16S_0uM_summarised %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)


# Get top 6 species based on the lower bound from plot_data_20_endpoint
top6_predicted_20_Dienestrol <- plot_data_20_Dienestrol_endpoint %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

# Get top 6 species based on the lower bound from Dienestrol_16S_20uM_summarised
top6_real_20_Dienestrol <- Dienestrol_16S_20uM_summarised %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

top6_NULL <- Null_model_summarised %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

# Calculate the overlap of top 6 species
top_six_correct_20_Dienestrol <- length(intersect(top6_predicted_20_Dienestrol, top6_real_20_Dienestrol))
#top_six_correct_20_Dienestrol

top_six_correct_20_Dienestrol_NULL <- length(intersect(top6_NULL, top6_real_20_Dienestrol))
#top_six_correct_20_Dienestrol_NULL

#top6_predicted_20_Dienestrol
#top6_real_20_Dienestrol



#Now by means:
top6_predicted_20_Dienestrol_means <- plot_data_20_Dienestrol_endpoint %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)

# Get top 6 species based on the lower bound from Dienestrol_16S_20uM_summarised
top6_real_20_Dienestrol_means <- Dienestrol_16S_20uM_summarised %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)

top6_NULL_means <- Null_model_summarised %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)



top_six_correct_20_Dienestrol_means <- length(intersect(top6_predicted_20_Dienestrol_means, top6_real_20_Dienestrol_means))
#top_six_correct_20_Dienestrol_means

top_six_correct_20_Dienestrol_means_NULL <- length(intersect(top6_NULL_means, top6_real_20_Dienestrol_means))
#top_six_correct_20_Dienestrol_means_NULL

top6_predicted_20_Dienestrol_means
#top6_real_20_Dienestrol_means




# Merge dataframes by Species
merged_data_20_Dienestrol <- merge(plot_data_20_Dienestrol_endpoint, Dienestrol_16S_20uM_summarised, by = "Species", suffixes = c(".pred", ".real"))
merged_data_20_Dienestrol_NULL <- merge(Niclosamide_16S_0uM_summarised, Dienestrol_16S_20uM_summarised, by = "Species", suffixes = c(".null", ".real"))



# Create lower and upper bounds considering mean ¬± sd
merged_data_20_Dienestrol$lower_bound_pred <- merged_data_20_Dienestrol$mean_rel_ab.pred - merged_data_20_Dienestrol$sd_rel_ab.pred
merged_data_20_Dienestrol$upper_bound_pred <- merged_data_20_Dienestrol$mean_rel_ab.pred + merged_data_20_Dienestrol$sd_rel_ab.pred
merged_data_20_Dienestrol$lower_bound_real <- merged_data_20_Dienestrol$mean_rel_ab.real - merged_data_20_Dienestrol$sd_rel_ab.real
merged_data_20_Dienestrol$upper_bound_real <- merged_data_20_Dienestrol$mean_rel_ab.real + merged_data_20_Dienestrol$sd_rel_ab.real

# Ensure lower and upper bounds are non-negative, adjusting as necessary
merged_data_20_Dienestrol$lower_bound_pred[merged_data_20_Dienestrol$lower_bound_pred <= 0] <- 1e-10
merged_data_20_Dienestrol$lower_bound_real[merged_data_20_Dienestrol$lower_bound_real <= 0] <- 1e-10
merged_data_20_Dienestrol$upper_bound_pred[merged_data_20_Dienestrol$upper_bound_pred <= 0] <- 1e-10
merged_data_20_Dienestrol$upper_bound_real[merged_data_20_Dienestrol$upper_bound_real <= 0] <- 1e-10

##and for NULL model:
# Create lower and upper bounds considering mean ¬± sd
merged_data_20_Dienestrol_NULL$lower_bound_null <- merged_data_20_Dienestrol_NULL$mean_rel_ab.null - merged_data_20_Dienestrol_NULL$sd_rel_ab.null
merged_data_20_Dienestrol_NULL$upper_bound_null <- merged_data_20_Dienestrol_NULL$mean_rel_ab.null + merged_data_20_Dienestrol_NULL$sd_rel_ab.null
merged_data_20_Dienestrol_NULL$lower_bound_real <- merged_data_20_Dienestrol_NULL$mean_rel_ab.real - merged_data_20_Dienestrol_NULL$sd_rel_ab.real
merged_data_20_Dienestrol_NULL$upper_bound_real <- merged_data_20_Dienestrol_NULL$mean_rel_ab.real + merged_data_20_Dienestrol_NULL$sd_rel_ab.real

# Ensure lower and upper bounds are non-negative, adjusting as necessary
merged_data_20_Dienestrol_NULL$lower_bound_null[merged_data_20_Dienestrol_NULL$lower_bound_null <= 0] <- 1e-10
merged_data_20_Dienestrol_NULL$lower_bound_real[merged_data_20_Dienestrol_NULL$lower_bound_real <= 0] <- 1e-10
merged_data_20_Dienestrol_NULL$upper_bound_null[merged_data_20_Dienestrol_NULL$upper_bound_null <= 0] <- 1e-10
merged_data_20_Dienestrol_NULL$upper_bound_real[merged_data_20_Dienestrol_NULL$upper_bound_real <= 0] <- 1e-10

# Filter to include only species with a mean relative abundance > 0.01 in the 'real' dataset
significant_species <- merged_data_20_Dienestrol[merged_data_20_Dienestrol$mean_rel_ab.real > 0.01, ]
survivors_20_Dienestrol <- nrow(significant_species)
survivors_20_Dienestrol

#should be the same as survivors defined above, since it is calculated from .real
significant_species_NULL <- merged_data_20_Dienestrol_NULL[merged_data_20_Dienestrol_NULL$mean_rel_ab.real > 0.01, ]
survivors_20_Dienestrol_NULL <- nrow(significant_species_NULL)
survivors_20_Dienestrol_NULL

# Adjusted order of magnitude check to include SD, only for significant species
significant_species$Predicted_magnitude_correct <- ifelse(
  (floor(log10(significant_species$lower_bound_pred)) <= floor(log10(significant_species$upper_bound_real)) &
     floor(log10(significant_species$upper_bound_pred)) >= floor(log10(significant_species$lower_bound_real))),
  1,
  0
)

#and for the Null model:
significant_species_NULL$Predicted_magnitude_correct <- ifelse(
  (floor(log10(significant_species_NULL$lower_bound_null)) <= floor(log10(significant_species_NULL$upper_bound_real)) &
     floor(log10(significant_species_NULL$upper_bound_null)) >= floor(log10(significant_species_NULL$lower_bound_real))),
  1,
  0
)

# Calculate the fraction of correctly predicted magnitudes for significant species
predicted_magnitude_correct_fraction_20_Dienestrol <- sum(significant_species$Predicted_magnitude_correct) / nrow(significant_species)
predicted_magnitude_correct_fraction_20_Dienestrol

predicted_magnitude_correct_fraction_20_Dienestrol_NULL <- sum(significant_species_NULL$Predicted_magnitude_correct) / nrow(significant_species_NULL)
predicted_magnitude_correct_fraction_20_Dienestrol_NULL

top_species_missing_20_Dienestrol <- setdiff(top6_real_20_Dienestrol_means, top6_predicted_20_Dienestrol_means)
top_species_wrong_20_Dienestrol <- setdiff(top6_predicted_20_Dienestrol_means, top6_real_20_Dienestrol_means)

Prediction_quality_20_Dienestrol <- data.frame(
  Top_six_correct = paste(top_six_correct_20_Dienestrol, sep=""),
  Top_six_correct_NULL = paste(top_six_correct_20_Dienestrol_NULL, sep=""),
  Top_six_correct_means = paste(top_six_correct_20_Dienestrol_means, sep=""),
  Top_six_correct_means_NULL = paste(top_six_correct_20_Dienestrol_means_NULL, sep=""),
  Predicted_magnitude_correct = paste(round(predicted_magnitude_correct_fraction_20_Dienestrol * 100, 2), "%", sep=""),
  Predicted_magnitude_correct_NULL = paste(round(predicted_magnitude_correct_fraction_20_Dienestrol_NULL * 100, 2), "%", sep=""),
  survivors_total = survivors_20_Dienestrol,
  top_species_missing <- top_species_missing_20_Dienestrol,
  top_species_wrong <- top_species_wrong_20_Dienestrol, 
  predicted_mean_final_OD <- predicted_mean_final_od_20_Dienestrol,
  real_mean_final_OD <- real_mean_final_od_20_Dienestrol,
  sims_total = length(successful_sim_ids)
)

Prediction_quality_20_Dienestrol






##Next, for 80 uM:
# Get top 6 species from plot_data_80_endpoint
# Adjust the plot_data_80_endpoint with confidence bounds
plot_data_80_Dienestrol_endpoint <- plot_data_80_Dienestrol_endpoint %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)

# Adjust the Dienestrol_16S_80uM_summarised with confidence bounds
Dienestrol_16S_80uM_summarised <- Dienestrol_16S_80uM_summarised %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)

#NULL model:
Null_model_summarised <- Niclosamide_16S_0uM_summarised %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)


# Get top 6 species based on the lower bound from plot_data_80_endpoint
top6_predicted_80_Dienestrol <- plot_data_80_Dienestrol_endpoint %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

# Get top 6 species based on the lower bound from Dienestrol_16S_80uM_summarised
top6_real_80_Dienestrol <- Dienestrol_16S_80uM_summarised %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

top6_NULL <- Null_model_summarised %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

# Calculate the overlap of top 6 species
top_six_correct_80_Dienestrol <- length(intersect(top6_predicted_80_Dienestrol, top6_real_80_Dienestrol))
#top_six_correct_80_Dienestrol

top_six_correct_80_Dienestrol_NULL <- length(intersect(top6_NULL, top6_real_80_Dienestrol))
#top_six_correct_80_Dienestrol_NULL

#top6_predicted_80_Dienestrol
#top6_real_80_Dienestrol




#Now by means:
top6_predicted_80_Dienestrol_means <- plot_data_80_Dienestrol_endpoint %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)

# Get top 6 species based on the lower bound from Dienestrol_16S_80uM_summarised
top6_real_80_Dienestrol_means <- Dienestrol_16S_80uM_summarised %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)

top6_NULL_means <- Null_model_summarised %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)



top_six_correct_80_Dienestrol_means <- length(intersect(top6_predicted_80_Dienestrol_means, top6_real_80_Dienestrol_means))
#top_six_correct_80_Dienestrol_means

top_six_correct_80_Dienestrol_means_NULL <- length(intersect(top6_NULL_means, top6_real_80_Dienestrol_means))
#top_six_correct_80_Dienestrol_means_NULL

#top6_predicted_80_Dienestrol_means
#top6_real_80_Dienestrol_means




# Merge dataframes by Species
merged_data_80_Dienestrol <- merge(plot_data_80_Dienestrol_endpoint, Dienestrol_16S_80uM_summarised, by = "Species", suffixes = c(".pred", ".real"))
merged_data_80_Dienestrol_NULL <- merge(Niclosamide_16S_0uM_summarised, Dienestrol_16S_80uM_summarised, by = "Species", suffixes = c(".null", ".real"))



# Create lower and upper bounds considering mean ¬± sd
merged_data_80_Dienestrol$lower_bound_pred <- merged_data_80_Dienestrol$mean_rel_ab.pred - merged_data_80_Dienestrol$sd_rel_ab.pred
merged_data_80_Dienestrol$upper_bound_pred <- merged_data_80_Dienestrol$mean_rel_ab.pred + merged_data_80_Dienestrol$sd_rel_ab.pred
merged_data_80_Dienestrol$lower_bound_real <- merged_data_80_Dienestrol$mean_rel_ab.real - merged_data_80_Dienestrol$sd_rel_ab.real
merged_data_80_Dienestrol$upper_bound_real <- merged_data_80_Dienestrol$mean_rel_ab.real + merged_data_80_Dienestrol$sd_rel_ab.real

# Ensure lower and upper bounds are non-negative, adjusting as necessary
merged_data_80_Dienestrol$lower_bound_pred[merged_data_80_Dienestrol$lower_bound_pred <= 0] <- 1e-10
merged_data_80_Dienestrol$lower_bound_real[merged_data_80_Dienestrol$lower_bound_real <= 0] <- 1e-10
merged_data_80_Dienestrol$upper_bound_pred[merged_data_80_Dienestrol$upper_bound_pred <= 0] <- 1e-10
merged_data_80_Dienestrol$upper_bound_real[merged_data_80_Dienestrol$upper_bound_real <= 0] <- 1e-10

##and for NULL model:
# Create lower and upper bounds considering mean ¬± sd
merged_data_80_Dienestrol_NULL$lower_bound_null <- merged_data_80_Dienestrol_NULL$mean_rel_ab.null - merged_data_80_Dienestrol_NULL$sd_rel_ab.null
merged_data_80_Dienestrol_NULL$upper_bound_null <- merged_data_80_Dienestrol_NULL$mean_rel_ab.null + merged_data_80_Dienestrol_NULL$sd_rel_ab.null
merged_data_80_Dienestrol_NULL$lower_bound_real <- merged_data_80_Dienestrol_NULL$mean_rel_ab.real - merged_data_80_Dienestrol_NULL$sd_rel_ab.real
merged_data_80_Dienestrol_NULL$upper_bound_real <- merged_data_80_Dienestrol_NULL$mean_rel_ab.real + merged_data_80_Dienestrol_NULL$sd_rel_ab.real

# Ensure lower and upper bounds are non-negative, adjusting as necessary
merged_data_80_Dienestrol_NULL$lower_bound_null[merged_data_80_Dienestrol_NULL$lower_bound_null <= 0] <- 1e-10
merged_data_80_Dienestrol_NULL$lower_bound_real[merged_data_80_Dienestrol_NULL$lower_bound_real <= 0] <- 1e-10
merged_data_80_Dienestrol_NULL$upper_bound_null[merged_data_80_Dienestrol_NULL$upper_bound_null <= 0] <- 1e-10
merged_data_80_Dienestrol_NULL$upper_bound_real[merged_data_80_Dienestrol_NULL$upper_bound_real <= 0] <- 1e-10

# Filter to include only species with a mean relative abundance > 0.01 in the 'real' dataset
significant_species <- merged_data_80_Dienestrol[merged_data_80_Dienestrol$mean_rel_ab.real > 0.01, ]
survivors_80_Dienestrol <- nrow(significant_species)
survivors_80_Dienestrol

#should be the same as survivors defined above, since it is calculated from .real
significant_species_NULL <- merged_data_80_Dienestrol_NULL[merged_data_80_Dienestrol_NULL$mean_rel_ab.real > 0.01, ]
survivors_80_Dienestrol_NULL <- nrow(significant_species_NULL)
survivors_80_Dienestrol_NULL

# Adjusted order of magnitude check to include SD, only for significant species
significant_species$Predicted_magnitude_correct <- ifelse(
  (floor(log10(significant_species$lower_bound_pred)) <= floor(log10(significant_species$upper_bound_real)) &
     floor(log10(significant_species$upper_bound_pred)) >= floor(log10(significant_species$lower_bound_real))),
  1,
  0
)

#and for the Null model:
significant_species_NULL$Predicted_magnitude_correct <- ifelse(
  (floor(log10(significant_species_NULL$lower_bound_null)) <= floor(log10(significant_species_NULL$upper_bound_real)) &
     floor(log10(significant_species_NULL$upper_bound_null)) >= floor(log10(significant_species_NULL$lower_bound_real))),
  1,
  0
)

# Calculate the fraction of correctly predicted magnitudes for significant species
predicted_magnitude_correct_fraction_80_Dienestrol <- sum(significant_species$Predicted_magnitude_correct) / nrow(significant_species)
predicted_magnitude_correct_fraction_80_Dienestrol

predicted_magnitude_correct_fraction_80_Dienestrol_NULL <- sum(significant_species_NULL$Predicted_magnitude_correct) / nrow(significant_species_NULL)
predicted_magnitude_correct_fraction_80_Dienestrol_NULL


top_species_missing_80_Dienestrol <- setdiff(top6_real_80_Dienestrol_means, top6_predicted_80_Dienestrol_means)
top_species_wrong_80_Dienestrol <- setdiff(top6_predicted_80_Dienestrol_means, top6_real_80_Dienestrol_means)

Prediction_quality_80_Dienestrol <- data.frame(
  Top_six_correct = paste(top_six_correct_80_Dienestrol, sep=""),
  Top_six_correct_NULL = paste(top_six_correct_80_Dienestrol_NULL, sep=""),
  Top_six_correct_means = paste(top_six_correct_80_Dienestrol_means, sep=""),
  Top_six_correct_means_NULL = paste(top_six_correct_80_Dienestrol_means_NULL, sep=""),
  Predicted_magnitude_correct = paste(round(predicted_magnitude_correct_fraction_80_Dienestrol * 100, 2), "%", sep=""),
  Predicted_magnitude_correct_NULL = paste(round(predicted_magnitude_correct_fraction_80_Dienestrol_NULL * 100, 2), "%", sep=""),
  survivors_total = survivors_80_Dienestrol,
  top_species_missing <- top_species_missing_80_Dienestrol,
  top_species_wrong <- top_species_wrong_80_Dienestrol, 
  predicted_mean_final_OD <- predicted_mean_final_od_80_Dienestrol,
  real_mean_final_OD <- real_mean_final_od_80_Dienestrol,
  sims_total = length(successful_sim_ids)
)

Prediction_quality_80_Dienestrol











##Doxycycline

combined_monoculture_aucs2_Doxycycline <- subset(combined_monoculture_aucs2, drug == "Doxycycline")


#drug sensitivity terms: define once outside of ODEs
y_function_B_vulgatus_Doxycycline <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("B_vulgatus", "Doxycycline", best_fitting_models_df_Doxycycline)), collapse = " ")))
y_function_B_uniformis_Doxycycline <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("B_uniformis", "Doxycycline", best_fitting_models_df_Doxycycline)), collapse = " ")))
y_function_B_fragilis_Doxycycline <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("B_fragilis", "Doxycycline", best_fitting_models_df_Doxycycline)), collapse = " ")))
y_function_B_thetaiotaomicron_Doxycycline <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("B_thetaiotaomicron", "Doxycycline", best_fitting_models_df_Doxycycline)), collapse = " ")))
y_function_C_ramosum_Doxycycline <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("C_ramosum", "Doxycycline", best_fitting_models_df_Doxycycline)), collapse = " ")))
y_function_E_rectale_Doxycycline <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("E_rectale", "Doxycycline", best_fitting_models_df_Doxycycline)), collapse = " ")))
y_function_R_intestinalis_Doxycycline <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("R_intestinalis", "Doxycycline", best_fitting_models_df_Doxycycline)), collapse = " ")))
y_function_V_parvula_Doxycycline <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("V_parvula", "Doxycycline", best_fitting_models_df_Doxycycline)), collapse = " ")))
y_function_E_lenta_Doxycycline <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("E_lenta", "Doxycycline", best_fitting_models_df_Doxycycline)), collapse = " ")))
y_function_F_nucleatum_Doxycycline <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("F_nucleatum", "Doxycycline", best_fitting_models_df_Doxycycline)), collapse = " ")))
y_function_C_bolteae_Doxycycline <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("C_bolteae", "Doxycycline", best_fitting_models_df_Doxycycline)), collapse = " ")))
y_function_C_perfringens_Doxycycline <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("C_perfringens", "Doxycycline", best_fitting_models_df_Doxycycline)), collapse = " ")))
y_function_C_saccharolyticum_Doxycycline <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("C_saccharolyticum", "Doxycycline", best_fitting_models_df_Doxycycline)), collapse = " ")))
y_function_S_salivarius_Doxycycline <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("S_salivarius", "Doxycycline", best_fitting_models_df_Doxycycline)), collapse = " ")))
y_function_R_gnavus_Doxycycline <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("R_gnavus", "Doxycycline", best_fitting_models_df_Doxycycline)), collapse = " ")))
y_function_C_comes_Doxycycline <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("C_comes", "Doxycycline", best_fitting_models_df_Doxycycline)), collapse = " ")))
y_function_P_merdae_Doxycycline <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("P_merdae", "Doxycycline", best_fitting_models_df_Doxycycline)), collapse = " ")))
y_function_S_parasanguinis_Doxycycline <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("S_parasanguinis", "Doxycycline", best_fitting_models_df_Doxycycline)), collapse = " ")))
y_function_C_aerofaciens_Doxycycline <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("C_aerofaciens", "Doxycycline", best_fitting_models_df_Doxycycline)), collapse = " ")))
y_function_D_formicigenerans_Doxycycline <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("D_formicigenerans", "Doxycycline", best_fitting_models_df_Doxycycline)), collapse = " ")))
y_function_E_coli_Doxycycline <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("E_coli", "Doxycycline", best_fitting_models_df_Doxycycline)), collapse = " ")))



y_function_B_vulgatus_Doxycycline_func <- eval(parse(text = paste("function(Drug) {", y_function_B_vulgatus_Doxycycline, "}")))
y_function_B_uniformis_Doxycycline_func <- eval(parse(text = paste("function(Drug) {", y_function_B_uniformis_Doxycycline, "}")))
y_function_B_fragilis_Doxycycline_func <- eval(parse(text = paste("function(Drug) {", y_function_B_fragilis_Doxycycline, "}")))
y_function_B_thetaiotaomicron_Doxycycline_func <- eval(parse(text = paste("function(Drug) {", y_function_B_thetaiotaomicron_Doxycycline, "}")))
y_function_C_ramosum_Doxycycline_func <- eval(parse(text = paste("function(Drug) {", y_function_C_ramosum_Doxycycline, "}")))
y_function_E_rectale_Doxycycline_func <- eval(parse(text = paste("function(Drug) {", y_function_E_rectale_Doxycycline, "}")))
y_function_R_intestinalis_Doxycycline_func <- eval(parse(text = paste("function(Drug) {", y_function_R_intestinalis_Doxycycline, "}")))
y_function_E_lenta_Doxycycline_func <- eval(parse(text = paste("function(Drug) {", y_function_E_lenta_Doxycycline, "}")))
y_function_F_nucleatum_Doxycycline_func <- eval(parse(text = paste("function(Drug) {", y_function_F_nucleatum_Doxycycline, "}")))
y_function_C_bolteae_Doxycycline_func <- eval(parse(text = paste("function(Drug) {", y_function_C_bolteae_Doxycycline, "}")))
y_function_C_perfringens_Doxycycline_func <- eval(parse(text = paste("function(Drug) {", y_function_C_perfringens_Doxycycline, "}")))
y_function_C_saccharolyticum_Doxycycline_func <- eval(parse(text = paste("function(Drug) {", y_function_C_saccharolyticum_Doxycycline, "}")))
y_function_S_salivarius_Doxycycline_func <- eval(parse(text = paste("function(Drug) {", y_function_S_salivarius_Doxycycline, "}")))
y_function_R_gnavus_Doxycycline_func <- eval(parse(text = paste("function(Drug) {", y_function_R_gnavus_Doxycycline, "}")))
y_function_C_comes_Doxycycline_func <- eval(parse(text = paste("function(Drug) {", y_function_C_comes_Doxycycline, "}")))
y_function_P_merdae_Doxycycline_func <- eval(parse(text = paste("function(Drug) {", y_function_P_merdae_Doxycycline, "}")))
y_function_S_parasanguinis_Doxycycline_func <- eval(parse(text = paste("function(Drug) {", y_function_S_parasanguinis_Doxycycline, "}")))
y_function_C_aerofaciens_Doxycycline_func <- eval(parse(text = paste("function(Drug) {", y_function_C_aerofaciens_Doxycycline, "}")))
y_function_D_formicigenerans_Doxycycline_func <- eval(parse(text = paste("function(Drug) {", y_function_D_formicigenerans_Doxycycline, "}")))
y_function_E_coli_Doxycycline_func <- eval(parse(text = paste("function(Drug) {", y_function_E_coli_Doxycycline, "}")))
y_function_V_parvula_Doxycycline_func <- eval(parse(text = paste("function(Drug) {", y_function_V_parvula_Doxycycline, "}")))



unique(combined_monoculture_aucs2_Doxycycline$conc)
##dictate drug concentration tested for simulation cycle here:
#drug_concentration_tested <- 0.5 #if manually or:
drug_concentration_tested <- unique(combined_monoculture_aucs2_Doxycycline$conc)[1] 
initial_conditions <- rep(0.01/32, 32)
initial_conditions <- c(initial_conditions, drug_concentration_tested)


##drug effect fitted for species showing sensitivity in monoculture:
#unique(combined_monoculture_aucs2_Doxycycline$Species)

##for more simple linear fits
closed.sir.model_Doxycycline <- function (t, x, params) {
  ## first extract the state variables
  A_muciniphila <- x[1]
  B_adolescentis <- x[2]
  B_fragilis <- x[3]
  B_longum <- x[4]
  B_obeum <- x[5]
  B_thetaiotaomicron <- x[6]
  B_uniformis <- x[7]
  B_vulgatus <- x[8]
  B_wadsworthia <- x[9]
  C_aerofaciens <- x[10]
  C_bolteae <- x[11]
  C_comes <- x[12]
  C_perfringens <- x[13]
  C_ramosum <- x[14]
  C_saccharolyticum <- x[15]
  D_formicigenerans <- x[16]
  E_coli <- x[17]
  E_lenta <- x[18]
  E_rectale <- x[19]
  F_nucleatum <- x[20]
  L_paracasei <- x[21]
  O_splanchnicus <- x[22]
  P_copri <- x[23]
  P_distasonis <- x[24]
  P_merdae <- x[25]
  R_bromii <- x[26]
  R_gnavus <- x[27]
  R_intestinalis <- x[28]
  R_torques <- x[29]
  S_parasanguinis <- x[30]
  S_salivarius <- x[31]
  V_parvula <- x[32]
  Drug <- x[33]
  
  
  ## now extract the parameters
  r_B_fragilis <- flat_params[["B._fragilis.r"]]
  K_B_fragilis <- flat_params[["B._fragilis.K"]]
  r_B_longum <- flat_params[["B._longum.r"]]
  K_B_longum <- flat_params[["B._longum.K"]]
  r_B_thetaiotaomicron <- flat_params[["B._thetaiotaomicron.r"]]
  K_B_thetaiotaomicron <- flat_params[["B._thetaiotaomicron.K"]]
  r_B_uniformis <- flat_params[["B._uniformis.r"]]
  K_B_uniformis <- flat_params[["B._uniformis.K"]]
  r_B_vulgatus <- flat_params[["B._vulgatus.r"]]
  K_B_vulgatus <- flat_params[["B._vulgatus.K"]]
  r_B_wadsworthia <- flat_params[["B._wadsworthia.r"]]
  K_B_wadsworthia <- flat_params[["B._wadsworthia.K"]]
  r_C_aerofaciens <- flat_params[["C._aerofaciens.r"]]
  K_C_aerofaciens <- flat_params[["C._aerofaciens.K"]]
  r_C_bolteae <- flat_params[["C._bolteae.r"]]
  K_C_bolteae <- flat_params[["C._bolteae.K"]]
  r_C_comes <- flat_params[["C._comes.r"]]
  K_C_comes <- flat_params[["C._comes.K"]]
  r_C_perfringens <- flat_params[["C._perfringens.r"]]
  K_C_perfringens <- flat_params[["C._perfringens.K"]]
  r_C_ramosum <- flat_params[["C._ramosum.r"]]
  K_C_ramosum <- flat_params[["C._ramosum.K"]]
  r_C_saccharolyticum <- flat_params[["C._saccharolyticum.r"]]
  K_C_saccharolyticum <- flat_params[["C._saccharolyticum.K"]]
  r_D_formicigenerans <- flat_params[["D._formicigenerans.r"]]
  K_D_formicigenerans <- flat_params[["D._formicigenerans.K"]]
  r_E_coli <- flat_params[["E._coli.r"]]
  K_E_coli <- flat_params[["E._coli.K"]]
  r_E_lenta <- flat_params[["E._lenta.r"]]
  K_E_lenta <- flat_params[["E._lenta.K"]]
  r_E_rectale <- flat_params[["E._rectale.r"]]
  K_E_rectale <- flat_params[["E._rectale.K"]]
  r_F_nucleatum <- flat_params[["F._nucleatum.r"]]
  K_F_nucleatum <- flat_params[["F._nucleatum.K"]]
  r_P_copri <- flat_params[["P._copri.r"]]
  K_P_copri <- flat_params[["P._copri.K"]]
  r_P_merdae <- flat_params[["P._merdae.r"]]
  K_P_merdae <- flat_params[["P._merdae.K"]]
  r_R_gnavus <- flat_params[["R._gnavus.r"]]
  K_R_gnavus <- flat_params[["R._gnavus.K"]]
  r_R_intestinalis <- flat_params[["R._intestinalis.r"]]
  K_R_intestinalis <- flat_params[["R._intestinalis.K"]]
  r_V_parvula <- flat_params[["V._parvula.r"]]
  K_V_parvula <- flat_params[["V._parvula.K"]]
  r_A_muciniphila <- flat_params[["A._muciniphila.r"]]
  K_A_muciniphila <- flat_params[["A._muciniphila.K"]]
  r_B_adolescentis <- flat_params[["B._adolescentis.r"]]
  K_B_adolescentis <- flat_params[["B._adolescentis.K"]]
  r_B_obeum <- flat_params[["B._obeum.r"]]
  K_B_obeum <- flat_params[["B._obeum.K"]]
  r_O_splanchnicus <- flat_params[["O._splanchnicus.r"]]
  K_O_splanchnicus <- flat_params[["O._splanchnicus.K"]]
  r_P_distasonis <- flat_params[["P._distasonis.r"]]
  K_P_distasonis <- flat_params[["P._distasonis.K"]]
  r_R_bromii <- flat_params[["R._bromii.r"]]
  K_R_bromii <- flat_params[["R._bromii.K"]]
  r_R_torques <- flat_params[["R._torques.r"]]
  K_R_torques <- flat_params[["R._torques.K"]]
  r_S_parasanguinis <- flat_params[["S._parasanguinis.r"]]
  K_S_parasanguinis <-flat_params[["S._parasanguinis.K"]]
  r_S_salivarius <- flat_params[["S._salivarius.r"]]
  K_S_salivarius <- flat_params[["S._salivarius.K"]]
  r_L_paracasei <- flat_params[["L._paracasei.r"]]
  K_L_paracasei <- flat_params[["L._paracasei.K"]]
  
  
  t_mod <- ifelse(t > 24.1, t - 24.1, t)
  
  
  ## now code the model equations
  dA_muciniphila_dt <- r_A_muciniphila * A_muciniphila * (1 - A_muciniphila / K_A_muciniphila)
  dB_adolescentis_dt <- r_B_adolescentis * B_adolescentis * (1 - B_adolescentis / K_B_adolescentis)
  dB_fragilis_dt <- r_B_fragilis * B_fragilis * (1 - B_fragilis / max(0.0001, K_B_fragilis * (y_function_B_fragilis_Doxycycline_func(Drug))))
  dB_longum_dt <- r_B_longum * B_longum * (1 - B_longum / K_B_longum)
  dB_obeum_dt <- r_B_obeum * B_obeum * (1 - B_obeum / K_B_obeum)
  dB_thetaiotaomicron_dt <- r_B_thetaiotaomicron * B_thetaiotaomicron * (1 - B_thetaiotaomicron / max(0.0001, K_B_thetaiotaomicron * (y_function_B_thetaiotaomicron_Doxycycline_func(Drug))))  
  dB_uniformis_dt <- r_B_uniformis * B_uniformis * (1 - B_uniformis / max(0.0001, K_B_uniformis * (y_function_B_uniformis_Doxycycline_func(Drug))))
  dB_vulgatus_dt <- r_B_vulgatus * B_vulgatus * (1 - B_vulgatus / max(0.0001, K_B_vulgatus * (y_function_B_vulgatus_Doxycycline_func(Drug))))
  dB_wadsworthia_dt <- r_B_wadsworthia * B_wadsworthia * (1 - B_wadsworthia / K_B_wadsworthia)
  dC_aerofaciens_dt <- r_C_aerofaciens * C_aerofaciens * (1 - C_aerofaciens / max(0.0001, K_C_aerofaciens * (y_function_C_aerofaciens_Doxycycline_func(Drug))))
  dC_bolteae_dt <- r_C_bolteae * C_bolteae * (1 - C_bolteae /  max(0.0001, K_C_bolteae * (y_function_C_bolteae_Doxycycline_func(Drug))))
  dC_comes_dt <- r_C_comes * C_comes * (1 - C_comes / max(0.0001, K_C_comes * (y_function_C_comes_Doxycycline_func(Drug))))
  dC_perfringens_dt <- r_C_perfringens * C_perfringens * (1 - C_perfringens / max(0.0001, K_C_perfringens * (y_function_C_perfringens_Doxycycline_func(Drug))))
  dC_ramosum_dt <- r_C_ramosum * C_ramosum * (1 - C_ramosum / max(0.0001, K_C_ramosum * (y_function_C_ramosum_Doxycycline_func(Drug))))
  dC_saccharolyticum_dt <- r_C_saccharolyticum * C_saccharolyticum * (1 - C_saccharolyticum / max(0.0001, K_C_saccharolyticum * (y_function_C_saccharolyticum_Doxycycline_func(Drug))))
  dD_formicigenerans_dt <- r_D_formicigenerans * D_formicigenerans * (1 - D_formicigenerans / max(0.0001, K_D_formicigenerans * (y_function_D_formicigenerans_Doxycycline_func(Drug))))
  dE_coli_dt <- r_E_coli * E_coli * (1 - E_coli / max(0.0001, K_E_coli * (y_function_E_coli_Doxycycline_func(Drug))))
  dE_lenta_dt <- r_E_lenta * E_lenta * (1 - E_lenta / max(0.0001, K_E_lenta * (y_function_E_lenta_Doxycycline_func(Drug))))
  dE_rectale_dt <- r_E_rectale * E_rectale * (1 - E_rectale / max(0.0001, K_E_rectale * (y_function_E_rectale_Doxycycline_func(Drug))))
  dF_nucleatum_dt <- r_F_nucleatum * F_nucleatum * (1 - F_nucleatum / max(0.0001, K_F_nucleatum * (y_function_F_nucleatum_Doxycycline_func(Drug))))
  dL_paracasei_dt <- r_L_paracasei * L_paracasei * (1 - L_paracasei / K_L_paracasei)  
  dO_splanchnicus_dt <- r_O_splanchnicus * O_splanchnicus * (1 - O_splanchnicus / K_O_splanchnicus)  
  dP_copri_dt <- r_P_copri * P_copri * (1 - P_copri / K_P_copri)
  dP_distasonis_dt <- r_P_distasonis * P_distasonis * (1 - P_distasonis / K_P_distasonis)  
  dP_merdae_dt <- r_P_merdae * P_merdae * (1 - P_merdae / max(0.0001, K_P_merdae * (y_function_P_merdae_Doxycycline_func(Drug))))
  dR_bromii_dt <- r_R_bromii * R_bromii * (1 - R_bromii / K_R_bromii) 
  dR_gnavus_dt <- r_R_gnavus * R_gnavus * (1 - R_gnavus / max(0.0001, K_R_gnavus * (y_function_R_gnavus_Doxycycline_func(Drug))))
  dR_intestinalis_dt <- r_R_intestinalis * R_intestinalis * (1 - R_intestinalis / max(0.0001, K_R_intestinalis * (y_function_R_intestinalis_Doxycycline_func(Drug))))
  dR_torques_dt <- r_R_torques * R_torques * (1 - R_torques /K_R_torques) 
  dS_parasanguinis_dt <- r_S_parasanguinis * S_parasanguinis * (1 - S_parasanguinis / max(0.0001, K_S_parasanguinis * (y_function_S_parasanguinis_Doxycycline_func(Drug))))
  dS_salivarius_dt <- r_S_salivarius * S_salivarius * (1 - S_salivarius / max(0.0001, K_S_salivarius * (y_function_S_salivarius_Doxycycline_func(Drug))))
  dV_parvula_dt <- r_V_parvula * V_parvula * (1 - V_parvula / max(0.0001, K_V_parvula * (y_function_V_parvula_Doxycycline_func(Drug))))
  
  
  
  #Drug differential:
  dDrug_dt <- (subset(drug_dynamics, Drug == "Doxycycline")$Steepness_param_community * exp(-subset(drug_dynamics, Drug == "Doxycycline")$Steepness_param_community * t_mod)) * (drug_concentration_tested * prop_left_Doxycycline - drug_concentration_tested)
  #dDrug_dt <- 0
  
  ## Combine results into a single vector
  dxdt <- c(dA_muciniphila_dt, dB_adolescentis_dt, dB_fragilis_dt, dB_longum_dt, dB_obeum_dt, dB_thetaiotaomicron_dt, dB_uniformis_dt, dB_vulgatus_dt, dB_wadsworthia_dt, dC_aerofaciens_dt, dC_bolteae_dt, dC_comes_dt, dC_perfringens_dt, dC_ramosum_dt, dC_saccharolyticum_dt, dD_formicigenerans_dt, dE_coli_dt, dE_lenta_dt, dE_rectale_dt, dF_nucleatum_dt, dL_paracasei_dt, dO_splanchnicus_dt, dP_copri_dt, dP_distasonis_dt, dP_merdae_dt, dR_bromii_dt, dR_gnavus_dt, dR_intestinalis_dt, dR_torques_dt, dS_parasanguinis_dt, dS_salivarius_dt, dV_parvula_dt, dDrug_dt)
  
  ## Return result as a list
  list(dxdt)
}




#calculate the co-culture correction factor per species based on community composition in absence of drug, just like done for Niclosamide

growth_data_all_0_Niclosamide
growth_data_all_0_Niclosamide1 <- growth_data_all_0_Niclosamide %>%
  dplyr::mutate(Species = gsub(" ", "_", Species))


# Merge rel_ab_control with growth_data_all_0_Niclosamide on Species
# Function to remove duplicated columns by name pattern
clean_columns_base <- function(df, pattern) {
  cols_to_keep <- !grepl(pattern, names(df))
  df <- df[, cols_to_keep]
  return(df)
}

# Use the new function to clean up your dataframe
rel_ab_control <- clean_columns_base(rel_ab_control, "mean_max_OD.[xy]")
str(rel_ab_control)


#rel_ab_control$correction_factor <- rel_ab_control$mean_rel_ab / (rel_ab_control$mean_max_OD/sum(rel_ab_control$mean_max_OD))
# Calculate correction factor with a minimum value of ~1
rel_ab_control$correction_factor <- pmax(rel_ab_control$mean_rel_ab / (rel_ab_control$mean_max_OD / sum(rel_ab_control$mean_max_OD)), 1.1)


# Create a new dataframe for co-culture correction
co_culture_correction <- data.frame(
  species = rel_ab_control$Species,
  correction_factor = rel_ab_control$correction_factor
)


#summarise community data
#Adjust based on tested concentrations for each drug
unique(Community_compositions_focus_drugs_Doxycycline$concentration)

Community_compositions_focus_drugs_Doxycycline_0.5uM <- subset(Community_compositions_focus_drugs_Doxycycline, concentration == 0.5)
Community_compositions_focus_drugs_Doxycycline_2.5uM <- subset(Community_compositions_focus_drugs_Doxycycline, concentration == 2.5)



#0.5 uM
Community_compositions_focus_drugs_Doxycycline_0.5uM_summarised <- Community_compositions_focus_drugs_Doxycycline_0.5uM %>%
  dplyr::group_by(species) %>%                                  
  dplyr::summarize(
    mean_rel_ab = mean(rel_abundance, na.rm = TRUE),     
    sd_rel_ab = sd(rel_abundance, na.rm = TRUE) ,
    mean_max_OD = mean(maxOD, na.rm = TRUE),
    sd_max_OD = sd(maxOD, na.rm = TRUE),
    mean_final_OD = mean(finalOD, na.rm = TRUE),
    sd_final_OD = sd(finalOD, na.rm = TRUE)
  ) %>%
  dplyr::ungroup() 


Community_compositions_focus_drugs_Doxycycline_0.5uM_summarised <- Community_compositions_focus_drugs_Doxycycline_0.5uM_summarised %>%
  dplyr::mutate(Species = sub("^(\\w)\\w*\\s(.*)", "\\1._\\2", species))

#remove (sub)strain info
Community_compositions_focus_drugs_Doxycycline_0.5uM_summarised <- Community_compositions_focus_drugs_Doxycycline_0.5uM_summarised %>%
  dplyr::mutate(Species = sub("^(\\w\\._\\w+).*", "\\1", Species))


#2.5 uM
Community_compositions_focus_drugs_Doxycycline_2.5uM_summarised <- Community_compositions_focus_drugs_Doxycycline_2.5uM %>%
  dplyr::group_by(species) %>%                                  
  dplyr::summarize(
    mean_rel_ab = mean(rel_abundance, na.rm = TRUE),     
    sd_rel_ab = sd(rel_abundance, na.rm = TRUE) ,
    mean_max_OD = mean(maxOD, na.rm = TRUE),
    sd_max_OD = sd(maxOD, na.rm = TRUE),    
    mean_final_OD = mean(finalOD, na.rm = TRUE),
    sd_final_OD = sd(finalOD, na.rm = TRUE)
  ) %>%
  dplyr::ungroup() 



Community_compositions_focus_drugs_Doxycycline_2.5uM_summarised <- Community_compositions_focus_drugs_Doxycycline_2.5uM_summarised %>%
  dplyr::mutate(Species = sub("^(\\w)\\w*\\s(.*)", "\\1._\\2", species))

#remove (sub)strain info
Community_compositions_focus_drugs_Doxycycline_2.5uM_summarised <- Community_compositions_focus_drugs_Doxycycline_2.5uM_summarised %>%
  dplyr::mutate(Species = sub("^(\\w\\._\\w+).*", "\\1", Species))


#Initialise data frames
sim_output <- data.frame()
input_params_list <- list() #Use a list to collect parameters for each simulation

#number of simulations
num_sims <- 250


for (i in 1:num_sims) {
  tryCatch({
    # generate model parameters
    set.seed(i) #set a different seed for each simulation for variation
    params <- lapply(1:nrow(growth_data_all_0_Niclosamide), function(idx) {
      species_params <- growth_data_all_0_Niclosamide[idx, ]
      list(
        r = rnorm(1, mean = species_params$mean_max_Growth_rate, sd = species_params$sd_max_Growth_rate),
        K = rnorm(1, mean = species_params$mean_max_OD, sd = species_params$sd_max_OD)
      )
    })
    names(params) <- gsub(" ", "_", growth_data_all_0_Niclosamide$Species)
    flat_params <- unlist(params)
    names(flat_params) <- gsub("\\.\\d$", "", names(flat_params))
    
    #replace spaces with underscores to match formatting
    co_culture_correction$species <- gsub(" ", "_", co_culture_correction$species, fixed = TRUE)
    
    #replace the species-specific K parameters extracted from monoculture growth data 
    #with drawn relative abundance values at Niclosamide = 0, scaled to K
    rel_ab_control$Species <- gsub(" ", "_", rel_ab_control$Species)
    
    #Initialise an empty vector to store drawn values
    drawn_values <- numeric(nrow(rel_ab_control))
    
    #draw values from their respective distributions
    for (k in 1:nrow(rel_ab_control)) {
      species_name <- rel_ab_control$Species[k]
      drawn_value <- rnorm(1, mean = rel_ab_control$mean_rel_ab[k], sd = rel_ab_control$sd_rel_ab[k])
      drawn_values[k] <- max(drawn_value, 0)  # Ensure no negative values
    }
    
    #Normalise drawn relative abundance values so they sum to 1 (to reflect a 'true' relative abundance distribution)
    #this is needed so when we convert the values into OD units by multiplying with the drawn community maxOD,
    # the sum of K_i parameters and the drawn K are equal
    normalised_values <- drawn_values / sum(drawn_values)
    
    #Pull community maxOD (K) at 0 drugs from respective normal distribution:
    K <- rnorm(n = 1, mean = rel_ab_control$mean_com_max_OD[1], sd = rel_ab_control$sd_com_max_OD[1])
    
    # Assign these normalised values to their respective species' .K parameters
    for (k in 1:nrow(rel_ab_control)) {
      species_name <- rel_ab_control$Species[k]
      k_index <- grep(paste0("^", species_name, "\\.K$"), names(flat_params))
      
      if (length(k_index) > 0) {
        old_value <- flat_params[k_index]
        flat_params[k_index] <- (normalised_values[k] + 0.0001) * K #add small value in case drawn K_i is 0, which would cause issues with the solver
        cat(sprintf("Updated %s from %f to %f using normalised value %f scaled by K %f\n", names(flat_params)[k_index], old_value, flat_params[k_index], normalised_values[k], K))
      }
    }
    
    #Accounting for variation in drug degradation by community, with standard deviation of end concentration (at 10h) around the fitted predicted (relative) end concentration at 24h
    #prop_left_Doxycycline <- abs(rnorm(1, (subset(drug_dynamics, Drug == "Doxycycline")$Prop_left_24h_community), (subset(drug_dynamics, Drug == "Doxycycline")$SD_drug_community))) 
    #below, we account for measurement error rather than ecological drivers that lead to the variability of degradation at the final point measured 
    prop_left_Doxycycline <- abs(rnorm(
      n = 1, 
      mean = subset(drug_dynamics, Drug == "Doxycycline")$Prop_left_24h_community, 
      sd = ifelse(
        subset(drug_dynamics, Drug == "Doxycycline")$SD_drug_community > subset(drug_dynamics, Drug == "Doxycycline")$SD_drug_community_start, 
        subset(drug_dynamics, Drug == "Doxycycline")$SD_drug_community - subset(drug_dynamics, Drug == "Doxycycline")$SD_drug_community_start, 
        subset(drug_dynamics, Drug == "Doxycycline")$SD_drug_community
      )
    ))
    
    
    #loop through each species in co_culture_correction
    for (j in 1:nrow(co_culture_correction)) {
      # Extract the species name and correction factor
      species_name <- co_culture_correction$species[j]
      correction_factor <- co_culture_correction$correction_factor[j]
      
      # Identify the corresponding growth rate parameter in flat_params
      #by matching the base species name (without .r)
      growth_rate_indices <- grep(paste0("^", species_name, "\\.r$"), names(flat_params))
      
      #take the growth rate parameter and apply the correction factor 
      for (index in growth_rate_indices) {
        flat_params[index] <- flat_params[index] * correction_factor
      }
    }
    
    flat_params
    # Store parameters for each simulation
    input_params_list[[i]] <- c(sim_ID = i, flat_params)
    
    # Run the model for the first 24-hour cycle
    solution_cycle_1 <- ode(y = initial_conditions, times = seq(from = 0, to = 24, by = 0.1), func = closed.sir.model_Doxycycline, parms = flat_params,   method = "lsoda", rtol = 1e-6, atol = 1e-6)
    
    # Dilution and second cycle
    end_of_cycle_1 <- solution_cycle_1[nrow(solution_cycle_1), -1]
    initial_conditions_cycle_2 <- end_of_cycle_1 / 50
    #accounting for the drugs being added with the new growth cycle as well:
    initial_conditions_cycle_2[33] <- initial_conditions_cycle_2[33] + drug_concentration_tested
    solution_cycle_2 <- ode(y = initial_conditions_cycle_2, times = seq(from = 24, to = 48, by = 0.1), func = closed.sir.model_Doxycycline, parms = flat_params,  method = "lsoda", rtol = 1e-6, atol = 1e-6)
    
    # Combine and format results
    combined_solution <- rbind(as.data.frame(solution_cycle_1), as.data.frame(solution_cycle_2)[-1,])
    combined_solution$sim_ID <- rep(i, nrow(combined_solution))
    combined_solution <- combined_solution %>%
      tidyr::gather(key = "Species", value = "Density", -time, -sim_ID) %>%
      dplyr::mutate(Hour = time) %>%
      dplyr::select(sim_ID, Hour, Species, Density)
    
    ##Append to sim_output
    sim_output <- rbind(sim_output, combined_solution)
  }, error = function(e) {
    cat(sprintf("Skipping simulation %d due to an error: %s\n", i, e$message))
  })
}



##Combine all parameter data into a single dataframe
input_params <- do.call(rbind, input_params_list)

# Add a "Species" column 
sim_output$Species_name <- species_names[as.numeric(as.character(sim_output$Species))]
sim_output$Species_name <- replace_na(sim_output$Species_name, "Drug")

#View(input_params)
#View(sim_output)

sim_output <- na.omit(sim_output)
successful_sim_ids <- unique(subset(sim_output, Hour == 48)$sim_ID)
length(successful_sim_ids)
sim_output1 <- sim_output[sim_output$sim_ID %in% successful_sim_ids, ]


#Transform sim_output so we have wide format by Species
sim_output_wide <- tidyr::pivot_wider(sim_output1, 
                                      names_from = Species_name, 
                                      values_from = Density,
                                      id_cols = c(sim_ID, Hour))

length(unique(sim_output_wide$sim_ID))
#calc community OD per timepoint
sim_output_wide$Total_OD <- rowSums(sim_output_wide[, 3:34], na.rm = TRUE)
#calculate and add relative abundances here as well:
species_columns <- colnames(sim_output_wide)[3:34] 

for (species in species_columns) {
  sim_output_wide[[paste0("rel_", species)]] <- sim_output_wide[[species]] / sim_output_wide$Total_OD
}


#assign sim_output_wide test conditions to dataframe name
drug_tested <- "Doxycycline"
variable_name_1 <- paste0("sim_output_wide_", ifelse(drug_concentration_tested == 1e-04, 0, drug_concentration_tested), "_", drug_tested)
assign(variable_name_1, sim_output_wide)

#turn back into long format if interested in plotting relative abundances
cols_needed <- c("sim_ID", "Hour")

sim_output_long <- sim_output_wide %>% 
  dplyr::select(sim_ID, Hour, Drug, starts_with("rel_")) %>% 
  tidyr::pivot_longer(
    cols = c(Drug, starts_with("rel_")),
    names_to = "Species", 
    values_to = "Relative_abundance",
    names_prefix = "rel_",
    names_transform = list(Species = ~ ifelse(.x == "Drug", "Drug", .x))
  ) 

str(sim_output_long)


species_names_1 <- c(
  "A_muciniphila",
  "B_adolescentis",
  "B_fragilis",
  "B_longum",
  "B_obeum",
  "B_thetaiotaomicron",
  "B_uniformis",
  "B_vulgatus",
  "B_wadsworthia",
  "C_aerofaciens",
  "C_bolteae",
  "C_comes",
  "C_perfringens",
  "C_ramosum",
  "C_saccharolyticum",
  "D_formicigenerans",
  "E_coli",
  "E_lenta",
  "E_rectale",
  "F_nucleatum",
  "L_paracasei",
  "O_splanchnicus",
  "P_copri",
  "P_distasonis",
  "P_merdae",
  "R_bromii",
  "R_gnavus",
  "R_intestinalis",
  "R_torques",
  "S_parasanguinis",
  "S_salivarius",
  "V_parvula",
  "Drug"
)

species_colours_1 <- c(
  "A_muciniphila" = "#1f77b4",
  "B_adolescentis" = "#ff7f0e",
  "B_fragilis" = "#2ca02c",
  "B_longum" = "#d62728",
  "B_obeum" = "#9467bd",
  "B_thetaiotaomicron" = "black",
  "B_uniformis" = "#e377c2",
  "B_vulgatus" = "#7f7f7f",
  "B_wadsworthia" = "gold1",
  "C_aerofaciens" = "#aec7e8",
  "C_bolteae" = "#ffbb78",
  "C_comes" = "magenta",
  "C_perfringens" = "#ff9896",
  "C_ramosum" = "#c5b0d5",
  "C_saccharolyticum" = "#c49c94",
  "D_formicigenerans" = "#f7b6d2",
  "E_coli" = "yellow",
  "E_lenta" = "turquoise",
  "E_rectale" = "#393b79",
  "F_nucleatum" = "royalblue2",
  "L_paracasei" = "blue",
  "O_splanchnicus" = "#637939",
  "P_copri" = "cyan",
  "P_distasonis" = "#8c6d31",
  "P_merdae" = "#c7c7c7",
  "R_bromii" = "#e6550d",
  "R_gnavus" = "#e7cb94",
  "R_intestinalis" = "#843c39",
  "R_torques" = "#d6616b",
  "S_parasanguinis" = "orange3",
  "S_salivarius" = "#7b4173",
  "V_parvula" = "#ce6dbd",
  "Drug" = "green"
)



##Plot output for any specific sim:
# ggplot(subset(sim_output, sim_ID == 1 & Species_name != "Drug"), aes(x = Hour, y = Density, group = Species_name, color = Species_name)) +
#   geom_line(size = 1, alpha = 0.7) +
#   scale_color_manual(values = species_colours_1) +
#   labs(title = paste0("Doxycycline = ", drug_concentration_tested),
#        x = "Time (hours)",
#        y = "Population Density (OD)",
#        color = "Species") +
#   theme_minimal() +
#   theme(legend.position = "right")
# 
# ggplot(subset(sim_output, sim_ID == 3 & Species_name != "Drug"), aes(x = Hour, y = Density, group = Species_name, color = Species_name)) +
#   geom_line(size = 1, alpha = 0.7) +
#   scale_color_manual(values = species_colours_1) +
#   labs(title = paste0("Doxycycline = ", drug_concentration_tested),
#        x = "Time (hours)",
#        y = "Population Density (OD)",
#        color = "Species") +
#   theme_minimal() +
#   theme(legend.position = "right")


ggplot(subset(sim_output_long, sim_ID == 1), aes(x = Hour, y = Relative_abundance, group = Species, color = Species)) +
  geom_line(size = 1, alpha = 0.7) +
  scale_color_manual(values = species_colours_1) +
  labs(title = paste0("Doxycycline = ", drug_concentration_tested),
       x = "Time (hours)",
       y = "Relative abundance",
       color = "Species") +
  theme_minimal() +
  theme(legend.position = "right")


ggplot(subset(sim_output_long, sim_ID == 3), aes(x = Hour, y = Relative_abundance, group = Species, color = Species)) +
  geom_line(size = 1, alpha = 0.7) +
  scale_color_manual(values = species_colours_1) +
  labs(title = paste0("Doxycycline = ", drug_concentration_tested),
       x = "Time (hours)",
       y = "Relative abundance",
       color = "Species") +
  theme_minimal() +
  theme(legend.position = "right")


#calc mean and standard deviation across sims
sim_stats <- sim_output_long %>%
  dplyr::group_by(Hour, Species) %>%
  dplyr::summarise(
    mean_rel_ab = mean(Relative_abundance),
    sd_rel_ab = sd(Relative_abundance),
    .groups = 'drop'
  )

# Prepare the data for plotting
plot_data <- sim_stats %>%
  dplyr::mutate(Upper = mean_rel_ab + sd_rel_ab, Lower = mean_rel_ab - sd_rel_ab)

ggplot(subset(plot_data, Species != "Drug"), aes(x = Hour, y = mean_rel_ab, group = Species, color = Species)) +
  geom_ribbon(aes(ymin = Lower, ymax = Upper, fill = Species), colour = NA, alpha = 0.2) +  
  geom_line(size = 1, alpha = 0.7) + 
  scale_color_manual(values = species_colours_1) +
  scale_fill_manual(values = species_colours_1) +  
  labs(title = "Mean and SD of Relative Abundance Across Simulations",
       subtitle = paste0("Doxycycline = ", drug_concentration_tested),       
       x = "Time (hours)",
       y = "Relative abundance",
       color = "Species",
       fill = "Species") +
  theme_minimal() +
  theme(legend.position = "right")

#log-scaled mean trends
ggplot(plot_data, aes(x = Hour, y = log10(mean_rel_ab + 0.0001), group = Species, color = Species)) +
  geom_line(size = 1, alpha = 0.7) +  # Mean line
  scale_color_manual(values = species_colours_1) +
  scale_fill_manual(values = species_colours_1) +  # Ensure consistent colors for lines and fills
  labs(title = "Mean and SD of Relative Abundance Across Simulations",
       subtitle = paste0("Doxycycline = ", drug_concentration_tested),
       x = "Time (hours)",
       y = "Relative abundance",
       color = "Species",
       fill = "Species") +
  theme_minimal() +
  theme(legend.position = "right")




##prediction quality evaluation
drug_tested <- "Doxycycline"
variable_name <- paste0("plot_data_", ifelse(drug_concentration_tested == 1e-04, 0, drug_concentration_tested), "_", drug_tested)
assign(variable_name, plot_data)


#extract total OD info:
predicted_mean_final_od_NULL <- Niclosamide_16S_0uM_summarised$mean_com_final_OD[1]
predicted_sd_final_od_NULL <- Niclosamide_16S_0uM_summarised$sd_com_final_OD[1]


predicted_mean_final_od_0.5_Doxycycline <- mean(subset(sim_output_wide_0.5_Doxycycline, Hour == 48)$Total_OD, na.rm = TRUE)
predicted_sd_final_od_0.5_Doxycycline <- sd(subset(sim_output_wide_0.5_Doxycycline, Hour == 48)$Total_OD, na.rm = TRUE)

real_mean_final_od_0.5_Doxycycline <- Community_compositions_focus_drugs_Doxycycline_0.5uM_summarised$mean_final_OD[1]
real_sd_final_od_0.5_Doxycycline <- Community_compositions_focus_drugs_Doxycycline_0.5uM_summarised$sd_final_OD[1]


predicted_mean_final_od_2.5_Doxycycline <- mean(subset(sim_output_wide_2.5_Doxycycline, Hour == 48)$Total_OD, na.rm = TRUE)
predicted_sd_final_od_2.5_Doxycycline <- sd(subset(sim_output_wide_2.5_Doxycycline, Hour == 48)$Total_OD, na.rm = TRUE)

real_mean_final_od_2.5_Doxycycline <- Community_compositions_focus_drugs_Doxycycline_2.5uM_summarised$mean_final_OD[1]
real_sd_final_od_2.5_Doxycycline <- Community_compositions_focus_drugs_Doxycycline_2.5uM_summarised$sd_final_OD[1]




#plot_data_0_Doxycycline_endpoint was used to test model performance at 0 drugs
#plot_data_0_Doxycycline_endpoint <- subset(plot_data_0_Doxycycline, Hour == 48 & Species != "Drug")
plot_data_0.5_Doxycycline_endpoint <- subset(plot_data_0.5_Doxycycline, Hour == 48 & Species != "Drug")
plot_data_2.5_Doxycycline_endpoint <- subset(plot_data_2.5_Doxycycline, Hour == 48 & Species != "Drug")

##Inspecting 'match' to real relative abundance distributions:
Niclosamide_16S_0uM_summarised <- rel_ab_control
Niclosamide_16S_0uM_summarised$Species <- gsub("\\.", "", Niclosamide_16S_0uM_summarised$Species)

Doxycycline_16S_0.5uM_summarised <- Community_compositions_focus_drugs_Doxycycline_0.5uM_summarised
Doxycycline_16S_2.5uM_summarised <- Community_compositions_focus_drugs_Doxycycline_2.5uM_summarised

Niclosamide_16S_0uM_summarised
Doxycycline_16S_0.5uM_summarised 
Doxycycline_16S_2.5uM_summarised 

#Rename 'species' so the outputs become comparable
original_names_2.5 <- unique(Doxycycline_16S_2.5uM_summarised$species)
original_names_0.5 <- unique(Doxycycline_16S_0.5uM_summarised$species)


##Create a named vector with the original and new names mapping
name_changes <- c(
  "Akkermansia muciniphila" = "A_muciniphila",
  "Bacteroides fragilis" = "B_fragilis",
  "Bacteroides thetaiotaomicron" = "B_thetaiotaomicron",
  "Bacteroides uniformis" = "B_uniformis",
  "Bifidobacterium adolescentis" = "B_adolescentis",
  "Bifidobacterium longum subsp. longum" = "B_longum",
  "Bilophila wadsworthia" = "B_wadsworthia",
  "Blautia obeum" = "B_obeum",
  "Clostridium perfringens" = "C_perfringens",
  "Collinsella aerofaciens" = "C_aerofaciens",
  "Coprococcus comes" = "C_comes",
  "Dorea formicigenerans" = "D_formicigenerans",
  "Eggerthella lenta" = "E_lenta",
  "Enterocloster bolteae" = "C_bolteae",
  "Erysipelatoclostridium ramosum" = "C_ramosum",
  "Escherichia coli ED1a" = "E_coli",
  "Eubacterium rectale" = "E_rectale",
  "Fusobacterium nucleatum subsp. nucleatum" = "F_nucleatum",
  "Lacrimispora saccharolytica" = "C_saccharolyticum",
  "Lacticaseibacillus paracasei" = "L_paracasei",
  "Odoribacter splanchnicus" = "O_splanchnicus",
  "Parabacteroides distasonis" = "P_distasonis",
  "Parabacteroides merdae" = "P_merdae",
  "Phocaeicola vulgatus" = "B_vulgatus",
  "Prevotella copri" = "P_copri",
  "Roseburia intestinalis" = "R_intestinalis",
  "Ruminococcus bromii" = "R_bromii",
  "Ruminococcus gnavus" = "R_gnavus",
  "Ruminococcus torques" = "R_torques",
  "Streptococcus parasanguinis" = "S_parasanguinis",
  "Streptococcus salivarius" = "S_salivarius",
  "Veillonella parvula" = "V_parvula"
)

# Apply name changes to the species column in Doxycycline_16S_2.5uM_summarised

Doxycycline_16S_2.5uM_summarised$Species <- name_changes[Doxycycline_16S_2.5uM_summarised$species]
Doxycycline_16S_0.5uM_summarised$Species <- name_changes[Doxycycline_16S_0.5uM_summarised$species]


# Verify the changes
unique(Doxycycline_16S_2.5uM_summarised$Species)
unique(Doxycycline_16S_0.5uM_summarised$Species)






##Next, for 0.5 uM:
# Get top 6 species from plot_data_0.5_endpoint
# Adjust the plot_data_0.5_endpoint with confidence bounds
plot_data_0.5_Doxycycline_endpoint <- plot_data_0.5_Doxycycline_endpoint %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)

# Adjust the Doxycycline_16S_0.5uM_summarised with confidence bounds
Doxycycline_16S_0.5uM_summarised <- Doxycycline_16S_0.5uM_summarised %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)

#NULL model:
Null_model_summarised <- Niclosamide_16S_0uM_summarised %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)


# Get top 6 species based on the lower bound from plot_data_0.5_endpoint
top6_predicted_0.5_Doxycycline <- plot_data_0.5_Doxycycline_endpoint %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

# Get top 6 species based on the lower bound from Doxycycline_16S_0.5uM_summarised
top6_real_0.5_Doxycycline <- Doxycycline_16S_0.5uM_summarised %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

top6_NULL <- Null_model_summarised %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

# Calculate the overlap of top 6 species
top_six_correct_0.5_Doxycycline <- length(intersect(top6_predicted_0.5_Doxycycline, top6_real_0.5_Doxycycline))
#top_six_correct_0.5_Doxycycline

top_six_correct_0.5_Doxycycline_NULL <- length(intersect(top6_NULL, top6_real_0.5_Doxycycline))
#top_six_correct_0.5_Doxycycline_NULL

#top6_predicted_0.5_Doxycycline
#top6_real_0.5_Doxycycline



#Now by means:
top6_predicted_0.5_Doxycycline_means <- plot_data_0.5_Doxycycline_endpoint %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)

# Get top 6 species based on the lower bound from Doxycycline_16S_0.5uM_summarised
top6_real_0.5_Doxycycline_means <- Doxycycline_16S_0.5uM_summarised %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)

top6_NULL_means <- Null_model_summarised %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)



top_six_correct_0.5_Doxycycline_means <- length(intersect(top6_predicted_0.5_Doxycycline_means, top6_real_0.5_Doxycycline_means))
#top_six_correct_0.5_Doxycycline_means

top_six_correct_0.5_Doxycycline_means_NULL <- length(intersect(top6_NULL_means, top6_real_0.5_Doxycycline_means))
#top_six_correct_0.5_Doxycycline_means_NULL

top6_predicted_0.5_Doxycycline_means
#top6_real_0.5_Doxycycline_means




# Merge dataframes by Species
merged_data_0.5_Doxycycline <- merge(plot_data_0.5_Doxycycline_endpoint, Doxycycline_16S_0.5uM_summarised, by = "Species", suffixes = c(".pred", ".real"))
merged_data_0.5_Doxycycline_NULL <- merge(Niclosamide_16S_0uM_summarised, Doxycycline_16S_0.5uM_summarised, by = "Species", suffixes = c(".null", ".real"))



# Create lower and upper bounds considering mean ¬± sd
merged_data_0.5_Doxycycline$lower_bound_pred <- merged_data_0.5_Doxycycline$mean_rel_ab.pred - merged_data_0.5_Doxycycline$sd_rel_ab.pred
merged_data_0.5_Doxycycline$upper_bound_pred <- merged_data_0.5_Doxycycline$mean_rel_ab.pred + merged_data_0.5_Doxycycline$sd_rel_ab.pred
merged_data_0.5_Doxycycline$lower_bound_real <- merged_data_0.5_Doxycycline$mean_rel_ab.real - merged_data_0.5_Doxycycline$sd_rel_ab.real
merged_data_0.5_Doxycycline$upper_bound_real <- merged_data_0.5_Doxycycline$mean_rel_ab.real + merged_data_0.5_Doxycycline$sd_rel_ab.real

# Ensure lower and upper bounds are non-negative, adjusting as necessary
merged_data_0.5_Doxycycline$lower_bound_pred[merged_data_0.5_Doxycycline$lower_bound_pred <= 0] <- 1e-10
merged_data_0.5_Doxycycline$lower_bound_real[merged_data_0.5_Doxycycline$lower_bound_real <= 0] <- 1e-10
merged_data_0.5_Doxycycline$upper_bound_pred[merged_data_0.5_Doxycycline$upper_bound_pred <= 0] <- 1e-10
merged_data_0.5_Doxycycline$upper_bound_real[merged_data_0.5_Doxycycline$upper_bound_real <= 0] <- 1e-10

##and for NULL model:
# Create lower and upper bounds considering mean ¬± sd
merged_data_0.5_Doxycycline_NULL$lower_bound_null <- merged_data_0.5_Doxycycline_NULL$mean_rel_ab.null - merged_data_0.5_Doxycycline_NULL$sd_rel_ab.null
merged_data_0.5_Doxycycline_NULL$upper_bound_null <- merged_data_0.5_Doxycycline_NULL$mean_rel_ab.null + merged_data_0.5_Doxycycline_NULL$sd_rel_ab.null
merged_data_0.5_Doxycycline_NULL$lower_bound_real <- merged_data_0.5_Doxycycline_NULL$mean_rel_ab.real - merged_data_0.5_Doxycycline_NULL$sd_rel_ab.real
merged_data_0.5_Doxycycline_NULL$upper_bound_real <- merged_data_0.5_Doxycycline_NULL$mean_rel_ab.real + merged_data_0.5_Doxycycline_NULL$sd_rel_ab.real

# Ensure lower and upper bounds are non-negative, adjusting as necessary
merged_data_0.5_Doxycycline_NULL$lower_bound_null[merged_data_0.5_Doxycycline_NULL$lower_bound_null <= 0] <- 1e-10
merged_data_0.5_Doxycycline_NULL$lower_bound_real[merged_data_0.5_Doxycycline_NULL$lower_bound_real <= 0] <- 1e-10
merged_data_0.5_Doxycycline_NULL$upper_bound_null[merged_data_0.5_Doxycycline_NULL$upper_bound_null <= 0] <- 1e-10
merged_data_0.5_Doxycycline_NULL$upper_bound_real[merged_data_0.5_Doxycycline_NULL$upper_bound_real <= 0] <- 1e-10

# Filter to include only species with a mean relative abundance > 0.01 in the 'real' dataset
significant_species <- merged_data_0.5_Doxycycline[merged_data_0.5_Doxycycline$mean_rel_ab.real > 0.01, ]
survivors_0.5_Doxycycline <- nrow(significant_species)
survivors_0.5_Doxycycline

#should be the same as survivors defined above, since it is calculated from .real
significant_species_NULL <- merged_data_0.5_Doxycycline_NULL[merged_data_0.5_Doxycycline_NULL$mean_rel_ab.real > 0.01, ]
survivors_0.5_Doxycycline_NULL <- nrow(significant_species_NULL)
survivors_0.5_Doxycycline_NULL

# Adjusted order of magnitude check to include SD, only for significant species
significant_species$Predicted_magnitude_correct <- ifelse(
  (floor(log10(significant_species$lower_bound_pred)) <= floor(log10(significant_species$upper_bound_real)) &
     floor(log10(significant_species$upper_bound_pred)) >= floor(log10(significant_species$lower_bound_real))),
  1,
  0
)

#and for the Null model:
significant_species_NULL$Predicted_magnitude_correct <- ifelse(
  (floor(log10(significant_species_NULL$lower_bound_null)) <= floor(log10(significant_species_NULL$upper_bound_real)) &
     floor(log10(significant_species_NULL$upper_bound_null)) >= floor(log10(significant_species_NULL$lower_bound_real))),
  1,
  0
)

# Calculate the fraction of correctly predicted magnitudes for significant species
predicted_magnitude_correct_fraction_0.5_Doxycycline <- sum(significant_species$Predicted_magnitude_correct) / nrow(significant_species)
predicted_magnitude_correct_fraction_0.5_Doxycycline

predicted_magnitude_correct_fraction_0.5_Doxycycline_NULL <- sum(significant_species_NULL$Predicted_magnitude_correct) / nrow(significant_species_NULL)
predicted_magnitude_correct_fraction_0.5_Doxycycline_NULL

top_species_missing_0.5_Doxycycline <- setdiff(top6_real_0.5_Doxycycline_means, top6_predicted_0.5_Doxycycline_means)
top_species_wrong_0.5_Doxycycline <- setdiff(top6_predicted_0.5_Doxycycline_means, top6_real_0.5_Doxycycline_means)

Prediction_quality_0.5_Doxycycline <- data.frame(
  Top_six_correct = paste(top_six_correct_0.5_Doxycycline, sep=""),
  Top_six_correct_NULL = paste(top_six_correct_0.5_Doxycycline_NULL, sep=""),
  Top_six_correct_means = paste(top_six_correct_0.5_Doxycycline_means, sep=""),
  Top_six_correct_means_NULL = paste(top_six_correct_0.5_Doxycycline_means_NULL, sep=""),
  Predicted_magnitude_correct = paste(round(predicted_magnitude_correct_fraction_0.5_Doxycycline * 100, 2), "%", sep=""),
  Predicted_magnitude_correct_NULL = paste(round(predicted_magnitude_correct_fraction_0.5_Doxycycline_NULL * 100, 2), "%", sep=""),
  survivors_total = survivors_0.5_Doxycycline,
  top_species_missing <- top_species_missing_0.5_Doxycycline,
  top_species_wrong <- top_species_wrong_0.5_Doxycycline, 
  predicted_mean_final_OD <- predicted_mean_final_od_0.5_Doxycycline,
  real_mean_final_OD <- real_mean_final_od_0.5_Doxycycline,
  sims_total = length(successful_sim_ids)
)

Prediction_quality_0.5_Doxycycline






##Next, for 2.5 uM:
# Get top 6 species from plot_data_2.5_endpoint
# Adjust the plot_data_2.5_endpoint with confidence bounds
plot_data_2.5_Doxycycline_endpoint <- plot_data_2.5_Doxycycline_endpoint %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)

# Adjust the Doxycycline_16S_2.5uM_summarised with confidence bounds
Doxycycline_16S_2.5uM_summarised <- Doxycycline_16S_2.5uM_summarised %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)

#NULL model:
Null_model_summarised <- Niclosamide_16S_0uM_summarised %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)


# Get top 6 species based on the lower bound from plot_data_2.5_endpoint
top6_predicted_2.5_Doxycycline <- plot_data_2.5_Doxycycline_endpoint %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

# Get top 6 species based on the lower bound from Doxycycline_16S_2.5uM_summarised
top6_real_2.5_Doxycycline <- Doxycycline_16S_2.5uM_summarised %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

top6_NULL <- Null_model_summarised %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

# Calculate the overlap of top 6 species
top_six_correct_2.5_Doxycycline <- length(intersect(top6_predicted_2.5_Doxycycline, top6_real_2.5_Doxycycline))
#top_six_correct_2.5_Doxycycline

top_six_correct_2.5_Doxycycline_NULL <- length(intersect(top6_NULL, top6_real_2.5_Doxycycline))
#top_six_correct_2.5_Doxycycline_NULL

#top6_predicted_2.5_Doxycycline
#top6_real_2.5_Doxycycline




#Now by means:
top6_predicted_2.5_Doxycycline_means <- plot_data_2.5_Doxycycline_endpoint %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)

# Get top 6 species based on the lower bound from Doxycycline_16S_2.5uM_summarised
top6_real_2.5_Doxycycline_means <- Doxycycline_16S_2.5uM_summarised %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)

top6_NULL_means <- Null_model_summarised %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)



top_six_correct_2.5_Doxycycline_means <- length(intersect(top6_predicted_2.5_Doxycycline_means, top6_real_2.5_Doxycycline_means))
#top_six_correct_2.5_Doxycycline_means

top_six_correct_2.5_Doxycycline_means_NULL <- length(intersect(top6_NULL_means, top6_real_2.5_Doxycycline_means))
#top_six_correct_2.5_Doxycycline_means_NULL

#top6_predicted_2.5_Doxycycline_means
#top6_real_2.5_Doxycycline_means




# Merge dataframes by Species
merged_data_2.5_Doxycycline <- merge(plot_data_2.5_Doxycycline_endpoint, Doxycycline_16S_2.5uM_summarised, by = "Species", suffixes = c(".pred", ".real"))
merged_data_2.5_Doxycycline_NULL <- merge(Niclosamide_16S_0uM_summarised, Doxycycline_16S_2.5uM_summarised, by = "Species", suffixes = c(".null", ".real"))



# Create lower and upper bounds considering mean ¬± sd
merged_data_2.5_Doxycycline$lower_bound_pred <- merged_data_2.5_Doxycycline$mean_rel_ab.pred - merged_data_2.5_Doxycycline$sd_rel_ab.pred
merged_data_2.5_Doxycycline$upper_bound_pred <- merged_data_2.5_Doxycycline$mean_rel_ab.pred + merged_data_2.5_Doxycycline$sd_rel_ab.pred
merged_data_2.5_Doxycycline$lower_bound_real <- merged_data_2.5_Doxycycline$mean_rel_ab.real - merged_data_2.5_Doxycycline$sd_rel_ab.real
merged_data_2.5_Doxycycline$upper_bound_real <- merged_data_2.5_Doxycycline$mean_rel_ab.real + merged_data_2.5_Doxycycline$sd_rel_ab.real

# Ensure lower and upper bounds are non-negative, adjusting as necessary
merged_data_2.5_Doxycycline$lower_bound_pred[merged_data_2.5_Doxycycline$lower_bound_pred <= 0] <- 1e-10
merged_data_2.5_Doxycycline$lower_bound_real[merged_data_2.5_Doxycycline$lower_bound_real <= 0] <- 1e-10
merged_data_2.5_Doxycycline$upper_bound_pred[merged_data_2.5_Doxycycline$upper_bound_pred <= 0] <- 1e-10
merged_data_2.5_Doxycycline$upper_bound_real[merged_data_2.5_Doxycycline$upper_bound_real <= 0] <- 1e-10

##and for NULL model:
# Create lower and upper bounds considering mean ¬± sd
merged_data_2.5_Doxycycline_NULL$lower_bound_null <- merged_data_2.5_Doxycycline_NULL$mean_rel_ab.null - merged_data_2.5_Doxycycline_NULL$sd_rel_ab.null
merged_data_2.5_Doxycycline_NULL$upper_bound_null <- merged_data_2.5_Doxycycline_NULL$mean_rel_ab.null + merged_data_2.5_Doxycycline_NULL$sd_rel_ab.null
merged_data_2.5_Doxycycline_NULL$lower_bound_real <- merged_data_2.5_Doxycycline_NULL$mean_rel_ab.real - merged_data_2.5_Doxycycline_NULL$sd_rel_ab.real
merged_data_2.5_Doxycycline_NULL$upper_bound_real <- merged_data_2.5_Doxycycline_NULL$mean_rel_ab.real + merged_data_2.5_Doxycycline_NULL$sd_rel_ab.real

# Ensure lower and upper bounds are non-negative, adjusting as necessary
merged_data_2.5_Doxycycline_NULL$lower_bound_null[merged_data_2.5_Doxycycline_NULL$lower_bound_null <= 0] <- 1e-10
merged_data_2.5_Doxycycline_NULL$lower_bound_real[merged_data_2.5_Doxycycline_NULL$lower_bound_real <= 0] <- 1e-10
merged_data_2.5_Doxycycline_NULL$upper_bound_null[merged_data_2.5_Doxycycline_NULL$upper_bound_null <= 0] <- 1e-10
merged_data_2.5_Doxycycline_NULL$upper_bound_real[merged_data_2.5_Doxycycline_NULL$upper_bound_real <= 0] <- 1e-10

# Filter to include only species with a mean relative abundance > 0.01 in the 'real' dataset
significant_species <- merged_data_2.5_Doxycycline[merged_data_2.5_Doxycycline$mean_rel_ab.real > 0.01, ]
survivors_2.5_Doxycycline <- nrow(significant_species)
survivors_2.5_Doxycycline

#should be the same as survivors defined above, since it is calculated from .real
significant_species_NULL <- merged_data_2.5_Doxycycline_NULL[merged_data_2.5_Doxycycline_NULL$mean_rel_ab.real > 0.01, ]
survivors_2.5_Doxycycline_NULL <- nrow(significant_species_NULL)
survivors_2.5_Doxycycline_NULL

# Adjusted order of magnitude check to include SD, only for significant species
significant_species$Predicted_magnitude_correct <- ifelse(
  (floor(log10(significant_species$lower_bound_pred)) <= floor(log10(significant_species$upper_bound_real)) &
     floor(log10(significant_species$upper_bound_pred)) >= floor(log10(significant_species$lower_bound_real))),
  1,
  0
)

#and for the Null model:
significant_species_NULL$Predicted_magnitude_correct <- ifelse(
  (floor(log10(significant_species_NULL$lower_bound_null)) <= floor(log10(significant_species_NULL$upper_bound_real)) &
     floor(log10(significant_species_NULL$upper_bound_null)) >= floor(log10(significant_species_NULL$lower_bound_real))),
  1,
  0
)

# Calculate the fraction of correctly predicted magnitudes for significant species
predicted_magnitude_correct_fraction_2.5_Doxycycline <- sum(significant_species$Predicted_magnitude_correct) / nrow(significant_species)
predicted_magnitude_correct_fraction_2.5_Doxycycline

predicted_magnitude_correct_fraction_2.5_Doxycycline_NULL <- sum(significant_species_NULL$Predicted_magnitude_correct) / nrow(significant_species_NULL)
predicted_magnitude_correct_fraction_2.5_Doxycycline_NULL


top_species_missing_2.5_Doxycycline <- setdiff(top6_real_2.5_Doxycycline_means, top6_predicted_2.5_Doxycycline_means)
top_species_wrong_2.5_Doxycycline <- setdiff(top6_predicted_2.5_Doxycycline_means, top6_real_2.5_Doxycycline_means)

Prediction_quality_2.5_Doxycycline <- data.frame(
  Top_six_correct = paste(top_six_correct_2.5_Doxycycline, sep=""),
  Top_six_correct_NULL = paste(top_six_correct_2.5_Doxycycline_NULL, sep=""),
  Top_six_correct_means = paste(top_six_correct_2.5_Doxycycline_means, sep=""),
  Top_six_correct_means_NULL = paste(top_six_correct_2.5_Doxycycline_means_NULL, sep=""),
  Predicted_magnitude_correct = paste(round(predicted_magnitude_correct_fraction_2.5_Doxycycline * 100, 2), "%", sep=""),
  Predicted_magnitude_correct_NULL = paste(round(predicted_magnitude_correct_fraction_2.5_Doxycycline_NULL * 100, 2), "%", sep=""),
  survivors_total = survivors_2.5_Doxycycline,
  top_species_missing <- top_species_missing_2.5_Doxycycline,
  top_species_wrong <- top_species_wrong_2.5_Doxycycline, 
  predicted_mean_final_OD <- predicted_mean_final_od_2.5_Doxycycline,
  real_mean_final_OD <- real_mean_final_od_2.5_Doxycycline,
  sims_total = length(successful_sim_ids)
)

Prediction_quality_2.5_Doxycycline










##Ebselen

combined_monoculture_aucs2_Ebselen <- subset(combined_monoculture_aucs2, drug == "Ebselen")


#drug sensitivity terms: define once outside of ODEs
y_function_B_vulgatus_Ebselen <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("B_vulgatus", "Ebselen", best_fitting_models_df_Ebselen)), collapse = " ")))
y_function_B_uniformis_Ebselen <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("B_uniformis", "Ebselen", best_fitting_models_df_Ebselen)), collapse = " ")))
y_function_B_fragilis_Ebselen <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("B_fragilis", "Ebselen", best_fitting_models_df_Ebselen)), collapse = " ")))
y_function_B_thetaiotaomicron_Ebselen <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("B_thetaiotaomicron", "Ebselen", best_fitting_models_df_Ebselen)), collapse = " ")))
y_function_C_ramosum_Ebselen <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("C_ramosum", "Ebselen", best_fitting_models_df_Ebselen)), collapse = " ")))
y_function_E_rectale_Ebselen <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("E_rectale", "Ebselen", best_fitting_models_df_Ebselen)), collapse = " ")))
y_function_R_intestinalis_Ebselen <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("R_intestinalis", "Ebselen", best_fitting_models_df_Ebselen)), collapse = " ")))
y_function_V_parvula_Ebselen <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("V_parvula", "Ebselen", best_fitting_models_df_Ebselen)), collapse = " ")))
y_function_E_lenta_Ebselen <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("E_lenta", "Ebselen", best_fitting_models_df_Ebselen)), collapse = " ")))
y_function_F_nucleatum_Ebselen <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("F_nucleatum", "Ebselen", best_fitting_models_df_Ebselen)), collapse = " ")))
y_function_C_bolteae_Ebselen <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("C_bolteae", "Ebselen", best_fitting_models_df_Ebselen)), collapse = " ")))
y_function_C_perfringens_Ebselen <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("C_perfringens", "Ebselen", best_fitting_models_df_Ebselen)), collapse = " ")))
y_function_C_saccharolyticum_Ebselen <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("C_saccharolyticum", "Ebselen", best_fitting_models_df_Ebselen)), collapse = " ")))
y_function_S_salivarius_Ebselen <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("S_salivarius", "Ebselen", best_fitting_models_df_Ebselen)), collapse = " ")))
y_function_R_gnavus_Ebselen <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("R_gnavus", "Ebselen", best_fitting_models_df_Ebselen)), collapse = " ")))
y_function_C_comes_Ebselen <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("C_comes", "Ebselen", best_fitting_models_df_Ebselen)), collapse = " ")))
y_function_P_merdae_Ebselen <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("P_merdae", "Ebselen", best_fitting_models_df_Ebselen)), collapse = " ")))
y_function_S_parasanguinis_Ebselen <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("S_parasanguinis", "Ebselen", best_fitting_models_df_Ebselen)), collapse = " ")))
y_function_C_aerofaciens_Ebselen <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("C_aerofaciens", "Ebselen", best_fitting_models_df_Ebselen)), collapse = " ")))
y_function_D_formicigenerans_Ebselen <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("D_formicigenerans", "Ebselen", best_fitting_models_df_Ebselen)), collapse = " ")))
y_function_E_coli_Ebselen <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("E_coli", "Ebselen", best_fitting_models_df_Ebselen)), collapse = " ")))



y_function_B_vulgatus_Ebselen_func <- eval(parse(text = paste("function(Drug) {", y_function_B_vulgatus_Ebselen, "}")))
y_function_B_uniformis_Ebselen_func <- eval(parse(text = paste("function(Drug) {", y_function_B_uniformis_Ebselen, "}")))
y_function_B_fragilis_Ebselen_func <- eval(parse(text = paste("function(Drug) {", y_function_B_fragilis_Ebselen, "}")))
y_function_B_thetaiotaomicron_Ebselen_func <- eval(parse(text = paste("function(Drug) {", y_function_B_thetaiotaomicron_Ebselen, "}")))
y_function_C_ramosum_Ebselen_func <- eval(parse(text = paste("function(Drug) {", y_function_C_ramosum_Ebselen, "}")))
y_function_E_rectale_Ebselen_func <- eval(parse(text = paste("function(Drug) {", y_function_E_rectale_Ebselen, "}")))
y_function_R_intestinalis_Ebselen_func <- eval(parse(text = paste("function(Drug) {", y_function_R_intestinalis_Ebselen, "}")))
y_function_E_lenta_Ebselen_func <- eval(parse(text = paste("function(Drug) {", y_function_E_lenta_Ebselen, "}")))
y_function_F_nucleatum_Ebselen_func <- eval(parse(text = paste("function(Drug) {", y_function_F_nucleatum_Ebselen, "}")))
y_function_C_bolteae_Ebselen_func <- eval(parse(text = paste("function(Drug) {", y_function_C_bolteae_Ebselen, "}")))
y_function_C_perfringens_Ebselen_func <- eval(parse(text = paste("function(Drug) {", y_function_C_perfringens_Ebselen, "}")))
y_function_C_saccharolyticum_Ebselen_func <- eval(parse(text = paste("function(Drug) {", y_function_C_saccharolyticum_Ebselen, "}")))
y_function_S_salivarius_Ebselen_func <- eval(parse(text = paste("function(Drug) {", y_function_S_salivarius_Ebselen, "}")))
y_function_R_gnavus_Ebselen_func <- eval(parse(text = paste("function(Drug) {", y_function_R_gnavus_Ebselen, "}")))
y_function_C_comes_Ebselen_func <- eval(parse(text = paste("function(Drug) {", y_function_C_comes_Ebselen, "}")))
y_function_P_merdae_Ebselen_func <- eval(parse(text = paste("function(Drug) {", y_function_P_merdae_Ebselen, "}")))
y_function_S_parasanguinis_Ebselen_func <- eval(parse(text = paste("function(Drug) {", y_function_S_parasanguinis_Ebselen, "}")))
y_function_C_aerofaciens_Ebselen_func <- eval(parse(text = paste("function(Drug) {", y_function_C_aerofaciens_Ebselen, "}")))
y_function_D_formicigenerans_Ebselen_func <- eval(parse(text = paste("function(Drug) {", y_function_D_formicigenerans_Ebselen, "}")))
y_function_E_coli_Ebselen_func <- eval(parse(text = paste("function(Drug) {", y_function_E_coli_Ebselen, "}")))
y_function_V_parvula_Ebselen_func <- eval(parse(text = paste("function(Drug) {", y_function_V_parvula_Ebselen, "}")))



unique(combined_monoculture_aucs2_Ebselen$conc)
##dictate drug concentration tested for simulation cycle here:
#drug_concentration_tested <- 1.25 #if manually or:
drug_concentration_tested <- unique(combined_monoculture_aucs2_Ebselen$conc)[1] 
initial_conditions <- rep(0.01/32, 32)
initial_conditions <- c(initial_conditions, drug_concentration_tested)


##drug effect fitted for species showing sensitivity in monoculture:
#unique(combined_monoculture_aucs2_Ebselen$Species)

##for more simple linear fits
closed.sir.model_Ebselen <- function (t, x, params) {
  ## first extract the state variables
  A_muciniphila <- x[1]
  B_adolescentis <- x[2]
  B_fragilis <- x[3]
  B_longum <- x[4]
  B_obeum <- x[5]
  B_thetaiotaomicron <- x[6]
  B_uniformis <- x[7]
  B_vulgatus <- x[8]
  B_wadsworthia <- x[9]
  C_aerofaciens <- x[10]
  C_bolteae <- x[11]
  C_comes <- x[12]
  C_perfringens <- x[13]
  C_ramosum <- x[14]
  C_saccharolyticum <- x[15]
  D_formicigenerans <- x[16]
  E_coli <- x[17]
  E_lenta <- x[18]
  E_rectale <- x[19]
  F_nucleatum <- x[20]
  L_paracasei <- x[21]
  O_splanchnicus <- x[22]
  P_copri <- x[23]
  P_distasonis <- x[24]
  P_merdae <- x[25]
  R_bromii <- x[26]
  R_gnavus <- x[27]
  R_intestinalis <- x[28]
  R_torques <- x[29]
  S_parasanguinis <- x[30]
  S_salivarius <- x[31]
  V_parvula <- x[32]
  Drug <- x[33]
  
  
  ## now extract the parameters
  r_B_fragilis <- flat_params[["B._fragilis.r"]]
  K_B_fragilis <- flat_params[["B._fragilis.K"]]
  r_B_longum <- flat_params[["B._longum.r"]]
  K_B_longum <- flat_params[["B._longum.K"]]
  r_B_thetaiotaomicron <- flat_params[["B._thetaiotaomicron.r"]]
  K_B_thetaiotaomicron <- flat_params[["B._thetaiotaomicron.K"]]
  r_B_uniformis <- flat_params[["B._uniformis.r"]]
  K_B_uniformis <- flat_params[["B._uniformis.K"]]
  r_B_vulgatus <- flat_params[["B._vulgatus.r"]]
  K_B_vulgatus <- flat_params[["B._vulgatus.K"]]
  r_B_wadsworthia <- flat_params[["B._wadsworthia.r"]]
  K_B_wadsworthia <- flat_params[["B._wadsworthia.K"]]
  r_C_aerofaciens <- flat_params[["C._aerofaciens.r"]]
  K_C_aerofaciens <- flat_params[["C._aerofaciens.K"]]
  r_C_bolteae <- flat_params[["C._bolteae.r"]]
  K_C_bolteae <- flat_params[["C._bolteae.K"]]
  r_C_comes <- flat_params[["C._comes.r"]]
  K_C_comes <- flat_params[["C._comes.K"]]
  r_C_perfringens <- flat_params[["C._perfringens.r"]]
  K_C_perfringens <- flat_params[["C._perfringens.K"]]
  r_C_ramosum <- flat_params[["C._ramosum.r"]]
  K_C_ramosum <- flat_params[["C._ramosum.K"]]
  r_C_saccharolyticum <- flat_params[["C._saccharolyticum.r"]]
  K_C_saccharolyticum <- flat_params[["C._saccharolyticum.K"]]
  r_D_formicigenerans <- flat_params[["D._formicigenerans.r"]]
  K_D_formicigenerans <- flat_params[["D._formicigenerans.K"]]
  r_E_coli <- flat_params[["E._coli.r"]]
  K_E_coli <- flat_params[["E._coli.K"]]
  r_E_lenta <- flat_params[["E._lenta.r"]]
  K_E_lenta <- flat_params[["E._lenta.K"]]
  r_E_rectale <- flat_params[["E._rectale.r"]]
  K_E_rectale <- flat_params[["E._rectale.K"]]
  r_F_nucleatum <- flat_params[["F._nucleatum.r"]]
  K_F_nucleatum <- flat_params[["F._nucleatum.K"]]
  r_P_copri <- flat_params[["P._copri.r"]]
  K_P_copri <- flat_params[["P._copri.K"]]
  r_P_merdae <- flat_params[["P._merdae.r"]]
  K_P_merdae <- flat_params[["P._merdae.K"]]
  r_R_gnavus <- flat_params[["R._gnavus.r"]]
  K_R_gnavus <- flat_params[["R._gnavus.K"]]
  r_R_intestinalis <- flat_params[["R._intestinalis.r"]]
  K_R_intestinalis <- flat_params[["R._intestinalis.K"]]
  r_V_parvula <- flat_params[["V._parvula.r"]]
  K_V_parvula <- flat_params[["V._parvula.K"]]
  r_A_muciniphila <- flat_params[["A._muciniphila.r"]]
  K_A_muciniphila <- flat_params[["A._muciniphila.K"]]
  r_B_adolescentis <- flat_params[["B._adolescentis.r"]]
  K_B_adolescentis <- flat_params[["B._adolescentis.K"]]
  r_B_obeum <- flat_params[["B._obeum.r"]]
  K_B_obeum <- flat_params[["B._obeum.K"]]
  r_O_splanchnicus <- flat_params[["O._splanchnicus.r"]]
  K_O_splanchnicus <- flat_params[["O._splanchnicus.K"]]
  r_P_distasonis <- flat_params[["P._distasonis.r"]]
  K_P_distasonis <- flat_params[["P._distasonis.K"]]
  r_R_bromii <- flat_params[["R._bromii.r"]]
  K_R_bromii <- flat_params[["R._bromii.K"]]
  r_R_torques <- flat_params[["R._torques.r"]]
  K_R_torques <- flat_params[["R._torques.K"]]
  r_S_parasanguinis <- flat_params[["S._parasanguinis.r"]]
  K_S_parasanguinis <-flat_params[["S._parasanguinis.K"]]
  r_S_salivarius <- flat_params[["S._salivarius.r"]]
  K_S_salivarius <- flat_params[["S._salivarius.K"]]
  r_L_paracasei <- flat_params[["L._paracasei.r"]]
  K_L_paracasei <- flat_params[["L._paracasei.K"]]
  
  
  t_mod <- ifelse(t > 24.1, t - 24.1, t)
  
  
  ## now code the model equations
  dA_muciniphila_dt <- r_A_muciniphila * A_muciniphila * (1 - A_muciniphila / K_A_muciniphila)
  dB_adolescentis_dt <- r_B_adolescentis * B_adolescentis * (1 - B_adolescentis / K_B_adolescentis)
  dB_fragilis_dt <- r_B_fragilis * B_fragilis * (1 - B_fragilis / max(0.0001, K_B_fragilis * (y_function_B_fragilis_Ebselen_func(Drug))))
  dB_longum_dt <- r_B_longum * B_longum * (1 - B_longum / K_B_longum)
  dB_obeum_dt <- r_B_obeum * B_obeum * (1 - B_obeum / K_B_obeum)
  dB_thetaiotaomicron_dt <- r_B_thetaiotaomicron * B_thetaiotaomicron * (1 - B_thetaiotaomicron / max(0.0001, K_B_thetaiotaomicron * (y_function_B_thetaiotaomicron_Ebselen_func(Drug))))  
  dB_uniformis_dt <- r_B_uniformis * B_uniformis * (1 - B_uniformis / max(0.0001, K_B_uniformis * (y_function_B_uniformis_Ebselen_func(Drug))))
  dB_vulgatus_dt <- r_B_vulgatus * B_vulgatus * (1 - B_vulgatus / max(0.0001, K_B_vulgatus * (y_function_B_vulgatus_Ebselen_func(Drug))))
  dB_wadsworthia_dt <- r_B_wadsworthia * B_wadsworthia * (1 - B_wadsworthia / K_B_wadsworthia)
  dC_aerofaciens_dt <- r_C_aerofaciens * C_aerofaciens * (1 - C_aerofaciens / max(0.0001, K_C_aerofaciens * (y_function_C_aerofaciens_Ebselen_func(Drug))))
  dC_bolteae_dt <- r_C_bolteae * C_bolteae * (1 - C_bolteae /  max(0.0001, K_C_bolteae * (y_function_C_bolteae_Ebselen_func(Drug))))
  dC_comes_dt <- r_C_comes * C_comes * (1 - C_comes / max(0.0001, K_C_comes * (y_function_C_comes_Ebselen_func(Drug))))
  dC_perfringens_dt <- r_C_perfringens * C_perfringens * (1 - C_perfringens / max(0.0001, K_C_perfringens * (y_function_C_perfringens_Ebselen_func(Drug))))
  dC_ramosum_dt <- r_C_ramosum * C_ramosum * (1 - C_ramosum / max(0.0001, K_C_ramosum * (y_function_C_ramosum_Ebselen_func(Drug))))
  dC_saccharolyticum_dt <- r_C_saccharolyticum * C_saccharolyticum * (1 - C_saccharolyticum / max(0.0001, K_C_saccharolyticum * (y_function_C_saccharolyticum_Ebselen_func(Drug))))
  dD_formicigenerans_dt <- r_D_formicigenerans * D_formicigenerans * (1 - D_formicigenerans / max(0.0001, K_D_formicigenerans * (y_function_D_formicigenerans_Ebselen_func(Drug))))
  dE_coli_dt <- r_E_coli * E_coli * (1 - E_coli / max(0.0001, K_E_coli * (y_function_E_coli_Ebselen_func(Drug))))
  dE_lenta_dt <- r_E_lenta * E_lenta * (1 - E_lenta / max(0.0001, K_E_lenta * (y_function_E_lenta_Ebselen_func(Drug))))
  dE_rectale_dt <- r_E_rectale * E_rectale * (1 - E_rectale / max(0.0001, K_E_rectale * (y_function_E_rectale_Ebselen_func(Drug))))
  dF_nucleatum_dt <- r_F_nucleatum * F_nucleatum * (1 - F_nucleatum / max(0.0001, K_F_nucleatum * (y_function_F_nucleatum_Ebselen_func(Drug))))
  dL_paracasei_dt <- r_L_paracasei * L_paracasei * (1 - L_paracasei / K_L_paracasei)  
  dO_splanchnicus_dt <- r_O_splanchnicus * O_splanchnicus * (1 - O_splanchnicus / K_O_splanchnicus)  
  dP_copri_dt <- r_P_copri * P_copri * (1 - P_copri / K_P_copri)
  dP_distasonis_dt <- r_P_distasonis * P_distasonis * (1 - P_distasonis / K_P_distasonis)  
  dP_merdae_dt <- r_P_merdae * P_merdae * (1 - P_merdae / max(0.0001, K_P_merdae * (y_function_P_merdae_Ebselen_func(Drug))))
  dR_bromii_dt <- r_R_bromii * R_bromii * (1 - R_bromii / K_R_bromii) 
  dR_gnavus_dt <- r_R_gnavus * R_gnavus * (1 - R_gnavus / max(0.0001, K_R_gnavus * (y_function_R_gnavus_Ebselen_func(Drug))))
  dR_intestinalis_dt <- r_R_intestinalis * R_intestinalis * (1 - R_intestinalis / max(0.0001, K_R_intestinalis * (y_function_R_intestinalis_Ebselen_func(Drug))))
  dR_torques_dt <- r_R_torques * R_torques * (1 - R_torques /K_R_torques) 
  dS_parasanguinis_dt <- r_S_parasanguinis * S_parasanguinis * (1 - S_parasanguinis / max(0.0001, K_S_parasanguinis * (y_function_S_parasanguinis_Ebselen_func(Drug))))
  dS_salivarius_dt <- r_S_salivarius * S_salivarius * (1 - S_salivarius / max(0.0001, K_S_salivarius * (y_function_S_salivarius_Ebselen_func(Drug))))
  dV_parvula_dt <- r_V_parvula * V_parvula * (1 - V_parvula / max(0.0001, K_V_parvula * (y_function_V_parvula_Ebselen_func(Drug))))
  
  
  
  #Drug differential:
  dDrug_dt <- (subset(drug_dynamics, Drug == "Ebselen")$Steepness_param_community * exp(-subset(drug_dynamics, Drug == "Ebselen")$Steepness_param_community * t_mod)) * (drug_concentration_tested * prop_left_Ebselen - drug_concentration_tested)
  #dDrug_dt <- 0
  
  ## Combine results into a single vector
  dxdt <- c(dA_muciniphila_dt, dB_adolescentis_dt, dB_fragilis_dt, dB_longum_dt, dB_obeum_dt, dB_thetaiotaomicron_dt, dB_uniformis_dt, dB_vulgatus_dt, dB_wadsworthia_dt, dC_aerofaciens_dt, dC_bolteae_dt, dC_comes_dt, dC_perfringens_dt, dC_ramosum_dt, dC_saccharolyticum_dt, dD_formicigenerans_dt, dE_coli_dt, dE_lenta_dt, dE_rectale_dt, dF_nucleatum_dt, dL_paracasei_dt, dO_splanchnicus_dt, dP_copri_dt, dP_distasonis_dt, dP_merdae_dt, dR_bromii_dt, dR_gnavus_dt, dR_intestinalis_dt, dR_torques_dt, dS_parasanguinis_dt, dS_salivarius_dt, dV_parvula_dt, dDrug_dt)
  
  ## Return result as a list
  list(dxdt)
}




#calculate the co-culture correction factor per species based on community composition in absence of drug, just like done for Niclosamide

growth_data_all_0_Niclosamide
growth_data_all_0_Niclosamide1 <- growth_data_all_0_Niclosamide %>%
  dplyr::mutate(Species = gsub(" ", "_", Species))


# Merge rel_ab_control with growth_data_all_0_Niclosamide on Species
# Function to remove duplicated columns by name pattern
clean_columns_base <- function(df, pattern) {
  cols_to_keep <- !grepl(pattern, names(df))
  df <- df[, cols_to_keep]
  return(df)
}

# Use the new function to clean up your dataframe
rel_ab_control <- clean_columns_base(rel_ab_control, "mean_max_OD.[xy]")
str(rel_ab_control)


#rel_ab_control$correction_factor <- rel_ab_control$mean_rel_ab / (rel_ab_control$mean_max_OD/sum(rel_ab_control$mean_max_OD))
# Calculate correction factor with a minimum value of ~1
rel_ab_control$correction_factor <- pmax(rel_ab_control$mean_rel_ab / (rel_ab_control$mean_max_OD / sum(rel_ab_control$mean_max_OD)), 1.1)


# Create a new dataframe for co-culture correction
co_culture_correction <- data.frame(
  species = rel_ab_control$Species,
  correction_factor = rel_ab_control$correction_factor
)


#summarise community data
#Adjust based on tested concentrations for each drug
unique(Community_compositions_focus_drugs_Ebselen$concentration)

Community_compositions_focus_drugs_Ebselen_5uM <- subset(Community_compositions_focus_drugs_Ebselen, concentration == 5)
Community_compositions_focus_drugs_Ebselen_20uM <- subset(Community_compositions_focus_drugs_Ebselen, concentration == 20)
Community_compositions_focus_drugs_Ebselen_1.25uM <- subset(Community_compositions_focus_drugs_Ebselen, concentration == 1.25)


#5 uM
Community_compositions_focus_drugs_Ebselen_5uM_summarised <- Community_compositions_focus_drugs_Ebselen_5uM %>%
  dplyr::group_by(species) %>%                                  
  dplyr::summarize(
    mean_rel_ab = mean(rel_abundance, na.rm = TRUE),     
    sd_rel_ab = sd(rel_abundance, na.rm = TRUE) ,
    mean_max_OD = mean(maxOD, na.rm = TRUE),
    sd_max_OD = sd(maxOD, na.rm = TRUE),
    mean_final_OD = mean(finalOD, na.rm = TRUE),
    sd_final_OD = sd(finalOD, na.rm = TRUE)
  ) %>%
  dplyr::ungroup() 


Community_compositions_focus_drugs_Ebselen_5uM_summarised <- Community_compositions_focus_drugs_Ebselen_5uM_summarised %>%
  dplyr::mutate(Species = sub("^(\\w)\\w*\\s(.*)", "\\1._\\2", species))

#remove (sub)strain info
Community_compositions_focus_drugs_Ebselen_5uM_summarised <- Community_compositions_focus_drugs_Ebselen_5uM_summarised %>%
  dplyr::mutate(Species = sub("^(\\w\\._\\w+).*", "\\1", Species))


#20 uM
Community_compositions_focus_drugs_Ebselen_20uM_summarised <- Community_compositions_focus_drugs_Ebselen_20uM %>%
  dplyr::group_by(species) %>%                                  
  dplyr::summarize(
    mean_rel_ab = mean(rel_abundance, na.rm = TRUE),     
    sd_rel_ab = sd(rel_abundance, na.rm = TRUE) ,
    mean_max_OD = mean(maxOD, na.rm = TRUE),
    sd_max_OD = sd(maxOD, na.rm = TRUE),
    mean_final_OD = mean(finalOD, na.rm = TRUE),
    sd_final_OD = sd(finalOD, na.rm = TRUE)
  ) %>%
  dplyr::ungroup() 


Community_compositions_focus_drugs_Ebselen_20uM_summarised <- Community_compositions_focus_drugs_Ebselen_20uM_summarised %>%
  dplyr::mutate(Species = sub("^(\\w)\\w*\\s(.*)", "\\1._\\2", species))

#remove (sub)strain info
Community_compositions_focus_drugs_Ebselen_20uM_summarised <- Community_compositions_focus_drugs_Ebselen_20uM_summarised %>%
  dplyr::mutate(Species = sub("^(\\w\\._\\w+).*", "\\1", Species))


#1.25 uM
Community_compositions_focus_drugs_Ebselen_1.25uM_summarised <- Community_compositions_focus_drugs_Ebselen_1.25uM %>%
  dplyr::group_by(species) %>%                                  
  dplyr::summarize(
    mean_rel_ab = mean(rel_abundance, na.rm = TRUE),     
    sd_rel_ab = sd(rel_abundance, na.rm = TRUE) ,
    mean_max_OD = mean(maxOD, na.rm = TRUE),
    sd_max_OD = sd(maxOD, na.rm = TRUE),    
    mean_final_OD = mean(finalOD, na.rm = TRUE),
    sd_final_OD = sd(finalOD, na.rm = TRUE)
  ) %>%
  dplyr::ungroup() 



Community_compositions_focus_drugs_Ebselen_1.25uM_summarised <- Community_compositions_focus_drugs_Ebselen_1.25uM_summarised %>%
  dplyr::mutate(Species = sub("^(\\w)\\w*\\s(.*)", "\\1._\\2", species))

#remove (sub)strain info
Community_compositions_focus_drugs_Ebselen_1.25uM_summarised <- Community_compositions_focus_drugs_Ebselen_1.25uM_summarised %>%
  dplyr::mutate(Species = sub("^(\\w\\._\\w+).*", "\\1", Species))


#Initialise data frames
sim_output <- data.frame()
input_params_list <- list() #Use a list to collect parameters for each simulation

#number of simulations
num_sims <- 250


for (i in 1:num_sims) {
  tryCatch({
    # generate model parameters
    set.seed(i) #set a different seed for each simulation for variation
    params <- lapply(1:nrow(growth_data_all_0_Niclosamide), function(idx) {
      species_params <- growth_data_all_0_Niclosamide[idx, ]
      list(
        r = rnorm(1, mean = species_params$mean_max_Growth_rate, sd = species_params$sd_max_Growth_rate),
        K = rnorm(1, mean = species_params$mean_max_OD, sd = species_params$sd_max_OD)
      )
    })
    names(params) <- gsub(" ", "_", growth_data_all_0_Niclosamide$Species)
    flat_params <- unlist(params)
    names(flat_params) <- gsub("\\.\\d$", "", names(flat_params))
    
    #replace spaces with underscores to match formatting
    co_culture_correction$species <- gsub(" ", "_", co_culture_correction$species, fixed = TRUE)
    
    #replace the species-specific K parameters extracted from monoculture growth data 
    #with drawn relative abundance values at Niclosamide = 0, scaled to K
    rel_ab_control$Species <- gsub(" ", "_", rel_ab_control$Species)
    
    #Initialise an empty vector to store drawn values
    drawn_values <- numeric(nrow(rel_ab_control))
    
    #draw values from their respective distributions
    for (k in 1:nrow(rel_ab_control)) {
      species_name <- rel_ab_control$Species[k]
      drawn_value <- rnorm(1, mean = rel_ab_control$mean_rel_ab[k], sd = rel_ab_control$sd_rel_ab[k])
      drawn_values[k] <- max(drawn_value, 0)  # Ensure no negative values
    }
    
    #Normalise drawn relative abundance values so they sum to 1 (to reflect a 'true' relative abundance distribution)
    #this is needed so when we convert the values into OD units by multiplying with the drawn community maxOD,
    # the sum of K_i parameters and the drawn K are equal
    normalised_values <- drawn_values / sum(drawn_values)
    
    #Pull community maxOD (K) at 0 drugs from respective normal distribution:
    K <- rnorm(n = 1, mean = rel_ab_control$mean_com_max_OD[1], sd = rel_ab_control$sd_com_max_OD[1])
    
    # Assign these normalised values to their respective species' .K parameters
    for (k in 1:nrow(rel_ab_control)) {
      species_name <- rel_ab_control$Species[k]
      k_index <- grep(paste0("^", species_name, "\\.K$"), names(flat_params))
      
      if (length(k_index) > 0) {
        old_value <- flat_params[k_index]
        flat_params[k_index] <- (normalised_values[k] + 0.0001) * K #add small value in case drawn K_i is 0, which would cause issues with the solver
        cat(sprintf("Updated %s from %f to %f using normalised value %f scaled by K %f\n", names(flat_params)[k_index], old_value, flat_params[k_index], normalised_values[k], K))
      }
    }
    
    #Accounting for variation in drug degradation by community, with standard deviation of end concentration (at 10h) around the fitted predicted (relative) end concentration at 24h
    #prop_left_Ebselen <- abs(rnorm(1, (subset(drug_dynamics, Drug == "Ebselen")$Prop_left_24h_community), (subset(drug_dynamics, Drug == "Ebselen")$SD_drug_community))) 
    #below, we account for measurement error rather than ecological drivers that lead to the variability of degradation at the final point measured 
    prop_left_Ebselen <- abs(rnorm(
      n = 1, 
      mean = subset(drug_dynamics, Drug == "Ebselen")$Prop_left_24h_community, 
      sd = ifelse(
        subset(drug_dynamics, Drug == "Ebselen")$SD_drug_community > subset(drug_dynamics, Drug == "Ebselen")$SD_drug_community_start, 
        subset(drug_dynamics, Drug == "Ebselen")$SD_drug_community - subset(drug_dynamics, Drug == "Ebselen")$SD_drug_community_start, 
        subset(drug_dynamics, Drug == "Ebselen")$SD_drug_community
      )
    ))
    
    
    #loop through each species in co_culture_correction
    for (j in 1:nrow(co_culture_correction)) {
      # Extract the species name and correction factor
      species_name <- co_culture_correction$species[j]
      correction_factor <- co_culture_correction$correction_factor[j]
      
      # Identify the corresponding growth rate parameter in flat_params
      #by matching the base species name (without .r)
      growth_rate_indices <- grep(paste0("^", species_name, "\\.r$"), names(flat_params))
      
      #take the growth rate parameter and apply the correction factor 
      for (index in growth_rate_indices) {
        flat_params[index] <- flat_params[index] * correction_factor
      }
    }
    
    flat_params
    # Store parameters for each simulation
    input_params_list[[i]] <- c(sim_ID = i, flat_params)
    
    # Run the model for the first 24-hour cycle
    solution_cycle_1 <- ode(y = initial_conditions, times = seq(from = 0, to = 24, by = 0.1), func = closed.sir.model_Ebselen, parms = flat_params,   method = "lsoda", rtol = 1e-6, atol = 1e-6)
    
    # Dilution and second cycle
    end_of_cycle_1 <- solution_cycle_1[nrow(solution_cycle_1), -1]
    initial_conditions_cycle_2 <- end_of_cycle_1 / 50
    #accounting for the drugs being added with the new growth cycle as well:
    initial_conditions_cycle_2[33] <- initial_conditions_cycle_2[33] + drug_concentration_tested
    solution_cycle_2 <- ode(y = initial_conditions_cycle_2, times = seq(from = 24, to = 48, by = 0.1), func = closed.sir.model_Ebselen, parms = flat_params,  method = "lsoda", rtol = 1e-6, atol = 1e-6)
    
    # Combine and format results
    combined_solution <- rbind(as.data.frame(solution_cycle_1), as.data.frame(solution_cycle_2)[-1,])
    combined_solution$sim_ID <- rep(i, nrow(combined_solution))
    combined_solution <- combined_solution %>%
      tidyr::gather(key = "Species", value = "Density", -time, -sim_ID) %>%
      dplyr::mutate(Hour = time) %>%
      dplyr::select(sim_ID, Hour, Species, Density)
    
    ##Append to sim_output
    sim_output <- rbind(sim_output, combined_solution)
  }, error = function(e) {
    cat(sprintf("Skipping simulation %d due to an error: %s\n", i, e$message))
  })
}



##Combine all parameter data into a single dataframe
input_params <- do.call(rbind, input_params_list)

# Add a "Species" column 
sim_output$Species_name <- species_names[as.numeric(as.character(sim_output$Species))]
sim_output$Species_name <- replace_na(sim_output$Species_name, "Drug")

#View(input_params)
#View(sim_output)

sim_output <- na.omit(sim_output)
successful_sim_ids <- unique(subset(sim_output, Hour == 48)$sim_ID)
length(successful_sim_ids)
sim_output1 <- sim_output[sim_output$sim_ID %in% successful_sim_ids, ]


#Transform sim_output so we have wide format by Species
sim_output_wide <- tidyr::pivot_wider(sim_output1, 
                                      names_from = Species_name, 
                                      values_from = Density,
                                      id_cols = c(sim_ID, Hour))

length(unique(sim_output_wide$sim_ID))
#calc community OD per timepoint
sim_output_wide$Total_OD <- rowSums(sim_output_wide[, 3:34], na.rm = TRUE)
#calculate and add relative abundances here as well:
species_columns <- colnames(sim_output_wide)[3:34] 

for (species in species_columns) {
  sim_output_wide[[paste0("rel_", species)]] <- sim_output_wide[[species]] / sim_output_wide$Total_OD
}


#assign sim_output_wide test conditions to dataframe name
drug_tested <- "Ebselen"
variable_name_1 <- paste0("sim_output_wide_", ifelse(drug_concentration_tested == 1e-04, 0, drug_concentration_tested), "_", drug_tested)
assign(variable_name_1, sim_output_wide)

#turn back into long format if interested in plotting relative abundances
cols_needed <- c("sim_ID", "Hour")

sim_output_long <- sim_output_wide %>% 
  dplyr::select(sim_ID, Hour, Drug, starts_with("rel_")) %>% 
  tidyr::pivot_longer(
    cols = c(Drug, starts_with("rel_")),
    names_to = "Species", 
    values_to = "Relative_abundance",
    names_prefix = "rel_",
    names_transform = list(Species = ~ ifelse(.x == "Drug", "Drug", .x))
  ) 

str(sim_output_long)


species_names_1 <- c(
  "A_muciniphila",
  "B_adolescentis",
  "B_fragilis",
  "B_longum",
  "B_obeum",
  "B_thetaiotaomicron",
  "B_uniformis",
  "B_vulgatus",
  "B_wadsworthia",
  "C_aerofaciens",
  "C_bolteae",
  "C_comes",
  "C_perfringens",
  "C_ramosum",
  "C_saccharolyticum",
  "D_formicigenerans",
  "E_coli",
  "E_lenta",
  "E_rectale",
  "F_nucleatum",
  "L_paracasei",
  "O_splanchnicus",
  "P_copri",
  "P_distasonis",
  "P_merdae",
  "R_bromii",
  "R_gnavus",
  "R_intestinalis",
  "R_torques",
  "S_parasanguinis",
  "S_salivarius",
  "V_parvula",
  "Drug"
)

species_colours_1 <- c(
  "A_muciniphila" = "#1f77b4",
  "B_adolescentis" = "#ff7f0e",
  "B_fragilis" = "#2ca02c",
  "B_longum" = "#d62728",
  "B_obeum" = "#9467bd",
  "B_thetaiotaomicron" = "black",
  "B_uniformis" = "#e377c2",
  "B_vulgatus" = "#7f7f7f",
  "B_wadsworthia" = "gold1",
  "C_aerofaciens" = "#aec7e8",
  "C_bolteae" = "#ffbb78",
  "C_comes" = "magenta",
  "C_perfringens" = "#ff9896",
  "C_ramosum" = "#c5b0d5",
  "C_saccharolyticum" = "#c49c94",
  "D_formicigenerans" = "#f7b6d2",
  "E_coli" = "yellow",
  "E_lenta" = "turquoise",
  "E_rectale" = "#393b79",
  "F_nucleatum" = "royalblue2",
  "L_paracasei" = "blue",
  "O_splanchnicus" = "#637939",
  "P_copri" = "cyan",
  "P_distasonis" = "#8c6d31",
  "P_merdae" = "#c7c7c7",
  "R_bromii" = "#e6550d",
  "R_gnavus" = "#e7cb94",
  "R_intestinalis" = "#843c39",
  "R_torques" = "#d6616b",
  "S_parasanguinis" = "orange3",
  "S_salivarius" = "#7b4173",
  "V_parvula" = "#ce6dbd",
  "Drug" = "green"
)



##Plot output for any specific sim:
# ggplot(subset(sim_output, sim_ID == 1 & Species_name != "Drug"), aes(x = Hour, y = Density, group = Species_name, color = Species_name)) +
#   geom_line(size = 1, alpha = 0.7) +
#   scale_color_manual(values = species_colours_1) +
#   labs(title = paste0("Ebselen = ", drug_concentration_tested),
#        x = "Time (hours)",
#        y = "Population Density (OD)",
#        color = "Species") +
#   theme_minimal() +
#   theme(legend.position = "right")
# 
# ggplot(subset(sim_output, sim_ID == 3 & Species_name != "Drug"), aes(x = Hour, y = Density, group = Species_name, color = Species_name)) +
#   geom_line(size = 1, alpha = 0.7) +
#   scale_color_manual(values = species_colours_1) +
#   labs(title = paste0("Ebselen = ", drug_concentration_tested),
#        x = "Time (hours)",
#        y = "Population Density (OD)",
#        color = "Species") +
#   theme_minimal() +
#   theme(legend.position = "right")


ggplot(subset(sim_output_long, sim_ID == 1), aes(x = Hour, y = Relative_abundance, group = Species, color = Species)) +
  geom_line(size = 1, alpha = 0.7) +
  scale_color_manual(values = species_colours_1) +
  labs(title = paste0("Ebselen = ", drug_concentration_tested),
       x = "Time (hours)",
       y = "Relative abundance",
       color = "Species") +
  theme_minimal() +
  theme(legend.position = "right")


ggplot(subset(sim_output_long, sim_ID == 3), aes(x = Hour, y = Relative_abundance, group = Species, color = Species)) +
  geom_line(size = 1, alpha = 0.7) +
  scale_color_manual(values = species_colours_1) +
  labs(title = paste0("Ebselen = ", drug_concentration_tested),
       x = "Time (hours)",
       y = "Relative abundance",
       color = "Species") +
  theme_minimal() +
  theme(legend.position = "right")


#calc mean and standard deviation across sims
sim_stats <- sim_output_long %>%
  dplyr::group_by(Hour, Species) %>%
  dplyr::summarise(
    mean_rel_ab = mean(Relative_abundance),
    sd_rel_ab = sd(Relative_abundance),
    .groups = 'drop'
  )

# Prepare the data for plotting
plot_data <- sim_stats %>%
  dplyr::mutate(Upper = mean_rel_ab + sd_rel_ab, Lower = mean_rel_ab - sd_rel_ab)

ggplot(subset(plot_data, Species != "Drug"), aes(x = Hour, y = mean_rel_ab, group = Species, color = Species)) +
  geom_ribbon(aes(ymin = Lower, ymax = Upper, fill = Species), colour = NA, alpha = 0.2) +  
  geom_line(size = 1, alpha = 0.7) + 
  scale_color_manual(values = species_colours_1) +
  scale_fill_manual(values = species_colours_1) +  
  labs(title = "Mean and SD of Relative Abundance Across Simulations",
       subtitle = paste0("Ebselen = ", drug_concentration_tested),       
       x = "Time (hours)",
       y = "Relative abundance",
       color = "Species",
       fill = "Species") +
  theme_minimal() +
  theme(legend.position = "right")

#log-scaled mean trends
ggplot(plot_data, aes(x = Hour, y = log10(mean_rel_ab + 0.0001), group = Species, color = Species)) +
  geom_line(size = 1, alpha = 0.7) +  # Mean line
  scale_color_manual(values = species_colours_1) +
  scale_fill_manual(values = species_colours_1) +  # Ensure consistent colors for lines and fills
  labs(title = "Mean and SD of Relative Abundance Across Simulations",
       subtitle = paste0("Ebselen = ", drug_concentration_tested),
       x = "Time (hours)",
       y = "Relative abundance",
       color = "Species",
       fill = "Species") +
  theme_minimal() +
  theme(legend.position = "right")




##prediction quality evaluation
drug_tested <- "Ebselen"
variable_name <- paste0("plot_data_", ifelse(drug_concentration_tested == 1e-04, 0, drug_concentration_tested), "_", drug_tested)
assign(variable_name, plot_data)


#extract total OD info:
predicted_mean_final_od_NULL <- Niclosamide_16S_0uM_summarised$mean_com_final_OD[1]
predicted_sd_final_od_NULL <- Niclosamide_16S_0uM_summarised$sd_com_final_OD[1]

predicted_mean_final_od_5_Ebselen <- mean(subset(sim_output_wide_5_Ebselen, Hour == 48)$Total_OD, na.rm = TRUE)
predicted_sd_final_od_5_Ebselen <- sd(subset(sim_output_wide_5_Ebselen, Hour == 48)$Total_OD, na.rm = TRUE)

real_mean_final_od_5_Ebselen <- Community_compositions_focus_drugs_Ebselen_5uM_summarised$mean_final_OD[1]
real_sd_final_od_5_Ebselen <- Community_compositions_focus_drugs_Ebselen_5uM_summarised$sd_final_OD[1]


predicted_mean_final_od_20_Ebselen <- mean(subset(sim_output_wide_20_Ebselen, Hour == 48)$Total_OD, na.rm = TRUE)
predicted_sd_final_od_20_Ebselen <- sd(subset(sim_output_wide_20_Ebselen, Hour == 48)$Total_OD, na.rm = TRUE)

real_mean_final_od_20_Ebselen <- Community_compositions_focus_drugs_Ebselen_20uM_summarised$mean_final_OD[1]
real_sd_final_od_20_Ebselen <- Community_compositions_focus_drugs_Ebselen_20uM_summarised$sd_final_OD[1]


predicted_mean_final_od_1.25_Ebselen <- mean(subset(sim_output_wide_1.25_Ebselen, Hour == 48)$Total_OD, na.rm = TRUE)
predicted_sd_final_od_1.25_Ebselen <- sd(subset(sim_output_wide_1.25_Ebselen, Hour == 48)$Total_OD, na.rm = TRUE)

real_mean_final_od_1.25_Ebselen <- Community_compositions_focus_drugs_Ebselen_1.25uM_summarised$mean_final_OD[1]
real_sd_final_od_1.25_Ebselen <- Community_compositions_focus_drugs_Ebselen_1.25uM_summarised$sd_final_OD[1]




#plot_data_0_Ebselen_endpoint was used to test model performance at 0 drugs
#plot_data_0_Ebselen_endpoint <- subset(plot_data_0_Ebselen, Hour == 48 & Species != "Drug")
plot_data_5_Ebselen_endpoint <- subset(plot_data_5_Ebselen, Hour == 48 & Species != "Drug")
plot_data_20_Ebselen_endpoint <- subset(plot_data_20_Ebselen, Hour == 48 & Species != "Drug")
plot_data_1.25_Ebselen_endpoint <- subset(plot_data_1.25_Ebselen, Hour == 48 & Species != "Drug")

##Inspecting 'match' to real relative abundance distributions:
Niclosamide_16S_0uM_summarised <- rel_ab_control
Niclosamide_16S_0uM_summarised$Species <- gsub("\\.", "", Niclosamide_16S_0uM_summarised$Species)

Ebselen_16S_5uM_summarised <- Community_compositions_focus_drugs_Ebselen_5uM_summarised
Ebselen_16S_20uM_summarised <- Community_compositions_focus_drugs_Ebselen_20uM_summarised
Ebselen_16S_1.25uM_summarised <- Community_compositions_focus_drugs_Ebselen_1.25uM_summarised

Niclosamide_16S_0uM_summarised
Ebselen_16S_5uM_summarised 
Ebselen_16S_20uM_summarised 
Ebselen_16S_1.25uM_summarised 

#Rename 'species' so the outputs become comparable
original_names_1.25 <- unique(Ebselen_16S_1.25uM_summarised$species)
original_names_20 <- unique(Ebselen_16S_20uM_summarised$species)
original_names_5 <- unique(Ebselen_16S_5uM_summarised$species)


##Create a named vector with the original and new names mapping
name_changes <- c(
  "Akkermansia muciniphila" = "A_muciniphila",
  "Bacteroides fragilis" = "B_fragilis",
  "Bacteroides thetaiotaomicron" = "B_thetaiotaomicron",
  "Bacteroides uniformis" = "B_uniformis",
  "Bifidobacterium adolescentis" = "B_adolescentis",
  "Bifidobacterium longum subsp. longum" = "B_longum",
  "Bilophila wadsworthia" = "B_wadsworthia",
  "Blautia obeum" = "B_obeum",
  "Clostridium perfringens" = "C_perfringens",
  "Collinsella aerofaciens" = "C_aerofaciens",
  "Coprococcus comes" = "C_comes",
  "Dorea formicigenerans" = "D_formicigenerans",
  "Eggerthella lenta" = "E_lenta",
  "Enterocloster bolteae" = "C_bolteae",
  "Erysipelatoclostridium ramosum" = "C_ramosum",
  "Escherichia coli ED1a" = "E_coli",
  "Eubacterium rectale" = "E_rectale",
  "Fusobacterium nucleatum subsp. nucleatum" = "F_nucleatum",
  "Lacrimispora saccharolytica" = "C_saccharolyticum",
  "Lacticaseibacillus paracasei" = "L_paracasei",
  "Odoribacter splanchnicus" = "O_splanchnicus",
  "Parabacteroides distasonis" = "P_distasonis",
  "Parabacteroides merdae" = "P_merdae",
  "Phocaeicola vulgatus" = "B_vulgatus",
  "Prevotella copri" = "P_copri",
  "Roseburia intestinalis" = "R_intestinalis",
  "Ruminococcus bromii" = "R_bromii",
  "Ruminococcus gnavus" = "R_gnavus",
  "Ruminococcus torques" = "R_torques",
  "Streptococcus parasanguinis" = "S_parasanguinis",
  "Streptococcus salivarius" = "S_salivarius",
  "Veillonella parvula" = "V_parvula"
)

# Apply name changes to the species column in Ebselen_16S_1.25uM_summarised

Ebselen_16S_1.25uM_summarised$Species <- name_changes[Ebselen_16S_1.25uM_summarised$species]
Ebselen_16S_20uM_summarised$Species <- name_changes[Ebselen_16S_20uM_summarised$species]
Ebselen_16S_5uM_summarised$Species <- name_changes[Ebselen_16S_5uM_summarised$species]

# Verify the changes
unique(Ebselen_16S_1.25uM_summarised$Species)
unique(Ebselen_16S_20uM_summarised$Species)
unique(Ebselen_16S_5uM_summarised$Species)



##First, for 5 uM:
# Get top 6 species from plot_data_5_endpoint
# Adjust the plot_data_5_endpoint with confidence bounds

# #plot_data_0_Ebselen_endpoint was used to test model performance at 0 drugs
# plot_data_0_Ebselen_endpoint <- plot_data_0_Ebselen_endpoint %>%
#   dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)

plot_data_5_Ebselen_endpoint <- plot_data_5_Ebselen_endpoint %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)

# Adjust the Ebselen_16S_5uM_summarised with confidence bounds
Ebselen_16S_5uM_summarised <- Ebselen_16S_5uM_summarised %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)

#NULL model:
Null_model_summarised <- Niclosamide_16S_0uM_summarised %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)


# Get top 6 species based on the lower bound from plot_data_5_endpoint

#top6_predicted_0_Ebselen was used to test model performance at 0 drugs
# top6_predicted_0_Ebselen <- plot_data_0_Ebselen_endpoint %>%
#    arrange(desc(lower_bound)) %>%
#    slice(1:6) %>%
#    pull(Species)

top6_predicted_5_Ebselen <- plot_data_5_Ebselen_endpoint %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

# Get top 6 species based on the lower bound from Ebselen_16S_5uM_summarised
top6_real_5_Ebselen <- Ebselen_16S_5uM_summarised %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

top6_NULL <- Null_model_summarised %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

# Calculate the overlap of top 6 species

#top_six_correct_0_Ebselen was used to assess model performance at 0 drugs
# top_six_correct_0_Ebselen <- length(intersect(top6_predicted_0_Ebselen, top6_NULL))
# top_six_correct_0_Ebselen

top_six_correct_5_Ebselen <- length(intersect(top6_predicted_5_Ebselen, top6_real_5_Ebselen))
top_six_correct_5_Ebselen

top_six_correct_5_Ebselen_NULL <- length(intersect(top6_NULL, top6_real_5_Ebselen))
top_six_correct_5_Ebselen_NULL

top6_predicted_5_Ebselen
top6_real_5_Ebselen

#top6_NULL

#Now by means:
# #top6_predicted_0_Ebselen_means was used to assess model performance at 0 drugs
# top6_predicted_0_Ebselen_means <- plot_data_0_Ebselen_endpoint %>%
#    arrange(desc(mean_rel_ab)) %>%
#    slice(1:6) %>%
#    pull(Species)

top6_predicted_5_Ebselen_means <- plot_data_5_Ebselen_endpoint %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)

# Get top 6 species based on the lower bound from Ebselen_16S_5uM_summarised
top6_real_5_Ebselen_means <- Ebselen_16S_5uM_summarised %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)

top6_NULL_means <- Null_model_summarised %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)


# #top_six_correct_0_Ebselen_means was used to assess model performance at 0 drugs
# top_six_correct_0_Ebselen_means <- length(intersect(top6_predicted_0_Ebselen_means, top6_NULL_means))
# top_six_correct_0_Ebselen_means

top_six_correct_5_Ebselen_means <- length(intersect(top6_predicted_5_Ebselen_means, top6_real_5_Ebselen_means))
top_six_correct_5_Ebselen_means

top_six_correct_5_Ebselen_means_NULL <- length(intersect(top6_NULL_means, top6_real_5_Ebselen_means))
top_six_correct_5_Ebselen_means_NULL

top6_predicted_5_Ebselen_means
top6_real_5_Ebselen_means

#top6_NULL_means


# Merge dataframes by Species

#merged_data_0_Ebselen was used to assess model performance at 0 drugs
#merged_data_0_Ebselen <- merge(plot_data_0_Ebselen_endpoint, Niclosamide_16S_0uM_summarised, by = "Species", suffixes = c(".pred", ".real"))
merged_data_5_Ebselen <- merge(plot_data_5_Ebselen_endpoint, Ebselen_16S_5uM_summarised, by = "Species", suffixes = c(".pred", ".real"))
merged_data_5_Ebselen_NULL <- merge(Niclosamide_16S_0uM_summarised, Ebselen_16S_5uM_summarised, by = "Species", suffixes = c(".null", ".real"))


## Below lines used for assessing model performance at 0 drugs; ignore for nonzero concentrations
# # Create lower and upper bounds considering mean ¬± sd
# merged_data_0_Ebselen$lower_bound_pred <- merged_data_0_Ebselen$mean_rel_ab.pred - merged_data_0_Ebselen$sd_rel_ab.pred
# merged_data_0_Ebselen$upper_bound_pred <- merged_data_0_Ebselen$mean_rel_ab.pred + merged_data_0_Ebselen$sd_rel_ab.pred
# merged_data_0_Ebselen$lower_bound_real <- merged_data_0_Ebselen$mean_rel_ab.real - merged_data_0_Ebselen$sd_rel_ab.real
# merged_data_0_Ebselen$upper_bound_real <- merged_data_0_Ebselen$mean_rel_ab.real + merged_data_0_Ebselen$sd_rel_ab.real
# 
# # Ensure lower and upper bounds are non-negative, adjusting as necessary
# merged_data_0_Ebselen$lower_bound_pred[merged_data_0_Ebselen$lower_bound_pred <= 0] <- 1e-10
# merged_data_0_Ebselen$lower_bound_real[merged_data_0_Ebselen$lower_bound_real <= 0] <- 1e-10
# merged_data_0_Ebselen$upper_bound_pred[merged_data_0_Ebselen$upper_bound_pred <= 0] <- 1e-10
# merged_data_0_Ebselen$upper_bound_real[merged_data_0_Ebselen$upper_bound_real <= 0] <- 1e-10


# Create lower and upper bounds considering mean ¬± sd
merged_data_5_Ebselen$lower_bound_pred <- merged_data_5_Ebselen$mean_rel_ab.pred - merged_data_5_Ebselen$sd_rel_ab.pred
merged_data_5_Ebselen$upper_bound_pred <- merged_data_5_Ebselen$mean_rel_ab.pred + merged_data_5_Ebselen$sd_rel_ab.pred
merged_data_5_Ebselen$lower_bound_real <- merged_data_5_Ebselen$mean_rel_ab.real - merged_data_5_Ebselen$sd_rel_ab.real
merged_data_5_Ebselen$upper_bound_real <- merged_data_5_Ebselen$mean_rel_ab.real + merged_data_5_Ebselen$sd_rel_ab.real

# Ensure lower and upper bounds are non-negative, adjusting as necessary
merged_data_5_Ebselen$lower_bound_pred[merged_data_5_Ebselen$lower_bound_pred <= 0] <- 1e-10
merged_data_5_Ebselen$lower_bound_real[merged_data_5_Ebselen$lower_bound_real <= 0] <- 1e-10
merged_data_5_Ebselen$upper_bound_pred[merged_data_5_Ebselen$upper_bound_pred <= 0] <- 1e-10
merged_data_5_Ebselen$upper_bound_real[merged_data_5_Ebselen$upper_bound_real <= 0] <- 1e-10

##and for NULL model:
# Create lower and upper bounds considering mean ¬± sd
merged_data_5_Ebselen_NULL$lower_bound_null <- merged_data_5_Ebselen_NULL$mean_rel_ab.null - merged_data_5_Ebselen_NULL$sd_rel_ab.null
merged_data_5_Ebselen_NULL$upper_bound_null <- merged_data_5_Ebselen_NULL$mean_rel_ab.null + merged_data_5_Ebselen_NULL$sd_rel_ab.null
merged_data_5_Ebselen_NULL$lower_bound_real <- merged_data_5_Ebselen_NULL$mean_rel_ab.real - merged_data_5_Ebselen_NULL$sd_rel_ab.real
merged_data_5_Ebselen_NULL$upper_bound_real <- merged_data_5_Ebselen_NULL$mean_rel_ab.real + merged_data_5_Ebselen_NULL$sd_rel_ab.real

# Ensure lower and upper bounds are non-negative, adjusting as necessary
merged_data_5_Ebselen_NULL$lower_bound_null[merged_data_5_Ebselen_NULL$lower_bound_null <= 0] <- 1e-10
merged_data_5_Ebselen_NULL$lower_bound_real[merged_data_5_Ebselen_NULL$lower_bound_real <= 0] <- 1e-10
merged_data_5_Ebselen_NULL$upper_bound_null[merged_data_5_Ebselen_NULL$upper_bound_null <= 0] <- 1e-10
merged_data_5_Ebselen_NULL$upper_bound_real[merged_data_5_Ebselen_NULL$upper_bound_real <= 0] <- 1e-10

# Filter to include only species with a mean relative abundance > 0.01 in the 'real' dataset

## significant_species_0 was used to assess model performance at 0 drugs
#significant_species_0 <- merged_data_0_Ebselen[merged_data_0_Ebselen$mean_rel_ab.real > 0.01, ]
significant_species <- merged_data_5_Ebselen[merged_data_5_Ebselen$mean_rel_ab.real > 0.01, ]
survivors_5_Ebselen <- nrow(significant_species)
survivors_5_Ebselen

#should be the same as survivors defined above, since it is calculated from .real
significant_species_NULL <- merged_data_5_Ebselen_NULL[merged_data_5_Ebselen_NULL$mean_rel_ab.real > 0.01, ]
survivors_5_Ebselen_NULL <- nrow(significant_species_NULL)
survivors_5_Ebselen_NULL

# Adjusted order of magnitude check to include SD, only for significant species
## below code was used to assess model performance at 0 drugs
# significant_species_0$Predicted_magnitude_correct <- ifelse(
#   (floor(log10(significant_species_0$lower_bound_pred)) <= floor(log10(significant_species_0$upper_bound_real)) &
#      floor(log10(significant_species_0$upper_bound_pred)) >= floor(log10(significant_species_0$lower_bound_real))),
#   1,
#   0
# )

significant_species$Predicted_magnitude_correct <- ifelse(
  (floor(log10(significant_species$lower_bound_pred)) <= floor(log10(significant_species$upper_bound_real)) &
     floor(log10(significant_species$upper_bound_pred)) >= floor(log10(significant_species$lower_bound_real))),
  1,
  0
)

#and for the Null model:
significant_species_NULL$Predicted_magnitude_correct <- ifelse(
  (floor(log10(significant_species_NULL$lower_bound_null)) <= floor(log10(significant_species_NULL$upper_bound_real)) &
     floor(log10(significant_species_NULL$upper_bound_null)) >= floor(log10(significant_species_NULL$lower_bound_real))),
  1,
  0
)

# Calculate the fraction of correctly predicted magnitudes for significant species
## below code was used to assess model performance at 0 drugs
#predicted_magnitude_correct_fraction_0_Ebselen <- sum(significant_species_0$Predicted_magnitude_correct) / nrow(significant_species_0)
#predicted_magnitude_correct_fraction_0_Ebselen

predicted_magnitude_correct_fraction_5_Ebselen <- sum(significant_species$Predicted_magnitude_correct) / nrow(significant_species)
predicted_magnitude_correct_fraction_5_Ebselen

predicted_magnitude_correct_fraction_5_Ebselen_NULL <- sum(significant_species_NULL$Predicted_magnitude_correct) / nrow(significant_species_NULL)
predicted_magnitude_correct_fraction_5_Ebselen_NULL

top_species_missing_5_Ebselen <- setdiff(top6_real_5_Ebselen_means, top6_predicted_5_Ebselen_means)
top_species_wrong_5_Ebselen <- setdiff(top6_predicted_5_Ebselen_means, top6_real_5_Ebselen_means)

top_species_missing_5_Ebselen <- if(length(top_species_missing_5_Ebselen) == 0) "None" else top_species_missing_5_Ebselen
top_species_wrong_5_Ebselen <- if(length(top_species_wrong_5_Ebselen) == 0) "None" else top_species_wrong_5_Ebselen

Prediction_quality_5_Ebselen <- data.frame(
  Top_six_correct = paste(top_six_correct_5_Ebselen, sep=""),
  Top_six_correct_NULL = paste(top_six_correct_5_Ebselen_NULL, sep=""),
  Top_six_correct_means = paste(top_six_correct_5_Ebselen_means, sep=""),
  Top_six_correct_means_NULL = paste(top_six_correct_5_Ebselen_means_NULL, sep=""),
  Predicted_magnitude_correct = paste(round(predicted_magnitude_correct_fraction_5_Ebselen * 100, 2), "%", sep=""),
  Predicted_magnitude_correct_NULL = paste(round(predicted_magnitude_correct_fraction_5_Ebselen_NULL * 100, 2), "%", sep=""),
  survivors_total = survivors_5_Ebselen,
  top_species_missing <- top_species_missing_5_Ebselen,
  top_species_wrong <- top_species_wrong_5_Ebselen, 
  predicted_mean_final_OD <- predicted_mean_final_od_5_Ebselen,
  real_mean_final_OD <- real_mean_final_od_5_Ebselen,
  sims_total = length(successful_sim_ids)
)



Prediction_quality_5_Ebselen



##Next, for 20 uM:
# Get top 6 species from plot_data_20_endpoint
# Adjust the plot_data_20_endpoint with confidence bounds
plot_data_20_Ebselen_endpoint <- plot_data_20_Ebselen_endpoint %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)

# Adjust the Ebselen_16S_20uM_summarised with confidence bounds
Ebselen_16S_20uM_summarised <- Ebselen_16S_20uM_summarised %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)

#NULL model:
Null_model_summarised <- Niclosamide_16S_0uM_summarised %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)


# Get top 6 species based on the lower bound from plot_data_20_endpoint
top6_predicted_20_Ebselen <- plot_data_20_Ebselen_endpoint %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

# Get top 6 species based on the lower bound from Ebselen_16S_20uM_summarised
top6_real_20_Ebselen <- Ebselen_16S_20uM_summarised %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

top6_NULL <- Null_model_summarised %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

# Calculate the overlap of top 6 species
top_six_correct_20_Ebselen <- length(intersect(top6_predicted_20_Ebselen, top6_real_20_Ebselen))
#top_six_correct_20_Ebselen

top_six_correct_20_Ebselen_NULL <- length(intersect(top6_NULL, top6_real_20_Ebselen))
#top_six_correct_20_Ebselen_NULL

#top6_predicted_20_Ebselen
#top6_real_20_Ebselen



#Now by means:
top6_predicted_20_Ebselen_means <- plot_data_20_Ebselen_endpoint %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)

# Get top 6 species based on the lower bound from Ebselen_16S_20uM_summarised
top6_real_20_Ebselen_means <- Ebselen_16S_20uM_summarised %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)

top6_NULL_means <- Null_model_summarised %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)



top_six_correct_20_Ebselen_means <- length(intersect(top6_predicted_20_Ebselen_means, top6_real_20_Ebselen_means))
#top_six_correct_20_Ebselen_means

top_six_correct_20_Ebselen_means_NULL <- length(intersect(top6_NULL_means, top6_real_20_Ebselen_means))
#top_six_correct_20_Ebselen_means_NULL

top6_predicted_20_Ebselen_means
#top6_real_20_Ebselen_means




# Merge dataframes by Species
merged_data_20_Ebselen <- merge(plot_data_20_Ebselen_endpoint, Ebselen_16S_20uM_summarised, by = "Species", suffixes = c(".pred", ".real"))
merged_data_20_Ebselen_NULL <- merge(Niclosamide_16S_0uM_summarised, Ebselen_16S_20uM_summarised, by = "Species", suffixes = c(".null", ".real"))



# Create lower and upper bounds considering mean ¬± sd
merged_data_20_Ebselen$lower_bound_pred <- merged_data_20_Ebselen$mean_rel_ab.pred - merged_data_20_Ebselen$sd_rel_ab.pred
merged_data_20_Ebselen$upper_bound_pred <- merged_data_20_Ebselen$mean_rel_ab.pred + merged_data_20_Ebselen$sd_rel_ab.pred
merged_data_20_Ebselen$lower_bound_real <- merged_data_20_Ebselen$mean_rel_ab.real - merged_data_20_Ebselen$sd_rel_ab.real
merged_data_20_Ebselen$upper_bound_real <- merged_data_20_Ebselen$mean_rel_ab.real + merged_data_20_Ebselen$sd_rel_ab.real

# Ensure lower and upper bounds are non-negative, adjusting as necessary
merged_data_20_Ebselen$lower_bound_pred[merged_data_20_Ebselen$lower_bound_pred <= 0] <- 1e-10
merged_data_20_Ebselen$lower_bound_real[merged_data_20_Ebselen$lower_bound_real <= 0] <- 1e-10
merged_data_20_Ebselen$upper_bound_pred[merged_data_20_Ebselen$upper_bound_pred <= 0] <- 1e-10
merged_data_20_Ebselen$upper_bound_real[merged_data_20_Ebselen$upper_bound_real <= 0] <- 1e-10

##and for NULL model:
# Create lower and upper bounds considering mean ¬± sd
merged_data_20_Ebselen_NULL$lower_bound_null <- merged_data_20_Ebselen_NULL$mean_rel_ab.null - merged_data_20_Ebselen_NULL$sd_rel_ab.null
merged_data_20_Ebselen_NULL$upper_bound_null <- merged_data_20_Ebselen_NULL$mean_rel_ab.null + merged_data_20_Ebselen_NULL$sd_rel_ab.null
merged_data_20_Ebselen_NULL$lower_bound_real <- merged_data_20_Ebselen_NULL$mean_rel_ab.real - merged_data_20_Ebselen_NULL$sd_rel_ab.real
merged_data_20_Ebselen_NULL$upper_bound_real <- merged_data_20_Ebselen_NULL$mean_rel_ab.real + merged_data_20_Ebselen_NULL$sd_rel_ab.real

# Ensure lower and upper bounds are non-negative, adjusting as necessary
merged_data_20_Ebselen_NULL$lower_bound_null[merged_data_20_Ebselen_NULL$lower_bound_null <= 0] <- 1e-10
merged_data_20_Ebselen_NULL$lower_bound_real[merged_data_20_Ebselen_NULL$lower_bound_real <= 0] <- 1e-10
merged_data_20_Ebselen_NULL$upper_bound_null[merged_data_20_Ebselen_NULL$upper_bound_null <= 0] <- 1e-10
merged_data_20_Ebselen_NULL$upper_bound_real[merged_data_20_Ebselen_NULL$upper_bound_real <= 0] <- 1e-10

# Filter to include only species with a mean relative abundance > 0.01 in the 'real' dataset
significant_species <- merged_data_20_Ebselen[merged_data_20_Ebselen$mean_rel_ab.real > 0.01, ]
survivors_20_Ebselen <- nrow(significant_species)
survivors_20_Ebselen

#should be the same as survivors defined above, since it is calculated from .real
significant_species_NULL <- merged_data_20_Ebselen_NULL[merged_data_20_Ebselen_NULL$mean_rel_ab.real > 0.01, ]
survivors_20_Ebselen_NULL <- nrow(significant_species_NULL)
survivors_20_Ebselen_NULL

# Adjusted order of magnitude check to include SD, only for significant species
significant_species$Predicted_magnitude_correct <- ifelse(
  (floor(log10(significant_species$lower_bound_pred)) <= floor(log10(significant_species$upper_bound_real)) &
     floor(log10(significant_species$upper_bound_pred)) >= floor(log10(significant_species$lower_bound_real))),
  1,
  0
)

#and for the Null model:
significant_species_NULL$Predicted_magnitude_correct <- ifelse(
  (floor(log10(significant_species_NULL$lower_bound_null)) <= floor(log10(significant_species_NULL$upper_bound_real)) &
     floor(log10(significant_species_NULL$upper_bound_null)) >= floor(log10(significant_species_NULL$lower_bound_real))),
  1,
  0
)

# Calculate the fraction of correctly predicted magnitudes for significant species
predicted_magnitude_correct_fraction_20_Ebselen <- sum(significant_species$Predicted_magnitude_correct) / nrow(significant_species)
predicted_magnitude_correct_fraction_20_Ebselen

predicted_magnitude_correct_fraction_20_Ebselen_NULL <- sum(significant_species_NULL$Predicted_magnitude_correct) / nrow(significant_species_NULL)
predicted_magnitude_correct_fraction_20_Ebselen_NULL

top_species_missing_20_Ebselen <- setdiff(top6_real_20_Ebselen_means, top6_predicted_20_Ebselen_means)
top_species_wrong_20_Ebselen <- setdiff(top6_predicted_20_Ebselen_means, top6_real_20_Ebselen_means)

top_species_missing_20_Ebselen <- if(length(top_species_missing_20_Ebselen) == 0) "None" else top_species_missing_20_Ebselen
top_species_wrong_20_Ebselen <- if(length(top_species_wrong_20_Ebselen) == 0) "None" else top_species_wrong_20_Ebselen

Prediction_quality_20_Ebselen <- data.frame(
  Top_six_correct = paste(top_six_correct_20_Ebselen, sep=""),
  Top_six_correct_NULL = paste(top_six_correct_20_Ebselen_NULL, sep=""),
  Top_six_correct_means = paste(top_six_correct_20_Ebselen_means, sep=""),
  Top_six_correct_means_NULL = paste(top_six_correct_20_Ebselen_means_NULL, sep=""),
  Predicted_magnitude_correct = paste(round(predicted_magnitude_correct_fraction_20_Ebselen * 100, 2), "%", sep=""),
  Predicted_magnitude_correct_NULL = paste(round(predicted_magnitude_correct_fraction_20_Ebselen_NULL * 100, 2), "%", sep=""),
  survivors_total = survivors_20_Ebselen,
  top_species_missing <- top_species_missing_20_Ebselen,
  top_species_wrong <- top_species_wrong_20_Ebselen, 
  predicted_mean_final_OD <- predicted_mean_final_od_20_Ebselen,
  real_mean_final_OD <- real_mean_final_od_20_Ebselen,
  sims_total = length(successful_sim_ids)
)

Prediction_quality_20_Ebselen






##Next, for 1.25 uM:
# Get top 6 species from plot_data_1.25_endpoint
# Adjust the plot_data_1.25_endpoint with confidence bounds
plot_data_1.25_Ebselen_endpoint <- plot_data_1.25_Ebselen_endpoint %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)

# Adjust the Ebselen_16S_1.25uM_summarised with confidence bounds
Ebselen_16S_1.25uM_summarised <- Ebselen_16S_1.25uM_summarised %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)

#NULL model:
Null_model_summarised <- Niclosamide_16S_0uM_summarised %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)


# Get top 6 species based on the lower bound from plot_data_1.25_endpoint
top6_predicted_1.25_Ebselen <- plot_data_1.25_Ebselen_endpoint %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

# Get top 6 species based on the lower bound from Ebselen_16S_1.25uM_summarised
top6_real_1.25_Ebselen <- Ebselen_16S_1.25uM_summarised %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

top6_NULL <- Null_model_summarised %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

# Calculate the overlap of top 6 species
top_six_correct_1.25_Ebselen <- length(intersect(top6_predicted_1.25_Ebselen, top6_real_1.25_Ebselen))
#top_six_correct_1.25_Ebselen

top_six_correct_1.25_Ebselen_NULL <- length(intersect(top6_NULL, top6_real_1.25_Ebselen))
#top_six_correct_1.25_Ebselen_NULL

#top6_predicted_1.25_Ebselen
#top6_real_1.25_Ebselen




#Now by means:
top6_predicted_1.25_Ebselen_means <- plot_data_1.25_Ebselen_endpoint %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)

# Get top 6 species based on the lower bound from Ebselen_16S_1.25uM_summarised
top6_real_1.25_Ebselen_means <- Ebselen_16S_1.25uM_summarised %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)

top6_NULL_means <- Null_model_summarised %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)



top_six_correct_1.25_Ebselen_means <- length(intersect(top6_predicted_1.25_Ebselen_means, top6_real_1.25_Ebselen_means))
#top_six_correct_1.25_Ebselen_means

top_six_correct_1.25_Ebselen_means_NULL <- length(intersect(top6_NULL_means, top6_real_1.25_Ebselen_means))
#top_six_correct_1.25_Ebselen_means_NULL

#top6_predicted_1.25_Ebselen_means
#top6_real_1.25_Ebselen_means




# Merge dataframes by Species
merged_data_1.25_Ebselen <- merge(plot_data_1.25_Ebselen_endpoint, Ebselen_16S_1.25uM_summarised, by = "Species", suffixes = c(".pred", ".real"))
merged_data_1.25_Ebselen_NULL <- merge(Niclosamide_16S_0uM_summarised, Ebselen_16S_1.25uM_summarised, by = "Species", suffixes = c(".null", ".real"))



# Create lower and upper bounds considering mean ¬± sd
merged_data_1.25_Ebselen$lower_bound_pred <- merged_data_1.25_Ebselen$mean_rel_ab.pred - merged_data_1.25_Ebselen$sd_rel_ab.pred
merged_data_1.25_Ebselen$upper_bound_pred <- merged_data_1.25_Ebselen$mean_rel_ab.pred + merged_data_1.25_Ebselen$sd_rel_ab.pred
merged_data_1.25_Ebselen$lower_bound_real <- merged_data_1.25_Ebselen$mean_rel_ab.real - merged_data_1.25_Ebselen$sd_rel_ab.real
merged_data_1.25_Ebselen$upper_bound_real <- merged_data_1.25_Ebselen$mean_rel_ab.real + merged_data_1.25_Ebselen$sd_rel_ab.real

# Ensure lower and upper bounds are non-negative, adjusting as necessary
merged_data_1.25_Ebselen$lower_bound_pred[merged_data_1.25_Ebselen$lower_bound_pred <= 0] <- 1e-10
merged_data_1.25_Ebselen$lower_bound_real[merged_data_1.25_Ebselen$lower_bound_real <= 0] <- 1e-10
merged_data_1.25_Ebselen$upper_bound_pred[merged_data_1.25_Ebselen$upper_bound_pred <= 0] <- 1e-10
merged_data_1.25_Ebselen$upper_bound_real[merged_data_1.25_Ebselen$upper_bound_real <= 0] <- 1e-10

##and for NULL model:
# Create lower and upper bounds considering mean ¬± sd
merged_data_1.25_Ebselen_NULL$lower_bound_null <- merged_data_1.25_Ebselen_NULL$mean_rel_ab.null - merged_data_1.25_Ebselen_NULL$sd_rel_ab.null
merged_data_1.25_Ebselen_NULL$upper_bound_null <- merged_data_1.25_Ebselen_NULL$mean_rel_ab.null + merged_data_1.25_Ebselen_NULL$sd_rel_ab.null
merged_data_1.25_Ebselen_NULL$lower_bound_real <- merged_data_1.25_Ebselen_NULL$mean_rel_ab.real - merged_data_1.25_Ebselen_NULL$sd_rel_ab.real
merged_data_1.25_Ebselen_NULL$upper_bound_real <- merged_data_1.25_Ebselen_NULL$mean_rel_ab.real + merged_data_1.25_Ebselen_NULL$sd_rel_ab.real

# Ensure lower and upper bounds are non-negative, adjusting as necessary
merged_data_1.25_Ebselen_NULL$lower_bound_null[merged_data_1.25_Ebselen_NULL$lower_bound_null <= 0] <- 1e-10
merged_data_1.25_Ebselen_NULL$lower_bound_real[merged_data_1.25_Ebselen_NULL$lower_bound_real <= 0] <- 1e-10
merged_data_1.25_Ebselen_NULL$upper_bound_null[merged_data_1.25_Ebselen_NULL$upper_bound_null <= 0] <- 1e-10
merged_data_1.25_Ebselen_NULL$upper_bound_real[merged_data_1.25_Ebselen_NULL$upper_bound_real <= 0] <- 1e-10

# Filter to include only species with a mean relative abundance > 0.01 in the 'real' dataset
significant_species <- merged_data_1.25_Ebselen[merged_data_1.25_Ebselen$mean_rel_ab.real > 0.01, ]
survivors_1.25_Ebselen <- nrow(significant_species)
survivors_1.25_Ebselen

#should be the same as survivors defined above, since it is calculated from .real
significant_species_NULL <- merged_data_1.25_Ebselen_NULL[merged_data_1.25_Ebselen_NULL$mean_rel_ab.real > 0.01, ]
survivors_1.25_Ebselen_NULL <- nrow(significant_species_NULL)
survivors_1.25_Ebselen_NULL

# Adjusted order of magnitude check to include SD, only for significant species
significant_species$Predicted_magnitude_correct <- ifelse(
  (floor(log10(significant_species$lower_bound_pred)) <= floor(log10(significant_species$upper_bound_real)) &
     floor(log10(significant_species$upper_bound_pred)) >= floor(log10(significant_species$lower_bound_real))),
  1,
  0
)

#and for the Null model:
significant_species_NULL$Predicted_magnitude_correct <- ifelse(
  (floor(log10(significant_species_NULL$lower_bound_null)) <= floor(log10(significant_species_NULL$upper_bound_real)) &
     floor(log10(significant_species_NULL$upper_bound_null)) >= floor(log10(significant_species_NULL$lower_bound_real))),
  1,
  0
)

# Calculate the fraction of correctly predicted magnitudes for significant species
predicted_magnitude_correct_fraction_1.25_Ebselen <- sum(significant_species$Predicted_magnitude_correct) / nrow(significant_species)
predicted_magnitude_correct_fraction_1.25_Ebselen

predicted_magnitude_correct_fraction_1.25_Ebselen_NULL <- sum(significant_species_NULL$Predicted_magnitude_correct) / nrow(significant_species_NULL)
predicted_magnitude_correct_fraction_1.25_Ebselen_NULL


top_species_missing_1.25_Ebselen <- setdiff(top6_real_1.25_Ebselen_means, top6_predicted_1.25_Ebselen_means)
top_species_wrong_1.25_Ebselen <- setdiff(top6_predicted_1.25_Ebselen_means, top6_real_1.25_Ebselen_means)

top_species_missing_1.25_Ebselen <- if(length(top_species_missing_1.25_Ebselen) == 0) "None" else top_species_missing_1.25_Ebselen
top_species_wrong_1.25_Ebselen <- if(length(top_species_wrong_1.25_Ebselen) == 0) "None" else top_species_wrong_1.25_Ebselen

Prediction_quality_1.25_Ebselen <- data.frame(
  Top_six_correct = paste(top_six_correct_1.25_Ebselen, sep=""),
  Top_six_correct_NULL = paste(top_six_correct_1.25_Ebselen_NULL, sep=""),
  Top_six_correct_means = paste(top_six_correct_1.25_Ebselen_means, sep=""),
  Top_six_correct_means_NULL = paste(top_six_correct_1.25_Ebselen_means_NULL, sep=""),
  Predicted_magnitude_correct = paste(round(predicted_magnitude_correct_fraction_1.25_Ebselen * 100, 2), "%", sep=""),
  Predicted_magnitude_correct_NULL = paste(round(predicted_magnitude_correct_fraction_1.25_Ebselen_NULL * 100, 2), "%", sep=""),
  survivors_total = survivors_1.25_Ebselen,
  top_species_missing <- top_species_missing_1.25_Ebselen,
  top_species_wrong <- top_species_wrong_1.25_Ebselen, 
  predicted_mean_final_OD <- predicted_mean_final_od_1.25_Ebselen,
  real_mean_final_OD <- real_mean_final_od_1.25_Ebselen,
  sims_total = length(successful_sim_ids)
)

Prediction_quality_1.25_Ebselen












##Entacapone

combined_monoculture_aucs2_Entacapone <- subset(combined_monoculture_aucs2, drug == "Entacapone")


#drug sensitivity terms: define once outside of ODEs
y_function_B_vulgatus_Entacapone <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("B_vulgatus", "Entacapone", best_fitting_models_df_Entacapone)), collapse = " ")))
y_function_B_uniformis_Entacapone <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("B_uniformis", "Entacapone", best_fitting_models_df_Entacapone)), collapse = " ")))
y_function_B_fragilis_Entacapone <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("B_fragilis", "Entacapone", best_fitting_models_df_Entacapone)), collapse = " ")))
y_function_B_thetaiotaomicron_Entacapone <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("B_thetaiotaomicron", "Entacapone", best_fitting_models_df_Entacapone)), collapse = " ")))
y_function_C_ramosum_Entacapone <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("C_ramosum", "Entacapone", best_fitting_models_df_Entacapone)), collapse = " ")))
y_function_E_rectale_Entacapone <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("E_rectale", "Entacapone", best_fitting_models_df_Entacapone)), collapse = " ")))
y_function_R_intestinalis_Entacapone <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("R_intestinalis", "Entacapone", best_fitting_models_df_Entacapone)), collapse = " ")))
y_function_V_parvula_Entacapone <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("V_parvula", "Entacapone", best_fitting_models_df_Entacapone)), collapse = " ")))
y_function_E_lenta_Entacapone <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("E_lenta", "Entacapone", best_fitting_models_df_Entacapone)), collapse = " ")))
y_function_F_nucleatum_Entacapone <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("F_nucleatum", "Entacapone", best_fitting_models_df_Entacapone)), collapse = " ")))
y_function_C_bolteae_Entacapone <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("C_bolteae", "Entacapone", best_fitting_models_df_Entacapone)), collapse = " ")))
y_function_C_perfringens_Entacapone <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("C_perfringens", "Entacapone", best_fitting_models_df_Entacapone)), collapse = " ")))
y_function_C_saccharolyticum_Entacapone <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("C_saccharolyticum", "Entacapone", best_fitting_models_df_Entacapone)), collapse = " ")))
y_function_S_salivarius_Entacapone <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("S_salivarius", "Entacapone", best_fitting_models_df_Entacapone)), collapse = " ")))
y_function_R_gnavus_Entacapone <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("R_gnavus", "Entacapone", best_fitting_models_df_Entacapone)), collapse = " ")))
y_function_C_comes_Entacapone <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("C_comes", "Entacapone", best_fitting_models_df_Entacapone)), collapse = " ")))
y_function_P_merdae_Entacapone <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("P_merdae", "Entacapone", best_fitting_models_df_Entacapone)), collapse = " ")))
y_function_S_parasanguinis_Entacapone <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("S_parasanguinis", "Entacapone", best_fitting_models_df_Entacapone)), collapse = " ")))
y_function_C_aerofaciens_Entacapone <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("C_aerofaciens", "Entacapone", best_fitting_models_df_Entacapone)), collapse = " ")))
y_function_D_formicigenerans_Entacapone <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("D_formicigenerans", "Entacapone", best_fitting_models_df_Entacapone)), collapse = " ")))
y_function_E_coli_Entacapone <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("E_coli", "Entacapone", best_fitting_models_df_Entacapone)), collapse = " ")))



y_function_B_vulgatus_Entacapone_func <- eval(parse(text = paste("function(Drug) {", y_function_B_vulgatus_Entacapone, "}")))
y_function_B_uniformis_Entacapone_func <- eval(parse(text = paste("function(Drug) {", y_function_B_uniformis_Entacapone, "}")))
y_function_B_fragilis_Entacapone_func <- eval(parse(text = paste("function(Drug) {", y_function_B_fragilis_Entacapone, "}")))
y_function_B_thetaiotaomicron_Entacapone_func <- eval(parse(text = paste("function(Drug) {", y_function_B_thetaiotaomicron_Entacapone, "}")))
y_function_C_ramosum_Entacapone_func <- eval(parse(text = paste("function(Drug) {", y_function_C_ramosum_Entacapone, "}")))
y_function_E_rectale_Entacapone_func <- eval(parse(text = paste("function(Drug) {", y_function_E_rectale_Entacapone, "}")))
y_function_R_intestinalis_Entacapone_func <- eval(parse(text = paste("function(Drug) {", y_function_R_intestinalis_Entacapone, "}")))
y_function_E_lenta_Entacapone_func <- eval(parse(text = paste("function(Drug) {", y_function_E_lenta_Entacapone, "}")))
y_function_F_nucleatum_Entacapone_func <- eval(parse(text = paste("function(Drug) {", y_function_F_nucleatum_Entacapone, "}")))
y_function_C_bolteae_Entacapone_func <- eval(parse(text = paste("function(Drug) {", y_function_C_bolteae_Entacapone, "}")))
y_function_C_perfringens_Entacapone_func <- eval(parse(text = paste("function(Drug) {", y_function_C_perfringens_Entacapone, "}")))
y_function_C_saccharolyticum_Entacapone_func <- eval(parse(text = paste("function(Drug) {", y_function_C_saccharolyticum_Entacapone, "}")))
y_function_S_salivarius_Entacapone_func <- eval(parse(text = paste("function(Drug) {", y_function_S_salivarius_Entacapone, "}")))
y_function_R_gnavus_Entacapone_func <- eval(parse(text = paste("function(Drug) {", y_function_R_gnavus_Entacapone, "}")))
y_function_C_comes_Entacapone_func <- eval(parse(text = paste("function(Drug) {", y_function_C_comes_Entacapone, "}")))
y_function_P_merdae_Entacapone_func <- eval(parse(text = paste("function(Drug) {", y_function_P_merdae_Entacapone, "}")))
y_function_S_parasanguinis_Entacapone_func <- eval(parse(text = paste("function(Drug) {", y_function_S_parasanguinis_Entacapone, "}")))
y_function_C_aerofaciens_Entacapone_func <- eval(parse(text = paste("function(Drug) {", y_function_C_aerofaciens_Entacapone, "}")))
y_function_D_formicigenerans_Entacapone_func <- eval(parse(text = paste("function(Drug) {", y_function_D_formicigenerans_Entacapone, "}")))
y_function_E_coli_Entacapone_func <- eval(parse(text = paste("function(Drug) {", y_function_E_coli_Entacapone, "}")))
y_function_V_parvula_Entacapone_func <- eval(parse(text = paste("function(Drug) {", y_function_V_parvula_Entacapone, "}")))



unique(combined_monoculture_aucs2_Entacapone$conc)
##dictate drug concentration tested for simulation cycle here:
#drug_concentration_tested <- 5 #if manually or:
drug_concentration_tested <- unique(combined_monoculture_aucs2_Entacapone$conc)[1] 
initial_conditions <- rep(0.01/32, 32)
initial_conditions <- c(initial_conditions, drug_concentration_tested)


##drug effect fitted for species showing sensitivity in monoculture:
#unique(combined_monoculture_aucs2_Entacapone$Species)

##for more simple linear fits
closed.sir.model_Entacapone <- function (t, x, params) {
  ## first extract the state variables
  A_muciniphila <- x[1]
  B_adolescentis <- x[2]
  B_fragilis <- x[3]
  B_longum <- x[4]
  B_obeum <- x[5]
  B_thetaiotaomicron <- x[6]
  B_uniformis <- x[7]
  B_vulgatus <- x[8]
  B_wadsworthia <- x[9]
  C_aerofaciens <- x[10]
  C_bolteae <- x[11]
  C_comes <- x[12]
  C_perfringens <- x[13]
  C_ramosum <- x[14]
  C_saccharolyticum <- x[15]
  D_formicigenerans <- x[16]
  E_coli <- x[17]
  E_lenta <- x[18]
  E_rectale <- x[19]
  F_nucleatum <- x[20]
  L_paracasei <- x[21]
  O_splanchnicus <- x[22]
  P_copri <- x[23]
  P_distasonis <- x[24]
  P_merdae <- x[25]
  R_bromii <- x[26]
  R_gnavus <- x[27]
  R_intestinalis <- x[28]
  R_torques <- x[29]
  S_parasanguinis <- x[30]
  S_salivarius <- x[31]
  V_parvula <- x[32]
  Drug <- x[33]
  
  
  ## now extract the parameters
  r_B_fragilis <- flat_params[["B._fragilis.r"]]
  K_B_fragilis <- flat_params[["B._fragilis.K"]]
  r_B_longum <- flat_params[["B._longum.r"]]
  K_B_longum <- flat_params[["B._longum.K"]]
  r_B_thetaiotaomicron <- flat_params[["B._thetaiotaomicron.r"]]
  K_B_thetaiotaomicron <- flat_params[["B._thetaiotaomicron.K"]]
  r_B_uniformis <- flat_params[["B._uniformis.r"]]
  K_B_uniformis <- flat_params[["B._uniformis.K"]]
  r_B_vulgatus <- flat_params[["B._vulgatus.r"]]
  K_B_vulgatus <- flat_params[["B._vulgatus.K"]]
  r_B_wadsworthia <- flat_params[["B._wadsworthia.r"]]
  K_B_wadsworthia <- flat_params[["B._wadsworthia.K"]]
  r_C_aerofaciens <- flat_params[["C._aerofaciens.r"]]
  K_C_aerofaciens <- flat_params[["C._aerofaciens.K"]]
  r_C_bolteae <- flat_params[["C._bolteae.r"]]
  K_C_bolteae <- flat_params[["C._bolteae.K"]]
  r_C_comes <- flat_params[["C._comes.r"]]
  K_C_comes <- flat_params[["C._comes.K"]]
  r_C_perfringens <- flat_params[["C._perfringens.r"]]
  K_C_perfringens <- flat_params[["C._perfringens.K"]]
  r_C_ramosum <- flat_params[["C._ramosum.r"]]
  K_C_ramosum <- flat_params[["C._ramosum.K"]]
  r_C_saccharolyticum <- flat_params[["C._saccharolyticum.r"]]
  K_C_saccharolyticum <- flat_params[["C._saccharolyticum.K"]]
  r_D_formicigenerans <- flat_params[["D._formicigenerans.r"]]
  K_D_formicigenerans <- flat_params[["D._formicigenerans.K"]]
  r_E_coli <- flat_params[["E._coli.r"]]
  K_E_coli <- flat_params[["E._coli.K"]]
  r_E_lenta <- flat_params[["E._lenta.r"]]
  K_E_lenta <- flat_params[["E._lenta.K"]]
  r_E_rectale <- flat_params[["E._rectale.r"]]
  K_E_rectale <- flat_params[["E._rectale.K"]]
  r_F_nucleatum <- flat_params[["F._nucleatum.r"]]
  K_F_nucleatum <- flat_params[["F._nucleatum.K"]]
  r_P_copri <- flat_params[["P._copri.r"]]
  K_P_copri <- flat_params[["P._copri.K"]]
  r_P_merdae <- flat_params[["P._merdae.r"]]
  K_P_merdae <- flat_params[["P._merdae.K"]]
  r_R_gnavus <- flat_params[["R._gnavus.r"]]
  K_R_gnavus <- flat_params[["R._gnavus.K"]]
  r_R_intestinalis <- flat_params[["R._intestinalis.r"]]
  K_R_intestinalis <- flat_params[["R._intestinalis.K"]]
  r_V_parvula <- flat_params[["V._parvula.r"]]
  K_V_parvula <- flat_params[["V._parvula.K"]]
  r_A_muciniphila <- flat_params[["A._muciniphila.r"]]
  K_A_muciniphila <- flat_params[["A._muciniphila.K"]]
  r_B_adolescentis <- flat_params[["B._adolescentis.r"]]
  K_B_adolescentis <- flat_params[["B._adolescentis.K"]]
  r_B_obeum <- flat_params[["B._obeum.r"]]
  K_B_obeum <- flat_params[["B._obeum.K"]]
  r_O_splanchnicus <- flat_params[["O._splanchnicus.r"]]
  K_O_splanchnicus <- flat_params[["O._splanchnicus.K"]]
  r_P_distasonis <- flat_params[["P._distasonis.r"]]
  K_P_distasonis <- flat_params[["P._distasonis.K"]]
  r_R_bromii <- flat_params[["R._bromii.r"]]
  K_R_bromii <- flat_params[["R._bromii.K"]]
  r_R_torques <- flat_params[["R._torques.r"]]
  K_R_torques <- flat_params[["R._torques.K"]]
  r_S_parasanguinis <- flat_params[["S._parasanguinis.r"]]
  K_S_parasanguinis <-flat_params[["S._parasanguinis.K"]]
  r_S_salivarius <- flat_params[["S._salivarius.r"]]
  K_S_salivarius <- flat_params[["S._salivarius.K"]]
  r_L_paracasei <- flat_params[["L._paracasei.r"]]
  K_L_paracasei <- flat_params[["L._paracasei.K"]]
  
  
  t_mod <- ifelse(t > 24.1, t - 24.1, t)
  
  
  ## now code the model equations
  dA_muciniphila_dt <- r_A_muciniphila * A_muciniphila * (1 - A_muciniphila / K_A_muciniphila)
  dB_adolescentis_dt <- r_B_adolescentis * B_adolescentis * (1 - B_adolescentis / K_B_adolescentis)
  dB_fragilis_dt <- r_B_fragilis * B_fragilis * (1 - B_fragilis / max(0.0001, K_B_fragilis * (y_function_B_fragilis_Entacapone_func(Drug))))
  dB_longum_dt <- r_B_longum * B_longum * (1 - B_longum / K_B_longum)
  dB_obeum_dt <- r_B_obeum * B_obeum * (1 - B_obeum / K_B_obeum)
  dB_thetaiotaomicron_dt <- r_B_thetaiotaomicron * B_thetaiotaomicron * (1 - B_thetaiotaomicron / max(0.0001, K_B_thetaiotaomicron * (y_function_B_thetaiotaomicron_Entacapone_func(Drug))))  
  dB_uniformis_dt <- r_B_uniformis * B_uniformis * (1 - B_uniformis / max(0.0001, K_B_uniformis * (y_function_B_uniformis_Entacapone_func(Drug))))
  dB_vulgatus_dt <- r_B_vulgatus * B_vulgatus * (1 - B_vulgatus / max(0.0001, K_B_vulgatus * (y_function_B_vulgatus_Entacapone_func(Drug))))
  dB_wadsworthia_dt <- r_B_wadsworthia * B_wadsworthia * (1 - B_wadsworthia / K_B_wadsworthia)
  dC_aerofaciens_dt <- r_C_aerofaciens * C_aerofaciens * (1 - C_aerofaciens / max(0.0001, K_C_aerofaciens * (y_function_C_aerofaciens_Entacapone_func(Drug))))
  dC_bolteae_dt <- r_C_bolteae * C_bolteae * (1 - C_bolteae /  max(0.0001, K_C_bolteae * (y_function_C_bolteae_Entacapone_func(Drug))))
  dC_comes_dt <- r_C_comes * C_comes * (1 - C_comes / max(0.0001, K_C_comes * (y_function_C_comes_Entacapone_func(Drug))))
  dC_perfringens_dt <- r_C_perfringens * C_perfringens * (1 - C_perfringens / max(0.0001, K_C_perfringens * (y_function_C_perfringens_Entacapone_func(Drug))))
  dC_ramosum_dt <- r_C_ramosum * C_ramosum * (1 - C_ramosum / max(0.0001, K_C_ramosum * (y_function_C_ramosum_Entacapone_func(Drug))))
  dC_saccharolyticum_dt <- r_C_saccharolyticum * C_saccharolyticum * (1 - C_saccharolyticum / max(0.0001, K_C_saccharolyticum * (y_function_C_saccharolyticum_Entacapone_func(Drug))))
  dD_formicigenerans_dt <- r_D_formicigenerans * D_formicigenerans * (1 - D_formicigenerans / max(0.0001, K_D_formicigenerans * (y_function_D_formicigenerans_Entacapone_func(Drug))))
  dE_coli_dt <- r_E_coli * E_coli * (1 - E_coli / max(0.0001, K_E_coli * (y_function_E_coli_Entacapone_func(Drug))))
  dE_lenta_dt <- r_E_lenta * E_lenta * (1 - E_lenta / max(0.0001, K_E_lenta * (y_function_E_lenta_Entacapone_func(Drug))))
  dE_rectale_dt <- r_E_rectale * E_rectale * (1 - E_rectale / max(0.0001, K_E_rectale * (y_function_E_rectale_Entacapone_func(Drug))))
  dF_nucleatum_dt <- r_F_nucleatum * F_nucleatum * (1 - F_nucleatum / max(0.0001, K_F_nucleatum * (y_function_F_nucleatum_Entacapone_func(Drug))))
  dL_paracasei_dt <- r_L_paracasei * L_paracasei * (1 - L_paracasei / K_L_paracasei)  
  dO_splanchnicus_dt <- r_O_splanchnicus * O_splanchnicus * (1 - O_splanchnicus / K_O_splanchnicus)  
  dP_copri_dt <- r_P_copri * P_copri * (1 - P_copri / K_P_copri)
  dP_distasonis_dt <- r_P_distasonis * P_distasonis * (1 - P_distasonis / K_P_distasonis)  
  dP_merdae_dt <- r_P_merdae * P_merdae * (1 - P_merdae / max(0.0001, K_P_merdae * (y_function_P_merdae_Entacapone_func(Drug))))
  dR_bromii_dt <- r_R_bromii * R_bromii * (1 - R_bromii / K_R_bromii) 
  dR_gnavus_dt <- r_R_gnavus * R_gnavus * (1 - R_gnavus / max(0.0001, K_R_gnavus * (y_function_R_gnavus_Entacapone_func(Drug))))
  dR_intestinalis_dt <- r_R_intestinalis * R_intestinalis * (1 - R_intestinalis / max(0.0001, K_R_intestinalis * (y_function_R_intestinalis_Entacapone_func(Drug))))
  dR_torques_dt <- r_R_torques * R_torques * (1 - R_torques /K_R_torques) 
  dS_parasanguinis_dt <- r_S_parasanguinis * S_parasanguinis * (1 - S_parasanguinis / max(0.0001, K_S_parasanguinis * (y_function_S_parasanguinis_Entacapone_func(Drug))))
  dS_salivarius_dt <- r_S_salivarius * S_salivarius * (1 - S_salivarius / max(0.0001, K_S_salivarius * (y_function_S_salivarius_Entacapone_func(Drug))))
  dV_parvula_dt <- r_V_parvula * V_parvula * (1 - V_parvula / max(0.0001, K_V_parvula * (y_function_V_parvula_Entacapone_func(Drug))))
  
  
  
  #Drug differential:
  dDrug_dt <- (subset(drug_dynamics, Drug == "Entacapone")$Steepness_param_community * exp(-subset(drug_dynamics, Drug == "Entacapone")$Steepness_param_community * t_mod)) * (drug_concentration_tested * prop_left_Entacapone - drug_concentration_tested)
  #dDrug_dt <- 0
  
  ## Combine results into a single vector
  dxdt <- c(dA_muciniphila_dt, dB_adolescentis_dt, dB_fragilis_dt, dB_longum_dt, dB_obeum_dt, dB_thetaiotaomicron_dt, dB_uniformis_dt, dB_vulgatus_dt, dB_wadsworthia_dt, dC_aerofaciens_dt, dC_bolteae_dt, dC_comes_dt, dC_perfringens_dt, dC_ramosum_dt, dC_saccharolyticum_dt, dD_formicigenerans_dt, dE_coli_dt, dE_lenta_dt, dE_rectale_dt, dF_nucleatum_dt, dL_paracasei_dt, dO_splanchnicus_dt, dP_copri_dt, dP_distasonis_dt, dP_merdae_dt, dR_bromii_dt, dR_gnavus_dt, dR_intestinalis_dt, dR_torques_dt, dS_parasanguinis_dt, dS_salivarius_dt, dV_parvula_dt, dDrug_dt)
  
  ## Return result as a list
  list(dxdt)
}




#calculate the co-culture correction factor per species based on community composition in absence of drug, just like done for Niclosamide

growth_data_all_0_Niclosamide
growth_data_all_0_Niclosamide1 <- growth_data_all_0_Niclosamide %>%
  dplyr::mutate(Species = gsub(" ", "_", Species))


# Merge rel_ab_control with growth_data_all_0_Niclosamide on Species
# Function to remove duplicated columns by name pattern
clean_columns_base <- function(df, pattern) {
  cols_to_keep <- !grepl(pattern, names(df))
  df <- df[, cols_to_keep]
  return(df)
}

# Use the new function to clean up your dataframe
rel_ab_control <- clean_columns_base(rel_ab_control, "mean_max_OD.[xy]")
str(rel_ab_control)


#rel_ab_control$correction_factor <- rel_ab_control$mean_rel_ab / (rel_ab_control$mean_max_OD/sum(rel_ab_control$mean_max_OD))
# Calculate correction factor with a minimum value of ~1
rel_ab_control$correction_factor <- pmax(rel_ab_control$mean_rel_ab / (rel_ab_control$mean_max_OD / sum(rel_ab_control$mean_max_OD)), 1.1)


# Create a new dataframe for co-culture correction
co_culture_correction <- data.frame(
  species = rel_ab_control$Species,
  correction_factor = rel_ab_control$correction_factor
)


#summarise community data
#Adjust based on tested concentrations for each drug
unique(Community_compositions_focus_drugs_Entacapone$concentration)

Community_compositions_focus_drugs_Entacapone_5uM <- subset(Community_compositions_focus_drugs_Entacapone, concentration == 5)
Community_compositions_focus_drugs_Entacapone_20uM <- subset(Community_compositions_focus_drugs_Entacapone, concentration == 20)
Community_compositions_focus_drugs_Entacapone_80uM <- subset(Community_compositions_focus_drugs_Entacapone, concentration == 80)


#5 uM
Community_compositions_focus_drugs_Entacapone_5uM_summarised <- Community_compositions_focus_drugs_Entacapone_5uM %>%
  dplyr::group_by(species) %>%                                  
  dplyr::summarize(
    mean_rel_ab = mean(rel_abundance, na.rm = TRUE),     
    sd_rel_ab = sd(rel_abundance, na.rm = TRUE) ,
    mean_max_OD = mean(maxOD, na.rm = TRUE),
    sd_max_OD = sd(maxOD, na.rm = TRUE),
    mean_final_OD = mean(finalOD, na.rm = TRUE),
    sd_final_OD = sd(finalOD, na.rm = TRUE)
  ) %>%
  dplyr::ungroup() 


Community_compositions_focus_drugs_Entacapone_5uM_summarised <- Community_compositions_focus_drugs_Entacapone_5uM_summarised %>%
  dplyr::mutate(Species = sub("^(\\w)\\w*\\s(.*)", "\\1._\\2", species))

#remove (sub)strain info
Community_compositions_focus_drugs_Entacapone_5uM_summarised <- Community_compositions_focus_drugs_Entacapone_5uM_summarised %>%
  dplyr::mutate(Species = sub("^(\\w\\._\\w+).*", "\\1", Species))


#20 uM
Community_compositions_focus_drugs_Entacapone_20uM_summarised <- Community_compositions_focus_drugs_Entacapone_20uM %>%
  dplyr::group_by(species) %>%                                  
  dplyr::summarize(
    mean_rel_ab = mean(rel_abundance, na.rm = TRUE),     
    sd_rel_ab = sd(rel_abundance, na.rm = TRUE) ,
    mean_max_OD = mean(maxOD, na.rm = TRUE),
    sd_max_OD = sd(maxOD, na.rm = TRUE),
    mean_final_OD = mean(finalOD, na.rm = TRUE),
    sd_final_OD = sd(finalOD, na.rm = TRUE)
  ) %>%
  dplyr::ungroup() 


Community_compositions_focus_drugs_Entacapone_20uM_summarised <- Community_compositions_focus_drugs_Entacapone_20uM_summarised %>%
  dplyr::mutate(Species = sub("^(\\w)\\w*\\s(.*)", "\\1._\\2", species))

#remove (sub)strain info
Community_compositions_focus_drugs_Entacapone_20uM_summarised <- Community_compositions_focus_drugs_Entacapone_20uM_summarised %>%
  dplyr::mutate(Species = sub("^(\\w\\._\\w+).*", "\\1", Species))


#80 uM
Community_compositions_focus_drugs_Entacapone_80uM_summarised <- Community_compositions_focus_drugs_Entacapone_80uM %>%
  dplyr::group_by(species) %>%                                  
  dplyr::summarize(
    mean_rel_ab = mean(rel_abundance, na.rm = TRUE),     
    sd_rel_ab = sd(rel_abundance, na.rm = TRUE) ,
    mean_max_OD = mean(maxOD, na.rm = TRUE),
    sd_max_OD = sd(maxOD, na.rm = TRUE),    
    mean_final_OD = mean(finalOD, na.rm = TRUE),
    sd_final_OD = sd(finalOD, na.rm = TRUE)
  ) %>%
  dplyr::ungroup() 



Community_compositions_focus_drugs_Entacapone_80uM_summarised <- Community_compositions_focus_drugs_Entacapone_80uM_summarised %>%
  dplyr::mutate(Species = sub("^(\\w)\\w*\\s(.*)", "\\1._\\2", species))

#remove (sub)strain info
Community_compositions_focus_drugs_Entacapone_80uM_summarised <- Community_compositions_focus_drugs_Entacapone_80uM_summarised %>%
  dplyr::mutate(Species = sub("^(\\w\\._\\w+).*", "\\1", Species))


#Initialise data frames
sim_output <- data.frame()
input_params_list <- list() #Use a list to collect parameters for each simulation

#number of simulations
num_sims <- 250


for (i in 1:num_sims) {
  tryCatch({
    # generate model parameters
    set.seed(i) #set a different seed for each simulation for variation
    params <- lapply(1:nrow(growth_data_all_0_Niclosamide), function(idx) {
      species_params <- growth_data_all_0_Niclosamide[idx, ]
      list(
        r = rnorm(1, mean = species_params$mean_max_Growth_rate, sd = species_params$sd_max_Growth_rate),
        K = rnorm(1, mean = species_params$mean_max_OD, sd = species_params$sd_max_OD)
      )
    })
    names(params) <- gsub(" ", "_", growth_data_all_0_Niclosamide$Species)
    flat_params <- unlist(params)
    names(flat_params) <- gsub("\\.\\d$", "", names(flat_params))
    
    #replace spaces with underscores to match formatting
    co_culture_correction$species <- gsub(" ", "_", co_culture_correction$species, fixed = TRUE)
    
    #replace the species-specific K parameters extracted from monoculture growth data 
    #with drawn relative abundance values at Niclosamide = 0, scaled to K
    rel_ab_control$Species <- gsub(" ", "_", rel_ab_control$Species)
    
    #Initialise an empty vector to store drawn values
    drawn_values <- numeric(nrow(rel_ab_control))
    
    #draw values from their respective distributions
    for (k in 1:nrow(rel_ab_control)) {
      species_name <- rel_ab_control$Species[k]
      drawn_value <- rnorm(1, mean = rel_ab_control$mean_rel_ab[k], sd = rel_ab_control$sd_rel_ab[k])
      drawn_values[k] <- max(drawn_value, 0)  # Ensure no negative values
    }
    
    #Normalise drawn relative abundance values so they sum to 1 (to reflect a 'true' relative abundance distribution)
    #this is needed so when we convert the values into OD units by multiplying with the drawn community maxOD,
    # the sum of K_i parameters and the drawn K are equal
    normalised_values <- drawn_values / sum(drawn_values)
    
    #Pull community maxOD (K) at 0 drugs from respective normal distribution:
    K <- rnorm(n = 1, mean = rel_ab_control$mean_com_max_OD[1], sd = rel_ab_control$sd_com_max_OD[1])
    
    # Assign these normalised values to their respective species' .K parameters
    for (k in 1:nrow(rel_ab_control)) {
      species_name <- rel_ab_control$Species[k]
      k_index <- grep(paste0("^", species_name, "\\.K$"), names(flat_params))
      
      if (length(k_index) > 0) {
        old_value <- flat_params[k_index]
        flat_params[k_index] <- (normalised_values[k] + 0.0001) * K #add small value in case drawn K_i is 0, which would cause issues with the solver
        cat(sprintf("Updated %s from %f to %f using normalised value %f scaled by K %f\n", names(flat_params)[k_index], old_value, flat_params[k_index], normalised_values[k], K))
      }
    }
    
    #Accounting for variation in drug degradation by community, with standard deviation of end concentration (at 10h) around the fitted predicted (relative) end concentration at 24h
    #prop_left_Entacapone <- abs(rnorm(1, (subset(drug_dynamics, Drug == "Entacapone")$Prop_left_24h_community), (subset(drug_dynamics, Drug == "Entacapone")$SD_drug_community))) 
    #below, we account for measurement error rather than ecological drivers that lead to the variability of degradation at the final point measured 
    prop_left_Entacapone <- abs(rnorm(
      n = 1, 
      mean = subset(drug_dynamics, Drug == "Entacapone")$Prop_left_24h_community, 
      sd = ifelse(
        subset(drug_dynamics, Drug == "Entacapone")$SD_drug_community > subset(drug_dynamics, Drug == "Entacapone")$SD_drug_community_start, 
        subset(drug_dynamics, Drug == "Entacapone")$SD_drug_community - subset(drug_dynamics, Drug == "Entacapone")$SD_drug_community_start, 
        subset(drug_dynamics, Drug == "Entacapone")$SD_drug_community
      )
    ))
    
    
    #loop through each species in co_culture_correction
    for (j in 1:nrow(co_culture_correction)) {
      # Extract the species name and correction factor
      species_name <- co_culture_correction$species[j]
      correction_factor <- co_culture_correction$correction_factor[j]
      
      # Identify the corresponding growth rate parameter in flat_params
      #by matching the base species name (without .r)
      growth_rate_indices <- grep(paste0("^", species_name, "\\.r$"), names(flat_params))
      
      #take the growth rate parameter and apply the correction factor 
      for (index in growth_rate_indices) {
        flat_params[index] <- flat_params[index] * correction_factor
      }
    }
    
    flat_params
    # Store parameters for each simulation
    input_params_list[[i]] <- c(sim_ID = i, flat_params)
    
    # Run the model for the first 24-hour cycle
    solution_cycle_1 <- ode(y = initial_conditions, times = seq(from = 0, to = 24, by = 0.1), func = closed.sir.model_Entacapone, parms = flat_params,   method = "lsoda", rtol = 1e-6, atol = 1e-6)
    
    # Dilution and second cycle
    end_of_cycle_1 <- solution_cycle_1[nrow(solution_cycle_1), -1]
    initial_conditions_cycle_2 <- end_of_cycle_1 / 50
    #accounting for the drugs being added with the new growth cycle as well:
    initial_conditions_cycle_2[33] <- initial_conditions_cycle_2[33] + drug_concentration_tested
    solution_cycle_2 <- ode(y = initial_conditions_cycle_2, times = seq(from = 24, to = 48, by = 0.1), func = closed.sir.model_Entacapone, parms = flat_params,  method = "lsoda", rtol = 1e-6, atol = 1e-6)
    
    # Combine and format results
    combined_solution <- rbind(as.data.frame(solution_cycle_1), as.data.frame(solution_cycle_2)[-1,])
    combined_solution$sim_ID <- rep(i, nrow(combined_solution))
    combined_solution <- combined_solution %>%
      tidyr::gather(key = "Species", value = "Density", -time, -sim_ID) %>%
      dplyr::mutate(Hour = time) %>%
      dplyr::select(sim_ID, Hour, Species, Density)
    
    ##Append to sim_output
    sim_output <- rbind(sim_output, combined_solution)
  }, error = function(e) {
    cat(sprintf("Skipping simulation %d due to an error: %s\n", i, e$message))
  })
}



##Combine all parameter data into a single dataframe
input_params <- do.call(rbind, input_params_list)

# Add a "Species" column 
sim_output$Species_name <- species_names[as.numeric(as.character(sim_output$Species))]
sim_output$Species_name <- replace_na(sim_output$Species_name, "Drug")

#View(input_params)
#View(sim_output)

sim_output <- na.omit(sim_output)
successful_sim_ids <- unique(subset(sim_output, Hour == 48)$sim_ID)
length(successful_sim_ids)
sim_output1 <- sim_output[sim_output$sim_ID %in% successful_sim_ids, ]


#Transform sim_output so we have wide format by Species
sim_output_wide <- tidyr::pivot_wider(sim_output1, 
                                      names_from = Species_name, 
                                      values_from = Density,
                                      id_cols = c(sim_ID, Hour))

length(unique(sim_output_wide$sim_ID))
#calc community OD per timepoint
sim_output_wide$Total_OD <- rowSums(sim_output_wide[, 3:34], na.rm = TRUE)
#calculate and add relative abundances here as well:
species_columns <- colnames(sim_output_wide)[3:34] 

for (species in species_columns) {
  sim_output_wide[[paste0("rel_", species)]] <- sim_output_wide[[species]] / sim_output_wide$Total_OD
}


#assign sim_output_wide test conditions to dataframe name
drug_tested <- "Entacapone"
variable_name_1 <- paste0("sim_output_wide_", ifelse(drug_concentration_tested == 1e-04, 0, drug_concentration_tested), "_", drug_tested)
assign(variable_name_1, sim_output_wide)

#turn back into long format if interested in plotting relative abundances
cols_needed <- c("sim_ID", "Hour")

sim_output_long <- sim_output_wide %>% 
  dplyr::select(sim_ID, Hour, Drug, starts_with("rel_")) %>% 
  tidyr::pivot_longer(
    cols = c(Drug, starts_with("rel_")),
    names_to = "Species", 
    values_to = "Relative_abundance",
    names_prefix = "rel_",
    names_transform = list(Species = ~ ifelse(.x == "Drug", "Drug", .x))
  ) 

str(sim_output_long)


species_names_1 <- c(
  "A_muciniphila",
  "B_adolescentis",
  "B_fragilis",
  "B_longum",
  "B_obeum",
  "B_thetaiotaomicron",
  "B_uniformis",
  "B_vulgatus",
  "B_wadsworthia",
  "C_aerofaciens",
  "C_bolteae",
  "C_comes",
  "C_perfringens",
  "C_ramosum",
  "C_saccharolyticum",
  "D_formicigenerans",
  "E_coli",
  "E_lenta",
  "E_rectale",
  "F_nucleatum",
  "L_paracasei",
  "O_splanchnicus",
  "P_copri",
  "P_distasonis",
  "P_merdae",
  "R_bromii",
  "R_gnavus",
  "R_intestinalis",
  "R_torques",
  "S_parasanguinis",
  "S_salivarius",
  "V_parvula",
  "Drug"
)

species_colours_1 <- c(
  "A_muciniphila" = "#1f77b4",
  "B_adolescentis" = "#ff7f0e",
  "B_fragilis" = "#2ca02c",
  "B_longum" = "#d62728",
  "B_obeum" = "#9467bd",
  "B_thetaiotaomicron" = "black",
  "B_uniformis" = "#e377c2",
  "B_vulgatus" = "#7f7f7f",
  "B_wadsworthia" = "gold1",
  "C_aerofaciens" = "#aec7e8",
  "C_bolteae" = "#ffbb78",
  "C_comes" = "magenta",
  "C_perfringens" = "#ff9896",
  "C_ramosum" = "#c5b0d5",
  "C_saccharolyticum" = "#c49c94",
  "D_formicigenerans" = "#f7b6d2",
  "E_coli" = "yellow",
  "E_lenta" = "turquoise",
  "E_rectale" = "#393b79",
  "F_nucleatum" = "royalblue2",
  "L_paracasei" = "blue",
  "O_splanchnicus" = "#637939",
  "P_copri" = "cyan",
  "P_distasonis" = "#8c6d31",
  "P_merdae" = "#c7c7c7",
  "R_bromii" = "#e6550d",
  "R_gnavus" = "#e7cb94",
  "R_intestinalis" = "#843c39",
  "R_torques" = "#d6616b",
  "S_parasanguinis" = "orange3",
  "S_salivarius" = "#7b4173",
  "V_parvula" = "#ce6dbd",
  "Drug" = "green"
)



##Plot output for any specific sim:
# ggplot(subset(sim_output, sim_ID == 1 & Species_name != "Drug"), aes(x = Hour, y = Density, group = Species_name, color = Species_name)) +
#   geom_line(size = 1, alpha = 0.7) +
#   scale_color_manual(values = species_colours_1) +
#   labs(title = paste0("Entacapone = ", drug_concentration_tested),
#        x = "Time (hours)",
#        y = "Population Density (OD)",
#        color = "Species") +
#   theme_minimal() +
#   theme(legend.position = "right")
# 
# ggplot(subset(sim_output, sim_ID == 3 & Species_name != "Drug"), aes(x = Hour, y = Density, group = Species_name, color = Species_name)) +
#   geom_line(size = 1, alpha = 0.7) +
#   scale_color_manual(values = species_colours_1) +
#   labs(title = paste0("Entacapone = ", drug_concentration_tested),
#        x = "Time (hours)",
#        y = "Population Density (OD)",
#        color = "Species") +
#   theme_minimal() +
#   theme(legend.position = "right")


ggplot(subset(sim_output_long, sim_ID == 1), aes(x = Hour, y = Relative_abundance, group = Species, color = Species)) +
  geom_line(size = 1, alpha = 0.7) +
  scale_color_manual(values = species_colours_1) +
  labs(title = paste0("Entacapone = ", drug_concentration_tested),
       x = "Time (hours)",
       y = "Relative abundance",
       color = "Species") +
  theme_minimal() +
  theme(legend.position = "right")


ggplot(subset(sim_output_long, sim_ID == 3), aes(x = Hour, y = Relative_abundance, group = Species, color = Species)) +
  geom_line(size = 1, alpha = 0.7) +
  scale_color_manual(values = species_colours_1) +
  labs(title = paste0("Entacapone = ", drug_concentration_tested),
       x = "Time (hours)",
       y = "Relative abundance",
       color = "Species") +
  theme_minimal() +
  theme(legend.position = "right")


#calc mean and standard deviation across sims
sim_stats <- sim_output_long %>%
  dplyr::group_by(Hour, Species) %>%
  dplyr::summarise(
    mean_rel_ab = mean(Relative_abundance),
    sd_rel_ab = sd(Relative_abundance),
    .groups = 'drop'
  )

# Prepare the data for plotting
plot_data <- sim_stats %>%
  dplyr::mutate(Upper = mean_rel_ab + sd_rel_ab, Lower = mean_rel_ab - sd_rel_ab)

ggplot(subset(plot_data, Species != "Drug"), aes(x = Hour, y = mean_rel_ab, group = Species, color = Species)) +
  geom_ribbon(aes(ymin = Lower, ymax = Upper, fill = Species), colour = NA, alpha = 0.2) +  
  geom_line(size = 1, alpha = 0.7) + 
  scale_color_manual(values = species_colours_1) +
  scale_fill_manual(values = species_colours_1) +  
  labs(title = "Mean and SD of Relative Abundance Across Simulations",
       subtitle = paste0("Entacapone = ", drug_concentration_tested),       
       x = "Time (hours)",
       y = "Relative abundance",
       color = "Species",
       fill = "Species") +
  theme_minimal() +
  theme(legend.position = "right")

#log-scaled mean trends
ggplot(plot_data, aes(x = Hour, y = log10(mean_rel_ab + 0.0001), group = Species, color = Species)) +
  geom_line(size = 1, alpha = 0.7) +  # Mean line
  scale_color_manual(values = species_colours_1) +
  scale_fill_manual(values = species_colours_1) +  # Ensure consistent colors for lines and fills
  labs(title = "Mean and SD of Relative Abundance Across Simulations",
       subtitle = paste0("Entacapone = ", drug_concentration_tested),
       x = "Time (hours)",
       y = "Relative abundance",
       color = "Species",
       fill = "Species") +
  theme_minimal() +
  theme(legend.position = "right")




##prediction quality evaluation
drug_tested <- "Entacapone"
variable_name <- paste0("plot_data_", ifelse(drug_concentration_tested == 1e-04, 0, drug_concentration_tested), "_", drug_tested)
assign(variable_name, plot_data)


#extract total OD info:
predicted_mean_final_od_NULL <- Niclosamide_16S_0uM_summarised$mean_com_final_OD[1]
predicted_sd_final_od_NULL <- Niclosamide_16S_0uM_summarised$sd_com_final_OD[1]

predicted_mean_final_od_5_Entacapone <- mean(subset(sim_output_wide_5_Entacapone, Hour == 48)$Total_OD, na.rm = TRUE)
predicted_sd_final_od_5_Entacapone <- sd(subset(sim_output_wide_5_Entacapone, Hour == 48)$Total_OD, na.rm = TRUE)

real_mean_final_od_5_Entacapone <- Community_compositions_focus_drugs_Entacapone_5uM_summarised$mean_final_OD[1]
real_sd_final_od_5_Entacapone <- Community_compositions_focus_drugs_Entacapone_5uM_summarised$sd_final_OD[1]


predicted_mean_final_od_20_Entacapone <- mean(subset(sim_output_wide_20_Entacapone, Hour == 48)$Total_OD, na.rm = TRUE)
predicted_sd_final_od_20_Entacapone <- sd(subset(sim_output_wide_20_Entacapone, Hour == 48)$Total_OD, na.rm = TRUE)

real_mean_final_od_20_Entacapone <- Community_compositions_focus_drugs_Entacapone_20uM_summarised$mean_final_OD[1]
real_sd_final_od_20_Entacapone <- Community_compositions_focus_drugs_Entacapone_20uM_summarised$sd_final_OD[1]


predicted_mean_final_od_80_Entacapone <- mean(subset(sim_output_wide_80_Entacapone, Hour == 48)$Total_OD, na.rm = TRUE)
predicted_sd_final_od_80_Entacapone <- sd(subset(sim_output_wide_80_Entacapone, Hour == 48)$Total_OD, na.rm = TRUE)

real_mean_final_od_80_Entacapone <- Community_compositions_focus_drugs_Entacapone_80uM_summarised$mean_final_OD[1]
real_sd_final_od_80_Entacapone <- Community_compositions_focus_drugs_Entacapone_80uM_summarised$sd_final_OD[1]




#plot_data_0_Entacapone_endpoint was used to test model performance at 0 drugs
#plot_data_0_Entacapone_endpoint <- subset(plot_data_0_Entacapone, Hour == 48 & Species != "Drug")
plot_data_5_Entacapone_endpoint <- subset(plot_data_5_Entacapone, Hour == 48 & Species != "Drug")
plot_data_20_Entacapone_endpoint <- subset(plot_data_20_Entacapone, Hour == 48 & Species != "Drug")
plot_data_80_Entacapone_endpoint <- subset(plot_data_80_Entacapone, Hour == 48 & Species != "Drug")

##Inspecting 'match' to real relative abundance distributions:
Niclosamide_16S_0uM_summarised <- rel_ab_control
Niclosamide_16S_0uM_summarised$Species <- gsub("\\.", "", Niclosamide_16S_0uM_summarised$Species)

Entacapone_16S_5uM_summarised <- Community_compositions_focus_drugs_Entacapone_5uM_summarised
Entacapone_16S_20uM_summarised <- Community_compositions_focus_drugs_Entacapone_20uM_summarised
Entacapone_16S_80uM_summarised <- Community_compositions_focus_drugs_Entacapone_80uM_summarised

Niclosamide_16S_0uM_summarised
Entacapone_16S_5uM_summarised 
Entacapone_16S_20uM_summarised 
Entacapone_16S_80uM_summarised 

#Rename 'species' so the outputs become comparable
original_names_80 <- unique(Entacapone_16S_80uM_summarised$species)
original_names_20 <- unique(Entacapone_16S_20uM_summarised$species)
original_names_5 <- unique(Entacapone_16S_5uM_summarised$species)


##Create a named vector with the original and new names mapping
name_changes <- c(
  "Akkermansia muciniphila" = "A_muciniphila",
  "Bacteroides fragilis" = "B_fragilis",
  "Bacteroides thetaiotaomicron" = "B_thetaiotaomicron",
  "Bacteroides uniformis" = "B_uniformis",
  "Bifidobacterium adolescentis" = "B_adolescentis",
  "Bifidobacterium longum subsp. longum" = "B_longum",
  "Bilophila wadsworthia" = "B_wadsworthia",
  "Blautia obeum" = "B_obeum",
  "Clostridium perfringens" = "C_perfringens",
  "Collinsella aerofaciens" = "C_aerofaciens",
  "Coprococcus comes" = "C_comes",
  "Dorea formicigenerans" = "D_formicigenerans",
  "Eggerthella lenta" = "E_lenta",
  "Enterocloster bolteae" = "C_bolteae",
  "Erysipelatoclostridium ramosum" = "C_ramosum",
  "Escherichia coli ED1a" = "E_coli",
  "Eubacterium rectale" = "E_rectale",
  "Fusobacterium nucleatum subsp. nucleatum" = "F_nucleatum",
  "Lacrimispora saccharolytica" = "C_saccharolyticum",
  "Lacticaseibacillus paracasei" = "L_paracasei",
  "Odoribacter splanchnicus" = "O_splanchnicus",
  "Parabacteroides distasonis" = "P_distasonis",
  "Parabacteroides merdae" = "P_merdae",
  "Phocaeicola vulgatus" = "B_vulgatus",
  "Prevotella copri" = "P_copri",
  "Roseburia intestinalis" = "R_intestinalis",
  "Ruminococcus bromii" = "R_bromii",
  "Ruminococcus gnavus" = "R_gnavus",
  "Ruminococcus torques" = "R_torques",
  "Streptococcus parasanguinis" = "S_parasanguinis",
  "Streptococcus salivarius" = "S_salivarius",
  "Veillonella parvula" = "V_parvula"
)

# Apply name changes to the species column in Entacapone_16S_80uM_summarised

Entacapone_16S_80uM_summarised$Species <- name_changes[Entacapone_16S_80uM_summarised$species]
Entacapone_16S_20uM_summarised$Species <- name_changes[Entacapone_16S_20uM_summarised$species]
Entacapone_16S_5uM_summarised$Species <- name_changes[Entacapone_16S_5uM_summarised$species]

# Verify the changes
unique(Entacapone_16S_80uM_summarised$Species)
unique(Entacapone_16S_20uM_summarised$Species)
unique(Entacapone_16S_5uM_summarised$Species)



##First, for 5 uM:
# Get top 6 species from plot_data_5_endpoint
# Adjust the plot_data_5_endpoint with confidence bounds

# #plot_data_0_Entacapone_endpoint was used to test model performance at 0 drugs
# plot_data_0_Entacapone_endpoint <- plot_data_0_Entacapone_endpoint %>%
#   dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)

plot_data_5_Entacapone_endpoint <- plot_data_5_Entacapone_endpoint %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)

# Adjust the Entacapone_16S_5uM_summarised with confidence bounds
Entacapone_16S_5uM_summarised <- Entacapone_16S_5uM_summarised %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)

#NULL model:
Null_model_summarised <- Niclosamide_16S_0uM_summarised %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)


# Get top 6 species based on the lower bound from plot_data_5_endpoint

#top6_predicted_0_Entacapone was used to test model performance at 0 drugs
# top6_predicted_0_Entacapone <- plot_data_0_Entacapone_endpoint %>%
#    arrange(desc(lower_bound)) %>%
#    slice(1:6) %>%
#    pull(Species)

top6_predicted_5_Entacapone <- plot_data_5_Entacapone_endpoint %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

# Get top 6 species based on the lower bound from Entacapone_16S_5uM_summarised
top6_real_5_Entacapone <- Entacapone_16S_5uM_summarised %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

top6_NULL <- Null_model_summarised %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

# Calculate the overlap of top 6 species

#top_six_correct_0_Entacapone was used to assess model performance at 0 drugs
# top_six_correct_0_Entacapone <- length(intersect(top6_predicted_0_Entacapone, top6_NULL))
# top_six_correct_0_Entacapone

top_six_correct_5_Entacapone <- length(intersect(top6_predicted_5_Entacapone, top6_real_5_Entacapone))
top_six_correct_5_Entacapone

top_six_correct_5_Entacapone_NULL <- length(intersect(top6_NULL, top6_real_5_Entacapone))
top_six_correct_5_Entacapone_NULL

top6_predicted_5_Entacapone
top6_real_5_Entacapone

#top6_NULL

#Now by means:
# #top6_predicted_0_Entacapone_means was used to assess model performance at 0 drugs
# top6_predicted_0_Entacapone_means <- plot_data_0_Entacapone_endpoint %>%
#    arrange(desc(mean_rel_ab)) %>%
#    slice(1:6) %>%
#    pull(Species)

top6_predicted_5_Entacapone_means <- plot_data_5_Entacapone_endpoint %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)

# Get top 6 species based on the lower bound from Entacapone_16S_5uM_summarised
top6_real_5_Entacapone_means <- Entacapone_16S_5uM_summarised %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)

top6_NULL_means <- Null_model_summarised %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)


# #top_six_correct_0_Entacapone_means was used to assess model performance at 0 drugs
# top_six_correct_0_Entacapone_means <- length(intersect(top6_predicted_0_Entacapone_means, top6_NULL_means))
# top_six_correct_0_Entacapone_means

top_six_correct_5_Entacapone_means <- length(intersect(top6_predicted_5_Entacapone_means, top6_real_5_Entacapone_means))
top_six_correct_5_Entacapone_means

top_six_correct_5_Entacapone_means_NULL <- length(intersect(top6_NULL_means, top6_real_5_Entacapone_means))
top_six_correct_5_Entacapone_means_NULL

top6_predicted_5_Entacapone_means
top6_real_5_Entacapone_means

#top6_NULL_means


# Merge dataframes by Species

#merged_data_0_Entacapone was used to assess model performance at 0 drugs
#merged_data_0_Entacapone <- merge(plot_data_0_Entacapone_endpoint, Niclosamide_16S_0uM_summarised, by = "Species", suffixes = c(".pred", ".real"))
merged_data_5_Entacapone <- merge(plot_data_5_Entacapone_endpoint, Entacapone_16S_5uM_summarised, by = "Species", suffixes = c(".pred", ".real"))
merged_data_5_Entacapone_NULL <- merge(Niclosamide_16S_0uM_summarised, Entacapone_16S_5uM_summarised, by = "Species", suffixes = c(".null", ".real"))


## Below lines used for assessing model performance at 0 drugs; ignore for nonzero concentrations
# # Create lower and upper bounds considering mean ¬± sd
# merged_data_0_Entacapone$lower_bound_pred <- merged_data_0_Entacapone$mean_rel_ab.pred - merged_data_0_Entacapone$sd_rel_ab.pred
# merged_data_0_Entacapone$upper_bound_pred <- merged_data_0_Entacapone$mean_rel_ab.pred + merged_data_0_Entacapone$sd_rel_ab.pred
# merged_data_0_Entacapone$lower_bound_real <- merged_data_0_Entacapone$mean_rel_ab.real - merged_data_0_Entacapone$sd_rel_ab.real
# merged_data_0_Entacapone$upper_bound_real <- merged_data_0_Entacapone$mean_rel_ab.real + merged_data_0_Entacapone$sd_rel_ab.real
# 
# # Ensure lower and upper bounds are non-negative, adjusting as necessary
# merged_data_0_Entacapone$lower_bound_pred[merged_data_0_Entacapone$lower_bound_pred <= 0] <- 1e-10
# merged_data_0_Entacapone$lower_bound_real[merged_data_0_Entacapone$lower_bound_real <= 0] <- 1e-10
# merged_data_0_Entacapone$upper_bound_pred[merged_data_0_Entacapone$upper_bound_pred <= 0] <- 1e-10
# merged_data_0_Entacapone$upper_bound_real[merged_data_0_Entacapone$upper_bound_real <= 0] <- 1e-10


# Create lower and upper bounds considering mean ¬± sd
merged_data_5_Entacapone$lower_bound_pred <- merged_data_5_Entacapone$mean_rel_ab.pred - merged_data_5_Entacapone$sd_rel_ab.pred
merged_data_5_Entacapone$upper_bound_pred <- merged_data_5_Entacapone$mean_rel_ab.pred + merged_data_5_Entacapone$sd_rel_ab.pred
merged_data_5_Entacapone$lower_bound_real <- merged_data_5_Entacapone$mean_rel_ab.real - merged_data_5_Entacapone$sd_rel_ab.real
merged_data_5_Entacapone$upper_bound_real <- merged_data_5_Entacapone$mean_rel_ab.real + merged_data_5_Entacapone$sd_rel_ab.real

# Ensure lower and upper bounds are non-negative, adjusting as necessary
merged_data_5_Entacapone$lower_bound_pred[merged_data_5_Entacapone$lower_bound_pred <= 0] <- 1e-10
merged_data_5_Entacapone$lower_bound_real[merged_data_5_Entacapone$lower_bound_real <= 0] <- 1e-10
merged_data_5_Entacapone$upper_bound_pred[merged_data_5_Entacapone$upper_bound_pred <= 0] <- 1e-10
merged_data_5_Entacapone$upper_bound_real[merged_data_5_Entacapone$upper_bound_real <= 0] <- 1e-10

##and for NULL model:
# Create lower and upper bounds considering mean ¬± sd
merged_data_5_Entacapone_NULL$lower_bound_null <- merged_data_5_Entacapone_NULL$mean_rel_ab.null - merged_data_5_Entacapone_NULL$sd_rel_ab.null
merged_data_5_Entacapone_NULL$upper_bound_null <- merged_data_5_Entacapone_NULL$mean_rel_ab.null + merged_data_5_Entacapone_NULL$sd_rel_ab.null
merged_data_5_Entacapone_NULL$lower_bound_real <- merged_data_5_Entacapone_NULL$mean_rel_ab.real - merged_data_5_Entacapone_NULL$sd_rel_ab.real
merged_data_5_Entacapone_NULL$upper_bound_real <- merged_data_5_Entacapone_NULL$mean_rel_ab.real + merged_data_5_Entacapone_NULL$sd_rel_ab.real

# Ensure lower and upper bounds are non-negative, adjusting as necessary
merged_data_5_Entacapone_NULL$lower_bound_null[merged_data_5_Entacapone_NULL$lower_bound_null <= 0] <- 1e-10
merged_data_5_Entacapone_NULL$lower_bound_real[merged_data_5_Entacapone_NULL$lower_bound_real <= 0] <- 1e-10
merged_data_5_Entacapone_NULL$upper_bound_null[merged_data_5_Entacapone_NULL$upper_bound_null <= 0] <- 1e-10
merged_data_5_Entacapone_NULL$upper_bound_real[merged_data_5_Entacapone_NULL$upper_bound_real <= 0] <- 1e-10

# Filter to include only species with a mean relative abundance > 0.01 in the 'real' dataset

## significant_species_0 was used to assess model performance at 0 drugs
#significant_species_0 <- merged_data_0_Entacapone[merged_data_0_Entacapone$mean_rel_ab.real > 0.01, ]
significant_species <- merged_data_5_Entacapone[merged_data_5_Entacapone$mean_rel_ab.real > 0.01, ]
survivors_5_Entacapone <- nrow(significant_species)
survivors_5_Entacapone

#should be the same as survivors defined above, since it is calculated from .real
significant_species_NULL <- merged_data_5_Entacapone_NULL[merged_data_5_Entacapone_NULL$mean_rel_ab.real > 0.01, ]
survivors_5_Entacapone_NULL <- nrow(significant_species_NULL)
survivors_5_Entacapone_NULL

# Adjusted order of magnitude check to include SD, only for significant species
## below code was used to assess model performance at 0 drugs
# significant_species_0$Predicted_magnitude_correct <- ifelse(
#   (floor(log10(significant_species_0$lower_bound_pred)) <= floor(log10(significant_species_0$upper_bound_real)) &
#      floor(log10(significant_species_0$upper_bound_pred)) >= floor(log10(significant_species_0$lower_bound_real))),
#   1,
#   0
# )

significant_species$Predicted_magnitude_correct <- ifelse(
  (floor(log10(significant_species$lower_bound_pred)) <= floor(log10(significant_species$upper_bound_real)) &
     floor(log10(significant_species$upper_bound_pred)) >= floor(log10(significant_species$lower_bound_real))),
  1,
  0
)

#and for the Null model:
significant_species_NULL$Predicted_magnitude_correct <- ifelse(
  (floor(log10(significant_species_NULL$lower_bound_null)) <= floor(log10(significant_species_NULL$upper_bound_real)) &
     floor(log10(significant_species_NULL$upper_bound_null)) >= floor(log10(significant_species_NULL$lower_bound_real))),
  1,
  0
)

# Calculate the fraction of correctly predicted magnitudes for significant species
## below code was used to assess model performance at 0 drugs
#predicted_magnitude_correct_fraction_0_Entacapone <- sum(significant_species_0$Predicted_magnitude_correct) / nrow(significant_species_0)
#predicted_magnitude_correct_fraction_0_Entacapone

predicted_magnitude_correct_fraction_5_Entacapone <- sum(significant_species$Predicted_magnitude_correct) / nrow(significant_species)
predicted_magnitude_correct_fraction_5_Entacapone

predicted_magnitude_correct_fraction_5_Entacapone_NULL <- sum(significant_species_NULL$Predicted_magnitude_correct) / nrow(significant_species_NULL)
predicted_magnitude_correct_fraction_5_Entacapone_NULL

top_species_missing_5_Entacapone <- setdiff(top6_real_5_Entacapone_means, top6_predicted_5_Entacapone_means)
top_species_wrong_5_Entacapone <- setdiff(top6_predicted_5_Entacapone_means, top6_real_5_Entacapone_means)

top_species_missing_5_Entacapone <- if(length(top_species_missing_5_Entacapone) == 0) "None" else top_species_missing_5_Entacapone
top_species_wrong_5_Entacapone <- if(length(top_species_wrong_5_Entacapone) == 0) "None" else top_species_wrong_5_Entacapone


Prediction_quality_5_Entacapone <- data.frame(
  Top_six_correct = paste(top_six_correct_5_Entacapone, sep=""),
  Top_six_correct_NULL = paste(top_six_correct_5_Entacapone_NULL, sep=""),
  Top_six_correct_means = paste(top_six_correct_5_Entacapone_means, sep=""),
  Top_six_correct_means_NULL = paste(top_six_correct_5_Entacapone_means_NULL, sep=""),
  Predicted_magnitude_correct = paste(round(predicted_magnitude_correct_fraction_5_Entacapone * 100, 2), "%", sep=""),
  Predicted_magnitude_correct_NULL = paste(round(predicted_magnitude_correct_fraction_5_Entacapone_NULL * 100, 2), "%", sep=""),
  survivors_total = survivors_5_Entacapone,
  top_species_missing <- top_species_missing_5_Entacapone,
  top_species_wrong <- top_species_wrong_5_Entacapone, 
  predicted_mean_final_OD <- predicted_mean_final_od_5_Entacapone,
  real_mean_final_OD <- real_mean_final_od_5_Entacapone,
  sims_total = length(successful_sim_ids)
)



Prediction_quality_5_Entacapone



##Next, for 20 uM:
# Get top 6 species from plot_data_20_endpoint
# Adjust the plot_data_20_endpoint with confidence bounds
plot_data_20_Entacapone_endpoint <- plot_data_20_Entacapone_endpoint %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)

# Adjust the Entacapone_16S_20uM_summarised with confidence bounds
Entacapone_16S_20uM_summarised <- Entacapone_16S_20uM_summarised %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)

#NULL model:
Null_model_summarised <- Niclosamide_16S_0uM_summarised %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)


# Get top 6 species based on the lower bound from plot_data_20_endpoint
top6_predicted_20_Entacapone <- plot_data_20_Entacapone_endpoint %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

# Get top 6 species based on the lower bound from Entacapone_16S_20uM_summarised
top6_real_20_Entacapone <- Entacapone_16S_20uM_summarised %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

top6_NULL <- Null_model_summarised %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

# Calculate the overlap of top 6 species
top_six_correct_20_Entacapone <- length(intersect(top6_predicted_20_Entacapone, top6_real_20_Entacapone))
#top_six_correct_20_Entacapone

top_six_correct_20_Entacapone_NULL <- length(intersect(top6_NULL, top6_real_20_Entacapone))
#top_six_correct_20_Entacapone_NULL

#top6_predicted_20_Entacapone
#top6_real_20_Entacapone



#Now by means:
top6_predicted_20_Entacapone_means <- plot_data_20_Entacapone_endpoint %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)

# Get top 6 species based on the lower bound from Entacapone_16S_20uM_summarised
top6_real_20_Entacapone_means <- Entacapone_16S_20uM_summarised %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)

top6_NULL_means <- Null_model_summarised %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)



top_six_correct_20_Entacapone_means <- length(intersect(top6_predicted_20_Entacapone_means, top6_real_20_Entacapone_means))
#top_six_correct_20_Entacapone_means

top_six_correct_20_Entacapone_means_NULL <- length(intersect(top6_NULL_means, top6_real_20_Entacapone_means))
#top_six_correct_20_Entacapone_means_NULL

top6_predicted_20_Entacapone_means
#top6_real_20_Entacapone_means




# Merge dataframes by Species
merged_data_20_Entacapone <- merge(plot_data_20_Entacapone_endpoint, Entacapone_16S_20uM_summarised, by = "Species", suffixes = c(".pred", ".real"))
merged_data_20_Entacapone_NULL <- merge(Niclosamide_16S_0uM_summarised, Entacapone_16S_20uM_summarised, by = "Species", suffixes = c(".null", ".real"))



# Create lower and upper bounds considering mean ¬± sd
merged_data_20_Entacapone$lower_bound_pred <- merged_data_20_Entacapone$mean_rel_ab.pred - merged_data_20_Entacapone$sd_rel_ab.pred
merged_data_20_Entacapone$upper_bound_pred <- merged_data_20_Entacapone$mean_rel_ab.pred + merged_data_20_Entacapone$sd_rel_ab.pred
merged_data_20_Entacapone$lower_bound_real <- merged_data_20_Entacapone$mean_rel_ab.real - merged_data_20_Entacapone$sd_rel_ab.real
merged_data_20_Entacapone$upper_bound_real <- merged_data_20_Entacapone$mean_rel_ab.real + merged_data_20_Entacapone$sd_rel_ab.real

# Ensure lower and upper bounds are non-negative, adjusting as necessary
merged_data_20_Entacapone$lower_bound_pred[merged_data_20_Entacapone$lower_bound_pred <= 0] <- 1e-10
merged_data_20_Entacapone$lower_bound_real[merged_data_20_Entacapone$lower_bound_real <= 0] <- 1e-10
merged_data_20_Entacapone$upper_bound_pred[merged_data_20_Entacapone$upper_bound_pred <= 0] <- 1e-10
merged_data_20_Entacapone$upper_bound_real[merged_data_20_Entacapone$upper_bound_real <= 0] <- 1e-10

##and for NULL model:
# Create lower and upper bounds considering mean ¬± sd
merged_data_20_Entacapone_NULL$lower_bound_null <- merged_data_20_Entacapone_NULL$mean_rel_ab.null - merged_data_20_Entacapone_NULL$sd_rel_ab.null
merged_data_20_Entacapone_NULL$upper_bound_null <- merged_data_20_Entacapone_NULL$mean_rel_ab.null + merged_data_20_Entacapone_NULL$sd_rel_ab.null
merged_data_20_Entacapone_NULL$lower_bound_real <- merged_data_20_Entacapone_NULL$mean_rel_ab.real - merged_data_20_Entacapone_NULL$sd_rel_ab.real
merged_data_20_Entacapone_NULL$upper_bound_real <- merged_data_20_Entacapone_NULL$mean_rel_ab.real + merged_data_20_Entacapone_NULL$sd_rel_ab.real

# Ensure lower and upper bounds are non-negative, adjusting as necessary
merged_data_20_Entacapone_NULL$lower_bound_null[merged_data_20_Entacapone_NULL$lower_bound_null <= 0] <- 1e-10
merged_data_20_Entacapone_NULL$lower_bound_real[merged_data_20_Entacapone_NULL$lower_bound_real <= 0] <- 1e-10
merged_data_20_Entacapone_NULL$upper_bound_null[merged_data_20_Entacapone_NULL$upper_bound_null <= 0] <- 1e-10
merged_data_20_Entacapone_NULL$upper_bound_real[merged_data_20_Entacapone_NULL$upper_bound_real <= 0] <- 1e-10

# Filter to include only species with a mean relative abundance > 0.01 in the 'real' dataset
significant_species <- merged_data_20_Entacapone[merged_data_20_Entacapone$mean_rel_ab.real > 0.01, ]
survivors_20_Entacapone <- nrow(significant_species)
survivors_20_Entacapone

#should be the same as survivors defined above, since it is calculated from .real
significant_species_NULL <- merged_data_20_Entacapone_NULL[merged_data_20_Entacapone_NULL$mean_rel_ab.real > 0.01, ]
survivors_20_Entacapone_NULL <- nrow(significant_species_NULL)
survivors_20_Entacapone_NULL

# Adjusted order of magnitude check to include SD, only for significant species
significant_species$Predicted_magnitude_correct <- ifelse(
  (floor(log10(significant_species$lower_bound_pred)) <= floor(log10(significant_species$upper_bound_real)) &
     floor(log10(significant_species$upper_bound_pred)) >= floor(log10(significant_species$lower_bound_real))),
  1,
  0
)

#and for the Null model:
significant_species_NULL$Predicted_magnitude_correct <- ifelse(
  (floor(log10(significant_species_NULL$lower_bound_null)) <= floor(log10(significant_species_NULL$upper_bound_real)) &
     floor(log10(significant_species_NULL$upper_bound_null)) >= floor(log10(significant_species_NULL$lower_bound_real))),
  1,
  0
)

# Calculate the fraction of correctly predicted magnitudes for significant species
predicted_magnitude_correct_fraction_20_Entacapone <- sum(significant_species$Predicted_magnitude_correct) / nrow(significant_species)
predicted_magnitude_correct_fraction_20_Entacapone

predicted_magnitude_correct_fraction_20_Entacapone_NULL <- sum(significant_species_NULL$Predicted_magnitude_correct) / nrow(significant_species_NULL)
predicted_magnitude_correct_fraction_20_Entacapone_NULL

top_species_missing_20_Entacapone <- setdiff(top6_real_20_Entacapone_means, top6_predicted_20_Entacapone_means)
top_species_wrong_20_Entacapone <- setdiff(top6_predicted_20_Entacapone_means, top6_real_20_Entacapone_means)

top_species_missing_20_Entacapone <- if(length(top_species_missing_20_Entacapone) == 0) "None" else top_species_missing_20_Entacapone
top_species_wrong_20_Entacapone <- if(length(top_species_wrong_20_Entacapone) == 0) "None" else top_species_wrong_20_Entacapone


Prediction_quality_20_Entacapone <- data.frame(
  Top_six_correct = paste(top_six_correct_20_Entacapone, sep=""),
  Top_six_correct_NULL = paste(top_six_correct_20_Entacapone_NULL, sep=""),
  Top_six_correct_means = paste(top_six_correct_20_Entacapone_means, sep=""),
  Top_six_correct_means_NULL = paste(top_six_correct_20_Entacapone_means_NULL, sep=""),
  Predicted_magnitude_correct = paste(round(predicted_magnitude_correct_fraction_20_Entacapone * 100, 2), "%", sep=""),
  Predicted_magnitude_correct_NULL = paste(round(predicted_magnitude_correct_fraction_20_Entacapone_NULL * 100, 2), "%", sep=""),
  survivors_total = survivors_20_Entacapone,
  top_species_missing <- top_species_missing_20_Entacapone,
  top_species_wrong <- top_species_wrong_20_Entacapone, 
  predicted_mean_final_OD <- predicted_mean_final_od_20_Entacapone,
  real_mean_final_OD <- real_mean_final_od_20_Entacapone,
  sims_total = length(successful_sim_ids)
)

Prediction_quality_20_Entacapone






##Next, for 80 uM:
# Get top 6 species from plot_data_80_endpoint
# Adjust the plot_data_80_endpoint with confidence bounds
plot_data_80_Entacapone_endpoint <- plot_data_80_Entacapone_endpoint %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)

# Adjust the Entacapone_16S_80uM_summarised with confidence bounds
Entacapone_16S_80uM_summarised <- Entacapone_16S_80uM_summarised %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)

#NULL model:
Null_model_summarised <- Niclosamide_16S_0uM_summarised %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)


# Get top 6 species based on the lower bound from plot_data_80_endpoint
top6_predicted_80_Entacapone <- plot_data_80_Entacapone_endpoint %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

# Get top 6 species based on the lower bound from Entacapone_16S_80uM_summarised
top6_real_80_Entacapone <- Entacapone_16S_80uM_summarised %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

top6_NULL <- Null_model_summarised %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

# Calculate the overlap of top 6 species
top_six_correct_80_Entacapone <- length(intersect(top6_predicted_80_Entacapone, top6_real_80_Entacapone))
#top_six_correct_80_Entacapone

top_six_correct_80_Entacapone_NULL <- length(intersect(top6_NULL, top6_real_80_Entacapone))
#top_six_correct_80_Entacapone_NULL

#top6_predicted_80_Entacapone
#top6_real_80_Entacapone




#Now by means:
top6_predicted_80_Entacapone_means <- plot_data_80_Entacapone_endpoint %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)

# Get top 6 species based on the lower bound from Entacapone_16S_80uM_summarised
top6_real_80_Entacapone_means <- Entacapone_16S_80uM_summarised %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)

top6_NULL_means <- Null_model_summarised %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)



top_six_correct_80_Entacapone_means <- length(intersect(top6_predicted_80_Entacapone_means, top6_real_80_Entacapone_means))
#top_six_correct_80_Entacapone_means

top_six_correct_80_Entacapone_means_NULL <- length(intersect(top6_NULL_means, top6_real_80_Entacapone_means))
#top_six_correct_80_Entacapone_means_NULL

#top6_predicted_80_Entacapone_means
#top6_real_80_Entacapone_means




# Merge dataframes by Species
merged_data_80_Entacapone <- merge(plot_data_80_Entacapone_endpoint, Entacapone_16S_80uM_summarised, by = "Species", suffixes = c(".pred", ".real"))
merged_data_80_Entacapone_NULL <- merge(Niclosamide_16S_0uM_summarised, Entacapone_16S_80uM_summarised, by = "Species", suffixes = c(".null", ".real"))



# Create lower and upper bounds considering mean ¬± sd
merged_data_80_Entacapone$lower_bound_pred <- merged_data_80_Entacapone$mean_rel_ab.pred - merged_data_80_Entacapone$sd_rel_ab.pred
merged_data_80_Entacapone$upper_bound_pred <- merged_data_80_Entacapone$mean_rel_ab.pred + merged_data_80_Entacapone$sd_rel_ab.pred
merged_data_80_Entacapone$lower_bound_real <- merged_data_80_Entacapone$mean_rel_ab.real - merged_data_80_Entacapone$sd_rel_ab.real
merged_data_80_Entacapone$upper_bound_real <- merged_data_80_Entacapone$mean_rel_ab.real + merged_data_80_Entacapone$sd_rel_ab.real

# Ensure lower and upper bounds are non-negative, adjusting as necessary
merged_data_80_Entacapone$lower_bound_pred[merged_data_80_Entacapone$lower_bound_pred <= 0] <- 1e-10
merged_data_80_Entacapone$lower_bound_real[merged_data_80_Entacapone$lower_bound_real <= 0] <- 1e-10
merged_data_80_Entacapone$upper_bound_pred[merged_data_80_Entacapone$upper_bound_pred <= 0] <- 1e-10
merged_data_80_Entacapone$upper_bound_real[merged_data_80_Entacapone$upper_bound_real <= 0] <- 1e-10

##and for NULL model:
# Create lower and upper bounds considering mean ¬± sd
merged_data_80_Entacapone_NULL$lower_bound_null <- merged_data_80_Entacapone_NULL$mean_rel_ab.null - merged_data_80_Entacapone_NULL$sd_rel_ab.null
merged_data_80_Entacapone_NULL$upper_bound_null <- merged_data_80_Entacapone_NULL$mean_rel_ab.null + merged_data_80_Entacapone_NULL$sd_rel_ab.null
merged_data_80_Entacapone_NULL$lower_bound_real <- merged_data_80_Entacapone_NULL$mean_rel_ab.real - merged_data_80_Entacapone_NULL$sd_rel_ab.real
merged_data_80_Entacapone_NULL$upper_bound_real <- merged_data_80_Entacapone_NULL$mean_rel_ab.real + merged_data_80_Entacapone_NULL$sd_rel_ab.real

# Ensure lower and upper bounds are non-negative, adjusting as necessary
merged_data_80_Entacapone_NULL$lower_bound_null[merged_data_80_Entacapone_NULL$lower_bound_null <= 0] <- 1e-10
merged_data_80_Entacapone_NULL$lower_bound_real[merged_data_80_Entacapone_NULL$lower_bound_real <= 0] <- 1e-10
merged_data_80_Entacapone_NULL$upper_bound_null[merged_data_80_Entacapone_NULL$upper_bound_null <= 0] <- 1e-10
merged_data_80_Entacapone_NULL$upper_bound_real[merged_data_80_Entacapone_NULL$upper_bound_real <= 0] <- 1e-10

# Filter to include only species with a mean relative abundance > 0.01 in the 'real' dataset
significant_species <- merged_data_80_Entacapone[merged_data_80_Entacapone$mean_rel_ab.real > 0.01, ]
survivors_80_Entacapone <- nrow(significant_species)
survivors_80_Entacapone

#should be the same as survivors defined above, since it is calculated from .real
significant_species_NULL <- merged_data_80_Entacapone_NULL[merged_data_80_Entacapone_NULL$mean_rel_ab.real > 0.01, ]
survivors_80_Entacapone_NULL <- nrow(significant_species_NULL)
survivors_80_Entacapone_NULL

# Adjusted order of magnitude check to include SD, only for significant species
significant_species$Predicted_magnitude_correct <- ifelse(
  (floor(log10(significant_species$lower_bound_pred)) <= floor(log10(significant_species$upper_bound_real)) &
     floor(log10(significant_species$upper_bound_pred)) >= floor(log10(significant_species$lower_bound_real))),
  1,
  0
)

#and for the Null model:
significant_species_NULL$Predicted_magnitude_correct <- ifelse(
  (floor(log10(significant_species_NULL$lower_bound_null)) <= floor(log10(significant_species_NULL$upper_bound_real)) &
     floor(log10(significant_species_NULL$upper_bound_null)) >= floor(log10(significant_species_NULL$lower_bound_real))),
  1,
  0
)

# Calculate the fraction of correctly predicted magnitudes for significant species
predicted_magnitude_correct_fraction_80_Entacapone <- sum(significant_species$Predicted_magnitude_correct) / nrow(significant_species)
predicted_magnitude_correct_fraction_80_Entacapone

predicted_magnitude_correct_fraction_80_Entacapone_NULL <- sum(significant_species_NULL$Predicted_magnitude_correct) / nrow(significant_species_NULL)
predicted_magnitude_correct_fraction_80_Entacapone_NULL


top_species_missing_80_Entacapone <- setdiff(top6_real_80_Entacapone_means, top6_predicted_80_Entacapone_means)
top_species_wrong_80_Entacapone <- setdiff(top6_predicted_80_Entacapone_means, top6_real_80_Entacapone_means)

top_species_missing_80_Entacapone <- if(length(top_species_missing_80_Entacapone) == 0) "None" else top_species_missing_80_Entacapone
top_species_wrong_80_Entacapone <- if(length(top_species_wrong_80_Entacapone) == 0) "None" else top_species_wrong_80_Entacapone


Prediction_quality_80_Entacapone <- data.frame(
  Top_six_correct = paste(top_six_correct_80_Entacapone, sep=""),
  Top_six_correct_NULL = paste(top_six_correct_80_Entacapone_NULL, sep=""),
  Top_six_correct_means = paste(top_six_correct_80_Entacapone_means, sep=""),
  Top_six_correct_means_NULL = paste(top_six_correct_80_Entacapone_means_NULL, sep=""),
  Predicted_magnitude_correct = paste(round(predicted_magnitude_correct_fraction_80_Entacapone * 100, 2), "%", sep=""),
  Predicted_magnitude_correct_NULL = paste(round(predicted_magnitude_correct_fraction_80_Entacapone_NULL * 100, 2), "%", sep=""),
  survivors_total = survivors_80_Entacapone,
  top_species_missing <- top_species_missing_80_Entacapone,
  top_species_wrong <- top_species_wrong_80_Entacapone, 
  predicted_mean_final_OD <- predicted_mean_final_od_80_Entacapone,
  real_mean_final_OD <- real_mean_final_od_80_Entacapone,
  sims_total = length(successful_sim_ids)
)

Prediction_quality_80_Entacapone












##Felodipine

combined_monoculture_aucs2_Felodipine <- subset(combined_monoculture_aucs2, drug == "Felodipine")


#drug sensitivity terms: define once outside of ODEs
y_function_B_vulgatus_Felodipine <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("B_vulgatus", "Felodipine", best_fitting_models_df_Felodipine)), collapse = " ")))
y_function_B_uniformis_Felodipine <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("B_uniformis", "Felodipine", best_fitting_models_df_Felodipine)), collapse = " ")))
y_function_B_fragilis_Felodipine <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("B_fragilis", "Felodipine", best_fitting_models_df_Felodipine)), collapse = " ")))
y_function_B_thetaiotaomicron_Felodipine <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("B_thetaiotaomicron", "Felodipine", best_fitting_models_df_Felodipine)), collapse = " ")))
y_function_C_ramosum_Felodipine <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("C_ramosum", "Felodipine", best_fitting_models_df_Felodipine)), collapse = " ")))
y_function_E_rectale_Felodipine <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("E_rectale", "Felodipine", best_fitting_models_df_Felodipine)), collapse = " ")))
y_function_R_intestinalis_Felodipine <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("R_intestinalis", "Felodipine", best_fitting_models_df_Felodipine)), collapse = " ")))
y_function_V_parvula_Felodipine <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("V_parvula", "Felodipine", best_fitting_models_df_Felodipine)), collapse = " ")))
y_function_E_lenta_Felodipine <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("E_lenta", "Felodipine", best_fitting_models_df_Felodipine)), collapse = " ")))
y_function_F_nucleatum_Felodipine <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("F_nucleatum", "Felodipine", best_fitting_models_df_Felodipine)), collapse = " ")))
y_function_C_bolteae_Felodipine <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("C_bolteae", "Felodipine", best_fitting_models_df_Felodipine)), collapse = " ")))
y_function_C_perfringens_Felodipine <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("C_perfringens", "Felodipine", best_fitting_models_df_Felodipine)), collapse = " ")))
y_function_C_saccharolyticum_Felodipine <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("C_saccharolyticum", "Felodipine", best_fitting_models_df_Felodipine)), collapse = " ")))
y_function_S_salivarius_Felodipine <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("S_salivarius", "Felodipine", best_fitting_models_df_Felodipine)), collapse = " ")))
y_function_R_gnavus_Felodipine <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("R_gnavus", "Felodipine", best_fitting_models_df_Felodipine)), collapse = " ")))
y_function_C_comes_Felodipine <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("C_comes", "Felodipine", best_fitting_models_df_Felodipine)), collapse = " ")))
y_function_P_merdae_Felodipine <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("P_merdae", "Felodipine", best_fitting_models_df_Felodipine)), collapse = " ")))
y_function_S_parasanguinis_Felodipine <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("S_parasanguinis", "Felodipine", best_fitting_models_df_Felodipine)), collapse = " ")))
y_function_C_aerofaciens_Felodipine <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("C_aerofaciens", "Felodipine", best_fitting_models_df_Felodipine)), collapse = " ")))
y_function_D_formicigenerans_Felodipine <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("D_formicigenerans", "Felodipine", best_fitting_models_df_Felodipine)), collapse = " ")))
y_function_E_coli_Felodipine <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("E_coli", "Felodipine", best_fitting_models_df_Felodipine)), collapse = " ")))



y_function_B_vulgatus_Felodipine_func <- eval(parse(text = paste("function(Drug) {", y_function_B_vulgatus_Felodipine, "}")))
y_function_B_uniformis_Felodipine_func <- eval(parse(text = paste("function(Drug) {", y_function_B_uniformis_Felodipine, "}")))
y_function_B_fragilis_Felodipine_func <- eval(parse(text = paste("function(Drug) {", y_function_B_fragilis_Felodipine, "}")))
y_function_B_thetaiotaomicron_Felodipine_func <- eval(parse(text = paste("function(Drug) {", y_function_B_thetaiotaomicron_Felodipine, "}")))
y_function_C_ramosum_Felodipine_func <- eval(parse(text = paste("function(Drug) {", y_function_C_ramosum_Felodipine, "}")))
y_function_E_rectale_Felodipine_func <- eval(parse(text = paste("function(Drug) {", y_function_E_rectale_Felodipine, "}")))
y_function_R_intestinalis_Felodipine_func <- eval(parse(text = paste("function(Drug) {", y_function_R_intestinalis_Felodipine, "}")))
y_function_E_lenta_Felodipine_func <- eval(parse(text = paste("function(Drug) {", y_function_E_lenta_Felodipine, "}")))
y_function_F_nucleatum_Felodipine_func <- eval(parse(text = paste("function(Drug) {", y_function_F_nucleatum_Felodipine, "}")))
y_function_C_bolteae_Felodipine_func <- eval(parse(text = paste("function(Drug) {", y_function_C_bolteae_Felodipine, "}")))
y_function_C_perfringens_Felodipine_func <- eval(parse(text = paste("function(Drug) {", y_function_C_perfringens_Felodipine, "}")))
y_function_C_saccharolyticum_Felodipine_func <- eval(parse(text = paste("function(Drug) {", y_function_C_saccharolyticum_Felodipine, "}")))
y_function_S_salivarius_Felodipine_func <- eval(parse(text = paste("function(Drug) {", y_function_S_salivarius_Felodipine, "}")))
y_function_R_gnavus_Felodipine_func <- eval(parse(text = paste("function(Drug) {", y_function_R_gnavus_Felodipine, "}")))
y_function_C_comes_Felodipine_func <- eval(parse(text = paste("function(Drug) {", y_function_C_comes_Felodipine, "}")))
y_function_P_merdae_Felodipine_func <- eval(parse(text = paste("function(Drug) {", y_function_P_merdae_Felodipine, "}")))
y_function_S_parasanguinis_Felodipine_func <- eval(parse(text = paste("function(Drug) {", y_function_S_parasanguinis_Felodipine, "}")))
y_function_C_aerofaciens_Felodipine_func <- eval(parse(text = paste("function(Drug) {", y_function_C_aerofaciens_Felodipine, "}")))
y_function_D_formicigenerans_Felodipine_func <- eval(parse(text = paste("function(Drug) {", y_function_D_formicigenerans_Felodipine, "}")))
y_function_E_coli_Felodipine_func <- eval(parse(text = paste("function(Drug) {", y_function_E_coli_Felodipine, "}")))
y_function_V_parvula_Felodipine_func <- eval(parse(text = paste("function(Drug) {", y_function_V_parvula_Felodipine, "}")))



unique(combined_monoculture_aucs2_Felodipine$conc)
##dictate drug concentration tested for simulation cycle here:
#drug_concentration_tested <- 5 #if manually or:
drug_concentration_tested <- unique(combined_monoculture_aucs2_Felodipine$conc)[1] 
initial_conditions <- rep(0.01/32, 32)
initial_conditions <- c(initial_conditions, drug_concentration_tested)


##drug effect fitted for species showing sensitivity in monoculture:
#unique(combined_monoculture_aucs2_Felodipine$Species)

##for more simple linear fits
closed.sir.model_Felodipine <- function (t, x, params) {
  ## first extract the state variables
  A_muciniphila <- x[1]
  B_adolescentis <- x[2]
  B_fragilis <- x[3]
  B_longum <- x[4]
  B_obeum <- x[5]
  B_thetaiotaomicron <- x[6]
  B_uniformis <- x[7]
  B_vulgatus <- x[8]
  B_wadsworthia <- x[9]
  C_aerofaciens <- x[10]
  C_bolteae <- x[11]
  C_comes <- x[12]
  C_perfringens <- x[13]
  C_ramosum <- x[14]
  C_saccharolyticum <- x[15]
  D_formicigenerans <- x[16]
  E_coli <- x[17]
  E_lenta <- x[18]
  E_rectale <- x[19]
  F_nucleatum <- x[20]
  L_paracasei <- x[21]
  O_splanchnicus <- x[22]
  P_copri <- x[23]
  P_distasonis <- x[24]
  P_merdae <- x[25]
  R_bromii <- x[26]
  R_gnavus <- x[27]
  R_intestinalis <- x[28]
  R_torques <- x[29]
  S_parasanguinis <- x[30]
  S_salivarius <- x[31]
  V_parvula <- x[32]
  Drug <- x[33]
  
  
  ## now extract the parameters
  r_B_fragilis <- flat_params[["B._fragilis.r"]]
  K_B_fragilis <- flat_params[["B._fragilis.K"]]
  r_B_longum <- flat_params[["B._longum.r"]]
  K_B_longum <- flat_params[["B._longum.K"]]
  r_B_thetaiotaomicron <- flat_params[["B._thetaiotaomicron.r"]]
  K_B_thetaiotaomicron <- flat_params[["B._thetaiotaomicron.K"]]
  r_B_uniformis <- flat_params[["B._uniformis.r"]]
  K_B_uniformis <- flat_params[["B._uniformis.K"]]
  r_B_vulgatus <- flat_params[["B._vulgatus.r"]]
  K_B_vulgatus <- flat_params[["B._vulgatus.K"]]
  r_B_wadsworthia <- flat_params[["B._wadsworthia.r"]]
  K_B_wadsworthia <- flat_params[["B._wadsworthia.K"]]
  r_C_aerofaciens <- flat_params[["C._aerofaciens.r"]]
  K_C_aerofaciens <- flat_params[["C._aerofaciens.K"]]
  r_C_bolteae <- flat_params[["C._bolteae.r"]]
  K_C_bolteae <- flat_params[["C._bolteae.K"]]
  r_C_comes <- flat_params[["C._comes.r"]]
  K_C_comes <- flat_params[["C._comes.K"]]
  r_C_perfringens <- flat_params[["C._perfringens.r"]]
  K_C_perfringens <- flat_params[["C._perfringens.K"]]
  r_C_ramosum <- flat_params[["C._ramosum.r"]]
  K_C_ramosum <- flat_params[["C._ramosum.K"]]
  r_C_saccharolyticum <- flat_params[["C._saccharolyticum.r"]]
  K_C_saccharolyticum <- flat_params[["C._saccharolyticum.K"]]
  r_D_formicigenerans <- flat_params[["D._formicigenerans.r"]]
  K_D_formicigenerans <- flat_params[["D._formicigenerans.K"]]
  r_E_coli <- flat_params[["E._coli.r"]]
  K_E_coli <- flat_params[["E._coli.K"]]
  r_E_lenta <- flat_params[["E._lenta.r"]]
  K_E_lenta <- flat_params[["E._lenta.K"]]
  r_E_rectale <- flat_params[["E._rectale.r"]]
  K_E_rectale <- flat_params[["E._rectale.K"]]
  r_F_nucleatum <- flat_params[["F._nucleatum.r"]]
  K_F_nucleatum <- flat_params[["F._nucleatum.K"]]
  r_P_copri <- flat_params[["P._copri.r"]]
  K_P_copri <- flat_params[["P._copri.K"]]
  r_P_merdae <- flat_params[["P._merdae.r"]]
  K_P_merdae <- flat_params[["P._merdae.K"]]
  r_R_gnavus <- flat_params[["R._gnavus.r"]]
  K_R_gnavus <- flat_params[["R._gnavus.K"]]
  r_R_intestinalis <- flat_params[["R._intestinalis.r"]]
  K_R_intestinalis <- flat_params[["R._intestinalis.K"]]
  r_V_parvula <- flat_params[["V._parvula.r"]]
  K_V_parvula <- flat_params[["V._parvula.K"]]
  r_A_muciniphila <- flat_params[["A._muciniphila.r"]]
  K_A_muciniphila <- flat_params[["A._muciniphila.K"]]
  r_B_adolescentis <- flat_params[["B._adolescentis.r"]]
  K_B_adolescentis <- flat_params[["B._adolescentis.K"]]
  r_B_obeum <- flat_params[["B._obeum.r"]]
  K_B_obeum <- flat_params[["B._obeum.K"]]
  r_O_splanchnicus <- flat_params[["O._splanchnicus.r"]]
  K_O_splanchnicus <- flat_params[["O._splanchnicus.K"]]
  r_P_distasonis <- flat_params[["P._distasonis.r"]]
  K_P_distasonis <- flat_params[["P._distasonis.K"]]
  r_R_bromii <- flat_params[["R._bromii.r"]]
  K_R_bromii <- flat_params[["R._bromii.K"]]
  r_R_torques <- flat_params[["R._torques.r"]]
  K_R_torques <- flat_params[["R._torques.K"]]
  r_S_parasanguinis <- flat_params[["S._parasanguinis.r"]]
  K_S_parasanguinis <-flat_params[["S._parasanguinis.K"]]
  r_S_salivarius <- flat_params[["S._salivarius.r"]]
  K_S_salivarius <- flat_params[["S._salivarius.K"]]
  r_L_paracasei <- flat_params[["L._paracasei.r"]]
  K_L_paracasei <- flat_params[["L._paracasei.K"]]
  
  
  t_mod <- ifelse(t > 24.1, t - 24.1, t)
  
  
  ## now code the model equations
  dA_muciniphila_dt <- r_A_muciniphila * A_muciniphila * (1 - A_muciniphila / K_A_muciniphila)
  dB_adolescentis_dt <- r_B_adolescentis * B_adolescentis * (1 - B_adolescentis / K_B_adolescentis)
  dB_fragilis_dt <- r_B_fragilis * B_fragilis * (1 - B_fragilis / max(0.0001, K_B_fragilis * (y_function_B_fragilis_Felodipine_func(Drug))))
  dB_longum_dt <- r_B_longum * B_longum * (1 - B_longum / K_B_longum)
  dB_obeum_dt <- r_B_obeum * B_obeum * (1 - B_obeum / K_B_obeum)
  dB_thetaiotaomicron_dt <- r_B_thetaiotaomicron * B_thetaiotaomicron * (1 - B_thetaiotaomicron / max(0.0001, K_B_thetaiotaomicron * (y_function_B_thetaiotaomicron_Felodipine_func(Drug))))  
  dB_uniformis_dt <- r_B_uniformis * B_uniformis * (1 - B_uniformis / max(0.0001, K_B_uniformis * (y_function_B_uniformis_Felodipine_func(Drug))))
  dB_vulgatus_dt <- r_B_vulgatus * B_vulgatus * (1 - B_vulgatus / max(0.0001, K_B_vulgatus * (y_function_B_vulgatus_Felodipine_func(Drug))))
  dB_wadsworthia_dt <- r_B_wadsworthia * B_wadsworthia * (1 - B_wadsworthia / K_B_wadsworthia)
  dC_aerofaciens_dt <- r_C_aerofaciens * C_aerofaciens * (1 - C_aerofaciens / max(0.0001, K_C_aerofaciens * (y_function_C_aerofaciens_Felodipine_func(Drug))))
  dC_bolteae_dt <- r_C_bolteae * C_bolteae * (1 - C_bolteae /  max(0.0001, K_C_bolteae * (y_function_C_bolteae_Felodipine_func(Drug))))
  dC_comes_dt <- r_C_comes * C_comes * (1 - C_comes / max(0.0001, K_C_comes * (y_function_C_comes_Felodipine_func(Drug))))
  dC_perfringens_dt <- r_C_perfringens * C_perfringens * (1 - C_perfringens / max(0.0001, K_C_perfringens * (y_function_C_perfringens_Felodipine_func(Drug))))
  dC_ramosum_dt <- r_C_ramosum * C_ramosum * (1 - C_ramosum / max(0.0001, K_C_ramosum * (y_function_C_ramosum_Felodipine_func(Drug))))
  dC_saccharolyticum_dt <- r_C_saccharolyticum * C_saccharolyticum * (1 - C_saccharolyticum / max(0.0001, K_C_saccharolyticum * (y_function_C_saccharolyticum_Felodipine_func(Drug))))
  dD_formicigenerans_dt <- r_D_formicigenerans * D_formicigenerans * (1 - D_formicigenerans / max(0.0001, K_D_formicigenerans * (y_function_D_formicigenerans_Felodipine_func(Drug))))
  dE_coli_dt <- r_E_coli * E_coli * (1 - E_coli / max(0.0001, K_E_coli * (y_function_E_coli_Felodipine_func(Drug))))
  dE_lenta_dt <- r_E_lenta * E_lenta * (1 - E_lenta / max(0.0001, K_E_lenta * (y_function_E_lenta_Felodipine_func(Drug))))
  dE_rectale_dt <- r_E_rectale * E_rectale * (1 - E_rectale / max(0.0001, K_E_rectale * (y_function_E_rectale_Felodipine_func(Drug))))
  dF_nucleatum_dt <- r_F_nucleatum * F_nucleatum * (1 - F_nucleatum / max(0.0001, K_F_nucleatum * (y_function_F_nucleatum_Felodipine_func(Drug))))
  dL_paracasei_dt <- r_L_paracasei * L_paracasei * (1 - L_paracasei / K_L_paracasei)  
  dO_splanchnicus_dt <- r_O_splanchnicus * O_splanchnicus * (1 - O_splanchnicus / K_O_splanchnicus)  
  dP_copri_dt <- r_P_copri * P_copri * (1 - P_copri / K_P_copri)
  dP_distasonis_dt <- r_P_distasonis * P_distasonis * (1 - P_distasonis / K_P_distasonis)  
  dP_merdae_dt <- r_P_merdae * P_merdae * (1 - P_merdae / max(0.0001, K_P_merdae * (y_function_P_merdae_Felodipine_func(Drug))))
  dR_bromii_dt <- r_R_bromii * R_bromii * (1 - R_bromii / K_R_bromii) 
  dR_gnavus_dt <- r_R_gnavus * R_gnavus * (1 - R_gnavus / max(0.0001, K_R_gnavus * (y_function_R_gnavus_Felodipine_func(Drug))))
  dR_intestinalis_dt <- r_R_intestinalis * R_intestinalis * (1 - R_intestinalis / max(0.0001, K_R_intestinalis * (y_function_R_intestinalis_Felodipine_func(Drug))))
  dR_torques_dt <- r_R_torques * R_torques * (1 - R_torques /K_R_torques) 
  dS_parasanguinis_dt <- r_S_parasanguinis * S_parasanguinis * (1 - S_parasanguinis / max(0.0001, K_S_parasanguinis * (y_function_S_parasanguinis_Felodipine_func(Drug))))
  dS_salivarius_dt <- r_S_salivarius * S_salivarius * (1 - S_salivarius / max(0.0001, K_S_salivarius * (y_function_S_salivarius_Felodipine_func(Drug))))
  dV_parvula_dt <- r_V_parvula * V_parvula * (1 - V_parvula / max(0.0001, K_V_parvula * (y_function_V_parvula_Felodipine_func(Drug))))
  
  
  
  #Drug differential:
  dDrug_dt <- (subset(drug_dynamics, Drug == "Felodipine")$Steepness_param_community * exp(-subset(drug_dynamics, Drug == "Felodipine")$Steepness_param_community * t_mod)) * (drug_concentration_tested * prop_left_Felodipine - drug_concentration_tested)
  #dDrug_dt <- 0
  
  ## Combine results into a single vector
  dxdt <- c(dA_muciniphila_dt, dB_adolescentis_dt, dB_fragilis_dt, dB_longum_dt, dB_obeum_dt, dB_thetaiotaomicron_dt, dB_uniformis_dt, dB_vulgatus_dt, dB_wadsworthia_dt, dC_aerofaciens_dt, dC_bolteae_dt, dC_comes_dt, dC_perfringens_dt, dC_ramosum_dt, dC_saccharolyticum_dt, dD_formicigenerans_dt, dE_coli_dt, dE_lenta_dt, dE_rectale_dt, dF_nucleatum_dt, dL_paracasei_dt, dO_splanchnicus_dt, dP_copri_dt, dP_distasonis_dt, dP_merdae_dt, dR_bromii_dt, dR_gnavus_dt, dR_intestinalis_dt, dR_torques_dt, dS_parasanguinis_dt, dS_salivarius_dt, dV_parvula_dt, dDrug_dt)
  
  ## Return result as a list
  list(dxdt)
}




#calculate the co-culture correction factor per species based on community composition in absence of drug, just like done for Niclosamide

growth_data_all_0_Niclosamide
growth_data_all_0_Niclosamide1 <- growth_data_all_0_Niclosamide %>%
  dplyr::mutate(Species = gsub(" ", "_", Species))


# Merge rel_ab_control with growth_data_all_0_Niclosamide on Species
# Function to remove duplicated columns by name pattern
clean_columns_base <- function(df, pattern) {
  cols_to_keep <- !grepl(pattern, names(df))
  df <- df[, cols_to_keep]
  return(df)
}

# Use the new function to clean up your dataframe
rel_ab_control <- clean_columns_base(rel_ab_control, "mean_max_OD.[xy]")
str(rel_ab_control)


#rel_ab_control$correction_factor <- rel_ab_control$mean_rel_ab / (rel_ab_control$mean_max_OD/sum(rel_ab_control$mean_max_OD))
# Calculate correction factor with a minimum value of ~1
rel_ab_control$correction_factor <- pmax(rel_ab_control$mean_rel_ab / (rel_ab_control$mean_max_OD / sum(rel_ab_control$mean_max_OD)), 1.1)


# Create a new dataframe for co-culture correction
co_culture_correction <- data.frame(
  species = rel_ab_control$Species,
  correction_factor = rel_ab_control$correction_factor
)


#summarise community data
#Adjust based on tested concentrations for each drug
unique(Community_compositions_focus_drugs_Felodipine$concentration)

Community_compositions_focus_drugs_Felodipine_5uM <- subset(Community_compositions_focus_drugs_Felodipine, concentration == 5)
Community_compositions_focus_drugs_Felodipine_20uM <- subset(Community_compositions_focus_drugs_Felodipine, concentration == 20)
Community_compositions_focus_drugs_Felodipine_80uM <- subset(Community_compositions_focus_drugs_Felodipine, concentration == 80)


#5 uM
Community_compositions_focus_drugs_Felodipine_5uM_summarised <- Community_compositions_focus_drugs_Felodipine_5uM %>%
  dplyr::group_by(species) %>%                                  
  dplyr::summarize(
    mean_rel_ab = mean(rel_abundance, na.rm = TRUE),     
    sd_rel_ab = sd(rel_abundance, na.rm = TRUE) ,
    mean_max_OD = mean(maxOD, na.rm = TRUE),
    sd_max_OD = sd(maxOD, na.rm = TRUE),
    mean_final_OD = mean(finalOD, na.rm = TRUE),
    sd_final_OD = sd(finalOD, na.rm = TRUE)
  ) %>%
  dplyr::ungroup() 


Community_compositions_focus_drugs_Felodipine_5uM_summarised <- Community_compositions_focus_drugs_Felodipine_5uM_summarised %>%
  dplyr::mutate(Species = sub("^(\\w)\\w*\\s(.*)", "\\1._\\2", species))

#remove (sub)strain info
Community_compositions_focus_drugs_Felodipine_5uM_summarised <- Community_compositions_focus_drugs_Felodipine_5uM_summarised %>%
  dplyr::mutate(Species = sub("^(\\w\\._\\w+).*", "\\1", Species))


#20 uM
Community_compositions_focus_drugs_Felodipine_20uM_summarised <- Community_compositions_focus_drugs_Felodipine_20uM %>%
  dplyr::group_by(species) %>%                                  
  dplyr::summarize(
    mean_rel_ab = mean(rel_abundance, na.rm = TRUE),     
    sd_rel_ab = sd(rel_abundance, na.rm = TRUE) ,
    mean_max_OD = mean(maxOD, na.rm = TRUE),
    sd_max_OD = sd(maxOD, na.rm = TRUE),
    mean_final_OD = mean(finalOD, na.rm = TRUE),
    sd_final_OD = sd(finalOD, na.rm = TRUE)
  ) %>%
  dplyr::ungroup() 


Community_compositions_focus_drugs_Felodipine_20uM_summarised <- Community_compositions_focus_drugs_Felodipine_20uM_summarised %>%
  dplyr::mutate(Species = sub("^(\\w)\\w*\\s(.*)", "\\1._\\2", species))

#remove (sub)strain info
Community_compositions_focus_drugs_Felodipine_20uM_summarised <- Community_compositions_focus_drugs_Felodipine_20uM_summarised %>%
  dplyr::mutate(Species = sub("^(\\w\\._\\w+).*", "\\1", Species))


#80 uM
Community_compositions_focus_drugs_Felodipine_80uM_summarised <- Community_compositions_focus_drugs_Felodipine_80uM %>%
  dplyr::group_by(species) %>%                                  
  dplyr::summarize(
    mean_rel_ab = mean(rel_abundance, na.rm = TRUE),     
    sd_rel_ab = sd(rel_abundance, na.rm = TRUE) ,
    mean_max_OD = mean(maxOD, na.rm = TRUE),
    sd_max_OD = sd(maxOD, na.rm = TRUE),    
    mean_final_OD = mean(finalOD, na.rm = TRUE),
    sd_final_OD = sd(finalOD, na.rm = TRUE)
  ) %>%
  dplyr::ungroup() 



Community_compositions_focus_drugs_Felodipine_80uM_summarised <- Community_compositions_focus_drugs_Felodipine_80uM_summarised %>%
  dplyr::mutate(Species = sub("^(\\w)\\w*\\s(.*)", "\\1._\\2", species))

#remove (sub)strain info
Community_compositions_focus_drugs_Felodipine_80uM_summarised <- Community_compositions_focus_drugs_Felodipine_80uM_summarised %>%
  dplyr::mutate(Species = sub("^(\\w\\._\\w+).*", "\\1", Species))


#Initialise data frames
sim_output <- data.frame()
input_params_list <- list() #Use a list to collect parameters for each simulation

#number of simulations
num_sims <- 250


for (i in 1:num_sims) {
  tryCatch({
    # generate model parameters
    set.seed(i) #set a different seed for each simulation for variation
    params <- lapply(1:nrow(growth_data_all_0_Niclosamide), function(idx) {
      species_params <- growth_data_all_0_Niclosamide[idx, ]
      list(
        r = rnorm(1, mean = species_params$mean_max_Growth_rate, sd = species_params$sd_max_Growth_rate),
        K = rnorm(1, mean = species_params$mean_max_OD, sd = species_params$sd_max_OD)
      )
    })
    names(params) <- gsub(" ", "_", growth_data_all_0_Niclosamide$Species)
    flat_params <- unlist(params)
    names(flat_params) <- gsub("\\.\\d$", "", names(flat_params))
    
    #replace spaces with underscores to match formatting
    co_culture_correction$species <- gsub(" ", "_", co_culture_correction$species, fixed = TRUE)
    
    #replace the species-specific K parameters extracted from monoculture growth data 
    #with drawn relative abundance values at Niclosamide = 0, scaled to K
    rel_ab_control$Species <- gsub(" ", "_", rel_ab_control$Species)
    
    #Initialise an empty vector to store drawn values
    drawn_values <- numeric(nrow(rel_ab_control))
    
    #draw values from their respective distributions
    for (k in 1:nrow(rel_ab_control)) {
      species_name <- rel_ab_control$Species[k]
      drawn_value <- rnorm(1, mean = rel_ab_control$mean_rel_ab[k], sd = rel_ab_control$sd_rel_ab[k])
      drawn_values[k] <- max(drawn_value, 0)  # Ensure no negative values
    }
    
    #Normalise drawn relative abundance values so they sum to 1 (to reflect a 'true' relative abundance distribution)
    #this is needed so when we convert the values into OD units by multiplying with the drawn community maxOD,
    # the sum of K_i parameters and the drawn K are equal
    normalised_values <- drawn_values / sum(drawn_values)
    
    #Pull community maxOD (K) at 0 drugs from respective normal distribution:
    K <- rnorm(n = 1, mean = rel_ab_control$mean_com_max_OD[1], sd = rel_ab_control$sd_com_max_OD[1])
    
    # Assign these normalised values to their respective species' .K parameters
    for (k in 1:nrow(rel_ab_control)) {
      species_name <- rel_ab_control$Species[k]
      k_index <- grep(paste0("^", species_name, "\\.K$"), names(flat_params))
      
      if (length(k_index) > 0) {
        old_value <- flat_params[k_index]
        flat_params[k_index] <- (normalised_values[k] + 0.0001) * K #add small value in case drawn K_i is 0, which would cause issues with the solver
        cat(sprintf("Updated %s from %f to %f using normalised value %f scaled by K %f\n", names(flat_params)[k_index], old_value, flat_params[k_index], normalised_values[k], K))
      }
    }
    
    #Accounting for variation in drug degradation by community, with standard deviation of end concentration (at 10h) around the fitted predicted (relative) end concentration at 24h
    #prop_left_Felodipine <- abs(rnorm(1, (subset(drug_dynamics, Drug == "Felodipine")$Prop_left_24h_community), (subset(drug_dynamics, Drug == "Felodipine")$SD_drug_community))) 
    #below, we account for measurement error rather than ecological drivers that lead to the variability of degradation at the final point measured 
    prop_left_Felodipine <- abs(rnorm(
      n = 1, 
      mean = subset(drug_dynamics, Drug == "Felodipine")$Prop_left_24h_community, 
      sd = ifelse(
        subset(drug_dynamics, Drug == "Felodipine")$SD_drug_community > subset(drug_dynamics, Drug == "Felodipine")$SD_drug_community_start, 
        subset(drug_dynamics, Drug == "Felodipine")$SD_drug_community - subset(drug_dynamics, Drug == "Felodipine")$SD_drug_community_start, 
        subset(drug_dynamics, Drug == "Felodipine")$SD_drug_community
      )
    ))
    
    
    #loop through each species in co_culture_correction
    for (j in 1:nrow(co_culture_correction)) {
      # Extract the species name and correction factor
      species_name <- co_culture_correction$species[j]
      correction_factor <- co_culture_correction$correction_factor[j]
      
      # Identify the corresponding growth rate parameter in flat_params
      #by matching the base species name (without .r)
      growth_rate_indices <- grep(paste0("^", species_name, "\\.r$"), names(flat_params))
      
      #take the growth rate parameter and apply the correction factor 
      for (index in growth_rate_indices) {
        flat_params[index] <- flat_params[index] * correction_factor
      }
    }
    
    flat_params
    # Store parameters for each simulation
    input_params_list[[i]] <- c(sim_ID = i, flat_params)
    
    # Run the model for the first 24-hour cycle
    solution_cycle_1 <- ode(y = initial_conditions, times = seq(from = 0, to = 24, by = 0.1), func = closed.sir.model_Felodipine, parms = flat_params,   method = "lsoda", rtol = 1e-6, atol = 1e-6)
    
    # Dilution and second cycle
    end_of_cycle_1 <- solution_cycle_1[nrow(solution_cycle_1), -1]
    initial_conditions_cycle_2 <- end_of_cycle_1 / 50
    #accounting for the drugs being added with the new growth cycle as well:
    initial_conditions_cycle_2[33] <- initial_conditions_cycle_2[33] + drug_concentration_tested
    solution_cycle_2 <- ode(y = initial_conditions_cycle_2, times = seq(from = 24, to = 48, by = 0.1), func = closed.sir.model_Felodipine, parms = flat_params,  method = "lsoda", rtol = 1e-6, atol = 1e-6)
    
    # Combine and format results
    combined_solution <- rbind(as.data.frame(solution_cycle_1), as.data.frame(solution_cycle_2)[-1,])
    combined_solution$sim_ID <- rep(i, nrow(combined_solution))
    combined_solution <- combined_solution %>%
      tidyr::gather(key = "Species", value = "Density", -time, -sim_ID) %>%
      dplyr::mutate(Hour = time) %>%
      dplyr::select(sim_ID, Hour, Species, Density)
    
    ##Append to sim_output
    sim_output <- rbind(sim_output, combined_solution)
  }, error = function(e) {
    cat(sprintf("Skipping simulation %d due to an error: %s\n", i, e$message))
  })
}



##Combine all parameter data into a single dataframe
input_params <- do.call(rbind, input_params_list)

# Add a "Species" column 
sim_output$Species_name <- species_names[as.numeric(as.character(sim_output$Species))]
sim_output$Species_name <- replace_na(sim_output$Species_name, "Drug")

#View(input_params)
#View(sim_output)

sim_output <- na.omit(sim_output)
successful_sim_ids <- unique(subset(sim_output, Hour == 48)$sim_ID)
length(successful_sim_ids)
sim_output1 <- sim_output[sim_output$sim_ID %in% successful_sim_ids, ]


#Transform sim_output so we have wide format by Species
sim_output_wide <- tidyr::pivot_wider(sim_output1, 
                                      names_from = Species_name, 
                                      values_from = Density,
                                      id_cols = c(sim_ID, Hour))

length(unique(sim_output_wide$sim_ID))
#calc community OD per timepoint
sim_output_wide$Total_OD <- rowSums(sim_output_wide[, 3:34], na.rm = TRUE)
#calculate and add relative abundances here as well:
species_columns <- colnames(sim_output_wide)[3:34] 

for (species in species_columns) {
  sim_output_wide[[paste0("rel_", species)]] <- sim_output_wide[[species]] / sim_output_wide$Total_OD
}


#assign sim_output_wide test conditions to dataframe name
drug_tested <- "Felodipine"
variable_name_1 <- paste0("sim_output_wide_", ifelse(drug_concentration_tested == 1e-04, 0, drug_concentration_tested), "_", drug_tested)
assign(variable_name_1, sim_output_wide)

#turn back into long format if interested in plotting relative abundances
cols_needed <- c("sim_ID", "Hour")

sim_output_long <- sim_output_wide %>% 
  dplyr::select(sim_ID, Hour, Drug, starts_with("rel_")) %>% 
  tidyr::pivot_longer(
    cols = c(Drug, starts_with("rel_")),
    names_to = "Species", 
    values_to = "Relative_abundance",
    names_prefix = "rel_",
    names_transform = list(Species = ~ ifelse(.x == "Drug", "Drug", .x))
  ) 

str(sim_output_long)


species_names_1 <- c(
  "A_muciniphila",
  "B_adolescentis",
  "B_fragilis",
  "B_longum",
  "B_obeum",
  "B_thetaiotaomicron",
  "B_uniformis",
  "B_vulgatus",
  "B_wadsworthia",
  "C_aerofaciens",
  "C_bolteae",
  "C_comes",
  "C_perfringens",
  "C_ramosum",
  "C_saccharolyticum",
  "D_formicigenerans",
  "E_coli",
  "E_lenta",
  "E_rectale",
  "F_nucleatum",
  "L_paracasei",
  "O_splanchnicus",
  "P_copri",
  "P_distasonis",
  "P_merdae",
  "R_bromii",
  "R_gnavus",
  "R_intestinalis",
  "R_torques",
  "S_parasanguinis",
  "S_salivarius",
  "V_parvula",
  "Drug"
)

species_colours_1 <- c(
  "A_muciniphila" = "#1f77b4",
  "B_adolescentis" = "#ff7f0e",
  "B_fragilis" = "#2ca02c",
  "B_longum" = "#d62728",
  "B_obeum" = "#9467bd",
  "B_thetaiotaomicron" = "black",
  "B_uniformis" = "#e377c2",
  "B_vulgatus" = "#7f7f7f",
  "B_wadsworthia" = "gold1",
  "C_aerofaciens" = "#aec7e8",
  "C_bolteae" = "#ffbb78",
  "C_comes" = "magenta",
  "C_perfringens" = "#ff9896",
  "C_ramosum" = "#c5b0d5",
  "C_saccharolyticum" = "#c49c94",
  "D_formicigenerans" = "#f7b6d2",
  "E_coli" = "yellow",
  "E_lenta" = "turquoise",
  "E_rectale" = "#393b79",
  "F_nucleatum" = "royalblue2",
  "L_paracasei" = "blue",
  "O_splanchnicus" = "#637939",
  "P_copri" = "cyan",
  "P_distasonis" = "#8c6d31",
  "P_merdae" = "#c7c7c7",
  "R_bromii" = "#e6550d",
  "R_gnavus" = "#e7cb94",
  "R_intestinalis" = "#843c39",
  "R_torques" = "#d6616b",
  "S_parasanguinis" = "orange3",
  "S_salivarius" = "#7b4173",
  "V_parvula" = "#ce6dbd",
  "Drug" = "green"
)



##Plot output for any specific sim:
# ggplot(subset(sim_output, sim_ID == 1 & Species_name != "Drug"), aes(x = Hour, y = Density, group = Species_name, color = Species_name)) +
#   geom_line(size = 1, alpha = 0.7) +
#   scale_color_manual(values = species_colours_1) +
#   labs(title = paste0("Felodipine = ", drug_concentration_tested),
#        x = "Time (hours)",
#        y = "Population Density (OD)",
#        color = "Species") +
#   theme_minimal() +
#   theme(legend.position = "right")
# 
# ggplot(subset(sim_output, sim_ID == 3 & Species_name != "Drug"), aes(x = Hour, y = Density, group = Species_name, color = Species_name)) +
#   geom_line(size = 1, alpha = 0.7) +
#   scale_color_manual(values = species_colours_1) +
#   labs(title = paste0("Felodipine = ", drug_concentration_tested),
#        x = "Time (hours)",
#        y = "Population Density (OD)",
#        color = "Species") +
#   theme_minimal() +
#   theme(legend.position = "right")


ggplot(subset(sim_output_long, sim_ID == 1), aes(x = Hour, y = Relative_abundance, group = Species, color = Species)) +
  geom_line(size = 1, alpha = 0.7) +
  scale_color_manual(values = species_colours_1) +
  labs(title = paste0("Felodipine = ", drug_concentration_tested),
       x = "Time (hours)",
       y = "Relative abundance",
       color = "Species") +
  theme_minimal() +
  theme(legend.position = "right")


ggplot(subset(sim_output_long, sim_ID == 3), aes(x = Hour, y = Relative_abundance, group = Species, color = Species)) +
  geom_line(size = 1, alpha = 0.7) +
  scale_color_manual(values = species_colours_1) +
  labs(title = paste0("Felodipine = ", drug_concentration_tested),
       x = "Time (hours)",
       y = "Relative abundance",
       color = "Species") +
  theme_minimal() +
  theme(legend.position = "right")


#calc mean and standard deviation across sims
sim_stats <- sim_output_long %>%
  dplyr::group_by(Hour, Species) %>%
  dplyr::summarise(
    mean_rel_ab = mean(Relative_abundance),
    sd_rel_ab = sd(Relative_abundance),
    .groups = 'drop'
  )

# Prepare the data for plotting
plot_data <- sim_stats %>%
  dplyr::mutate(Upper = mean_rel_ab + sd_rel_ab, Lower = mean_rel_ab - sd_rel_ab)

ggplot(subset(plot_data, Species != "Drug"), aes(x = Hour, y = mean_rel_ab, group = Species, color = Species)) +
  geom_ribbon(aes(ymin = Lower, ymax = Upper, fill = Species), colour = NA, alpha = 0.2) +  
  geom_line(size = 1, alpha = 0.7) + 
  scale_color_manual(values = species_colours_1) +
  scale_fill_manual(values = species_colours_1) +  
  labs(title = "Mean and SD of Relative Abundance Across Simulations",
       subtitle = paste0("Felodipine = ", drug_concentration_tested),       
       x = "Time (hours)",
       y = "Relative abundance",
       color = "Species",
       fill = "Species") +
  theme_minimal() +
  theme(legend.position = "right")

#log-scaled mean trends
ggplot(plot_data, aes(x = Hour, y = log10(mean_rel_ab + 0.0001), group = Species, color = Species)) +
  geom_line(size = 1, alpha = 0.7) +  # Mean line
  scale_color_manual(values = species_colours_1) +
  scale_fill_manual(values = species_colours_1) +  # Ensure consistent colors for lines and fills
  labs(title = "Mean and SD of Relative Abundance Across Simulations",
       subtitle = paste0("Felodipine = ", drug_concentration_tested),
       x = "Time (hours)",
       y = "Relative abundance",
       color = "Species",
       fill = "Species") +
  theme_minimal() +
  theme(legend.position = "right")




##prediction quality evaluation
drug_tested <- "Felodipine"
variable_name <- paste0("plot_data_", ifelse(drug_concentration_tested == 1e-04, 0, drug_concentration_tested), "_", drug_tested)
assign(variable_name, plot_data)


#extract total OD info:
predicted_mean_final_od_NULL <- Niclosamide_16S_0uM_summarised$mean_com_final_OD[1]
predicted_sd_final_od_NULL <- Niclosamide_16S_0uM_summarised$sd_com_final_OD[1]

predicted_mean_final_od_5_Felodipine <- mean(subset(sim_output_wide_5_Felodipine, Hour == 48)$Total_OD, na.rm = TRUE)
predicted_sd_final_od_5_Felodipine <- sd(subset(sim_output_wide_5_Felodipine, Hour == 48)$Total_OD, na.rm = TRUE)

real_mean_final_od_5_Felodipine <- Community_compositions_focus_drugs_Felodipine_5uM_summarised$mean_final_OD[1]
real_sd_final_od_5_Felodipine <- Community_compositions_focus_drugs_Felodipine_5uM_summarised$sd_final_OD[1]


predicted_mean_final_od_20_Felodipine <- mean(subset(sim_output_wide_20_Felodipine, Hour == 48)$Total_OD, na.rm = TRUE)
predicted_sd_final_od_20_Felodipine <- sd(subset(sim_output_wide_20_Felodipine, Hour == 48)$Total_OD, na.rm = TRUE)

real_mean_final_od_20_Felodipine <- Community_compositions_focus_drugs_Felodipine_20uM_summarised$mean_final_OD[1]
real_sd_final_od_20_Felodipine <- Community_compositions_focus_drugs_Felodipine_20uM_summarised$sd_final_OD[1]


predicted_mean_final_od_80_Felodipine <- mean(subset(sim_output_wide_80_Felodipine, Hour == 48)$Total_OD, na.rm = TRUE)
predicted_sd_final_od_80_Felodipine <- sd(subset(sim_output_wide_80_Felodipine, Hour == 48)$Total_OD, na.rm = TRUE)

real_mean_final_od_80_Felodipine <- Community_compositions_focus_drugs_Felodipine_80uM_summarised$mean_final_OD[1]
real_sd_final_od_80_Felodipine <- Community_compositions_focus_drugs_Felodipine_80uM_summarised$sd_final_OD[1]




#plot_data_0_Felodipine_endpoint was used to test model performance at 0 drugs
#plot_data_0_Felodipine_endpoint <- subset(plot_data_0_Felodipine, Hour == 48 & Species != "Drug")
plot_data_5_Felodipine_endpoint <- subset(plot_data_5_Felodipine, Hour == 48 & Species != "Drug")
plot_data_20_Felodipine_endpoint <- subset(plot_data_20_Felodipine, Hour == 48 & Species != "Drug")
plot_data_80_Felodipine_endpoint <- subset(plot_data_80_Felodipine, Hour == 48 & Species != "Drug")

##Inspecting 'match' to real relative abundance distributions:
Niclosamide_16S_0uM_summarised <- rel_ab_control
Niclosamide_16S_0uM_summarised$Species <- gsub("\\.", "", Niclosamide_16S_0uM_summarised$Species)

Felodipine_16S_5uM_summarised <- Community_compositions_focus_drugs_Felodipine_5uM_summarised
Felodipine_16S_20uM_summarised <- Community_compositions_focus_drugs_Felodipine_20uM_summarised
Felodipine_16S_80uM_summarised <- Community_compositions_focus_drugs_Felodipine_80uM_summarised

Niclosamide_16S_0uM_summarised
Felodipine_16S_5uM_summarised 
Felodipine_16S_20uM_summarised 
Felodipine_16S_80uM_summarised 

#Rename 'species' so the outputs become comparable
original_names_80 <- unique(Felodipine_16S_80uM_summarised$species)
original_names_20 <- unique(Felodipine_16S_20uM_summarised$species)
original_names_5 <- unique(Felodipine_16S_5uM_summarised$species)


##Create a named vector with the original and new names mapping
name_changes <- c(
  "Akkermansia muciniphila" = "A_muciniphila",
  "Bacteroides fragilis" = "B_fragilis",
  "Bacteroides thetaiotaomicron" = "B_thetaiotaomicron",
  "Bacteroides uniformis" = "B_uniformis",
  "Bifidobacterium adolescentis" = "B_adolescentis",
  "Bifidobacterium longum subsp. longum" = "B_longum",
  "Bilophila wadsworthia" = "B_wadsworthia",
  "Blautia obeum" = "B_obeum",
  "Clostridium perfringens" = "C_perfringens",
  "Collinsella aerofaciens" = "C_aerofaciens",
  "Coprococcus comes" = "C_comes",
  "Dorea formicigenerans" = "D_formicigenerans",
  "Eggerthella lenta" = "E_lenta",
  "Enterocloster bolteae" = "C_bolteae",
  "Erysipelatoclostridium ramosum" = "C_ramosum",
  "Escherichia coli ED1a" = "E_coli",
  "Eubacterium rectale" = "E_rectale",
  "Fusobacterium nucleatum subsp. nucleatum" = "F_nucleatum",
  "Lacrimispora saccharolytica" = "C_saccharolyticum",
  "Lacticaseibacillus paracasei" = "L_paracasei",
  "Odoribacter splanchnicus" = "O_splanchnicus",
  "Parabacteroides distasonis" = "P_distasonis",
  "Parabacteroides merdae" = "P_merdae",
  "Phocaeicola vulgatus" = "B_vulgatus",
  "Prevotella copri" = "P_copri",
  "Roseburia intestinalis" = "R_intestinalis",
  "Ruminococcus bromii" = "R_bromii",
  "Ruminococcus gnavus" = "R_gnavus",
  "Ruminococcus torques" = "R_torques",
  "Streptococcus parasanguinis" = "S_parasanguinis",
  "Streptococcus salivarius" = "S_salivarius",
  "Veillonella parvula" = "V_parvula"
)

# Apply name changes to the species column in Felodipine_16S_80uM_summarised

Felodipine_16S_80uM_summarised$Species <- name_changes[Felodipine_16S_80uM_summarised$species]
Felodipine_16S_20uM_summarised$Species <- name_changes[Felodipine_16S_20uM_summarised$species]
Felodipine_16S_5uM_summarised$Species <- name_changes[Felodipine_16S_5uM_summarised$species]

# Verify the changes
unique(Felodipine_16S_80uM_summarised$Species)
unique(Felodipine_16S_20uM_summarised$Species)
unique(Felodipine_16S_5uM_summarised$Species)



##First, for 5 uM:
# Get top 6 species from plot_data_5_endpoint
# Adjust the plot_data_5_endpoint with confidence bounds

# #plot_data_0_Felodipine_endpoint was used to test model performance at 0 drugs
# plot_data_0_Felodipine_endpoint <- plot_data_0_Felodipine_endpoint %>%
#   dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)

plot_data_5_Felodipine_endpoint <- plot_data_5_Felodipine_endpoint %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)

# Adjust the Felodipine_16S_5uM_summarised with confidence bounds
Felodipine_16S_5uM_summarised <- Felodipine_16S_5uM_summarised %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)

#NULL model:
Null_model_summarised <- Niclosamide_16S_0uM_summarised %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)


# Get top 6 species based on the lower bound from plot_data_5_endpoint

#top6_predicted_0_Felodipine was used to test model performance at 0 drugs
# top6_predicted_0_Felodipine <- plot_data_0_Felodipine_endpoint %>%
#    arrange(desc(lower_bound)) %>%
#    slice(1:6) %>%
#    pull(Species)

top6_predicted_5_Felodipine <- plot_data_5_Felodipine_endpoint %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

# Get top 6 species based on the lower bound from Felodipine_16S_5uM_summarised
top6_real_5_Felodipine <- Felodipine_16S_5uM_summarised %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

top6_NULL <- Null_model_summarised %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

# Calculate the overlap of top 6 species

#top_six_correct_0_Felodipine was used to assess model performance at 0 drugs
# top_six_correct_0_Felodipine <- length(intersect(top6_predicted_0_Felodipine, top6_NULL))
# top_six_correct_0_Felodipine

top_six_correct_5_Felodipine <- length(intersect(top6_predicted_5_Felodipine, top6_real_5_Felodipine))
top_six_correct_5_Felodipine

top_six_correct_5_Felodipine_NULL <- length(intersect(top6_NULL, top6_real_5_Felodipine))
top_six_correct_5_Felodipine_NULL

top6_predicted_5_Felodipine
top6_real_5_Felodipine

#top6_NULL

#Now by means:
# #top6_predicted_0_Felodipine_means was used to assess model performance at 0 drugs
# top6_predicted_0_Felodipine_means <- plot_data_0_Felodipine_endpoint %>%
#    arrange(desc(mean_rel_ab)) %>%
#    slice(1:6) %>%
#    pull(Species)

top6_predicted_5_Felodipine_means <- plot_data_5_Felodipine_endpoint %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)

# Get top 6 species based on the lower bound from Felodipine_16S_5uM_summarised
top6_real_5_Felodipine_means <- Felodipine_16S_5uM_summarised %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)

top6_NULL_means <- Null_model_summarised %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)


# #top_six_correct_0_Felodipine_means was used to assess model performance at 0 drugs
# top_six_correct_0_Felodipine_means <- length(intersect(top6_predicted_0_Felodipine_means, top6_NULL_means))
# top_six_correct_0_Felodipine_means

top_six_correct_5_Felodipine_means <- length(intersect(top6_predicted_5_Felodipine_means, top6_real_5_Felodipine_means))
top_six_correct_5_Felodipine_means

top_six_correct_5_Felodipine_means_NULL <- length(intersect(top6_NULL_means, top6_real_5_Felodipine_means))
top_six_correct_5_Felodipine_means_NULL

top6_predicted_5_Felodipine_means
top6_real_5_Felodipine_means

#top6_NULL_means


# Merge dataframes by Species

#merged_data_0_Felodipine was used to assess model performance at 0 drugs
#merged_data_0_Felodipine <- merge(plot_data_0_Felodipine_endpoint, Niclosamide_16S_0uM_summarised, by = "Species", suffixes = c(".pred", ".real"))
merged_data_5_Felodipine <- merge(plot_data_5_Felodipine_endpoint, Felodipine_16S_5uM_summarised, by = "Species", suffixes = c(".pred", ".real"))
merged_data_5_Felodipine_NULL <- merge(Niclosamide_16S_0uM_summarised, Felodipine_16S_5uM_summarised, by = "Species", suffixes = c(".null", ".real"))


## Below lines used for assessing model performance at 0 drugs; ignore for nonzero concentrations
# # Create lower and upper bounds considering mean ¬± sd
# merged_data_0_Felodipine$lower_bound_pred <- merged_data_0_Felodipine$mean_rel_ab.pred - merged_data_0_Felodipine$sd_rel_ab.pred
# merged_data_0_Felodipine$upper_bound_pred <- merged_data_0_Felodipine$mean_rel_ab.pred + merged_data_0_Felodipine$sd_rel_ab.pred
# merged_data_0_Felodipine$lower_bound_real <- merged_data_0_Felodipine$mean_rel_ab.real - merged_data_0_Felodipine$sd_rel_ab.real
# merged_data_0_Felodipine$upper_bound_real <- merged_data_0_Felodipine$mean_rel_ab.real + merged_data_0_Felodipine$sd_rel_ab.real
# 
# # Ensure lower and upper bounds are non-negative, adjusting as necessary
# merged_data_0_Felodipine$lower_bound_pred[merged_data_0_Felodipine$lower_bound_pred <= 0] <- 1e-10
# merged_data_0_Felodipine$lower_bound_real[merged_data_0_Felodipine$lower_bound_real <= 0] <- 1e-10
# merged_data_0_Felodipine$upper_bound_pred[merged_data_0_Felodipine$upper_bound_pred <= 0] <- 1e-10
# merged_data_0_Felodipine$upper_bound_real[merged_data_0_Felodipine$upper_bound_real <= 0] <- 1e-10


# Create lower and upper bounds considering mean ¬± sd
merged_data_5_Felodipine$lower_bound_pred <- merged_data_5_Felodipine$mean_rel_ab.pred - merged_data_5_Felodipine$sd_rel_ab.pred
merged_data_5_Felodipine$upper_bound_pred <- merged_data_5_Felodipine$mean_rel_ab.pred + merged_data_5_Felodipine$sd_rel_ab.pred
merged_data_5_Felodipine$lower_bound_real <- merged_data_5_Felodipine$mean_rel_ab.real - merged_data_5_Felodipine$sd_rel_ab.real
merged_data_5_Felodipine$upper_bound_real <- merged_data_5_Felodipine$mean_rel_ab.real + merged_data_5_Felodipine$sd_rel_ab.real

# Ensure lower and upper bounds are non-negative, adjusting as necessary
merged_data_5_Felodipine$lower_bound_pred[merged_data_5_Felodipine$lower_bound_pred <= 0] <- 1e-10
merged_data_5_Felodipine$lower_bound_real[merged_data_5_Felodipine$lower_bound_real <= 0] <- 1e-10
merged_data_5_Felodipine$upper_bound_pred[merged_data_5_Felodipine$upper_bound_pred <= 0] <- 1e-10
merged_data_5_Felodipine$upper_bound_real[merged_data_5_Felodipine$upper_bound_real <= 0] <- 1e-10

##and for NULL model:
# Create lower and upper bounds considering mean ¬± sd
merged_data_5_Felodipine_NULL$lower_bound_null <- merged_data_5_Felodipine_NULL$mean_rel_ab.null - merged_data_5_Felodipine_NULL$sd_rel_ab.null
merged_data_5_Felodipine_NULL$upper_bound_null <- merged_data_5_Felodipine_NULL$mean_rel_ab.null + merged_data_5_Felodipine_NULL$sd_rel_ab.null
merged_data_5_Felodipine_NULL$lower_bound_real <- merged_data_5_Felodipine_NULL$mean_rel_ab.real - merged_data_5_Felodipine_NULL$sd_rel_ab.real
merged_data_5_Felodipine_NULL$upper_bound_real <- merged_data_5_Felodipine_NULL$mean_rel_ab.real + merged_data_5_Felodipine_NULL$sd_rel_ab.real

# Ensure lower and upper bounds are non-negative, adjusting as necessary
merged_data_5_Felodipine_NULL$lower_bound_null[merged_data_5_Felodipine_NULL$lower_bound_null <= 0] <- 1e-10
merged_data_5_Felodipine_NULL$lower_bound_real[merged_data_5_Felodipine_NULL$lower_bound_real <= 0] <- 1e-10
merged_data_5_Felodipine_NULL$upper_bound_null[merged_data_5_Felodipine_NULL$upper_bound_null <= 0] <- 1e-10
merged_data_5_Felodipine_NULL$upper_bound_real[merged_data_5_Felodipine_NULL$upper_bound_real <= 0] <- 1e-10

# Filter to include only species with a mean relative abundance > 0.01 in the 'real' dataset

## significant_species_0 was used to assess model performance at 0 drugs
#significant_species_0 <- merged_data_0_Felodipine[merged_data_0_Felodipine$mean_rel_ab.real > 0.01, ]
significant_species <- merged_data_5_Felodipine[merged_data_5_Felodipine$mean_rel_ab.real > 0.01, ]
survivors_5_Felodipine <- nrow(significant_species)
survivors_5_Felodipine

#should be the same as survivors defined above, since it is calculated from .real
significant_species_NULL <- merged_data_5_Felodipine_NULL[merged_data_5_Felodipine_NULL$mean_rel_ab.real > 0.01, ]
survivors_5_Felodipine_NULL <- nrow(significant_species_NULL)
survivors_5_Felodipine_NULL

# Adjusted order of magnitude check to include SD, only for significant species
## below code was used to assess model performance at 0 drugs
# significant_species_0$Predicted_magnitude_correct <- ifelse(
#   (floor(log10(significant_species_0$lower_bound_pred)) <= floor(log10(significant_species_0$upper_bound_real)) &
#      floor(log10(significant_species_0$upper_bound_pred)) >= floor(log10(significant_species_0$lower_bound_real))),
#   1,
#   0
# )

significant_species$Predicted_magnitude_correct <- ifelse(
  (floor(log10(significant_species$lower_bound_pred)) <= floor(log10(significant_species$upper_bound_real)) &
     floor(log10(significant_species$upper_bound_pred)) >= floor(log10(significant_species$lower_bound_real))),
  1,
  0
)

#and for the Null model:
significant_species_NULL$Predicted_magnitude_correct <- ifelse(
  (floor(log10(significant_species_NULL$lower_bound_null)) <= floor(log10(significant_species_NULL$upper_bound_real)) &
     floor(log10(significant_species_NULL$upper_bound_null)) >= floor(log10(significant_species_NULL$lower_bound_real))),
  1,
  0
)

# Calculate the fraction of correctly predicted magnitudes for significant species
## below code was used to assess model performance at 0 drugs
#predicted_magnitude_correct_fraction_0_Felodipine <- sum(significant_species_0$Predicted_magnitude_correct) / nrow(significant_species_0)
#predicted_magnitude_correct_fraction_0_Felodipine

predicted_magnitude_correct_fraction_5_Felodipine <- sum(significant_species$Predicted_magnitude_correct) / nrow(significant_species)
predicted_magnitude_correct_fraction_5_Felodipine

predicted_magnitude_correct_fraction_5_Felodipine_NULL <- sum(significant_species_NULL$Predicted_magnitude_correct) / nrow(significant_species_NULL)
predicted_magnitude_correct_fraction_5_Felodipine_NULL

top_species_missing_5_Felodipine <- setdiff(top6_real_5_Felodipine_means, top6_predicted_5_Felodipine_means)
top_species_wrong_5_Felodipine <- setdiff(top6_predicted_5_Felodipine_means, top6_real_5_Felodipine_means)

top_species_missing_5_Felodipine <- if(length(top_species_missing_5_Felodipine) == 0) "None" else top_species_missing_5_Felodipine
top_species_wrong_5_Felodipine <- if(length(top_species_wrong_5_Felodipine) == 0) "None" else top_species_wrong_5_Felodipine

Prediction_quality_5_Felodipine <- data.frame(
  Top_six_correct = paste(top_six_correct_5_Felodipine, sep=""),
  Top_six_correct_NULL = paste(top_six_correct_5_Felodipine_NULL, sep=""),
  Top_six_correct_means = paste(top_six_correct_5_Felodipine_means, sep=""),
  Top_six_correct_means_NULL = paste(top_six_correct_5_Felodipine_means_NULL, sep=""),
  Predicted_magnitude_correct = paste(round(predicted_magnitude_correct_fraction_5_Felodipine * 100, 2), "%", sep=""),
  Predicted_magnitude_correct_NULL = paste(round(predicted_magnitude_correct_fraction_5_Felodipine_NULL * 100, 2), "%", sep=""),
  survivors_total = survivors_5_Felodipine,
  top_species_missing <- top_species_missing_5_Felodipine,
  top_species_wrong <- top_species_wrong_5_Felodipine, 
  predicted_mean_final_OD <- predicted_mean_final_od_5_Felodipine,
  real_mean_final_OD <- real_mean_final_od_5_Felodipine,
  sims_total = length(successful_sim_ids)
)



Prediction_quality_5_Felodipine



##Next, for 20 uM:
# Get top 6 species from plot_data_20_endpoint
# Adjust the plot_data_20_endpoint with confidence bounds
plot_data_20_Felodipine_endpoint <- plot_data_20_Felodipine_endpoint %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)

# Adjust the Felodipine_16S_20uM_summarised with confidence bounds
Felodipine_16S_20uM_summarised <- Felodipine_16S_20uM_summarised %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)

#NULL model:
Null_model_summarised <- Niclosamide_16S_0uM_summarised %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)


# Get top 6 species based on the lower bound from plot_data_20_endpoint
top6_predicted_20_Felodipine <- plot_data_20_Felodipine_endpoint %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

# Get top 6 species based on the lower bound from Felodipine_16S_20uM_summarised
top6_real_20_Felodipine <- Felodipine_16S_20uM_summarised %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

top6_NULL <- Null_model_summarised %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

# Calculate the overlap of top 6 species
top_six_correct_20_Felodipine <- length(intersect(top6_predicted_20_Felodipine, top6_real_20_Felodipine))
#top_six_correct_20_Felodipine

top_six_correct_20_Felodipine_NULL <- length(intersect(top6_NULL, top6_real_20_Felodipine))
#top_six_correct_20_Felodipine_NULL

#top6_predicted_20_Felodipine
#top6_real_20_Felodipine



#Now by means:
top6_predicted_20_Felodipine_means <- plot_data_20_Felodipine_endpoint %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)

# Get top 6 species based on the lower bound from Felodipine_16S_20uM_summarised
top6_real_20_Felodipine_means <- Felodipine_16S_20uM_summarised %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)

top6_NULL_means <- Null_model_summarised %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)



top_six_correct_20_Felodipine_means <- length(intersect(top6_predicted_20_Felodipine_means, top6_real_20_Felodipine_means))
#top_six_correct_20_Felodipine_means

top_six_correct_20_Felodipine_means_NULL <- length(intersect(top6_NULL_means, top6_real_20_Felodipine_means))
#top_six_correct_20_Felodipine_means_NULL

top6_predicted_20_Felodipine_means
#top6_real_20_Felodipine_means




# Merge dataframes by Species
merged_data_20_Felodipine <- merge(plot_data_20_Felodipine_endpoint, Felodipine_16S_20uM_summarised, by = "Species", suffixes = c(".pred", ".real"))
merged_data_20_Felodipine_NULL <- merge(Niclosamide_16S_0uM_summarised, Felodipine_16S_20uM_summarised, by = "Species", suffixes = c(".null", ".real"))



# Create lower and upper bounds considering mean ¬± sd
merged_data_20_Felodipine$lower_bound_pred <- merged_data_20_Felodipine$mean_rel_ab.pred - merged_data_20_Felodipine$sd_rel_ab.pred
merged_data_20_Felodipine$upper_bound_pred <- merged_data_20_Felodipine$mean_rel_ab.pred + merged_data_20_Felodipine$sd_rel_ab.pred
merged_data_20_Felodipine$lower_bound_real <- merged_data_20_Felodipine$mean_rel_ab.real - merged_data_20_Felodipine$sd_rel_ab.real
merged_data_20_Felodipine$upper_bound_real <- merged_data_20_Felodipine$mean_rel_ab.real + merged_data_20_Felodipine$sd_rel_ab.real

# Ensure lower and upper bounds are non-negative, adjusting as necessary
merged_data_20_Felodipine$lower_bound_pred[merged_data_20_Felodipine$lower_bound_pred <= 0] <- 1e-10
merged_data_20_Felodipine$lower_bound_real[merged_data_20_Felodipine$lower_bound_real <= 0] <- 1e-10
merged_data_20_Felodipine$upper_bound_pred[merged_data_20_Felodipine$upper_bound_pred <= 0] <- 1e-10
merged_data_20_Felodipine$upper_bound_real[merged_data_20_Felodipine$upper_bound_real <= 0] <- 1e-10

##and for NULL model:
# Create lower and upper bounds considering mean ¬± sd
merged_data_20_Felodipine_NULL$lower_bound_null <- merged_data_20_Felodipine_NULL$mean_rel_ab.null - merged_data_20_Felodipine_NULL$sd_rel_ab.null
merged_data_20_Felodipine_NULL$upper_bound_null <- merged_data_20_Felodipine_NULL$mean_rel_ab.null + merged_data_20_Felodipine_NULL$sd_rel_ab.null
merged_data_20_Felodipine_NULL$lower_bound_real <- merged_data_20_Felodipine_NULL$mean_rel_ab.real - merged_data_20_Felodipine_NULL$sd_rel_ab.real
merged_data_20_Felodipine_NULL$upper_bound_real <- merged_data_20_Felodipine_NULL$mean_rel_ab.real + merged_data_20_Felodipine_NULL$sd_rel_ab.real

# Ensure lower and upper bounds are non-negative, adjusting as necessary
merged_data_20_Felodipine_NULL$lower_bound_null[merged_data_20_Felodipine_NULL$lower_bound_null <= 0] <- 1e-10
merged_data_20_Felodipine_NULL$lower_bound_real[merged_data_20_Felodipine_NULL$lower_bound_real <= 0] <- 1e-10
merged_data_20_Felodipine_NULL$upper_bound_null[merged_data_20_Felodipine_NULL$upper_bound_null <= 0] <- 1e-10
merged_data_20_Felodipine_NULL$upper_bound_real[merged_data_20_Felodipine_NULL$upper_bound_real <= 0] <- 1e-10

# Filter to include only species with a mean relative abundance > 0.01 in the 'real' dataset
significant_species <- merged_data_20_Felodipine[merged_data_20_Felodipine$mean_rel_ab.real > 0.01, ]
survivors_20_Felodipine <- nrow(significant_species)
survivors_20_Felodipine

#should be the same as survivors defined above, since it is calculated from .real
significant_species_NULL <- merged_data_20_Felodipine_NULL[merged_data_20_Felodipine_NULL$mean_rel_ab.real > 0.01, ]
survivors_20_Felodipine_NULL <- nrow(significant_species_NULL)
survivors_20_Felodipine_NULL

# Adjusted order of magnitude check to include SD, only for significant species
significant_species$Predicted_magnitude_correct <- ifelse(
  (floor(log10(significant_species$lower_bound_pred)) <= floor(log10(significant_species$upper_bound_real)) &
     floor(log10(significant_species$upper_bound_pred)) >= floor(log10(significant_species$lower_bound_real))),
  1,
  0
)

#and for the Null model:
significant_species_NULL$Predicted_magnitude_correct <- ifelse(
  (floor(log10(significant_species_NULL$lower_bound_null)) <= floor(log10(significant_species_NULL$upper_bound_real)) &
     floor(log10(significant_species_NULL$upper_bound_null)) >= floor(log10(significant_species_NULL$lower_bound_real))),
  1,
  0
)

# Calculate the fraction of correctly predicted magnitudes for significant species
predicted_magnitude_correct_fraction_20_Felodipine <- sum(significant_species$Predicted_magnitude_correct) / nrow(significant_species)
predicted_magnitude_correct_fraction_20_Felodipine

predicted_magnitude_correct_fraction_20_Felodipine_NULL <- sum(significant_species_NULL$Predicted_magnitude_correct) / nrow(significant_species_NULL)
predicted_magnitude_correct_fraction_20_Felodipine_NULL

top_species_missing_20_Felodipine <- setdiff(top6_real_20_Felodipine_means, top6_predicted_20_Felodipine_means)
top_species_wrong_20_Felodipine <- setdiff(top6_predicted_20_Felodipine_means, top6_real_20_Felodipine_means)

Prediction_quality_20_Felodipine <- data.frame(
  Top_six_correct = paste(top_six_correct_20_Felodipine, sep=""),
  Top_six_correct_NULL = paste(top_six_correct_20_Felodipine_NULL, sep=""),
  Top_six_correct_means = paste(top_six_correct_20_Felodipine_means, sep=""),
  Top_six_correct_means_NULL = paste(top_six_correct_20_Felodipine_means_NULL, sep=""),
  Predicted_magnitude_correct = paste(round(predicted_magnitude_correct_fraction_20_Felodipine * 100, 2), "%", sep=""),
  Predicted_magnitude_correct_NULL = paste(round(predicted_magnitude_correct_fraction_20_Felodipine_NULL * 100, 2), "%", sep=""),
  survivors_total = survivors_20_Felodipine,
  top_species_missing <- top_species_missing_20_Felodipine,
  top_species_wrong <- top_species_wrong_20_Felodipine, 
  predicted_mean_final_OD <- predicted_mean_final_od_20_Felodipine,
  real_mean_final_OD <- real_mean_final_od_20_Felodipine,
  sims_total = length(successful_sim_ids)
)

Prediction_quality_20_Felodipine






##Next, for 80 uM:
# Get top 6 species from plot_data_80_endpoint
# Adjust the plot_data_80_endpoint with confidence bounds
plot_data_80_Felodipine_endpoint <- plot_data_80_Felodipine_endpoint %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)

# Adjust the Felodipine_16S_80uM_summarised with confidence bounds
Felodipine_16S_80uM_summarised <- Felodipine_16S_80uM_summarised %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)

#NULL model:
Null_model_summarised <- Niclosamide_16S_0uM_summarised %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)


# Get top 6 species based on the lower bound from plot_data_80_endpoint
top6_predicted_80_Felodipine <- plot_data_80_Felodipine_endpoint %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

# Get top 6 species based on the lower bound from Felodipine_16S_80uM_summarised
top6_real_80_Felodipine <- Felodipine_16S_80uM_summarised %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

top6_NULL <- Null_model_summarised %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

# Calculate the overlap of top 6 species
top_six_correct_80_Felodipine <- length(intersect(top6_predicted_80_Felodipine, top6_real_80_Felodipine))
#top_six_correct_80_Felodipine

top_six_correct_80_Felodipine_NULL <- length(intersect(top6_NULL, top6_real_80_Felodipine))
#top_six_correct_80_Felodipine_NULL

#top6_predicted_80_Felodipine
#top6_real_80_Felodipine




#Now by means:
top6_predicted_80_Felodipine_means <- plot_data_80_Felodipine_endpoint %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)

# Get top 6 species based on the lower bound from Felodipine_16S_80uM_summarised
top6_real_80_Felodipine_means <- Felodipine_16S_80uM_summarised %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)

top6_NULL_means <- Null_model_summarised %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)



top_six_correct_80_Felodipine_means <- length(intersect(top6_predicted_80_Felodipine_means, top6_real_80_Felodipine_means))
#top_six_correct_80_Felodipine_means

top_six_correct_80_Felodipine_means_NULL <- length(intersect(top6_NULL_means, top6_real_80_Felodipine_means))
#top_six_correct_80_Felodipine_means_NULL

#top6_predicted_80_Felodipine_means
#top6_real_80_Felodipine_means




# Merge dataframes by Species
merged_data_80_Felodipine <- merge(plot_data_80_Felodipine_endpoint, Felodipine_16S_80uM_summarised, by = "Species", suffixes = c(".pred", ".real"))
merged_data_80_Felodipine_NULL <- merge(Niclosamide_16S_0uM_summarised, Felodipine_16S_80uM_summarised, by = "Species", suffixes = c(".null", ".real"))



# Create lower and upper bounds considering mean ¬± sd
merged_data_80_Felodipine$lower_bound_pred <- merged_data_80_Felodipine$mean_rel_ab.pred - merged_data_80_Felodipine$sd_rel_ab.pred
merged_data_80_Felodipine$upper_bound_pred <- merged_data_80_Felodipine$mean_rel_ab.pred + merged_data_80_Felodipine$sd_rel_ab.pred
merged_data_80_Felodipine$lower_bound_real <- merged_data_80_Felodipine$mean_rel_ab.real - merged_data_80_Felodipine$sd_rel_ab.real
merged_data_80_Felodipine$upper_bound_real <- merged_data_80_Felodipine$mean_rel_ab.real + merged_data_80_Felodipine$sd_rel_ab.real

# Ensure lower and upper bounds are non-negative, adjusting as necessary
merged_data_80_Felodipine$lower_bound_pred[merged_data_80_Felodipine$lower_bound_pred <= 0] <- 1e-10
merged_data_80_Felodipine$lower_bound_real[merged_data_80_Felodipine$lower_bound_real <= 0] <- 1e-10
merged_data_80_Felodipine$upper_bound_pred[merged_data_80_Felodipine$upper_bound_pred <= 0] <- 1e-10
merged_data_80_Felodipine$upper_bound_real[merged_data_80_Felodipine$upper_bound_real <= 0] <- 1e-10

##and for NULL model:
# Create lower and upper bounds considering mean ¬± sd
merged_data_80_Felodipine_NULL$lower_bound_null <- merged_data_80_Felodipine_NULL$mean_rel_ab.null - merged_data_80_Felodipine_NULL$sd_rel_ab.null
merged_data_80_Felodipine_NULL$upper_bound_null <- merged_data_80_Felodipine_NULL$mean_rel_ab.null + merged_data_80_Felodipine_NULL$sd_rel_ab.null
merged_data_80_Felodipine_NULL$lower_bound_real <- merged_data_80_Felodipine_NULL$mean_rel_ab.real - merged_data_80_Felodipine_NULL$sd_rel_ab.real
merged_data_80_Felodipine_NULL$upper_bound_real <- merged_data_80_Felodipine_NULL$mean_rel_ab.real + merged_data_80_Felodipine_NULL$sd_rel_ab.real

# Ensure lower and upper bounds are non-negative, adjusting as necessary
merged_data_80_Felodipine_NULL$lower_bound_null[merged_data_80_Felodipine_NULL$lower_bound_null <= 0] <- 1e-10
merged_data_80_Felodipine_NULL$lower_bound_real[merged_data_80_Felodipine_NULL$lower_bound_real <= 0] <- 1e-10
merged_data_80_Felodipine_NULL$upper_bound_null[merged_data_80_Felodipine_NULL$upper_bound_null <= 0] <- 1e-10
merged_data_80_Felodipine_NULL$upper_bound_real[merged_data_80_Felodipine_NULL$upper_bound_real <= 0] <- 1e-10

# Filter to include only species with a mean relative abundance > 0.01 in the 'real' dataset
significant_species <- merged_data_80_Felodipine[merged_data_80_Felodipine$mean_rel_ab.real > 0.01, ]
survivors_80_Felodipine <- nrow(significant_species)
survivors_80_Felodipine

#should be the same as survivors defined above, since it is calculated from .real
significant_species_NULL <- merged_data_80_Felodipine_NULL[merged_data_80_Felodipine_NULL$mean_rel_ab.real > 0.01, ]
survivors_80_Felodipine_NULL <- nrow(significant_species_NULL)
survivors_80_Felodipine_NULL

# Adjusted order of magnitude check to include SD, only for significant species
significant_species$Predicted_magnitude_correct <- ifelse(
  (floor(log10(significant_species$lower_bound_pred)) <= floor(log10(significant_species$upper_bound_real)) &
     floor(log10(significant_species$upper_bound_pred)) >= floor(log10(significant_species$lower_bound_real))),
  1,
  0
)

#and for the Null model:
significant_species_NULL$Predicted_magnitude_correct <- ifelse(
  (floor(log10(significant_species_NULL$lower_bound_null)) <= floor(log10(significant_species_NULL$upper_bound_real)) &
     floor(log10(significant_species_NULL$upper_bound_null)) >= floor(log10(significant_species_NULL$lower_bound_real))),
  1,
  0
)

# Calculate the fraction of correctly predicted magnitudes for significant species
predicted_magnitude_correct_fraction_80_Felodipine <- sum(significant_species$Predicted_magnitude_correct) / nrow(significant_species)
predicted_magnitude_correct_fraction_80_Felodipine

predicted_magnitude_correct_fraction_80_Felodipine_NULL <- sum(significant_species_NULL$Predicted_magnitude_correct) / nrow(significant_species_NULL)
predicted_magnitude_correct_fraction_80_Felodipine_NULL


top_species_missing_80_Felodipine <- setdiff(top6_real_80_Felodipine_means, top6_predicted_80_Felodipine_means)
top_species_wrong_80_Felodipine <- setdiff(top6_predicted_80_Felodipine_means, top6_real_80_Felodipine_means)

Prediction_quality_80_Felodipine <- data.frame(
  Top_six_correct = paste(top_six_correct_80_Felodipine, sep=""),
  Top_six_correct_NULL = paste(top_six_correct_80_Felodipine_NULL, sep=""),
  Top_six_correct_means = paste(top_six_correct_80_Felodipine_means, sep=""),
  Top_six_correct_means_NULL = paste(top_six_correct_80_Felodipine_means_NULL, sep=""),
  Predicted_magnitude_correct = paste(round(predicted_magnitude_correct_fraction_80_Felodipine * 100, 2), "%", sep=""),
  Predicted_magnitude_correct_NULL = paste(round(predicted_magnitude_correct_fraction_80_Felodipine_NULL * 100, 2), "%", sep=""),
  survivors_total = survivors_80_Felodipine,
  top_species_missing <- top_species_missing_80_Felodipine,
  top_species_wrong <- top_species_wrong_80_Felodipine, 
  predicted_mean_final_OD <- predicted_mean_final_od_80_Felodipine,
  real_mean_final_OD <- real_mean_final_od_80_Felodipine,
  sims_total = length(successful_sim_ids)
)

Prediction_quality_80_Felodipine









##Ketoconazole

combined_monoculture_aucs2_Ketoconazole <- subset(combined_monoculture_aucs2, drug == "Ketoconazole")


#drug sensitivity terms: define once outside of ODEs
y_function_B_vulgatus_Ketoconazole <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("B_vulgatus", "Ketoconazole", best_fitting_models_df_Ketoconazole)), collapse = " ")))
y_function_B_uniformis_Ketoconazole <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("B_uniformis", "Ketoconazole", best_fitting_models_df_Ketoconazole)), collapse = " ")))
y_function_B_fragilis_Ketoconazole <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("B_fragilis", "Ketoconazole", best_fitting_models_df_Ketoconazole)), collapse = " ")))
y_function_B_thetaiotaomicron_Ketoconazole <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("B_thetaiotaomicron", "Ketoconazole", best_fitting_models_df_Ketoconazole)), collapse = " ")))
y_function_C_ramosum_Ketoconazole <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("C_ramosum", "Ketoconazole", best_fitting_models_df_Ketoconazole)), collapse = " ")))
y_function_E_rectale_Ketoconazole <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("E_rectale", "Ketoconazole", best_fitting_models_df_Ketoconazole)), collapse = " ")))
y_function_R_intestinalis_Ketoconazole <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("R_intestinalis", "Ketoconazole", best_fitting_models_df_Ketoconazole)), collapse = " ")))
y_function_V_parvula_Ketoconazole <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("V_parvula", "Ketoconazole", best_fitting_models_df_Ketoconazole)), collapse = " ")))
y_function_E_lenta_Ketoconazole <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("E_lenta", "Ketoconazole", best_fitting_models_df_Ketoconazole)), collapse = " ")))
y_function_F_nucleatum_Ketoconazole <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("F_nucleatum", "Ketoconazole", best_fitting_models_df_Ketoconazole)), collapse = " ")))
y_function_C_bolteae_Ketoconazole <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("C_bolteae", "Ketoconazole", best_fitting_models_df_Ketoconazole)), collapse = " ")))
y_function_C_perfringens_Ketoconazole <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("C_perfringens", "Ketoconazole", best_fitting_models_df_Ketoconazole)), collapse = " ")))
y_function_C_saccharolyticum_Ketoconazole <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("C_saccharolyticum", "Ketoconazole", best_fitting_models_df_Ketoconazole)), collapse = " ")))
y_function_S_salivarius_Ketoconazole <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("S_salivarius", "Ketoconazole", best_fitting_models_df_Ketoconazole)), collapse = " ")))
y_function_R_gnavus_Ketoconazole <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("R_gnavus", "Ketoconazole", best_fitting_models_df_Ketoconazole)), collapse = " ")))
y_function_C_comes_Ketoconazole <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("C_comes", "Ketoconazole", best_fitting_models_df_Ketoconazole)), collapse = " ")))
y_function_P_merdae_Ketoconazole <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("P_merdae", "Ketoconazole", best_fitting_models_df_Ketoconazole)), collapse = " ")))
y_function_S_parasanguinis_Ketoconazole <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("S_parasanguinis", "Ketoconazole", best_fitting_models_df_Ketoconazole)), collapse = " ")))
y_function_C_aerofaciens_Ketoconazole <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("C_aerofaciens", "Ketoconazole", best_fitting_models_df_Ketoconazole)), collapse = " ")))
y_function_D_formicigenerans_Ketoconazole <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("D_formicigenerans", "Ketoconazole", best_fitting_models_df_Ketoconazole)), collapse = " ")))
y_function_E_coli_Ketoconazole <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("E_coli", "Ketoconazole", best_fitting_models_df_Ketoconazole)), collapse = " ")))



y_function_B_vulgatus_Ketoconazole_func <- eval(parse(text = paste("function(Drug) {", y_function_B_vulgatus_Ketoconazole, "}")))
y_function_B_uniformis_Ketoconazole_func <- eval(parse(text = paste("function(Drug) {", y_function_B_uniformis_Ketoconazole, "}")))
y_function_B_fragilis_Ketoconazole_func <- eval(parse(text = paste("function(Drug) {", y_function_B_fragilis_Ketoconazole, "}")))
y_function_B_thetaiotaomicron_Ketoconazole_func <- eval(parse(text = paste("function(Drug) {", y_function_B_thetaiotaomicron_Ketoconazole, "}")))
y_function_C_ramosum_Ketoconazole_func <- eval(parse(text = paste("function(Drug) {", y_function_C_ramosum_Ketoconazole, "}")))
y_function_E_rectale_Ketoconazole_func <- eval(parse(text = paste("function(Drug) {", y_function_E_rectale_Ketoconazole, "}")))
y_function_R_intestinalis_Ketoconazole_func <- eval(parse(text = paste("function(Drug) {", y_function_R_intestinalis_Ketoconazole, "}")))
y_function_E_lenta_Ketoconazole_func <- eval(parse(text = paste("function(Drug) {", y_function_E_lenta_Ketoconazole, "}")))
y_function_F_nucleatum_Ketoconazole_func <- eval(parse(text = paste("function(Drug) {", y_function_F_nucleatum_Ketoconazole, "}")))
y_function_C_bolteae_Ketoconazole_func <- eval(parse(text = paste("function(Drug) {", y_function_C_bolteae_Ketoconazole, "}")))
y_function_C_perfringens_Ketoconazole_func <- eval(parse(text = paste("function(Drug) {", y_function_C_perfringens_Ketoconazole, "}")))
y_function_C_saccharolyticum_Ketoconazole_func <- eval(parse(text = paste("function(Drug) {", y_function_C_saccharolyticum_Ketoconazole, "}")))
y_function_S_salivarius_Ketoconazole_func <- eval(parse(text = paste("function(Drug) {", y_function_S_salivarius_Ketoconazole, "}")))
y_function_R_gnavus_Ketoconazole_func <- eval(parse(text = paste("function(Drug) {", y_function_R_gnavus_Ketoconazole, "}")))
y_function_C_comes_Ketoconazole_func <- eval(parse(text = paste("function(Drug) {", y_function_C_comes_Ketoconazole, "}")))
y_function_P_merdae_Ketoconazole_func <- eval(parse(text = paste("function(Drug) {", y_function_P_merdae_Ketoconazole, "}")))
y_function_S_parasanguinis_Ketoconazole_func <- eval(parse(text = paste("function(Drug) {", y_function_S_parasanguinis_Ketoconazole, "}")))
y_function_C_aerofaciens_Ketoconazole_func <- eval(parse(text = paste("function(Drug) {", y_function_C_aerofaciens_Ketoconazole, "}")))
y_function_D_formicigenerans_Ketoconazole_func <- eval(parse(text = paste("function(Drug) {", y_function_D_formicigenerans_Ketoconazole, "}")))
y_function_E_coli_Ketoconazole_func <- eval(parse(text = paste("function(Drug) {", y_function_E_coli_Ketoconazole, "}")))
y_function_V_parvula_Ketoconazole_func <- eval(parse(text = paste("function(Drug) {", y_function_V_parvula_Ketoconazole, "}")))



unique(combined_monoculture_aucs2_Ketoconazole$conc)
##dictate drug concentration tested for simulation cycle here:
#drug_concentration_tested <- 5 #if manually or:
drug_concentration_tested <- unique(combined_monoculture_aucs2_Ketoconazole$conc)[1] 
initial_conditions <- rep(0.01/32, 32)
initial_conditions <- c(initial_conditions, drug_concentration_tested)


##drug effect fitted for species showing sensitivity in monoculture:
#unique(combined_monoculture_aucs2_Ketoconazole$Species)

##for more simple linear fits
closed.sir.model_Ketoconazole <- function (t, x, params) {
  ## first extract the state variables
  A_muciniphila <- x[1]
  B_adolescentis <- x[2]
  B_fragilis <- x[3]
  B_longum <- x[4]
  B_obeum <- x[5]
  B_thetaiotaomicron <- x[6]
  B_uniformis <- x[7]
  B_vulgatus <- x[8]
  B_wadsworthia <- x[9]
  C_aerofaciens <- x[10]
  C_bolteae <- x[11]
  C_comes <- x[12]
  C_perfringens <- x[13]
  C_ramosum <- x[14]
  C_saccharolyticum <- x[15]
  D_formicigenerans <- x[16]
  E_coli <- x[17]
  E_lenta <- x[18]
  E_rectale <- x[19]
  F_nucleatum <- x[20]
  L_paracasei <- x[21]
  O_splanchnicus <- x[22]
  P_copri <- x[23]
  P_distasonis <- x[24]
  P_merdae <- x[25]
  R_bromii <- x[26]
  R_gnavus <- x[27]
  R_intestinalis <- x[28]
  R_torques <- x[29]
  S_parasanguinis <- x[30]
  S_salivarius <- x[31]
  V_parvula <- x[32]
  Drug <- x[33]
  
  
  ## now extract the parameters
  r_B_fragilis <- flat_params[["B._fragilis.r"]]
  K_B_fragilis <- flat_params[["B._fragilis.K"]]
  r_B_longum <- flat_params[["B._longum.r"]]
  K_B_longum <- flat_params[["B._longum.K"]]
  r_B_thetaiotaomicron <- flat_params[["B._thetaiotaomicron.r"]]
  K_B_thetaiotaomicron <- flat_params[["B._thetaiotaomicron.K"]]
  r_B_uniformis <- flat_params[["B._uniformis.r"]]
  K_B_uniformis <- flat_params[["B._uniformis.K"]]
  r_B_vulgatus <- flat_params[["B._vulgatus.r"]]
  K_B_vulgatus <- flat_params[["B._vulgatus.K"]]
  r_B_wadsworthia <- flat_params[["B._wadsworthia.r"]]
  K_B_wadsworthia <- flat_params[["B._wadsworthia.K"]]
  r_C_aerofaciens <- flat_params[["C._aerofaciens.r"]]
  K_C_aerofaciens <- flat_params[["C._aerofaciens.K"]]
  r_C_bolteae <- flat_params[["C._bolteae.r"]]
  K_C_bolteae <- flat_params[["C._bolteae.K"]]
  r_C_comes <- flat_params[["C._comes.r"]]
  K_C_comes <- flat_params[["C._comes.K"]]
  r_C_perfringens <- flat_params[["C._perfringens.r"]]
  K_C_perfringens <- flat_params[["C._perfringens.K"]]
  r_C_ramosum <- flat_params[["C._ramosum.r"]]
  K_C_ramosum <- flat_params[["C._ramosum.K"]]
  r_C_saccharolyticum <- flat_params[["C._saccharolyticum.r"]]
  K_C_saccharolyticum <- flat_params[["C._saccharolyticum.K"]]
  r_D_formicigenerans <- flat_params[["D._formicigenerans.r"]]
  K_D_formicigenerans <- flat_params[["D._formicigenerans.K"]]
  r_E_coli <- flat_params[["E._coli.r"]]
  K_E_coli <- flat_params[["E._coli.K"]]
  r_E_lenta <- flat_params[["E._lenta.r"]]
  K_E_lenta <- flat_params[["E._lenta.K"]]
  r_E_rectale <- flat_params[["E._rectale.r"]]
  K_E_rectale <- flat_params[["E._rectale.K"]]
  r_F_nucleatum <- flat_params[["F._nucleatum.r"]]
  K_F_nucleatum <- flat_params[["F._nucleatum.K"]]
  r_P_copri <- flat_params[["P._copri.r"]]
  K_P_copri <- flat_params[["P._copri.K"]]
  r_P_merdae <- flat_params[["P._merdae.r"]]
  K_P_merdae <- flat_params[["P._merdae.K"]]
  r_R_gnavus <- flat_params[["R._gnavus.r"]]
  K_R_gnavus <- flat_params[["R._gnavus.K"]]
  r_R_intestinalis <- flat_params[["R._intestinalis.r"]]
  K_R_intestinalis <- flat_params[["R._intestinalis.K"]]
  r_V_parvula <- flat_params[["V._parvula.r"]]
  K_V_parvula <- flat_params[["V._parvula.K"]]
  r_A_muciniphila <- flat_params[["A._muciniphila.r"]]
  K_A_muciniphila <- flat_params[["A._muciniphila.K"]]
  r_B_adolescentis <- flat_params[["B._adolescentis.r"]]
  K_B_adolescentis <- flat_params[["B._adolescentis.K"]]
  r_B_obeum <- flat_params[["B._obeum.r"]]
  K_B_obeum <- flat_params[["B._obeum.K"]]
  r_O_splanchnicus <- flat_params[["O._splanchnicus.r"]]
  K_O_splanchnicus <- flat_params[["O._splanchnicus.K"]]
  r_P_distasonis <- flat_params[["P._distasonis.r"]]
  K_P_distasonis <- flat_params[["P._distasonis.K"]]
  r_R_bromii <- flat_params[["R._bromii.r"]]
  K_R_bromii <- flat_params[["R._bromii.K"]]
  r_R_torques <- flat_params[["R._torques.r"]]
  K_R_torques <- flat_params[["R._torques.K"]]
  r_S_parasanguinis <- flat_params[["S._parasanguinis.r"]]
  K_S_parasanguinis <-flat_params[["S._parasanguinis.K"]]
  r_S_salivarius <- flat_params[["S._salivarius.r"]]
  K_S_salivarius <- flat_params[["S._salivarius.K"]]
  r_L_paracasei <- flat_params[["L._paracasei.r"]]
  K_L_paracasei <- flat_params[["L._paracasei.K"]]
  
  
  t_mod <- ifelse(t > 24.1, t - 24.1, t)
  
  
  ## now code the model equations
  dA_muciniphila_dt <- r_A_muciniphila * A_muciniphila * (1 - A_muciniphila / K_A_muciniphila)
  dB_adolescentis_dt <- r_B_adolescentis * B_adolescentis * (1 - B_adolescentis / K_B_adolescentis)
  dB_fragilis_dt <- r_B_fragilis * B_fragilis * (1 - B_fragilis / max(0.0001, K_B_fragilis * (y_function_B_fragilis_Ketoconazole_func(Drug))))
  dB_longum_dt <- r_B_longum * B_longum * (1 - B_longum / K_B_longum)
  dB_obeum_dt <- r_B_obeum * B_obeum * (1 - B_obeum / K_B_obeum)
  dB_thetaiotaomicron_dt <- r_B_thetaiotaomicron * B_thetaiotaomicron * (1 - B_thetaiotaomicron / max(0.0001, K_B_thetaiotaomicron * (y_function_B_thetaiotaomicron_Ketoconazole_func(Drug))))  
  dB_uniformis_dt <- r_B_uniformis * B_uniformis * (1 - B_uniformis / max(0.0001, K_B_uniformis * (y_function_B_uniformis_Ketoconazole_func(Drug))))
  dB_vulgatus_dt <- r_B_vulgatus * B_vulgatus * (1 - B_vulgatus / max(0.0001, K_B_vulgatus * (y_function_B_vulgatus_Ketoconazole_func(Drug))))
  dB_wadsworthia_dt <- r_B_wadsworthia * B_wadsworthia * (1 - B_wadsworthia / K_B_wadsworthia)
  dC_aerofaciens_dt <- r_C_aerofaciens * C_aerofaciens * (1 - C_aerofaciens / max(0.0001, K_C_aerofaciens * (y_function_C_aerofaciens_Ketoconazole_func(Drug))))
  dC_bolteae_dt <- r_C_bolteae * C_bolteae * (1 - C_bolteae /  max(0.0001, K_C_bolteae * (y_function_C_bolteae_Ketoconazole_func(Drug))))
  dC_comes_dt <- r_C_comes * C_comes * (1 - C_comes / max(0.0001, K_C_comes * (y_function_C_comes_Ketoconazole_func(Drug))))
  dC_perfringens_dt <- r_C_perfringens * C_perfringens * (1 - C_perfringens / max(0.0001, K_C_perfringens * (y_function_C_perfringens_Ketoconazole_func(Drug))))
  dC_ramosum_dt <- r_C_ramosum * C_ramosum * (1 - C_ramosum / max(0.0001, K_C_ramosum * (y_function_C_ramosum_Ketoconazole_func(Drug))))
  dC_saccharolyticum_dt <- r_C_saccharolyticum * C_saccharolyticum * (1 - C_saccharolyticum / max(0.0001, K_C_saccharolyticum * (y_function_C_saccharolyticum_Ketoconazole_func(Drug))))
  dD_formicigenerans_dt <- r_D_formicigenerans * D_formicigenerans * (1 - D_formicigenerans / max(0.0001, K_D_formicigenerans * (y_function_D_formicigenerans_Ketoconazole_func(Drug))))
  dE_coli_dt <- r_E_coli * E_coli * (1 - E_coli / max(0.0001, K_E_coli * (y_function_E_coli_Ketoconazole_func(Drug))))
  dE_lenta_dt <- r_E_lenta * E_lenta * (1 - E_lenta / max(0.0001, K_E_lenta * (y_function_E_lenta_Ketoconazole_func(Drug))))
  dE_rectale_dt <- r_E_rectale * E_rectale * (1 - E_rectale / max(0.0001, K_E_rectale * (y_function_E_rectale_Ketoconazole_func(Drug))))
  dF_nucleatum_dt <- r_F_nucleatum * F_nucleatum * (1 - F_nucleatum / max(0.0001, K_F_nucleatum * (y_function_F_nucleatum_Ketoconazole_func(Drug))))
  dL_paracasei_dt <- r_L_paracasei * L_paracasei * (1 - L_paracasei / K_L_paracasei)  
  dO_splanchnicus_dt <- r_O_splanchnicus * O_splanchnicus * (1 - O_splanchnicus / K_O_splanchnicus)  
  dP_copri_dt <- r_P_copri * P_copri * (1 - P_copri / K_P_copri)
  dP_distasonis_dt <- r_P_distasonis * P_distasonis * (1 - P_distasonis / K_P_distasonis)  
  dP_merdae_dt <- r_P_merdae * P_merdae * (1 - P_merdae / max(0.0001, K_P_merdae * (y_function_P_merdae_Ketoconazole_func(Drug))))
  dR_bromii_dt <- r_R_bromii * R_bromii * (1 - R_bromii / K_R_bromii) 
  dR_gnavus_dt <- r_R_gnavus * R_gnavus * (1 - R_gnavus / max(0.0001, K_R_gnavus * (y_function_R_gnavus_Ketoconazole_func(Drug))))
  dR_intestinalis_dt <- r_R_intestinalis * R_intestinalis * (1 - R_intestinalis / max(0.0001, K_R_intestinalis * (y_function_R_intestinalis_Ketoconazole_func(Drug))))
  dR_torques_dt <- r_R_torques * R_torques * (1 - R_torques /K_R_torques) 
  dS_parasanguinis_dt <- r_S_parasanguinis * S_parasanguinis * (1 - S_parasanguinis / max(0.0001, K_S_parasanguinis * (y_function_S_parasanguinis_Ketoconazole_func(Drug))))
  dS_salivarius_dt <- r_S_salivarius * S_salivarius * (1 - S_salivarius / max(0.0001, K_S_salivarius * (y_function_S_salivarius_Ketoconazole_func(Drug))))
  dV_parvula_dt <- r_V_parvula * V_parvula * (1 - V_parvula / max(0.0001, K_V_parvula * (y_function_V_parvula_Ketoconazole_func(Drug))))
  
  
  
  #Drug differential:
  dDrug_dt <- (subset(drug_dynamics, Drug == "Ketoconazole")$Steepness_param_community * exp(-subset(drug_dynamics, Drug == "Ketoconazole")$Steepness_param_community * t_mod)) * (drug_concentration_tested * prop_left_Ketoconazole - drug_concentration_tested)
  #dDrug_dt <- 0
  
  ## Combine results into a single vector
  dxdt <- c(dA_muciniphila_dt, dB_adolescentis_dt, dB_fragilis_dt, dB_longum_dt, dB_obeum_dt, dB_thetaiotaomicron_dt, dB_uniformis_dt, dB_vulgatus_dt, dB_wadsworthia_dt, dC_aerofaciens_dt, dC_bolteae_dt, dC_comes_dt, dC_perfringens_dt, dC_ramosum_dt, dC_saccharolyticum_dt, dD_formicigenerans_dt, dE_coli_dt, dE_lenta_dt, dE_rectale_dt, dF_nucleatum_dt, dL_paracasei_dt, dO_splanchnicus_dt, dP_copri_dt, dP_distasonis_dt, dP_merdae_dt, dR_bromii_dt, dR_gnavus_dt, dR_intestinalis_dt, dR_torques_dt, dS_parasanguinis_dt, dS_salivarius_dt, dV_parvula_dt, dDrug_dt)
  
  ## Return result as a list
  list(dxdt)
}




#calculate the co-culture correction factor per species based on community composition in absence of drug, just like done for Niclosamide

growth_data_all_0_Niclosamide
growth_data_all_0_Niclosamide1 <- growth_data_all_0_Niclosamide %>%
  dplyr::mutate(Species = gsub(" ", "_", Species))


# Merge rel_ab_control with growth_data_all_0_Niclosamide on Species
# Function to remove duplicated columns by name pattern
clean_columns_base <- function(df, pattern) {
  cols_to_keep <- !grepl(pattern, names(df))
  df <- df[, cols_to_keep]
  return(df)
}

# Use the new function to clean up your dataframe
rel_ab_control <- clean_columns_base(rel_ab_control, "mean_max_OD.[xy]")
str(rel_ab_control)


#rel_ab_control$correction_factor <- rel_ab_control$mean_rel_ab / (rel_ab_control$mean_max_OD/sum(rel_ab_control$mean_max_OD))
# Calculate correction factor with a minimum value of ~1
rel_ab_control$correction_factor <- pmax(rel_ab_control$mean_rel_ab / (rel_ab_control$mean_max_OD / sum(rel_ab_control$mean_max_OD)), 1.1)


# Create a new dataframe for co-culture correction
co_culture_correction <- data.frame(
  species = rel_ab_control$Species,
  correction_factor = rel_ab_control$correction_factor
)


#summarise community data
#Adjust based on tested concentrations for each drug
unique(Community_compositions_focus_drugs_Ketoconazole$concentration)

Community_compositions_focus_drugs_Ketoconazole_5uM <- subset(Community_compositions_focus_drugs_Ketoconazole, concentration == 5)
Community_compositions_focus_drugs_Ketoconazole_20uM <- subset(Community_compositions_focus_drugs_Ketoconazole, concentration == 20)
Community_compositions_focus_drugs_Ketoconazole_80uM <- subset(Community_compositions_focus_drugs_Ketoconazole, concentration == 80)


#5 uM
Community_compositions_focus_drugs_Ketoconazole_5uM_summarised <- Community_compositions_focus_drugs_Ketoconazole_5uM %>%
  dplyr::group_by(species) %>%                                  
  dplyr::summarize(
    mean_rel_ab = mean(rel_abundance, na.rm = TRUE),     
    sd_rel_ab = sd(rel_abundance, na.rm = TRUE) ,
    mean_max_OD = mean(maxOD, na.rm = TRUE),
    sd_max_OD = sd(maxOD, na.rm = TRUE),
    mean_final_OD = mean(finalOD, na.rm = TRUE),
    sd_final_OD = sd(finalOD, na.rm = TRUE)
  ) %>%
  dplyr::ungroup() 


Community_compositions_focus_drugs_Ketoconazole_5uM_summarised <- Community_compositions_focus_drugs_Ketoconazole_5uM_summarised %>%
  dplyr::mutate(Species = sub("^(\\w)\\w*\\s(.*)", "\\1._\\2", species))

#remove (sub)strain info
Community_compositions_focus_drugs_Ketoconazole_5uM_summarised <- Community_compositions_focus_drugs_Ketoconazole_5uM_summarised %>%
  dplyr::mutate(Species = sub("^(\\w\\._\\w+).*", "\\1", Species))


#20 uM
Community_compositions_focus_drugs_Ketoconazole_20uM_summarised <- Community_compositions_focus_drugs_Ketoconazole_20uM %>%
  dplyr::group_by(species) %>%                                  
  dplyr::summarize(
    mean_rel_ab = mean(rel_abundance, na.rm = TRUE),     
    sd_rel_ab = sd(rel_abundance, na.rm = TRUE) ,
    mean_max_OD = mean(maxOD, na.rm = TRUE),
    sd_max_OD = sd(maxOD, na.rm = TRUE),
    mean_final_OD = mean(finalOD, na.rm = TRUE),
    sd_final_OD = sd(finalOD, na.rm = TRUE)
  ) %>%
  dplyr::ungroup() 


Community_compositions_focus_drugs_Ketoconazole_20uM_summarised <- Community_compositions_focus_drugs_Ketoconazole_20uM_summarised %>%
  dplyr::mutate(Species = sub("^(\\w)\\w*\\s(.*)", "\\1._\\2", species))

#remove (sub)strain info
Community_compositions_focus_drugs_Ketoconazole_20uM_summarised <- Community_compositions_focus_drugs_Ketoconazole_20uM_summarised %>%
  dplyr::mutate(Species = sub("^(\\w\\._\\w+).*", "\\1", Species))


#80 uM
Community_compositions_focus_drugs_Ketoconazole_80uM_summarised <- Community_compositions_focus_drugs_Ketoconazole_80uM %>%
  dplyr::group_by(species) %>%                                  
  dplyr::summarize(
    mean_rel_ab = mean(rel_abundance, na.rm = TRUE),     
    sd_rel_ab = sd(rel_abundance, na.rm = TRUE) ,
    mean_max_OD = mean(maxOD, na.rm = TRUE),
    sd_max_OD = sd(maxOD, na.rm = TRUE),    
    mean_final_OD = mean(finalOD, na.rm = TRUE),
    sd_final_OD = sd(finalOD, na.rm = TRUE)
  ) %>%
  dplyr::ungroup() 



Community_compositions_focus_drugs_Ketoconazole_80uM_summarised <- Community_compositions_focus_drugs_Ketoconazole_80uM_summarised %>%
  dplyr::mutate(Species = sub("^(\\w)\\w*\\s(.*)", "\\1._\\2", species))

#remove (sub)strain info
Community_compositions_focus_drugs_Ketoconazole_80uM_summarised <- Community_compositions_focus_drugs_Ketoconazole_80uM_summarised %>%
  dplyr::mutate(Species = sub("^(\\w\\._\\w+).*", "\\1", Species))


#Initialise data frames
sim_output <- data.frame()
input_params_list <- list() #Use a list to collect parameters for each simulation

#number of simulations
num_sims <- 250


for (i in 1:num_sims) {
  tryCatch({
    # generate model parameters
    set.seed(i) #set a different seed for each simulation for variation
    params <- lapply(1:nrow(growth_data_all_0_Niclosamide), function(idx) {
      species_params <- growth_data_all_0_Niclosamide[idx, ]
      list(
        r = rnorm(1, mean = species_params$mean_max_Growth_rate, sd = species_params$sd_max_Growth_rate),
        K = rnorm(1, mean = species_params$mean_max_OD, sd = species_params$sd_max_OD)
      )
    })
    names(params) <- gsub(" ", "_", growth_data_all_0_Niclosamide$Species)
    flat_params <- unlist(params)
    names(flat_params) <- gsub("\\.\\d$", "", names(flat_params))
    
    #replace spaces with underscores to match formatting
    co_culture_correction$species <- gsub(" ", "_", co_culture_correction$species, fixed = TRUE)
    
    #replace the species-specific K parameters extracted from monoculture growth data 
    #with drawn relative abundance values at Niclosamide = 0, scaled to K
    rel_ab_control$Species <- gsub(" ", "_", rel_ab_control$Species)
    
    #Initialise an empty vector to store drawn values
    drawn_values <- numeric(nrow(rel_ab_control))
    
    #draw values from their respective distributions
    for (k in 1:nrow(rel_ab_control)) {
      species_name <- rel_ab_control$Species[k]
      drawn_value <- rnorm(1, mean = rel_ab_control$mean_rel_ab[k], sd = rel_ab_control$sd_rel_ab[k])
      drawn_values[k] <- max(drawn_value, 0)  # Ensure no negative values
    }
    
    #Normalise drawn relative abundance values so they sum to 1 (to reflect a 'true' relative abundance distribution)
    #this is needed so when we convert the values into OD units by multiplying with the drawn community maxOD,
    # the sum of K_i parameters and the drawn K are equal
    normalised_values <- drawn_values / sum(drawn_values)
    
    #Pull community maxOD (K) at 0 drugs from respective normal distribution:
    K <- rnorm(n = 1, mean = rel_ab_control$mean_com_max_OD[1], sd = rel_ab_control$sd_com_max_OD[1])
    
    # Assign these normalised values to their respective species' .K parameters
    for (k in 1:nrow(rel_ab_control)) {
      species_name <- rel_ab_control$Species[k]
      k_index <- grep(paste0("^", species_name, "\\.K$"), names(flat_params))
      
      if (length(k_index) > 0) {
        old_value <- flat_params[k_index]
        flat_params[k_index] <- (normalised_values[k] + 0.0001) * K #add small value in case drawn K_i is 0, which would cause issues with the solver
        cat(sprintf("Updated %s from %f to %f using normalised value %f scaled by K %f\n", names(flat_params)[k_index], old_value, flat_params[k_index], normalised_values[k], K))
      }
    }
    
    #Accounting for variation in drug degradation by community, with standard deviation of end concentration (at 10h) around the fitted predicted (relative) end concentration at 24h
    #prop_left_Ketoconazole <- abs(rnorm(1, (subset(drug_dynamics, Drug == "Ketoconazole")$Prop_left_24h_community), (subset(drug_dynamics, Drug == "Ketoconazole")$SD_drug_community))) 
    #below, we account for measurement error rather than ecological drivers that lead to the variability of degradation at the final point measured 
    prop_left_Ketoconazole <- abs(rnorm(
      n = 1, 
      mean = subset(drug_dynamics, Drug == "Ketoconazole")$Prop_left_24h_community, 
      sd = ifelse(
        subset(drug_dynamics, Drug == "Ketoconazole")$SD_drug_community > subset(drug_dynamics, Drug == "Ketoconazole")$SD_drug_community_start, 
        subset(drug_dynamics, Drug == "Ketoconazole")$SD_drug_community - subset(drug_dynamics, Drug == "Ketoconazole")$SD_drug_community_start, 
        subset(drug_dynamics, Drug == "Ketoconazole")$SD_drug_community
      )
    ))
    
    
    #loop through each species in co_culture_correction
    for (j in 1:nrow(co_culture_correction)) {
      # Extract the species name and correction factor
      species_name <- co_culture_correction$species[j]
      correction_factor <- co_culture_correction$correction_factor[j]
      
      # Identify the corresponding growth rate parameter in flat_params
      #by matching the base species name (without .r)
      growth_rate_indices <- grep(paste0("^", species_name, "\\.r$"), names(flat_params))
      
      #take the growth rate parameter and apply the correction factor 
      for (index in growth_rate_indices) {
        flat_params[index] <- flat_params[index] * correction_factor
      }
    }
    
    flat_params
    # Store parameters for each simulation
    input_params_list[[i]] <- c(sim_ID = i, flat_params)
    
    # Run the model for the first 24-hour cycle
    solution_cycle_1 <- ode(y = initial_conditions, times = seq(from = 0, to = 24, by = 0.1), func = closed.sir.model_Ketoconazole, parms = flat_params,   method = "lsoda", rtol = 1e-6, atol = 1e-6)
    
    # Dilution and second cycle
    end_of_cycle_1 <- solution_cycle_1[nrow(solution_cycle_1), -1]
    initial_conditions_cycle_2 <- end_of_cycle_1 / 50
    #accounting for the drugs being added with the new growth cycle as well:
    initial_conditions_cycle_2[33] <- initial_conditions_cycle_2[33] + drug_concentration_tested
    solution_cycle_2 <- ode(y = initial_conditions_cycle_2, times = seq(from = 24, to = 48, by = 0.1), func = closed.sir.model_Ketoconazole, parms = flat_params,  method = "lsoda", rtol = 1e-6, atol = 1e-6)
    
    # Combine and format results
    combined_solution <- rbind(as.data.frame(solution_cycle_1), as.data.frame(solution_cycle_2)[-1,])
    combined_solution$sim_ID <- rep(i, nrow(combined_solution))
    combined_solution <- combined_solution %>%
      tidyr::gather(key = "Species", value = "Density", -time, -sim_ID) %>%
      dplyr::mutate(Hour = time) %>%
      dplyr::select(sim_ID, Hour, Species, Density)
    
    ##Append to sim_output
    sim_output <- rbind(sim_output, combined_solution)
  }, error = function(e) {
    cat(sprintf("Skipping simulation %d due to an error: %s\n", i, e$message))
  })
}



##Combine all parameter data into a single dataframe
input_params <- do.call(rbind, input_params_list)

# Add a "Species" column 
sim_output$Species_name <- species_names[as.numeric(as.character(sim_output$Species))]
sim_output$Species_name <- replace_na(sim_output$Species_name, "Drug")

#View(input_params)
#View(sim_output)

sim_output <- na.omit(sim_output)
successful_sim_ids <- unique(subset(sim_output, Hour == 48)$sim_ID)
length(successful_sim_ids)
sim_output1 <- sim_output[sim_output$sim_ID %in% successful_sim_ids, ]


#Transform sim_output so we have wide format by Species
sim_output_wide <- tidyr::pivot_wider(sim_output1, 
                                      names_from = Species_name, 
                                      values_from = Density,
                                      id_cols = c(sim_ID, Hour))

length(unique(sim_output_wide$sim_ID))
#calc community OD per timepoint
sim_output_wide$Total_OD <- rowSums(sim_output_wide[, 3:34], na.rm = TRUE)
#calculate and add relative abundances here as well:
species_columns <- colnames(sim_output_wide)[3:34] 

for (species in species_columns) {
  sim_output_wide[[paste0("rel_", species)]] <- sim_output_wide[[species]] / sim_output_wide$Total_OD
}


#assign sim_output_wide test conditions to dataframe name
drug_tested <- "Ketoconazole"
variable_name_1 <- paste0("sim_output_wide_", ifelse(drug_concentration_tested == 1e-04, 0, drug_concentration_tested), "_", drug_tested)
assign(variable_name_1, sim_output_wide)

#turn back into long format if interested in plotting relative abundances
cols_needed <- c("sim_ID", "Hour")

sim_output_long <- sim_output_wide %>% 
  dplyr::select(sim_ID, Hour, Drug, starts_with("rel_")) %>% 
  tidyr::pivot_longer(
    cols = c(Drug, starts_with("rel_")),
    names_to = "Species", 
    values_to = "Relative_abundance",
    names_prefix = "rel_",
    names_transform = list(Species = ~ ifelse(.x == "Drug", "Drug", .x))
  ) 

str(sim_output_long)


species_names_1 <- c(
  "A_muciniphila",
  "B_adolescentis",
  "B_fragilis",
  "B_longum",
  "B_obeum",
  "B_thetaiotaomicron",
  "B_uniformis",
  "B_vulgatus",
  "B_wadsworthia",
  "C_aerofaciens",
  "C_bolteae",
  "C_comes",
  "C_perfringens",
  "C_ramosum",
  "C_saccharolyticum",
  "D_formicigenerans",
  "E_coli",
  "E_lenta",
  "E_rectale",
  "F_nucleatum",
  "L_paracasei",
  "O_splanchnicus",
  "P_copri",
  "P_distasonis",
  "P_merdae",
  "R_bromii",
  "R_gnavus",
  "R_intestinalis",
  "R_torques",
  "S_parasanguinis",
  "S_salivarius",
  "V_parvula",
  "Drug"
)

species_colours_1 <- c(
  "A_muciniphila" = "#1f77b4",
  "B_adolescentis" = "#ff7f0e",
  "B_fragilis" = "#2ca02c",
  "B_longum" = "#d62728",
  "B_obeum" = "#9467bd",
  "B_thetaiotaomicron" = "black",
  "B_uniformis" = "#e377c2",
  "B_vulgatus" = "#7f7f7f",
  "B_wadsworthia" = "gold1",
  "C_aerofaciens" = "#aec7e8",
  "C_bolteae" = "#ffbb78",
  "C_comes" = "magenta",
  "C_perfringens" = "#ff9896",
  "C_ramosum" = "#c5b0d5",
  "C_saccharolyticum" = "#c49c94",
  "D_formicigenerans" = "#f7b6d2",
  "E_coli" = "yellow",
  "E_lenta" = "turquoise",
  "E_rectale" = "#393b79",
  "F_nucleatum" = "royalblue2",
  "L_paracasei" = "blue",
  "O_splanchnicus" = "#637939",
  "P_copri" = "cyan",
  "P_distasonis" = "#8c6d31",
  "P_merdae" = "#c7c7c7",
  "R_bromii" = "#e6550d",
  "R_gnavus" = "#e7cb94",
  "R_intestinalis" = "#843c39",
  "R_torques" = "#d6616b",
  "S_parasanguinis" = "orange3",
  "S_salivarius" = "#7b4173",
  "V_parvula" = "#ce6dbd",
  "Drug" = "green"
)



##Plot output for any specific sim:
# ggplot(subset(sim_output, sim_ID == 1 & Species_name != "Drug"), aes(x = Hour, y = Density, group = Species_name, color = Species_name)) +
#   geom_line(size = 1, alpha = 0.7) +
#   scale_color_manual(values = species_colours_1) +
#   labs(title = paste0("Ketoconazole = ", drug_concentration_tested),
#        x = "Time (hours)",
#        y = "Population Density (OD)",
#        color = "Species") +
#   theme_minimal() +
#   theme(legend.position = "right")
# 
# ggplot(subset(sim_output, sim_ID == 3 & Species_name != "Drug"), aes(x = Hour, y = Density, group = Species_name, color = Species_name)) +
#   geom_line(size = 1, alpha = 0.7) +
#   scale_color_manual(values = species_colours_1) +
#   labs(title = paste0("Ketoconazole = ", drug_concentration_tested),
#        x = "Time (hours)",
#        y = "Population Density (OD)",
#        color = "Species") +
#   theme_minimal() +
#   theme(legend.position = "right")


ggplot(subset(sim_output_long, sim_ID == 1), aes(x = Hour, y = Relative_abundance, group = Species, color = Species)) +
  geom_line(size = 1, alpha = 0.7) +
  scale_color_manual(values = species_colours_1) +
  labs(title = paste0("Ketoconazole = ", drug_concentration_tested),
       x = "Time (hours)",
       y = "Relative abundance",
       color = "Species") +
  theme_minimal() +
  theme(legend.position = "right")


ggplot(subset(sim_output_long, sim_ID == 3), aes(x = Hour, y = Relative_abundance, group = Species, color = Species)) +
  geom_line(size = 1, alpha = 0.7) +
  scale_color_manual(values = species_colours_1) +
  labs(title = paste0("Ketoconazole = ", drug_concentration_tested),
       x = "Time (hours)",
       y = "Relative abundance",
       color = "Species") +
  theme_minimal() +
  theme(legend.position = "right")


#calc mean and standard deviation across sims
sim_stats <- sim_output_long %>%
  dplyr::group_by(Hour, Species) %>%
  dplyr::summarise(
    mean_rel_ab = mean(Relative_abundance),
    sd_rel_ab = sd(Relative_abundance),
    .groups = 'drop'
  )

# Prepare the data for plotting
plot_data <- sim_stats %>%
  dplyr::mutate(Upper = mean_rel_ab + sd_rel_ab, Lower = mean_rel_ab - sd_rel_ab)

ggplot(subset(plot_data, Species != "Drug"), aes(x = Hour, y = mean_rel_ab, group = Species, color = Species)) +
  geom_ribbon(aes(ymin = Lower, ymax = Upper, fill = Species), colour = NA, alpha = 0.2) +  
  geom_line(size = 1, alpha = 0.7) + 
  scale_color_manual(values = species_colours_1) +
  scale_fill_manual(values = species_colours_1) +  
  labs(title = "Mean and SD of Relative Abundance Across Simulations",
       subtitle = paste0("Ketoconazole = ", drug_concentration_tested),       
       x = "Time (hours)",
       y = "Relative abundance",
       color = "Species",
       fill = "Species") +
  theme_minimal() +
  theme(legend.position = "right")

#log-scaled mean trends
ggplot(plot_data, aes(x = Hour, y = log10(mean_rel_ab + 0.0001), group = Species, color = Species)) +
  geom_line(size = 1, alpha = 0.7) +  # Mean line
  scale_color_manual(values = species_colours_1) +
  scale_fill_manual(values = species_colours_1) +  # Ensure consistent colors for lines and fills
  labs(title = "Mean and SD of Relative Abundance Across Simulations",
       subtitle = paste0("Ketoconazole = ", drug_concentration_tested),
       x = "Time (hours)",
       y = "Relative abundance",
       color = "Species",
       fill = "Species") +
  theme_minimal() +
  theme(legend.position = "right")




##prediction quality evaluation
drug_tested <- "Ketoconazole"
variable_name <- paste0("plot_data_", ifelse(drug_concentration_tested == 1e-04, 0, drug_concentration_tested), "_", drug_tested)
assign(variable_name, plot_data)


#extract total OD info:
predicted_mean_final_od_NULL <- Niclosamide_16S_0uM_summarised$mean_com_final_OD[1]
predicted_sd_final_od_NULL <- Niclosamide_16S_0uM_summarised$sd_com_final_OD[1]

predicted_mean_final_od_5_Ketoconazole <- mean(subset(sim_output_wide_5_Ketoconazole, Hour == 48)$Total_OD, na.rm = TRUE)
predicted_sd_final_od_5_Ketoconazole <- sd(subset(sim_output_wide_5_Ketoconazole, Hour == 48)$Total_OD, na.rm = TRUE)

real_mean_final_od_5_Ketoconazole <- Community_compositions_focus_drugs_Ketoconazole_5uM_summarised$mean_final_OD[1]
real_sd_final_od_5_Ketoconazole <- Community_compositions_focus_drugs_Ketoconazole_5uM_summarised$sd_final_OD[1]


predicted_mean_final_od_20_Ketoconazole <- mean(subset(sim_output_wide_20_Ketoconazole, Hour == 48)$Total_OD, na.rm = TRUE)
predicted_sd_final_od_20_Ketoconazole <- sd(subset(sim_output_wide_20_Ketoconazole, Hour == 48)$Total_OD, na.rm = TRUE)

real_mean_final_od_20_Ketoconazole <- Community_compositions_focus_drugs_Ketoconazole_20uM_summarised$mean_final_OD[1]
real_sd_final_od_20_Ketoconazole <- Community_compositions_focus_drugs_Ketoconazole_20uM_summarised$sd_final_OD[1]


predicted_mean_final_od_80_Ketoconazole <- mean(subset(sim_output_wide_80_Ketoconazole, Hour == 48)$Total_OD, na.rm = TRUE)
predicted_sd_final_od_80_Ketoconazole <- sd(subset(sim_output_wide_80_Ketoconazole, Hour == 48)$Total_OD, na.rm = TRUE)

real_mean_final_od_80_Ketoconazole <- Community_compositions_focus_drugs_Ketoconazole_80uM_summarised$mean_final_OD[1]
real_sd_final_od_80_Ketoconazole <- Community_compositions_focus_drugs_Ketoconazole_80uM_summarised$sd_final_OD[1]




#plot_data_0_Ketoconazole_endpoint was used to test model performance at 0 drugs
#plot_data_0_Ketoconazole_endpoint <- subset(plot_data_0_Ketoconazole, Hour == 48 & Species != "Drug")
plot_data_5_Ketoconazole_endpoint <- subset(plot_data_5_Ketoconazole, Hour == 48 & Species != "Drug")
plot_data_20_Ketoconazole_endpoint <- subset(plot_data_20_Ketoconazole, Hour == 48 & Species != "Drug")
plot_data_80_Ketoconazole_endpoint <- subset(plot_data_80_Ketoconazole, Hour == 48 & Species != "Drug")

##Inspecting 'match' to real relative abundance distributions:
Niclosamide_16S_0uM_summarised <- rel_ab_control
Niclosamide_16S_0uM_summarised$Species <- gsub("\\.", "", Niclosamide_16S_0uM_summarised$Species)

Ketoconazole_16S_5uM_summarised <- Community_compositions_focus_drugs_Ketoconazole_5uM_summarised
Ketoconazole_16S_20uM_summarised <- Community_compositions_focus_drugs_Ketoconazole_20uM_summarised
Ketoconazole_16S_80uM_summarised <- Community_compositions_focus_drugs_Ketoconazole_80uM_summarised

Niclosamide_16S_0uM_summarised
Ketoconazole_16S_5uM_summarised 
Ketoconazole_16S_20uM_summarised 
Ketoconazole_16S_80uM_summarised 

#Rename 'species' so the outputs become comparable
original_names_80 <- unique(Ketoconazole_16S_80uM_summarised$species)
original_names_20 <- unique(Ketoconazole_16S_20uM_summarised$species)
original_names_5 <- unique(Ketoconazole_16S_5uM_summarised$species)


##Create a named vector with the original and new names mapping
name_changes <- c(
  "Akkermansia muciniphila" = "A_muciniphila",
  "Bacteroides fragilis" = "B_fragilis",
  "Bacteroides thetaiotaomicron" = "B_thetaiotaomicron",
  "Bacteroides uniformis" = "B_uniformis",
  "Bifidobacterium adolescentis" = "B_adolescentis",
  "Bifidobacterium longum subsp. longum" = "B_longum",
  "Bilophila wadsworthia" = "B_wadsworthia",
  "Blautia obeum" = "B_obeum",
  "Clostridium perfringens" = "C_perfringens",
  "Collinsella aerofaciens" = "C_aerofaciens",
  "Coprococcus comes" = "C_comes",
  "Dorea formicigenerans" = "D_formicigenerans",
  "Eggerthella lenta" = "E_lenta",
  "Enterocloster bolteae" = "C_bolteae",
  "Erysipelatoclostridium ramosum" = "C_ramosum",
  "Escherichia coli ED1a" = "E_coli",
  "Eubacterium rectale" = "E_rectale",
  "Fusobacterium nucleatum subsp. nucleatum" = "F_nucleatum",
  "Lacrimispora saccharolytica" = "C_saccharolyticum",
  "Lacticaseibacillus paracasei" = "L_paracasei",
  "Odoribacter splanchnicus" = "O_splanchnicus",
  "Parabacteroides distasonis" = "P_distasonis",
  "Parabacteroides merdae" = "P_merdae",
  "Phocaeicola vulgatus" = "B_vulgatus",
  "Prevotella copri" = "P_copri",
  "Roseburia intestinalis" = "R_intestinalis",
  "Ruminococcus bromii" = "R_bromii",
  "Ruminococcus gnavus" = "R_gnavus",
  "Ruminococcus torques" = "R_torques",
  "Streptococcus parasanguinis" = "S_parasanguinis",
  "Streptococcus salivarius" = "S_salivarius",
  "Veillonella parvula" = "V_parvula"
)

# Apply name changes to the species column in Ketoconazole_16S_80uM_summarised

Ketoconazole_16S_80uM_summarised$Species <- name_changes[Ketoconazole_16S_80uM_summarised$species]
Ketoconazole_16S_20uM_summarised$Species <- name_changes[Ketoconazole_16S_20uM_summarised$species]
Ketoconazole_16S_5uM_summarised$Species <- name_changes[Ketoconazole_16S_5uM_summarised$species]

# Verify the changes
unique(Ketoconazole_16S_80uM_summarised$Species)
unique(Ketoconazole_16S_20uM_summarised$Species)
unique(Ketoconazole_16S_5uM_summarised$Species)



##First, for 5 uM:
# Get top 6 species from plot_data_5_endpoint
# Adjust the plot_data_5_endpoint with confidence bounds

# #plot_data_0_Ketoconazole_endpoint was used to test model performance at 0 drugs
# plot_data_0_Ketoconazole_endpoint <- plot_data_0_Ketoconazole_endpoint %>%
#   dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)

plot_data_5_Ketoconazole_endpoint <- plot_data_5_Ketoconazole_endpoint %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)

# Adjust the Ketoconazole_16S_5uM_summarised with confidence bounds
Ketoconazole_16S_5uM_summarised <- Ketoconazole_16S_5uM_summarised %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)

#NULL model:
Null_model_summarised <- Niclosamide_16S_0uM_summarised %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)


# Get top 6 species based on the lower bound from plot_data_5_endpoint

#top6_predicted_0_Ketoconazole was used to test model performance at 0 drugs
# top6_predicted_0_Ketoconazole <- plot_data_0_Ketoconazole_endpoint %>%
#    arrange(desc(lower_bound)) %>%
#    slice(1:6) %>%
#    pull(Species)

top6_predicted_5_Ketoconazole <- plot_data_5_Ketoconazole_endpoint %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

# Get top 6 species based on the lower bound from Ketoconazole_16S_5uM_summarised
top6_real_5_Ketoconazole <- Ketoconazole_16S_5uM_summarised %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

top6_NULL <- Null_model_summarised %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

# Calculate the overlap of top 6 species

#top_six_correct_0_Ketoconazole was used to assess model performance at 0 drugs
# top_six_correct_0_Ketoconazole <- length(intersect(top6_predicted_0_Ketoconazole, top6_NULL))
# top_six_correct_0_Ketoconazole

top_six_correct_5_Ketoconazole <- length(intersect(top6_predicted_5_Ketoconazole, top6_real_5_Ketoconazole))
top_six_correct_5_Ketoconazole

top_six_correct_5_Ketoconazole_NULL <- length(intersect(top6_NULL, top6_real_5_Ketoconazole))
top_six_correct_5_Ketoconazole_NULL

top6_predicted_5_Ketoconazole
top6_real_5_Ketoconazole

#top6_NULL

#Now by means:
# #top6_predicted_0_Ketoconazole_means was used to assess model performance at 0 drugs
# top6_predicted_0_Ketoconazole_means <- plot_data_0_Ketoconazole_endpoint %>%
#    arrange(desc(mean_rel_ab)) %>%
#    slice(1:6) %>%
#    pull(Species)

top6_predicted_5_Ketoconazole_means <- plot_data_5_Ketoconazole_endpoint %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)

# Get top 6 species based on the lower bound from Ketoconazole_16S_5uM_summarised
top6_real_5_Ketoconazole_means <- Ketoconazole_16S_5uM_summarised %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)

top6_NULL_means <- Null_model_summarised %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)


# #top_six_correct_0_Ketoconazole_means was used to assess model performance at 0 drugs
# top_six_correct_0_Ketoconazole_means <- length(intersect(top6_predicted_0_Ketoconazole_means, top6_NULL_means))
# top_six_correct_0_Ketoconazole_means

top_six_correct_5_Ketoconazole_means <- length(intersect(top6_predicted_5_Ketoconazole_means, top6_real_5_Ketoconazole_means))
top_six_correct_5_Ketoconazole_means

top_six_correct_5_Ketoconazole_means_NULL <- length(intersect(top6_NULL_means, top6_real_5_Ketoconazole_means))
top_six_correct_5_Ketoconazole_means_NULL

top6_predicted_5_Ketoconazole_means
top6_real_5_Ketoconazole_means

#top6_NULL_means


# Merge dataframes by Species

#merged_data_0_Ketoconazole was used to assess model performance at 0 drugs
#merged_data_0_Ketoconazole <- merge(plot_data_0_Ketoconazole_endpoint, Niclosamide_16S_0uM_summarised, by = "Species", suffixes = c(".pred", ".real"))
merged_data_5_Ketoconazole <- merge(plot_data_5_Ketoconazole_endpoint, Ketoconazole_16S_5uM_summarised, by = "Species", suffixes = c(".pred", ".real"))
merged_data_5_Ketoconazole_NULL <- merge(Niclosamide_16S_0uM_summarised, Ketoconazole_16S_5uM_summarised, by = "Species", suffixes = c(".null", ".real"))


## Below lines used for assessing model performance at 0 drugs; ignore for nonzero concentrations
# # Create lower and upper bounds considering mean ¬± sd
# merged_data_0_Ketoconazole$lower_bound_pred <- merged_data_0_Ketoconazole$mean_rel_ab.pred - merged_data_0_Ketoconazole$sd_rel_ab.pred
# merged_data_0_Ketoconazole$upper_bound_pred <- merged_data_0_Ketoconazole$mean_rel_ab.pred + merged_data_0_Ketoconazole$sd_rel_ab.pred
# merged_data_0_Ketoconazole$lower_bound_real <- merged_data_0_Ketoconazole$mean_rel_ab.real - merged_data_0_Ketoconazole$sd_rel_ab.real
# merged_data_0_Ketoconazole$upper_bound_real <- merged_data_0_Ketoconazole$mean_rel_ab.real + merged_data_0_Ketoconazole$sd_rel_ab.real
# 
# # Ensure lower and upper bounds are non-negative, adjusting as necessary
# merged_data_0_Ketoconazole$lower_bound_pred[merged_data_0_Ketoconazole$lower_bound_pred <= 0] <- 1e-10
# merged_data_0_Ketoconazole$lower_bound_real[merged_data_0_Ketoconazole$lower_bound_real <= 0] <- 1e-10
# merged_data_0_Ketoconazole$upper_bound_pred[merged_data_0_Ketoconazole$upper_bound_pred <= 0] <- 1e-10
# merged_data_0_Ketoconazole$upper_bound_real[merged_data_0_Ketoconazole$upper_bound_real <= 0] <- 1e-10


# Create lower and upper bounds considering mean ¬± sd
merged_data_5_Ketoconazole$lower_bound_pred <- merged_data_5_Ketoconazole$mean_rel_ab.pred - merged_data_5_Ketoconazole$sd_rel_ab.pred
merged_data_5_Ketoconazole$upper_bound_pred <- merged_data_5_Ketoconazole$mean_rel_ab.pred + merged_data_5_Ketoconazole$sd_rel_ab.pred
merged_data_5_Ketoconazole$lower_bound_real <- merged_data_5_Ketoconazole$mean_rel_ab.real - merged_data_5_Ketoconazole$sd_rel_ab.real
merged_data_5_Ketoconazole$upper_bound_real <- merged_data_5_Ketoconazole$mean_rel_ab.real + merged_data_5_Ketoconazole$sd_rel_ab.real

# Ensure lower and upper bounds are non-negative, adjusting as necessary
merged_data_5_Ketoconazole$lower_bound_pred[merged_data_5_Ketoconazole$lower_bound_pred <= 0] <- 1e-10
merged_data_5_Ketoconazole$lower_bound_real[merged_data_5_Ketoconazole$lower_bound_real <= 0] <- 1e-10
merged_data_5_Ketoconazole$upper_bound_pred[merged_data_5_Ketoconazole$upper_bound_pred <= 0] <- 1e-10
merged_data_5_Ketoconazole$upper_bound_real[merged_data_5_Ketoconazole$upper_bound_real <= 0] <- 1e-10

##and for NULL model:
# Create lower and upper bounds considering mean ¬± sd
merged_data_5_Ketoconazole_NULL$lower_bound_null <- merged_data_5_Ketoconazole_NULL$mean_rel_ab.null - merged_data_5_Ketoconazole_NULL$sd_rel_ab.null
merged_data_5_Ketoconazole_NULL$upper_bound_null <- merged_data_5_Ketoconazole_NULL$mean_rel_ab.null + merged_data_5_Ketoconazole_NULL$sd_rel_ab.null
merged_data_5_Ketoconazole_NULL$lower_bound_real <- merged_data_5_Ketoconazole_NULL$mean_rel_ab.real - merged_data_5_Ketoconazole_NULL$sd_rel_ab.real
merged_data_5_Ketoconazole_NULL$upper_bound_real <- merged_data_5_Ketoconazole_NULL$mean_rel_ab.real + merged_data_5_Ketoconazole_NULL$sd_rel_ab.real

# Ensure lower and upper bounds are non-negative, adjusting as necessary
merged_data_5_Ketoconazole_NULL$lower_bound_null[merged_data_5_Ketoconazole_NULL$lower_bound_null <= 0] <- 1e-10
merged_data_5_Ketoconazole_NULL$lower_bound_real[merged_data_5_Ketoconazole_NULL$lower_bound_real <= 0] <- 1e-10
merged_data_5_Ketoconazole_NULL$upper_bound_null[merged_data_5_Ketoconazole_NULL$upper_bound_null <= 0] <- 1e-10
merged_data_5_Ketoconazole_NULL$upper_bound_real[merged_data_5_Ketoconazole_NULL$upper_bound_real <= 0] <- 1e-10

# Filter to include only species with a mean relative abundance > 0.01 in the 'real' dataset

## significant_species_0 was used to assess model performance at 0 drugs
#significant_species_0 <- merged_data_0_Ketoconazole[merged_data_0_Ketoconazole$mean_rel_ab.real > 0.01, ]
significant_species <- merged_data_5_Ketoconazole[merged_data_5_Ketoconazole$mean_rel_ab.real > 0.01, ]
survivors_5_Ketoconazole <- nrow(significant_species)
survivors_5_Ketoconazole

#should be the same as survivors defined above, since it is calculated from .real
significant_species_NULL <- merged_data_5_Ketoconazole_NULL[merged_data_5_Ketoconazole_NULL$mean_rel_ab.real > 0.01, ]
survivors_5_Ketoconazole_NULL <- nrow(significant_species_NULL)
survivors_5_Ketoconazole_NULL

# Adjusted order of magnitude check to include SD, only for significant species
## below code was used to assess model performance at 0 drugs
# significant_species_0$Predicted_magnitude_correct <- ifelse(
#   (floor(log10(significant_species_0$lower_bound_pred)) <= floor(log10(significant_species_0$upper_bound_real)) &
#      floor(log10(significant_species_0$upper_bound_pred)) >= floor(log10(significant_species_0$lower_bound_real))),
#   1,
#   0
# )

significant_species$Predicted_magnitude_correct <- ifelse(
  (floor(log10(significant_species$lower_bound_pred)) <= floor(log10(significant_species$upper_bound_real)) &
     floor(log10(significant_species$upper_bound_pred)) >= floor(log10(significant_species$lower_bound_real))),
  1,
  0
)

#and for the Null model:
significant_species_NULL$Predicted_magnitude_correct <- ifelse(
  (floor(log10(significant_species_NULL$lower_bound_null)) <= floor(log10(significant_species_NULL$upper_bound_real)) &
     floor(log10(significant_species_NULL$upper_bound_null)) >= floor(log10(significant_species_NULL$lower_bound_real))),
  1,
  0
)

# Calculate the fraction of correctly predicted magnitudes for significant species
## below code was used to assess model performance at 0 drugs
#predicted_magnitude_correct_fraction_0_Ketoconazole <- sum(significant_species_0$Predicted_magnitude_correct) / nrow(significant_species_0)
#predicted_magnitude_correct_fraction_0_Ketoconazole

predicted_magnitude_correct_fraction_5_Ketoconazole <- sum(significant_species$Predicted_magnitude_correct) / nrow(significant_species)
predicted_magnitude_correct_fraction_5_Ketoconazole

predicted_magnitude_correct_fraction_5_Ketoconazole_NULL <- sum(significant_species_NULL$Predicted_magnitude_correct) / nrow(significant_species_NULL)
predicted_magnitude_correct_fraction_5_Ketoconazole_NULL

top_species_missing_5_Ketoconazole <- setdiff(top6_real_5_Ketoconazole_means, top6_predicted_5_Ketoconazole_means)
top_species_wrong_5_Ketoconazole <- setdiff(top6_predicted_5_Ketoconazole_means, top6_real_5_Ketoconazole_means)

top_species_missing_5_Ketoconazole <- if(length(top_species_missing_5_Ketoconazole) == 0) "None" else top_species_missing_5_Ketoconazole
top_species_wrong_5_Ketoconazole <- if(length(top_species_wrong_5_Ketoconazole) == 0) "None" else top_species_wrong_5_Ketoconazole

Prediction_quality_5_Ketoconazole <- data.frame(
  Top_six_correct = paste(top_six_correct_5_Ketoconazole, sep=""),
  Top_six_correct_NULL = paste(top_six_correct_5_Ketoconazole_NULL, sep=""),
  Top_six_correct_means = paste(top_six_correct_5_Ketoconazole_means, sep=""),
  Top_six_correct_means_NULL = paste(top_six_correct_5_Ketoconazole_means_NULL, sep=""),
  Predicted_magnitude_correct = paste(round(predicted_magnitude_correct_fraction_5_Ketoconazole * 100, 2), "%", sep=""),
  Predicted_magnitude_correct_NULL = paste(round(predicted_magnitude_correct_fraction_5_Ketoconazole_NULL * 100, 2), "%", sep=""),
  survivors_total = survivors_5_Ketoconazole,
  top_species_missing <- top_species_missing_5_Ketoconazole,
  top_species_wrong <- top_species_wrong_5_Ketoconazole, 
  predicted_mean_final_OD <- predicted_mean_final_od_5_Ketoconazole,
  real_mean_final_OD <- real_mean_final_od_5_Ketoconazole,
  sims_total = length(successful_sim_ids)
)



Prediction_quality_5_Ketoconazole



##Next, for 20 uM:
# Get top 6 species from plot_data_20_endpoint
# Adjust the plot_data_20_endpoint with confidence bounds
plot_data_20_Ketoconazole_endpoint <- plot_data_20_Ketoconazole_endpoint %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)

# Adjust the Ketoconazole_16S_20uM_summarised with confidence bounds
Ketoconazole_16S_20uM_summarised <- Ketoconazole_16S_20uM_summarised %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)

#NULL model:
Null_model_summarised <- Niclosamide_16S_0uM_summarised %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)


# Get top 6 species based on the lower bound from plot_data_20_endpoint
top6_predicted_20_Ketoconazole <- plot_data_20_Ketoconazole_endpoint %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

# Get top 6 species based on the lower bound from Ketoconazole_16S_20uM_summarised
top6_real_20_Ketoconazole <- Ketoconazole_16S_20uM_summarised %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

top6_NULL <- Null_model_summarised %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

# Calculate the overlap of top 6 species
top_six_correct_20_Ketoconazole <- length(intersect(top6_predicted_20_Ketoconazole, top6_real_20_Ketoconazole))
#top_six_correct_20_Ketoconazole

top_six_correct_20_Ketoconazole_NULL <- length(intersect(top6_NULL, top6_real_20_Ketoconazole))
#top_six_correct_20_Ketoconazole_NULL

#top6_predicted_20_Ketoconazole
#top6_real_20_Ketoconazole



#Now by means:
top6_predicted_20_Ketoconazole_means <- plot_data_20_Ketoconazole_endpoint %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)

# Get top 6 species based on the lower bound from Ketoconazole_16S_20uM_summarised
top6_real_20_Ketoconazole_means <- Ketoconazole_16S_20uM_summarised %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)

top6_NULL_means <- Null_model_summarised %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)



top_six_correct_20_Ketoconazole_means <- length(intersect(top6_predicted_20_Ketoconazole_means, top6_real_20_Ketoconazole_means))
#top_six_correct_20_Ketoconazole_means

top_six_correct_20_Ketoconazole_means_NULL <- length(intersect(top6_NULL_means, top6_real_20_Ketoconazole_means))
#top_six_correct_20_Ketoconazole_means_NULL

top6_predicted_20_Ketoconazole_means
#top6_real_20_Ketoconazole_means




# Merge dataframes by Species
merged_data_20_Ketoconazole <- merge(plot_data_20_Ketoconazole_endpoint, Ketoconazole_16S_20uM_summarised, by = "Species", suffixes = c(".pred", ".real"))
merged_data_20_Ketoconazole_NULL <- merge(Niclosamide_16S_0uM_summarised, Ketoconazole_16S_20uM_summarised, by = "Species", suffixes = c(".null", ".real"))



# Create lower and upper bounds considering mean ¬± sd
merged_data_20_Ketoconazole$lower_bound_pred <- merged_data_20_Ketoconazole$mean_rel_ab.pred - merged_data_20_Ketoconazole$sd_rel_ab.pred
merged_data_20_Ketoconazole$upper_bound_pred <- merged_data_20_Ketoconazole$mean_rel_ab.pred + merged_data_20_Ketoconazole$sd_rel_ab.pred
merged_data_20_Ketoconazole$lower_bound_real <- merged_data_20_Ketoconazole$mean_rel_ab.real - merged_data_20_Ketoconazole$sd_rel_ab.real
merged_data_20_Ketoconazole$upper_bound_real <- merged_data_20_Ketoconazole$mean_rel_ab.real + merged_data_20_Ketoconazole$sd_rel_ab.real

# Ensure lower and upper bounds are non-negative, adjusting as necessary
merged_data_20_Ketoconazole$lower_bound_pred[merged_data_20_Ketoconazole$lower_bound_pred <= 0] <- 1e-10
merged_data_20_Ketoconazole$lower_bound_real[merged_data_20_Ketoconazole$lower_bound_real <= 0] <- 1e-10
merged_data_20_Ketoconazole$upper_bound_pred[merged_data_20_Ketoconazole$upper_bound_pred <= 0] <- 1e-10
merged_data_20_Ketoconazole$upper_bound_real[merged_data_20_Ketoconazole$upper_bound_real <= 0] <- 1e-10

##and for NULL model:
# Create lower and upper bounds considering mean ¬± sd
merged_data_20_Ketoconazole_NULL$lower_bound_null <- merged_data_20_Ketoconazole_NULL$mean_rel_ab.null - merged_data_20_Ketoconazole_NULL$sd_rel_ab.null
merged_data_20_Ketoconazole_NULL$upper_bound_null <- merged_data_20_Ketoconazole_NULL$mean_rel_ab.null + merged_data_20_Ketoconazole_NULL$sd_rel_ab.null
merged_data_20_Ketoconazole_NULL$lower_bound_real <- merged_data_20_Ketoconazole_NULL$mean_rel_ab.real - merged_data_20_Ketoconazole_NULL$sd_rel_ab.real
merged_data_20_Ketoconazole_NULL$upper_bound_real <- merged_data_20_Ketoconazole_NULL$mean_rel_ab.real + merged_data_20_Ketoconazole_NULL$sd_rel_ab.real

# Ensure lower and upper bounds are non-negative, adjusting as necessary
merged_data_20_Ketoconazole_NULL$lower_bound_null[merged_data_20_Ketoconazole_NULL$lower_bound_null <= 0] <- 1e-10
merged_data_20_Ketoconazole_NULL$lower_bound_real[merged_data_20_Ketoconazole_NULL$lower_bound_real <= 0] <- 1e-10
merged_data_20_Ketoconazole_NULL$upper_bound_null[merged_data_20_Ketoconazole_NULL$upper_bound_null <= 0] <- 1e-10
merged_data_20_Ketoconazole_NULL$upper_bound_real[merged_data_20_Ketoconazole_NULL$upper_bound_real <= 0] <- 1e-10

# Filter to include only species with a mean relative abundance > 0.01 in the 'real' dataset
significant_species <- merged_data_20_Ketoconazole[merged_data_20_Ketoconazole$mean_rel_ab.real > 0.01, ]
survivors_20_Ketoconazole <- nrow(significant_species)
survivors_20_Ketoconazole

#should be the same as survivors defined above, since it is calculated from .real
significant_species_NULL <- merged_data_20_Ketoconazole_NULL[merged_data_20_Ketoconazole_NULL$mean_rel_ab.real > 0.01, ]
survivors_20_Ketoconazole_NULL <- nrow(significant_species_NULL)
survivors_20_Ketoconazole_NULL

# Adjusted order of magnitude check to include SD, only for significant species
significant_species$Predicted_magnitude_correct <- ifelse(
  (floor(log10(significant_species$lower_bound_pred)) <= floor(log10(significant_species$upper_bound_real)) &
     floor(log10(significant_species$upper_bound_pred)) >= floor(log10(significant_species$lower_bound_real))),
  1,
  0
)

#and for the Null model:
significant_species_NULL$Predicted_magnitude_correct <- ifelse(
  (floor(log10(significant_species_NULL$lower_bound_null)) <= floor(log10(significant_species_NULL$upper_bound_real)) &
     floor(log10(significant_species_NULL$upper_bound_null)) >= floor(log10(significant_species_NULL$lower_bound_real))),
  1,
  0
)

# Calculate the fraction of correctly predicted magnitudes for significant species
predicted_magnitude_correct_fraction_20_Ketoconazole <- sum(significant_species$Predicted_magnitude_correct) / nrow(significant_species)
predicted_magnitude_correct_fraction_20_Ketoconazole

predicted_magnitude_correct_fraction_20_Ketoconazole_NULL <- sum(significant_species_NULL$Predicted_magnitude_correct) / nrow(significant_species_NULL)
predicted_magnitude_correct_fraction_20_Ketoconazole_NULL

top_species_missing_20_Ketoconazole <- setdiff(top6_real_20_Ketoconazole_means, top6_predicted_20_Ketoconazole_means)
top_species_wrong_20_Ketoconazole <- setdiff(top6_predicted_20_Ketoconazole_means, top6_real_20_Ketoconazole_means)

Prediction_quality_20_Ketoconazole <- data.frame(
  Top_six_correct = paste(top_six_correct_20_Ketoconazole, sep=""),
  Top_six_correct_NULL = paste(top_six_correct_20_Ketoconazole_NULL, sep=""),
  Top_six_correct_means = paste(top_six_correct_20_Ketoconazole_means, sep=""),
  Top_six_correct_means_NULL = paste(top_six_correct_20_Ketoconazole_means_NULL, sep=""),
  Predicted_magnitude_correct = paste(round(predicted_magnitude_correct_fraction_20_Ketoconazole * 100, 2), "%", sep=""),
  Predicted_magnitude_correct_NULL = paste(round(predicted_magnitude_correct_fraction_20_Ketoconazole_NULL * 100, 2), "%", sep=""),
  survivors_total = survivors_20_Ketoconazole,
  top_species_missing <- top_species_missing_20_Ketoconazole,
  top_species_wrong <- top_species_wrong_20_Ketoconazole, 
  predicted_mean_final_OD <- predicted_mean_final_od_20_Ketoconazole,
  real_mean_final_OD <- real_mean_final_od_20_Ketoconazole,
  sims_total = length(successful_sim_ids)
)

Prediction_quality_20_Ketoconazole






##Next, for 80 uM:
# Get top 6 species from plot_data_80_endpoint
# Adjust the plot_data_80_endpoint with confidence bounds
plot_data_80_Ketoconazole_endpoint <- plot_data_80_Ketoconazole_endpoint %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)

# Adjust the Ketoconazole_16S_80uM_summarised with confidence bounds
Ketoconazole_16S_80uM_summarised <- Ketoconazole_16S_80uM_summarised %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)

#NULL model:
Null_model_summarised <- Niclosamide_16S_0uM_summarised %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)


# Get top 6 species based on the lower bound from plot_data_80_endpoint
top6_predicted_80_Ketoconazole <- plot_data_80_Ketoconazole_endpoint %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

# Get top 6 species based on the lower bound from Ketoconazole_16S_80uM_summarised
top6_real_80_Ketoconazole <- Ketoconazole_16S_80uM_summarised %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

top6_NULL <- Null_model_summarised %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

# Calculate the overlap of top 6 species
top_six_correct_80_Ketoconazole <- length(intersect(top6_predicted_80_Ketoconazole, top6_real_80_Ketoconazole))
#top_six_correct_80_Ketoconazole

top_six_correct_80_Ketoconazole_NULL <- length(intersect(top6_NULL, top6_real_80_Ketoconazole))
#top_six_correct_80_Ketoconazole_NULL

#top6_predicted_80_Ketoconazole
#top6_real_80_Ketoconazole




#Now by means:
top6_predicted_80_Ketoconazole_means <- plot_data_80_Ketoconazole_endpoint %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)

# Get top 6 species based on the lower bound from Ketoconazole_16S_80uM_summarised
top6_real_80_Ketoconazole_means <- Ketoconazole_16S_80uM_summarised %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)

top6_NULL_means <- Null_model_summarised %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)



top_six_correct_80_Ketoconazole_means <- length(intersect(top6_predicted_80_Ketoconazole_means, top6_real_80_Ketoconazole_means))
#top_six_correct_80_Ketoconazole_means

top_six_correct_80_Ketoconazole_means_NULL <- length(intersect(top6_NULL_means, top6_real_80_Ketoconazole_means))
#top_six_correct_80_Ketoconazole_means_NULL

#top6_predicted_80_Ketoconazole_means
#top6_real_80_Ketoconazole_means




# Merge dataframes by Species
merged_data_80_Ketoconazole <- merge(plot_data_80_Ketoconazole_endpoint, Ketoconazole_16S_80uM_summarised, by = "Species", suffixes = c(".pred", ".real"))
merged_data_80_Ketoconazole_NULL <- merge(Niclosamide_16S_0uM_summarised, Ketoconazole_16S_80uM_summarised, by = "Species", suffixes = c(".null", ".real"))



# Create lower and upper bounds considering mean ¬± sd
merged_data_80_Ketoconazole$lower_bound_pred <- merged_data_80_Ketoconazole$mean_rel_ab.pred - merged_data_80_Ketoconazole$sd_rel_ab.pred
merged_data_80_Ketoconazole$upper_bound_pred <- merged_data_80_Ketoconazole$mean_rel_ab.pred + merged_data_80_Ketoconazole$sd_rel_ab.pred
merged_data_80_Ketoconazole$lower_bound_real <- merged_data_80_Ketoconazole$mean_rel_ab.real - merged_data_80_Ketoconazole$sd_rel_ab.real
merged_data_80_Ketoconazole$upper_bound_real <- merged_data_80_Ketoconazole$mean_rel_ab.real + merged_data_80_Ketoconazole$sd_rel_ab.real

# Ensure lower and upper bounds are non-negative, adjusting as necessary
merged_data_80_Ketoconazole$lower_bound_pred[merged_data_80_Ketoconazole$lower_bound_pred <= 0] <- 1e-10
merged_data_80_Ketoconazole$lower_bound_real[merged_data_80_Ketoconazole$lower_bound_real <= 0] <- 1e-10
merged_data_80_Ketoconazole$upper_bound_pred[merged_data_80_Ketoconazole$upper_bound_pred <= 0] <- 1e-10
merged_data_80_Ketoconazole$upper_bound_real[merged_data_80_Ketoconazole$upper_bound_real <= 0] <- 1e-10

##and for NULL model:
# Create lower and upper bounds considering mean ¬± sd
merged_data_80_Ketoconazole_NULL$lower_bound_null <- merged_data_80_Ketoconazole_NULL$mean_rel_ab.null - merged_data_80_Ketoconazole_NULL$sd_rel_ab.null
merged_data_80_Ketoconazole_NULL$upper_bound_null <- merged_data_80_Ketoconazole_NULL$mean_rel_ab.null + merged_data_80_Ketoconazole_NULL$sd_rel_ab.null
merged_data_80_Ketoconazole_NULL$lower_bound_real <- merged_data_80_Ketoconazole_NULL$mean_rel_ab.real - merged_data_80_Ketoconazole_NULL$sd_rel_ab.real
merged_data_80_Ketoconazole_NULL$upper_bound_real <- merged_data_80_Ketoconazole_NULL$mean_rel_ab.real + merged_data_80_Ketoconazole_NULL$sd_rel_ab.real

# Ensure lower and upper bounds are non-negative, adjusting as necessary
merged_data_80_Ketoconazole_NULL$lower_bound_null[merged_data_80_Ketoconazole_NULL$lower_bound_null <= 0] <- 1e-10
merged_data_80_Ketoconazole_NULL$lower_bound_real[merged_data_80_Ketoconazole_NULL$lower_bound_real <= 0] <- 1e-10
merged_data_80_Ketoconazole_NULL$upper_bound_null[merged_data_80_Ketoconazole_NULL$upper_bound_null <= 0] <- 1e-10
merged_data_80_Ketoconazole_NULL$upper_bound_real[merged_data_80_Ketoconazole_NULL$upper_bound_real <= 0] <- 1e-10

# Filter to include only species with a mean relative abundance > 0.01 in the 'real' dataset
significant_species <- merged_data_80_Ketoconazole[merged_data_80_Ketoconazole$mean_rel_ab.real > 0.01, ]
survivors_80_Ketoconazole <- nrow(significant_species)
survivors_80_Ketoconazole

#should be the same as survivors defined above, since it is calculated from .real
significant_species_NULL <- merged_data_80_Ketoconazole_NULL[merged_data_80_Ketoconazole_NULL$mean_rel_ab.real > 0.01, ]
survivors_80_Ketoconazole_NULL <- nrow(significant_species_NULL)
survivors_80_Ketoconazole_NULL

# Adjusted order of magnitude check to include SD, only for significant species
significant_species$Predicted_magnitude_correct <- ifelse(
  (floor(log10(significant_species$lower_bound_pred)) <= floor(log10(significant_species$upper_bound_real)) &
     floor(log10(significant_species$upper_bound_pred)) >= floor(log10(significant_species$lower_bound_real))),
  1,
  0
)

#and for the Null model:
significant_species_NULL$Predicted_magnitude_correct <- ifelse(
  (floor(log10(significant_species_NULL$lower_bound_null)) <= floor(log10(significant_species_NULL$upper_bound_real)) &
     floor(log10(significant_species_NULL$upper_bound_null)) >= floor(log10(significant_species_NULL$lower_bound_real))),
  1,
  0
)

# Calculate the fraction of correctly predicted magnitudes for significant species
predicted_magnitude_correct_fraction_80_Ketoconazole <- sum(significant_species$Predicted_magnitude_correct) / nrow(significant_species)
predicted_magnitude_correct_fraction_80_Ketoconazole

predicted_magnitude_correct_fraction_80_Ketoconazole_NULL <- sum(significant_species_NULL$Predicted_magnitude_correct) / nrow(significant_species_NULL)
predicted_magnitude_correct_fraction_80_Ketoconazole_NULL


top_species_missing_80_Ketoconazole <- setdiff(top6_real_80_Ketoconazole_means, top6_predicted_80_Ketoconazole_means)
top_species_wrong_80_Ketoconazole <- setdiff(top6_predicted_80_Ketoconazole_means, top6_real_80_Ketoconazole_means)

Prediction_quality_80_Ketoconazole <- data.frame(
  Top_six_correct = paste(top_six_correct_80_Ketoconazole, sep=""),
  Top_six_correct_NULL = paste(top_six_correct_80_Ketoconazole_NULL, sep=""),
  Top_six_correct_means = paste(top_six_correct_80_Ketoconazole_means, sep=""),
  Top_six_correct_means_NULL = paste(top_six_correct_80_Ketoconazole_means_NULL, sep=""),
  Predicted_magnitude_correct = paste(round(predicted_magnitude_correct_fraction_80_Ketoconazole * 100, 2), "%", sep=""),
  Predicted_magnitude_correct_NULL = paste(round(predicted_magnitude_correct_fraction_80_Ketoconazole_NULL * 100, 2), "%", sep=""),
  survivors_total = survivors_80_Ketoconazole,
  top_species_missing <- top_species_missing_80_Ketoconazole,
  top_species_wrong <- top_species_wrong_80_Ketoconazole, 
  predicted_mean_final_OD <- predicted_mean_final_od_80_Ketoconazole,
  real_mean_final_OD <- real_mean_final_od_80_Ketoconazole,
  sims_total = length(successful_sim_ids)
)

Prediction_quality_80_Ketoconazole










##Lansoprazole

combined_monoculture_aucs2_Lansoprazole <- subset(combined_monoculture_aucs2, drug == "Lansoprazole")


#drug sensitivity terms: define once outside of ODEs
y_function_B_vulgatus_Lansoprazole <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("B_vulgatus", "Lansoprazole", best_fitting_models_df_Lansoprazole)), collapse = " ")))
y_function_B_uniformis_Lansoprazole <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("B_uniformis", "Lansoprazole", best_fitting_models_df_Lansoprazole)), collapse = " ")))
y_function_B_fragilis_Lansoprazole <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("B_fragilis", "Lansoprazole", best_fitting_models_df_Lansoprazole)), collapse = " ")))
y_function_B_thetaiotaomicron_Lansoprazole <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("B_thetaiotaomicron", "Lansoprazole", best_fitting_models_df_Lansoprazole)), collapse = " ")))
y_function_C_ramosum_Lansoprazole <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("C_ramosum", "Lansoprazole", best_fitting_models_df_Lansoprazole)), collapse = " ")))
y_function_E_rectale_Lansoprazole <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("E_rectale", "Lansoprazole", best_fitting_models_df_Lansoprazole)), collapse = " ")))
y_function_R_intestinalis_Lansoprazole <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("R_intestinalis", "Lansoprazole", best_fitting_models_df_Lansoprazole)), collapse = " ")))
y_function_V_parvula_Lansoprazole <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("V_parvula", "Lansoprazole", best_fitting_models_df_Lansoprazole)), collapse = " ")))
y_function_E_lenta_Lansoprazole <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("E_lenta", "Lansoprazole", best_fitting_models_df_Lansoprazole)), collapse = " ")))
y_function_F_nucleatum_Lansoprazole <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("F_nucleatum", "Lansoprazole", best_fitting_models_df_Lansoprazole)), collapse = " ")))
y_function_C_bolteae_Lansoprazole <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("C_bolteae", "Lansoprazole", best_fitting_models_df_Lansoprazole)), collapse = " ")))
y_function_C_perfringens_Lansoprazole <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("C_perfringens", "Lansoprazole", best_fitting_models_df_Lansoprazole)), collapse = " ")))
y_function_C_saccharolyticum_Lansoprazole <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("C_saccharolyticum", "Lansoprazole", best_fitting_models_df_Lansoprazole)), collapse = " ")))
y_function_S_salivarius_Lansoprazole <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("S_salivarius", "Lansoprazole", best_fitting_models_df_Lansoprazole)), collapse = " ")))
y_function_R_gnavus_Lansoprazole <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("R_gnavus", "Lansoprazole", best_fitting_models_df_Lansoprazole)), collapse = " ")))
y_function_C_comes_Lansoprazole <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("C_comes", "Lansoprazole", best_fitting_models_df_Lansoprazole)), collapse = " ")))
y_function_P_merdae_Lansoprazole <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("P_merdae", "Lansoprazole", best_fitting_models_df_Lansoprazole)), collapse = " ")))
y_function_S_parasanguinis_Lansoprazole <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("S_parasanguinis", "Lansoprazole", best_fitting_models_df_Lansoprazole)), collapse = " ")))
y_function_C_aerofaciens_Lansoprazole <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("C_aerofaciens", "Lansoprazole", best_fitting_models_df_Lansoprazole)), collapse = " ")))
y_function_D_formicigenerans_Lansoprazole <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("D_formicigenerans", "Lansoprazole", best_fitting_models_df_Lansoprazole)), collapse = " ")))
y_function_E_coli_Lansoprazole <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("E_coli", "Lansoprazole", best_fitting_models_df_Lansoprazole)), collapse = " ")))



y_function_B_vulgatus_Lansoprazole_func <- eval(parse(text = paste("function(Drug) {", y_function_B_vulgatus_Lansoprazole, "}")))
y_function_B_uniformis_Lansoprazole_func <- eval(parse(text = paste("function(Drug) {", y_function_B_uniformis_Lansoprazole, "}")))
y_function_B_fragilis_Lansoprazole_func <- eval(parse(text = paste("function(Drug) {", y_function_B_fragilis_Lansoprazole, "}")))
y_function_B_thetaiotaomicron_Lansoprazole_func <- eval(parse(text = paste("function(Drug) {", y_function_B_thetaiotaomicron_Lansoprazole, "}")))
y_function_C_ramosum_Lansoprazole_func <- eval(parse(text = paste("function(Drug) {", y_function_C_ramosum_Lansoprazole, "}")))
y_function_E_rectale_Lansoprazole_func <- eval(parse(text = paste("function(Drug) {", y_function_E_rectale_Lansoprazole, "}")))
y_function_R_intestinalis_Lansoprazole_func <- eval(parse(text = paste("function(Drug) {", y_function_R_intestinalis_Lansoprazole, "}")))
y_function_E_lenta_Lansoprazole_func <- eval(parse(text = paste("function(Drug) {", y_function_E_lenta_Lansoprazole, "}")))
y_function_F_nucleatum_Lansoprazole_func <- eval(parse(text = paste("function(Drug) {", y_function_F_nucleatum_Lansoprazole, "}")))
y_function_C_bolteae_Lansoprazole_func <- eval(parse(text = paste("function(Drug) {", y_function_C_bolteae_Lansoprazole, "}")))
y_function_C_perfringens_Lansoprazole_func <- eval(parse(text = paste("function(Drug) {", y_function_C_perfringens_Lansoprazole, "}")))
y_function_C_saccharolyticum_Lansoprazole_func <- eval(parse(text = paste("function(Drug) {", y_function_C_saccharolyticum_Lansoprazole, "}")))
y_function_S_salivarius_Lansoprazole_func <- eval(parse(text = paste("function(Drug) {", y_function_S_salivarius_Lansoprazole, "}")))
y_function_R_gnavus_Lansoprazole_func <- eval(parse(text = paste("function(Drug) {", y_function_R_gnavus_Lansoprazole, "}")))
y_function_C_comes_Lansoprazole_func <- eval(parse(text = paste("function(Drug) {", y_function_C_comes_Lansoprazole, "}")))
y_function_P_merdae_Lansoprazole_func <- eval(parse(text = paste("function(Drug) {", y_function_P_merdae_Lansoprazole, "}")))
y_function_S_parasanguinis_Lansoprazole_func <- eval(parse(text = paste("function(Drug) {", y_function_S_parasanguinis_Lansoprazole, "}")))
y_function_C_aerofaciens_Lansoprazole_func <- eval(parse(text = paste("function(Drug) {", y_function_C_aerofaciens_Lansoprazole, "}")))
y_function_D_formicigenerans_Lansoprazole_func <- eval(parse(text = paste("function(Drug) {", y_function_D_formicigenerans_Lansoprazole, "}")))
y_function_E_coli_Lansoprazole_func <- eval(parse(text = paste("function(Drug) {", y_function_E_coli_Lansoprazole, "}")))
y_function_V_parvula_Lansoprazole_func <- eval(parse(text = paste("function(Drug) {", y_function_V_parvula_Lansoprazole, "}")))



unique(combined_monoculture_aucs2_Lansoprazole$conc)
##dictate drug concentration tested for simulation cycle here:
#drug_concentration_tested <- 5 #if manually or:
drug_concentration_tested <- unique(combined_monoculture_aucs2_Lansoprazole$conc)[1] 
initial_conditions <- rep(0.01/32, 32)
initial_conditions <- c(initial_conditions, drug_concentration_tested)


##drug effect fitted for species showing sensitivity in monoculture:
#unique(combined_monoculture_aucs2_Lansoprazole$Species)

##for more simple linear fits
closed.sir.model_Lansoprazole <- function (t, x, params) {
  ## first extract the state variables
  A_muciniphila <- x[1]
  B_adolescentis <- x[2]
  B_fragilis <- x[3]
  B_longum <- x[4]
  B_obeum <- x[5]
  B_thetaiotaomicron <- x[6]
  B_uniformis <- x[7]
  B_vulgatus <- x[8]
  B_wadsworthia <- x[9]
  C_aerofaciens <- x[10]
  C_bolteae <- x[11]
  C_comes <- x[12]
  C_perfringens <- x[13]
  C_ramosum <- x[14]
  C_saccharolyticum <- x[15]
  D_formicigenerans <- x[16]
  E_coli <- x[17]
  E_lenta <- x[18]
  E_rectale <- x[19]
  F_nucleatum <- x[20]
  L_paracasei <- x[21]
  O_splanchnicus <- x[22]
  P_copri <- x[23]
  P_distasonis <- x[24]
  P_merdae <- x[25]
  R_bromii <- x[26]
  R_gnavus <- x[27]
  R_intestinalis <- x[28]
  R_torques <- x[29]
  S_parasanguinis <- x[30]
  S_salivarius <- x[31]
  V_parvula <- x[32]
  Drug <- x[33]
  
  
  ## now extract the parameters
  r_B_fragilis <- flat_params[["B._fragilis.r"]]
  K_B_fragilis <- flat_params[["B._fragilis.K"]]
  r_B_longum <- flat_params[["B._longum.r"]]
  K_B_longum <- flat_params[["B._longum.K"]]
  r_B_thetaiotaomicron <- flat_params[["B._thetaiotaomicron.r"]]
  K_B_thetaiotaomicron <- flat_params[["B._thetaiotaomicron.K"]]
  r_B_uniformis <- flat_params[["B._uniformis.r"]]
  K_B_uniformis <- flat_params[["B._uniformis.K"]]
  r_B_vulgatus <- flat_params[["B._vulgatus.r"]]
  K_B_vulgatus <- flat_params[["B._vulgatus.K"]]
  r_B_wadsworthia <- flat_params[["B._wadsworthia.r"]]
  K_B_wadsworthia <- flat_params[["B._wadsworthia.K"]]
  r_C_aerofaciens <- flat_params[["C._aerofaciens.r"]]
  K_C_aerofaciens <- flat_params[["C._aerofaciens.K"]]
  r_C_bolteae <- flat_params[["C._bolteae.r"]]
  K_C_bolteae <- flat_params[["C._bolteae.K"]]
  r_C_comes <- flat_params[["C._comes.r"]]
  K_C_comes <- flat_params[["C._comes.K"]]
  r_C_perfringens <- flat_params[["C._perfringens.r"]]
  K_C_perfringens <- flat_params[["C._perfringens.K"]]
  r_C_ramosum <- flat_params[["C._ramosum.r"]]
  K_C_ramosum <- flat_params[["C._ramosum.K"]]
  r_C_saccharolyticum <- flat_params[["C._saccharolyticum.r"]]
  K_C_saccharolyticum <- flat_params[["C._saccharolyticum.K"]]
  r_D_formicigenerans <- flat_params[["D._formicigenerans.r"]]
  K_D_formicigenerans <- flat_params[["D._formicigenerans.K"]]
  r_E_coli <- flat_params[["E._coli.r"]]
  K_E_coli <- flat_params[["E._coli.K"]]
  r_E_lenta <- flat_params[["E._lenta.r"]]
  K_E_lenta <- flat_params[["E._lenta.K"]]
  r_E_rectale <- flat_params[["E._rectale.r"]]
  K_E_rectale <- flat_params[["E._rectale.K"]]
  r_F_nucleatum <- flat_params[["F._nucleatum.r"]]
  K_F_nucleatum <- flat_params[["F._nucleatum.K"]]
  r_P_copri <- flat_params[["P._copri.r"]]
  K_P_copri <- flat_params[["P._copri.K"]]
  r_P_merdae <- flat_params[["P._merdae.r"]]
  K_P_merdae <- flat_params[["P._merdae.K"]]
  r_R_gnavus <- flat_params[["R._gnavus.r"]]
  K_R_gnavus <- flat_params[["R._gnavus.K"]]
  r_R_intestinalis <- flat_params[["R._intestinalis.r"]]
  K_R_intestinalis <- flat_params[["R._intestinalis.K"]]
  r_V_parvula <- flat_params[["V._parvula.r"]]
  K_V_parvula <- flat_params[["V._parvula.K"]]
  r_A_muciniphila <- flat_params[["A._muciniphila.r"]]
  K_A_muciniphila <- flat_params[["A._muciniphila.K"]]
  r_B_adolescentis <- flat_params[["B._adolescentis.r"]]
  K_B_adolescentis <- flat_params[["B._adolescentis.K"]]
  r_B_obeum <- flat_params[["B._obeum.r"]]
  K_B_obeum <- flat_params[["B._obeum.K"]]
  r_O_splanchnicus <- flat_params[["O._splanchnicus.r"]]
  K_O_splanchnicus <- flat_params[["O._splanchnicus.K"]]
  r_P_distasonis <- flat_params[["P._distasonis.r"]]
  K_P_distasonis <- flat_params[["P._distasonis.K"]]
  r_R_bromii <- flat_params[["R._bromii.r"]]
  K_R_bromii <- flat_params[["R._bromii.K"]]
  r_R_torques <- flat_params[["R._torques.r"]]
  K_R_torques <- flat_params[["R._torques.K"]]
  r_S_parasanguinis <- flat_params[["S._parasanguinis.r"]]
  K_S_parasanguinis <-flat_params[["S._parasanguinis.K"]]
  r_S_salivarius <- flat_params[["S._salivarius.r"]]
  K_S_salivarius <- flat_params[["S._salivarius.K"]]
  r_L_paracasei <- flat_params[["L._paracasei.r"]]
  K_L_paracasei <- flat_params[["L._paracasei.K"]]
  
  
  t_mod <- ifelse(t > 24.1, t - 24.1, t)
  
  
  ## now code the model equations
  dA_muciniphila_dt <- r_A_muciniphila * A_muciniphila * (1 - A_muciniphila / K_A_muciniphila)
  dB_adolescentis_dt <- r_B_adolescentis * B_adolescentis * (1 - B_adolescentis / K_B_adolescentis)
  dB_fragilis_dt <- r_B_fragilis * B_fragilis * (1 - B_fragilis / max(0.0001, K_B_fragilis * (y_function_B_fragilis_Lansoprazole_func(Drug))))
  dB_longum_dt <- r_B_longum * B_longum * (1 - B_longum / K_B_longum)
  dB_obeum_dt <- r_B_obeum * B_obeum * (1 - B_obeum / K_B_obeum)
  dB_thetaiotaomicron_dt <- r_B_thetaiotaomicron * B_thetaiotaomicron * (1 - B_thetaiotaomicron / max(0.0001, K_B_thetaiotaomicron * (y_function_B_thetaiotaomicron_Lansoprazole_func(Drug))))  
  dB_uniformis_dt <- r_B_uniformis * B_uniformis * (1 - B_uniformis / max(0.0001, K_B_uniformis * (y_function_B_uniformis_Lansoprazole_func(Drug))))
  dB_vulgatus_dt <- r_B_vulgatus * B_vulgatus * (1 - B_vulgatus / max(0.0001, K_B_vulgatus * (y_function_B_vulgatus_Lansoprazole_func(Drug))))
  dB_wadsworthia_dt <- r_B_wadsworthia * B_wadsworthia * (1 - B_wadsworthia / K_B_wadsworthia)
  dC_aerofaciens_dt <- r_C_aerofaciens * C_aerofaciens * (1 - C_aerofaciens / max(0.0001, K_C_aerofaciens * (y_function_C_aerofaciens_Lansoprazole_func(Drug))))
  dC_bolteae_dt <- r_C_bolteae * C_bolteae * (1 - C_bolteae /  max(0.0001, K_C_bolteae * (y_function_C_bolteae_Lansoprazole_func(Drug))))
  dC_comes_dt <- r_C_comes * C_comes * (1 - C_comes / max(0.0001, K_C_comes * (y_function_C_comes_Lansoprazole_func(Drug))))
  dC_perfringens_dt <- r_C_perfringens * C_perfringens * (1 - C_perfringens / max(0.0001, K_C_perfringens * (y_function_C_perfringens_Lansoprazole_func(Drug))))
  dC_ramosum_dt <- r_C_ramosum * C_ramosum * (1 - C_ramosum / max(0.0001, K_C_ramosum * (y_function_C_ramosum_Lansoprazole_func(Drug))))
  dC_saccharolyticum_dt <- r_C_saccharolyticum * C_saccharolyticum * (1 - C_saccharolyticum / max(0.0001, K_C_saccharolyticum * (y_function_C_saccharolyticum_Lansoprazole_func(Drug))))
  dD_formicigenerans_dt <- r_D_formicigenerans * D_formicigenerans * (1 - D_formicigenerans / max(0.0001, K_D_formicigenerans * (y_function_D_formicigenerans_Lansoprazole_func(Drug))))
  dE_coli_dt <- r_E_coli * E_coli * (1 - E_coli / max(0.0001, K_E_coli * (y_function_E_coli_Lansoprazole_func(Drug))))
  dE_lenta_dt <- r_E_lenta * E_lenta * (1 - E_lenta / max(0.0001, K_E_lenta * (y_function_E_lenta_Lansoprazole_func(Drug))))
  dE_rectale_dt <- r_E_rectale * E_rectale * (1 - E_rectale / max(0.0001, K_E_rectale * (y_function_E_rectale_Lansoprazole_func(Drug))))
  dF_nucleatum_dt <- r_F_nucleatum * F_nucleatum * (1 - F_nucleatum / max(0.0001, K_F_nucleatum * (y_function_F_nucleatum_Lansoprazole_func(Drug))))
  dL_paracasei_dt <- r_L_paracasei * L_paracasei * (1 - L_paracasei / K_L_paracasei)  
  dO_splanchnicus_dt <- r_O_splanchnicus * O_splanchnicus * (1 - O_splanchnicus / K_O_splanchnicus)  
  dP_copri_dt <- r_P_copri * P_copri * (1 - P_copri / K_P_copri)
  dP_distasonis_dt <- r_P_distasonis * P_distasonis * (1 - P_distasonis / K_P_distasonis)  
  dP_merdae_dt <- r_P_merdae * P_merdae * (1 - P_merdae / max(0.0001, K_P_merdae * (y_function_P_merdae_Lansoprazole_func(Drug))))
  dR_bromii_dt <- r_R_bromii * R_bromii * (1 - R_bromii / K_R_bromii) 
  dR_gnavus_dt <- r_R_gnavus * R_gnavus * (1 - R_gnavus / max(0.0001, K_R_gnavus * (y_function_R_gnavus_Lansoprazole_func(Drug))))
  dR_intestinalis_dt <- r_R_intestinalis * R_intestinalis * (1 - R_intestinalis / max(0.0001, K_R_intestinalis * (y_function_R_intestinalis_Lansoprazole_func(Drug))))
  dR_torques_dt <- r_R_torques * R_torques * (1 - R_torques /K_R_torques) 
  dS_parasanguinis_dt <- r_S_parasanguinis * S_parasanguinis * (1 - S_parasanguinis / max(0.0001, K_S_parasanguinis * (y_function_S_parasanguinis_Lansoprazole_func(Drug))))
  dS_salivarius_dt <- r_S_salivarius * S_salivarius * (1 - S_salivarius / max(0.0001, K_S_salivarius * (y_function_S_salivarius_Lansoprazole_func(Drug))))
  dV_parvula_dt <- r_V_parvula * V_parvula * (1 - V_parvula / max(0.0001, K_V_parvula * (y_function_V_parvula_Lansoprazole_func(Drug))))
  
  
  
  #Drug differential:
  dDrug_dt <- (subset(drug_dynamics, Drug == "Lansoprazole")$Steepness_param_community * exp(-subset(drug_dynamics, Drug == "Lansoprazole")$Steepness_param_community * t_mod)) * (drug_concentration_tested * prop_left_Lansoprazole - drug_concentration_tested)
  #dDrug_dt <- 0
  
  ## Combine results into a single vector
  dxdt <- c(dA_muciniphila_dt, dB_adolescentis_dt, dB_fragilis_dt, dB_longum_dt, dB_obeum_dt, dB_thetaiotaomicron_dt, dB_uniformis_dt, dB_vulgatus_dt, dB_wadsworthia_dt, dC_aerofaciens_dt, dC_bolteae_dt, dC_comes_dt, dC_perfringens_dt, dC_ramosum_dt, dC_saccharolyticum_dt, dD_formicigenerans_dt, dE_coli_dt, dE_lenta_dt, dE_rectale_dt, dF_nucleatum_dt, dL_paracasei_dt, dO_splanchnicus_dt, dP_copri_dt, dP_distasonis_dt, dP_merdae_dt, dR_bromii_dt, dR_gnavus_dt, dR_intestinalis_dt, dR_torques_dt, dS_parasanguinis_dt, dS_salivarius_dt, dV_parvula_dt, dDrug_dt)
  
  ## Return result as a list
  list(dxdt)
}




#calculate the co-culture correction factor per species based on community composition in absence of drug, just like done for Niclosamide

growth_data_all_0_Niclosamide
growth_data_all_0_Niclosamide1 <- growth_data_all_0_Niclosamide %>%
  dplyr::mutate(Species = gsub(" ", "_", Species))


# Merge rel_ab_control with growth_data_all_0_Niclosamide on Species
# Function to remove duplicated columns by name pattern
clean_columns_base <- function(df, pattern) {
  cols_to_keep <- !grepl(pattern, names(df))
  df <- df[, cols_to_keep]
  return(df)
}

# Use the new function to clean up your dataframe
rel_ab_control <- clean_columns_base(rel_ab_control, "mean_max_OD.[xy]")
str(rel_ab_control)


#rel_ab_control$correction_factor <- rel_ab_control$mean_rel_ab / (rel_ab_control$mean_max_OD/sum(rel_ab_control$mean_max_OD))
# Calculate correction factor with a minimum value of ~1
rel_ab_control$correction_factor <- pmax(rel_ab_control$mean_rel_ab / (rel_ab_control$mean_max_OD / sum(rel_ab_control$mean_max_OD)), 1.1)


# Create a new dataframe for co-culture correction
co_culture_correction <- data.frame(
  species = rel_ab_control$Species,
  correction_factor = rel_ab_control$correction_factor
)


#summarise community data
#Adjust based on tested concentrations for each drug
unique(Community_compositions_focus_drugs_Lansoprazole$concentration)

Community_compositions_focus_drugs_Lansoprazole_5uM <- subset(Community_compositions_focus_drugs_Lansoprazole, concentration == 5)
Community_compositions_focus_drugs_Lansoprazole_20uM <- subset(Community_compositions_focus_drugs_Lansoprazole, concentration == 20)
Community_compositions_focus_drugs_Lansoprazole_80uM <- subset(Community_compositions_focus_drugs_Lansoprazole, concentration == 80)


#5 uM
Community_compositions_focus_drugs_Lansoprazole_5uM_summarised <- Community_compositions_focus_drugs_Lansoprazole_5uM %>%
  dplyr::group_by(species) %>%                                  
  dplyr::summarize(
    mean_rel_ab = mean(rel_abundance, na.rm = TRUE),     
    sd_rel_ab = sd(rel_abundance, na.rm = TRUE) ,
    mean_max_OD = mean(maxOD, na.rm = TRUE),
    sd_max_OD = sd(maxOD, na.rm = TRUE),
    mean_final_OD = mean(finalOD, na.rm = TRUE),
    sd_final_OD = sd(finalOD, na.rm = TRUE)
  ) %>%
  dplyr::ungroup() 


Community_compositions_focus_drugs_Lansoprazole_5uM_summarised <- Community_compositions_focus_drugs_Lansoprazole_5uM_summarised %>%
  dplyr::mutate(Species = sub("^(\\w)\\w*\\s(.*)", "\\1._\\2", species))

#remove (sub)strain info
Community_compositions_focus_drugs_Lansoprazole_5uM_summarised <- Community_compositions_focus_drugs_Lansoprazole_5uM_summarised %>%
  dplyr::mutate(Species = sub("^(\\w\\._\\w+).*", "\\1", Species))


#20 uM
Community_compositions_focus_drugs_Lansoprazole_20uM_summarised <- Community_compositions_focus_drugs_Lansoprazole_20uM %>%
  dplyr::group_by(species) %>%                                  
  dplyr::summarize(
    mean_rel_ab = mean(rel_abundance, na.rm = TRUE),     
    sd_rel_ab = sd(rel_abundance, na.rm = TRUE) ,
    mean_max_OD = mean(maxOD, na.rm = TRUE),
    sd_max_OD = sd(maxOD, na.rm = TRUE),
    mean_final_OD = mean(finalOD, na.rm = TRUE),
    sd_final_OD = sd(finalOD, na.rm = TRUE)
  ) %>%
  dplyr::ungroup() 


Community_compositions_focus_drugs_Lansoprazole_20uM_summarised <- Community_compositions_focus_drugs_Lansoprazole_20uM_summarised %>%
  dplyr::mutate(Species = sub("^(\\w)\\w*\\s(.*)", "\\1._\\2", species))

#remove (sub)strain info
Community_compositions_focus_drugs_Lansoprazole_20uM_summarised <- Community_compositions_focus_drugs_Lansoprazole_20uM_summarised %>%
  dplyr::mutate(Species = sub("^(\\w\\._\\w+).*", "\\1", Species))


#80 uM
Community_compositions_focus_drugs_Lansoprazole_80uM_summarised <- Community_compositions_focus_drugs_Lansoprazole_80uM %>%
  dplyr::group_by(species) %>%                                  
  dplyr::summarize(
    mean_rel_ab = mean(rel_abundance, na.rm = TRUE),     
    sd_rel_ab = sd(rel_abundance, na.rm = TRUE) ,
    mean_max_OD = mean(maxOD, na.rm = TRUE),
    sd_max_OD = sd(maxOD, na.rm = TRUE),    
    mean_final_OD = mean(finalOD, na.rm = TRUE),
    sd_final_OD = sd(finalOD, na.rm = TRUE)
  ) %>%
  dplyr::ungroup() 



Community_compositions_focus_drugs_Lansoprazole_80uM_summarised <- Community_compositions_focus_drugs_Lansoprazole_80uM_summarised %>%
  dplyr::mutate(Species = sub("^(\\w)\\w*\\s(.*)", "\\1._\\2", species))

#remove (sub)strain info
Community_compositions_focus_drugs_Lansoprazole_80uM_summarised <- Community_compositions_focus_drugs_Lansoprazole_80uM_summarised %>%
  dplyr::mutate(Species = sub("^(\\w\\._\\w+).*", "\\1", Species))


#Initialise data frames
sim_output <- data.frame()
input_params_list <- list() #Use a list to collect parameters for each simulation

#number of simulations
num_sims <- 250


for (i in 1:num_sims) {
  tryCatch({
    # generate model parameters
    set.seed(i) #set a different seed for each simulation for variation
    params <- lapply(1:nrow(growth_data_all_0_Niclosamide), function(idx) {
      species_params <- growth_data_all_0_Niclosamide[idx, ]
      list(
        r = rnorm(1, mean = species_params$mean_max_Growth_rate, sd = species_params$sd_max_Growth_rate),
        K = rnorm(1, mean = species_params$mean_max_OD, sd = species_params$sd_max_OD)
      )
    })
    names(params) <- gsub(" ", "_", growth_data_all_0_Niclosamide$Species)
    flat_params <- unlist(params)
    names(flat_params) <- gsub("\\.\\d$", "", names(flat_params))
    
    #replace spaces with underscores to match formatting
    co_culture_correction$species <- gsub(" ", "_", co_culture_correction$species, fixed = TRUE)
    
    #replace the species-specific K parameters extracted from monoculture growth data 
    #with drawn relative abundance values at Niclosamide = 0, scaled to K
    rel_ab_control$Species <- gsub(" ", "_", rel_ab_control$Species)
    
    #Initialise an empty vector to store drawn values
    drawn_values <- numeric(nrow(rel_ab_control))
    
    #draw values from their respective distributions
    for (k in 1:nrow(rel_ab_control)) {
      species_name <- rel_ab_control$Species[k]
      drawn_value <- rnorm(1, mean = rel_ab_control$mean_rel_ab[k], sd = rel_ab_control$sd_rel_ab[k])
      drawn_values[k] <- max(drawn_value, 0)  # Ensure no negative values
    }
    
    #Normalise drawn relative abundance values so they sum to 1 (to reflect a 'true' relative abundance distribution)
    #this is needed so when we convert the values into OD units by multiplying with the drawn community maxOD,
    # the sum of K_i parameters and the drawn K are equal
    normalised_values <- drawn_values / sum(drawn_values)
    
    #Pull community maxOD (K) at 0 drugs from respective normal distribution:
    K <- rnorm(n = 1, mean = rel_ab_control$mean_com_max_OD[1], sd = rel_ab_control$sd_com_max_OD[1])
    
    # Assign these normalised values to their respective species' .K parameters
    for (k in 1:nrow(rel_ab_control)) {
      species_name <- rel_ab_control$Species[k]
      k_index <- grep(paste0("^", species_name, "\\.K$"), names(flat_params))
      
      if (length(k_index) > 0) {
        old_value <- flat_params[k_index]
        flat_params[k_index] <- (normalised_values[k] + 0.0001) * K #add small value in case drawn K_i is 0, which would cause issues with the solver
        cat(sprintf("Updated %s from %f to %f using normalised value %f scaled by K %f\n", names(flat_params)[k_index], old_value, flat_params[k_index], normalised_values[k], K))
      }
    }
    
    #Accounting for variation in drug degradation by community, with standard deviation of end concentration (at 10h) around the fitted predicted (relative) end concentration at 24h
    #prop_left_Lansoprazole <- abs(rnorm(1, (subset(drug_dynamics, Drug == "Lansoprazole")$Prop_left_24h_community), (subset(drug_dynamics, Drug == "Lansoprazole")$SD_drug_community))) 
    #below, we account for measurement error rather than ecological drivers that lead to the variability of degradation at the final point measured 
    prop_left_Lansoprazole <- abs(rnorm(
      n = 1, 
      mean = subset(drug_dynamics, Drug == "Lansoprazole")$Prop_left_24h_community, 
      sd = ifelse(
        subset(drug_dynamics, Drug == "Lansoprazole")$SD_drug_community > subset(drug_dynamics, Drug == "Lansoprazole")$SD_drug_community_start, 
        subset(drug_dynamics, Drug == "Lansoprazole")$SD_drug_community - subset(drug_dynamics, Drug == "Lansoprazole")$SD_drug_community_start, 
        subset(drug_dynamics, Drug == "Lansoprazole")$SD_drug_community
      )
    ))
    
    
    #loop through each species in co_culture_correction
    for (j in 1:nrow(co_culture_correction)) {
      # Extract the species name and correction factor
      species_name <- co_culture_correction$species[j]
      correction_factor <- co_culture_correction$correction_factor[j]
      
      # Identify the corresponding growth rate parameter in flat_params
      #by matching the base species name (without .r)
      growth_rate_indices <- grep(paste0("^", species_name, "\\.r$"), names(flat_params))
      
      #take the growth rate parameter and apply the correction factor 
      for (index in growth_rate_indices) {
        flat_params[index] <- flat_params[index] * correction_factor
      }
    }
    
    flat_params
    # Store parameters for each simulation
    input_params_list[[i]] <- c(sim_ID = i, flat_params)
    
    # Run the model for the first 24-hour cycle
    solution_cycle_1 <- ode(y = initial_conditions, times = seq(from = 0, to = 24, by = 0.1), func = closed.sir.model_Lansoprazole, parms = flat_params,   method = "lsoda", rtol = 1e-6, atol = 1e-6)
    
    # Dilution and second cycle
    end_of_cycle_1 <- solution_cycle_1[nrow(solution_cycle_1), -1]
    initial_conditions_cycle_2 <- end_of_cycle_1 / 50
    #accounting for the drugs being added with the new growth cycle as well:
    initial_conditions_cycle_2[33] <- initial_conditions_cycle_2[33] + drug_concentration_tested
    solution_cycle_2 <- ode(y = initial_conditions_cycle_2, times = seq(from = 24, to = 48, by = 0.1), func = closed.sir.model_Lansoprazole, parms = flat_params,  method = "lsoda", rtol = 1e-6, atol = 1e-6)
    
    # Combine and format results
    combined_solution <- rbind(as.data.frame(solution_cycle_1), as.data.frame(solution_cycle_2)[-1,])
    combined_solution$sim_ID <- rep(i, nrow(combined_solution))
    combined_solution <- combined_solution %>%
      tidyr::gather(key = "Species", value = "Density", -time, -sim_ID) %>%
      dplyr::mutate(Hour = time) %>%
      dplyr::select(sim_ID, Hour, Species, Density)
    
    ##Append to sim_output
    sim_output <- rbind(sim_output, combined_solution)
  }, error = function(e) {
    cat(sprintf("Skipping simulation %d due to an error: %s\n", i, e$message))
  })
}



##Combine all parameter data into a single dataframe
input_params <- do.call(rbind, input_params_list)

# Add a "Species" column 
sim_output$Species_name <- species_names[as.numeric(as.character(sim_output$Species))]
sim_output$Species_name <- replace_na(sim_output$Species_name, "Drug")

#View(input_params)
#View(sim_output)

sim_output <- na.omit(sim_output)
successful_sim_ids <- unique(subset(sim_output, Hour == 48)$sim_ID)
length(successful_sim_ids)
sim_output1 <- sim_output[sim_output$sim_ID %in% successful_sim_ids, ]


#Transform sim_output so we have wide format by Species
sim_output_wide <- tidyr::pivot_wider(sim_output1, 
                                      names_from = Species_name, 
                                      values_from = Density,
                                      id_cols = c(sim_ID, Hour))

length(unique(sim_output_wide$sim_ID))
#calc community OD per timepoint
sim_output_wide$Total_OD <- rowSums(sim_output_wide[, 3:34], na.rm = TRUE)
#calculate and add relative abundances here as well:
species_columns <- colnames(sim_output_wide)[3:34] 

for (species in species_columns) {
  sim_output_wide[[paste0("rel_", species)]] <- sim_output_wide[[species]] / sim_output_wide$Total_OD
}


#assign sim_output_wide test conditions to dataframe name
drug_tested <- "Lansoprazole"
variable_name_1 <- paste0("sim_output_wide_", ifelse(drug_concentration_tested == 1e-04, 0, drug_concentration_tested), "_", drug_tested)
assign(variable_name_1, sim_output_wide)

#turn back into long format if interested in plotting relative abundances
cols_needed <- c("sim_ID", "Hour")

sim_output_long <- sim_output_wide %>% 
  dplyr::select(sim_ID, Hour, Drug, starts_with("rel_")) %>% 
  tidyr::pivot_longer(
    cols = c(Drug, starts_with("rel_")),
    names_to = "Species", 
    values_to = "Relative_abundance",
    names_prefix = "rel_",
    names_transform = list(Species = ~ ifelse(.x == "Drug", "Drug", .x))
  ) 

str(sim_output_long)


species_names_1 <- c(
  "A_muciniphila",
  "B_adolescentis",
  "B_fragilis",
  "B_longum",
  "B_obeum",
  "B_thetaiotaomicron",
  "B_uniformis",
  "B_vulgatus",
  "B_wadsworthia",
  "C_aerofaciens",
  "C_bolteae",
  "C_comes",
  "C_perfringens",
  "C_ramosum",
  "C_saccharolyticum",
  "D_formicigenerans",
  "E_coli",
  "E_lenta",
  "E_rectale",
  "F_nucleatum",
  "L_paracasei",
  "O_splanchnicus",
  "P_copri",
  "P_distasonis",
  "P_merdae",
  "R_bromii",
  "R_gnavus",
  "R_intestinalis",
  "R_torques",
  "S_parasanguinis",
  "S_salivarius",
  "V_parvula",
  "Drug"
)

species_colours_1 <- c(
  "A_muciniphila" = "#1f77b4",
  "B_adolescentis" = "#ff7f0e",
  "B_fragilis" = "#2ca02c",
  "B_longum" = "#d62728",
  "B_obeum" = "#9467bd",
  "B_thetaiotaomicron" = "black",
  "B_uniformis" = "#e377c2",
  "B_vulgatus" = "#7f7f7f",
  "B_wadsworthia" = "gold1",
  "C_aerofaciens" = "#aec7e8",
  "C_bolteae" = "#ffbb78",
  "C_comes" = "magenta",
  "C_perfringens" = "#ff9896",
  "C_ramosum" = "#c5b0d5",
  "C_saccharolyticum" = "#c49c94",
  "D_formicigenerans" = "#f7b6d2",
  "E_coli" = "yellow",
  "E_lenta" = "turquoise",
  "E_rectale" = "#393b79",
  "F_nucleatum" = "royalblue2",
  "L_paracasei" = "blue",
  "O_splanchnicus" = "#637939",
  "P_copri" = "cyan",
  "P_distasonis" = "#8c6d31",
  "P_merdae" = "#c7c7c7",
  "R_bromii" = "#e6550d",
  "R_gnavus" = "#e7cb94",
  "R_intestinalis" = "#843c39",
  "R_torques" = "#d6616b",
  "S_parasanguinis" = "orange3",
  "S_salivarius" = "#7b4173",
  "V_parvula" = "#ce6dbd",
  "Drug" = "green"
)



##Plot output for any specific sim:
# ggplot(subset(sim_output, sim_ID == 1 & Species_name != "Drug"), aes(x = Hour, y = Density, group = Species_name, color = Species_name)) +
#   geom_line(size = 1, alpha = 0.7) +
#   scale_color_manual(values = species_colours_1) +
#   labs(title = paste0("Lansoprazole = ", drug_concentration_tested),
#        x = "Time (hours)",
#        y = "Population Density (OD)",
#        color = "Species") +
#   theme_minimal() +
#   theme(legend.position = "right")
# 
# ggplot(subset(sim_output, sim_ID == 3 & Species_name != "Drug"), aes(x = Hour, y = Density, group = Species_name, color = Species_name)) +
#   geom_line(size = 1, alpha = 0.7) +
#   scale_color_manual(values = species_colours_1) +
#   labs(title = paste0("Lansoprazole = ", drug_concentration_tested),
#        x = "Time (hours)",
#        y = "Population Density (OD)",
#        color = "Species") +
#   theme_minimal() +
#   theme(legend.position = "right")


ggplot(subset(sim_output_long, sim_ID == 1), aes(x = Hour, y = Relative_abundance, group = Species, color = Species)) +
  geom_line(size = 1, alpha = 0.7) +
  scale_color_manual(values = species_colours_1) +
  labs(title = paste0("Lansoprazole = ", drug_concentration_tested),
       x = "Time (hours)",
       y = "Relative abundance",
       color = "Species") +
  theme_minimal() +
  theme(legend.position = "right")


ggplot(subset(sim_output_long, sim_ID == 3), aes(x = Hour, y = Relative_abundance, group = Species, color = Species)) +
  geom_line(size = 1, alpha = 0.7) +
  scale_color_manual(values = species_colours_1) +
  labs(title = paste0("Lansoprazole = ", drug_concentration_tested),
       x = "Time (hours)",
       y = "Relative abundance",
       color = "Species") +
  theme_minimal() +
  theme(legend.position = "right")


#calc mean and standard deviation across sims
sim_stats <- sim_output_long %>%
  dplyr::group_by(Hour, Species) %>%
  dplyr::summarise(
    mean_rel_ab = mean(Relative_abundance),
    sd_rel_ab = sd(Relative_abundance),
    .groups = 'drop'
  )

# Prepare the data for plotting
plot_data <- sim_stats %>%
  dplyr::mutate(Upper = mean_rel_ab + sd_rel_ab, Lower = mean_rel_ab - sd_rel_ab)

ggplot(subset(plot_data, Species != "Drug"), aes(x = Hour, y = mean_rel_ab, group = Species, color = Species)) +
  geom_ribbon(aes(ymin = Lower, ymax = Upper, fill = Species), colour = NA, alpha = 0.2) +  
  geom_line(size = 1, alpha = 0.7) + 
  scale_color_manual(values = species_colours_1) +
  scale_fill_manual(values = species_colours_1) +  
  labs(title = "Mean and SD of Relative Abundance Across Simulations",
       subtitle = paste0("Lansoprazole = ", drug_concentration_tested),       
       x = "Time (hours)",
       y = "Relative abundance",
       color = "Species",
       fill = "Species") +
  theme_minimal() +
  theme(legend.position = "right")

#log-scaled mean trends
ggplot(plot_data, aes(x = Hour, y = log10(mean_rel_ab + 0.0001), group = Species, color = Species)) +
  geom_line(size = 1, alpha = 0.7) +  # Mean line
  scale_color_manual(values = species_colours_1) +
  scale_fill_manual(values = species_colours_1) +  # Ensure consistent colors for lines and fills
  labs(title = "Mean and SD of Relative Abundance Across Simulations",
       subtitle = paste0("Lansoprazole = ", drug_concentration_tested),
       x = "Time (hours)",
       y = "Relative abundance",
       color = "Species",
       fill = "Species") +
  theme_minimal() +
  theme(legend.position = "right")




##prediction quality evaluation
drug_tested <- "Lansoprazole"
variable_name <- paste0("plot_data_", ifelse(drug_concentration_tested == 1e-04, 0, drug_concentration_tested), "_", drug_tested)
assign(variable_name, plot_data)


#extract total OD info:
predicted_mean_final_od_NULL <- Niclosamide_16S_0uM_summarised$mean_com_final_OD[1]
predicted_sd_final_od_NULL <- Niclosamide_16S_0uM_summarised$sd_com_final_OD[1]

predicted_mean_final_od_5_Lansoprazole <- mean(subset(sim_output_wide_5_Lansoprazole, Hour == 48)$Total_OD, na.rm = TRUE)
predicted_sd_final_od_5_Lansoprazole <- sd(subset(sim_output_wide_5_Lansoprazole, Hour == 48)$Total_OD, na.rm = TRUE)

real_mean_final_od_5_Lansoprazole <- Community_compositions_focus_drugs_Lansoprazole_5uM_summarised$mean_final_OD[1]
real_sd_final_od_5_Lansoprazole <- Community_compositions_focus_drugs_Lansoprazole_5uM_summarised$sd_final_OD[1]


predicted_mean_final_od_20_Lansoprazole <- mean(subset(sim_output_wide_20_Lansoprazole, Hour == 48)$Total_OD, na.rm = TRUE)
predicted_sd_final_od_20_Lansoprazole <- sd(subset(sim_output_wide_20_Lansoprazole, Hour == 48)$Total_OD, na.rm = TRUE)

real_mean_final_od_20_Lansoprazole <- Community_compositions_focus_drugs_Lansoprazole_20uM_summarised$mean_final_OD[1]
real_sd_final_od_20_Lansoprazole <- Community_compositions_focus_drugs_Lansoprazole_20uM_summarised$sd_final_OD[1]


predicted_mean_final_od_80_Lansoprazole <- mean(subset(sim_output_wide_80_Lansoprazole, Hour == 48)$Total_OD, na.rm = TRUE)
predicted_sd_final_od_80_Lansoprazole <- sd(subset(sim_output_wide_80_Lansoprazole, Hour == 48)$Total_OD, na.rm = TRUE)

real_mean_final_od_80_Lansoprazole <- Community_compositions_focus_drugs_Lansoprazole_80uM_summarised$mean_final_OD[1]
real_sd_final_od_80_Lansoprazole <- Community_compositions_focus_drugs_Lansoprazole_80uM_summarised$sd_final_OD[1]




#plot_data_0_Lansoprazole_endpoint was used to test model performance at 0 drugs
#plot_data_0_Lansoprazole_endpoint <- subset(plot_data_0_Lansoprazole, Hour == 48 & Species != "Drug")
plot_data_5_Lansoprazole_endpoint <- subset(plot_data_5_Lansoprazole, Hour == 48 & Species != "Drug")
plot_data_20_Lansoprazole_endpoint <- subset(plot_data_20_Lansoprazole, Hour == 48 & Species != "Drug")
plot_data_80_Lansoprazole_endpoint <- subset(plot_data_80_Lansoprazole, Hour == 48 & Species != "Drug")

##Inspecting 'match' to real relative abundance distributions:
Niclosamide_16S_0uM_summarised <- rel_ab_control
Niclosamide_16S_0uM_summarised$Species <- gsub("\\.", "", Niclosamide_16S_0uM_summarised$Species)

Lansoprazole_16S_5uM_summarised <- Community_compositions_focus_drugs_Lansoprazole_5uM_summarised
Lansoprazole_16S_20uM_summarised <- Community_compositions_focus_drugs_Lansoprazole_20uM_summarised
Lansoprazole_16S_80uM_summarised <- Community_compositions_focus_drugs_Lansoprazole_80uM_summarised

Niclosamide_16S_0uM_summarised
Lansoprazole_16S_5uM_summarised 
Lansoprazole_16S_20uM_summarised 
Lansoprazole_16S_80uM_summarised 

#Rename 'species' so the outputs become comparable
original_names_80 <- unique(Lansoprazole_16S_80uM_summarised$species)
original_names_20 <- unique(Lansoprazole_16S_20uM_summarised$species)
original_names_5 <- unique(Lansoprazole_16S_5uM_summarised$species)


##Create a named vector with the original and new names mapping
name_changes <- c(
  "Akkermansia muciniphila" = "A_muciniphila",
  "Bacteroides fragilis" = "B_fragilis",
  "Bacteroides thetaiotaomicron" = "B_thetaiotaomicron",
  "Bacteroides uniformis" = "B_uniformis",
  "Bifidobacterium adolescentis" = "B_adolescentis",
  "Bifidobacterium longum subsp. longum" = "B_longum",
  "Bilophila wadsworthia" = "B_wadsworthia",
  "Blautia obeum" = "B_obeum",
  "Clostridium perfringens" = "C_perfringens",
  "Collinsella aerofaciens" = "C_aerofaciens",
  "Coprococcus comes" = "C_comes",
  "Dorea formicigenerans" = "D_formicigenerans",
  "Eggerthella lenta" = "E_lenta",
  "Enterocloster bolteae" = "C_bolteae",
  "Erysipelatoclostridium ramosum" = "C_ramosum",
  "Escherichia coli ED1a" = "E_coli",
  "Eubacterium rectale" = "E_rectale",
  "Fusobacterium nucleatum subsp. nucleatum" = "F_nucleatum",
  "Lacrimispora saccharolytica" = "C_saccharolyticum",
  "Lacticaseibacillus paracasei" = "L_paracasei",
  "Odoribacter splanchnicus" = "O_splanchnicus",
  "Parabacteroides distasonis" = "P_distasonis",
  "Parabacteroides merdae" = "P_merdae",
  "Phocaeicola vulgatus" = "B_vulgatus",
  "Prevotella copri" = "P_copri",
  "Roseburia intestinalis" = "R_intestinalis",
  "Ruminococcus bromii" = "R_bromii",
  "Ruminococcus gnavus" = "R_gnavus",
  "Ruminococcus torques" = "R_torques",
  "Streptococcus parasanguinis" = "S_parasanguinis",
  "Streptococcus salivarius" = "S_salivarius",
  "Veillonella parvula" = "V_parvula"
)

# Apply name changes to the species column in Lansoprazole_16S_80uM_summarised

Lansoprazole_16S_80uM_summarised$Species <- name_changes[Lansoprazole_16S_80uM_summarised$species]
Lansoprazole_16S_20uM_summarised$Species <- name_changes[Lansoprazole_16S_20uM_summarised$species]
Lansoprazole_16S_5uM_summarised$Species <- name_changes[Lansoprazole_16S_5uM_summarised$species]

# Verify the changes
unique(Lansoprazole_16S_80uM_summarised$Species)
unique(Lansoprazole_16S_20uM_summarised$Species)
unique(Lansoprazole_16S_5uM_summarised$Species)



##First, for 5 uM:
# Get top 6 species from plot_data_5_endpoint
# Adjust the plot_data_5_endpoint with confidence bounds

# #plot_data_0_Lansoprazole_endpoint was used to test model performance at 0 drugs
# plot_data_0_Lansoprazole_endpoint <- plot_data_0_Lansoprazole_endpoint %>%
#   dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)

plot_data_5_Lansoprazole_endpoint <- plot_data_5_Lansoprazole_endpoint %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)

# Adjust the Lansoprazole_16S_5uM_summarised with confidence bounds
Lansoprazole_16S_5uM_summarised <- Lansoprazole_16S_5uM_summarised %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)

#NULL model:
Null_model_summarised <- Niclosamide_16S_0uM_summarised %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)


# Get top 6 species based on the lower bound from plot_data_5_endpoint

#top6_predicted_0_Lansoprazole was used to test model performance at 0 drugs
# top6_predicted_0_Lansoprazole <- plot_data_0_Lansoprazole_endpoint %>%
#    arrange(desc(lower_bound)) %>%
#    slice(1:6) %>%
#    pull(Species)

top6_predicted_5_Lansoprazole <- plot_data_5_Lansoprazole_endpoint %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

# Get top 6 species based on the lower bound from Lansoprazole_16S_5uM_summarised
top6_real_5_Lansoprazole <- Lansoprazole_16S_5uM_summarised %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

top6_NULL <- Null_model_summarised %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

# Calculate the overlap of top 6 species

#top_six_correct_0_Lansoprazole was used to assess model performance at 0 drugs
# top_six_correct_0_Lansoprazole <- length(intersect(top6_predicted_0_Lansoprazole, top6_NULL))
# top_six_correct_0_Lansoprazole

top_six_correct_5_Lansoprazole <- length(intersect(top6_predicted_5_Lansoprazole, top6_real_5_Lansoprazole))
top_six_correct_5_Lansoprazole

top_six_correct_5_Lansoprazole_NULL <- length(intersect(top6_NULL, top6_real_5_Lansoprazole))
top_six_correct_5_Lansoprazole_NULL

top6_predicted_5_Lansoprazole
top6_real_5_Lansoprazole

#top6_NULL

#Now by means:
# #top6_predicted_0_Lansoprazole_means was used to assess model performance at 0 drugs
# top6_predicted_0_Lansoprazole_means <- plot_data_0_Lansoprazole_endpoint %>%
#    arrange(desc(mean_rel_ab)) %>%
#    slice(1:6) %>%
#    pull(Species)

top6_predicted_5_Lansoprazole_means <- plot_data_5_Lansoprazole_endpoint %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)

# Get top 6 species based on the lower bound from Lansoprazole_16S_5uM_summarised
top6_real_5_Lansoprazole_means <- Lansoprazole_16S_5uM_summarised %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)

top6_NULL_means <- Null_model_summarised %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)


# #top_six_correct_0_Lansoprazole_means was used to assess model performance at 0 drugs
# top_six_correct_0_Lansoprazole_means <- length(intersect(top6_predicted_0_Lansoprazole_means, top6_NULL_means))
# top_six_correct_0_Lansoprazole_means

top_six_correct_5_Lansoprazole_means <- length(intersect(top6_predicted_5_Lansoprazole_means, top6_real_5_Lansoprazole_means))
top_six_correct_5_Lansoprazole_means

top_six_correct_5_Lansoprazole_means_NULL <- length(intersect(top6_NULL_means, top6_real_5_Lansoprazole_means))
top_six_correct_5_Lansoprazole_means_NULL

top6_predicted_5_Lansoprazole_means
top6_real_5_Lansoprazole_means

#top6_NULL_means


# Merge dataframes by Species

#merged_data_0_Lansoprazole was used to assess model performance at 0 drugs
#merged_data_0_Lansoprazole <- merge(plot_data_0_Lansoprazole_endpoint, Niclosamide_16S_0uM_summarised, by = "Species", suffixes = c(".pred", ".real"))
merged_data_5_Lansoprazole <- merge(plot_data_5_Lansoprazole_endpoint, Lansoprazole_16S_5uM_summarised, by = "Species", suffixes = c(".pred", ".real"))
merged_data_5_Lansoprazole_NULL <- merge(Niclosamide_16S_0uM_summarised, Lansoprazole_16S_5uM_summarised, by = "Species", suffixes = c(".null", ".real"))


## Below lines used for assessing model performance at 0 drugs; ignore for nonzero concentrations
# # Create lower and upper bounds considering mean ¬± sd
# merged_data_0_Lansoprazole$lower_bound_pred <- merged_data_0_Lansoprazole$mean_rel_ab.pred - merged_data_0_Lansoprazole$sd_rel_ab.pred
# merged_data_0_Lansoprazole$upper_bound_pred <- merged_data_0_Lansoprazole$mean_rel_ab.pred + merged_data_0_Lansoprazole$sd_rel_ab.pred
# merged_data_0_Lansoprazole$lower_bound_real <- merged_data_0_Lansoprazole$mean_rel_ab.real - merged_data_0_Lansoprazole$sd_rel_ab.real
# merged_data_0_Lansoprazole$upper_bound_real <- merged_data_0_Lansoprazole$mean_rel_ab.real + merged_data_0_Lansoprazole$sd_rel_ab.real
# 
# # Ensure lower and upper bounds are non-negative, adjusting as necessary
# merged_data_0_Lansoprazole$lower_bound_pred[merged_data_0_Lansoprazole$lower_bound_pred <= 0] <- 1e-10
# merged_data_0_Lansoprazole$lower_bound_real[merged_data_0_Lansoprazole$lower_bound_real <= 0] <- 1e-10
# merged_data_0_Lansoprazole$upper_bound_pred[merged_data_0_Lansoprazole$upper_bound_pred <= 0] <- 1e-10
# merged_data_0_Lansoprazole$upper_bound_real[merged_data_0_Lansoprazole$upper_bound_real <= 0] <- 1e-10


# Create lower and upper bounds considering mean ¬± sd
merged_data_5_Lansoprazole$lower_bound_pred <- merged_data_5_Lansoprazole$mean_rel_ab.pred - merged_data_5_Lansoprazole$sd_rel_ab.pred
merged_data_5_Lansoprazole$upper_bound_pred <- merged_data_5_Lansoprazole$mean_rel_ab.pred + merged_data_5_Lansoprazole$sd_rel_ab.pred
merged_data_5_Lansoprazole$lower_bound_real <- merged_data_5_Lansoprazole$mean_rel_ab.real - merged_data_5_Lansoprazole$sd_rel_ab.real
merged_data_5_Lansoprazole$upper_bound_real <- merged_data_5_Lansoprazole$mean_rel_ab.real + merged_data_5_Lansoprazole$sd_rel_ab.real

# Ensure lower and upper bounds are non-negative, adjusting as necessary
merged_data_5_Lansoprazole$lower_bound_pred[merged_data_5_Lansoprazole$lower_bound_pred <= 0] <- 1e-10
merged_data_5_Lansoprazole$lower_bound_real[merged_data_5_Lansoprazole$lower_bound_real <= 0] <- 1e-10
merged_data_5_Lansoprazole$upper_bound_pred[merged_data_5_Lansoprazole$upper_bound_pred <= 0] <- 1e-10
merged_data_5_Lansoprazole$upper_bound_real[merged_data_5_Lansoprazole$upper_bound_real <= 0] <- 1e-10

##and for NULL model:
# Create lower and upper bounds considering mean ¬± sd
merged_data_5_Lansoprazole_NULL$lower_bound_null <- merged_data_5_Lansoprazole_NULL$mean_rel_ab.null - merged_data_5_Lansoprazole_NULL$sd_rel_ab.null
merged_data_5_Lansoprazole_NULL$upper_bound_null <- merged_data_5_Lansoprazole_NULL$mean_rel_ab.null + merged_data_5_Lansoprazole_NULL$sd_rel_ab.null
merged_data_5_Lansoprazole_NULL$lower_bound_real <- merged_data_5_Lansoprazole_NULL$mean_rel_ab.real - merged_data_5_Lansoprazole_NULL$sd_rel_ab.real
merged_data_5_Lansoprazole_NULL$upper_bound_real <- merged_data_5_Lansoprazole_NULL$mean_rel_ab.real + merged_data_5_Lansoprazole_NULL$sd_rel_ab.real

# Ensure lower and upper bounds are non-negative, adjusting as necessary
merged_data_5_Lansoprazole_NULL$lower_bound_null[merged_data_5_Lansoprazole_NULL$lower_bound_null <= 0] <- 1e-10
merged_data_5_Lansoprazole_NULL$lower_bound_real[merged_data_5_Lansoprazole_NULL$lower_bound_real <= 0] <- 1e-10
merged_data_5_Lansoprazole_NULL$upper_bound_null[merged_data_5_Lansoprazole_NULL$upper_bound_null <= 0] <- 1e-10
merged_data_5_Lansoprazole_NULL$upper_bound_real[merged_data_5_Lansoprazole_NULL$upper_bound_real <= 0] <- 1e-10

# Filter to include only species with a mean relative abundance > 0.01 in the 'real' dataset

## significant_species_0 was used to assess model performance at 0 drugs
#significant_species_0 <- merged_data_0_Lansoprazole[merged_data_0_Lansoprazole$mean_rel_ab.real > 0.01, ]
significant_species <- merged_data_5_Lansoprazole[merged_data_5_Lansoprazole$mean_rel_ab.real > 0.01, ]
survivors_5_Lansoprazole <- nrow(significant_species)
survivors_5_Lansoprazole

#should be the same as survivors defined above, since it is calculated from .real
significant_species_NULL <- merged_data_5_Lansoprazole_NULL[merged_data_5_Lansoprazole_NULL$mean_rel_ab.real > 0.01, ]
survivors_5_Lansoprazole_NULL <- nrow(significant_species_NULL)
survivors_5_Lansoprazole_NULL

# Adjusted order of magnitude check to include SD, only for significant species
## below code was used to assess model performance at 0 drugs
# significant_species_0$Predicted_magnitude_correct <- ifelse(
#   (floor(log10(significant_species_0$lower_bound_pred)) <= floor(log10(significant_species_0$upper_bound_real)) &
#      floor(log10(significant_species_0$upper_bound_pred)) >= floor(log10(significant_species_0$lower_bound_real))),
#   1,
#   0
# )

significant_species$Predicted_magnitude_correct <- ifelse(
  (floor(log10(significant_species$lower_bound_pred)) <= floor(log10(significant_species$upper_bound_real)) &
     floor(log10(significant_species$upper_bound_pred)) >= floor(log10(significant_species$lower_bound_real))),
  1,
  0
)

#and for the Null model:
significant_species_NULL$Predicted_magnitude_correct <- ifelse(
  (floor(log10(significant_species_NULL$lower_bound_null)) <= floor(log10(significant_species_NULL$upper_bound_real)) &
     floor(log10(significant_species_NULL$upper_bound_null)) >= floor(log10(significant_species_NULL$lower_bound_real))),
  1,
  0
)

# Calculate the fraction of correctly predicted magnitudes for significant species
## below code was used to assess model performance at 0 drugs
#predicted_magnitude_correct_fraction_0_Lansoprazole <- sum(significant_species_0$Predicted_magnitude_correct) / nrow(significant_species_0)
#predicted_magnitude_correct_fraction_0_Lansoprazole

predicted_magnitude_correct_fraction_5_Lansoprazole <- sum(significant_species$Predicted_magnitude_correct) / nrow(significant_species)
predicted_magnitude_correct_fraction_5_Lansoprazole

predicted_magnitude_correct_fraction_5_Lansoprazole_NULL <- sum(significant_species_NULL$Predicted_magnitude_correct) / nrow(significant_species_NULL)
predicted_magnitude_correct_fraction_5_Lansoprazole_NULL

top_species_missing_5_Lansoprazole <- setdiff(top6_real_5_Lansoprazole_means, top6_predicted_5_Lansoprazole_means)
top_species_wrong_5_Lansoprazole <- setdiff(top6_predicted_5_Lansoprazole_means, top6_real_5_Lansoprazole_means)

top_species_missing_5_Lansoprazole <- if(length(top_species_missing_5_Lansoprazole) == 0) "None" else top_species_missing_5_Lansoprazole
top_species_wrong_5_Lansoprazole <- if(length(top_species_wrong_5_Lansoprazole) == 0) "None" else top_species_wrong_5_Lansoprazole

Prediction_quality_5_Lansoprazole <- data.frame(
  Top_six_correct = paste(top_six_correct_5_Lansoprazole, sep=""),
  Top_six_correct_NULL = paste(top_six_correct_5_Lansoprazole_NULL, sep=""),
  Top_six_correct_means = paste(top_six_correct_5_Lansoprazole_means, sep=""),
  Top_six_correct_means_NULL = paste(top_six_correct_5_Lansoprazole_means_NULL, sep=""),
  Predicted_magnitude_correct = paste(round(predicted_magnitude_correct_fraction_5_Lansoprazole * 100, 2), "%", sep=""),
  Predicted_magnitude_correct_NULL = paste(round(predicted_magnitude_correct_fraction_5_Lansoprazole_NULL * 100, 2), "%", sep=""),
  survivors_total = survivors_5_Lansoprazole,
  top_species_missing <- top_species_missing_5_Lansoprazole,
  top_species_wrong <- top_species_wrong_5_Lansoprazole, 
  predicted_mean_final_OD <- predicted_mean_final_od_5_Lansoprazole,
  real_mean_final_OD <- real_mean_final_od_5_Lansoprazole,
  sims_total = length(successful_sim_ids)
)



Prediction_quality_5_Lansoprazole



##Next, for 20 uM:
# Get top 6 species from plot_data_20_endpoint
# Adjust the plot_data_20_endpoint with confidence bounds
plot_data_20_Lansoprazole_endpoint <- plot_data_20_Lansoprazole_endpoint %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)

# Adjust the Lansoprazole_16S_20uM_summarised with confidence bounds
Lansoprazole_16S_20uM_summarised <- Lansoprazole_16S_20uM_summarised %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)

#NULL model:
Null_model_summarised <- Niclosamide_16S_0uM_summarised %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)


# Get top 6 species based on the lower bound from plot_data_20_endpoint
top6_predicted_20_Lansoprazole <- plot_data_20_Lansoprazole_endpoint %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

# Get top 6 species based on the lower bound from Lansoprazole_16S_20uM_summarised
top6_real_20_Lansoprazole <- Lansoprazole_16S_20uM_summarised %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

top6_NULL <- Null_model_summarised %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

# Calculate the overlap of top 6 species
top_six_correct_20_Lansoprazole <- length(intersect(top6_predicted_20_Lansoprazole, top6_real_20_Lansoprazole))
#top_six_correct_20_Lansoprazole

top_six_correct_20_Lansoprazole_NULL <- length(intersect(top6_NULL, top6_real_20_Lansoprazole))
#top_six_correct_20_Lansoprazole_NULL

#top6_predicted_20_Lansoprazole
#top6_real_20_Lansoprazole



#Now by means:
top6_predicted_20_Lansoprazole_means <- plot_data_20_Lansoprazole_endpoint %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)

# Get top 6 species based on the lower bound from Lansoprazole_16S_20uM_summarised
top6_real_20_Lansoprazole_means <- Lansoprazole_16S_20uM_summarised %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)

top6_NULL_means <- Null_model_summarised %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)



top_six_correct_20_Lansoprazole_means <- length(intersect(top6_predicted_20_Lansoprazole_means, top6_real_20_Lansoprazole_means))
#top_six_correct_20_Lansoprazole_means

top_six_correct_20_Lansoprazole_means_NULL <- length(intersect(top6_NULL_means, top6_real_20_Lansoprazole_means))
#top_six_correct_20_Lansoprazole_means_NULL

top6_predicted_20_Lansoprazole_means
#top6_real_20_Lansoprazole_means




# Merge dataframes by Species
merged_data_20_Lansoprazole <- merge(plot_data_20_Lansoprazole_endpoint, Lansoprazole_16S_20uM_summarised, by = "Species", suffixes = c(".pred", ".real"))
merged_data_20_Lansoprazole_NULL <- merge(Niclosamide_16S_0uM_summarised, Lansoprazole_16S_20uM_summarised, by = "Species", suffixes = c(".null", ".real"))



# Create lower and upper bounds considering mean ¬± sd
merged_data_20_Lansoprazole$lower_bound_pred <- merged_data_20_Lansoprazole$mean_rel_ab.pred - merged_data_20_Lansoprazole$sd_rel_ab.pred
merged_data_20_Lansoprazole$upper_bound_pred <- merged_data_20_Lansoprazole$mean_rel_ab.pred + merged_data_20_Lansoprazole$sd_rel_ab.pred
merged_data_20_Lansoprazole$lower_bound_real <- merged_data_20_Lansoprazole$mean_rel_ab.real - merged_data_20_Lansoprazole$sd_rel_ab.real
merged_data_20_Lansoprazole$upper_bound_real <- merged_data_20_Lansoprazole$mean_rel_ab.real + merged_data_20_Lansoprazole$sd_rel_ab.real

# Ensure lower and upper bounds are non-negative, adjusting as necessary
merged_data_20_Lansoprazole$lower_bound_pred[merged_data_20_Lansoprazole$lower_bound_pred <= 0] <- 1e-10
merged_data_20_Lansoprazole$lower_bound_real[merged_data_20_Lansoprazole$lower_bound_real <= 0] <- 1e-10
merged_data_20_Lansoprazole$upper_bound_pred[merged_data_20_Lansoprazole$upper_bound_pred <= 0] <- 1e-10
merged_data_20_Lansoprazole$upper_bound_real[merged_data_20_Lansoprazole$upper_bound_real <= 0] <- 1e-10

##and for NULL model:
# Create lower and upper bounds considering mean ¬± sd
merged_data_20_Lansoprazole_NULL$lower_bound_null <- merged_data_20_Lansoprazole_NULL$mean_rel_ab.null - merged_data_20_Lansoprazole_NULL$sd_rel_ab.null
merged_data_20_Lansoprazole_NULL$upper_bound_null <- merged_data_20_Lansoprazole_NULL$mean_rel_ab.null + merged_data_20_Lansoprazole_NULL$sd_rel_ab.null
merged_data_20_Lansoprazole_NULL$lower_bound_real <- merged_data_20_Lansoprazole_NULL$mean_rel_ab.real - merged_data_20_Lansoprazole_NULL$sd_rel_ab.real
merged_data_20_Lansoprazole_NULL$upper_bound_real <- merged_data_20_Lansoprazole_NULL$mean_rel_ab.real + merged_data_20_Lansoprazole_NULL$sd_rel_ab.real

# Ensure lower and upper bounds are non-negative, adjusting as necessary
merged_data_20_Lansoprazole_NULL$lower_bound_null[merged_data_20_Lansoprazole_NULL$lower_bound_null <= 0] <- 1e-10
merged_data_20_Lansoprazole_NULL$lower_bound_real[merged_data_20_Lansoprazole_NULL$lower_bound_real <= 0] <- 1e-10
merged_data_20_Lansoprazole_NULL$upper_bound_null[merged_data_20_Lansoprazole_NULL$upper_bound_null <= 0] <- 1e-10
merged_data_20_Lansoprazole_NULL$upper_bound_real[merged_data_20_Lansoprazole_NULL$upper_bound_real <= 0] <- 1e-10

# Filter to include only species with a mean relative abundance > 0.01 in the 'real' dataset
significant_species <- merged_data_20_Lansoprazole[merged_data_20_Lansoprazole$mean_rel_ab.real > 0.01, ]
survivors_20_Lansoprazole <- nrow(significant_species)
survivors_20_Lansoprazole

#should be the same as survivors defined above, since it is calculated from .real
significant_species_NULL <- merged_data_20_Lansoprazole_NULL[merged_data_20_Lansoprazole_NULL$mean_rel_ab.real > 0.01, ]
survivors_20_Lansoprazole_NULL <- nrow(significant_species_NULL)
survivors_20_Lansoprazole_NULL

# Adjusted order of magnitude check to include SD, only for significant species
significant_species$Predicted_magnitude_correct <- ifelse(
  (floor(log10(significant_species$lower_bound_pred)) <= floor(log10(significant_species$upper_bound_real)) &
     floor(log10(significant_species$upper_bound_pred)) >= floor(log10(significant_species$lower_bound_real))),
  1,
  0
)

#and for the Null model:
significant_species_NULL$Predicted_magnitude_correct <- ifelse(
  (floor(log10(significant_species_NULL$lower_bound_null)) <= floor(log10(significant_species_NULL$upper_bound_real)) &
     floor(log10(significant_species_NULL$upper_bound_null)) >= floor(log10(significant_species_NULL$lower_bound_real))),
  1,
  0
)

# Calculate the fraction of correctly predicted magnitudes for significant species
predicted_magnitude_correct_fraction_20_Lansoprazole <- sum(significant_species$Predicted_magnitude_correct) / nrow(significant_species)
predicted_magnitude_correct_fraction_20_Lansoprazole

predicted_magnitude_correct_fraction_20_Lansoprazole_NULL <- sum(significant_species_NULL$Predicted_magnitude_correct) / nrow(significant_species_NULL)
predicted_magnitude_correct_fraction_20_Lansoprazole_NULL

top_species_missing_20_Lansoprazole <- setdiff(top6_real_20_Lansoprazole_means, top6_predicted_20_Lansoprazole_means)
top_species_wrong_20_Lansoprazole <- setdiff(top6_predicted_20_Lansoprazole_means, top6_real_20_Lansoprazole_means)

top_species_missing_20_Lansoprazole <- if(length(top_species_missing_20_Lansoprazole) == 0) "None" else top_species_missing_20_Lansoprazole
top_species_wrong_20_Lansoprazole <- if(length(top_species_wrong_20_Lansoprazole) == 0) "None" else top_species_wrong_20_Lansoprazole

Prediction_quality_20_Lansoprazole <- data.frame(
  Top_six_correct = paste(top_six_correct_20_Lansoprazole, sep=""),
  Top_six_correct_NULL = paste(top_six_correct_20_Lansoprazole_NULL, sep=""),
  Top_six_correct_means = paste(top_six_correct_20_Lansoprazole_means, sep=""),
  Top_six_correct_means_NULL = paste(top_six_correct_20_Lansoprazole_means_NULL, sep=""),
  Predicted_magnitude_correct = paste(round(predicted_magnitude_correct_fraction_20_Lansoprazole * 100, 2), "%", sep=""),
  Predicted_magnitude_correct_NULL = paste(round(predicted_magnitude_correct_fraction_20_Lansoprazole_NULL * 100, 2), "%", sep=""),
  survivors_total = survivors_20_Lansoprazole,
  top_species_missing <- top_species_missing_20_Lansoprazole,
  top_species_wrong <- top_species_wrong_20_Lansoprazole, 
  predicted_mean_final_OD <- predicted_mean_final_od_20_Lansoprazole,
  real_mean_final_OD <- real_mean_final_od_20_Lansoprazole,
  sims_total = length(successful_sim_ids)
)

Prediction_quality_20_Lansoprazole






##Next, for 80 uM:
# Get top 6 species from plot_data_80_endpoint
# Adjust the plot_data_80_endpoint with confidence bounds
plot_data_80_Lansoprazole_endpoint <- plot_data_80_Lansoprazole_endpoint %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)

# Adjust the Lansoprazole_16S_80uM_summarised with confidence bounds
Lansoprazole_16S_80uM_summarised <- Lansoprazole_16S_80uM_summarised %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)

#NULL model:
Null_model_summarised <- Niclosamide_16S_0uM_summarised %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)


# Get top 6 species based on the lower bound from plot_data_80_endpoint
top6_predicted_80_Lansoprazole <- plot_data_80_Lansoprazole_endpoint %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

# Get top 6 species based on the lower bound from Lansoprazole_16S_80uM_summarised
top6_real_80_Lansoprazole <- Lansoprazole_16S_80uM_summarised %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

top6_NULL <- Null_model_summarised %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

# Calculate the overlap of top 6 species
top_six_correct_80_Lansoprazole <- length(intersect(top6_predicted_80_Lansoprazole, top6_real_80_Lansoprazole))
#top_six_correct_80_Lansoprazole

top_six_correct_80_Lansoprazole_NULL <- length(intersect(top6_NULL, top6_real_80_Lansoprazole))
#top_six_correct_80_Lansoprazole_NULL

#top6_predicted_80_Lansoprazole
#top6_real_80_Lansoprazole




#Now by means:
top6_predicted_80_Lansoprazole_means <- plot_data_80_Lansoprazole_endpoint %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)

# Get top 6 species based on the lower bound from Lansoprazole_16S_80uM_summarised
top6_real_80_Lansoprazole_means <- Lansoprazole_16S_80uM_summarised %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)

top6_NULL_means <- Null_model_summarised %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)



top_six_correct_80_Lansoprazole_means <- length(intersect(top6_predicted_80_Lansoprazole_means, top6_real_80_Lansoprazole_means))
#top_six_correct_80_Lansoprazole_means

top_six_correct_80_Lansoprazole_means_NULL <- length(intersect(top6_NULL_means, top6_real_80_Lansoprazole_means))
#top_six_correct_80_Lansoprazole_means_NULL

#top6_predicted_80_Lansoprazole_means
#top6_real_80_Lansoprazole_means




# Merge dataframes by Species
merged_data_80_Lansoprazole <- merge(plot_data_80_Lansoprazole_endpoint, Lansoprazole_16S_80uM_summarised, by = "Species", suffixes = c(".pred", ".real"))
merged_data_80_Lansoprazole_NULL <- merge(Niclosamide_16S_0uM_summarised, Lansoprazole_16S_80uM_summarised, by = "Species", suffixes = c(".null", ".real"))



# Create lower and upper bounds considering mean ¬± sd
merged_data_80_Lansoprazole$lower_bound_pred <- merged_data_80_Lansoprazole$mean_rel_ab.pred - merged_data_80_Lansoprazole$sd_rel_ab.pred
merged_data_80_Lansoprazole$upper_bound_pred <- merged_data_80_Lansoprazole$mean_rel_ab.pred + merged_data_80_Lansoprazole$sd_rel_ab.pred
merged_data_80_Lansoprazole$lower_bound_real <- merged_data_80_Lansoprazole$mean_rel_ab.real - merged_data_80_Lansoprazole$sd_rel_ab.real
merged_data_80_Lansoprazole$upper_bound_real <- merged_data_80_Lansoprazole$mean_rel_ab.real + merged_data_80_Lansoprazole$sd_rel_ab.real

# Ensure lower and upper bounds are non-negative, adjusting as necessary
merged_data_80_Lansoprazole$lower_bound_pred[merged_data_80_Lansoprazole$lower_bound_pred <= 0] <- 1e-10
merged_data_80_Lansoprazole$lower_bound_real[merged_data_80_Lansoprazole$lower_bound_real <= 0] <- 1e-10
merged_data_80_Lansoprazole$upper_bound_pred[merged_data_80_Lansoprazole$upper_bound_pred <= 0] <- 1e-10
merged_data_80_Lansoprazole$upper_bound_real[merged_data_80_Lansoprazole$upper_bound_real <= 0] <- 1e-10

##and for NULL model:
# Create lower and upper bounds considering mean ¬± sd
merged_data_80_Lansoprazole_NULL$lower_bound_null <- merged_data_80_Lansoprazole_NULL$mean_rel_ab.null - merged_data_80_Lansoprazole_NULL$sd_rel_ab.null
merged_data_80_Lansoprazole_NULL$upper_bound_null <- merged_data_80_Lansoprazole_NULL$mean_rel_ab.null + merged_data_80_Lansoprazole_NULL$sd_rel_ab.null
merged_data_80_Lansoprazole_NULL$lower_bound_real <- merged_data_80_Lansoprazole_NULL$mean_rel_ab.real - merged_data_80_Lansoprazole_NULL$sd_rel_ab.real
merged_data_80_Lansoprazole_NULL$upper_bound_real <- merged_data_80_Lansoprazole_NULL$mean_rel_ab.real + merged_data_80_Lansoprazole_NULL$sd_rel_ab.real

# Ensure lower and upper bounds are non-negative, adjusting as necessary
merged_data_80_Lansoprazole_NULL$lower_bound_null[merged_data_80_Lansoprazole_NULL$lower_bound_null <= 0] <- 1e-10
merged_data_80_Lansoprazole_NULL$lower_bound_real[merged_data_80_Lansoprazole_NULL$lower_bound_real <= 0] <- 1e-10
merged_data_80_Lansoprazole_NULL$upper_bound_null[merged_data_80_Lansoprazole_NULL$upper_bound_null <= 0] <- 1e-10
merged_data_80_Lansoprazole_NULL$upper_bound_real[merged_data_80_Lansoprazole_NULL$upper_bound_real <= 0] <- 1e-10

# Filter to include only species with a mean relative abundance > 0.01 in the 'real' dataset
significant_species <- merged_data_80_Lansoprazole[merged_data_80_Lansoprazole$mean_rel_ab.real > 0.01, ]
survivors_80_Lansoprazole <- nrow(significant_species)
survivors_80_Lansoprazole

#should be the same as survivors defined above, since it is calculated from .real
significant_species_NULL <- merged_data_80_Lansoprazole_NULL[merged_data_80_Lansoprazole_NULL$mean_rel_ab.real > 0.01, ]
survivors_80_Lansoprazole_NULL <- nrow(significant_species_NULL)
survivors_80_Lansoprazole_NULL

# Adjusted order of magnitude check to include SD, only for significant species
significant_species$Predicted_magnitude_correct <- ifelse(
  (floor(log10(significant_species$lower_bound_pred)) <= floor(log10(significant_species$upper_bound_real)) &
     floor(log10(significant_species$upper_bound_pred)) >= floor(log10(significant_species$lower_bound_real))),
  1,
  0
)

#and for the Null model:
significant_species_NULL$Predicted_magnitude_correct <- ifelse(
  (floor(log10(significant_species_NULL$lower_bound_null)) <= floor(log10(significant_species_NULL$upper_bound_real)) &
     floor(log10(significant_species_NULL$upper_bound_null)) >= floor(log10(significant_species_NULL$lower_bound_real))),
  1,
  0
)

# Calculate the fraction of correctly predicted magnitudes for significant species
predicted_magnitude_correct_fraction_80_Lansoprazole <- sum(significant_species$Predicted_magnitude_correct) / nrow(significant_species)
predicted_magnitude_correct_fraction_80_Lansoprazole

predicted_magnitude_correct_fraction_80_Lansoprazole_NULL <- sum(significant_species_NULL$Predicted_magnitude_correct) / nrow(significant_species_NULL)
predicted_magnitude_correct_fraction_80_Lansoprazole_NULL


top_species_missing_80_Lansoprazole <- setdiff(top6_real_80_Lansoprazole_means, top6_predicted_80_Lansoprazole_means)
top_species_wrong_80_Lansoprazole <- setdiff(top6_predicted_80_Lansoprazole_means, top6_real_80_Lansoprazole_means)

Prediction_quality_80_Lansoprazole <- data.frame(
  Top_six_correct = paste(top_six_correct_80_Lansoprazole, sep=""),
  Top_six_correct_NULL = paste(top_six_correct_80_Lansoprazole_NULL, sep=""),
  Top_six_correct_means = paste(top_six_correct_80_Lansoprazole_means, sep=""),
  Top_six_correct_means_NULL = paste(top_six_correct_80_Lansoprazole_means_NULL, sep=""),
  Predicted_magnitude_correct = paste(round(predicted_magnitude_correct_fraction_80_Lansoprazole * 100, 2), "%", sep=""),
  Predicted_magnitude_correct_NULL = paste(round(predicted_magnitude_correct_fraction_80_Lansoprazole_NULL * 100, 2), "%", sep=""),
  survivors_total = survivors_80_Lansoprazole,
  top_species_missing <- top_species_missing_80_Lansoprazole,
  top_species_wrong <- top_species_wrong_80_Lansoprazole, 
  predicted_mean_final_OD <- predicted_mean_final_od_80_Lansoprazole,
  real_mean_final_OD <- real_mean_final_od_80_Lansoprazole,
  sims_total = length(successful_sim_ids)
)

Prediction_quality_80_Lansoprazole










##Loratadine

combined_monoculture_aucs2_Loratadine <- subset(combined_monoculture_aucs2, drug == "Loratadine")


#drug sensitivity terms: define once outside of ODEs
y_function_B_vulgatus_Loratadine <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("B_vulgatus", "Loratadine", best_fitting_models_df_Loratadine)), collapse = " ")))
y_function_B_uniformis_Loratadine <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("B_uniformis", "Loratadine", best_fitting_models_df_Loratadine)), collapse = " ")))
y_function_B_fragilis_Loratadine <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("B_fragilis", "Loratadine", best_fitting_models_df_Loratadine)), collapse = " ")))
y_function_B_thetaiotaomicron_Loratadine <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("B_thetaiotaomicron", "Loratadine", best_fitting_models_df_Loratadine)), collapse = " ")))
y_function_C_ramosum_Loratadine <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("C_ramosum", "Loratadine", best_fitting_models_df_Loratadine)), collapse = " ")))
y_function_E_rectale_Loratadine <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("E_rectale", "Loratadine", best_fitting_models_df_Loratadine)), collapse = " ")))
y_function_R_intestinalis_Loratadine <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("R_intestinalis", "Loratadine", best_fitting_models_df_Loratadine)), collapse = " ")))
y_function_V_parvula_Loratadine <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("V_parvula", "Loratadine", best_fitting_models_df_Loratadine)), collapse = " ")))
y_function_E_lenta_Loratadine <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("E_lenta", "Loratadine", best_fitting_models_df_Loratadine)), collapse = " ")))
y_function_F_nucleatum_Loratadine <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("F_nucleatum", "Loratadine", best_fitting_models_df_Loratadine)), collapse = " ")))
y_function_C_bolteae_Loratadine <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("C_bolteae", "Loratadine", best_fitting_models_df_Loratadine)), collapse = " ")))
y_function_C_perfringens_Loratadine <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("C_perfringens", "Loratadine", best_fitting_models_df_Loratadine)), collapse = " ")))
y_function_C_saccharolyticum_Loratadine <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("C_saccharolyticum", "Loratadine", best_fitting_models_df_Loratadine)), collapse = " ")))
y_function_S_salivarius_Loratadine <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("S_salivarius", "Loratadine", best_fitting_models_df_Loratadine)), collapse = " ")))
y_function_R_gnavus_Loratadine <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("R_gnavus", "Loratadine", best_fitting_models_df_Loratadine)), collapse = " ")))
y_function_C_comes_Loratadine <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("C_comes", "Loratadine", best_fitting_models_df_Loratadine)), collapse = " ")))
y_function_P_merdae_Loratadine <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("P_merdae", "Loratadine", best_fitting_models_df_Loratadine)), collapse = " ")))
y_function_S_parasanguinis_Loratadine <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("S_parasanguinis", "Loratadine", best_fitting_models_df_Loratadine)), collapse = " ")))
y_function_C_aerofaciens_Loratadine <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("C_aerofaciens", "Loratadine", best_fitting_models_df_Loratadine)), collapse = " ")))
y_function_D_formicigenerans_Loratadine <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("D_formicigenerans", "Loratadine", best_fitting_models_df_Loratadine)), collapse = " ")))
y_function_E_coli_Loratadine <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("E_coli", "Loratadine", best_fitting_models_df_Loratadine)), collapse = " ")))



y_function_B_vulgatus_Loratadine_func <- eval(parse(text = paste("function(Drug) {", y_function_B_vulgatus_Loratadine, "}")))
y_function_B_uniformis_Loratadine_func <- eval(parse(text = paste("function(Drug) {", y_function_B_uniformis_Loratadine, "}")))
y_function_B_fragilis_Loratadine_func <- eval(parse(text = paste("function(Drug) {", y_function_B_fragilis_Loratadine, "}")))
y_function_B_thetaiotaomicron_Loratadine_func <- eval(parse(text = paste("function(Drug) {", y_function_B_thetaiotaomicron_Loratadine, "}")))
y_function_C_ramosum_Loratadine_func <- eval(parse(text = paste("function(Drug) {", y_function_C_ramosum_Loratadine, "}")))
y_function_E_rectale_Loratadine_func <- eval(parse(text = paste("function(Drug) {", y_function_E_rectale_Loratadine, "}")))
y_function_R_intestinalis_Loratadine_func <- eval(parse(text = paste("function(Drug) {", y_function_R_intestinalis_Loratadine, "}")))
y_function_E_lenta_Loratadine_func <- eval(parse(text = paste("function(Drug) {", y_function_E_lenta_Loratadine, "}")))
y_function_F_nucleatum_Loratadine_func <- eval(parse(text = paste("function(Drug) {", y_function_F_nucleatum_Loratadine, "}")))
y_function_C_bolteae_Loratadine_func <- eval(parse(text = paste("function(Drug) {", y_function_C_bolteae_Loratadine, "}")))
y_function_C_perfringens_Loratadine_func <- eval(parse(text = paste("function(Drug) {", y_function_C_perfringens_Loratadine, "}")))
y_function_C_saccharolyticum_Loratadine_func <- eval(parse(text = paste("function(Drug) {", y_function_C_saccharolyticum_Loratadine, "}")))
y_function_S_salivarius_Loratadine_func <- eval(parse(text = paste("function(Drug) {", y_function_S_salivarius_Loratadine, "}")))
y_function_R_gnavus_Loratadine_func <- eval(parse(text = paste("function(Drug) {", y_function_R_gnavus_Loratadine, "}")))
y_function_C_comes_Loratadine_func <- eval(parse(text = paste("function(Drug) {", y_function_C_comes_Loratadine, "}")))
y_function_P_merdae_Loratadine_func <- eval(parse(text = paste("function(Drug) {", y_function_P_merdae_Loratadine, "}")))
y_function_S_parasanguinis_Loratadine_func <- eval(parse(text = paste("function(Drug) {", y_function_S_parasanguinis_Loratadine, "}")))
y_function_C_aerofaciens_Loratadine_func <- eval(parse(text = paste("function(Drug) {", y_function_C_aerofaciens_Loratadine, "}")))
y_function_D_formicigenerans_Loratadine_func <- eval(parse(text = paste("function(Drug) {", y_function_D_formicigenerans_Loratadine, "}")))
y_function_E_coli_Loratadine_func <- eval(parse(text = paste("function(Drug) {", y_function_E_coli_Loratadine, "}")))
y_function_V_parvula_Loratadine_func <- eval(parse(text = paste("function(Drug) {", y_function_V_parvula_Loratadine, "}")))



unique(combined_monoculture_aucs2_Loratadine$conc)
##dictate drug concentration tested for simulation cycle here:
#drug_concentration_tested <- 5 #if manually or:
drug_concentration_tested <- unique(combined_monoculture_aucs2_Loratadine$conc)[1] 
initial_conditions <- rep(0.01/32, 32)
initial_conditions <- c(initial_conditions, drug_concentration_tested)


##drug effect fitted for species showing sensitivity in monoculture:
#unique(combined_monoculture_aucs2_Loratadine$Species)

##for more simple linear fits
closed.sir.model_Loratadine <- function (t, x, params) {
  ## first extract the state variables
  A_muciniphila <- x[1]
  B_adolescentis <- x[2]
  B_fragilis <- x[3]
  B_longum <- x[4]
  B_obeum <- x[5]
  B_thetaiotaomicron <- x[6]
  B_uniformis <- x[7]
  B_vulgatus <- x[8]
  B_wadsworthia <- x[9]
  C_aerofaciens <- x[10]
  C_bolteae <- x[11]
  C_comes <- x[12]
  C_perfringens <- x[13]
  C_ramosum <- x[14]
  C_saccharolyticum <- x[15]
  D_formicigenerans <- x[16]
  E_coli <- x[17]
  E_lenta <- x[18]
  E_rectale <- x[19]
  F_nucleatum <- x[20]
  L_paracasei <- x[21]
  O_splanchnicus <- x[22]
  P_copri <- x[23]
  P_distasonis <- x[24]
  P_merdae <- x[25]
  R_bromii <- x[26]
  R_gnavus <- x[27]
  R_intestinalis <- x[28]
  R_torques <- x[29]
  S_parasanguinis <- x[30]
  S_salivarius <- x[31]
  V_parvula <- x[32]
  Drug <- x[33]
  
  
  ## now extract the parameters
  r_B_fragilis <- flat_params[["B._fragilis.r"]]
  K_B_fragilis <- flat_params[["B._fragilis.K"]]
  r_B_longum <- flat_params[["B._longum.r"]]
  K_B_longum <- flat_params[["B._longum.K"]]
  r_B_thetaiotaomicron <- flat_params[["B._thetaiotaomicron.r"]]
  K_B_thetaiotaomicron <- flat_params[["B._thetaiotaomicron.K"]]
  r_B_uniformis <- flat_params[["B._uniformis.r"]]
  K_B_uniformis <- flat_params[["B._uniformis.K"]]
  r_B_vulgatus <- flat_params[["B._vulgatus.r"]]
  K_B_vulgatus <- flat_params[["B._vulgatus.K"]]
  r_B_wadsworthia <- flat_params[["B._wadsworthia.r"]]
  K_B_wadsworthia <- flat_params[["B._wadsworthia.K"]]
  r_C_aerofaciens <- flat_params[["C._aerofaciens.r"]]
  K_C_aerofaciens <- flat_params[["C._aerofaciens.K"]]
  r_C_bolteae <- flat_params[["C._bolteae.r"]]
  K_C_bolteae <- flat_params[["C._bolteae.K"]]
  r_C_comes <- flat_params[["C._comes.r"]]
  K_C_comes <- flat_params[["C._comes.K"]]
  r_C_perfringens <- flat_params[["C._perfringens.r"]]
  K_C_perfringens <- flat_params[["C._perfringens.K"]]
  r_C_ramosum <- flat_params[["C._ramosum.r"]]
  K_C_ramosum <- flat_params[["C._ramosum.K"]]
  r_C_saccharolyticum <- flat_params[["C._saccharolyticum.r"]]
  K_C_saccharolyticum <- flat_params[["C._saccharolyticum.K"]]
  r_D_formicigenerans <- flat_params[["D._formicigenerans.r"]]
  K_D_formicigenerans <- flat_params[["D._formicigenerans.K"]]
  r_E_coli <- flat_params[["E._coli.r"]]
  K_E_coli <- flat_params[["E._coli.K"]]
  r_E_lenta <- flat_params[["E._lenta.r"]]
  K_E_lenta <- flat_params[["E._lenta.K"]]
  r_E_rectale <- flat_params[["E._rectale.r"]]
  K_E_rectale <- flat_params[["E._rectale.K"]]
  r_F_nucleatum <- flat_params[["F._nucleatum.r"]]
  K_F_nucleatum <- flat_params[["F._nucleatum.K"]]
  r_P_copri <- flat_params[["P._copri.r"]]
  K_P_copri <- flat_params[["P._copri.K"]]
  r_P_merdae <- flat_params[["P._merdae.r"]]
  K_P_merdae <- flat_params[["P._merdae.K"]]
  r_R_gnavus <- flat_params[["R._gnavus.r"]]
  K_R_gnavus <- flat_params[["R._gnavus.K"]]
  r_R_intestinalis <- flat_params[["R._intestinalis.r"]]
  K_R_intestinalis <- flat_params[["R._intestinalis.K"]]
  r_V_parvula <- flat_params[["V._parvula.r"]]
  K_V_parvula <- flat_params[["V._parvula.K"]]
  r_A_muciniphila <- flat_params[["A._muciniphila.r"]]
  K_A_muciniphila <- flat_params[["A._muciniphila.K"]]
  r_B_adolescentis <- flat_params[["B._adolescentis.r"]]
  K_B_adolescentis <- flat_params[["B._adolescentis.K"]]
  r_B_obeum <- flat_params[["B._obeum.r"]]
  K_B_obeum <- flat_params[["B._obeum.K"]]
  r_O_splanchnicus <- flat_params[["O._splanchnicus.r"]]
  K_O_splanchnicus <- flat_params[["O._splanchnicus.K"]]
  r_P_distasonis <- flat_params[["P._distasonis.r"]]
  K_P_distasonis <- flat_params[["P._distasonis.K"]]
  r_R_bromii <- flat_params[["R._bromii.r"]]
  K_R_bromii <- flat_params[["R._bromii.K"]]
  r_R_torques <- flat_params[["R._torques.r"]]
  K_R_torques <- flat_params[["R._torques.K"]]
  r_S_parasanguinis <- flat_params[["S._parasanguinis.r"]]
  K_S_parasanguinis <-flat_params[["S._parasanguinis.K"]]
  r_S_salivarius <- flat_params[["S._salivarius.r"]]
  K_S_salivarius <- flat_params[["S._salivarius.K"]]
  r_L_paracasei <- flat_params[["L._paracasei.r"]]
  K_L_paracasei <- flat_params[["L._paracasei.K"]]
  
  
  t_mod <- ifelse(t > 24.1, t - 24.1, t)
  
  
  ## now code the model equations
  dA_muciniphila_dt <- r_A_muciniphila * A_muciniphila * (1 - A_muciniphila / K_A_muciniphila)
  dB_adolescentis_dt <- r_B_adolescentis * B_adolescentis * (1 - B_adolescentis / K_B_adolescentis)
  dB_fragilis_dt <- r_B_fragilis * B_fragilis * (1 - B_fragilis / max(0.0001, K_B_fragilis * (y_function_B_fragilis_Loratadine_func(Drug))))
  dB_longum_dt <- r_B_longum * B_longum * (1 - B_longum / K_B_longum)
  dB_obeum_dt <- r_B_obeum * B_obeum * (1 - B_obeum / K_B_obeum)
  dB_thetaiotaomicron_dt <- r_B_thetaiotaomicron * B_thetaiotaomicron * (1 - B_thetaiotaomicron / max(0.0001, K_B_thetaiotaomicron * (y_function_B_thetaiotaomicron_Loratadine_func(Drug))))  
  dB_uniformis_dt <- r_B_uniformis * B_uniformis * (1 - B_uniformis / max(0.0001, K_B_uniformis * (y_function_B_uniformis_Loratadine_func(Drug))))
  dB_vulgatus_dt <- r_B_vulgatus * B_vulgatus * (1 - B_vulgatus / max(0.0001, K_B_vulgatus * (y_function_B_vulgatus_Loratadine_func(Drug))))
  dB_wadsworthia_dt <- r_B_wadsworthia * B_wadsworthia * (1 - B_wadsworthia / K_B_wadsworthia)
  dC_aerofaciens_dt <- r_C_aerofaciens * C_aerofaciens * (1 - C_aerofaciens / max(0.0001, K_C_aerofaciens * (y_function_C_aerofaciens_Loratadine_func(Drug))))
  dC_bolteae_dt <- r_C_bolteae * C_bolteae * (1 - C_bolteae /  max(0.0001, K_C_bolteae * (y_function_C_bolteae_Loratadine_func(Drug))))
  dC_comes_dt <- r_C_comes * C_comes * (1 - C_comes / max(0.0001, K_C_comes * (y_function_C_comes_Loratadine_func(Drug))))
  dC_perfringens_dt <- r_C_perfringens * C_perfringens * (1 - C_perfringens / max(0.0001, K_C_perfringens * (y_function_C_perfringens_Loratadine_func(Drug))))
  dC_ramosum_dt <- r_C_ramosum * C_ramosum * (1 - C_ramosum / max(0.0001, K_C_ramosum * (y_function_C_ramosum_Loratadine_func(Drug))))
  dC_saccharolyticum_dt <- r_C_saccharolyticum * C_saccharolyticum * (1 - C_saccharolyticum / max(0.0001, K_C_saccharolyticum * (y_function_C_saccharolyticum_Loratadine_func(Drug))))
  dD_formicigenerans_dt <- r_D_formicigenerans * D_formicigenerans * (1 - D_formicigenerans / max(0.0001, K_D_formicigenerans * (y_function_D_formicigenerans_Loratadine_func(Drug))))
  dE_coli_dt <- r_E_coli * E_coli * (1 - E_coli / max(0.0001, K_E_coli * (y_function_E_coli_Loratadine_func(Drug))))
  dE_lenta_dt <- r_E_lenta * E_lenta * (1 - E_lenta / max(0.0001, K_E_lenta * (y_function_E_lenta_Loratadine_func(Drug))))
  dE_rectale_dt <- r_E_rectale * E_rectale * (1 - E_rectale / max(0.0001, K_E_rectale * (y_function_E_rectale_Loratadine_func(Drug))))
  dF_nucleatum_dt <- r_F_nucleatum * F_nucleatum * (1 - F_nucleatum / max(0.0001, K_F_nucleatum * (y_function_F_nucleatum_Loratadine_func(Drug))))
  dL_paracasei_dt <- r_L_paracasei * L_paracasei * (1 - L_paracasei / K_L_paracasei)  
  dO_splanchnicus_dt <- r_O_splanchnicus * O_splanchnicus * (1 - O_splanchnicus / K_O_splanchnicus)  
  dP_copri_dt <- r_P_copri * P_copri * (1 - P_copri / K_P_copri)
  dP_distasonis_dt <- r_P_distasonis * P_distasonis * (1 - P_distasonis / K_P_distasonis)  
  dP_merdae_dt <- r_P_merdae * P_merdae * (1 - P_merdae / max(0.0001, K_P_merdae * (y_function_P_merdae_Loratadine_func(Drug))))
  dR_bromii_dt <- r_R_bromii * R_bromii * (1 - R_bromii / K_R_bromii) 
  dR_gnavus_dt <- r_R_gnavus * R_gnavus * (1 - R_gnavus / max(0.0001, K_R_gnavus * (y_function_R_gnavus_Loratadine_func(Drug))))
  dR_intestinalis_dt <- r_R_intestinalis * R_intestinalis * (1 - R_intestinalis / max(0.0001, K_R_intestinalis * (y_function_R_intestinalis_Loratadine_func(Drug))))
  dR_torques_dt <- r_R_torques * R_torques * (1 - R_torques /K_R_torques) 
  dS_parasanguinis_dt <- r_S_parasanguinis * S_parasanguinis * (1 - S_parasanguinis / max(0.0001, K_S_parasanguinis * (y_function_S_parasanguinis_Loratadine_func(Drug))))
  dS_salivarius_dt <- r_S_salivarius * S_salivarius * (1 - S_salivarius / max(0.0001, K_S_salivarius * (y_function_S_salivarius_Loratadine_func(Drug))))
  dV_parvula_dt <- r_V_parvula * V_parvula * (1 - V_parvula / max(0.0001, K_V_parvula * (y_function_V_parvula_Loratadine_func(Drug))))
  
  
  
  #Drug differential:
  dDrug_dt <- (subset(drug_dynamics, Drug == "Loratadine")$Steepness_param_community * exp(-subset(drug_dynamics, Drug == "Loratadine")$Steepness_param_community * t_mod)) * (drug_concentration_tested * prop_left_Loratadine - drug_concentration_tested)
  #dDrug_dt <- 0
  
  ## Combine results into a single vector
  dxdt <- c(dA_muciniphila_dt, dB_adolescentis_dt, dB_fragilis_dt, dB_longum_dt, dB_obeum_dt, dB_thetaiotaomicron_dt, dB_uniformis_dt, dB_vulgatus_dt, dB_wadsworthia_dt, dC_aerofaciens_dt, dC_bolteae_dt, dC_comes_dt, dC_perfringens_dt, dC_ramosum_dt, dC_saccharolyticum_dt, dD_formicigenerans_dt, dE_coli_dt, dE_lenta_dt, dE_rectale_dt, dF_nucleatum_dt, dL_paracasei_dt, dO_splanchnicus_dt, dP_copri_dt, dP_distasonis_dt, dP_merdae_dt, dR_bromii_dt, dR_gnavus_dt, dR_intestinalis_dt, dR_torques_dt, dS_parasanguinis_dt, dS_salivarius_dt, dV_parvula_dt, dDrug_dt)
  
  ## Return result as a list
  list(dxdt)
}




#calculate the co-culture correction factor per species based on community composition in absence of drug, just like done for Niclosamide

growth_data_all_0_Niclosamide
growth_data_all_0_Niclosamide1 <- growth_data_all_0_Niclosamide %>%
  dplyr::mutate(Species = gsub(" ", "_", Species))


# Merge rel_ab_control with growth_data_all_0_Niclosamide on Species
# Function to remove duplicated columns by name pattern
clean_columns_base <- function(df, pattern) {
  cols_to_keep <- !grepl(pattern, names(df))
  df <- df[, cols_to_keep]
  return(df)
}

# Use the new function to clean up your dataframe
rel_ab_control <- clean_columns_base(rel_ab_control, "mean_max_OD.[xy]")
str(rel_ab_control)


#rel_ab_control$correction_factor <- rel_ab_control$mean_rel_ab / (rel_ab_control$mean_max_OD/sum(rel_ab_control$mean_max_OD))
# Calculate correction factor with a minimum value of ~1
rel_ab_control$correction_factor <- pmax(rel_ab_control$mean_rel_ab / (rel_ab_control$mean_max_OD / sum(rel_ab_control$mean_max_OD)), 1.1)


# Create a new dataframe for co-culture correction
co_culture_correction <- data.frame(
  species = rel_ab_control$Species,
  correction_factor = rel_ab_control$correction_factor
)


#summarise community data
#Adjust based on tested concentrations for each drug
unique(Community_compositions_focus_drugs_Loratadine$concentration)

Community_compositions_focus_drugs_Loratadine_5uM <- subset(Community_compositions_focus_drugs_Loratadine, concentration == 5)
Community_compositions_focus_drugs_Loratadine_20uM <- subset(Community_compositions_focus_drugs_Loratadine, concentration == 20)
Community_compositions_focus_drugs_Loratadine_80uM <- subset(Community_compositions_focus_drugs_Loratadine, concentration == 80)


#5 uM
Community_compositions_focus_drugs_Loratadine_5uM_summarised <- Community_compositions_focus_drugs_Loratadine_5uM %>%
  dplyr::group_by(species) %>%                                  
  dplyr::summarize(
    mean_rel_ab = mean(rel_abundance, na.rm = TRUE),     
    sd_rel_ab = sd(rel_abundance, na.rm = TRUE) ,
    mean_max_OD = mean(maxOD, na.rm = TRUE),
    sd_max_OD = sd(maxOD, na.rm = TRUE),
    mean_final_OD = mean(finalOD, na.rm = TRUE),
    sd_final_OD = sd(finalOD, na.rm = TRUE)
  ) %>%
  dplyr::ungroup() 


Community_compositions_focus_drugs_Loratadine_5uM_summarised <- Community_compositions_focus_drugs_Loratadine_5uM_summarised %>%
  dplyr::mutate(Species = sub("^(\\w)\\w*\\s(.*)", "\\1._\\2", species))

#remove (sub)strain info
Community_compositions_focus_drugs_Loratadine_5uM_summarised <- Community_compositions_focus_drugs_Loratadine_5uM_summarised %>%
  dplyr::mutate(Species = sub("^(\\w\\._\\w+).*", "\\1", Species))


#20 uM
Community_compositions_focus_drugs_Loratadine_20uM_summarised <- Community_compositions_focus_drugs_Loratadine_20uM %>%
  dplyr::group_by(species) %>%                                  
  dplyr::summarize(
    mean_rel_ab = mean(rel_abundance, na.rm = TRUE),     
    sd_rel_ab = sd(rel_abundance, na.rm = TRUE) ,
    mean_max_OD = mean(maxOD, na.rm = TRUE),
    sd_max_OD = sd(maxOD, na.rm = TRUE),
    mean_final_OD = mean(finalOD, na.rm = TRUE),
    sd_final_OD = sd(finalOD, na.rm = TRUE)
  ) %>%
  dplyr::ungroup() 


Community_compositions_focus_drugs_Loratadine_20uM_summarised <- Community_compositions_focus_drugs_Loratadine_20uM_summarised %>%
  dplyr::mutate(Species = sub("^(\\w)\\w*\\s(.*)", "\\1._\\2", species))

#remove (sub)strain info
Community_compositions_focus_drugs_Loratadine_20uM_summarised <- Community_compositions_focus_drugs_Loratadine_20uM_summarised %>%
  dplyr::mutate(Species = sub("^(\\w\\._\\w+).*", "\\1", Species))


#80 uM
Community_compositions_focus_drugs_Loratadine_80uM_summarised <- Community_compositions_focus_drugs_Loratadine_80uM %>%
  dplyr::group_by(species) %>%                                  
  dplyr::summarize(
    mean_rel_ab = mean(rel_abundance, na.rm = TRUE),     
    sd_rel_ab = sd(rel_abundance, na.rm = TRUE) ,
    mean_max_OD = mean(maxOD, na.rm = TRUE),
    sd_max_OD = sd(maxOD, na.rm = TRUE),    
    mean_final_OD = mean(finalOD, na.rm = TRUE),
    sd_final_OD = sd(finalOD, na.rm = TRUE)
  ) %>%
  dplyr::ungroup() 



Community_compositions_focus_drugs_Loratadine_80uM_summarised <- Community_compositions_focus_drugs_Loratadine_80uM_summarised %>%
  dplyr::mutate(Species = sub("^(\\w)\\w*\\s(.*)", "\\1._\\2", species))

#remove (sub)strain info
Community_compositions_focus_drugs_Loratadine_80uM_summarised <- Community_compositions_focus_drugs_Loratadine_80uM_summarised %>%
  dplyr::mutate(Species = sub("^(\\w\\._\\w+).*", "\\1", Species))


#Initialise data frames
sim_output <- data.frame()
input_params_list <- list() #Use a list to collect parameters for each simulation

#number of simulations
num_sims <- 250


for (i in 1:num_sims) {
  tryCatch({
    # generate model parameters
    set.seed(i) #set a different seed for each simulation for variation
    params <- lapply(1:nrow(growth_data_all_0_Niclosamide), function(idx) {
      species_params <- growth_data_all_0_Niclosamide[idx, ]
      list(
        r = rnorm(1, mean = species_params$mean_max_Growth_rate, sd = species_params$sd_max_Growth_rate),
        K = rnorm(1, mean = species_params$mean_max_OD, sd = species_params$sd_max_OD)
      )
    })
    names(params) <- gsub(" ", "_", growth_data_all_0_Niclosamide$Species)
    flat_params <- unlist(params)
    names(flat_params) <- gsub("\\.\\d$", "", names(flat_params))
    
    #replace spaces with underscores to match formatting
    co_culture_correction$species <- gsub(" ", "_", co_culture_correction$species, fixed = TRUE)
    
    #replace the species-specific K parameters extracted from monoculture growth data 
    #with drawn relative abundance values at Niclosamide = 0, scaled to K
    rel_ab_control$Species <- gsub(" ", "_", rel_ab_control$Species)
    
    #Initialise an empty vector to store drawn values
    drawn_values <- numeric(nrow(rel_ab_control))
    
    #draw values from their respective distributions
    for (k in 1:nrow(rel_ab_control)) {
      species_name <- rel_ab_control$Species[k]
      drawn_value <- rnorm(1, mean = rel_ab_control$mean_rel_ab[k], sd = rel_ab_control$sd_rel_ab[k])
      drawn_values[k] <- max(drawn_value, 0)  # Ensure no negative values
    }
    
    #Normalise drawn relative abundance values so they sum to 1 (to reflect a 'true' relative abundance distribution)
    #this is needed so when we convert the values into OD units by multiplying with the drawn community maxOD,
    # the sum of K_i parameters and the drawn K are equal
    normalised_values <- drawn_values / sum(drawn_values)
    
    #Pull community maxOD (K) at 0 drugs from respective normal distribution:
    K <- rnorm(n = 1, mean = rel_ab_control$mean_com_max_OD[1], sd = rel_ab_control$sd_com_max_OD[1])
    
    # Assign these normalised values to their respective species' .K parameters
    for (k in 1:nrow(rel_ab_control)) {
      species_name <- rel_ab_control$Species[k]
      k_index <- grep(paste0("^", species_name, "\\.K$"), names(flat_params))
      
      if (length(k_index) > 0) {
        old_value <- flat_params[k_index]
        flat_params[k_index] <- (normalised_values[k] + 0.0001) * K #add small value in case drawn K_i is 0, which would cause issues with the solver
        cat(sprintf("Updated %s from %f to %f using normalised value %f scaled by K %f\n", names(flat_params)[k_index], old_value, flat_params[k_index], normalised_values[k], K))
      }
    }
    
    #Accounting for variation in drug degradation by community, with standard deviation of end concentration (at 10h) around the fitted predicted (relative) end concentration at 24h
    #prop_left_Loratadine <- abs(rnorm(1, (subset(drug_dynamics, Drug == "Loratadine")$Prop_left_24h_community), (subset(drug_dynamics, Drug == "Loratadine")$SD_drug_community))) 
    #below, we account for measurement error rather than ecological drivers that lead to the variability of degradation at the final point measured 
    prop_left_Loratadine <- abs(rnorm(
      n = 1, 
      mean = subset(drug_dynamics, Drug == "Loratadine")$Prop_left_24h_community, 
      sd = ifelse(
        subset(drug_dynamics, Drug == "Loratadine")$SD_drug_community > subset(drug_dynamics, Drug == "Loratadine")$SD_drug_community_start, 
        subset(drug_dynamics, Drug == "Loratadine")$SD_drug_community - subset(drug_dynamics, Drug == "Loratadine")$SD_drug_community_start, 
        subset(drug_dynamics, Drug == "Loratadine")$SD_drug_community
      )
    ))
    
    
    #loop through each species in co_culture_correction
    for (j in 1:nrow(co_culture_correction)) {
      # Extract the species name and correction factor
      species_name <- co_culture_correction$species[j]
      correction_factor <- co_culture_correction$correction_factor[j]
      
      # Identify the corresponding growth rate parameter in flat_params
      #by matching the base species name (without .r)
      growth_rate_indices <- grep(paste0("^", species_name, "\\.r$"), names(flat_params))
      
      #take the growth rate parameter and apply the correction factor 
      for (index in growth_rate_indices) {
        flat_params[index] <- flat_params[index] * correction_factor
      }
    }
    
    flat_params
    # Store parameters for each simulation
    input_params_list[[i]] <- c(sim_ID = i, flat_params)
    
    # Run the model for the first 24-hour cycle
    solution_cycle_1 <- ode(y = initial_conditions, times = seq(from = 0, to = 24, by = 0.1), func = closed.sir.model_Loratadine, parms = flat_params,   method = "lsoda", rtol = 1e-6, atol = 1e-6)
    
    # Dilution and second cycle
    end_of_cycle_1 <- solution_cycle_1[nrow(solution_cycle_1), -1]
    initial_conditions_cycle_2 <- end_of_cycle_1 / 50
    #accounting for the drugs being added with the new growth cycle as well:
    initial_conditions_cycle_2[33] <- initial_conditions_cycle_2[33] + drug_concentration_tested
    solution_cycle_2 <- ode(y = initial_conditions_cycle_2, times = seq(from = 24, to = 48, by = 0.1), func = closed.sir.model_Loratadine, parms = flat_params,  method = "lsoda", rtol = 1e-6, atol = 1e-6)
    
    # Combine and format results
    combined_solution <- rbind(as.data.frame(solution_cycle_1), as.data.frame(solution_cycle_2)[-1,])
    combined_solution$sim_ID <- rep(i, nrow(combined_solution))
    combined_solution <- combined_solution %>%
      tidyr::gather(key = "Species", value = "Density", -time, -sim_ID) %>%
      dplyr::mutate(Hour = time) %>%
      dplyr::select(sim_ID, Hour, Species, Density)
    
    ##Append to sim_output
    sim_output <- rbind(sim_output, combined_solution)
  }, error = function(e) {
    cat(sprintf("Skipping simulation %d due to an error: %s\n", i, e$message))
  })
}



##Combine all parameter data into a single dataframe
input_params <- do.call(rbind, input_params_list)

# Add a "Species" column 
sim_output$Species_name <- species_names[as.numeric(as.character(sim_output$Species))]
sim_output$Species_name <- replace_na(sim_output$Species_name, "Drug")

#View(input_params)
#View(sim_output)

sim_output <- na.omit(sim_output)
successful_sim_ids <- unique(subset(sim_output, Hour == 48)$sim_ID)
length(successful_sim_ids)
sim_output1 <- sim_output[sim_output$sim_ID %in% successful_sim_ids, ]


#Transform sim_output so we have wide format by Species
sim_output_wide <- tidyr::pivot_wider(sim_output1, 
                                      names_from = Species_name, 
                                      values_from = Density,
                                      id_cols = c(sim_ID, Hour))

length(unique(sim_output_wide$sim_ID))
#calc community OD per timepoint
sim_output_wide$Total_OD <- rowSums(sim_output_wide[, 3:34], na.rm = TRUE)
#calculate and add relative abundances here as well:
species_columns <- colnames(sim_output_wide)[3:34] 

for (species in species_columns) {
  sim_output_wide[[paste0("rel_", species)]] <- sim_output_wide[[species]] / sim_output_wide$Total_OD
}


#assign sim_output_wide test conditions to dataframe name
drug_tested <- "Loratadine"
variable_name_1 <- paste0("sim_output_wide_", ifelse(drug_concentration_tested == 1e-04, 0, drug_concentration_tested), "_", drug_tested)
assign(variable_name_1, sim_output_wide)

#turn back into long format if interested in plotting relative abundances
cols_needed <- c("sim_ID", "Hour")

sim_output_long <- sim_output_wide %>% 
  dplyr::select(sim_ID, Hour, Drug, starts_with("rel_")) %>% 
  tidyr::pivot_longer(
    cols = c(Drug, starts_with("rel_")),
    names_to = "Species", 
    values_to = "Relative_abundance",
    names_prefix = "rel_",
    names_transform = list(Species = ~ ifelse(.x == "Drug", "Drug", .x))
  ) 

str(sim_output_long)


species_names_1 <- c(
  "A_muciniphila",
  "B_adolescentis",
  "B_fragilis",
  "B_longum",
  "B_obeum",
  "B_thetaiotaomicron",
  "B_uniformis",
  "B_vulgatus",
  "B_wadsworthia",
  "C_aerofaciens",
  "C_bolteae",
  "C_comes",
  "C_perfringens",
  "C_ramosum",
  "C_saccharolyticum",
  "D_formicigenerans",
  "E_coli",
  "E_lenta",
  "E_rectale",
  "F_nucleatum",
  "L_paracasei",
  "O_splanchnicus",
  "P_copri",
  "P_distasonis",
  "P_merdae",
  "R_bromii",
  "R_gnavus",
  "R_intestinalis",
  "R_torques",
  "S_parasanguinis",
  "S_salivarius",
  "V_parvula",
  "Drug"
)

species_colours_1 <- c(
  "A_muciniphila" = "#1f77b4",
  "B_adolescentis" = "#ff7f0e",
  "B_fragilis" = "#2ca02c",
  "B_longum" = "#d62728",
  "B_obeum" = "#9467bd",
  "B_thetaiotaomicron" = "black",
  "B_uniformis" = "#e377c2",
  "B_vulgatus" = "#7f7f7f",
  "B_wadsworthia" = "gold1",
  "C_aerofaciens" = "#aec7e8",
  "C_bolteae" = "#ffbb78",
  "C_comes" = "magenta",
  "C_perfringens" = "#ff9896",
  "C_ramosum" = "#c5b0d5",
  "C_saccharolyticum" = "#c49c94",
  "D_formicigenerans" = "#f7b6d2",
  "E_coli" = "yellow",
  "E_lenta" = "turquoise",
  "E_rectale" = "#393b79",
  "F_nucleatum" = "royalblue2",
  "L_paracasei" = "blue",
  "O_splanchnicus" = "#637939",
  "P_copri" = "cyan",
  "P_distasonis" = "#8c6d31",
  "P_merdae" = "#c7c7c7",
  "R_bromii" = "#e6550d",
  "R_gnavus" = "#e7cb94",
  "R_intestinalis" = "#843c39",
  "R_torques" = "#d6616b",
  "S_parasanguinis" = "orange3",
  "S_salivarius" = "#7b4173",
  "V_parvula" = "#ce6dbd",
  "Drug" = "green"
)



##Plot output for any specific sim:
# ggplot(subset(sim_output, sim_ID == 1 & Species_name != "Drug"), aes(x = Hour, y = Density, group = Species_name, color = Species_name)) +
#   geom_line(size = 1, alpha = 0.7) +
#   scale_color_manual(values = species_colours_1) +
#   labs(title = paste0("Loratadine = ", drug_concentration_tested),
#        x = "Time (hours)",
#        y = "Population Density (OD)",
#        color = "Species") +
#   theme_minimal() +
#   theme(legend.position = "right")
# 
# ggplot(subset(sim_output, sim_ID == 3 & Species_name != "Drug"), aes(x = Hour, y = Density, group = Species_name, color = Species_name)) +
#   geom_line(size = 1, alpha = 0.7) +
#   scale_color_manual(values = species_colours_1) +
#   labs(title = paste0("Loratadine = ", drug_concentration_tested),
#        x = "Time (hours)",
#        y = "Population Density (OD)",
#        color = "Species") +
#   theme_minimal() +
#   theme(legend.position = "right")


ggplot(subset(sim_output_long, sim_ID == 1), aes(x = Hour, y = Relative_abundance, group = Species, color = Species)) +
  geom_line(size = 1, alpha = 0.7) +
  scale_color_manual(values = species_colours_1) +
  labs(title = paste0("Loratadine = ", drug_concentration_tested),
       x = "Time (hours)",
       y = "Relative abundance",
       color = "Species") +
  theme_minimal() +
  theme(legend.position = "right")


ggplot(subset(sim_output_long, sim_ID == 3), aes(x = Hour, y = Relative_abundance, group = Species, color = Species)) +
  geom_line(size = 1, alpha = 0.7) +
  scale_color_manual(values = species_colours_1) +
  labs(title = paste0("Loratadine = ", drug_concentration_tested),
       x = "Time (hours)",
       y = "Relative abundance",
       color = "Species") +
  theme_minimal() +
  theme(legend.position = "right")


#calc mean and standard deviation across sims
sim_stats <- sim_output_long %>%
  dplyr::group_by(Hour, Species) %>%
  dplyr::summarise(
    mean_rel_ab = mean(Relative_abundance),
    sd_rel_ab = sd(Relative_abundance),
    .groups = 'drop'
  )

# Prepare the data for plotting
plot_data <- sim_stats %>%
  dplyr::mutate(Upper = mean_rel_ab + sd_rel_ab, Lower = mean_rel_ab - sd_rel_ab)

ggplot(subset(plot_data, Species != "Drug"), aes(x = Hour, y = mean_rel_ab, group = Species, color = Species)) +
  geom_ribbon(aes(ymin = Lower, ymax = Upper, fill = Species), colour = NA, alpha = 0.2) +  
  geom_line(size = 1, alpha = 0.7) + 
  scale_color_manual(values = species_colours_1) +
  scale_fill_manual(values = species_colours_1) +  
  labs(title = "Mean and SD of Relative Abundance Across Simulations",
       subtitle = paste0("Loratadine = ", drug_concentration_tested),       
       x = "Time (hours)",
       y = "Relative abundance",
       color = "Species",
       fill = "Species") +
  theme_minimal() +
  theme(legend.position = "right")

#log-scaled mean trends
ggplot(plot_data, aes(x = Hour, y = log10(mean_rel_ab + 0.0001), group = Species, color = Species)) +
  geom_line(size = 1, alpha = 0.7) +  # Mean line
  scale_color_manual(values = species_colours_1) +
  scale_fill_manual(values = species_colours_1) +  # Ensure consistent colors for lines and fills
  labs(title = "Mean and SD of Relative Abundance Across Simulations",
       subtitle = paste0("Loratadine = ", drug_concentration_tested),
       x = "Time (hours)",
       y = "Relative abundance",
       color = "Species",
       fill = "Species") +
  theme_minimal() +
  theme(legend.position = "right")




##prediction quality evaluation
drug_tested <- "Loratadine"
variable_name <- paste0("plot_data_", ifelse(drug_concentration_tested == 1e-04, 0, drug_concentration_tested), "_", drug_tested)
assign(variable_name, plot_data)


#extract total OD info:
predicted_mean_final_od_NULL <- Niclosamide_16S_0uM_summarised$mean_com_final_OD[1]
predicted_sd_final_od_NULL <- Niclosamide_16S_0uM_summarised$sd_com_final_OD[1]

predicted_mean_final_od_5_Loratadine <- mean(subset(sim_output_wide_5_Loratadine, Hour == 48)$Total_OD, na.rm = TRUE)
predicted_sd_final_od_5_Loratadine <- sd(subset(sim_output_wide_5_Loratadine, Hour == 48)$Total_OD, na.rm = TRUE)

real_mean_final_od_5_Loratadine <- Community_compositions_focus_drugs_Loratadine_5uM_summarised$mean_final_OD[1]
real_sd_final_od_5_Loratadine <- Community_compositions_focus_drugs_Loratadine_5uM_summarised$sd_final_OD[1]


predicted_mean_final_od_20_Loratadine <- mean(subset(sim_output_wide_20_Loratadine, Hour == 48)$Total_OD, na.rm = TRUE)
predicted_sd_final_od_20_Loratadine <- sd(subset(sim_output_wide_20_Loratadine, Hour == 48)$Total_OD, na.rm = TRUE)

real_mean_final_od_20_Loratadine <- Community_compositions_focus_drugs_Loratadine_20uM_summarised$mean_final_OD[1]
real_sd_final_od_20_Loratadine <- Community_compositions_focus_drugs_Loratadine_20uM_summarised$sd_final_OD[1]


predicted_mean_final_od_80_Loratadine <- mean(subset(sim_output_wide_80_Loratadine, Hour == 48)$Total_OD, na.rm = TRUE)
predicted_sd_final_od_80_Loratadine <- sd(subset(sim_output_wide_80_Loratadine, Hour == 48)$Total_OD, na.rm = TRUE)

real_mean_final_od_80_Loratadine <- Community_compositions_focus_drugs_Loratadine_80uM_summarised$mean_final_OD[1]
real_sd_final_od_80_Loratadine <- Community_compositions_focus_drugs_Loratadine_80uM_summarised$sd_final_OD[1]




#plot_data_0_Loratadine_endpoint was used to test model performance at 0 drugs
#plot_data_0_Loratadine_endpoint <- subset(plot_data_0_Loratadine, Hour == 48 & Species != "Drug")
plot_data_5_Loratadine_endpoint <- subset(plot_data_5_Loratadine, Hour == 48 & Species != "Drug")
plot_data_20_Loratadine_endpoint <- subset(plot_data_20_Loratadine, Hour == 48 & Species != "Drug")
plot_data_80_Loratadine_endpoint <- subset(plot_data_80_Loratadine, Hour == 48 & Species != "Drug")

##Inspecting 'match' to real relative abundance distributions:
Niclosamide_16S_0uM_summarised <- rel_ab_control
Niclosamide_16S_0uM_summarised$Species <- gsub("\\.", "", Niclosamide_16S_0uM_summarised$Species)

Loratadine_16S_5uM_summarised <- Community_compositions_focus_drugs_Loratadine_5uM_summarised
Loratadine_16S_20uM_summarised <- Community_compositions_focus_drugs_Loratadine_20uM_summarised
Loratadine_16S_80uM_summarised <- Community_compositions_focus_drugs_Loratadine_80uM_summarised

Niclosamide_16S_0uM_summarised
Loratadine_16S_5uM_summarised 
Loratadine_16S_20uM_summarised 
Loratadine_16S_80uM_summarised 

#Rename 'species' so the outputs become comparable
original_names_80 <- unique(Loratadine_16S_80uM_summarised$species)
original_names_20 <- unique(Loratadine_16S_20uM_summarised$species)
original_names_5 <- unique(Loratadine_16S_5uM_summarised$species)


##Create a named vector with the original and new names mapping
name_changes <- c(
  "Akkermansia muciniphila" = "A_muciniphila",
  "Bacteroides fragilis" = "B_fragilis",
  "Bacteroides thetaiotaomicron" = "B_thetaiotaomicron",
  "Bacteroides uniformis" = "B_uniformis",
  "Bifidobacterium adolescentis" = "B_adolescentis",
  "Bifidobacterium longum subsp. longum" = "B_longum",
  "Bilophila wadsworthia" = "B_wadsworthia",
  "Blautia obeum" = "B_obeum",
  "Clostridium perfringens" = "C_perfringens",
  "Collinsella aerofaciens" = "C_aerofaciens",
  "Coprococcus comes" = "C_comes",
  "Dorea formicigenerans" = "D_formicigenerans",
  "Eggerthella lenta" = "E_lenta",
  "Enterocloster bolteae" = "C_bolteae",
  "Erysipelatoclostridium ramosum" = "C_ramosum",
  "Escherichia coli ED1a" = "E_coli",
  "Eubacterium rectale" = "E_rectale",
  "Fusobacterium nucleatum subsp. nucleatum" = "F_nucleatum",
  "Lacrimispora saccharolytica" = "C_saccharolyticum",
  "Lacticaseibacillus paracasei" = "L_paracasei",
  "Odoribacter splanchnicus" = "O_splanchnicus",
  "Parabacteroides distasonis" = "P_distasonis",
  "Parabacteroides merdae" = "P_merdae",
  "Phocaeicola vulgatus" = "B_vulgatus",
  "Prevotella copri" = "P_copri",
  "Roseburia intestinalis" = "R_intestinalis",
  "Ruminococcus bromii" = "R_bromii",
  "Ruminococcus gnavus" = "R_gnavus",
  "Ruminococcus torques" = "R_torques",
  "Streptococcus parasanguinis" = "S_parasanguinis",
  "Streptococcus salivarius" = "S_salivarius",
  "Veillonella parvula" = "V_parvula"
)

# Apply name changes to the species column in Loratadine_16S_80uM_summarised

Loratadine_16S_80uM_summarised$Species <- name_changes[Loratadine_16S_80uM_summarised$species]
Loratadine_16S_20uM_summarised$Species <- name_changes[Loratadine_16S_20uM_summarised$species]
Loratadine_16S_5uM_summarised$Species <- name_changes[Loratadine_16S_5uM_summarised$species]

# Verify the changes
unique(Loratadine_16S_80uM_summarised$Species)
unique(Loratadine_16S_20uM_summarised$Species)
unique(Loratadine_16S_5uM_summarised$Species)



##First, for 5 uM:
# Get top 6 species from plot_data_5_endpoint
# Adjust the plot_data_5_endpoint with confidence bounds

# #plot_data_0_Loratadine_endpoint was used to test model performance at 0 drugs
# plot_data_0_Loratadine_endpoint <- plot_data_0_Loratadine_endpoint %>%
#   dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)

plot_data_5_Loratadine_endpoint <- plot_data_5_Loratadine_endpoint %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)

# Adjust the Loratadine_16S_5uM_summarised with confidence bounds
Loratadine_16S_5uM_summarised <- Loratadine_16S_5uM_summarised %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)

#NULL model:
Null_model_summarised <- Niclosamide_16S_0uM_summarised %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)


# Get top 6 species based on the lower bound from plot_data_5_endpoint

#top6_predicted_0_Loratadine was used to test model performance at 0 drugs
# top6_predicted_0_Loratadine <- plot_data_0_Loratadine_endpoint %>%
#    arrange(desc(lower_bound)) %>%
#    slice(1:6) %>%
#    pull(Species)

top6_predicted_5_Loratadine <- plot_data_5_Loratadine_endpoint %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

# Get top 6 species based on the lower bound from Loratadine_16S_5uM_summarised
top6_real_5_Loratadine <- Loratadine_16S_5uM_summarised %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

top6_NULL <- Null_model_summarised %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

# Calculate the overlap of top 6 species

#top_six_correct_0_Loratadine was used to assess model performance at 0 drugs
# top_six_correct_0_Loratadine <- length(intersect(top6_predicted_0_Loratadine, top6_NULL))
# top_six_correct_0_Loratadine

top_six_correct_5_Loratadine <- length(intersect(top6_predicted_5_Loratadine, top6_real_5_Loratadine))
top_six_correct_5_Loratadine

top_six_correct_5_Loratadine_NULL <- length(intersect(top6_NULL, top6_real_5_Loratadine))
top_six_correct_5_Loratadine_NULL

top6_predicted_5_Loratadine
top6_real_5_Loratadine

#top6_NULL

#Now by means:
# #top6_predicted_0_Loratadine_means was used to assess model performance at 0 drugs
# top6_predicted_0_Loratadine_means <- plot_data_0_Loratadine_endpoint %>%
#    arrange(desc(mean_rel_ab)) %>%
#    slice(1:6) %>%
#    pull(Species)

top6_predicted_5_Loratadine_means <- plot_data_5_Loratadine_endpoint %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)

# Get top 6 species based on the lower bound from Loratadine_16S_5uM_summarised
top6_real_5_Loratadine_means <- Loratadine_16S_5uM_summarised %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)

top6_NULL_means <- Null_model_summarised %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)


# #top_six_correct_0_Loratadine_means was used to assess model performance at 0 drugs
# top_six_correct_0_Loratadine_means <- length(intersect(top6_predicted_0_Loratadine_means, top6_NULL_means))
# top_six_correct_0_Loratadine_means

top_six_correct_5_Loratadine_means <- length(intersect(top6_predicted_5_Loratadine_means, top6_real_5_Loratadine_means))
top_six_correct_5_Loratadine_means

top_six_correct_5_Loratadine_means_NULL <- length(intersect(top6_NULL_means, top6_real_5_Loratadine_means))
top_six_correct_5_Loratadine_means_NULL

top6_predicted_5_Loratadine_means
top6_real_5_Loratadine_means

#top6_NULL_means


# Merge dataframes by Species

#merged_data_0_Loratadine was used to assess model performance at 0 drugs
#merged_data_0_Loratadine <- merge(plot_data_0_Loratadine_endpoint, Niclosamide_16S_0uM_summarised, by = "Species", suffixes = c(".pred", ".real"))
merged_data_5_Loratadine <- merge(plot_data_5_Loratadine_endpoint, Loratadine_16S_5uM_summarised, by = "Species", suffixes = c(".pred", ".real"))
merged_data_5_Loratadine_NULL <- merge(Niclosamide_16S_0uM_summarised, Loratadine_16S_5uM_summarised, by = "Species", suffixes = c(".null", ".real"))


## Below lines used for assessing model performance at 0 drugs; ignore for nonzero concentrations
# # Create lower and upper bounds considering mean ¬± sd
# merged_data_0_Loratadine$lower_bound_pred <- merged_data_0_Loratadine$mean_rel_ab.pred - merged_data_0_Loratadine$sd_rel_ab.pred
# merged_data_0_Loratadine$upper_bound_pred <- merged_data_0_Loratadine$mean_rel_ab.pred + merged_data_0_Loratadine$sd_rel_ab.pred
# merged_data_0_Loratadine$lower_bound_real <- merged_data_0_Loratadine$mean_rel_ab.real - merged_data_0_Loratadine$sd_rel_ab.real
# merged_data_0_Loratadine$upper_bound_real <- merged_data_0_Loratadine$mean_rel_ab.real + merged_data_0_Loratadine$sd_rel_ab.real
# 
# # Ensure lower and upper bounds are non-negative, adjusting as necessary
# merged_data_0_Loratadine$lower_bound_pred[merged_data_0_Loratadine$lower_bound_pred <= 0] <- 1e-10
# merged_data_0_Loratadine$lower_bound_real[merged_data_0_Loratadine$lower_bound_real <= 0] <- 1e-10
# merged_data_0_Loratadine$upper_bound_pred[merged_data_0_Loratadine$upper_bound_pred <= 0] <- 1e-10
# merged_data_0_Loratadine$upper_bound_real[merged_data_0_Loratadine$upper_bound_real <= 0] <- 1e-10


# Create lower and upper bounds considering mean ¬± sd
merged_data_5_Loratadine$lower_bound_pred <- merged_data_5_Loratadine$mean_rel_ab.pred - merged_data_5_Loratadine$sd_rel_ab.pred
merged_data_5_Loratadine$upper_bound_pred <- merged_data_5_Loratadine$mean_rel_ab.pred + merged_data_5_Loratadine$sd_rel_ab.pred
merged_data_5_Loratadine$lower_bound_real <- merged_data_5_Loratadine$mean_rel_ab.real - merged_data_5_Loratadine$sd_rel_ab.real
merged_data_5_Loratadine$upper_bound_real <- merged_data_5_Loratadine$mean_rel_ab.real + merged_data_5_Loratadine$sd_rel_ab.real

# Ensure lower and upper bounds are non-negative, adjusting as necessary
merged_data_5_Loratadine$lower_bound_pred[merged_data_5_Loratadine$lower_bound_pred <= 0] <- 1e-10
merged_data_5_Loratadine$lower_bound_real[merged_data_5_Loratadine$lower_bound_real <= 0] <- 1e-10
merged_data_5_Loratadine$upper_bound_pred[merged_data_5_Loratadine$upper_bound_pred <= 0] <- 1e-10
merged_data_5_Loratadine$upper_bound_real[merged_data_5_Loratadine$upper_bound_real <= 0] <- 1e-10

##and for NULL model:
# Create lower and upper bounds considering mean ¬± sd
merged_data_5_Loratadine_NULL$lower_bound_null <- merged_data_5_Loratadine_NULL$mean_rel_ab.null - merged_data_5_Loratadine_NULL$sd_rel_ab.null
merged_data_5_Loratadine_NULL$upper_bound_null <- merged_data_5_Loratadine_NULL$mean_rel_ab.null + merged_data_5_Loratadine_NULL$sd_rel_ab.null
merged_data_5_Loratadine_NULL$lower_bound_real <- merged_data_5_Loratadine_NULL$mean_rel_ab.real - merged_data_5_Loratadine_NULL$sd_rel_ab.real
merged_data_5_Loratadine_NULL$upper_bound_real <- merged_data_5_Loratadine_NULL$mean_rel_ab.real + merged_data_5_Loratadine_NULL$sd_rel_ab.real

# Ensure lower and upper bounds are non-negative, adjusting as necessary
merged_data_5_Loratadine_NULL$lower_bound_null[merged_data_5_Loratadine_NULL$lower_bound_null <= 0] <- 1e-10
merged_data_5_Loratadine_NULL$lower_bound_real[merged_data_5_Loratadine_NULL$lower_bound_real <= 0] <- 1e-10
merged_data_5_Loratadine_NULL$upper_bound_null[merged_data_5_Loratadine_NULL$upper_bound_null <= 0] <- 1e-10
merged_data_5_Loratadine_NULL$upper_bound_real[merged_data_5_Loratadine_NULL$upper_bound_real <= 0] <- 1e-10

# Filter to include only species with a mean relative abundance > 0.01 in the 'real' dataset

## significant_species_0 was used to assess model performance at 0 drugs
#significant_species_0 <- merged_data_0_Loratadine[merged_data_0_Loratadine$mean_rel_ab.real > 0.01, ]
significant_species <- merged_data_5_Loratadine[merged_data_5_Loratadine$mean_rel_ab.real > 0.01, ]
survivors_5_Loratadine <- nrow(significant_species)
survivors_5_Loratadine

#should be the same as survivors defined above, since it is calculated from .real
significant_species_NULL <- merged_data_5_Loratadine_NULL[merged_data_5_Loratadine_NULL$mean_rel_ab.real > 0.01, ]
survivors_5_Loratadine_NULL <- nrow(significant_species_NULL)
survivors_5_Loratadine_NULL

# Adjusted order of magnitude check to include SD, only for significant species
## below code was used to assess model performance at 0 drugs
# significant_species_0$Predicted_magnitude_correct <- ifelse(
#   (floor(log10(significant_species_0$lower_bound_pred)) <= floor(log10(significant_species_0$upper_bound_real)) &
#      floor(log10(significant_species_0$upper_bound_pred)) >= floor(log10(significant_species_0$lower_bound_real))),
#   1,
#   0
# )

significant_species$Predicted_magnitude_correct <- ifelse(
  (floor(log10(significant_species$lower_bound_pred)) <= floor(log10(significant_species$upper_bound_real)) &
     floor(log10(significant_species$upper_bound_pred)) >= floor(log10(significant_species$lower_bound_real))),
  1,
  0
)

#and for the Null model:
significant_species_NULL$Predicted_magnitude_correct <- ifelse(
  (floor(log10(significant_species_NULL$lower_bound_null)) <= floor(log10(significant_species_NULL$upper_bound_real)) &
     floor(log10(significant_species_NULL$upper_bound_null)) >= floor(log10(significant_species_NULL$lower_bound_real))),
  1,
  0
)

# Calculate the fraction of correctly predicted magnitudes for significant species
## below code was used to assess model performance at 0 drugs
#predicted_magnitude_correct_fraction_0_Loratadine <- sum(significant_species_0$Predicted_magnitude_correct) / nrow(significant_species_0)
#predicted_magnitude_correct_fraction_0_Loratadine

predicted_magnitude_correct_fraction_5_Loratadine <- sum(significant_species$Predicted_magnitude_correct) / nrow(significant_species)
predicted_magnitude_correct_fraction_5_Loratadine

predicted_magnitude_correct_fraction_5_Loratadine_NULL <- sum(significant_species_NULL$Predicted_magnitude_correct) / nrow(significant_species_NULL)
predicted_magnitude_correct_fraction_5_Loratadine_NULL

top_species_missing_5_Loratadine <- setdiff(top6_real_5_Loratadine_means, top6_predicted_5_Loratadine_means)
top_species_wrong_5_Loratadine <- setdiff(top6_predicted_5_Loratadine_means, top6_real_5_Loratadine_means)

top_species_missing_5_Loratadine <- if(length(top_species_missing_5_Loratadine) == 0) "None" else top_species_missing_5_Loratadine
top_species_wrong_5_Loratadine <- if(length(top_species_wrong_5_Loratadine) == 0) "None" else top_species_wrong_5_Loratadine

Prediction_quality_5_Loratadine <- data.frame(
  Top_six_correct = paste(top_six_correct_5_Loratadine, sep=""),
  Top_six_correct_NULL = paste(top_six_correct_5_Loratadine_NULL, sep=""),
  Top_six_correct_means = paste(top_six_correct_5_Loratadine_means, sep=""),
  Top_six_correct_means_NULL = paste(top_six_correct_5_Loratadine_means_NULL, sep=""),
  Predicted_magnitude_correct = paste(round(predicted_magnitude_correct_fraction_5_Loratadine * 100, 2), "%", sep=""),
  Predicted_magnitude_correct_NULL = paste(round(predicted_magnitude_correct_fraction_5_Loratadine_NULL * 100, 2), "%", sep=""),
  survivors_total = survivors_5_Loratadine,
  top_species_missing <- top_species_missing_5_Loratadine,
  top_species_wrong <- top_species_wrong_5_Loratadine, 
  predicted_mean_final_OD <- predicted_mean_final_od_5_Loratadine,
  real_mean_final_OD <- real_mean_final_od_5_Loratadine,
  sims_total = length(successful_sim_ids)
)



Prediction_quality_5_Loratadine



##Next, for 20 uM:
# Get top 6 species from plot_data_20_endpoint
# Adjust the plot_data_20_endpoint with confidence bounds
plot_data_20_Loratadine_endpoint <- plot_data_20_Loratadine_endpoint %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)

# Adjust the Loratadine_16S_20uM_summarised with confidence bounds
Loratadine_16S_20uM_summarised <- Loratadine_16S_20uM_summarised %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)

#NULL model:
Null_model_summarised <- Niclosamide_16S_0uM_summarised %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)


# Get top 6 species based on the lower bound from plot_data_20_endpoint
top6_predicted_20_Loratadine <- plot_data_20_Loratadine_endpoint %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

# Get top 6 species based on the lower bound from Loratadine_16S_20uM_summarised
top6_real_20_Loratadine <- Loratadine_16S_20uM_summarised %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

top6_NULL <- Null_model_summarised %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

# Calculate the overlap of top 6 species
top_six_correct_20_Loratadine <- length(intersect(top6_predicted_20_Loratadine, top6_real_20_Loratadine))
#top_six_correct_20_Loratadine

top_six_correct_20_Loratadine_NULL <- length(intersect(top6_NULL, top6_real_20_Loratadine))
#top_six_correct_20_Loratadine_NULL

#top6_predicted_20_Loratadine
#top6_real_20_Loratadine



#Now by means:
top6_predicted_20_Loratadine_means <- plot_data_20_Loratadine_endpoint %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)

# Get top 6 species based on the lower bound from Loratadine_16S_20uM_summarised
top6_real_20_Loratadine_means <- Loratadine_16S_20uM_summarised %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)

top6_NULL_means <- Null_model_summarised %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)



top_six_correct_20_Loratadine_means <- length(intersect(top6_predicted_20_Loratadine_means, top6_real_20_Loratadine_means))
#top_six_correct_20_Loratadine_means

top_six_correct_20_Loratadine_means_NULL <- length(intersect(top6_NULL_means, top6_real_20_Loratadine_means))
#top_six_correct_20_Loratadine_means_NULL

top6_predicted_20_Loratadine_means
#top6_real_20_Loratadine_means




# Merge dataframes by Species
merged_data_20_Loratadine <- merge(plot_data_20_Loratadine_endpoint, Loratadine_16S_20uM_summarised, by = "Species", suffixes = c(".pred", ".real"))
merged_data_20_Loratadine_NULL <- merge(Niclosamide_16S_0uM_summarised, Loratadine_16S_20uM_summarised, by = "Species", suffixes = c(".null", ".real"))



# Create lower and upper bounds considering mean ¬± sd
merged_data_20_Loratadine$lower_bound_pred <- merged_data_20_Loratadine$mean_rel_ab.pred - merged_data_20_Loratadine$sd_rel_ab.pred
merged_data_20_Loratadine$upper_bound_pred <- merged_data_20_Loratadine$mean_rel_ab.pred + merged_data_20_Loratadine$sd_rel_ab.pred
merged_data_20_Loratadine$lower_bound_real <- merged_data_20_Loratadine$mean_rel_ab.real - merged_data_20_Loratadine$sd_rel_ab.real
merged_data_20_Loratadine$upper_bound_real <- merged_data_20_Loratadine$mean_rel_ab.real + merged_data_20_Loratadine$sd_rel_ab.real

# Ensure lower and upper bounds are non-negative, adjusting as necessary
merged_data_20_Loratadine$lower_bound_pred[merged_data_20_Loratadine$lower_bound_pred <= 0] <- 1e-10
merged_data_20_Loratadine$lower_bound_real[merged_data_20_Loratadine$lower_bound_real <= 0] <- 1e-10
merged_data_20_Loratadine$upper_bound_pred[merged_data_20_Loratadine$upper_bound_pred <= 0] <- 1e-10
merged_data_20_Loratadine$upper_bound_real[merged_data_20_Loratadine$upper_bound_real <= 0] <- 1e-10

##and for NULL model:
# Create lower and upper bounds considering mean ¬± sd
merged_data_20_Loratadine_NULL$lower_bound_null <- merged_data_20_Loratadine_NULL$mean_rel_ab.null - merged_data_20_Loratadine_NULL$sd_rel_ab.null
merged_data_20_Loratadine_NULL$upper_bound_null <- merged_data_20_Loratadine_NULL$mean_rel_ab.null + merged_data_20_Loratadine_NULL$sd_rel_ab.null
merged_data_20_Loratadine_NULL$lower_bound_real <- merged_data_20_Loratadine_NULL$mean_rel_ab.real - merged_data_20_Loratadine_NULL$sd_rel_ab.real
merged_data_20_Loratadine_NULL$upper_bound_real <- merged_data_20_Loratadine_NULL$mean_rel_ab.real + merged_data_20_Loratadine_NULL$sd_rel_ab.real

# Ensure lower and upper bounds are non-negative, adjusting as necessary
merged_data_20_Loratadine_NULL$lower_bound_null[merged_data_20_Loratadine_NULL$lower_bound_null <= 0] <- 1e-10
merged_data_20_Loratadine_NULL$lower_bound_real[merged_data_20_Loratadine_NULL$lower_bound_real <= 0] <- 1e-10
merged_data_20_Loratadine_NULL$upper_bound_null[merged_data_20_Loratadine_NULL$upper_bound_null <= 0] <- 1e-10
merged_data_20_Loratadine_NULL$upper_bound_real[merged_data_20_Loratadine_NULL$upper_bound_real <= 0] <- 1e-10

# Filter to include only species with a mean relative abundance > 0.01 in the 'real' dataset
significant_species <- merged_data_20_Loratadine[merged_data_20_Loratadine$mean_rel_ab.real > 0.01, ]
survivors_20_Loratadine <- nrow(significant_species)
survivors_20_Loratadine

#should be the same as survivors defined above, since it is calculated from .real
significant_species_NULL <- merged_data_20_Loratadine_NULL[merged_data_20_Loratadine_NULL$mean_rel_ab.real > 0.01, ]
survivors_20_Loratadine_NULL <- nrow(significant_species_NULL)
survivors_20_Loratadine_NULL

# Adjusted order of magnitude check to include SD, only for significant species
significant_species$Predicted_magnitude_correct <- ifelse(
  (floor(log10(significant_species$lower_bound_pred)) <= floor(log10(significant_species$upper_bound_real)) &
     floor(log10(significant_species$upper_bound_pred)) >= floor(log10(significant_species$lower_bound_real))),
  1,
  0
)

#and for the Null model:
significant_species_NULL$Predicted_magnitude_correct <- ifelse(
  (floor(log10(significant_species_NULL$lower_bound_null)) <= floor(log10(significant_species_NULL$upper_bound_real)) &
     floor(log10(significant_species_NULL$upper_bound_null)) >= floor(log10(significant_species_NULL$lower_bound_real))),
  1,
  0
)

# Calculate the fraction of correctly predicted magnitudes for significant species
predicted_magnitude_correct_fraction_20_Loratadine <- sum(significant_species$Predicted_magnitude_correct) / nrow(significant_species)
predicted_magnitude_correct_fraction_20_Loratadine

predicted_magnitude_correct_fraction_20_Loratadine_NULL <- sum(significant_species_NULL$Predicted_magnitude_correct) / nrow(significant_species_NULL)
predicted_magnitude_correct_fraction_20_Loratadine_NULL

top_species_missing_20_Loratadine <- setdiff(top6_real_20_Loratadine_means, top6_predicted_20_Loratadine_means)
top_species_wrong_20_Loratadine <- setdiff(top6_predicted_20_Loratadine_means, top6_real_20_Loratadine_means)

top_species_missing_20_Loratadine <- if(length(top_species_missing_20_Loratadine) == 0) "None" else top_species_missing_20_Loratadine
top_species_wrong_20_Loratadine <- if(length(top_species_wrong_20_Loratadine) == 0) "None" else top_species_wrong_20_Loratadine

Prediction_quality_20_Loratadine <- data.frame(
  Top_six_correct = paste(top_six_correct_20_Loratadine, sep=""),
  Top_six_correct_NULL = paste(top_six_correct_20_Loratadine_NULL, sep=""),
  Top_six_correct_means = paste(top_six_correct_20_Loratadine_means, sep=""),
  Top_six_correct_means_NULL = paste(top_six_correct_20_Loratadine_means_NULL, sep=""),
  Predicted_magnitude_correct = paste(round(predicted_magnitude_correct_fraction_20_Loratadine * 100, 2), "%", sep=""),
  Predicted_magnitude_correct_NULL = paste(round(predicted_magnitude_correct_fraction_20_Loratadine_NULL * 100, 2), "%", sep=""),
  survivors_total = survivors_20_Loratadine,
  top_species_missing <- top_species_missing_20_Loratadine,
  top_species_wrong <- top_species_wrong_20_Loratadine, 
  predicted_mean_final_OD <- predicted_mean_final_od_20_Loratadine,
  real_mean_final_OD <- real_mean_final_od_20_Loratadine,
  sims_total = length(successful_sim_ids)
)

Prediction_quality_20_Loratadine






##Next, for 80 uM:
# Get top 6 species from plot_data_80_endpoint
# Adjust the plot_data_80_endpoint with confidence bounds
plot_data_80_Loratadine_endpoint <- plot_data_80_Loratadine_endpoint %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)

# Adjust the Loratadine_16S_80uM_summarised with confidence bounds
Loratadine_16S_80uM_summarised <- Loratadine_16S_80uM_summarised %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)

#NULL model:
Null_model_summarised <- Niclosamide_16S_0uM_summarised %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)


# Get top 6 species based on the lower bound from plot_data_80_endpoint
top6_predicted_80_Loratadine <- plot_data_80_Loratadine_endpoint %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

# Get top 6 species based on the lower bound from Loratadine_16S_80uM_summarised
top6_real_80_Loratadine <- Loratadine_16S_80uM_summarised %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

top6_NULL <- Null_model_summarised %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

# Calculate the overlap of top 6 species
top_six_correct_80_Loratadine <- length(intersect(top6_predicted_80_Loratadine, top6_real_80_Loratadine))
#top_six_correct_80_Loratadine

top_six_correct_80_Loratadine_NULL <- length(intersect(top6_NULL, top6_real_80_Loratadine))
#top_six_correct_80_Loratadine_NULL

#top6_predicted_80_Loratadine
#top6_real_80_Loratadine




#Now by means:
top6_predicted_80_Loratadine_means <- plot_data_80_Loratadine_endpoint %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)

# Get top 6 species based on the lower bound from Loratadine_16S_80uM_summarised
top6_real_80_Loratadine_means <- Loratadine_16S_80uM_summarised %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)

top6_NULL_means <- Null_model_summarised %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)



top_six_correct_80_Loratadine_means <- length(intersect(top6_predicted_80_Loratadine_means, top6_real_80_Loratadine_means))
#top_six_correct_80_Loratadine_means

top_six_correct_80_Loratadine_means_NULL <- length(intersect(top6_NULL_means, top6_real_80_Loratadine_means))
#top_six_correct_80_Loratadine_means_NULL

#top6_predicted_80_Loratadine_means
#top6_real_80_Loratadine_means




# Merge dataframes by Species
merged_data_80_Loratadine <- merge(plot_data_80_Loratadine_endpoint, Loratadine_16S_80uM_summarised, by = "Species", suffixes = c(".pred", ".real"))
merged_data_80_Loratadine_NULL <- merge(Niclosamide_16S_0uM_summarised, Loratadine_16S_80uM_summarised, by = "Species", suffixes = c(".null", ".real"))



# Create lower and upper bounds considering mean ¬± sd
merged_data_80_Loratadine$lower_bound_pred <- merged_data_80_Loratadine$mean_rel_ab.pred - merged_data_80_Loratadine$sd_rel_ab.pred
merged_data_80_Loratadine$upper_bound_pred <- merged_data_80_Loratadine$mean_rel_ab.pred + merged_data_80_Loratadine$sd_rel_ab.pred
merged_data_80_Loratadine$lower_bound_real <- merged_data_80_Loratadine$mean_rel_ab.real - merged_data_80_Loratadine$sd_rel_ab.real
merged_data_80_Loratadine$upper_bound_real <- merged_data_80_Loratadine$mean_rel_ab.real + merged_data_80_Loratadine$sd_rel_ab.real

# Ensure lower and upper bounds are non-negative, adjusting as necessary
merged_data_80_Loratadine$lower_bound_pred[merged_data_80_Loratadine$lower_bound_pred <= 0] <- 1e-10
merged_data_80_Loratadine$lower_bound_real[merged_data_80_Loratadine$lower_bound_real <= 0] <- 1e-10
merged_data_80_Loratadine$upper_bound_pred[merged_data_80_Loratadine$upper_bound_pred <= 0] <- 1e-10
merged_data_80_Loratadine$upper_bound_real[merged_data_80_Loratadine$upper_bound_real <= 0] <- 1e-10

##and for NULL model:
# Create lower and upper bounds considering mean ¬± sd
merged_data_80_Loratadine_NULL$lower_bound_null <- merged_data_80_Loratadine_NULL$mean_rel_ab.null - merged_data_80_Loratadine_NULL$sd_rel_ab.null
merged_data_80_Loratadine_NULL$upper_bound_null <- merged_data_80_Loratadine_NULL$mean_rel_ab.null + merged_data_80_Loratadine_NULL$sd_rel_ab.null
merged_data_80_Loratadine_NULL$lower_bound_real <- merged_data_80_Loratadine_NULL$mean_rel_ab.real - merged_data_80_Loratadine_NULL$sd_rel_ab.real
merged_data_80_Loratadine_NULL$upper_bound_real <- merged_data_80_Loratadine_NULL$mean_rel_ab.real + merged_data_80_Loratadine_NULL$sd_rel_ab.real

# Ensure lower and upper bounds are non-negative, adjusting as necessary
merged_data_80_Loratadine_NULL$lower_bound_null[merged_data_80_Loratadine_NULL$lower_bound_null <= 0] <- 1e-10
merged_data_80_Loratadine_NULL$lower_bound_real[merged_data_80_Loratadine_NULL$lower_bound_real <= 0] <- 1e-10
merged_data_80_Loratadine_NULL$upper_bound_null[merged_data_80_Loratadine_NULL$upper_bound_null <= 0] <- 1e-10
merged_data_80_Loratadine_NULL$upper_bound_real[merged_data_80_Loratadine_NULL$upper_bound_real <= 0] <- 1e-10

# Filter to include only species with a mean relative abundance > 0.01 in the 'real' dataset
significant_species <- merged_data_80_Loratadine[merged_data_80_Loratadine$mean_rel_ab.real > 0.01, ]
survivors_80_Loratadine <- nrow(significant_species)
survivors_80_Loratadine

#should be the same as survivors defined above, since it is calculated from .real
significant_species_NULL <- merged_data_80_Loratadine_NULL[merged_data_80_Loratadine_NULL$mean_rel_ab.real > 0.01, ]
survivors_80_Loratadine_NULL <- nrow(significant_species_NULL)
survivors_80_Loratadine_NULL

# Adjusted order of magnitude check to include SD, only for significant species
significant_species$Predicted_magnitude_correct <- ifelse(
  (floor(log10(significant_species$lower_bound_pred)) <= floor(log10(significant_species$upper_bound_real)) &
     floor(log10(significant_species$upper_bound_pred)) >= floor(log10(significant_species$lower_bound_real))),
  1,
  0
)

#and for the Null model:
significant_species_NULL$Predicted_magnitude_correct <- ifelse(
  (floor(log10(significant_species_NULL$lower_bound_null)) <= floor(log10(significant_species_NULL$upper_bound_real)) &
     floor(log10(significant_species_NULL$upper_bound_null)) >= floor(log10(significant_species_NULL$lower_bound_real))),
  1,
  0
)

# Calculate the fraction of correctly predicted magnitudes for significant species
predicted_magnitude_correct_fraction_80_Loratadine <- sum(significant_species$Predicted_magnitude_correct) / nrow(significant_species)
predicted_magnitude_correct_fraction_80_Loratadine

predicted_magnitude_correct_fraction_80_Loratadine_NULL <- sum(significant_species_NULL$Predicted_magnitude_correct) / nrow(significant_species_NULL)
predicted_magnitude_correct_fraction_80_Loratadine_NULL


top_species_missing_80_Loratadine <- setdiff(top6_real_80_Loratadine_means, top6_predicted_80_Loratadine_means)
top_species_wrong_80_Loratadine <- setdiff(top6_predicted_80_Loratadine_means, top6_real_80_Loratadine_means)

top_species_missing_80_Loratadine <- if(length(top_species_missing_80_Loratadine) == 0) "None" else top_species_missing_80_Loratadine
top_species_wrong_80_Loratadine <- if(length(top_species_wrong_80_Loratadine) == 0) "None" else top_species_wrong_80_Loratadine

Prediction_quality_80_Loratadine <- data.frame(
  Top_six_correct = paste(top_six_correct_80_Loratadine, sep=""),
  Top_six_correct_NULL = paste(top_six_correct_80_Loratadine_NULL, sep=""),
  Top_six_correct_means = paste(top_six_correct_80_Loratadine_means, sep=""),
  Top_six_correct_means_NULL = paste(top_six_correct_80_Loratadine_means_NULL, sep=""),
  Predicted_magnitude_correct = paste(round(predicted_magnitude_correct_fraction_80_Loratadine * 100, 2), "%", sep=""),
  Predicted_magnitude_correct_NULL = paste(round(predicted_magnitude_correct_fraction_80_Loratadine_NULL * 100, 2), "%", sep=""),
  survivors_total = survivors_80_Loratadine,
  top_species_missing <- top_species_missing_80_Loratadine,
  top_species_wrong <- top_species_wrong_80_Loratadine, 
  predicted_mean_final_OD <- predicted_mean_final_od_80_Loratadine,
  real_mean_final_OD <- real_mean_final_od_80_Loratadine,
  sims_total = length(successful_sim_ids)
)

Prediction_quality_80_Loratadine








##Loxapine

combined_monoculture_aucs2_Loxapine <- subset(combined_monoculture_aucs2, drug == "Loxapine")


#drug sensitivity terms: define once outside of ODEs
y_function_B_vulgatus_Loxapine <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("B_vulgatus", "Loxapine", best_fitting_models_df_Loxapine)), collapse = " ")))
y_function_B_uniformis_Loxapine <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("B_uniformis", "Loxapine", best_fitting_models_df_Loxapine)), collapse = " ")))
y_function_B_fragilis_Loxapine <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("B_fragilis", "Loxapine", best_fitting_models_df_Loxapine)), collapse = " ")))
y_function_B_thetaiotaomicron_Loxapine <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("B_thetaiotaomicron", "Loxapine", best_fitting_models_df_Loxapine)), collapse = " ")))
y_function_C_ramosum_Loxapine <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("C_ramosum", "Loxapine", best_fitting_models_df_Loxapine)), collapse = " ")))
y_function_E_rectale_Loxapine <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("E_rectale", "Loxapine", best_fitting_models_df_Loxapine)), collapse = " ")))
y_function_R_intestinalis_Loxapine <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("R_intestinalis", "Loxapine", best_fitting_models_df_Loxapine)), collapse = " ")))
y_function_V_parvula_Loxapine <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("V_parvula", "Loxapine", best_fitting_models_df_Loxapine)), collapse = " ")))
y_function_E_lenta_Loxapine <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("E_lenta", "Loxapine", best_fitting_models_df_Loxapine)), collapse = " ")))
y_function_F_nucleatum_Loxapine <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("F_nucleatum", "Loxapine", best_fitting_models_df_Loxapine)), collapse = " ")))
y_function_C_bolteae_Loxapine <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("C_bolteae", "Loxapine", best_fitting_models_df_Loxapine)), collapse = " ")))
y_function_C_perfringens_Loxapine <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("C_perfringens", "Loxapine", best_fitting_models_df_Loxapine)), collapse = " ")))
y_function_C_saccharolyticum_Loxapine <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("C_saccharolyticum", "Loxapine", best_fitting_models_df_Loxapine)), collapse = " ")))
y_function_S_salivarius_Loxapine <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("S_salivarius", "Loxapine", best_fitting_models_df_Loxapine)), collapse = " ")))
y_function_R_gnavus_Loxapine <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("R_gnavus", "Loxapine", best_fitting_models_df_Loxapine)), collapse = " ")))
y_function_C_comes_Loxapine <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("C_comes", "Loxapine", best_fitting_models_df_Loxapine)), collapse = " ")))
y_function_P_merdae_Loxapine <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("P_merdae", "Loxapine", best_fitting_models_df_Loxapine)), collapse = " ")))
y_function_S_parasanguinis_Loxapine <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("S_parasanguinis", "Loxapine", best_fitting_models_df_Loxapine)), collapse = " ")))
y_function_C_aerofaciens_Loxapine <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("C_aerofaciens", "Loxapine", best_fitting_models_df_Loxapine)), collapse = " ")))
y_function_D_formicigenerans_Loxapine <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("D_formicigenerans", "Loxapine", best_fitting_models_df_Loxapine)), collapse = " ")))
y_function_E_coli_Loxapine <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("E_coli", "Loxapine", best_fitting_models_df_Loxapine)), collapse = " ")))



y_function_B_vulgatus_Loxapine_func <- eval(parse(text = paste("function(Drug) {", y_function_B_vulgatus_Loxapine, "}")))
y_function_B_uniformis_Loxapine_func <- eval(parse(text = paste("function(Drug) {", y_function_B_uniformis_Loxapine, "}")))
y_function_B_fragilis_Loxapine_func <- eval(parse(text = paste("function(Drug) {", y_function_B_fragilis_Loxapine, "}")))
y_function_B_thetaiotaomicron_Loxapine_func <- eval(parse(text = paste("function(Drug) {", y_function_B_thetaiotaomicron_Loxapine, "}")))
y_function_C_ramosum_Loxapine_func <- eval(parse(text = paste("function(Drug) {", y_function_C_ramosum_Loxapine, "}")))
y_function_E_rectale_Loxapine_func <- eval(parse(text = paste("function(Drug) {", y_function_E_rectale_Loxapine, "}")))
y_function_R_intestinalis_Loxapine_func <- eval(parse(text = paste("function(Drug) {", y_function_R_intestinalis_Loxapine, "}")))
y_function_E_lenta_Loxapine_func <- eval(parse(text = paste("function(Drug) {", y_function_E_lenta_Loxapine, "}")))
y_function_F_nucleatum_Loxapine_func <- eval(parse(text = paste("function(Drug) {", y_function_F_nucleatum_Loxapine, "}")))
y_function_C_bolteae_Loxapine_func <- eval(parse(text = paste("function(Drug) {", y_function_C_bolteae_Loxapine, "}")))
y_function_C_perfringens_Loxapine_func <- eval(parse(text = paste("function(Drug) {", y_function_C_perfringens_Loxapine, "}")))
y_function_C_saccharolyticum_Loxapine_func <- eval(parse(text = paste("function(Drug) {", y_function_C_saccharolyticum_Loxapine, "}")))
y_function_S_salivarius_Loxapine_func <- eval(parse(text = paste("function(Drug) {", y_function_S_salivarius_Loxapine, "}")))
y_function_R_gnavus_Loxapine_func <- eval(parse(text = paste("function(Drug) {", y_function_R_gnavus_Loxapine, "}")))
y_function_C_comes_Loxapine_func <- eval(parse(text = paste("function(Drug) {", y_function_C_comes_Loxapine, "}")))
y_function_P_merdae_Loxapine_func <- eval(parse(text = paste("function(Drug) {", y_function_P_merdae_Loxapine, "}")))
y_function_S_parasanguinis_Loxapine_func <- eval(parse(text = paste("function(Drug) {", y_function_S_parasanguinis_Loxapine, "}")))
y_function_C_aerofaciens_Loxapine_func <- eval(parse(text = paste("function(Drug) {", y_function_C_aerofaciens_Loxapine, "}")))
y_function_D_formicigenerans_Loxapine_func <- eval(parse(text = paste("function(Drug) {", y_function_D_formicigenerans_Loxapine, "}")))
y_function_E_coli_Loxapine_func <- eval(parse(text = paste("function(Drug) {", y_function_E_coli_Loxapine, "}")))
y_function_V_parvula_Loxapine_func <- eval(parse(text = paste("function(Drug) {", y_function_V_parvula_Loxapine, "}")))



unique(combined_monoculture_aucs2_Loxapine$conc)
##dictate drug concentration tested for simulation cycle here:
#drug_concentration_tested <- 5 #if manually or:
drug_concentration_tested <- unique(combined_monoculture_aucs2_Loxapine$conc)[1] 
initial_conditions <- rep(0.01/32, 32)
initial_conditions <- c(initial_conditions, drug_concentration_tested)


##drug effect fitted for species showing sensitivity in monoculture:
#unique(combined_monoculture_aucs2_Loxapine$Species)

##for more simple linear fits
closed.sir.model_Loxapine <- function (t, x, params) {
  ## first extract the state variables
  A_muciniphila <- x[1]
  B_adolescentis <- x[2]
  B_fragilis <- x[3]
  B_longum <- x[4]
  B_obeum <- x[5]
  B_thetaiotaomicron <- x[6]
  B_uniformis <- x[7]
  B_vulgatus <- x[8]
  B_wadsworthia <- x[9]
  C_aerofaciens <- x[10]
  C_bolteae <- x[11]
  C_comes <- x[12]
  C_perfringens <- x[13]
  C_ramosum <- x[14]
  C_saccharolyticum <- x[15]
  D_formicigenerans <- x[16]
  E_coli <- x[17]
  E_lenta <- x[18]
  E_rectale <- x[19]
  F_nucleatum <- x[20]
  L_paracasei <- x[21]
  O_splanchnicus <- x[22]
  P_copri <- x[23]
  P_distasonis <- x[24]
  P_merdae <- x[25]
  R_bromii <- x[26]
  R_gnavus <- x[27]
  R_intestinalis <- x[28]
  R_torques <- x[29]
  S_parasanguinis <- x[30]
  S_salivarius <- x[31]
  V_parvula <- x[32]
  Drug <- x[33]
  
  
  ## now extract the parameters
  r_B_fragilis <- flat_params[["B._fragilis.r"]]
  K_B_fragilis <- flat_params[["B._fragilis.K"]]
  r_B_longum <- flat_params[["B._longum.r"]]
  K_B_longum <- flat_params[["B._longum.K"]]
  r_B_thetaiotaomicron <- flat_params[["B._thetaiotaomicron.r"]]
  K_B_thetaiotaomicron <- flat_params[["B._thetaiotaomicron.K"]]
  r_B_uniformis <- flat_params[["B._uniformis.r"]]
  K_B_uniformis <- flat_params[["B._uniformis.K"]]
  r_B_vulgatus <- flat_params[["B._vulgatus.r"]]
  K_B_vulgatus <- flat_params[["B._vulgatus.K"]]
  r_B_wadsworthia <- flat_params[["B._wadsworthia.r"]]
  K_B_wadsworthia <- flat_params[["B._wadsworthia.K"]]
  r_C_aerofaciens <- flat_params[["C._aerofaciens.r"]]
  K_C_aerofaciens <- flat_params[["C._aerofaciens.K"]]
  r_C_bolteae <- flat_params[["C._bolteae.r"]]
  K_C_bolteae <- flat_params[["C._bolteae.K"]]
  r_C_comes <- flat_params[["C._comes.r"]]
  K_C_comes <- flat_params[["C._comes.K"]]
  r_C_perfringens <- flat_params[["C._perfringens.r"]]
  K_C_perfringens <- flat_params[["C._perfringens.K"]]
  r_C_ramosum <- flat_params[["C._ramosum.r"]]
  K_C_ramosum <- flat_params[["C._ramosum.K"]]
  r_C_saccharolyticum <- flat_params[["C._saccharolyticum.r"]]
  K_C_saccharolyticum <- flat_params[["C._saccharolyticum.K"]]
  r_D_formicigenerans <- flat_params[["D._formicigenerans.r"]]
  K_D_formicigenerans <- flat_params[["D._formicigenerans.K"]]
  r_E_coli <- flat_params[["E._coli.r"]]
  K_E_coli <- flat_params[["E._coli.K"]]
  r_E_lenta <- flat_params[["E._lenta.r"]]
  K_E_lenta <- flat_params[["E._lenta.K"]]
  r_E_rectale <- flat_params[["E._rectale.r"]]
  K_E_rectale <- flat_params[["E._rectale.K"]]
  r_F_nucleatum <- flat_params[["F._nucleatum.r"]]
  K_F_nucleatum <- flat_params[["F._nucleatum.K"]]
  r_P_copri <- flat_params[["P._copri.r"]]
  K_P_copri <- flat_params[["P._copri.K"]]
  r_P_merdae <- flat_params[["P._merdae.r"]]
  K_P_merdae <- flat_params[["P._merdae.K"]]
  r_R_gnavus <- flat_params[["R._gnavus.r"]]
  K_R_gnavus <- flat_params[["R._gnavus.K"]]
  r_R_intestinalis <- flat_params[["R._intestinalis.r"]]
  K_R_intestinalis <- flat_params[["R._intestinalis.K"]]
  r_V_parvula <- flat_params[["V._parvula.r"]]
  K_V_parvula <- flat_params[["V._parvula.K"]]
  r_A_muciniphila <- flat_params[["A._muciniphila.r"]]
  K_A_muciniphila <- flat_params[["A._muciniphila.K"]]
  r_B_adolescentis <- flat_params[["B._adolescentis.r"]]
  K_B_adolescentis <- flat_params[["B._adolescentis.K"]]
  r_B_obeum <- flat_params[["B._obeum.r"]]
  K_B_obeum <- flat_params[["B._obeum.K"]]
  r_O_splanchnicus <- flat_params[["O._splanchnicus.r"]]
  K_O_splanchnicus <- flat_params[["O._splanchnicus.K"]]
  r_P_distasonis <- flat_params[["P._distasonis.r"]]
  K_P_distasonis <- flat_params[["P._distasonis.K"]]
  r_R_bromii <- flat_params[["R._bromii.r"]]
  K_R_bromii <- flat_params[["R._bromii.K"]]
  r_R_torques <- flat_params[["R._torques.r"]]
  K_R_torques <- flat_params[["R._torques.K"]]
  r_S_parasanguinis <- flat_params[["S._parasanguinis.r"]]
  K_S_parasanguinis <-flat_params[["S._parasanguinis.K"]]
  r_S_salivarius <- flat_params[["S._salivarius.r"]]
  K_S_salivarius <- flat_params[["S._salivarius.K"]]
  r_L_paracasei <- flat_params[["L._paracasei.r"]]
  K_L_paracasei <- flat_params[["L._paracasei.K"]]
  
  
  t_mod <- ifelse(t > 24.1, t - 24.1, t)
  
  
  ## now code the model equations
  dA_muciniphila_dt <- r_A_muciniphila * A_muciniphila * (1 - A_muciniphila / K_A_muciniphila)
  dB_adolescentis_dt <- r_B_adolescentis * B_adolescentis * (1 - B_adolescentis / K_B_adolescentis)
  dB_fragilis_dt <- r_B_fragilis * B_fragilis * (1 - B_fragilis / max(0.0001, K_B_fragilis * (y_function_B_fragilis_Loxapine_func(Drug))))
  dB_longum_dt <- r_B_longum * B_longum * (1 - B_longum / K_B_longum)
  dB_obeum_dt <- r_B_obeum * B_obeum * (1 - B_obeum / K_B_obeum)
  dB_thetaiotaomicron_dt <- r_B_thetaiotaomicron * B_thetaiotaomicron * (1 - B_thetaiotaomicron / max(0.0001, K_B_thetaiotaomicron * (y_function_B_thetaiotaomicron_Loxapine_func(Drug))))  
  dB_uniformis_dt <- r_B_uniformis * B_uniformis * (1 - B_uniformis / max(0.0001, K_B_uniformis * (y_function_B_uniformis_Loxapine_func(Drug))))
  dB_vulgatus_dt <- r_B_vulgatus * B_vulgatus * (1 - B_vulgatus / max(0.0001, K_B_vulgatus * (y_function_B_vulgatus_Loxapine_func(Drug))))
  dB_wadsworthia_dt <- r_B_wadsworthia * B_wadsworthia * (1 - B_wadsworthia / K_B_wadsworthia)
  dC_aerofaciens_dt <- r_C_aerofaciens * C_aerofaciens * (1 - C_aerofaciens / max(0.0001, K_C_aerofaciens * (y_function_C_aerofaciens_Loxapine_func(Drug))))
  dC_bolteae_dt <- r_C_bolteae * C_bolteae * (1 - C_bolteae /  max(0.0001, K_C_bolteae * (y_function_C_bolteae_Loxapine_func(Drug))))
  dC_comes_dt <- r_C_comes * C_comes * (1 - C_comes / max(0.0001, K_C_comes * (y_function_C_comes_Loxapine_func(Drug))))
  dC_perfringens_dt <- r_C_perfringens * C_perfringens * (1 - C_perfringens / max(0.0001, K_C_perfringens * (y_function_C_perfringens_Loxapine_func(Drug))))
  dC_ramosum_dt <- r_C_ramosum * C_ramosum * (1 - C_ramosum / max(0.0001, K_C_ramosum * (y_function_C_ramosum_Loxapine_func(Drug))))
  dC_saccharolyticum_dt <- r_C_saccharolyticum * C_saccharolyticum * (1 - C_saccharolyticum / max(0.0001, K_C_saccharolyticum * (y_function_C_saccharolyticum_Loxapine_func(Drug))))
  dD_formicigenerans_dt <- r_D_formicigenerans * D_formicigenerans * (1 - D_formicigenerans / max(0.0001, K_D_formicigenerans * (y_function_D_formicigenerans_Loxapine_func(Drug))))
  dE_coli_dt <- r_E_coli * E_coli * (1 - E_coli / max(0.0001, K_E_coli * (y_function_E_coli_Loxapine_func(Drug))))
  dE_lenta_dt <- r_E_lenta * E_lenta * (1 - E_lenta / max(0.0001, K_E_lenta * (y_function_E_lenta_Loxapine_func(Drug))))
  dE_rectale_dt <- r_E_rectale * E_rectale * (1 - E_rectale / max(0.0001, K_E_rectale * (y_function_E_rectale_Loxapine_func(Drug))))
  dF_nucleatum_dt <- r_F_nucleatum * F_nucleatum * (1 - F_nucleatum / max(0.0001, K_F_nucleatum * (y_function_F_nucleatum_Loxapine_func(Drug))))
  dL_paracasei_dt <- r_L_paracasei * L_paracasei * (1 - L_paracasei / K_L_paracasei)  
  dO_splanchnicus_dt <- r_O_splanchnicus * O_splanchnicus * (1 - O_splanchnicus / K_O_splanchnicus)  
  dP_copri_dt <- r_P_copri * P_copri * (1 - P_copri / K_P_copri)
  dP_distasonis_dt <- r_P_distasonis * P_distasonis * (1 - P_distasonis / K_P_distasonis)  
  dP_merdae_dt <- r_P_merdae * P_merdae * (1 - P_merdae / max(0.0001, K_P_merdae * (y_function_P_merdae_Loxapine_func(Drug))))
  dR_bromii_dt <- r_R_bromii * R_bromii * (1 - R_bromii / K_R_bromii) 
  dR_gnavus_dt <- r_R_gnavus * R_gnavus * (1 - R_gnavus / max(0.0001, K_R_gnavus * (y_function_R_gnavus_Loxapine_func(Drug))))
  dR_intestinalis_dt <- r_R_intestinalis * R_intestinalis * (1 - R_intestinalis / max(0.0001, K_R_intestinalis * (y_function_R_intestinalis_Loxapine_func(Drug))))
  dR_torques_dt <- r_R_torques * R_torques * (1 - R_torques /K_R_torques) 
  dS_parasanguinis_dt <- r_S_parasanguinis * S_parasanguinis * (1 - S_parasanguinis / max(0.0001, K_S_parasanguinis * (y_function_S_parasanguinis_Loxapine_func(Drug))))
  dS_salivarius_dt <- r_S_salivarius * S_salivarius * (1 - S_salivarius / max(0.0001, K_S_salivarius * (y_function_S_salivarius_Loxapine_func(Drug))))
  dV_parvula_dt <- r_V_parvula * V_parvula * (1 - V_parvula / max(0.0001, K_V_parvula * (y_function_V_parvula_Loxapine_func(Drug))))
  
  
  
  #Drug differential:
  dDrug_dt <- (subset(drug_dynamics, Drug == "Loxapine")$Steepness_param_community * exp(-subset(drug_dynamics, Drug == "Loxapine")$Steepness_param_community * t_mod)) * (drug_concentration_tested * prop_left_Loxapine - drug_concentration_tested)
  #dDrug_dt <- 0
  
  ## Combine results into a single vector
  dxdt <- c(dA_muciniphila_dt, dB_adolescentis_dt, dB_fragilis_dt, dB_longum_dt, dB_obeum_dt, dB_thetaiotaomicron_dt, dB_uniformis_dt, dB_vulgatus_dt, dB_wadsworthia_dt, dC_aerofaciens_dt, dC_bolteae_dt, dC_comes_dt, dC_perfringens_dt, dC_ramosum_dt, dC_saccharolyticum_dt, dD_formicigenerans_dt, dE_coli_dt, dE_lenta_dt, dE_rectale_dt, dF_nucleatum_dt, dL_paracasei_dt, dO_splanchnicus_dt, dP_copri_dt, dP_distasonis_dt, dP_merdae_dt, dR_bromii_dt, dR_gnavus_dt, dR_intestinalis_dt, dR_torques_dt, dS_parasanguinis_dt, dS_salivarius_dt, dV_parvula_dt, dDrug_dt)
  
  ## Return result as a list
  list(dxdt)
}




#calculate the co-culture correction factor per species based on community composition in absence of drug, just like done for Niclosamide

growth_data_all_0_Niclosamide
growth_data_all_0_Niclosamide1 <- growth_data_all_0_Niclosamide %>%
  dplyr::mutate(Species = gsub(" ", "_", Species))


# Merge rel_ab_control with growth_data_all_0_Niclosamide on Species
# Function to remove duplicated columns by name pattern
clean_columns_base <- function(df, pattern) {
  cols_to_keep <- !grepl(pattern, names(df))
  df <- df[, cols_to_keep]
  return(df)
}

# Use the new function to clean up your dataframe
rel_ab_control <- clean_columns_base(rel_ab_control, "mean_max_OD.[xy]")
str(rel_ab_control)


#rel_ab_control$correction_factor <- rel_ab_control$mean_rel_ab / (rel_ab_control$mean_max_OD/sum(rel_ab_control$mean_max_OD))
# Calculate correction factor with a minimum value of ~1
rel_ab_control$correction_factor <- pmax(rel_ab_control$mean_rel_ab / (rel_ab_control$mean_max_OD / sum(rel_ab_control$mean_max_OD)), 1.1)


# Create a new dataframe for co-culture correction
co_culture_correction <- data.frame(
  species = rel_ab_control$Species,
  correction_factor = rel_ab_control$correction_factor
)


#summarise community data
#Adjust based on tested concentrations for each drug
unique(Community_compositions_focus_drugs_Loxapine$concentration)

Community_compositions_focus_drugs_Loxapine_5uM <- subset(Community_compositions_focus_drugs_Loxapine, concentration == 5)
Community_compositions_focus_drugs_Loxapine_20uM <- subset(Community_compositions_focus_drugs_Loxapine, concentration == 20)
Community_compositions_focus_drugs_Loxapine_80uM <- subset(Community_compositions_focus_drugs_Loxapine, concentration == 80)


#5 uM
Community_compositions_focus_drugs_Loxapine_5uM_summarised <- Community_compositions_focus_drugs_Loxapine_5uM %>%
  dplyr::group_by(species) %>%                                  
  dplyr::summarize(
    mean_rel_ab = mean(rel_abundance, na.rm = TRUE),     
    sd_rel_ab = sd(rel_abundance, na.rm = TRUE) ,
    mean_max_OD = mean(maxOD, na.rm = TRUE),
    sd_max_OD = sd(maxOD, na.rm = TRUE),
    mean_final_OD = mean(finalOD, na.rm = TRUE),
    sd_final_OD = sd(finalOD, na.rm = TRUE)
  ) %>%
  dplyr::ungroup() 


Community_compositions_focus_drugs_Loxapine_5uM_summarised <- Community_compositions_focus_drugs_Loxapine_5uM_summarised %>%
  dplyr::mutate(Species = sub("^(\\w)\\w*\\s(.*)", "\\1._\\2", species))

#remove (sub)strain info
Community_compositions_focus_drugs_Loxapine_5uM_summarised <- Community_compositions_focus_drugs_Loxapine_5uM_summarised %>%
  dplyr::mutate(Species = sub("^(\\w\\._\\w+).*", "\\1", Species))


#20 uM
Community_compositions_focus_drugs_Loxapine_20uM_summarised <- Community_compositions_focus_drugs_Loxapine_20uM %>%
  dplyr::group_by(species) %>%                                  
  dplyr::summarize(
    mean_rel_ab = mean(rel_abundance, na.rm = TRUE),     
    sd_rel_ab = sd(rel_abundance, na.rm = TRUE) ,
    mean_max_OD = mean(maxOD, na.rm = TRUE),
    sd_max_OD = sd(maxOD, na.rm = TRUE),
    mean_final_OD = mean(finalOD, na.rm = TRUE),
    sd_final_OD = sd(finalOD, na.rm = TRUE)
  ) %>%
  dplyr::ungroup() 


Community_compositions_focus_drugs_Loxapine_20uM_summarised <- Community_compositions_focus_drugs_Loxapine_20uM_summarised %>%
  dplyr::mutate(Species = sub("^(\\w)\\w*\\s(.*)", "\\1._\\2", species))

#remove (sub)strain info
Community_compositions_focus_drugs_Loxapine_20uM_summarised <- Community_compositions_focus_drugs_Loxapine_20uM_summarised %>%
  dplyr::mutate(Species = sub("^(\\w\\._\\w+).*", "\\1", Species))


#80 uM
Community_compositions_focus_drugs_Loxapine_80uM_summarised <- Community_compositions_focus_drugs_Loxapine_80uM %>%
  dplyr::group_by(species) %>%                                  
  dplyr::summarize(
    mean_rel_ab = mean(rel_abundance, na.rm = TRUE),     
    sd_rel_ab = sd(rel_abundance, na.rm = TRUE) ,
    mean_max_OD = mean(maxOD, na.rm = TRUE),
    sd_max_OD = sd(maxOD, na.rm = TRUE),    
    mean_final_OD = mean(finalOD, na.rm = TRUE),
    sd_final_OD = sd(finalOD, na.rm = TRUE)
  ) %>%
  dplyr::ungroup() 



Community_compositions_focus_drugs_Loxapine_80uM_summarised <- Community_compositions_focus_drugs_Loxapine_80uM_summarised %>%
  dplyr::mutate(Species = sub("^(\\w)\\w*\\s(.*)", "\\1._\\2", species))

#remove (sub)strain info
Community_compositions_focus_drugs_Loxapine_80uM_summarised <- Community_compositions_focus_drugs_Loxapine_80uM_summarised %>%
  dplyr::mutate(Species = sub("^(\\w\\._\\w+).*", "\\1", Species))


#Initialise data frames
sim_output <- data.frame()
input_params_list <- list() #Use a list to collect parameters for each simulation

#number of simulations
num_sims <- 250


for (i in 1:num_sims) {
  tryCatch({
    # generate model parameters
    set.seed(i) #set a different seed for each simulation for variation
    params <- lapply(1:nrow(growth_data_all_0_Niclosamide), function(idx) {
      species_params <- growth_data_all_0_Niclosamide[idx, ]
      list(
        r = rnorm(1, mean = species_params$mean_max_Growth_rate, sd = species_params$sd_max_Growth_rate),
        K = rnorm(1, mean = species_params$mean_max_OD, sd = species_params$sd_max_OD)
      )
    })
    names(params) <- gsub(" ", "_", growth_data_all_0_Niclosamide$Species)
    flat_params <- unlist(params)
    names(flat_params) <- gsub("\\.\\d$", "", names(flat_params))
    
    #replace spaces with underscores to match formatting
    co_culture_correction$species <- gsub(" ", "_", co_culture_correction$species, fixed = TRUE)
    
    #replace the species-specific K parameters extracted from monoculture growth data 
    #with drawn relative abundance values at Niclosamide = 0, scaled to K
    rel_ab_control$Species <- gsub(" ", "_", rel_ab_control$Species)
    
    #Initialise an empty vector to store drawn values
    drawn_values <- numeric(nrow(rel_ab_control))
    
    #draw values from their respective distributions
    for (k in 1:nrow(rel_ab_control)) {
      species_name <- rel_ab_control$Species[k]
      drawn_value <- rnorm(1, mean = rel_ab_control$mean_rel_ab[k], sd = rel_ab_control$sd_rel_ab[k])
      drawn_values[k] <- max(drawn_value, 0)  # Ensure no negative values
    }
    
    #Normalise drawn relative abundance values so they sum to 1 (to reflect a 'true' relative abundance distribution)
    #this is needed so when we convert the values into OD units by multiplying with the drawn community maxOD,
    # the sum of K_i parameters and the drawn K are equal
    normalised_values <- drawn_values / sum(drawn_values)
    
    #Pull community maxOD (K) at 0 drugs from respective normal distribution:
    K <- rnorm(n = 1, mean = rel_ab_control$mean_com_max_OD[1], sd = rel_ab_control$sd_com_max_OD[1])
    
    # Assign these normalised values to their respective species' .K parameters
    for (k in 1:nrow(rel_ab_control)) {
      species_name <- rel_ab_control$Species[k]
      k_index <- grep(paste0("^", species_name, "\\.K$"), names(flat_params))
      
      if (length(k_index) > 0) {
        old_value <- flat_params[k_index]
        flat_params[k_index] <- (normalised_values[k] + 0.0001) * K #add small value in case drawn K_i is 0, which would cause issues with the solver
        cat(sprintf("Updated %s from %f to %f using normalised value %f scaled by K %f\n", names(flat_params)[k_index], old_value, flat_params[k_index], normalised_values[k], K))
      }
    }
    
    #Accounting for variation in drug degradation by community, with standard deviation of end concentration (at 10h) around the fitted predicted (relative) end concentration at 24h
    #prop_left_Loxapine <- abs(rnorm(1, (subset(drug_dynamics, Drug == "Loxapine")$Prop_left_24h_community), (subset(drug_dynamics, Drug == "Loxapine")$SD_drug_community))) 
    #below, we account for measurement error rather than ecological drivers that lead to the variability of degradation at the final point measured 
    prop_left_Loxapine <- abs(rnorm(
      n = 1, 
      mean = subset(drug_dynamics, Drug == "Loxapine")$Prop_left_24h_community, 
      sd = ifelse(
        subset(drug_dynamics, Drug == "Loxapine")$SD_drug_community > subset(drug_dynamics, Drug == "Loxapine")$SD_drug_community_start, 
        subset(drug_dynamics, Drug == "Loxapine")$SD_drug_community - subset(drug_dynamics, Drug == "Loxapine")$SD_drug_community_start, 
        subset(drug_dynamics, Drug == "Loxapine")$SD_drug_community
      )
    ))
    
    
    #loop through each species in co_culture_correction
    for (j in 1:nrow(co_culture_correction)) {
      # Extract the species name and correction factor
      species_name <- co_culture_correction$species[j]
      correction_factor <- co_culture_correction$correction_factor[j]
      
      # Identify the corresponding growth rate parameter in flat_params
      #by matching the base species name (without .r)
      growth_rate_indices <- grep(paste0("^", species_name, "\\.r$"), names(flat_params))
      
      #take the growth rate parameter and apply the correction factor 
      for (index in growth_rate_indices) {
        flat_params[index] <- flat_params[index] * correction_factor
      }
    }
    
    flat_params
    # Store parameters for each simulation
    input_params_list[[i]] <- c(sim_ID = i, flat_params)
    
    # Run the model for the first 24-hour cycle
    solution_cycle_1 <- ode(y = initial_conditions, times = seq(from = 0, to = 24, by = 0.1), func = closed.sir.model_Loxapine, parms = flat_params,   method = "lsoda", rtol = 1e-6, atol = 1e-6)
    
    # Dilution and second cycle
    end_of_cycle_1 <- solution_cycle_1[nrow(solution_cycle_1), -1]
    initial_conditions_cycle_2 <- end_of_cycle_1 / 50
    #accounting for the drugs being added with the new growth cycle as well:
    initial_conditions_cycle_2[33] <- initial_conditions_cycle_2[33] + drug_concentration_tested
    solution_cycle_2 <- ode(y = initial_conditions_cycle_2, times = seq(from = 24, to = 48, by = 0.1), func = closed.sir.model_Loxapine, parms = flat_params,  method = "lsoda", rtol = 1e-6, atol = 1e-6)
    
    # Combine and format results
    combined_solution <- rbind(as.data.frame(solution_cycle_1), as.data.frame(solution_cycle_2)[-1,])
    combined_solution$sim_ID <- rep(i, nrow(combined_solution))
    combined_solution <- combined_solution %>%
      tidyr::gather(key = "Species", value = "Density", -time, -sim_ID) %>%
      dplyr::mutate(Hour = time) %>%
      dplyr::select(sim_ID, Hour, Species, Density)
    
    ##Append to sim_output
    sim_output <- rbind(sim_output, combined_solution)
  }, error = function(e) {
    cat(sprintf("Skipping simulation %d due to an error: %s\n", i, e$message))
  })
}



##Combine all parameter data into a single dataframe
input_params <- do.call(rbind, input_params_list)

# Add a "Species" column 
sim_output$Species_name <- species_names[as.numeric(as.character(sim_output$Species))]
sim_output$Species_name <- replace_na(sim_output$Species_name, "Drug")

#View(input_params)
#View(sim_output)

sim_output <- na.omit(sim_output)
successful_sim_ids <- unique(subset(sim_output, Hour == 48)$sim_ID)
length(successful_sim_ids)
sim_output1 <- sim_output[sim_output$sim_ID %in% successful_sim_ids, ]


#Transform sim_output so we have wide format by Species
sim_output_wide <- tidyr::pivot_wider(sim_output1, 
                                      names_from = Species_name, 
                                      values_from = Density,
                                      id_cols = c(sim_ID, Hour))

length(unique(sim_output_wide$sim_ID))
#calc community OD per timepoint
sim_output_wide$Total_OD <- rowSums(sim_output_wide[, 3:34], na.rm = TRUE)
#calculate and add relative abundances here as well:
species_columns <- colnames(sim_output_wide)[3:34] 

for (species in species_columns) {
  sim_output_wide[[paste0("rel_", species)]] <- sim_output_wide[[species]] / sim_output_wide$Total_OD
}


#assign sim_output_wide test conditions to dataframe name
drug_tested <- "Loxapine"
variable_name_1 <- paste0("sim_output_wide_", ifelse(drug_concentration_tested == 1e-04, 0, drug_concentration_tested), "_", drug_tested)
assign(variable_name_1, sim_output_wide)

#turn back into long format if interested in plotting relative abundances
cols_needed <- c("sim_ID", "Hour")

sim_output_long <- sim_output_wide %>% 
  dplyr::select(sim_ID, Hour, Drug, starts_with("rel_")) %>% 
  tidyr::pivot_longer(
    cols = c(Drug, starts_with("rel_")),
    names_to = "Species", 
    values_to = "Relative_abundance",
    names_prefix = "rel_",
    names_transform = list(Species = ~ ifelse(.x == "Drug", "Drug", .x))
  ) 

str(sim_output_long)


species_names_1 <- c(
  "A_muciniphila",
  "B_adolescentis",
  "B_fragilis",
  "B_longum",
  "B_obeum",
  "B_thetaiotaomicron",
  "B_uniformis",
  "B_vulgatus",
  "B_wadsworthia",
  "C_aerofaciens",
  "C_bolteae",
  "C_comes",
  "C_perfringens",
  "C_ramosum",
  "C_saccharolyticum",
  "D_formicigenerans",
  "E_coli",
  "E_lenta",
  "E_rectale",
  "F_nucleatum",
  "L_paracasei",
  "O_splanchnicus",
  "P_copri",
  "P_distasonis",
  "P_merdae",
  "R_bromii",
  "R_gnavus",
  "R_intestinalis",
  "R_torques",
  "S_parasanguinis",
  "S_salivarius",
  "V_parvula",
  "Drug"
)

species_colours_1 <- c(
  "A_muciniphila" = "#1f77b4",
  "B_adolescentis" = "#ff7f0e",
  "B_fragilis" = "#2ca02c",
  "B_longum" = "#d62728",
  "B_obeum" = "#9467bd",
  "B_thetaiotaomicron" = "black",
  "B_uniformis" = "#e377c2",
  "B_vulgatus" = "#7f7f7f",
  "B_wadsworthia" = "gold1",
  "C_aerofaciens" = "#aec7e8",
  "C_bolteae" = "#ffbb78",
  "C_comes" = "magenta",
  "C_perfringens" = "#ff9896",
  "C_ramosum" = "#c5b0d5",
  "C_saccharolyticum" = "#c49c94",
  "D_formicigenerans" = "#f7b6d2",
  "E_coli" = "yellow",
  "E_lenta" = "turquoise",
  "E_rectale" = "#393b79",
  "F_nucleatum" = "royalblue2",
  "L_paracasei" = "blue",
  "O_splanchnicus" = "#637939",
  "P_copri" = "cyan",
  "P_distasonis" = "#8c6d31",
  "P_merdae" = "#c7c7c7",
  "R_bromii" = "#e6550d",
  "R_gnavus" = "#e7cb94",
  "R_intestinalis" = "#843c39",
  "R_torques" = "#d6616b",
  "S_parasanguinis" = "orange3",
  "S_salivarius" = "#7b4173",
  "V_parvula" = "#ce6dbd",
  "Drug" = "green"
)



##Plot output for any specific sim:
# ggplot(subset(sim_output, sim_ID == 1 & Species_name != "Drug"), aes(x = Hour, y = Density, group = Species_name, color = Species_name)) +
#   geom_line(size = 1, alpha = 0.7) +
#   scale_color_manual(values = species_colours_1) +
#   labs(title = paste0("Loxapine = ", drug_concentration_tested),
#        x = "Time (hours)",
#        y = "Population Density (OD)",
#        color = "Species") +
#   theme_minimal() +
#   theme(legend.position = "right")
# 
# ggplot(subset(sim_output, sim_ID == 3 & Species_name != "Drug"), aes(x = Hour, y = Density, group = Species_name, color = Species_name)) +
#   geom_line(size = 1, alpha = 0.7) +
#   scale_color_manual(values = species_colours_1) +
#   labs(title = paste0("Loxapine = ", drug_concentration_tested),
#        x = "Time (hours)",
#        y = "Population Density (OD)",
#        color = "Species") +
#   theme_minimal() +
#   theme(legend.position = "right")


ggplot(subset(sim_output_long, sim_ID == 1), aes(x = Hour, y = Relative_abundance, group = Species, color = Species)) +
  geom_line(size = 1, alpha = 0.7) +
  scale_color_manual(values = species_colours_1) +
  labs(title = paste0("Loxapine = ", drug_concentration_tested),
       x = "Time (hours)",
       y = "Relative abundance",
       color = "Species") +
  theme_minimal() +
  theme(legend.position = "right")


ggplot(subset(sim_output_long, sim_ID == 3), aes(x = Hour, y = Relative_abundance, group = Species, color = Species)) +
  geom_line(size = 1, alpha = 0.7) +
  scale_color_manual(values = species_colours_1) +
  labs(title = paste0("Loxapine = ", drug_concentration_tested),
       x = "Time (hours)",
       y = "Relative abundance",
       color = "Species") +
  theme_minimal() +
  theme(legend.position = "right")


#calc mean and standard deviation across sims
sim_stats <- sim_output_long %>%
  dplyr::group_by(Hour, Species) %>%
  dplyr::summarise(
    mean_rel_ab = mean(Relative_abundance),
    sd_rel_ab = sd(Relative_abundance),
    .groups = 'drop'
  )

# Prepare the data for plotting
plot_data <- sim_stats %>%
  dplyr::mutate(Upper = mean_rel_ab + sd_rel_ab, Lower = mean_rel_ab - sd_rel_ab)

ggplot(subset(plot_data, Species != "Drug"), aes(x = Hour, y = mean_rel_ab, group = Species, color = Species)) +
  geom_ribbon(aes(ymin = Lower, ymax = Upper, fill = Species), colour = NA, alpha = 0.2) +  
  geom_line(size = 1, alpha = 0.7) + 
  scale_color_manual(values = species_colours_1) +
  scale_fill_manual(values = species_colours_1) +  
  labs(title = "Mean and SD of Relative Abundance Across Simulations",
       subtitle = paste0("Loxapine = ", drug_concentration_tested),       
       x = "Time (hours)",
       y = "Relative abundance",
       color = "Species",
       fill = "Species") +
  theme_minimal() +
  theme(legend.position = "right")

#log-scaled mean trends
ggplot(plot_data, aes(x = Hour, y = log10(mean_rel_ab + 0.0001), group = Species, color = Species)) +
  geom_line(size = 1, alpha = 0.7) +  # Mean line
  scale_color_manual(values = species_colours_1) +
  scale_fill_manual(values = species_colours_1) +  # Ensure consistent colors for lines and fills
  labs(title = "Mean and SD of Relative Abundance Across Simulations",
       subtitle = paste0("Loxapine = ", drug_concentration_tested),
       x = "Time (hours)",
       y = "Relative abundance",
       color = "Species",
       fill = "Species") +
  theme_minimal() +
  theme(legend.position = "right")




##prediction quality evaluation
drug_tested <- "Loxapine"
variable_name <- paste0("plot_data_", ifelse(drug_concentration_tested == 1e-04, 0, drug_concentration_tested), "_", drug_tested)
assign(variable_name, plot_data)


#extract total OD info:
predicted_mean_final_od_NULL <- Niclosamide_16S_0uM_summarised$mean_com_final_OD[1]
predicted_sd_final_od_NULL <- Niclosamide_16S_0uM_summarised$sd_com_final_OD[1]

predicted_mean_final_od_5_Loxapine <- mean(subset(sim_output_wide_5_Loxapine, Hour == 48)$Total_OD, na.rm = TRUE)
predicted_sd_final_od_5_Loxapine <- sd(subset(sim_output_wide_5_Loxapine, Hour == 48)$Total_OD, na.rm = TRUE)

real_mean_final_od_5_Loxapine <- Community_compositions_focus_drugs_Loxapine_5uM_summarised$mean_final_OD[1]
real_sd_final_od_5_Loxapine <- Community_compositions_focus_drugs_Loxapine_5uM_summarised$sd_final_OD[1]


predicted_mean_final_od_20_Loxapine <- mean(subset(sim_output_wide_20_Loxapine, Hour == 48)$Total_OD, na.rm = TRUE)
predicted_sd_final_od_20_Loxapine <- sd(subset(sim_output_wide_20_Loxapine, Hour == 48)$Total_OD, na.rm = TRUE)

real_mean_final_od_20_Loxapine <- Community_compositions_focus_drugs_Loxapine_20uM_summarised$mean_final_OD[1]
real_sd_final_od_20_Loxapine <- Community_compositions_focus_drugs_Loxapine_20uM_summarised$sd_final_OD[1]


predicted_mean_final_od_80_Loxapine <- mean(subset(sim_output_wide_80_Loxapine, Hour == 48)$Total_OD, na.rm = TRUE)
predicted_sd_final_od_80_Loxapine <- sd(subset(sim_output_wide_80_Loxapine, Hour == 48)$Total_OD, na.rm = TRUE)

real_mean_final_od_80_Loxapine <- Community_compositions_focus_drugs_Loxapine_80uM_summarised$mean_final_OD[1]
real_sd_final_od_80_Loxapine <- Community_compositions_focus_drugs_Loxapine_80uM_summarised$sd_final_OD[1]




#plot_data_0_Loxapine_endpoint was used to test model performance at 0 drugs
#plot_data_0_Loxapine_endpoint <- subset(plot_data_0_Loxapine, Hour == 48 & Species != "Drug")
plot_data_5_Loxapine_endpoint <- subset(plot_data_5_Loxapine, Hour == 48 & Species != "Drug")
plot_data_20_Loxapine_endpoint <- subset(plot_data_20_Loxapine, Hour == 48 & Species != "Drug")
plot_data_80_Loxapine_endpoint <- subset(plot_data_80_Loxapine, Hour == 48 & Species != "Drug")

##Inspecting 'match' to real relative abundance distributions:
Niclosamide_16S_0uM_summarised <- rel_ab_control
Niclosamide_16S_0uM_summarised$Species <- gsub("\\.", "", Niclosamide_16S_0uM_summarised$Species)

Loxapine_16S_5uM_summarised <- Community_compositions_focus_drugs_Loxapine_5uM_summarised
Loxapine_16S_20uM_summarised <- Community_compositions_focus_drugs_Loxapine_20uM_summarised
Loxapine_16S_80uM_summarised <- Community_compositions_focus_drugs_Loxapine_80uM_summarised

Niclosamide_16S_0uM_summarised
Loxapine_16S_5uM_summarised 
Loxapine_16S_20uM_summarised 
Loxapine_16S_80uM_summarised 

#Rename 'species' so the outputs become comparable
original_names_80 <- unique(Loxapine_16S_80uM_summarised$species)
original_names_20 <- unique(Loxapine_16S_20uM_summarised$species)
original_names_5 <- unique(Loxapine_16S_5uM_summarised$species)


##Create a named vector with the original and new names mapping
name_changes <- c(
  "Akkermansia muciniphila" = "A_muciniphila",
  "Bacteroides fragilis" = "B_fragilis",
  "Bacteroides thetaiotaomicron" = "B_thetaiotaomicron",
  "Bacteroides uniformis" = "B_uniformis",
  "Bifidobacterium adolescentis" = "B_adolescentis",
  "Bifidobacterium longum subsp. longum" = "B_longum",
  "Bilophila wadsworthia" = "B_wadsworthia",
  "Blautia obeum" = "B_obeum",
  "Clostridium perfringens" = "C_perfringens",
  "Collinsella aerofaciens" = "C_aerofaciens",
  "Coprococcus comes" = "C_comes",
  "Dorea formicigenerans" = "D_formicigenerans",
  "Eggerthella lenta" = "E_lenta",
  "Enterocloster bolteae" = "C_bolteae",
  "Erysipelatoclostridium ramosum" = "C_ramosum",
  "Escherichia coli ED1a" = "E_coli",
  "Eubacterium rectale" = "E_rectale",
  "Fusobacterium nucleatum subsp. nucleatum" = "F_nucleatum",
  "Lacrimispora saccharolytica" = "C_saccharolyticum",
  "Lacticaseibacillus paracasei" = "L_paracasei",
  "Odoribacter splanchnicus" = "O_splanchnicus",
  "Parabacteroides distasonis" = "P_distasonis",
  "Parabacteroides merdae" = "P_merdae",
  "Phocaeicola vulgatus" = "B_vulgatus",
  "Prevotella copri" = "P_copri",
  "Roseburia intestinalis" = "R_intestinalis",
  "Ruminococcus bromii" = "R_bromii",
  "Ruminococcus gnavus" = "R_gnavus",
  "Ruminococcus torques" = "R_torques",
  "Streptococcus parasanguinis" = "S_parasanguinis",
  "Streptococcus salivarius" = "S_salivarius",
  "Veillonella parvula" = "V_parvula"
)

# Apply name changes to the species column in Loxapine_16S_80uM_summarised

Loxapine_16S_80uM_summarised$Species <- name_changes[Loxapine_16S_80uM_summarised$species]
Loxapine_16S_20uM_summarised$Species <- name_changes[Loxapine_16S_20uM_summarised$species]
Loxapine_16S_5uM_summarised$Species <- name_changes[Loxapine_16S_5uM_summarised$species]

# Verify the changes
unique(Loxapine_16S_80uM_summarised$Species)
unique(Loxapine_16S_20uM_summarised$Species)
unique(Loxapine_16S_5uM_summarised$Species)



##First, for 5 uM:
# Get top 6 species from plot_data_5_endpoint
# Adjust the plot_data_5_endpoint with confidence bounds

# #plot_data_0_Loxapine_endpoint was used to test model performance at 0 drugs
# plot_data_0_Loxapine_endpoint <- plot_data_0_Loxapine_endpoint %>%
#   dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)

plot_data_5_Loxapine_endpoint <- plot_data_5_Loxapine_endpoint %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)

# Adjust the Loxapine_16S_5uM_summarised with confidence bounds
Loxapine_16S_5uM_summarised <- Loxapine_16S_5uM_summarised %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)

#NULL model:
Null_model_summarised <- Niclosamide_16S_0uM_summarised %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)


# Get top 6 species based on the lower bound from plot_data_5_endpoint

#top6_predicted_0_Loxapine was used to test model performance at 0 drugs
# top6_predicted_0_Loxapine <- plot_data_0_Loxapine_endpoint %>%
#    arrange(desc(lower_bound)) %>%
#    slice(1:6) %>%
#    pull(Species)

top6_predicted_5_Loxapine <- plot_data_5_Loxapine_endpoint %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

# Get top 6 species based on the lower bound from Loxapine_16S_5uM_summarised
top6_real_5_Loxapine <- Loxapine_16S_5uM_summarised %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

top6_NULL <- Null_model_summarised %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

# Calculate the overlap of top 6 species

#top_six_correct_0_Loxapine was used to assess model performance at 0 drugs
# top_six_correct_0_Loxapine <- length(intersect(top6_predicted_0_Loxapine, top6_NULL))
# top_six_correct_0_Loxapine

top_six_correct_5_Loxapine <- length(intersect(top6_predicted_5_Loxapine, top6_real_5_Loxapine))
top_six_correct_5_Loxapine

top_six_correct_5_Loxapine_NULL <- length(intersect(top6_NULL, top6_real_5_Loxapine))
top_six_correct_5_Loxapine_NULL

top6_predicted_5_Loxapine
top6_real_5_Loxapine

#top6_NULL

#Now by means:
# #top6_predicted_0_Loxapine_means was used to assess model performance at 0 drugs
# top6_predicted_0_Loxapine_means <- plot_data_0_Loxapine_endpoint %>%
#    arrange(desc(mean_rel_ab)) %>%
#    slice(1:6) %>%
#    pull(Species)

top6_predicted_5_Loxapine_means <- plot_data_5_Loxapine_endpoint %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)

# Get top 6 species based on the lower bound from Loxapine_16S_5uM_summarised
top6_real_5_Loxapine_means <- Loxapine_16S_5uM_summarised %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)

top6_NULL_means <- Null_model_summarised %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)


# #top_six_correct_0_Loxapine_means was used to assess model performance at 0 drugs
# top_six_correct_0_Loxapine_means <- length(intersect(top6_predicted_0_Loxapine_means, top6_NULL_means))
# top_six_correct_0_Loxapine_means

top_six_correct_5_Loxapine_means <- length(intersect(top6_predicted_5_Loxapine_means, top6_real_5_Loxapine_means))
top_six_correct_5_Loxapine_means

top_six_correct_5_Loxapine_means_NULL <- length(intersect(top6_NULL_means, top6_real_5_Loxapine_means))
top_six_correct_5_Loxapine_means_NULL

top6_predicted_5_Loxapine_means
top6_real_5_Loxapine_means

#top6_NULL_means


# Merge dataframes by Species

#merged_data_0_Loxapine was used to assess model performance at 0 drugs
#merged_data_0_Loxapine <- merge(plot_data_0_Loxapine_endpoint, Niclosamide_16S_0uM_summarised, by = "Species", suffixes = c(".pred", ".real"))
merged_data_5_Loxapine <- merge(plot_data_5_Loxapine_endpoint, Loxapine_16S_5uM_summarised, by = "Species", suffixes = c(".pred", ".real"))
merged_data_5_Loxapine_NULL <- merge(Niclosamide_16S_0uM_summarised, Loxapine_16S_5uM_summarised, by = "Species", suffixes = c(".null", ".real"))


## Below lines used for assessing model performance at 0 drugs; ignore for nonzero concentrations
# # Create lower and upper bounds considering mean ¬± sd
# merged_data_0_Loxapine$lower_bound_pred <- merged_data_0_Loxapine$mean_rel_ab.pred - merged_data_0_Loxapine$sd_rel_ab.pred
# merged_data_0_Loxapine$upper_bound_pred <- merged_data_0_Loxapine$mean_rel_ab.pred + merged_data_0_Loxapine$sd_rel_ab.pred
# merged_data_0_Loxapine$lower_bound_real <- merged_data_0_Loxapine$mean_rel_ab.real - merged_data_0_Loxapine$sd_rel_ab.real
# merged_data_0_Loxapine$upper_bound_real <- merged_data_0_Loxapine$mean_rel_ab.real + merged_data_0_Loxapine$sd_rel_ab.real
# 
# # Ensure lower and upper bounds are non-negative, adjusting as necessary
# merged_data_0_Loxapine$lower_bound_pred[merged_data_0_Loxapine$lower_bound_pred <= 0] <- 1e-10
# merged_data_0_Loxapine$lower_bound_real[merged_data_0_Loxapine$lower_bound_real <= 0] <- 1e-10
# merged_data_0_Loxapine$upper_bound_pred[merged_data_0_Loxapine$upper_bound_pred <= 0] <- 1e-10
# merged_data_0_Loxapine$upper_bound_real[merged_data_0_Loxapine$upper_bound_real <= 0] <- 1e-10


# Create lower and upper bounds considering mean ¬± sd
merged_data_5_Loxapine$lower_bound_pred <- merged_data_5_Loxapine$mean_rel_ab.pred - merged_data_5_Loxapine$sd_rel_ab.pred
merged_data_5_Loxapine$upper_bound_pred <- merged_data_5_Loxapine$mean_rel_ab.pred + merged_data_5_Loxapine$sd_rel_ab.pred
merged_data_5_Loxapine$lower_bound_real <- merged_data_5_Loxapine$mean_rel_ab.real - merged_data_5_Loxapine$sd_rel_ab.real
merged_data_5_Loxapine$upper_bound_real <- merged_data_5_Loxapine$mean_rel_ab.real + merged_data_5_Loxapine$sd_rel_ab.real

# Ensure lower and upper bounds are non-negative, adjusting as necessary
merged_data_5_Loxapine$lower_bound_pred[merged_data_5_Loxapine$lower_bound_pred <= 0] <- 1e-10
merged_data_5_Loxapine$lower_bound_real[merged_data_5_Loxapine$lower_bound_real <= 0] <- 1e-10
merged_data_5_Loxapine$upper_bound_pred[merged_data_5_Loxapine$upper_bound_pred <= 0] <- 1e-10
merged_data_5_Loxapine$upper_bound_real[merged_data_5_Loxapine$upper_bound_real <= 0] <- 1e-10

##and for NULL model:
# Create lower and upper bounds considering mean ¬± sd
merged_data_5_Loxapine_NULL$lower_bound_null <- merged_data_5_Loxapine_NULL$mean_rel_ab.null - merged_data_5_Loxapine_NULL$sd_rel_ab.null
merged_data_5_Loxapine_NULL$upper_bound_null <- merged_data_5_Loxapine_NULL$mean_rel_ab.null + merged_data_5_Loxapine_NULL$sd_rel_ab.null
merged_data_5_Loxapine_NULL$lower_bound_real <- merged_data_5_Loxapine_NULL$mean_rel_ab.real - merged_data_5_Loxapine_NULL$sd_rel_ab.real
merged_data_5_Loxapine_NULL$upper_bound_real <- merged_data_5_Loxapine_NULL$mean_rel_ab.real + merged_data_5_Loxapine_NULL$sd_rel_ab.real

# Ensure lower and upper bounds are non-negative, adjusting as necessary
merged_data_5_Loxapine_NULL$lower_bound_null[merged_data_5_Loxapine_NULL$lower_bound_null <= 0] <- 1e-10
merged_data_5_Loxapine_NULL$lower_bound_real[merged_data_5_Loxapine_NULL$lower_bound_real <= 0] <- 1e-10
merged_data_5_Loxapine_NULL$upper_bound_null[merged_data_5_Loxapine_NULL$upper_bound_null <= 0] <- 1e-10
merged_data_5_Loxapine_NULL$upper_bound_real[merged_data_5_Loxapine_NULL$upper_bound_real <= 0] <- 1e-10

# Filter to include only species with a mean relative abundance > 0.01 in the 'real' dataset

## significant_species_0 was used to assess model performance at 0 drugs
#significant_species_0 <- merged_data_0_Loxapine[merged_data_0_Loxapine$mean_rel_ab.real > 0.01, ]
significant_species <- merged_data_5_Loxapine[merged_data_5_Loxapine$mean_rel_ab.real > 0.01, ]
survivors_5_Loxapine <- nrow(significant_species)
survivors_5_Loxapine

#should be the same as survivors defined above, since it is calculated from .real
significant_species_NULL <- merged_data_5_Loxapine_NULL[merged_data_5_Loxapine_NULL$mean_rel_ab.real > 0.01, ]
survivors_5_Loxapine_NULL <- nrow(significant_species_NULL)
survivors_5_Loxapine_NULL

# Adjusted order of magnitude check to include SD, only for significant species
## below code was used to assess model performance at 0 drugs
# significant_species_0$Predicted_magnitude_correct <- ifelse(
#   (floor(log10(significant_species_0$lower_bound_pred)) <= floor(log10(significant_species_0$upper_bound_real)) &
#      floor(log10(significant_species_0$upper_bound_pred)) >= floor(log10(significant_species_0$lower_bound_real))),
#   1,
#   0
# )

significant_species$Predicted_magnitude_correct <- ifelse(
  (floor(log10(significant_species$lower_bound_pred)) <= floor(log10(significant_species$upper_bound_real)) &
     floor(log10(significant_species$upper_bound_pred)) >= floor(log10(significant_species$lower_bound_real))),
  1,
  0
)

#and for the Null model:
significant_species_NULL$Predicted_magnitude_correct <- ifelse(
  (floor(log10(significant_species_NULL$lower_bound_null)) <= floor(log10(significant_species_NULL$upper_bound_real)) &
     floor(log10(significant_species_NULL$upper_bound_null)) >= floor(log10(significant_species_NULL$lower_bound_real))),
  1,
  0
)

# Calculate the fraction of correctly predicted magnitudes for significant species
## below code was used to assess model performance at 0 drugs
#predicted_magnitude_correct_fraction_0_Loxapine <- sum(significant_species_0$Predicted_magnitude_correct) / nrow(significant_species_0)
#predicted_magnitude_correct_fraction_0_Loxapine

predicted_magnitude_correct_fraction_5_Loxapine <- sum(significant_species$Predicted_magnitude_correct) / nrow(significant_species)
predicted_magnitude_correct_fraction_5_Loxapine

predicted_magnitude_correct_fraction_5_Loxapine_NULL <- sum(significant_species_NULL$Predicted_magnitude_correct) / nrow(significant_species_NULL)
predicted_magnitude_correct_fraction_5_Loxapine_NULL

top_species_missing_5_Loxapine <- setdiff(top6_real_5_Loxapine_means, top6_predicted_5_Loxapine_means)
top_species_wrong_5_Loxapine <- setdiff(top6_predicted_5_Loxapine_means, top6_real_5_Loxapine_means)


Prediction_quality_5_Loxapine <- data.frame(
  Top_six_correct = paste(top_six_correct_5_Loxapine, sep=""),
  Top_six_correct_NULL = paste(top_six_correct_5_Loxapine_NULL, sep=""),
  Top_six_correct_means = paste(top_six_correct_5_Loxapine_means, sep=""),
  Top_six_correct_means_NULL = paste(top_six_correct_5_Loxapine_means_NULL, sep=""),
  Predicted_magnitude_correct = paste(round(predicted_magnitude_correct_fraction_5_Loxapine * 100, 2), "%", sep=""),
  Predicted_magnitude_correct_NULL = paste(round(predicted_magnitude_correct_fraction_5_Loxapine_NULL * 100, 2), "%", sep=""),
  survivors_total = survivors_5_Loxapine,
  top_species_missing <- top_species_missing_5_Loxapine,
  top_species_wrong <- top_species_wrong_5_Loxapine, 
  predicted_mean_final_OD <- predicted_mean_final_od_5_Loxapine,
  real_mean_final_OD <- real_mean_final_od_5_Loxapine,
  sims_total = length(successful_sim_ids)
)



Prediction_quality_5_Loxapine



##Next, for 20 uM:
# Get top 6 species from plot_data_20_endpoint
# Adjust the plot_data_20_endpoint with confidence bounds
plot_data_20_Loxapine_endpoint <- plot_data_20_Loxapine_endpoint %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)

# Adjust the Loxapine_16S_20uM_summarised with confidence bounds
Loxapine_16S_20uM_summarised <- Loxapine_16S_20uM_summarised %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)

#NULL model:
Null_model_summarised <- Niclosamide_16S_0uM_summarised %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)


# Get top 6 species based on the lower bound from plot_data_20_endpoint
top6_predicted_20_Loxapine <- plot_data_20_Loxapine_endpoint %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

# Get top 6 species based on the lower bound from Loxapine_16S_20uM_summarised
top6_real_20_Loxapine <- Loxapine_16S_20uM_summarised %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

top6_NULL <- Null_model_summarised %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

# Calculate the overlap of top 6 species
top_six_correct_20_Loxapine <- length(intersect(top6_predicted_20_Loxapine, top6_real_20_Loxapine))
#top_six_correct_20_Loxapine

top_six_correct_20_Loxapine_NULL <- length(intersect(top6_NULL, top6_real_20_Loxapine))
#top_six_correct_20_Loxapine_NULL

#top6_predicted_20_Loxapine
#top6_real_20_Loxapine



#Now by means:
top6_predicted_20_Loxapine_means <- plot_data_20_Loxapine_endpoint %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)

# Get top 6 species based on the lower bound from Loxapine_16S_20uM_summarised
top6_real_20_Loxapine_means <- Loxapine_16S_20uM_summarised %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)

top6_NULL_means <- Null_model_summarised %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)



top_six_correct_20_Loxapine_means <- length(intersect(top6_predicted_20_Loxapine_means, top6_real_20_Loxapine_means))
#top_six_correct_20_Loxapine_means

top_six_correct_20_Loxapine_means_NULL <- length(intersect(top6_NULL_means, top6_real_20_Loxapine_means))
#top_six_correct_20_Loxapine_means_NULL

top6_predicted_20_Loxapine_means
#top6_real_20_Loxapine_means




# Merge dataframes by Species
merged_data_20_Loxapine <- merge(plot_data_20_Loxapine_endpoint, Loxapine_16S_20uM_summarised, by = "Species", suffixes = c(".pred", ".real"))
merged_data_20_Loxapine_NULL <- merge(Niclosamide_16S_0uM_summarised, Loxapine_16S_20uM_summarised, by = "Species", suffixes = c(".null", ".real"))



# Create lower and upper bounds considering mean ¬± sd
merged_data_20_Loxapine$lower_bound_pred <- merged_data_20_Loxapine$mean_rel_ab.pred - merged_data_20_Loxapine$sd_rel_ab.pred
merged_data_20_Loxapine$upper_bound_pred <- merged_data_20_Loxapine$mean_rel_ab.pred + merged_data_20_Loxapine$sd_rel_ab.pred
merged_data_20_Loxapine$lower_bound_real <- merged_data_20_Loxapine$mean_rel_ab.real - merged_data_20_Loxapine$sd_rel_ab.real
merged_data_20_Loxapine$upper_bound_real <- merged_data_20_Loxapine$mean_rel_ab.real + merged_data_20_Loxapine$sd_rel_ab.real

# Ensure lower and upper bounds are non-negative, adjusting as necessary
merged_data_20_Loxapine$lower_bound_pred[merged_data_20_Loxapine$lower_bound_pred <= 0] <- 1e-10
merged_data_20_Loxapine$lower_bound_real[merged_data_20_Loxapine$lower_bound_real <= 0] <- 1e-10
merged_data_20_Loxapine$upper_bound_pred[merged_data_20_Loxapine$upper_bound_pred <= 0] <- 1e-10
merged_data_20_Loxapine$upper_bound_real[merged_data_20_Loxapine$upper_bound_real <= 0] <- 1e-10

##and for NULL model:
# Create lower and upper bounds considering mean ¬± sd
merged_data_20_Loxapine_NULL$lower_bound_null <- merged_data_20_Loxapine_NULL$mean_rel_ab.null - merged_data_20_Loxapine_NULL$sd_rel_ab.null
merged_data_20_Loxapine_NULL$upper_bound_null <- merged_data_20_Loxapine_NULL$mean_rel_ab.null + merged_data_20_Loxapine_NULL$sd_rel_ab.null
merged_data_20_Loxapine_NULL$lower_bound_real <- merged_data_20_Loxapine_NULL$mean_rel_ab.real - merged_data_20_Loxapine_NULL$sd_rel_ab.real
merged_data_20_Loxapine_NULL$upper_bound_real <- merged_data_20_Loxapine_NULL$mean_rel_ab.real + merged_data_20_Loxapine_NULL$sd_rel_ab.real

# Ensure lower and upper bounds are non-negative, adjusting as necessary
merged_data_20_Loxapine_NULL$lower_bound_null[merged_data_20_Loxapine_NULL$lower_bound_null <= 0] <- 1e-10
merged_data_20_Loxapine_NULL$lower_bound_real[merged_data_20_Loxapine_NULL$lower_bound_real <= 0] <- 1e-10
merged_data_20_Loxapine_NULL$upper_bound_null[merged_data_20_Loxapine_NULL$upper_bound_null <= 0] <- 1e-10
merged_data_20_Loxapine_NULL$upper_bound_real[merged_data_20_Loxapine_NULL$upper_bound_real <= 0] <- 1e-10

# Filter to include only species with a mean relative abundance > 0.01 in the 'real' dataset
significant_species <- merged_data_20_Loxapine[merged_data_20_Loxapine$mean_rel_ab.real > 0.01, ]
survivors_20_Loxapine <- nrow(significant_species)
survivors_20_Loxapine

#should be the same as survivors defined above, since it is calculated from .real
significant_species_NULL <- merged_data_20_Loxapine_NULL[merged_data_20_Loxapine_NULL$mean_rel_ab.real > 0.01, ]
survivors_20_Loxapine_NULL <- nrow(significant_species_NULL)
survivors_20_Loxapine_NULL

# Adjusted order of magnitude check to include SD, only for significant species
significant_species$Predicted_magnitude_correct <- ifelse(
  (floor(log10(significant_species$lower_bound_pred)) <= floor(log10(significant_species$upper_bound_real)) &
     floor(log10(significant_species$upper_bound_pred)) >= floor(log10(significant_species$lower_bound_real))),
  1,
  0
)

#and for the Null model:
significant_species_NULL$Predicted_magnitude_correct <- ifelse(
  (floor(log10(significant_species_NULL$lower_bound_null)) <= floor(log10(significant_species_NULL$upper_bound_real)) &
     floor(log10(significant_species_NULL$upper_bound_null)) >= floor(log10(significant_species_NULL$lower_bound_real))),
  1,
  0
)

# Calculate the fraction of correctly predicted magnitudes for significant species
predicted_magnitude_correct_fraction_20_Loxapine <- sum(significant_species$Predicted_magnitude_correct) / nrow(significant_species)
predicted_magnitude_correct_fraction_20_Loxapine

predicted_magnitude_correct_fraction_20_Loxapine_NULL <- sum(significant_species_NULL$Predicted_magnitude_correct) / nrow(significant_species_NULL)
predicted_magnitude_correct_fraction_20_Loxapine_NULL

top_species_missing_20_Loxapine <- setdiff(top6_real_20_Loxapine_means, top6_predicted_20_Loxapine_means)
top_species_wrong_20_Loxapine <- setdiff(top6_predicted_20_Loxapine_means, top6_real_20_Loxapine_means)

top_species_missing_20_Loxapine <- if(length(top_species_missing_20_Loxapine) == 0) "None" else top_species_missing_20_Loxapine
top_species_wrong_20_Loxapine <- if(length(top_species_wrong_20_Loxapine) == 0) "None" else top_species_wrong_20_Loxapine

Prediction_quality_20_Loxapine <- data.frame(
  Top_six_correct = paste(top_six_correct_20_Loxapine, sep=""),
  Top_six_correct_NULL = paste(top_six_correct_20_Loxapine_NULL, sep=""),
  Top_six_correct_means = paste(top_six_correct_20_Loxapine_means, sep=""),
  Top_six_correct_means_NULL = paste(top_six_correct_20_Loxapine_means_NULL, sep=""),
  Predicted_magnitude_correct = paste(round(predicted_magnitude_correct_fraction_20_Loxapine * 100, 2), "%", sep=""),
  Predicted_magnitude_correct_NULL = paste(round(predicted_magnitude_correct_fraction_20_Loxapine_NULL * 100, 2), "%", sep=""),
  survivors_total = survivors_20_Loxapine,
  top_species_missing <- top_species_missing_20_Loxapine,
  top_species_wrong <- top_species_wrong_20_Loxapine, 
  predicted_mean_final_OD <- predicted_mean_final_od_20_Loxapine,
  real_mean_final_OD <- real_mean_final_od_20_Loxapine,
  sims_total = length(successful_sim_ids)
)

Prediction_quality_20_Loxapine






##Next, for 80 uM:
# Get top 6 species from plot_data_80_endpoint
# Adjust the plot_data_80_endpoint with confidence bounds
plot_data_80_Loxapine_endpoint <- plot_data_80_Loxapine_endpoint %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)

# Adjust the Loxapine_16S_80uM_summarised with confidence bounds
Loxapine_16S_80uM_summarised <- Loxapine_16S_80uM_summarised %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)

#NULL model:
Null_model_summarised <- Niclosamide_16S_0uM_summarised %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)


# Get top 6 species based on the lower bound from plot_data_80_endpoint
top6_predicted_80_Loxapine <- plot_data_80_Loxapine_endpoint %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

# Get top 6 species based on the lower bound from Loxapine_16S_80uM_summarised
top6_real_80_Loxapine <- Loxapine_16S_80uM_summarised %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

top6_NULL <- Null_model_summarised %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

# Calculate the overlap of top 6 species
top_six_correct_80_Loxapine <- length(intersect(top6_predicted_80_Loxapine, top6_real_80_Loxapine))
#top_six_correct_80_Loxapine

top_six_correct_80_Loxapine_NULL <- length(intersect(top6_NULL, top6_real_80_Loxapine))
#top_six_correct_80_Loxapine_NULL

#top6_predicted_80_Loxapine
#top6_real_80_Loxapine




#Now by means:
top6_predicted_80_Loxapine_means <- plot_data_80_Loxapine_endpoint %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)

# Get top 6 species based on the lower bound from Loxapine_16S_80uM_summarised
top6_real_80_Loxapine_means <- Loxapine_16S_80uM_summarised %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)

top6_NULL_means <- Null_model_summarised %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)



top_six_correct_80_Loxapine_means <- length(intersect(top6_predicted_80_Loxapine_means, top6_real_80_Loxapine_means))
#top_six_correct_80_Loxapine_means

top_six_correct_80_Loxapine_means_NULL <- length(intersect(top6_NULL_means, top6_real_80_Loxapine_means))
#top_six_correct_80_Loxapine_means_NULL

#top6_predicted_80_Loxapine_means
#top6_real_80_Loxapine_means




# Merge dataframes by Species
merged_data_80_Loxapine <- merge(plot_data_80_Loxapine_endpoint, Loxapine_16S_80uM_summarised, by = "Species", suffixes = c(".pred", ".real"))
merged_data_80_Loxapine_NULL <- merge(Niclosamide_16S_0uM_summarised, Loxapine_16S_80uM_summarised, by = "Species", suffixes = c(".null", ".real"))



# Create lower and upper bounds considering mean ¬± sd
merged_data_80_Loxapine$lower_bound_pred <- merged_data_80_Loxapine$mean_rel_ab.pred - merged_data_80_Loxapine$sd_rel_ab.pred
merged_data_80_Loxapine$upper_bound_pred <- merged_data_80_Loxapine$mean_rel_ab.pred + merged_data_80_Loxapine$sd_rel_ab.pred
merged_data_80_Loxapine$lower_bound_real <- merged_data_80_Loxapine$mean_rel_ab.real - merged_data_80_Loxapine$sd_rel_ab.real
merged_data_80_Loxapine$upper_bound_real <- merged_data_80_Loxapine$mean_rel_ab.real + merged_data_80_Loxapine$sd_rel_ab.real

# Ensure lower and upper bounds are non-negative, adjusting as necessary
merged_data_80_Loxapine$lower_bound_pred[merged_data_80_Loxapine$lower_bound_pred <= 0] <- 1e-10
merged_data_80_Loxapine$lower_bound_real[merged_data_80_Loxapine$lower_bound_real <= 0] <- 1e-10
merged_data_80_Loxapine$upper_bound_pred[merged_data_80_Loxapine$upper_bound_pred <= 0] <- 1e-10
merged_data_80_Loxapine$upper_bound_real[merged_data_80_Loxapine$upper_bound_real <= 0] <- 1e-10

##and for NULL model:
# Create lower and upper bounds considering mean ¬± sd
merged_data_80_Loxapine_NULL$lower_bound_null <- merged_data_80_Loxapine_NULL$mean_rel_ab.null - merged_data_80_Loxapine_NULL$sd_rel_ab.null
merged_data_80_Loxapine_NULL$upper_bound_null <- merged_data_80_Loxapine_NULL$mean_rel_ab.null + merged_data_80_Loxapine_NULL$sd_rel_ab.null
merged_data_80_Loxapine_NULL$lower_bound_real <- merged_data_80_Loxapine_NULL$mean_rel_ab.real - merged_data_80_Loxapine_NULL$sd_rel_ab.real
merged_data_80_Loxapine_NULL$upper_bound_real <- merged_data_80_Loxapine_NULL$mean_rel_ab.real + merged_data_80_Loxapine_NULL$sd_rel_ab.real

# Ensure lower and upper bounds are non-negative, adjusting as necessary
merged_data_80_Loxapine_NULL$lower_bound_null[merged_data_80_Loxapine_NULL$lower_bound_null <= 0] <- 1e-10
merged_data_80_Loxapine_NULL$lower_bound_real[merged_data_80_Loxapine_NULL$lower_bound_real <= 0] <- 1e-10
merged_data_80_Loxapine_NULL$upper_bound_null[merged_data_80_Loxapine_NULL$upper_bound_null <= 0] <- 1e-10
merged_data_80_Loxapine_NULL$upper_bound_real[merged_data_80_Loxapine_NULL$upper_bound_real <= 0] <- 1e-10

# Filter to include only species with a mean relative abundance > 0.01 in the 'real' dataset
significant_species <- merged_data_80_Loxapine[merged_data_80_Loxapine$mean_rel_ab.real > 0.01, ]
survivors_80_Loxapine <- nrow(significant_species)
survivors_80_Loxapine

#should be the same as survivors defined above, since it is calculated from .real
significant_species_NULL <- merged_data_80_Loxapine_NULL[merged_data_80_Loxapine_NULL$mean_rel_ab.real > 0.01, ]
survivors_80_Loxapine_NULL <- nrow(significant_species_NULL)
survivors_80_Loxapine_NULL

# Adjusted order of magnitude check to include SD, only for significant species
significant_species$Predicted_magnitude_correct <- ifelse(
  (floor(log10(significant_species$lower_bound_pred)) <= floor(log10(significant_species$upper_bound_real)) &
     floor(log10(significant_species$upper_bound_pred)) >= floor(log10(significant_species$lower_bound_real))),
  1,
  0
)

#and for the Null model:
significant_species_NULL$Predicted_magnitude_correct <- ifelse(
  (floor(log10(significant_species_NULL$lower_bound_null)) <= floor(log10(significant_species_NULL$upper_bound_real)) &
     floor(log10(significant_species_NULL$upper_bound_null)) >= floor(log10(significant_species_NULL$lower_bound_real))),
  1,
  0
)

# Calculate the fraction of correctly predicted magnitudes for significant species
predicted_magnitude_correct_fraction_80_Loxapine <- sum(significant_species$Predicted_magnitude_correct) / nrow(significant_species)
predicted_magnitude_correct_fraction_80_Loxapine

predicted_magnitude_correct_fraction_80_Loxapine_NULL <- sum(significant_species_NULL$Predicted_magnitude_correct) / nrow(significant_species_NULL)
predicted_magnitude_correct_fraction_80_Loxapine_NULL


top_species_missing_80_Loxapine <- setdiff(top6_real_80_Loxapine_means, top6_predicted_80_Loxapine_means)
top_species_wrong_80_Loxapine <- setdiff(top6_predicted_80_Loxapine_means, top6_real_80_Loxapine_means)

top_species_missing_80_Loxapine <- if(length(top_species_missing_80_Loxapine) == 0) "None" else top_species_missing_80_Loxapine
top_species_wrong_80_Loxapine <- if(length(top_species_wrong_80_Loxapine) == 0) "None" else top_species_wrong_80_Loxapine

Prediction_quality_80_Loxapine <- data.frame(
  Top_six_correct = paste(top_six_correct_80_Loxapine, sep=""),
  Top_six_correct_NULL = paste(top_six_correct_80_Loxapine_NULL, sep=""),
  Top_six_correct_means = paste(top_six_correct_80_Loxapine_means, sep=""),
  Top_six_correct_means_NULL = paste(top_six_correct_80_Loxapine_means_NULL, sep=""),
  Predicted_magnitude_correct = paste(round(predicted_magnitude_correct_fraction_80_Loxapine * 100, 2), "%", sep=""),
  Predicted_magnitude_correct_NULL = paste(round(predicted_magnitude_correct_fraction_80_Loxapine_NULL * 100, 2), "%", sep=""),
  survivors_total = survivors_80_Loxapine,
  top_species_missing <- top_species_missing_80_Loxapine,
  top_species_wrong <- top_species_wrong_80_Loxapine, 
  predicted_mean_final_OD <- predicted_mean_final_od_80_Loxapine,
  real_mean_final_OD <- real_mean_final_od_80_Loxapine,
  sims_total = length(successful_sim_ids)
)

Prediction_quality_80_Loxapine









##Mecillinam

combined_monoculture_aucs2_Mecillinam <- subset(combined_monoculture_aucs2, drug == "Mecillinam")


#drug sensitivity terms: define once outside of ODEs
y_function_B_vulgatus_Mecillinam <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("B_vulgatus", "Mecillinam", best_fitting_models_df_Mecillinam)), collapse = " ")))
y_function_B_uniformis_Mecillinam <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("B_uniformis", "Mecillinam", best_fitting_models_df_Mecillinam)), collapse = " ")))
y_function_B_fragilis_Mecillinam <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("B_fragilis", "Mecillinam", best_fitting_models_df_Mecillinam)), collapse = " ")))
y_function_B_thetaiotaomicron_Mecillinam <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("B_thetaiotaomicron", "Mecillinam", best_fitting_models_df_Mecillinam)), collapse = " ")))
y_function_C_ramosum_Mecillinam <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("C_ramosum", "Mecillinam", best_fitting_models_df_Mecillinam)), collapse = " ")))
y_function_E_rectale_Mecillinam <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("E_rectale", "Mecillinam", best_fitting_models_df_Mecillinam)), collapse = " ")))
y_function_R_intestinalis_Mecillinam <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("R_intestinalis", "Mecillinam", best_fitting_models_df_Mecillinam)), collapse = " ")))
y_function_V_parvula_Mecillinam <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("V_parvula", "Mecillinam", best_fitting_models_df_Mecillinam)), collapse = " ")))
y_function_E_lenta_Mecillinam <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("E_lenta", "Mecillinam", best_fitting_models_df_Mecillinam)), collapse = " ")))
y_function_F_nucleatum_Mecillinam <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("F_nucleatum", "Mecillinam", best_fitting_models_df_Mecillinam)), collapse = " ")))
y_function_C_bolteae_Mecillinam <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("C_bolteae", "Mecillinam", best_fitting_models_df_Mecillinam)), collapse = " ")))
y_function_C_perfringens_Mecillinam <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("C_perfringens", "Mecillinam", best_fitting_models_df_Mecillinam)), collapse = " ")))
y_function_C_saccharolyticum_Mecillinam <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("C_saccharolyticum", "Mecillinam", best_fitting_models_df_Mecillinam)), collapse = " ")))
y_function_S_salivarius_Mecillinam <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("S_salivarius", "Mecillinam", best_fitting_models_df_Mecillinam)), collapse = " ")))
y_function_R_gnavus_Mecillinam <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("R_gnavus", "Mecillinam", best_fitting_models_df_Mecillinam)), collapse = " ")))
y_function_C_comes_Mecillinam <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("C_comes", "Mecillinam", best_fitting_models_df_Mecillinam)), collapse = " ")))
y_function_P_merdae_Mecillinam <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("P_merdae", "Mecillinam", best_fitting_models_df_Mecillinam)), collapse = " ")))
y_function_S_parasanguinis_Mecillinam <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("S_parasanguinis", "Mecillinam", best_fitting_models_df_Mecillinam)), collapse = " ")))
y_function_C_aerofaciens_Mecillinam <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("C_aerofaciens", "Mecillinam", best_fitting_models_df_Mecillinam)), collapse = " ")))
y_function_D_formicigenerans_Mecillinam <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("D_formicigenerans", "Mecillinam", best_fitting_models_df_Mecillinam)), collapse = " ")))
y_function_E_coli_Mecillinam <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("E_coli", "Mecillinam", best_fitting_models_df_Mecillinam)), collapse = " ")))



y_function_B_vulgatus_Mecillinam_func <- eval(parse(text = paste("function(Drug) {", y_function_B_vulgatus_Mecillinam, "}")))
y_function_B_uniformis_Mecillinam_func <- eval(parse(text = paste("function(Drug) {", y_function_B_uniformis_Mecillinam, "}")))
y_function_B_fragilis_Mecillinam_func <- eval(parse(text = paste("function(Drug) {", y_function_B_fragilis_Mecillinam, "}")))
y_function_B_thetaiotaomicron_Mecillinam_func <- eval(parse(text = paste("function(Drug) {", y_function_B_thetaiotaomicron_Mecillinam, "}")))
y_function_C_ramosum_Mecillinam_func <- eval(parse(text = paste("function(Drug) {", y_function_C_ramosum_Mecillinam, "}")))
y_function_E_rectale_Mecillinam_func <- eval(parse(text = paste("function(Drug) {", y_function_E_rectale_Mecillinam, "}")))
y_function_R_intestinalis_Mecillinam_func <- eval(parse(text = paste("function(Drug) {", y_function_R_intestinalis_Mecillinam, "}")))
y_function_E_lenta_Mecillinam_func <- eval(parse(text = paste("function(Drug) {", y_function_E_lenta_Mecillinam, "}")))
y_function_F_nucleatum_Mecillinam_func <- eval(parse(text = paste("function(Drug) {", y_function_F_nucleatum_Mecillinam, "}")))
y_function_C_bolteae_Mecillinam_func <- eval(parse(text = paste("function(Drug) {", y_function_C_bolteae_Mecillinam, "}")))
y_function_C_perfringens_Mecillinam_func <- eval(parse(text = paste("function(Drug) {", y_function_C_perfringens_Mecillinam, "}")))
y_function_C_saccharolyticum_Mecillinam_func <- eval(parse(text = paste("function(Drug) {", y_function_C_saccharolyticum_Mecillinam, "}")))
y_function_S_salivarius_Mecillinam_func <- eval(parse(text = paste("function(Drug) {", y_function_S_salivarius_Mecillinam, "}")))
y_function_R_gnavus_Mecillinam_func <- eval(parse(text = paste("function(Drug) {", y_function_R_gnavus_Mecillinam, "}")))
y_function_C_comes_Mecillinam_func <- eval(parse(text = paste("function(Drug) {", y_function_C_comes_Mecillinam, "}")))
y_function_P_merdae_Mecillinam_func <- eval(parse(text = paste("function(Drug) {", y_function_P_merdae_Mecillinam, "}")))
y_function_S_parasanguinis_Mecillinam_func <- eval(parse(text = paste("function(Drug) {", y_function_S_parasanguinis_Mecillinam, "}")))
y_function_C_aerofaciens_Mecillinam_func <- eval(parse(text = paste("function(Drug) {", y_function_C_aerofaciens_Mecillinam, "}")))
y_function_D_formicigenerans_Mecillinam_func <- eval(parse(text = paste("function(Drug) {", y_function_D_formicigenerans_Mecillinam, "}")))
y_function_E_coli_Mecillinam_func <- eval(parse(text = paste("function(Drug) {", y_function_E_coli_Mecillinam, "}")))
y_function_V_parvula_Mecillinam_func <- eval(parse(text = paste("function(Drug) {", y_function_V_parvula_Mecillinam, "}")))



unique(combined_monoculture_aucs2_Mecillinam$conc)
##dictate drug concentration tested for simulation cycle here:
#drug_concentration_tested <- 0.5 #if manually or:
drug_concentration_tested <- unique(combined_monoculture_aucs2_Mecillinam$conc)[1] 
initial_conditions <- rep(0.01/32, 32)
initial_conditions <- c(initial_conditions, drug_concentration_tested)


##drug effect fitted for species showing sensitivity in monoculture:
#unique(combined_monoculture_aucs2_Mecillinam$Species)

##for more simple linear fits
closed.sir.model_Mecillinam <- function (t, x, params) {
  ## first extract the state variables
  A_muciniphila <- x[1]
  B_adolescentis <- x[2]
  B_fragilis <- x[3]
  B_longum <- x[4]
  B_obeum <- x[5]
  B_thetaiotaomicron <- x[6]
  B_uniformis <- x[7]
  B_vulgatus <- x[8]
  B_wadsworthia <- x[9]
  C_aerofaciens <- x[10]
  C_bolteae <- x[11]
  C_comes <- x[12]
  C_perfringens <- x[13]
  C_ramosum <- x[14]
  C_saccharolyticum <- x[15]
  D_formicigenerans <- x[16]
  E_coli <- x[17]
  E_lenta <- x[18]
  E_rectale <- x[19]
  F_nucleatum <- x[20]
  L_paracasei <- x[21]
  O_splanchnicus <- x[22]
  P_copri <- x[23]
  P_distasonis <- x[24]
  P_merdae <- x[25]
  R_bromii <- x[26]
  R_gnavus <- x[27]
  R_intestinalis <- x[28]
  R_torques <- x[29]
  S_parasanguinis <- x[30]
  S_salivarius <- x[31]
  V_parvula <- x[32]
  Drug <- x[33]
  
  
  ## now extract the parameters
  r_B_fragilis <- flat_params[["B._fragilis.r"]]
  K_B_fragilis <- flat_params[["B._fragilis.K"]]
  r_B_longum <- flat_params[["B._longum.r"]]
  K_B_longum <- flat_params[["B._longum.K"]]
  r_B_thetaiotaomicron <- flat_params[["B._thetaiotaomicron.r"]]
  K_B_thetaiotaomicron <- flat_params[["B._thetaiotaomicron.K"]]
  r_B_uniformis <- flat_params[["B._uniformis.r"]]
  K_B_uniformis <- flat_params[["B._uniformis.K"]]
  r_B_vulgatus <- flat_params[["B._vulgatus.r"]]
  K_B_vulgatus <- flat_params[["B._vulgatus.K"]]
  r_B_wadsworthia <- flat_params[["B._wadsworthia.r"]]
  K_B_wadsworthia <- flat_params[["B._wadsworthia.K"]]
  r_C_aerofaciens <- flat_params[["C._aerofaciens.r"]]
  K_C_aerofaciens <- flat_params[["C._aerofaciens.K"]]
  r_C_bolteae <- flat_params[["C._bolteae.r"]]
  K_C_bolteae <- flat_params[["C._bolteae.K"]]
  r_C_comes <- flat_params[["C._comes.r"]]
  K_C_comes <- flat_params[["C._comes.K"]]
  r_C_perfringens <- flat_params[["C._perfringens.r"]]
  K_C_perfringens <- flat_params[["C._perfringens.K"]]
  r_C_ramosum <- flat_params[["C._ramosum.r"]]
  K_C_ramosum <- flat_params[["C._ramosum.K"]]
  r_C_saccharolyticum <- flat_params[["C._saccharolyticum.r"]]
  K_C_saccharolyticum <- flat_params[["C._saccharolyticum.K"]]
  r_D_formicigenerans <- flat_params[["D._formicigenerans.r"]]
  K_D_formicigenerans <- flat_params[["D._formicigenerans.K"]]
  r_E_coli <- flat_params[["E._coli.r"]]
  K_E_coli <- flat_params[["E._coli.K"]]
  r_E_lenta <- flat_params[["E._lenta.r"]]
  K_E_lenta <- flat_params[["E._lenta.K"]]
  r_E_rectale <- flat_params[["E._rectale.r"]]
  K_E_rectale <- flat_params[["E._rectale.K"]]
  r_F_nucleatum <- flat_params[["F._nucleatum.r"]]
  K_F_nucleatum <- flat_params[["F._nucleatum.K"]]
  r_P_copri <- flat_params[["P._copri.r"]]
  K_P_copri <- flat_params[["P._copri.K"]]
  r_P_merdae <- flat_params[["P._merdae.r"]]
  K_P_merdae <- flat_params[["P._merdae.K"]]
  r_R_gnavus <- flat_params[["R._gnavus.r"]]
  K_R_gnavus <- flat_params[["R._gnavus.K"]]
  r_R_intestinalis <- flat_params[["R._intestinalis.r"]]
  K_R_intestinalis <- flat_params[["R._intestinalis.K"]]
  r_V_parvula <- flat_params[["V._parvula.r"]]
  K_V_parvula <- flat_params[["V._parvula.K"]]
  r_A_muciniphila <- flat_params[["A._muciniphila.r"]]
  K_A_muciniphila <- flat_params[["A._muciniphila.K"]]
  r_B_adolescentis <- flat_params[["B._adolescentis.r"]]
  K_B_adolescentis <- flat_params[["B._adolescentis.K"]]
  r_B_obeum <- flat_params[["B._obeum.r"]]
  K_B_obeum <- flat_params[["B._obeum.K"]]
  r_O_splanchnicus <- flat_params[["O._splanchnicus.r"]]
  K_O_splanchnicus <- flat_params[["O._splanchnicus.K"]]
  r_P_distasonis <- flat_params[["P._distasonis.r"]]
  K_P_distasonis <- flat_params[["P._distasonis.K"]]
  r_R_bromii <- flat_params[["R._bromii.r"]]
  K_R_bromii <- flat_params[["R._bromii.K"]]
  r_R_torques <- flat_params[["R._torques.r"]]
  K_R_torques <- flat_params[["R._torques.K"]]
  r_S_parasanguinis <- flat_params[["S._parasanguinis.r"]]
  K_S_parasanguinis <-flat_params[["S._parasanguinis.K"]]
  r_S_salivarius <- flat_params[["S._salivarius.r"]]
  K_S_salivarius <- flat_params[["S._salivarius.K"]]
  r_L_paracasei <- flat_params[["L._paracasei.r"]]
  K_L_paracasei <- flat_params[["L._paracasei.K"]]
  
  
  t_mod <- ifelse(t > 24.1, t - 24.1, t)
  
  
  ## now code the model equations
  dA_muciniphila_dt <- r_A_muciniphila * A_muciniphila * (1 - A_muciniphila / K_A_muciniphila)
  dB_adolescentis_dt <- r_B_adolescentis * B_adolescentis * (1 - B_adolescentis / K_B_adolescentis)
  dB_fragilis_dt <- r_B_fragilis * B_fragilis * (1 - B_fragilis / max(0.0001, K_B_fragilis * (y_function_B_fragilis_Mecillinam_func(Drug))))
  dB_longum_dt <- r_B_longum * B_longum * (1 - B_longum / K_B_longum)
  dB_obeum_dt <- r_B_obeum * B_obeum * (1 - B_obeum / K_B_obeum)
  dB_thetaiotaomicron_dt <- r_B_thetaiotaomicron * B_thetaiotaomicron * (1 - B_thetaiotaomicron / max(0.0001, K_B_thetaiotaomicron * (y_function_B_thetaiotaomicron_Mecillinam_func(Drug))))  
  dB_uniformis_dt <- r_B_uniformis * B_uniformis * (1 - B_uniformis / max(0.0001, K_B_uniformis * (y_function_B_uniformis_Mecillinam_func(Drug))))
  dB_vulgatus_dt <- r_B_vulgatus * B_vulgatus * (1 - B_vulgatus / max(0.0001, K_B_vulgatus * (y_function_B_vulgatus_Mecillinam_func(Drug))))
  dB_wadsworthia_dt <- r_B_wadsworthia * B_wadsworthia * (1 - B_wadsworthia / K_B_wadsworthia)
  dC_aerofaciens_dt <- r_C_aerofaciens * C_aerofaciens * (1 - C_aerofaciens / max(0.0001, K_C_aerofaciens * (y_function_C_aerofaciens_Mecillinam_func(Drug))))
  dC_bolteae_dt <- r_C_bolteae * C_bolteae * (1 - C_bolteae /  max(0.0001, K_C_bolteae * (y_function_C_bolteae_Mecillinam_func(Drug))))
  dC_comes_dt <- r_C_comes * C_comes * (1 - C_comes / max(0.0001, K_C_comes * (y_function_C_comes_Mecillinam_func(Drug))))
  dC_perfringens_dt <- r_C_perfringens * C_perfringens * (1 - C_perfringens / max(0.0001, K_C_perfringens * (y_function_C_perfringens_Mecillinam_func(Drug))))
  dC_ramosum_dt <- r_C_ramosum * C_ramosum * (1 - C_ramosum / max(0.0001, K_C_ramosum * (y_function_C_ramosum_Mecillinam_func(Drug))))
  dC_saccharolyticum_dt <- r_C_saccharolyticum * C_saccharolyticum * (1 - C_saccharolyticum / max(0.0001, K_C_saccharolyticum * (y_function_C_saccharolyticum_Mecillinam_func(Drug))))
  dD_formicigenerans_dt <- r_D_formicigenerans * D_formicigenerans * (1 - D_formicigenerans / max(0.0001, K_D_formicigenerans * (y_function_D_formicigenerans_Mecillinam_func(Drug))))
  dE_coli_dt <- r_E_coli * E_coli * (1 - E_coli / max(0.0001, K_E_coli * (y_function_E_coli_Mecillinam_func(Drug))))
  dE_lenta_dt <- r_E_lenta * E_lenta * (1 - E_lenta / max(0.0001, K_E_lenta * (y_function_E_lenta_Mecillinam_func(Drug))))
  dE_rectale_dt <- r_E_rectale * E_rectale * (1 - E_rectale / max(0.0001, K_E_rectale * (y_function_E_rectale_Mecillinam_func(Drug))))
  dF_nucleatum_dt <- r_F_nucleatum * F_nucleatum * (1 - F_nucleatum / max(0.0001, K_F_nucleatum * (y_function_F_nucleatum_Mecillinam_func(Drug))))
  dL_paracasei_dt <- r_L_paracasei * L_paracasei * (1 - L_paracasei / K_L_paracasei)  
  dO_splanchnicus_dt <- r_O_splanchnicus * O_splanchnicus * (1 - O_splanchnicus / K_O_splanchnicus)  
  dP_copri_dt <- r_P_copri * P_copri * (1 - P_copri / K_P_copri)
  dP_distasonis_dt <- r_P_distasonis * P_distasonis * (1 - P_distasonis / K_P_distasonis)  
  dP_merdae_dt <- r_P_merdae * P_merdae * (1 - P_merdae / max(0.0001, K_P_merdae * (y_function_P_merdae_Mecillinam_func(Drug))))
  dR_bromii_dt <- r_R_bromii * R_bromii * (1 - R_bromii / K_R_bromii) 
  dR_gnavus_dt <- r_R_gnavus * R_gnavus * (1 - R_gnavus / max(0.0001, K_R_gnavus * (y_function_R_gnavus_Mecillinam_func(Drug))))
  dR_intestinalis_dt <- r_R_intestinalis * R_intestinalis * (1 - R_intestinalis / max(0.0001, K_R_intestinalis * (y_function_R_intestinalis_Mecillinam_func(Drug))))
  dR_torques_dt <- r_R_torques * R_torques * (1 - R_torques /K_R_torques) 
  dS_parasanguinis_dt <- r_S_parasanguinis * S_parasanguinis * (1 - S_parasanguinis / max(0.0001, K_S_parasanguinis * (y_function_S_parasanguinis_Mecillinam_func(Drug))))
  dS_salivarius_dt <- r_S_salivarius * S_salivarius * (1 - S_salivarius / max(0.0001, K_S_salivarius * (y_function_S_salivarius_Mecillinam_func(Drug))))
  dV_parvula_dt <- r_V_parvula * V_parvula * (1 - V_parvula / max(0.0001, K_V_parvula * (y_function_V_parvula_Mecillinam_func(Drug))))
  
  
  
  #Drug differential:
  dDrug_dt <- (subset(drug_dynamics, Drug == "Mecillinam")$Steepness_param_community * exp(-subset(drug_dynamics, Drug == "Mecillinam")$Steepness_param_community * t_mod)) * (drug_concentration_tested * prop_left_Mecillinam - drug_concentration_tested)
  #dDrug_dt <- 0
  
  ## Combine results into a single vector
  dxdt <- c(dA_muciniphila_dt, dB_adolescentis_dt, dB_fragilis_dt, dB_longum_dt, dB_obeum_dt, dB_thetaiotaomicron_dt, dB_uniformis_dt, dB_vulgatus_dt, dB_wadsworthia_dt, dC_aerofaciens_dt, dC_bolteae_dt, dC_comes_dt, dC_perfringens_dt, dC_ramosum_dt, dC_saccharolyticum_dt, dD_formicigenerans_dt, dE_coli_dt, dE_lenta_dt, dE_rectale_dt, dF_nucleatum_dt, dL_paracasei_dt, dO_splanchnicus_dt, dP_copri_dt, dP_distasonis_dt, dP_merdae_dt, dR_bromii_dt, dR_gnavus_dt, dR_intestinalis_dt, dR_torques_dt, dS_parasanguinis_dt, dS_salivarius_dt, dV_parvula_dt, dDrug_dt)
  
  ## Return result as a list
  list(dxdt)
}




#calculate the co-culture correction factor per species based on community composition in absence of drug, just like done for Niclosamide

growth_data_all_0_Niclosamide
growth_data_all_0_Niclosamide1 <- growth_data_all_0_Niclosamide %>%
  dplyr::mutate(Species = gsub(" ", "_", Species))


# Merge rel_ab_control with growth_data_all_0_Niclosamide on Species
# Function to remove duplicated columns by name pattern
clean_columns_base <- function(df, pattern) {
  cols_to_keep <- !grepl(pattern, names(df))
  df <- df[, cols_to_keep]
  return(df)
}

# Use the new function to clean up your dataframe
rel_ab_control <- clean_columns_base(rel_ab_control, "mean_max_OD.[xy]")
str(rel_ab_control)


#rel_ab_control$correction_factor <- rel_ab_control$mean_rel_ab / (rel_ab_control$mean_max_OD/sum(rel_ab_control$mean_max_OD))
# Calculate correction factor with a minimum value of ~1
rel_ab_control$correction_factor <- pmax(rel_ab_control$mean_rel_ab / (rel_ab_control$mean_max_OD / sum(rel_ab_control$mean_max_OD)), 1.1)


# Create a new dataframe for co-culture correction
co_culture_correction <- data.frame(
  species = rel_ab_control$Species,
  correction_factor = rel_ab_control$correction_factor
)


#summarise community data
#Adjust based on tested concentrations for each drug
unique(Community_compositions_focus_drugs_Mecillinam$concentration)

Community_compositions_focus_drugs_Mecillinam_0.5uM <- subset(Community_compositions_focus_drugs_Mecillinam, concentration == 0.5)
Community_compositions_focus_drugs_Mecillinam_20uM <- subset(Community_compositions_focus_drugs_Mecillinam, concentration == 20)
Community_compositions_focus_drugs_Mecillinam_2.5uM <- subset(Community_compositions_focus_drugs_Mecillinam, concentration == 2.5)


#0.5 uM
Community_compositions_focus_drugs_Mecillinam_0.5uM_summarised <- Community_compositions_focus_drugs_Mecillinam_0.5uM %>%
  dplyr::group_by(species) %>%                                  
  dplyr::summarize(
    mean_rel_ab = mean(rel_abundance, na.rm = TRUE),     
    sd_rel_ab = sd(rel_abundance, na.rm = TRUE) ,
    mean_max_OD = mean(maxOD, na.rm = TRUE),
    sd_max_OD = sd(maxOD, na.rm = TRUE),
    mean_final_OD = mean(finalOD, na.rm = TRUE),
    sd_final_OD = sd(finalOD, na.rm = TRUE)
  ) %>%
  dplyr::ungroup() 


Community_compositions_focus_drugs_Mecillinam_0.5uM_summarised <- Community_compositions_focus_drugs_Mecillinam_0.5uM_summarised %>%
  dplyr::mutate(Species = sub("^(\\w)\\w*\\s(.*)", "\\1._\\2", species))

#remove (sub)strain info
Community_compositions_focus_drugs_Mecillinam_0.5uM_summarised <- Community_compositions_focus_drugs_Mecillinam_0.5uM_summarised %>%
  dplyr::mutate(Species = sub("^(\\w\\._\\w+).*", "\\1", Species))


#20 uM
Community_compositions_focus_drugs_Mecillinam_20uM_summarised <- Community_compositions_focus_drugs_Mecillinam_20uM %>%
  dplyr::group_by(species) %>%                                  
  dplyr::summarize(
    mean_rel_ab = mean(rel_abundance, na.rm = TRUE),     
    sd_rel_ab = sd(rel_abundance, na.rm = TRUE) ,
    mean_max_OD = mean(maxOD, na.rm = TRUE),
    sd_max_OD = sd(maxOD, na.rm = TRUE),
    mean_final_OD = mean(finalOD, na.rm = TRUE),
    sd_final_OD = sd(finalOD, na.rm = TRUE)
  ) %>%
  dplyr::ungroup() 


Community_compositions_focus_drugs_Mecillinam_20uM_summarised <- Community_compositions_focus_drugs_Mecillinam_20uM_summarised %>%
  dplyr::mutate(Species = sub("^(\\w)\\w*\\s(.*)", "\\1._\\2", species))

#remove (sub)strain info
Community_compositions_focus_drugs_Mecillinam_20uM_summarised <- Community_compositions_focus_drugs_Mecillinam_20uM_summarised %>%
  dplyr::mutate(Species = sub("^(\\w\\._\\w+).*", "\\1", Species))


#2.5uM
Community_compositions_focus_drugs_Mecillinam_2.5uM_summarised <- Community_compositions_focus_drugs_Mecillinam_2.5uM %>%
  dplyr::group_by(species) %>%                                  
  dplyr::summarize(
    mean_rel_ab = mean(rel_abundance, na.rm = TRUE),     
    sd_rel_ab = sd(rel_abundance, na.rm = TRUE) ,
    mean_max_OD = mean(maxOD, na.rm = TRUE),
    sd_max_OD = sd(maxOD, na.rm = TRUE),    
    mean_final_OD = mean(finalOD, na.rm = TRUE),
    sd_final_OD = sd(finalOD, na.rm = TRUE)
  ) %>%
  dplyr::ungroup() 



Community_compositions_focus_drugs_Mecillinam_2.5uM_summarised <- Community_compositions_focus_drugs_Mecillinam_2.5uM_summarised %>%
  dplyr::mutate(Species = sub("^(\\w)\\w*\\s(.*)", "\\1._\\2", species))

#remove (sub)strain info
Community_compositions_focus_drugs_Mecillinam_2.5uM_summarised <- Community_compositions_focus_drugs_Mecillinam_2.5uM_summarised %>%
  dplyr::mutate(Species = sub("^(\\w\\._\\w+).*", "\\1", Species))


#Initialise data frames
sim_output <- data.frame()
input_params_list <- list() #Use a list to collect parameters for each simulation

#number of simulations
num_sims <- 250


for (i in 1:num_sims) {
  tryCatch({
    # generate model parameters
    set.seed(i) #set a different seed for each simulation for variation
    params <- lapply(1:nrow(growth_data_all_0_Niclosamide), function(idx) {
      species_params <- growth_data_all_0_Niclosamide[idx, ]
      list(
        r = rnorm(1, mean = species_params$mean_max_Growth_rate, sd = species_params$sd_max_Growth_rate),
        K = rnorm(1, mean = species_params$mean_max_OD, sd = species_params$sd_max_OD)
      )
    })
    names(params) <- gsub(" ", "_", growth_data_all_0_Niclosamide$Species)
    flat_params <- unlist(params)
    names(flat_params) <- gsub("\\.\\d$", "", names(flat_params))
    
    #replace spaces with underscores to match formatting
    co_culture_correction$species <- gsub(" ", "_", co_culture_correction$species, fixed = TRUE)
    
    #replace the species-specific K parameters extracted from monoculture growth data 
    #with drawn relative abundance values at Niclosamide = 0, scaled to K
    rel_ab_control$Species <- gsub(" ", "_", rel_ab_control$Species)
    
    #Initialise an empty vector to store drawn values
    drawn_values <- numeric(nrow(rel_ab_control))
    
    #draw values from their respective distributions
    for (k in 1:nrow(rel_ab_control)) {
      species_name <- rel_ab_control$Species[k]
      drawn_value <- rnorm(1, mean = rel_ab_control$mean_rel_ab[k], sd = rel_ab_control$sd_rel_ab[k])
      drawn_values[k] <- max(drawn_value, 0)  # Ensure no negative values
    }
    
    #Normalise drawn relative abundance values so they sum to 1 (to reflect a 'true' relative abundance distribution)
    #this is needed so when we convert the values into OD units by multiplying with the drawn community maxOD,
    # the sum of K_i parameters and the drawn K are equal
    normalised_values <- drawn_values / sum(drawn_values)
    
    #Pull community maxOD (K) at 0 drugs from respective normal distribution:
    K <- rnorm(n = 1, mean = rel_ab_control$mean_com_max_OD[1], sd = rel_ab_control$sd_com_max_OD[1])
    
    # Assign these normalised values to their respective species' .K parameters
    for (k in 1:nrow(rel_ab_control)) {
      species_name <- rel_ab_control$Species[k]
      k_index <- grep(paste0("^", species_name, "\\.K$"), names(flat_params))
      
      if (length(k_index) > 0) {
        old_value <- flat_params[k_index]
        flat_params[k_index] <- (normalised_values[k] + 0.0001) * K #add small value in case drawn K_i is 0, which would cause issues with the solver
        cat(sprintf("Updated %s from %f to %f using normalised value %f scaled by K %f\n", names(flat_params)[k_index], old_value, flat_params[k_index], normalised_values[k], K))
      }
    }
    
    #Accounting for variation in drug degradation by community, with standard deviation of end concentration (at 10h) around the fitted predicted (relative) end concentration at 24h
    #prop_left_Mecillinam <- abs(rnorm(1, (subset(drug_dynamics, Drug == "Mecillinam")$Prop_left_24h_community), (subset(drug_dynamics, Drug == "Mecillinam")$SD_drug_community))) 
    #below, we account for measurement error rather than ecological drivers that lead to the variability of degradation at the final point measured 
    prop_left_Mecillinam <- abs(rnorm(
      n = 1, 
      mean = subset(drug_dynamics, Drug == "Mecillinam")$Prop_left_24h_community, 
      sd = ifelse(
        subset(drug_dynamics, Drug == "Mecillinam")$SD_drug_community > subset(drug_dynamics, Drug == "Mecillinam")$SD_drug_community_start, 
        subset(drug_dynamics, Drug == "Mecillinam")$SD_drug_community - subset(drug_dynamics, Drug == "Mecillinam")$SD_drug_community_start, 
        subset(drug_dynamics, Drug == "Mecillinam")$SD_drug_community
      )
    ))
    
    
    #loop through each species in co_culture_correction
    for (j in 1:nrow(co_culture_correction)) {
      # Extract the species name and correction factor
      species_name <- co_culture_correction$species[j]
      correction_factor <- co_culture_correction$correction_factor[j]
      
      # Identify the corresponding growth rate parameter in flat_params
      #by matching the base species name (without .r)
      growth_rate_indices <- grep(paste0("^", species_name, "\\.r$"), names(flat_params))
      
      #take the growth rate parameter and apply the correction factor 
      for (index in growth_rate_indices) {
        flat_params[index] <- flat_params[index] * correction_factor
      }
    }
    
    flat_params
    # Store parameters for each simulation
    input_params_list[[i]] <- c(sim_ID = i, flat_params)
    
    # Run the model for the first 24-hour cycle
    solution_cycle_1 <- ode(y = initial_conditions, times = seq(from = 0, to = 24, by = 0.1), func = closed.sir.model_Mecillinam, parms = flat_params,   method = "lsoda", rtol = 1e-6, atol = 1e-6)
    
    # Dilution and second cycle
    end_of_cycle_1 <- solution_cycle_1[nrow(solution_cycle_1), -1]
    initial_conditions_cycle_2 <- end_of_cycle_1 / 50
    #accounting for the drugs being added with the new growth cycle as well:
    initial_conditions_cycle_2[33] <- initial_conditions_cycle_2[33] + drug_concentration_tested
    solution_cycle_2 <- ode(y = initial_conditions_cycle_2, times = seq(from = 24, to = 48, by = 0.1), func = closed.sir.model_Mecillinam, parms = flat_params,  method = "lsoda", rtol = 1e-6, atol = 1e-6)
    
    # Combine and format results
    combined_solution <- rbind(as.data.frame(solution_cycle_1), as.data.frame(solution_cycle_2)[-1,])
    combined_solution$sim_ID <- rep(i, nrow(combined_solution))
    combined_solution <- combined_solution %>%
      tidyr::gather(key = "Species", value = "Density", -time, -sim_ID) %>%
      dplyr::mutate(Hour = time) %>%
      dplyr::select(sim_ID, Hour, Species, Density)
    
    ##Append to sim_output
    sim_output <- rbind(sim_output, combined_solution)
  }, error = function(e) {
    cat(sprintf("Skipping simulation %d due to an error: %s\n", i, e$message))
  })
}



##Combine all parameter data into a single dataframe
input_params <- do.call(rbind, input_params_list)

# Add a "Species" column 
sim_output$Species_name <- species_names[as.numeric(as.character(sim_output$Species))]
sim_output$Species_name <- replace_na(sim_output$Species_name, "Drug")

#View(input_params)
#View(sim_output)

sim_output <- na.omit(sim_output)
successful_sim_ids <- unique(subset(sim_output, Hour == 48)$sim_ID)
length(successful_sim_ids)
sim_output1 <- sim_output[sim_output$sim_ID %in% successful_sim_ids, ]


#Transform sim_output so we have wide format by Species
sim_output_wide <- tidyr::pivot_wider(sim_output1, 
                                      names_from = Species_name, 
                                      values_from = Density,
                                      id_cols = c(sim_ID, Hour))

length(unique(sim_output_wide$sim_ID))
#calc community OD per timepoint
sim_output_wide$Total_OD <- rowSums(sim_output_wide[, 3:34], na.rm = TRUE)
#calculate and add relative abundances here as well:
species_columns <- colnames(sim_output_wide)[3:34] 

for (species in species_columns) {
  sim_output_wide[[paste0("rel_", species)]] <- sim_output_wide[[species]] / sim_output_wide$Total_OD
}


#assign sim_output_wide test conditions to dataframe name
drug_tested <- "Mecillinam"
variable_name_1 <- paste0("sim_output_wide_", ifelse(drug_concentration_tested == 1e-04, 0, drug_concentration_tested), "_", drug_tested)
assign(variable_name_1, sim_output_wide)

#turn back into long format if interested in plotting relative abundances
cols_needed <- c("sim_ID", "Hour")

sim_output_long <- sim_output_wide %>% 
  dplyr::select(sim_ID, Hour, Drug, starts_with("rel_")) %>% 
  tidyr::pivot_longer(
    cols = c(Drug, starts_with("rel_")),
    names_to = "Species", 
    values_to = "Relative_abundance",
    names_prefix = "rel_",
    names_transform = list(Species = ~ ifelse(.x == "Drug", "Drug", .x))
  ) 

str(sim_output_long)


species_names_1 <- c(
  "A_muciniphila",
  "B_adolescentis",
  "B_fragilis",
  "B_longum",
  "B_obeum",
  "B_thetaiotaomicron",
  "B_uniformis",
  "B_vulgatus",
  "B_wadsworthia",
  "C_aerofaciens",
  "C_bolteae",
  "C_comes",
  "C_perfringens",
  "C_ramosum",
  "C_saccharolyticum",
  "D_formicigenerans",
  "E_coli",
  "E_lenta",
  "E_rectale",
  "F_nucleatum",
  "L_paracasei",
  "O_splanchnicus",
  "P_copri",
  "P_distasonis",
  "P_merdae",
  "R_bromii",
  "R_gnavus",
  "R_intestinalis",
  "R_torques",
  "S_parasanguinis",
  "S_salivarius",
  "V_parvula",
  "Drug"
)

species_colours_1 <- c(
  "A_muciniphila" = "#1f77b4",
  "B_adolescentis" = "#ff7f0e",
  "B_fragilis" = "#2ca02c",
  "B_longum" = "#d62728",
  "B_obeum" = "#9467bd",
  "B_thetaiotaomicron" = "black",
  "B_uniformis" = "#e377c2",
  "B_vulgatus" = "#7f7f7f",
  "B_wadsworthia" = "gold1",
  "C_aerofaciens" = "#aec7e8",
  "C_bolteae" = "#ffbb78",
  "C_comes" = "magenta",
  "C_perfringens" = "#ff9896",
  "C_ramosum" = "#c5b0d5",
  "C_saccharolyticum" = "#c49c94",
  "D_formicigenerans" = "#f7b6d2",
  "E_coli" = "yellow",
  "E_lenta" = "turquoise",
  "E_rectale" = "#393b79",
  "F_nucleatum" = "royalblue2",
  "L_paracasei" = "blue",
  "O_splanchnicus" = "#637939",
  "P_copri" = "cyan",
  "P_distasonis" = "#8c6d31",
  "P_merdae" = "#c7c7c7",
  "R_bromii" = "#e6550d",
  "R_gnavus" = "#e7cb94",
  "R_intestinalis" = "#843c39",
  "R_torques" = "#d6616b",
  "S_parasanguinis" = "orange3",
  "S_salivarius" = "#7b4173",
  "V_parvula" = "#ce6dbd",
  "Drug" = "green"
)



##Plot output for any specific sim:
# ggplot(subset(sim_output, sim_ID == 1 & Species_name != "Drug"), aes(x = Hour, y = Density, group = Species_name, color = Species_name)) +
#   geom_line(size = 1, alpha = 0.7) +
#   scale_color_manual(values = species_colours_1) +
#   labs(title = paste0("Mecillinam = ", drug_concentration_tested),
#        x = "Time (hours)",
#        y = "Population Density (OD)",
#        color = "Species") +
#   theme_minimal() +
#   theme(legend.position = "right")
# 
# ggplot(subset(sim_output, sim_ID == 3 & Species_name != "Drug"), aes(x = Hour, y = Density, group = Species_name, color = Species_name)) +
#   geom_line(size = 1, alpha = 0.7) +
#   scale_color_manual(values = species_colours_1) +
#   labs(title = paste0("Mecillinam = ", drug_concentration_tested),
#        x = "Time (hours)",
#        y = "Population Density (OD)",
#        color = "Species") +
#   theme_minimal() +
#   theme(legend.position = "right")


ggplot(subset(sim_output_long, sim_ID == 1), aes(x = Hour, y = Relative_abundance, group = Species, color = Species)) +
  geom_line(size = 1, alpha = 0.7) +
  scale_color_manual(values = species_colours_1) +
  labs(title = paste0("Mecillinam = ", drug_concentration_tested),
       x = "Time (hours)",
       y = "Relative abundance",
       color = "Species") +
  theme_minimal() +
  theme(legend.position = "right")


ggplot(subset(sim_output_long, sim_ID == 3), aes(x = Hour, y = Relative_abundance, group = Species, color = Species)) +
  geom_line(size = 1, alpha = 0.7) +
  scale_color_manual(values = species_colours_1) +
  labs(title = paste0("Mecillinam = ", drug_concentration_tested),
       x = "Time (hours)",
       y = "Relative abundance",
       color = "Species") +
  theme_minimal() +
  theme(legend.position = "right")


#calc mean and standard deviation across sims
sim_stats <- sim_output_long %>%
  dplyr::group_by(Hour, Species) %>%
  dplyr::summarise(
    mean_rel_ab = mean(Relative_abundance),
    sd_rel_ab = sd(Relative_abundance),
    .groups = 'drop'
  )

# Prepare the data for plotting
plot_data <- sim_stats %>%
  dplyr::mutate(Upper = mean_rel_ab + sd_rel_ab, Lower = mean_rel_ab - sd_rel_ab)

ggplot(subset(plot_data, Species != "Drug"), aes(x = Hour, y = mean_rel_ab, group = Species, color = Species)) +
  geom_ribbon(aes(ymin = Lower, ymax = Upper, fill = Species), colour = NA, alpha = 0.2) +  
  geom_line(size = 1, alpha = 0.7) + 
  scale_color_manual(values = species_colours_1) +
  scale_fill_manual(values = species_colours_1) +  
  labs(title = "Mean and SD of Relative Abundance Across Simulations",
       subtitle = paste0("Mecillinam = ", drug_concentration_tested),       
       x = "Time (hours)",
       y = "Relative abundance",
       color = "Species",
       fill = "Species") +
  theme_minimal() +
  theme(legend.position = "right")

#log-scaled mean trends
ggplot(plot_data, aes(x = Hour, y = log10(mean_rel_ab + 0.0001), group = Species, color = Species)) +
  geom_line(size = 1, alpha = 0.7) +  # Mean line
  scale_color_manual(values = species_colours_1) +
  scale_fill_manual(values = species_colours_1) +  # Ensure consistent colors for lines and fills
  labs(title = "Mean and SD of Relative Abundance Across Simulations",
       subtitle = paste0("Mecillinam = ", drug_concentration_tested),
       x = "Time (hours)",
       y = "Relative abundance",
       color = "Species",
       fill = "Species") +
  theme_minimal() +
  theme(legend.position = "right")




##prediction quality evaluation
drug_tested <- "Mecillinam"
variable_name <- paste0("plot_data_", ifelse(drug_concentration_tested == 1e-04, 0, drug_concentration_tested), "_", drug_tested)
assign(variable_name, plot_data)


#extract total OD info:
predicted_mean_final_od_NULL <- Niclosamide_16S_0uM_summarised$mean_com_final_OD[1]
predicted_sd_final_od_NULL <- Niclosamide_16S_0uM_summarised$sd_com_final_OD[1]

predicted_mean_final_od_0.5_Mecillinam <- mean(subset(sim_output_wide_0.5_Mecillinam, Hour == 48)$Total_OD, na.rm = TRUE)
predicted_sd_final_od_0.5_Mecillinam <- sd(subset(sim_output_wide_0.5_Mecillinam, Hour == 48)$Total_OD, na.rm = TRUE)

real_mean_final_od_0.5_Mecillinam <- Community_compositions_focus_drugs_Mecillinam_0.5uM_summarised$mean_final_OD[1]
real_sd_final_od_0.5_Mecillinam <- Community_compositions_focus_drugs_Mecillinam_0.5uM_summarised$sd_final_OD[1]


predicted_mean_final_od_20_Mecillinam <- mean(subset(sim_output_wide_20_Mecillinam, Hour == 48)$Total_OD, na.rm = TRUE)
predicted_sd_final_od_20_Mecillinam <- sd(subset(sim_output_wide_20_Mecillinam, Hour == 48)$Total_OD, na.rm = TRUE)

real_mean_final_od_20_Mecillinam <- Community_compositions_focus_drugs_Mecillinam_20uM_summarised$mean_final_OD[1]
real_sd_final_od_20_Mecillinam <- Community_compositions_focus_drugs_Mecillinam_20uM_summarised$sd_final_OD[1]


predicted_mean_final_od_2.5_Mecillinam <- mean(subset(sim_output_wide_2.5_Mecillinam, Hour == 48)$Total_OD, na.rm = TRUE)
predicted_sd_final_od_2.5_Mecillinam <- sd(subset(sim_output_wide_2.5_Mecillinam, Hour == 48)$Total_OD, na.rm = TRUE)

real_mean_final_od_2.5_Mecillinam <- Community_compositions_focus_drugs_Mecillinam_2.5uM_summarised$mean_final_OD[1]
real_sd_final_od_2.5_Mecillinam <- Community_compositions_focus_drugs_Mecillinam_2.5uM_summarised$sd_final_OD[1]




#plot_data_0_Mecillinam_endpoint was used to test model performance at 0 drugs
#plot_data_0_Mecillinam_endpoint <- subset(plot_data_0_Mecillinam, Hour == 48 & Species != "Drug")
plot_data_0.5_Mecillinam_endpoint <- subset(plot_data_0.5_Mecillinam, Hour == 48 & Species != "Drug")
plot_data_20_Mecillinam_endpoint <- subset(plot_data_20_Mecillinam, Hour == 48 & Species != "Drug")
plot_data_2.5_Mecillinam_endpoint <- subset(plot_data_2.5_Mecillinam, Hour == 48 & Species != "Drug")

##Inspecting 'match' to real relative abundance distributions:
Niclosamide_16S_0uM_summarised <- rel_ab_control
Niclosamide_16S_0uM_summarised$Species <- gsub("\\.", "", Niclosamide_16S_0uM_summarised$Species)

Mecillinam_16S_0.5uM_summarised <- Community_compositions_focus_drugs_Mecillinam_0.5uM_summarised
Mecillinam_16S_20uM_summarised <- Community_compositions_focus_drugs_Mecillinam_20uM_summarised
Mecillinam_16S_2.5uM_summarised <- Community_compositions_focus_drugs_Mecillinam_2.5uM_summarised

Niclosamide_16S_0uM_summarised
Mecillinam_16S_0.5uM_summarised 
Mecillinam_16S_20uM_summarised 
Mecillinam_16S_2.5uM_summarised 

#Rename 'species' so the outputs become comparable
original_names_2.5 <- unique(Mecillinam_16S_2.5uM_summarised$species)
original_names_20 <- unique(Mecillinam_16S_20uM_summarised$species)
original_names_0.5 <- unique(Mecillinam_16S_0.5uM_summarised$species)


##Create a named vector with the original and new names mapping
name_changes <- c(
  "Akkermansia muciniphila" = "A_muciniphila",
  "Bacteroides fragilis" = "B_fragilis",
  "Bacteroides thetaiotaomicron" = "B_thetaiotaomicron",
  "Bacteroides uniformis" = "B_uniformis",
  "Bifidobacterium adolescentis" = "B_adolescentis",
  "Bifidobacterium longum subsp. longum" = "B_longum",
  "Bilophila wadsworthia" = "B_wadsworthia",
  "Blautia obeum" = "B_obeum",
  "Clostridium perfringens" = "C_perfringens",
  "Collinsella aerofaciens" = "C_aerofaciens",
  "Coprococcus comes" = "C_comes",
  "Dorea formicigenerans" = "D_formicigenerans",
  "Eggerthella lenta" = "E_lenta",
  "Enterocloster bolteae" = "C_bolteae",
  "Erysipelatoclostridium ramosum" = "C_ramosum",
  "Escherichia coli ED1a" = "E_coli",
  "Eubacterium rectale" = "E_rectale",
  "Fusobacterium nucleatum subsp. nucleatum" = "F_nucleatum",
  "Lacrimispora saccharolytica" = "C_saccharolyticum",
  "Lacticaseibacillus paracasei" = "L_paracasei",
  "Odoribacter splanchnicus" = "O_splanchnicus",
  "Parabacteroides distasonis" = "P_distasonis",
  "Parabacteroides merdae" = "P_merdae",
  "Phocaeicola vulgatus" = "B_vulgatus",
  "Prevotella copri" = "P_copri",
  "Roseburia intestinalis" = "R_intestinalis",
  "Ruminococcus bromii" = "R_bromii",
  "Ruminococcus gnavus" = "R_gnavus",
  "Ruminococcus torques" = "R_torques",
  "Streptococcus parasanguinis" = "S_parasanguinis",
  "Streptococcus salivarius" = "S_salivarius",
  "Veillonella parvula" = "V_parvula"
)

# Apply name changes to the species column in Mecillinam_16S_2.5uM_summarised

Mecillinam_16S_2.5uM_summarised$Species <- name_changes[Mecillinam_16S_2.5uM_summarised$species]
Mecillinam_16S_20uM_summarised$Species <- name_changes[Mecillinam_16S_20uM_summarised$species]
Mecillinam_16S_0.5uM_summarised$Species <- name_changes[Mecillinam_16S_0.5uM_summarised$species]

# Verify the changes
unique(Mecillinam_16S_2.5uM_summarised$Species)
unique(Mecillinam_16S_20uM_summarised$Species)
unique(Mecillinam_16S_0.5uM_summarised$Species)



##First, for 0.5 uM:
# Get top 6 species from plot_data_0.5_endpoint
# Adjust the plot_data_0.5_endpoint with confidence bounds

# #plot_data_0_Mecillinam_endpoint was used to test model performance at 0 drugs
# plot_data_0_Mecillinam_endpoint <- plot_data_0_Mecillinam_endpoint %>%
#   dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)

plot_data_0.5_Mecillinam_endpoint <- plot_data_0.5_Mecillinam_endpoint %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)

# Adjust the Mecillinam_16S_0.5uM_summarised with confidence bounds
Mecillinam_16S_0.5uM_summarised <- Mecillinam_16S_0.5uM_summarised %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)

#NULL model:
Null_model_summarised <- Niclosamide_16S_0uM_summarised %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)


# Get top 6 species based on the lower bound from plot_data_0.5_endpoint

#top6_predicted_0_Mecillinam was used to test model performance at 0 drugs
# top6_predicted_0_Mecillinam <- plot_data_0_Mecillinam_endpoint %>%
#    arrange(desc(lower_bound)) %>%
#    slice(1:6) %>%
#    pull(Species)

top6_predicted_0.5_Mecillinam <- plot_data_0.5_Mecillinam_endpoint %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

# Get top 6 species based on the lower bound from Mecillinam_16S_0.5uM_summarised
top6_real_0.5_Mecillinam <- Mecillinam_16S_0.5uM_summarised %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

top6_NULL <- Null_model_summarised %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

# Calculate the overlap of top 6 species

#top_six_correct_0_Mecillinam was used to assess model performance at 0 drugs
# top_six_correct_0_Mecillinam <- length(intersect(top6_predicted_0_Mecillinam, top6_NULL))
# top_six_correct_0_Mecillinam

top_six_correct_0.5_Mecillinam <- length(intersect(top6_predicted_0.5_Mecillinam, top6_real_0.5_Mecillinam))
top_six_correct_0.5_Mecillinam

top_six_correct_0.5_Mecillinam_NULL <- length(intersect(top6_NULL, top6_real_0.5_Mecillinam))
top_six_correct_0.5_Mecillinam_NULL

top6_predicted_0.5_Mecillinam
top6_real_0.5_Mecillinam

#top6_NULL

#Now by means:
# #top6_predicted_0_Mecillinam_means was used to assess model performance at 0 drugs
# top6_predicted_0_Mecillinam_means <- plot_data_0_Mecillinam_endpoint %>%
#    arrange(desc(mean_rel_ab)) %>%
#    slice(1:6) %>%
#    pull(Species)

top6_predicted_0.5_Mecillinam_means <- plot_data_0.5_Mecillinam_endpoint %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)

# Get top 6 species based on the lower bound from Mecillinam_16S_0.5uM_summarised
top6_real_0.5_Mecillinam_means <- Mecillinam_16S_0.5uM_summarised %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)

top6_NULL_means <- Null_model_summarised %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)


# #top_six_correct_0_Mecillinam_means was used to assess model performance at 0 drugs
# top_six_correct_0_Mecillinam_means <- length(intersect(top6_predicted_0_Mecillinam_means, top6_NULL_means))
# top_six_correct_0_Mecillinam_means

top_six_correct_0.5_Mecillinam_means <- length(intersect(top6_predicted_0.5_Mecillinam_means, top6_real_0.5_Mecillinam_means))
top_six_correct_0.5_Mecillinam_means

top_six_correct_0.5_Mecillinam_means_NULL <- length(intersect(top6_NULL_means, top6_real_0.5_Mecillinam_means))
top_six_correct_0.5_Mecillinam_means_NULL

top6_predicted_0.5_Mecillinam_means
top6_real_0.5_Mecillinam_means

#top6_NULL_means


# Merge dataframes by Species

#merged_data_0_Mecillinam was used to assess model performance at 0 drugs
#merged_data_0_Mecillinam <- merge(plot_data_0_Mecillinam_endpoint, Niclosamide_16S_0uM_summarised, by = "Species", suffixes = c(".pred", ".real"))
merged_data_0.5_Mecillinam <- merge(plot_data_0.5_Mecillinam_endpoint, Mecillinam_16S_0.5uM_summarised, by = "Species", suffixes = c(".pred", ".real"))
merged_data_0.5_Mecillinam_NULL <- merge(Niclosamide_16S_0uM_summarised, Mecillinam_16S_0.5uM_summarised, by = "Species", suffixes = c(".null", ".real"))


## Below lines used for assessing model performance at 0 drugs; ignore for nonzero concentrations
# # Create lower and upper bounds considering mean ¬± sd
# merged_data_0_Mecillinam$lower_bound_pred <- merged_data_0_Mecillinam$mean_rel_ab.pred - merged_data_0_Mecillinam$sd_rel_ab.pred
# merged_data_0_Mecillinam$upper_bound_pred <- merged_data_0_Mecillinam$mean_rel_ab.pred + merged_data_0_Mecillinam$sd_rel_ab.pred
# merged_data_0_Mecillinam$lower_bound_real <- merged_data_0_Mecillinam$mean_rel_ab.real - merged_data_0_Mecillinam$sd_rel_ab.real
# merged_data_0_Mecillinam$upper_bound_real <- merged_data_0_Mecillinam$mean_rel_ab.real + merged_data_0_Mecillinam$sd_rel_ab.real
# 
# # Ensure lower and upper bounds are non-negative, adjusting as necessary
# merged_data_0_Mecillinam$lower_bound_pred[merged_data_0_Mecillinam$lower_bound_pred <= 0] <- 1e-10
# merged_data_0_Mecillinam$lower_bound_real[merged_data_0_Mecillinam$lower_bound_real <= 0] <- 1e-10
# merged_data_0_Mecillinam$upper_bound_pred[merged_data_0_Mecillinam$upper_bound_pred <= 0] <- 1e-10
# merged_data_0_Mecillinam$upper_bound_real[merged_data_0_Mecillinam$upper_bound_real <= 0] <- 1e-10


# Create lower and upper bounds considering mean ¬± sd
merged_data_0.5_Mecillinam$lower_bound_pred <- merged_data_0.5_Mecillinam$mean_rel_ab.pred - merged_data_0.5_Mecillinam$sd_rel_ab.pred
merged_data_0.5_Mecillinam$upper_bound_pred <- merged_data_0.5_Mecillinam$mean_rel_ab.pred + merged_data_0.5_Mecillinam$sd_rel_ab.pred
merged_data_0.5_Mecillinam$lower_bound_real <- merged_data_0.5_Mecillinam$mean_rel_ab.real - merged_data_0.5_Mecillinam$sd_rel_ab.real
merged_data_0.5_Mecillinam$upper_bound_real <- merged_data_0.5_Mecillinam$mean_rel_ab.real + merged_data_0.5_Mecillinam$sd_rel_ab.real

# Ensure lower and upper bounds are non-negative, adjusting as necessary
merged_data_0.5_Mecillinam$lower_bound_pred[merged_data_0.5_Mecillinam$lower_bound_pred <= 0] <- 1e-10
merged_data_0.5_Mecillinam$lower_bound_real[merged_data_0.5_Mecillinam$lower_bound_real <= 0] <- 1e-10
merged_data_0.5_Mecillinam$upper_bound_pred[merged_data_0.5_Mecillinam$upper_bound_pred <= 0] <- 1e-10
merged_data_0.5_Mecillinam$upper_bound_real[merged_data_0.5_Mecillinam$upper_bound_real <= 0] <- 1e-10

##and for NULL model:
# Create lower and upper bounds considering mean ¬± sd
merged_data_0.5_Mecillinam_NULL$lower_bound_null <- merged_data_0.5_Mecillinam_NULL$mean_rel_ab.null - merged_data_0.5_Mecillinam_NULL$sd_rel_ab.null
merged_data_0.5_Mecillinam_NULL$upper_bound_null <- merged_data_0.5_Mecillinam_NULL$mean_rel_ab.null + merged_data_0.5_Mecillinam_NULL$sd_rel_ab.null
merged_data_0.5_Mecillinam_NULL$lower_bound_real <- merged_data_0.5_Mecillinam_NULL$mean_rel_ab.real - merged_data_0.5_Mecillinam_NULL$sd_rel_ab.real
merged_data_0.5_Mecillinam_NULL$upper_bound_real <- merged_data_0.5_Mecillinam_NULL$mean_rel_ab.real + merged_data_0.5_Mecillinam_NULL$sd_rel_ab.real

# Ensure lower and upper bounds are non-negative, adjusting as necessary
merged_data_0.5_Mecillinam_NULL$lower_bound_null[merged_data_0.5_Mecillinam_NULL$lower_bound_null <= 0] <- 1e-10
merged_data_0.5_Mecillinam_NULL$lower_bound_real[merged_data_0.5_Mecillinam_NULL$lower_bound_real <= 0] <- 1e-10
merged_data_0.5_Mecillinam_NULL$upper_bound_null[merged_data_0.5_Mecillinam_NULL$upper_bound_null <= 0] <- 1e-10
merged_data_0.5_Mecillinam_NULL$upper_bound_real[merged_data_0.5_Mecillinam_NULL$upper_bound_real <= 0] <- 1e-10

# Filter to include only species with a mean relative abundance > 0.01 in the 'real' dataset

## significant_species_0 was used to assess model performance at 0 drugs
#significant_species_0 <- merged_data_0_Mecillinam[merged_data_0_Mecillinam$mean_rel_ab.real > 0.01, ]
significant_species <- merged_data_0.5_Mecillinam[merged_data_0.5_Mecillinam$mean_rel_ab.real > 0.01, ]
survivors_0.5_Mecillinam <- nrow(significant_species)
survivors_0.5_Mecillinam

#should be the same as survivors defined above, since it is calculated from .real
significant_species_NULL <- merged_data_0.5_Mecillinam_NULL[merged_data_0.5_Mecillinam_NULL$mean_rel_ab.real > 0.01, ]
survivors_0.5_Mecillinam_NULL <- nrow(significant_species_NULL)
survivors_0.5_Mecillinam_NULL

# Adjusted order of magnitude check to include SD, only for significant species
## below code was used to assess model performance at 0 drugs
# significant_species_0$Predicted_magnitude_correct <- ifelse(
#   (floor(log10(significant_species_0$lower_bound_pred)) <= floor(log10(significant_species_0$upper_bound_real)) &
#      floor(log10(significant_species_0$upper_bound_pred)) >= floor(log10(significant_species_0$lower_bound_real))),
#   1,
#   0
# )

significant_species$Predicted_magnitude_correct <- ifelse(
  (floor(log10(significant_species$lower_bound_pred)) <= floor(log10(significant_species$upper_bound_real)) &
     floor(log10(significant_species$upper_bound_pred)) >= floor(log10(significant_species$lower_bound_real))),
  1,
  0
)

#and for the Null model:
significant_species_NULL$Predicted_magnitude_correct <- ifelse(
  (floor(log10(significant_species_NULL$lower_bound_null)) <= floor(log10(significant_species_NULL$upper_bound_real)) &
     floor(log10(significant_species_NULL$upper_bound_null)) >= floor(log10(significant_species_NULL$lower_bound_real))),
  1,
  0
)

# Calculate the fraction of correctly predicted magnitudes for significant species
## below code was used to assess model performance at 0 drugs
#predicted_magnitude_correct_fraction_0_Mecillinam <- sum(significant_species_0$Predicted_magnitude_correct) / nrow(significant_species_0)
#predicted_magnitude_correct_fraction_0_Mecillinam

predicted_magnitude_correct_fraction_0.5_Mecillinam <- sum(significant_species$Predicted_magnitude_correct) / nrow(significant_species)
predicted_magnitude_correct_fraction_0.5_Mecillinam

predicted_magnitude_correct_fraction_0.5_Mecillinam_NULL <- sum(significant_species_NULL$Predicted_magnitude_correct) / nrow(significant_species_NULL)
predicted_magnitude_correct_fraction_0.5_Mecillinam_NULL

top_species_missing_0.5_Mecillinam <- setdiff(top6_real_0.5_Mecillinam_means, top6_predicted_0.5_Mecillinam_means)
top_species_wrong_0.5_Mecillinam <- setdiff(top6_predicted_0.5_Mecillinam_means, top6_real_0.5_Mecillinam_means)


Prediction_quality_0.5_Mecillinam <- data.frame(
  Top_six_correct = paste(top_six_correct_0.5_Mecillinam, sep=""),
  Top_six_correct_NULL = paste(top_six_correct_0.5_Mecillinam_NULL, sep=""),
  Top_six_correct_means = paste(top_six_correct_0.5_Mecillinam_means, sep=""),
  Top_six_correct_means_NULL = paste(top_six_correct_0.5_Mecillinam_means_NULL, sep=""),
  Predicted_magnitude_correct = paste(round(predicted_magnitude_correct_fraction_0.5_Mecillinam * 100, 2), "%", sep=""),
  Predicted_magnitude_correct_NULL = paste(round(predicted_magnitude_correct_fraction_0.5_Mecillinam_NULL * 100, 2), "%", sep=""),
  survivors_total = survivors_0.5_Mecillinam,
  top_species_missing <- top_species_missing_0.5_Mecillinam,
  top_species_wrong <- top_species_wrong_0.5_Mecillinam, 
  predicted_mean_final_OD <- predicted_mean_final_od_0.5_Mecillinam,
  real_mean_final_OD <- real_mean_final_od_0.5_Mecillinam,
  sims_total = length(successful_sim_ids)
)



Prediction_quality_0.5_Mecillinam



##Next, for 20 uM:
# Get top 6 species from plot_data_20_endpoint
# Adjust the plot_data_20_endpoint with confidence bounds
plot_data_20_Mecillinam_endpoint <- plot_data_20_Mecillinam_endpoint %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)

# Adjust the Mecillinam_16S_20uM_summarised with confidence bounds
Mecillinam_16S_20uM_summarised <- Mecillinam_16S_20uM_summarised %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)

#NULL model:
Null_model_summarised <- Niclosamide_16S_0uM_summarised %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)


# Get top 6 species based on the lower bound from plot_data_20_endpoint
top6_predicted_20_Mecillinam <- plot_data_20_Mecillinam_endpoint %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

# Get top 6 species based on the lower bound from Mecillinam_16S_20uM_summarised
top6_real_20_Mecillinam <- Mecillinam_16S_20uM_summarised %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

top6_NULL <- Null_model_summarised %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

# Calculate the overlap of top 6 species
top_six_correct_20_Mecillinam <- length(intersect(top6_predicted_20_Mecillinam, top6_real_20_Mecillinam))
#top_six_correct_20_Mecillinam

top_six_correct_20_Mecillinam_NULL <- length(intersect(top6_NULL, top6_real_20_Mecillinam))
#top_six_correct_20_Mecillinam_NULL

#top6_predicted_20_Mecillinam
#top6_real_20_Mecillinam



#Now by means:
top6_predicted_20_Mecillinam_means <- plot_data_20_Mecillinam_endpoint %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)

# Get top 6 species based on the lower bound from Mecillinam_16S_20uM_summarised
top6_real_20_Mecillinam_means <- Mecillinam_16S_20uM_summarised %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)

top6_NULL_means <- Null_model_summarised %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)



top_six_correct_20_Mecillinam_means <- length(intersect(top6_predicted_20_Mecillinam_means, top6_real_20_Mecillinam_means))
#top_six_correct_20_Mecillinam_means

top_six_correct_20_Mecillinam_means_NULL <- length(intersect(top6_NULL_means, top6_real_20_Mecillinam_means))
#top_six_correct_20_Mecillinam_means_NULL

top6_predicted_20_Mecillinam_means
#top6_real_20_Mecillinam_means




# Merge dataframes by Species
merged_data_20_Mecillinam <- merge(plot_data_20_Mecillinam_endpoint, Mecillinam_16S_20uM_summarised, by = "Species", suffixes = c(".pred", ".real"))
merged_data_20_Mecillinam_NULL <- merge(Niclosamide_16S_0uM_summarised, Mecillinam_16S_20uM_summarised, by = "Species", suffixes = c(".null", ".real"))



# Create lower and upper bounds considering mean ¬± sd
merged_data_20_Mecillinam$lower_bound_pred <- merged_data_20_Mecillinam$mean_rel_ab.pred - merged_data_20_Mecillinam$sd_rel_ab.pred
merged_data_20_Mecillinam$upper_bound_pred <- merged_data_20_Mecillinam$mean_rel_ab.pred + merged_data_20_Mecillinam$sd_rel_ab.pred
merged_data_20_Mecillinam$lower_bound_real <- merged_data_20_Mecillinam$mean_rel_ab.real - merged_data_20_Mecillinam$sd_rel_ab.real
merged_data_20_Mecillinam$upper_bound_real <- merged_data_20_Mecillinam$mean_rel_ab.real + merged_data_20_Mecillinam$sd_rel_ab.real

# Ensure lower and upper bounds are non-negative, adjusting as necessary
merged_data_20_Mecillinam$lower_bound_pred[merged_data_20_Mecillinam$lower_bound_pred <= 0] <- 1e-10
merged_data_20_Mecillinam$lower_bound_real[merged_data_20_Mecillinam$lower_bound_real <= 0] <- 1e-10
merged_data_20_Mecillinam$upper_bound_pred[merged_data_20_Mecillinam$upper_bound_pred <= 0] <- 1e-10
merged_data_20_Mecillinam$upper_bound_real[merged_data_20_Mecillinam$upper_bound_real <= 0] <- 1e-10

##and for NULL model:
# Create lower and upper bounds considering mean ¬± sd
merged_data_20_Mecillinam_NULL$lower_bound_null <- merged_data_20_Mecillinam_NULL$mean_rel_ab.null - merged_data_20_Mecillinam_NULL$sd_rel_ab.null
merged_data_20_Mecillinam_NULL$upper_bound_null <- merged_data_20_Mecillinam_NULL$mean_rel_ab.null + merged_data_20_Mecillinam_NULL$sd_rel_ab.null
merged_data_20_Mecillinam_NULL$lower_bound_real <- merged_data_20_Mecillinam_NULL$mean_rel_ab.real - merged_data_20_Mecillinam_NULL$sd_rel_ab.real
merged_data_20_Mecillinam_NULL$upper_bound_real <- merged_data_20_Mecillinam_NULL$mean_rel_ab.real + merged_data_20_Mecillinam_NULL$sd_rel_ab.real

# Ensure lower and upper bounds are non-negative, adjusting as necessary
merged_data_20_Mecillinam_NULL$lower_bound_null[merged_data_20_Mecillinam_NULL$lower_bound_null <= 0] <- 1e-10
merged_data_20_Mecillinam_NULL$lower_bound_real[merged_data_20_Mecillinam_NULL$lower_bound_real <= 0] <- 1e-10
merged_data_20_Mecillinam_NULL$upper_bound_null[merged_data_20_Mecillinam_NULL$upper_bound_null <= 0] <- 1e-10
merged_data_20_Mecillinam_NULL$upper_bound_real[merged_data_20_Mecillinam_NULL$upper_bound_real <= 0] <- 1e-10

# Filter to include only species with a mean relative abundance > 0.01 in the 'real' dataset
significant_species <- merged_data_20_Mecillinam[merged_data_20_Mecillinam$mean_rel_ab.real > 0.01, ]
survivors_20_Mecillinam <- nrow(significant_species)
survivors_20_Mecillinam

#should be the same as survivors defined above, since it is calculated from .real
significant_species_NULL <- merged_data_20_Mecillinam_NULL[merged_data_20_Mecillinam_NULL$mean_rel_ab.real > 0.01, ]
survivors_20_Mecillinam_NULL <- nrow(significant_species_NULL)
survivors_20_Mecillinam_NULL

# Adjusted order of magnitude check to include SD, only for significant species
significant_species$Predicted_magnitude_correct <- ifelse(
  (floor(log10(significant_species$lower_bound_pred)) <= floor(log10(significant_species$upper_bound_real)) &
     floor(log10(significant_species$upper_bound_pred)) >= floor(log10(significant_species$lower_bound_real))),
  1,
  0
)

#and for the Null model:
significant_species_NULL$Predicted_magnitude_correct <- ifelse(
  (floor(log10(significant_species_NULL$lower_bound_null)) <= floor(log10(significant_species_NULL$upper_bound_real)) &
     floor(log10(significant_species_NULL$upper_bound_null)) >= floor(log10(significant_species_NULL$lower_bound_real))),
  1,
  0
)

# Calculate the fraction of correctly predicted magnitudes for significant species
predicted_magnitude_correct_fraction_20_Mecillinam <- sum(significant_species$Predicted_magnitude_correct) / nrow(significant_species)
predicted_magnitude_correct_fraction_20_Mecillinam

predicted_magnitude_correct_fraction_20_Mecillinam_NULL <- sum(significant_species_NULL$Predicted_magnitude_correct) / nrow(significant_species_NULL)
predicted_magnitude_correct_fraction_20_Mecillinam_NULL

top_species_missing_20_Mecillinam <- setdiff(top6_real_20_Mecillinam_means, top6_predicted_20_Mecillinam_means)
top_species_wrong_20_Mecillinam <- setdiff(top6_predicted_20_Mecillinam_means, top6_real_20_Mecillinam_means)

Prediction_quality_20_Mecillinam <- data.frame(
  Top_six_correct = paste(top_six_correct_20_Mecillinam, sep=""),
  Top_six_correct_NULL = paste(top_six_correct_20_Mecillinam_NULL, sep=""),
  Top_six_correct_means = paste(top_six_correct_20_Mecillinam_means, sep=""),
  Top_six_correct_means_NULL = paste(top_six_correct_20_Mecillinam_means_NULL, sep=""),
  Predicted_magnitude_correct = paste(round(predicted_magnitude_correct_fraction_20_Mecillinam * 100, 2), "%", sep=""),
  Predicted_magnitude_correct_NULL = paste(round(predicted_magnitude_correct_fraction_20_Mecillinam_NULL * 100, 2), "%", sep=""),
  survivors_total = survivors_20_Mecillinam,
  top_species_missing <- top_species_missing_20_Mecillinam,
  top_species_wrong <- top_species_wrong_20_Mecillinam, 
  predicted_mean_final_OD <- predicted_mean_final_od_20_Mecillinam,
  real_mean_final_OD <- real_mean_final_od_20_Mecillinam,
  sims_total = length(successful_sim_ids)
)

Prediction_quality_20_Mecillinam






##Next, for 2.5uM:
# Get top 6 species from plot_data_2.5_endpoint
# Adjust the plot_data_2.5_endpoint with confidence bounds
plot_data_2.5_Mecillinam_endpoint <- plot_data_2.5_Mecillinam_endpoint %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)

# Adjust the Mecillinam_16S_2.5uM_summarised with confidence bounds
Mecillinam_16S_2.5uM_summarised <- Mecillinam_16S_2.5uM_summarised %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)

#NULL model:
Null_model_summarised <- Niclosamide_16S_0uM_summarised %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)


# Get top 6 species based on the lower bound from plot_data_2.5_endpoint
top6_predicted_2.5_Mecillinam <- plot_data_2.5_Mecillinam_endpoint %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

# Get top 6 species based on the lower bound from Mecillinam_16S_2.5uM_summarised
top6_real_2.5_Mecillinam <- Mecillinam_16S_2.5uM_summarised %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

top6_NULL <- Null_model_summarised %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

# Calculate the overlap of top 6 species
top_six_correct_2.5_Mecillinam <- length(intersect(top6_predicted_2.5_Mecillinam, top6_real_2.5_Mecillinam))
#top_six_correct_2.5_Mecillinam

top_six_correct_2.5_Mecillinam_NULL <- length(intersect(top6_NULL, top6_real_2.5_Mecillinam))
#top_six_correct_2.5_Mecillinam_NULL

#top6_predicted_2.5_Mecillinam
#top6_real_2.5_Mecillinam




#Now by means:
top6_predicted_2.5_Mecillinam_means <- plot_data_2.5_Mecillinam_endpoint %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)

# Get top 6 species based on the lower bound from Mecillinam_16S_2.5uM_summarised
top6_real_2.5_Mecillinam_means <- Mecillinam_16S_2.5uM_summarised %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)

top6_NULL_means <- Null_model_summarised %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)



top_six_correct_2.5_Mecillinam_means <- length(intersect(top6_predicted_2.5_Mecillinam_means, top6_real_2.5_Mecillinam_means))
#top_six_correct_2.5_Mecillinam_means

top_six_correct_2.5_Mecillinam_means_NULL <- length(intersect(top6_NULL_means, top6_real_2.5_Mecillinam_means))
#top_six_correct_2.5_Mecillinam_means_NULL

#top6_predicted_2.5_Mecillinam_means
#top6_real_2.5_Mecillinam_means




# Merge dataframes by Species
merged_data_2.5_Mecillinam <- merge(plot_data_2.5_Mecillinam_endpoint, Mecillinam_16S_2.5uM_summarised, by = "Species", suffixes = c(".pred", ".real"))
merged_data_2.5_Mecillinam_NULL <- merge(Niclosamide_16S_0uM_summarised, Mecillinam_16S_2.5uM_summarised, by = "Species", suffixes = c(".null", ".real"))



# Create lower and upper bounds considering mean ¬± sd
merged_data_2.5_Mecillinam$lower_bound_pred <- merged_data_2.5_Mecillinam$mean_rel_ab.pred - merged_data_2.5_Mecillinam$sd_rel_ab.pred
merged_data_2.5_Mecillinam$upper_bound_pred <- merged_data_2.5_Mecillinam$mean_rel_ab.pred + merged_data_2.5_Mecillinam$sd_rel_ab.pred
merged_data_2.5_Mecillinam$lower_bound_real <- merged_data_2.5_Mecillinam$mean_rel_ab.real - merged_data_2.5_Mecillinam$sd_rel_ab.real
merged_data_2.5_Mecillinam$upper_bound_real <- merged_data_2.5_Mecillinam$mean_rel_ab.real + merged_data_2.5_Mecillinam$sd_rel_ab.real

# Ensure lower and upper bounds are non-negative, adjusting as necessary
merged_data_2.5_Mecillinam$lower_bound_pred[merged_data_2.5_Mecillinam$lower_bound_pred <= 0] <- 1e-10
merged_data_2.5_Mecillinam$lower_bound_real[merged_data_2.5_Mecillinam$lower_bound_real <= 0] <- 1e-10
merged_data_2.5_Mecillinam$upper_bound_pred[merged_data_2.5_Mecillinam$upper_bound_pred <= 0] <- 1e-10
merged_data_2.5_Mecillinam$upper_bound_real[merged_data_2.5_Mecillinam$upper_bound_real <= 0] <- 1e-10

##and for NULL model:
# Create lower and upper bounds considering mean ¬± sd
merged_data_2.5_Mecillinam_NULL$lower_bound_null <- merged_data_2.5_Mecillinam_NULL$mean_rel_ab.null - merged_data_2.5_Mecillinam_NULL$sd_rel_ab.null
merged_data_2.5_Mecillinam_NULL$upper_bound_null <- merged_data_2.5_Mecillinam_NULL$mean_rel_ab.null + merged_data_2.5_Mecillinam_NULL$sd_rel_ab.null
merged_data_2.5_Mecillinam_NULL$lower_bound_real <- merged_data_2.5_Mecillinam_NULL$mean_rel_ab.real - merged_data_2.5_Mecillinam_NULL$sd_rel_ab.real
merged_data_2.5_Mecillinam_NULL$upper_bound_real <- merged_data_2.5_Mecillinam_NULL$mean_rel_ab.real + merged_data_2.5_Mecillinam_NULL$sd_rel_ab.real

# Ensure lower and upper bounds are non-negative, adjusting as necessary
merged_data_2.5_Mecillinam_NULL$lower_bound_null[merged_data_2.5_Mecillinam_NULL$lower_bound_null <= 0] <- 1e-10
merged_data_2.5_Mecillinam_NULL$lower_bound_real[merged_data_2.5_Mecillinam_NULL$lower_bound_real <= 0] <- 1e-10
merged_data_2.5_Mecillinam_NULL$upper_bound_null[merged_data_2.5_Mecillinam_NULL$upper_bound_null <= 0] <- 1e-10
merged_data_2.5_Mecillinam_NULL$upper_bound_real[merged_data_2.5_Mecillinam_NULL$upper_bound_real <= 0] <- 1e-10

# Filter to include only species with a mean relative abundance > 0.01 in the 'real' dataset
significant_species <- merged_data_2.5_Mecillinam[merged_data_2.5_Mecillinam$mean_rel_ab.real > 0.01, ]
survivors_2.5_Mecillinam <- nrow(significant_species)
survivors_2.5_Mecillinam

#should be the same as survivors defined above, since it is calculated from .real
significant_species_NULL <- merged_data_2.5_Mecillinam_NULL[merged_data_2.5_Mecillinam_NULL$mean_rel_ab.real > 0.01, ]
survivors_2.5_Mecillinam_NULL <- nrow(significant_species_NULL)
survivors_2.5_Mecillinam_NULL

# Adjusted order of magnitude check to include SD, only for significant species
significant_species$Predicted_magnitude_correct <- ifelse(
  (floor(log10(significant_species$lower_bound_pred)) <= floor(log10(significant_species$upper_bound_real)) &
     floor(log10(significant_species$upper_bound_pred)) >= floor(log10(significant_species$lower_bound_real))),
  1,
  0
)

#and for the Null model:
significant_species_NULL$Predicted_magnitude_correct <- ifelse(
  (floor(log10(significant_species_NULL$lower_bound_null)) <= floor(log10(significant_species_NULL$upper_bound_real)) &
     floor(log10(significant_species_NULL$upper_bound_null)) >= floor(log10(significant_species_NULL$lower_bound_real))),
  1,
  0
)

# Calculate the fraction of correctly predicted magnitudes for significant species
predicted_magnitude_correct_fraction_2.5_Mecillinam <- sum(significant_species$Predicted_magnitude_correct) / nrow(significant_species)
predicted_magnitude_correct_fraction_2.5_Mecillinam

predicted_magnitude_correct_fraction_2.5_Mecillinam_NULL <- sum(significant_species_NULL$Predicted_magnitude_correct) / nrow(significant_species_NULL)
predicted_magnitude_correct_fraction_2.5_Mecillinam_NULL


top_species_missing_2.5_Mecillinam <- setdiff(top6_real_2.5_Mecillinam_means, top6_predicted_2.5_Mecillinam_means)
top_species_wrong_2.5_Mecillinam <- setdiff(top6_predicted_2.5_Mecillinam_means, top6_real_2.5_Mecillinam_means)

Prediction_quality_2.5_Mecillinam <- data.frame(
  Top_six_correct = paste(top_six_correct_2.5_Mecillinam, sep=""),
  Top_six_correct_NULL = paste(top_six_correct_2.5_Mecillinam_NULL, sep=""),
  Top_six_correct_means = paste(top_six_correct_2.5_Mecillinam_means, sep=""),
  Top_six_correct_means_NULL = paste(top_six_correct_2.5_Mecillinam_means_NULL, sep=""),
  Predicted_magnitude_correct = paste(round(predicted_magnitude_correct_fraction_2.5_Mecillinam * 100, 2), "%", sep=""),
  Predicted_magnitude_correct_NULL = paste(round(predicted_magnitude_correct_fraction_2.5_Mecillinam_NULL * 100, 2), "%", sep=""),
  survivors_total = survivors_2.5_Mecillinam,
  top_species_missing <- top_species_missing_2.5_Mecillinam,
  top_species_wrong <- top_species_wrong_2.5_Mecillinam, 
  predicted_mean_final_OD <- predicted_mean_final_od_2.5_Mecillinam,
  real_mean_final_OD <- real_mean_final_od_2.5_Mecillinam,
  sims_total = length(successful_sim_ids)
)

Prediction_quality_2.5_Mecillinam











##Mefloquine

combined_monoculture_aucs2_Mefloquine <- subset(combined_monoculture_aucs2, drug == "Mefloquine")


#drug sensitivity terms: define once outside of ODEs
y_function_B_vulgatus_Mefloquine <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("B_vulgatus", "Mefloquine", best_fitting_models_df_Mefloquine)), collapse = " ")))
y_function_B_uniformis_Mefloquine <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("B_uniformis", "Mefloquine", best_fitting_models_df_Mefloquine)), collapse = " ")))
y_function_B_fragilis_Mefloquine <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("B_fragilis", "Mefloquine", best_fitting_models_df_Mefloquine)), collapse = " ")))
y_function_B_thetaiotaomicron_Mefloquine <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("B_thetaiotaomicron", "Mefloquine", best_fitting_models_df_Mefloquine)), collapse = " ")))
y_function_C_ramosum_Mefloquine <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("C_ramosum", "Mefloquine", best_fitting_models_df_Mefloquine)), collapse = " ")))
y_function_E_rectale_Mefloquine <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("E_rectale", "Mefloquine", best_fitting_models_df_Mefloquine)), collapse = " ")))
y_function_R_intestinalis_Mefloquine <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("R_intestinalis", "Mefloquine", best_fitting_models_df_Mefloquine)), collapse = " ")))
y_function_V_parvula_Mefloquine <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("V_parvula", "Mefloquine", best_fitting_models_df_Mefloquine)), collapse = " ")))
y_function_E_lenta_Mefloquine <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("E_lenta", "Mefloquine", best_fitting_models_df_Mefloquine)), collapse = " ")))
y_function_F_nucleatum_Mefloquine <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("F_nucleatum", "Mefloquine", best_fitting_models_df_Mefloquine)), collapse = " ")))
y_function_C_bolteae_Mefloquine <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("C_bolteae", "Mefloquine", best_fitting_models_df_Mefloquine)), collapse = " ")))
y_function_C_perfringens_Mefloquine <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("C_perfringens", "Mefloquine", best_fitting_models_df_Mefloquine)), collapse = " ")))
y_function_C_saccharolyticum_Mefloquine <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("C_saccharolyticum", "Mefloquine", best_fitting_models_df_Mefloquine)), collapse = " ")))
y_function_S_salivarius_Mefloquine <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("S_salivarius", "Mefloquine", best_fitting_models_df_Mefloquine)), collapse = " ")))
y_function_R_gnavus_Mefloquine <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("R_gnavus", "Mefloquine", best_fitting_models_df_Mefloquine)), collapse = " ")))
y_function_C_comes_Mefloquine <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("C_comes", "Mefloquine", best_fitting_models_df_Mefloquine)), collapse = " ")))
y_function_P_merdae_Mefloquine <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("P_merdae", "Mefloquine", best_fitting_models_df_Mefloquine)), collapse = " ")))
y_function_S_parasanguinis_Mefloquine <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("S_parasanguinis", "Mefloquine", best_fitting_models_df_Mefloquine)), collapse = " ")))
y_function_C_aerofaciens_Mefloquine <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("C_aerofaciens", "Mefloquine", best_fitting_models_df_Mefloquine)), collapse = " ")))
y_function_D_formicigenerans_Mefloquine <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("D_formicigenerans", "Mefloquine", best_fitting_models_df_Mefloquine)), collapse = " ")))
y_function_E_coli_Mefloquine <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("E_coli", "Mefloquine", best_fitting_models_df_Mefloquine)), collapse = " ")))



y_function_B_vulgatus_Mefloquine_func <- eval(parse(text = paste("function(Drug) {", y_function_B_vulgatus_Mefloquine, "}")))
y_function_B_uniformis_Mefloquine_func <- eval(parse(text = paste("function(Drug) {", y_function_B_uniformis_Mefloquine, "}")))
y_function_B_fragilis_Mefloquine_func <- eval(parse(text = paste("function(Drug) {", y_function_B_fragilis_Mefloquine, "}")))
y_function_B_thetaiotaomicron_Mefloquine_func <- eval(parse(text = paste("function(Drug) {", y_function_B_thetaiotaomicron_Mefloquine, "}")))
y_function_C_ramosum_Mefloquine_func <- eval(parse(text = paste("function(Drug) {", y_function_C_ramosum_Mefloquine, "}")))
y_function_E_rectale_Mefloquine_func <- eval(parse(text = paste("function(Drug) {", y_function_E_rectale_Mefloquine, "}")))
y_function_R_intestinalis_Mefloquine_func <- eval(parse(text = paste("function(Drug) {", y_function_R_intestinalis_Mefloquine, "}")))
y_function_E_lenta_Mefloquine_func <- eval(parse(text = paste("function(Drug) {", y_function_E_lenta_Mefloquine, "}")))
y_function_F_nucleatum_Mefloquine_func <- eval(parse(text = paste("function(Drug) {", y_function_F_nucleatum_Mefloquine, "}")))
y_function_C_bolteae_Mefloquine_func <- eval(parse(text = paste("function(Drug) {", y_function_C_bolteae_Mefloquine, "}")))
y_function_C_perfringens_Mefloquine_func <- eval(parse(text = paste("function(Drug) {", y_function_C_perfringens_Mefloquine, "}")))
y_function_C_saccharolyticum_Mefloquine_func <- eval(parse(text = paste("function(Drug) {", y_function_C_saccharolyticum_Mefloquine, "}")))
y_function_S_salivarius_Mefloquine_func <- eval(parse(text = paste("function(Drug) {", y_function_S_salivarius_Mefloquine, "}")))
y_function_R_gnavus_Mefloquine_func <- eval(parse(text = paste("function(Drug) {", y_function_R_gnavus_Mefloquine, "}")))
y_function_C_comes_Mefloquine_func <- eval(parse(text = paste("function(Drug) {", y_function_C_comes_Mefloquine, "}")))
y_function_P_merdae_Mefloquine_func <- eval(parse(text = paste("function(Drug) {", y_function_P_merdae_Mefloquine, "}")))
y_function_S_parasanguinis_Mefloquine_func <- eval(parse(text = paste("function(Drug) {", y_function_S_parasanguinis_Mefloquine, "}")))
y_function_C_aerofaciens_Mefloquine_func <- eval(parse(text = paste("function(Drug) {", y_function_C_aerofaciens_Mefloquine, "}")))
y_function_D_formicigenerans_Mefloquine_func <- eval(parse(text = paste("function(Drug) {", y_function_D_formicigenerans_Mefloquine, "}")))
y_function_E_coli_Mefloquine_func <- eval(parse(text = paste("function(Drug) {", y_function_E_coli_Mefloquine, "}")))
y_function_V_parvula_Mefloquine_func <- eval(parse(text = paste("function(Drug) {", y_function_V_parvula_Mefloquine, "}")))



unique(combined_monoculture_aucs2_Mefloquine$conc)
##dictate drug concentration tested for simulation cycle here:
#drug_concentration_tested <- 5 #if manually or:
drug_concentration_tested <- unique(combined_monoculture_aucs2_Mefloquine$conc)[1] 
initial_conditions <- rep(0.01/32, 32)
initial_conditions <- c(initial_conditions, drug_concentration_tested)


##drug effect fitted for species showing sensitivity in monoculture:
#unique(combined_monoculture_aucs2_Mefloquine$Species)

##for more simple linear fits
closed.sir.model_Mefloquine <- function (t, x, params) {
  ## first extract the state variables
  A_muciniphila <- x[1]
  B_adolescentis <- x[2]
  B_fragilis <- x[3]
  B_longum <- x[4]
  B_obeum <- x[5]
  B_thetaiotaomicron <- x[6]
  B_uniformis <- x[7]
  B_vulgatus <- x[8]
  B_wadsworthia <- x[9]
  C_aerofaciens <- x[10]
  C_bolteae <- x[11]
  C_comes <- x[12]
  C_perfringens <- x[13]
  C_ramosum <- x[14]
  C_saccharolyticum <- x[15]
  D_formicigenerans <- x[16]
  E_coli <- x[17]
  E_lenta <- x[18]
  E_rectale <- x[19]
  F_nucleatum <- x[20]
  L_paracasei <- x[21]
  O_splanchnicus <- x[22]
  P_copri <- x[23]
  P_distasonis <- x[24]
  P_merdae <- x[25]
  R_bromii <- x[26]
  R_gnavus <- x[27]
  R_intestinalis <- x[28]
  R_torques <- x[29]
  S_parasanguinis <- x[30]
  S_salivarius <- x[31]
  V_parvula <- x[32]
  Drug <- x[33]
  
  
  ## now extract the parameters
  r_B_fragilis <- flat_params[["B._fragilis.r"]]
  K_B_fragilis <- flat_params[["B._fragilis.K"]]
  r_B_longum <- flat_params[["B._longum.r"]]
  K_B_longum <- flat_params[["B._longum.K"]]
  r_B_thetaiotaomicron <- flat_params[["B._thetaiotaomicron.r"]]
  K_B_thetaiotaomicron <- flat_params[["B._thetaiotaomicron.K"]]
  r_B_uniformis <- flat_params[["B._uniformis.r"]]
  K_B_uniformis <- flat_params[["B._uniformis.K"]]
  r_B_vulgatus <- flat_params[["B._vulgatus.r"]]
  K_B_vulgatus <- flat_params[["B._vulgatus.K"]]
  r_B_wadsworthia <- flat_params[["B._wadsworthia.r"]]
  K_B_wadsworthia <- flat_params[["B._wadsworthia.K"]]
  r_C_aerofaciens <- flat_params[["C._aerofaciens.r"]]
  K_C_aerofaciens <- flat_params[["C._aerofaciens.K"]]
  r_C_bolteae <- flat_params[["C._bolteae.r"]]
  K_C_bolteae <- flat_params[["C._bolteae.K"]]
  r_C_comes <- flat_params[["C._comes.r"]]
  K_C_comes <- flat_params[["C._comes.K"]]
  r_C_perfringens <- flat_params[["C._perfringens.r"]]
  K_C_perfringens <- flat_params[["C._perfringens.K"]]
  r_C_ramosum <- flat_params[["C._ramosum.r"]]
  K_C_ramosum <- flat_params[["C._ramosum.K"]]
  r_C_saccharolyticum <- flat_params[["C._saccharolyticum.r"]]
  K_C_saccharolyticum <- flat_params[["C._saccharolyticum.K"]]
  r_D_formicigenerans <- flat_params[["D._formicigenerans.r"]]
  K_D_formicigenerans <- flat_params[["D._formicigenerans.K"]]
  r_E_coli <- flat_params[["E._coli.r"]]
  K_E_coli <- flat_params[["E._coli.K"]]
  r_E_lenta <- flat_params[["E._lenta.r"]]
  K_E_lenta <- flat_params[["E._lenta.K"]]
  r_E_rectale <- flat_params[["E._rectale.r"]]
  K_E_rectale <- flat_params[["E._rectale.K"]]
  r_F_nucleatum <- flat_params[["F._nucleatum.r"]]
  K_F_nucleatum <- flat_params[["F._nucleatum.K"]]
  r_P_copri <- flat_params[["P._copri.r"]]
  K_P_copri <- flat_params[["P._copri.K"]]
  r_P_merdae <- flat_params[["P._merdae.r"]]
  K_P_merdae <- flat_params[["P._merdae.K"]]
  r_R_gnavus <- flat_params[["R._gnavus.r"]]
  K_R_gnavus <- flat_params[["R._gnavus.K"]]
  r_R_intestinalis <- flat_params[["R._intestinalis.r"]]
  K_R_intestinalis <- flat_params[["R._intestinalis.K"]]
  r_V_parvula <- flat_params[["V._parvula.r"]]
  K_V_parvula <- flat_params[["V._parvula.K"]]
  r_A_muciniphila <- flat_params[["A._muciniphila.r"]]
  K_A_muciniphila <- flat_params[["A._muciniphila.K"]]
  r_B_adolescentis <- flat_params[["B._adolescentis.r"]]
  K_B_adolescentis <- flat_params[["B._adolescentis.K"]]
  r_B_obeum <- flat_params[["B._obeum.r"]]
  K_B_obeum <- flat_params[["B._obeum.K"]]
  r_O_splanchnicus <- flat_params[["O._splanchnicus.r"]]
  K_O_splanchnicus <- flat_params[["O._splanchnicus.K"]]
  r_P_distasonis <- flat_params[["P._distasonis.r"]]
  K_P_distasonis <- flat_params[["P._distasonis.K"]]
  r_R_bromii <- flat_params[["R._bromii.r"]]
  K_R_bromii <- flat_params[["R._bromii.K"]]
  r_R_torques <- flat_params[["R._torques.r"]]
  K_R_torques <- flat_params[["R._torques.K"]]
  r_S_parasanguinis <- flat_params[["S._parasanguinis.r"]]
  K_S_parasanguinis <-flat_params[["S._parasanguinis.K"]]
  r_S_salivarius <- flat_params[["S._salivarius.r"]]
  K_S_salivarius <- flat_params[["S._salivarius.K"]]
  r_L_paracasei <- flat_params[["L._paracasei.r"]]
  K_L_paracasei <- flat_params[["L._paracasei.K"]]
  
  
  t_mod <- ifelse(t > 24.1, t - 24.1, t)
  
  
  ## now code the model equations
  dA_muciniphila_dt <- r_A_muciniphila * A_muciniphila * (1 - A_muciniphila / K_A_muciniphila)
  dB_adolescentis_dt <- r_B_adolescentis * B_adolescentis * (1 - B_adolescentis / K_B_adolescentis)
  dB_fragilis_dt <- r_B_fragilis * B_fragilis * (1 - B_fragilis / max(0.0001, K_B_fragilis * (y_function_B_fragilis_Mefloquine_func(Drug))))
  dB_longum_dt <- r_B_longum * B_longum * (1 - B_longum / K_B_longum)
  dB_obeum_dt <- r_B_obeum * B_obeum * (1 - B_obeum / K_B_obeum)
  dB_thetaiotaomicron_dt <- r_B_thetaiotaomicron * B_thetaiotaomicron * (1 - B_thetaiotaomicron / max(0.0001, K_B_thetaiotaomicron * (y_function_B_thetaiotaomicron_Mefloquine_func(Drug))))  
  dB_uniformis_dt <- r_B_uniformis * B_uniformis * (1 - B_uniformis / max(0.0001, K_B_uniformis * (y_function_B_uniformis_Mefloquine_func(Drug))))
  dB_vulgatus_dt <- r_B_vulgatus * B_vulgatus * (1 - B_vulgatus / max(0.0001, K_B_vulgatus * (y_function_B_vulgatus_Mefloquine_func(Drug))))
  dB_wadsworthia_dt <- r_B_wadsworthia * B_wadsworthia * (1 - B_wadsworthia / K_B_wadsworthia)
  dC_aerofaciens_dt <- r_C_aerofaciens * C_aerofaciens * (1 - C_aerofaciens / max(0.0001, K_C_aerofaciens * (y_function_C_aerofaciens_Mefloquine_func(Drug))))
  dC_bolteae_dt <- r_C_bolteae * C_bolteae * (1 - C_bolteae /  max(0.0001, K_C_bolteae * (y_function_C_bolteae_Mefloquine_func(Drug))))
  dC_comes_dt <- r_C_comes * C_comes * (1 - C_comes / max(0.0001, K_C_comes * (y_function_C_comes_Mefloquine_func(Drug))))
  dC_perfringens_dt <- r_C_perfringens * C_perfringens * (1 - C_perfringens / max(0.0001, K_C_perfringens * (y_function_C_perfringens_Mefloquine_func(Drug))))
  dC_ramosum_dt <- r_C_ramosum * C_ramosum * (1 - C_ramosum / max(0.0001, K_C_ramosum * (y_function_C_ramosum_Mefloquine_func(Drug))))
  dC_saccharolyticum_dt <- r_C_saccharolyticum * C_saccharolyticum * (1 - C_saccharolyticum / max(0.0001, K_C_saccharolyticum * (y_function_C_saccharolyticum_Mefloquine_func(Drug))))
  dD_formicigenerans_dt <- r_D_formicigenerans * D_formicigenerans * (1 - D_formicigenerans / max(0.0001, K_D_formicigenerans * (y_function_D_formicigenerans_Mefloquine_func(Drug))))
  dE_coli_dt <- r_E_coli * E_coli * (1 - E_coli / max(0.0001, K_E_coli * (y_function_E_coli_Mefloquine_func(Drug))))
  dE_lenta_dt <- r_E_lenta * E_lenta * (1 - E_lenta / max(0.0001, K_E_lenta * (y_function_E_lenta_Mefloquine_func(Drug))))
  dE_rectale_dt <- r_E_rectale * E_rectale * (1 - E_rectale / max(0.0001, K_E_rectale * (y_function_E_rectale_Mefloquine_func(Drug))))
  dF_nucleatum_dt <- r_F_nucleatum * F_nucleatum * (1 - F_nucleatum / max(0.0001, K_F_nucleatum * (y_function_F_nucleatum_Mefloquine_func(Drug))))
  dL_paracasei_dt <- r_L_paracasei * L_paracasei * (1 - L_paracasei / K_L_paracasei)  
  dO_splanchnicus_dt <- r_O_splanchnicus * O_splanchnicus * (1 - O_splanchnicus / K_O_splanchnicus)  
  dP_copri_dt <- r_P_copri * P_copri * (1 - P_copri / K_P_copri)
  dP_distasonis_dt <- r_P_distasonis * P_distasonis * (1 - P_distasonis / K_P_distasonis)  
  dP_merdae_dt <- r_P_merdae * P_merdae * (1 - P_merdae / max(0.0001, K_P_merdae * (y_function_P_merdae_Mefloquine_func(Drug))))
  dR_bromii_dt <- r_R_bromii * R_bromii * (1 - R_bromii / K_R_bromii) 
  dR_gnavus_dt <- r_R_gnavus * R_gnavus * (1 - R_gnavus / max(0.0001, K_R_gnavus * (y_function_R_gnavus_Mefloquine_func(Drug))))
  dR_intestinalis_dt <- r_R_intestinalis * R_intestinalis * (1 - R_intestinalis / max(0.0001, K_R_intestinalis * (y_function_R_intestinalis_Mefloquine_func(Drug))))
  dR_torques_dt <- r_R_torques * R_torques * (1 - R_torques /K_R_torques) 
  dS_parasanguinis_dt <- r_S_parasanguinis * S_parasanguinis * (1 - S_parasanguinis / max(0.0001, K_S_parasanguinis * (y_function_S_parasanguinis_Mefloquine_func(Drug))))
  dS_salivarius_dt <- r_S_salivarius * S_salivarius * (1 - S_salivarius / max(0.0001, K_S_salivarius * (y_function_S_salivarius_Mefloquine_func(Drug))))
  dV_parvula_dt <- r_V_parvula * V_parvula * (1 - V_parvula / max(0.0001, K_V_parvula * (y_function_V_parvula_Mefloquine_func(Drug))))
  
  
  
  #Drug differential:
  dDrug_dt <- (subset(drug_dynamics, Drug == "Mefloquine")$Steepness_param_community * exp(-subset(drug_dynamics, Drug == "Mefloquine")$Steepness_param_community * t_mod)) * (drug_concentration_tested * prop_left_Mefloquine - drug_concentration_tested)
  #dDrug_dt <- 0
  
  ## Combine results into a single vector
  dxdt <- c(dA_muciniphila_dt, dB_adolescentis_dt, dB_fragilis_dt, dB_longum_dt, dB_obeum_dt, dB_thetaiotaomicron_dt, dB_uniformis_dt, dB_vulgatus_dt, dB_wadsworthia_dt, dC_aerofaciens_dt, dC_bolteae_dt, dC_comes_dt, dC_perfringens_dt, dC_ramosum_dt, dC_saccharolyticum_dt, dD_formicigenerans_dt, dE_coli_dt, dE_lenta_dt, dE_rectale_dt, dF_nucleatum_dt, dL_paracasei_dt, dO_splanchnicus_dt, dP_copri_dt, dP_distasonis_dt, dP_merdae_dt, dR_bromii_dt, dR_gnavus_dt, dR_intestinalis_dt, dR_torques_dt, dS_parasanguinis_dt, dS_salivarius_dt, dV_parvula_dt, dDrug_dt)
  
  ## Return result as a list
  list(dxdt)
}




#calculate the co-culture correction factor per species based on community composition in absence of drug, just like done for Niclosamide

growth_data_all_0_Niclosamide
growth_data_all_0_Niclosamide1 <- growth_data_all_0_Niclosamide %>%
  dplyr::mutate(Species = gsub(" ", "_", Species))


# Merge rel_ab_control with growth_data_all_0_Niclosamide on Species
# Function to remove duplicated columns by name pattern
clean_columns_base <- function(df, pattern) {
  cols_to_keep <- !grepl(pattern, names(df))
  df <- df[, cols_to_keep]
  return(df)
}

# Use the new function to clean up your dataframe
rel_ab_control <- clean_columns_base(rel_ab_control, "mean_max_OD.[xy]")
str(rel_ab_control)


#rel_ab_control$correction_factor <- rel_ab_control$mean_rel_ab / (rel_ab_control$mean_max_OD/sum(rel_ab_control$mean_max_OD))
# Calculate correction factor with a minimum value of ~1
rel_ab_control$correction_factor <- pmax(rel_ab_control$mean_rel_ab / (rel_ab_control$mean_max_OD / sum(rel_ab_control$mean_max_OD)), 1.1)


# Create a new dataframe for co-culture correction
co_culture_correction <- data.frame(
  species = rel_ab_control$Species,
  correction_factor = rel_ab_control$correction_factor
)


#summarise community data
#Adjust based on tested concentrations for each drug
unique(Community_compositions_focus_drugs_Mefloquine$concentration)

Community_compositions_focus_drugs_Mefloquine_5uM <- subset(Community_compositions_focus_drugs_Mefloquine, concentration == 5)
Community_compositions_focus_drugs_Mefloquine_20uM <- subset(Community_compositions_focus_drugs_Mefloquine, concentration == 20)
Community_compositions_focus_drugs_Mefloquine_60uM <- subset(Community_compositions_focus_drugs_Mefloquine, concentration == 60)


#5 uM
Community_compositions_focus_drugs_Mefloquine_5uM_summarised <- Community_compositions_focus_drugs_Mefloquine_5uM %>%
  dplyr::group_by(species) %>%                                  
  dplyr::summarize(
    mean_rel_ab = mean(rel_abundance, na.rm = TRUE),     
    sd_rel_ab = sd(rel_abundance, na.rm = TRUE) ,
    mean_max_OD = mean(maxOD, na.rm = TRUE),
    sd_max_OD = sd(maxOD, na.rm = TRUE),
    mean_final_OD = mean(finalOD, na.rm = TRUE),
    sd_final_OD = sd(finalOD, na.rm = TRUE)
  ) %>%
  dplyr::ungroup() 


Community_compositions_focus_drugs_Mefloquine_5uM_summarised <- Community_compositions_focus_drugs_Mefloquine_5uM_summarised %>%
  dplyr::mutate(Species = sub("^(\\w)\\w*\\s(.*)", "\\1._\\2", species))

#remove (sub)strain info
Community_compositions_focus_drugs_Mefloquine_5uM_summarised <- Community_compositions_focus_drugs_Mefloquine_5uM_summarised %>%
  dplyr::mutate(Species = sub("^(\\w\\._\\w+).*", "\\1", Species))


#20 uM
Community_compositions_focus_drugs_Mefloquine_20uM_summarised <- Community_compositions_focus_drugs_Mefloquine_20uM %>%
  dplyr::group_by(species) %>%                                  
  dplyr::summarize(
    mean_rel_ab = mean(rel_abundance, na.rm = TRUE),     
    sd_rel_ab = sd(rel_abundance, na.rm = TRUE) ,
    mean_max_OD = mean(maxOD, na.rm = TRUE),
    sd_max_OD = sd(maxOD, na.rm = TRUE),
    mean_final_OD = mean(finalOD, na.rm = TRUE),
    sd_final_OD = sd(finalOD, na.rm = TRUE)
  ) %>%
  dplyr::ungroup() 


Community_compositions_focus_drugs_Mefloquine_20uM_summarised <- Community_compositions_focus_drugs_Mefloquine_20uM_summarised %>%
  dplyr::mutate(Species = sub("^(\\w)\\w*\\s(.*)", "\\1._\\2", species))

#remove (sub)strain info
Community_compositions_focus_drugs_Mefloquine_20uM_summarised <- Community_compositions_focus_drugs_Mefloquine_20uM_summarised %>%
  dplyr::mutate(Species = sub("^(\\w\\._\\w+).*", "\\1", Species))


#60 uM
Community_compositions_focus_drugs_Mefloquine_60uM_summarised <- Community_compositions_focus_drugs_Mefloquine_60uM %>%
  dplyr::group_by(species) %>%                                  
  dplyr::summarize(
    mean_rel_ab = mean(rel_abundance, na.rm = TRUE),     
    sd_rel_ab = sd(rel_abundance, na.rm = TRUE) ,
    mean_max_OD = mean(maxOD, na.rm = TRUE),
    sd_max_OD = sd(maxOD, na.rm = TRUE),    
    mean_final_OD = mean(finalOD, na.rm = TRUE),
    sd_final_OD = sd(finalOD, na.rm = TRUE)
  ) %>%
  dplyr::ungroup() 



Community_compositions_focus_drugs_Mefloquine_60uM_summarised <- Community_compositions_focus_drugs_Mefloquine_60uM_summarised %>%
  dplyr::mutate(Species = sub("^(\\w)\\w*\\s(.*)", "\\1._\\2", species))

#remove (sub)strain info
Community_compositions_focus_drugs_Mefloquine_60uM_summarised <- Community_compositions_focus_drugs_Mefloquine_60uM_summarised %>%
  dplyr::mutate(Species = sub("^(\\w\\._\\w+).*", "\\1", Species))


#Initialise data frames
sim_output <- data.frame()
input_params_list <- list() #Use a list to collect parameters for each simulation

#number of simulations
num_sims <- 250


for (i in 1:num_sims) {
  tryCatch({
    # generate model parameters
    set.seed(i) #set a different seed for each simulation for variation
    params <- lapply(1:nrow(growth_data_all_0_Niclosamide), function(idx) {
      species_params <- growth_data_all_0_Niclosamide[idx, ]
      list(
        r = rnorm(1, mean = species_params$mean_max_Growth_rate, sd = species_params$sd_max_Growth_rate),
        K = rnorm(1, mean = species_params$mean_max_OD, sd = species_params$sd_max_OD)
      )
    })
    names(params) <- gsub(" ", "_", growth_data_all_0_Niclosamide$Species)
    flat_params <- unlist(params)
    names(flat_params) <- gsub("\\.\\d$", "", names(flat_params))
    
    #replace spaces with underscores to match formatting
    co_culture_correction$species <- gsub(" ", "_", co_culture_correction$species, fixed = TRUE)
    
    #replace the species-specific K parameters extracted from monoculture growth data 
    #with drawn relative abundance values at Niclosamide = 0, scaled to K
    rel_ab_control$Species <- gsub(" ", "_", rel_ab_control$Species)
    
    #Initialise an empty vector to store drawn values
    drawn_values <- numeric(nrow(rel_ab_control))
    
    #draw values from their respective distributions
    for (k in 1:nrow(rel_ab_control)) {
      species_name <- rel_ab_control$Species[k]
      drawn_value <- rnorm(1, mean = rel_ab_control$mean_rel_ab[k], sd = rel_ab_control$sd_rel_ab[k])
      drawn_values[k] <- max(drawn_value, 0)  # Ensure no negative values
    }
    
    #Normalise drawn relative abundance values so they sum to 1 (to reflect a 'true' relative abundance distribution)
    #this is needed so when we convert the values into OD units by multiplying with the drawn community maxOD,
    # the sum of K_i parameters and the drawn K are equal
    normalised_values <- drawn_values / sum(drawn_values)
    
    #Pull community maxOD (K) at 0 drugs from respective normal distribution:
    K <- rnorm(n = 1, mean = rel_ab_control$mean_com_max_OD[1], sd = rel_ab_control$sd_com_max_OD[1])
    
    # Assign these normalised values to their respective species' .K parameters
    for (k in 1:nrow(rel_ab_control)) {
      species_name <- rel_ab_control$Species[k]
      k_index <- grep(paste0("^", species_name, "\\.K$"), names(flat_params))
      
      if (length(k_index) > 0) {
        old_value <- flat_params[k_index]
        flat_params[k_index] <- (normalised_values[k] + 0.0001) * K #add small value in case drawn K_i is 0, which would cause issues with the solver
        cat(sprintf("Updated %s from %f to %f using normalised value %f scaled by K %f\n", names(flat_params)[k_index], old_value, flat_params[k_index], normalised_values[k], K))
      }
    }
    
    #Accounting for variation in drug degradation by community, with standard deviation of end concentration (at 10h) around the fitted predicted (relative) end concentration at 24h
    #prop_left_Mefloquine <- abs(rnorm(1, (subset(drug_dynamics, Drug == "Mefloquine")$Prop_left_24h_community), (subset(drug_dynamics, Drug == "Mefloquine")$SD_drug_community))) 
    #below, we account for measurement error rather than ecological drivers that lead to the variability of degradation at the final point measured 
    prop_left_Mefloquine <- abs(rnorm(
      n = 1, 
      mean = subset(drug_dynamics, Drug == "Mefloquine")$Prop_left_24h_community, 
      sd = ifelse(
        subset(drug_dynamics, Drug == "Mefloquine")$SD_drug_community > subset(drug_dynamics, Drug == "Mefloquine")$SD_drug_community_start, 
        subset(drug_dynamics, Drug == "Mefloquine")$SD_drug_community - subset(drug_dynamics, Drug == "Mefloquine")$SD_drug_community_start, 
        subset(drug_dynamics, Drug == "Mefloquine")$SD_drug_community
      )
    ))
    
    
    #loop through each species in co_culture_correction
    for (j in 1:nrow(co_culture_correction)) {
      # Extract the species name and correction factor
      species_name <- co_culture_correction$species[j]
      correction_factor <- co_culture_correction$correction_factor[j]
      
      # Identify the corresponding growth rate parameter in flat_params
      #by matching the base species name (without .r)
      growth_rate_indices <- grep(paste0("^", species_name, "\\.r$"), names(flat_params))
      
      #take the growth rate parameter and apply the correction factor 
      for (index in growth_rate_indices) {
        flat_params[index] <- flat_params[index] * correction_factor
      }
    }
    
    flat_params
    # Store parameters for each simulation
    input_params_list[[i]] <- c(sim_ID = i, flat_params)
    
    # Run the model for the first 24-hour cycle
    solution_cycle_1 <- ode(y = initial_conditions, times = seq(from = 0, to = 24, by = 0.1), func = closed.sir.model_Mefloquine, parms = flat_params,   method = "lsoda", rtol = 1e-6, atol = 1e-6)
    
    # Dilution and second cycle
    end_of_cycle_1 <- solution_cycle_1[nrow(solution_cycle_1), -1]
    initial_conditions_cycle_2 <- end_of_cycle_1 / 50
    #accounting for the drugs being added with the new growth cycle as well:
    initial_conditions_cycle_2[33] <- initial_conditions_cycle_2[33] + drug_concentration_tested
    solution_cycle_2 <- ode(y = initial_conditions_cycle_2, times = seq(from = 24, to = 48, by = 0.1), func = closed.sir.model_Mefloquine, parms = flat_params,  method = "lsoda", rtol = 1e-6, atol = 1e-6)
    
    # Combine and format results
    combined_solution <- rbind(as.data.frame(solution_cycle_1), as.data.frame(solution_cycle_2)[-1,])
    combined_solution$sim_ID <- rep(i, nrow(combined_solution))
    combined_solution <- combined_solution %>%
      tidyr::gather(key = "Species", value = "Density", -time, -sim_ID) %>%
      dplyr::mutate(Hour = time) %>%
      dplyr::select(sim_ID, Hour, Species, Density)
    
    ##Append to sim_output
    sim_output <- rbind(sim_output, combined_solution)
  }, error = function(e) {
    cat(sprintf("Skipping simulation %d due to an error: %s\n", i, e$message))
  })
}



##Combine all parameter data into a single dataframe
input_params <- do.call(rbind, input_params_list)

# Add a "Species" column 
sim_output$Species_name <- species_names[as.numeric(as.character(sim_output$Species))]
sim_output$Species_name <- replace_na(sim_output$Species_name, "Drug")

#View(input_params)
#View(sim_output)

sim_output <- na.omit(sim_output)
successful_sim_ids <- unique(subset(sim_output, Hour == 48)$sim_ID)
length(successful_sim_ids)
sim_output1 <- sim_output[sim_output$sim_ID %in% successful_sim_ids, ]


#Transform sim_output so we have wide format by Species
sim_output_wide <- tidyr::pivot_wider(sim_output1, 
                                      names_from = Species_name, 
                                      values_from = Density,
                                      id_cols = c(sim_ID, Hour))

length(unique(sim_output_wide$sim_ID))
#calc community OD per timepoint
sim_output_wide$Total_OD <- rowSums(sim_output_wide[, 3:34], na.rm = TRUE)
#calculate and add relative abundances here as well:
species_columns <- colnames(sim_output_wide)[3:34] 

for (species in species_columns) {
  sim_output_wide[[paste0("rel_", species)]] <- sim_output_wide[[species]] / sim_output_wide$Total_OD
}


#assign sim_output_wide test conditions to dataframe name
drug_tested <- "Mefloquine"
variable_name_1 <- paste0("sim_output_wide_", ifelse(drug_concentration_tested == 1e-04, 0, drug_concentration_tested), "_", drug_tested)
assign(variable_name_1, sim_output_wide)

#turn back into long format if interested in plotting relative abundances
cols_needed <- c("sim_ID", "Hour")

sim_output_long <- sim_output_wide %>% 
  dplyr::select(sim_ID, Hour, Drug, starts_with("rel_")) %>% 
  tidyr::pivot_longer(
    cols = c(Drug, starts_with("rel_")),
    names_to = "Species", 
    values_to = "Relative_abundance",
    names_prefix = "rel_",
    names_transform = list(Species = ~ ifelse(.x == "Drug", "Drug", .x))
  ) 

str(sim_output_long)


species_names_1 <- c(
  "A_muciniphila",
  "B_adolescentis",
  "B_fragilis",
  "B_longum",
  "B_obeum",
  "B_thetaiotaomicron",
  "B_uniformis",
  "B_vulgatus",
  "B_wadsworthia",
  "C_aerofaciens",
  "C_bolteae",
  "C_comes",
  "C_perfringens",
  "C_ramosum",
  "C_saccharolyticum",
  "D_formicigenerans",
  "E_coli",
  "E_lenta",
  "E_rectale",
  "F_nucleatum",
  "L_paracasei",
  "O_splanchnicus",
  "P_copri",
  "P_distasonis",
  "P_merdae",
  "R_bromii",
  "R_gnavus",
  "R_intestinalis",
  "R_torques",
  "S_parasanguinis",
  "S_salivarius",
  "V_parvula",
  "Drug"
)

species_colours_1 <- c(
  "A_muciniphila" = "#1f77b4",
  "B_adolescentis" = "#ff7f0e",
  "B_fragilis" = "#2ca02c",
  "B_longum" = "#d62728",
  "B_obeum" = "#9467bd",
  "B_thetaiotaomicron" = "black",
  "B_uniformis" = "#e377c2",
  "B_vulgatus" = "#7f7f7f",
  "B_wadsworthia" = "gold1",
  "C_aerofaciens" = "#aec7e8",
  "C_bolteae" = "#ffbb78",
  "C_comes" = "magenta",
  "C_perfringens" = "#ff9896",
  "C_ramosum" = "#c5b0d5",
  "C_saccharolyticum" = "#c49c94",
  "D_formicigenerans" = "#f7b6d2",
  "E_coli" = "yellow",
  "E_lenta" = "turquoise",
  "E_rectale" = "#393b79",
  "F_nucleatum" = "royalblue2",
  "L_paracasei" = "blue",
  "O_splanchnicus" = "#637939",
  "P_copri" = "cyan",
  "P_distasonis" = "#8c6d31",
  "P_merdae" = "#c7c7c7",
  "R_bromii" = "#e6550d",
  "R_gnavus" = "#e7cb94",
  "R_intestinalis" = "#843c39",
  "R_torques" = "#d6616b",
  "S_parasanguinis" = "orange3",
  "S_salivarius" = "#7b4173",
  "V_parvula" = "#ce6dbd",
  "Drug" = "green"
)



##Plot output for any specific sim:
# ggplot(subset(sim_output, sim_ID == 1 & Species_name != "Drug"), aes(x = Hour, y = Density, group = Species_name, color = Species_name)) +
#   geom_line(size = 1, alpha = 0.7) +
#   scale_color_manual(values = species_colours_1) +
#   labs(title = paste0("Mefloquine = ", drug_concentration_tested),
#        x = "Time (hours)",
#        y = "Population Density (OD)",
#        color = "Species") +
#   theme_minimal() +
#   theme(legend.position = "right")
# 
# ggplot(subset(sim_output, sim_ID == 3 & Species_name != "Drug"), aes(x = Hour, y = Density, group = Species_name, color = Species_name)) +
#   geom_line(size = 1, alpha = 0.7) +
#   scale_color_manual(values = species_colours_1) +
#   labs(title = paste0("Mefloquine = ", drug_concentration_tested),
#        x = "Time (hours)",
#        y = "Population Density (OD)",
#        color = "Species") +
#   theme_minimal() +
#   theme(legend.position = "right")


ggplot(subset(sim_output_long, sim_ID == 1), aes(x = Hour, y = Relative_abundance, group = Species, color = Species)) +
  geom_line(size = 1, alpha = 0.7) +
  scale_color_manual(values = species_colours_1) +
  labs(title = paste0("Mefloquine = ", drug_concentration_tested),
       x = "Time (hours)",
       y = "Relative abundance",
       color = "Species") +
  theme_minimal() +
  theme(legend.position = "right")


ggplot(subset(sim_output_long, sim_ID == 3), aes(x = Hour, y = Relative_abundance, group = Species, color = Species)) +
  geom_line(size = 1, alpha = 0.7) +
  scale_color_manual(values = species_colours_1) +
  labs(title = paste0("Mefloquine = ", drug_concentration_tested),
       x = "Time (hours)",
       y = "Relative abundance",
       color = "Species") +
  theme_minimal() +
  theme(legend.position = "right")


#calc mean and standard deviation across sims
sim_stats <- sim_output_long %>%
  dplyr::group_by(Hour, Species) %>%
  dplyr::summarise(
    mean_rel_ab = mean(Relative_abundance),
    sd_rel_ab = sd(Relative_abundance),
    .groups = 'drop'
  )

# Prepare the data for plotting
plot_data <- sim_stats %>%
  dplyr::mutate(Upper = mean_rel_ab + sd_rel_ab, Lower = mean_rel_ab - sd_rel_ab)

ggplot(subset(plot_data, Species != "Drug"), aes(x = Hour, y = mean_rel_ab, group = Species, color = Species)) +
  geom_ribbon(aes(ymin = Lower, ymax = Upper, fill = Species), colour = NA, alpha = 0.2) +  
  geom_line(size = 1, alpha = 0.7) + 
  scale_color_manual(values = species_colours_1) +
  scale_fill_manual(values = species_colours_1) +  
  labs(title = "Mean and SD of Relative Abundance Across Simulations",
       subtitle = paste0("Mefloquine = ", drug_concentration_tested),       
       x = "Time (hours)",
       y = "Relative abundance",
       color = "Species",
       fill = "Species") +
  theme_minimal() +
  theme(legend.position = "right")

#log-scaled mean trends
ggplot(plot_data, aes(x = Hour, y = log10(mean_rel_ab + 0.0001), group = Species, color = Species)) +
  geom_line(size = 1, alpha = 0.7) +  # Mean line
  scale_color_manual(values = species_colours_1) +
  scale_fill_manual(values = species_colours_1) +  # Ensure consistent colors for lines and fills
  labs(title = "Mean and SD of Relative Abundance Across Simulations",
       subtitle = paste0("Mefloquine = ", drug_concentration_tested),
       x = "Time (hours)",
       y = "Relative abundance",
       color = "Species",
       fill = "Species") +
  theme_minimal() +
  theme(legend.position = "right")




##prediction quality evaluation
drug_tested <- "Mefloquine"
variable_name <- paste0("plot_data_", ifelse(drug_concentration_tested == 1e-04, 0, drug_concentration_tested), "_", drug_tested)
assign(variable_name, plot_data)


#extract total OD info:
predicted_mean_final_od_NULL <- Niclosamide_16S_0uM_summarised$mean_com_final_OD[1]
predicted_sd_final_od_NULL <- Niclosamide_16S_0uM_summarised$sd_com_final_OD[1]

predicted_mean_final_od_5_Mefloquine <- mean(subset(sim_output_wide_5_Mefloquine, Hour == 48)$Total_OD, na.rm = TRUE)
predicted_sd_final_od_5_Mefloquine <- sd(subset(sim_output_wide_5_Mefloquine, Hour == 48)$Total_OD, na.rm = TRUE)

real_mean_final_od_5_Mefloquine <- Community_compositions_focus_drugs_Mefloquine_5uM_summarised$mean_final_OD[1]
real_sd_final_od_5_Mefloquine <- Community_compositions_focus_drugs_Mefloquine_5uM_summarised$sd_final_OD[1]


predicted_mean_final_od_20_Mefloquine <- mean(subset(sim_output_wide_20_Mefloquine, Hour == 48)$Total_OD, na.rm = TRUE)
predicted_sd_final_od_20_Mefloquine <- sd(subset(sim_output_wide_20_Mefloquine, Hour == 48)$Total_OD, na.rm = TRUE)

real_mean_final_od_20_Mefloquine <- Community_compositions_focus_drugs_Mefloquine_20uM_summarised$mean_final_OD[1]
real_sd_final_od_20_Mefloquine <- Community_compositions_focus_drugs_Mefloquine_20uM_summarised$sd_final_OD[1]


predicted_mean_final_od_60_Mefloquine <- mean(subset(sim_output_wide_60_Mefloquine, Hour == 48)$Total_OD, na.rm = TRUE)
predicted_sd_final_od_60_Mefloquine <- sd(subset(sim_output_wide_60_Mefloquine, Hour == 48)$Total_OD, na.rm = TRUE)

real_mean_final_od_60_Mefloquine <- Community_compositions_focus_drugs_Mefloquine_60uM_summarised$mean_final_OD[1]
real_sd_final_od_60_Mefloquine <- Community_compositions_focus_drugs_Mefloquine_60uM_summarised$sd_final_OD[1]




#plot_data_0_Mefloquine_endpoint was used to test model performance at 0 drugs
#plot_data_0_Mefloquine_endpoint <- subset(plot_data_0_Mefloquine, Hour == 48 & Species != "Drug")
plot_data_5_Mefloquine_endpoint <- subset(plot_data_5_Mefloquine, Hour == 48 & Species != "Drug")
plot_data_20_Mefloquine_endpoint <- subset(plot_data_20_Mefloquine, Hour == 48 & Species != "Drug")
plot_data_60_Mefloquine_endpoint <- subset(plot_data_60_Mefloquine, Hour == 48 & Species != "Drug")

##Inspecting 'match' to real relative abundance distributions:
Niclosamide_16S_0uM_summarised <- rel_ab_control
Niclosamide_16S_0uM_summarised$Species <- gsub("\\.", "", Niclosamide_16S_0uM_summarised$Species)

Mefloquine_16S_5uM_summarised <- Community_compositions_focus_drugs_Mefloquine_5uM_summarised
Mefloquine_16S_20uM_summarised <- Community_compositions_focus_drugs_Mefloquine_20uM_summarised
Mefloquine_16S_60uM_summarised <- Community_compositions_focus_drugs_Mefloquine_60uM_summarised

Niclosamide_16S_0uM_summarised
Mefloquine_16S_5uM_summarised 
Mefloquine_16S_20uM_summarised 
Mefloquine_16S_60uM_summarised 

#Rename 'species' so the outputs become comparable
original_names_60 <- unique(Mefloquine_16S_60uM_summarised$species)
original_names_20 <- unique(Mefloquine_16S_20uM_summarised$species)
original_names_5 <- unique(Mefloquine_16S_5uM_summarised$species)


##Create a named vector with the original and new names mapping
name_changes <- c(
  "Akkermansia muciniphila" = "A_muciniphila",
  "Bacteroides fragilis" = "B_fragilis",
  "Bacteroides thetaiotaomicron" = "B_thetaiotaomicron",
  "Bacteroides uniformis" = "B_uniformis",
  "Bifidobacterium adolescentis" = "B_adolescentis",
  "Bifidobacterium longum subsp. longum" = "B_longum",
  "Bilophila wadsworthia" = "B_wadsworthia",
  "Blautia obeum" = "B_obeum",
  "Clostridium perfringens" = "C_perfringens",
  "Collinsella aerofaciens" = "C_aerofaciens",
  "Coprococcus comes" = "C_comes",
  "Dorea formicigenerans" = "D_formicigenerans",
  "Eggerthella lenta" = "E_lenta",
  "Enterocloster bolteae" = "C_bolteae",
  "Erysipelatoclostridium ramosum" = "C_ramosum",
  "Escherichia coli ED1a" = "E_coli",
  "Eubacterium rectale" = "E_rectale",
  "Fusobacterium nucleatum subsp. nucleatum" = "F_nucleatum",
  "Lacrimispora saccharolytica" = "C_saccharolyticum",
  "Lacticaseibacillus paracasei" = "L_paracasei",
  "Odoribacter splanchnicus" = "O_splanchnicus",
  "Parabacteroides distasonis" = "P_distasonis",
  "Parabacteroides merdae" = "P_merdae",
  "Phocaeicola vulgatus" = "B_vulgatus",
  "Prevotella copri" = "P_copri",
  "Roseburia intestinalis" = "R_intestinalis",
  "Ruminococcus bromii" = "R_bromii",
  "Ruminococcus gnavus" = "R_gnavus",
  "Ruminococcus torques" = "R_torques",
  "Streptococcus parasanguinis" = "S_parasanguinis",
  "Streptococcus salivarius" = "S_salivarius",
  "Veillonella parvula" = "V_parvula"
)

# Apply name changes to the species column in Mefloquine_16S_60uM_summarised

Mefloquine_16S_60uM_summarised$Species <- name_changes[Mefloquine_16S_60uM_summarised$species]
Mefloquine_16S_20uM_summarised$Species <- name_changes[Mefloquine_16S_20uM_summarised$species]
Mefloquine_16S_5uM_summarised$Species <- name_changes[Mefloquine_16S_5uM_summarised$species]

# Verify the changes
unique(Mefloquine_16S_60uM_summarised$Species)
unique(Mefloquine_16S_20uM_summarised$Species)
unique(Mefloquine_16S_5uM_summarised$Species)



##First, for 5 uM:
# Get top 6 species from plot_data_5_endpoint
# Adjust the plot_data_5_endpoint with confidence bounds

# #plot_data_0_Mefloquine_endpoint was used to test model performance at 0 drugs
# plot_data_0_Mefloquine_endpoint <- plot_data_0_Mefloquine_endpoint %>%
#   dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)

plot_data_5_Mefloquine_endpoint <- plot_data_5_Mefloquine_endpoint %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)

# Adjust the Mefloquine_16S_5uM_summarised with confidence bounds
Mefloquine_16S_5uM_summarised <- Mefloquine_16S_5uM_summarised %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)

#NULL model:
Null_model_summarised <- Niclosamide_16S_0uM_summarised %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)


# Get top 6 species based on the lower bound from plot_data_5_endpoint

#top6_predicted_0_Mefloquine was used to test model performance at 0 drugs
# top6_predicted_0_Mefloquine <- plot_data_0_Mefloquine_endpoint %>%
#    arrange(desc(lower_bound)) %>%
#    slice(1:6) %>%
#    pull(Species)

top6_predicted_5_Mefloquine <- plot_data_5_Mefloquine_endpoint %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

# Get top 6 species based on the lower bound from Mefloquine_16S_5uM_summarised
top6_real_5_Mefloquine <- Mefloquine_16S_5uM_summarised %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

top6_NULL <- Null_model_summarised %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

# Calculate the overlap of top 6 species

#top_six_correct_0_Mefloquine was used to assess model performance at 0 drugs
# top_six_correct_0_Mefloquine <- length(intersect(top6_predicted_0_Mefloquine, top6_NULL))
# top_six_correct_0_Mefloquine

top_six_correct_5_Mefloquine <- length(intersect(top6_predicted_5_Mefloquine, top6_real_5_Mefloquine))
top_six_correct_5_Mefloquine

top_six_correct_5_Mefloquine_NULL <- length(intersect(top6_NULL, top6_real_5_Mefloquine))
top_six_correct_5_Mefloquine_NULL

top6_predicted_5_Mefloquine
top6_real_5_Mefloquine

#top6_NULL

#Now by means:
# #top6_predicted_0_Mefloquine_means was used to assess model performance at 0 drugs
# top6_predicted_0_Mefloquine_means <- plot_data_0_Mefloquine_endpoint %>%
#    arrange(desc(mean_rel_ab)) %>%
#    slice(1:6) %>%
#    pull(Species)

top6_predicted_5_Mefloquine_means <- plot_data_5_Mefloquine_endpoint %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)

# Get top 6 species based on the lower bound from Mefloquine_16S_5uM_summarised
top6_real_5_Mefloquine_means <- Mefloquine_16S_5uM_summarised %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)

top6_NULL_means <- Null_model_summarised %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)


# #top_six_correct_0_Mefloquine_means was used to assess model performance at 0 drugs
# top_six_correct_0_Mefloquine_means <- length(intersect(top6_predicted_0_Mefloquine_means, top6_NULL_means))
# top_six_correct_0_Mefloquine_means

top_six_correct_5_Mefloquine_means <- length(intersect(top6_predicted_5_Mefloquine_means, top6_real_5_Mefloquine_means))
top_six_correct_5_Mefloquine_means

top_six_correct_5_Mefloquine_means_NULL <- length(intersect(top6_NULL_means, top6_real_5_Mefloquine_means))
top_six_correct_5_Mefloquine_means_NULL

top6_predicted_5_Mefloquine_means
top6_real_5_Mefloquine_means

#top6_NULL_means


# Merge dataframes by Species

#merged_data_0_Mefloquine was used to assess model performance at 0 drugs
#merged_data_0_Mefloquine <- merge(plot_data_0_Mefloquine_endpoint, Niclosamide_16S_0uM_summarised, by = "Species", suffixes = c(".pred", ".real"))
merged_data_5_Mefloquine <- merge(plot_data_5_Mefloquine_endpoint, Mefloquine_16S_5uM_summarised, by = "Species", suffixes = c(".pred", ".real"))
merged_data_5_Mefloquine_NULL <- merge(Niclosamide_16S_0uM_summarised, Mefloquine_16S_5uM_summarised, by = "Species", suffixes = c(".null", ".real"))


## Below lines used for assessing model performance at 0 drugs; ignore for nonzero concentrations
# # Create lower and upper bounds considering mean ¬± sd
# merged_data_0_Mefloquine$lower_bound_pred <- merged_data_0_Mefloquine$mean_rel_ab.pred - merged_data_0_Mefloquine$sd_rel_ab.pred
# merged_data_0_Mefloquine$upper_bound_pred <- merged_data_0_Mefloquine$mean_rel_ab.pred + merged_data_0_Mefloquine$sd_rel_ab.pred
# merged_data_0_Mefloquine$lower_bound_real <- merged_data_0_Mefloquine$mean_rel_ab.real - merged_data_0_Mefloquine$sd_rel_ab.real
# merged_data_0_Mefloquine$upper_bound_real <- merged_data_0_Mefloquine$mean_rel_ab.real + merged_data_0_Mefloquine$sd_rel_ab.real
# 
# # Ensure lower and upper bounds are non-negative, adjusting as necessary
# merged_data_0_Mefloquine$lower_bound_pred[merged_data_0_Mefloquine$lower_bound_pred <= 0] <- 1e-10
# merged_data_0_Mefloquine$lower_bound_real[merged_data_0_Mefloquine$lower_bound_real <= 0] <- 1e-10
# merged_data_0_Mefloquine$upper_bound_pred[merged_data_0_Mefloquine$upper_bound_pred <= 0] <- 1e-10
# merged_data_0_Mefloquine$upper_bound_real[merged_data_0_Mefloquine$upper_bound_real <= 0] <- 1e-10


# Create lower and upper bounds considering mean ¬± sd
merged_data_5_Mefloquine$lower_bound_pred <- merged_data_5_Mefloquine$mean_rel_ab.pred - merged_data_5_Mefloquine$sd_rel_ab.pred
merged_data_5_Mefloquine$upper_bound_pred <- merged_data_5_Mefloquine$mean_rel_ab.pred + merged_data_5_Mefloquine$sd_rel_ab.pred
merged_data_5_Mefloquine$lower_bound_real <- merged_data_5_Mefloquine$mean_rel_ab.real - merged_data_5_Mefloquine$sd_rel_ab.real
merged_data_5_Mefloquine$upper_bound_real <- merged_data_5_Mefloquine$mean_rel_ab.real + merged_data_5_Mefloquine$sd_rel_ab.real

# Ensure lower and upper bounds are non-negative, adjusting as necessary
merged_data_5_Mefloquine$lower_bound_pred[merged_data_5_Mefloquine$lower_bound_pred <= 0] <- 1e-10
merged_data_5_Mefloquine$lower_bound_real[merged_data_5_Mefloquine$lower_bound_real <= 0] <- 1e-10
merged_data_5_Mefloquine$upper_bound_pred[merged_data_5_Mefloquine$upper_bound_pred <= 0] <- 1e-10
merged_data_5_Mefloquine$upper_bound_real[merged_data_5_Mefloquine$upper_bound_real <= 0] <- 1e-10

##and for NULL model:
# Create lower and upper bounds considering mean ¬± sd
merged_data_5_Mefloquine_NULL$lower_bound_null <- merged_data_5_Mefloquine_NULL$mean_rel_ab.null - merged_data_5_Mefloquine_NULL$sd_rel_ab.null
merged_data_5_Mefloquine_NULL$upper_bound_null <- merged_data_5_Mefloquine_NULL$mean_rel_ab.null + merged_data_5_Mefloquine_NULL$sd_rel_ab.null
merged_data_5_Mefloquine_NULL$lower_bound_real <- merged_data_5_Mefloquine_NULL$mean_rel_ab.real - merged_data_5_Mefloquine_NULL$sd_rel_ab.real
merged_data_5_Mefloquine_NULL$upper_bound_real <- merged_data_5_Mefloquine_NULL$mean_rel_ab.real + merged_data_5_Mefloquine_NULL$sd_rel_ab.real

# Ensure lower and upper bounds are non-negative, adjusting as necessary
merged_data_5_Mefloquine_NULL$lower_bound_null[merged_data_5_Mefloquine_NULL$lower_bound_null <= 0] <- 1e-10
merged_data_5_Mefloquine_NULL$lower_bound_real[merged_data_5_Mefloquine_NULL$lower_bound_real <= 0] <- 1e-10
merged_data_5_Mefloquine_NULL$upper_bound_null[merged_data_5_Mefloquine_NULL$upper_bound_null <= 0] <- 1e-10
merged_data_5_Mefloquine_NULL$upper_bound_real[merged_data_5_Mefloquine_NULL$upper_bound_real <= 0] <- 1e-10

# Filter to include only species with a mean relative abundance > 0.01 in the 'real' dataset

## significant_species_0 was used to assess model performance at 0 drugs
#significant_species_0 <- merged_data_0_Mefloquine[merged_data_0_Mefloquine$mean_rel_ab.real > 0.01, ]
significant_species <- merged_data_5_Mefloquine[merged_data_5_Mefloquine$mean_rel_ab.real > 0.01, ]
survivors_5_Mefloquine <- nrow(significant_species)
survivors_5_Mefloquine

#should be the same as survivors defined above, since it is calculated from .real
significant_species_NULL <- merged_data_5_Mefloquine_NULL[merged_data_5_Mefloquine_NULL$mean_rel_ab.real > 0.01, ]
survivors_5_Mefloquine_NULL <- nrow(significant_species_NULL)
survivors_5_Mefloquine_NULL

# Adjusted order of magnitude check to include SD, only for significant species
## below code was used to assess model performance at 0 drugs
# significant_species_0$Predicted_magnitude_correct <- ifelse(
#   (floor(log10(significant_species_0$lower_bound_pred)) <= floor(log10(significant_species_0$upper_bound_real)) &
#      floor(log10(significant_species_0$upper_bound_pred)) >= floor(log10(significant_species_0$lower_bound_real))),
#   1,
#   0
# )

significant_species$Predicted_magnitude_correct <- ifelse(
  (floor(log10(significant_species$lower_bound_pred)) <= floor(log10(significant_species$upper_bound_real)) &
     floor(log10(significant_species$upper_bound_pred)) >= floor(log10(significant_species$lower_bound_real))),
  1,
  0
)

#and for the Null model:
significant_species_NULL$Predicted_magnitude_correct <- ifelse(
  (floor(log10(significant_species_NULL$lower_bound_null)) <= floor(log10(significant_species_NULL$upper_bound_real)) &
     floor(log10(significant_species_NULL$upper_bound_null)) >= floor(log10(significant_species_NULL$lower_bound_real))),
  1,
  0
)

# Calculate the fraction of correctly predicted magnitudes for significant species
## below code was used to assess model performance at 0 drugs
#predicted_magnitude_correct_fraction_0_Mefloquine <- sum(significant_species_0$Predicted_magnitude_correct) / nrow(significant_species_0)
#predicted_magnitude_correct_fraction_0_Mefloquine

predicted_magnitude_correct_fraction_5_Mefloquine <- sum(significant_species$Predicted_magnitude_correct) / nrow(significant_species)
predicted_magnitude_correct_fraction_5_Mefloquine

predicted_magnitude_correct_fraction_5_Mefloquine_NULL <- sum(significant_species_NULL$Predicted_magnitude_correct) / nrow(significant_species_NULL)
predicted_magnitude_correct_fraction_5_Mefloquine_NULL

top_species_missing_5_Mefloquine <- setdiff(top6_real_5_Mefloquine_means, top6_predicted_5_Mefloquine_means)
top_species_wrong_5_Mefloquine <- setdiff(top6_predicted_5_Mefloquine_means, top6_real_5_Mefloquine_means)

top_species_missing_5_Mefloquine <- if(length(top_species_missing_5_Mefloquine) == 0) "None" else top_species_missing_5_Mefloquine
top_species_wrong_5_Mefloquine <- if(length(top_species_wrong_5_Mefloquine) == 0) "None" else top_species_wrong_5_Mefloquine

Prediction_quality_5_Mefloquine <- data.frame(
  Top_six_correct = paste(top_six_correct_5_Mefloquine, sep=""),
  Top_six_correct_NULL = paste(top_six_correct_5_Mefloquine_NULL, sep=""),
  Top_six_correct_means = paste(top_six_correct_5_Mefloquine_means, sep=""),
  Top_six_correct_means_NULL = paste(top_six_correct_5_Mefloquine_means_NULL, sep=""),
  Predicted_magnitude_correct = paste(round(predicted_magnitude_correct_fraction_5_Mefloquine * 100, 2), "%", sep=""),
  Predicted_magnitude_correct_NULL = paste(round(predicted_magnitude_correct_fraction_5_Mefloquine_NULL * 100, 2), "%", sep=""),
  survivors_total = survivors_5_Mefloquine,
  top_species_missing <- top_species_missing_5_Mefloquine,
  top_species_wrong <- top_species_wrong_5_Mefloquine, 
  predicted_mean_final_OD <- predicted_mean_final_od_5_Mefloquine,
  real_mean_final_OD <- real_mean_final_od_5_Mefloquine,
  sims_total = length(successful_sim_ids)
)



Prediction_quality_5_Mefloquine



##Next, for 20 uM:
# Get top 6 species from plot_data_20_endpoint
# Adjust the plot_data_20_endpoint with confidence bounds
plot_data_20_Mefloquine_endpoint <- plot_data_20_Mefloquine_endpoint %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)

# Adjust the Mefloquine_16S_20uM_summarised with confidence bounds
Mefloquine_16S_20uM_summarised <- Mefloquine_16S_20uM_summarised %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)

#NULL model:
Null_model_summarised <- Niclosamide_16S_0uM_summarised %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)


# Get top 6 species based on the lower bound from plot_data_20_endpoint
top6_predicted_20_Mefloquine <- plot_data_20_Mefloquine_endpoint %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

# Get top 6 species based on the lower bound from Mefloquine_16S_20uM_summarised
top6_real_20_Mefloquine <- Mefloquine_16S_20uM_summarised %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

top6_NULL <- Null_model_summarised %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

# Calculate the overlap of top 6 species
top_six_correct_20_Mefloquine <- length(intersect(top6_predicted_20_Mefloquine, top6_real_20_Mefloquine))
#top_six_correct_20_Mefloquine

top_six_correct_20_Mefloquine_NULL <- length(intersect(top6_NULL, top6_real_20_Mefloquine))
#top_six_correct_20_Mefloquine_NULL

#top6_predicted_20_Mefloquine
#top6_real_20_Mefloquine



#Now by means:
top6_predicted_20_Mefloquine_means <- plot_data_20_Mefloquine_endpoint %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)

# Get top 6 species based on the lower bound from Mefloquine_16S_20uM_summarised
top6_real_20_Mefloquine_means <- Mefloquine_16S_20uM_summarised %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)

top6_NULL_means <- Null_model_summarised %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)



top_six_correct_20_Mefloquine_means <- length(intersect(top6_predicted_20_Mefloquine_means, top6_real_20_Mefloquine_means))
#top_six_correct_20_Mefloquine_means

top_six_correct_20_Mefloquine_means_NULL <- length(intersect(top6_NULL_means, top6_real_20_Mefloquine_means))
#top_six_correct_20_Mefloquine_means_NULL

top6_predicted_20_Mefloquine_means
#top6_real_20_Mefloquine_means




# Merge dataframes by Species
merged_data_20_Mefloquine <- merge(plot_data_20_Mefloquine_endpoint, Mefloquine_16S_20uM_summarised, by = "Species", suffixes = c(".pred", ".real"))
merged_data_20_Mefloquine_NULL <- merge(Niclosamide_16S_0uM_summarised, Mefloquine_16S_20uM_summarised, by = "Species", suffixes = c(".null", ".real"))



# Create lower and upper bounds considering mean ¬± sd
merged_data_20_Mefloquine$lower_bound_pred <- merged_data_20_Mefloquine$mean_rel_ab.pred - merged_data_20_Mefloquine$sd_rel_ab.pred
merged_data_20_Mefloquine$upper_bound_pred <- merged_data_20_Mefloquine$mean_rel_ab.pred + merged_data_20_Mefloquine$sd_rel_ab.pred
merged_data_20_Mefloquine$lower_bound_real <- merged_data_20_Mefloquine$mean_rel_ab.real - merged_data_20_Mefloquine$sd_rel_ab.real
merged_data_20_Mefloquine$upper_bound_real <- merged_data_20_Mefloquine$mean_rel_ab.real + merged_data_20_Mefloquine$sd_rel_ab.real

# Ensure lower and upper bounds are non-negative, adjusting as necessary
merged_data_20_Mefloquine$lower_bound_pred[merged_data_20_Mefloquine$lower_bound_pred <= 0] <- 1e-10
merged_data_20_Mefloquine$lower_bound_real[merged_data_20_Mefloquine$lower_bound_real <= 0] <- 1e-10
merged_data_20_Mefloquine$upper_bound_pred[merged_data_20_Mefloquine$upper_bound_pred <= 0] <- 1e-10
merged_data_20_Mefloquine$upper_bound_real[merged_data_20_Mefloquine$upper_bound_real <= 0] <- 1e-10

##and for NULL model:
# Create lower and upper bounds considering mean ¬± sd
merged_data_20_Mefloquine_NULL$lower_bound_null <- merged_data_20_Mefloquine_NULL$mean_rel_ab.null - merged_data_20_Mefloquine_NULL$sd_rel_ab.null
merged_data_20_Mefloquine_NULL$upper_bound_null <- merged_data_20_Mefloquine_NULL$mean_rel_ab.null + merged_data_20_Mefloquine_NULL$sd_rel_ab.null
merged_data_20_Mefloquine_NULL$lower_bound_real <- merged_data_20_Mefloquine_NULL$mean_rel_ab.real - merged_data_20_Mefloquine_NULL$sd_rel_ab.real
merged_data_20_Mefloquine_NULL$upper_bound_real <- merged_data_20_Mefloquine_NULL$mean_rel_ab.real + merged_data_20_Mefloquine_NULL$sd_rel_ab.real

# Ensure lower and upper bounds are non-negative, adjusting as necessary
merged_data_20_Mefloquine_NULL$lower_bound_null[merged_data_20_Mefloquine_NULL$lower_bound_null <= 0] <- 1e-10
merged_data_20_Mefloquine_NULL$lower_bound_real[merged_data_20_Mefloquine_NULL$lower_bound_real <= 0] <- 1e-10
merged_data_20_Mefloquine_NULL$upper_bound_null[merged_data_20_Mefloquine_NULL$upper_bound_null <= 0] <- 1e-10
merged_data_20_Mefloquine_NULL$upper_bound_real[merged_data_20_Mefloquine_NULL$upper_bound_real <= 0] <- 1e-10

# Filter to include only species with a mean relative abundance > 0.01 in the 'real' dataset
significant_species <- merged_data_20_Mefloquine[merged_data_20_Mefloquine$mean_rel_ab.real > 0.01, ]
survivors_20_Mefloquine <- nrow(significant_species)
survivors_20_Mefloquine

#should be the same as survivors defined above, since it is calculated from .real
significant_species_NULL <- merged_data_20_Mefloquine_NULL[merged_data_20_Mefloquine_NULL$mean_rel_ab.real > 0.01, ]
survivors_20_Mefloquine_NULL <- nrow(significant_species_NULL)
survivors_20_Mefloquine_NULL

# Adjusted order of magnitude check to include SD, only for significant species
significant_species$Predicted_magnitude_correct <- ifelse(
  (floor(log10(significant_species$lower_bound_pred)) <= floor(log10(significant_species$upper_bound_real)) &
     floor(log10(significant_species$upper_bound_pred)) >= floor(log10(significant_species$lower_bound_real))),
  1,
  0
)

#and for the Null model:
significant_species_NULL$Predicted_magnitude_correct <- ifelse(
  (floor(log10(significant_species_NULL$lower_bound_null)) <= floor(log10(significant_species_NULL$upper_bound_real)) &
     floor(log10(significant_species_NULL$upper_bound_null)) >= floor(log10(significant_species_NULL$lower_bound_real))),
  1,
  0
)

# Calculate the fraction of correctly predicted magnitudes for significant species
predicted_magnitude_correct_fraction_20_Mefloquine <- sum(significant_species$Predicted_magnitude_correct) / nrow(significant_species)
predicted_magnitude_correct_fraction_20_Mefloquine

predicted_magnitude_correct_fraction_20_Mefloquine_NULL <- sum(significant_species_NULL$Predicted_magnitude_correct) / nrow(significant_species_NULL)
predicted_magnitude_correct_fraction_20_Mefloquine_NULL

top_species_missing_20_Mefloquine <- setdiff(top6_real_20_Mefloquine_means, top6_predicted_20_Mefloquine_means)
top_species_wrong_20_Mefloquine <- setdiff(top6_predicted_20_Mefloquine_means, top6_real_20_Mefloquine_means)

Prediction_quality_20_Mefloquine <- data.frame(
  Top_six_correct = paste(top_six_correct_20_Mefloquine, sep=""),
  Top_six_correct_NULL = paste(top_six_correct_20_Mefloquine_NULL, sep=""),
  Top_six_correct_means = paste(top_six_correct_20_Mefloquine_means, sep=""),
  Top_six_correct_means_NULL = paste(top_six_correct_20_Mefloquine_means_NULL, sep=""),
  Predicted_magnitude_correct = paste(round(predicted_magnitude_correct_fraction_20_Mefloquine * 100, 2), "%", sep=""),
  Predicted_magnitude_correct_NULL = paste(round(predicted_magnitude_correct_fraction_20_Mefloquine_NULL * 100, 2), "%", sep=""),
  survivors_total = survivors_20_Mefloquine,
  top_species_missing <- top_species_missing_20_Mefloquine,
  top_species_wrong <- top_species_wrong_20_Mefloquine, 
  predicted_mean_final_OD <- predicted_mean_final_od_20_Mefloquine,
  real_mean_final_OD <- real_mean_final_od_20_Mefloquine,
  sims_total = length(successful_sim_ids)
)

Prediction_quality_20_Mefloquine






##Next, for 60 uM:
# Get top 6 species from plot_data_60_endpoint
# Adjust the plot_data_60_endpoint with confidence bounds
plot_data_60_Mefloquine_endpoint <- plot_data_60_Mefloquine_endpoint %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)

# Adjust the Mefloquine_16S_60uM_summarised with confidence bounds
Mefloquine_16S_60uM_summarised <- Mefloquine_16S_60uM_summarised %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)

#NULL model:
Null_model_summarised <- Niclosamide_16S_0uM_summarised %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)


# Get top 6 species based on the lower bound from plot_data_60_endpoint
top6_predicted_60_Mefloquine <- plot_data_60_Mefloquine_endpoint %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

# Get top 6 species based on the lower bound from Mefloquine_16S_60uM_summarised
top6_real_60_Mefloquine <- Mefloquine_16S_60uM_summarised %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

top6_NULL <- Null_model_summarised %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

# Calculate the overlap of top 6 species
top_six_correct_60_Mefloquine <- length(intersect(top6_predicted_60_Mefloquine, top6_real_60_Mefloquine))
#top_six_correct_60_Mefloquine

top_six_correct_60_Mefloquine_NULL <- length(intersect(top6_NULL, top6_real_60_Mefloquine))
#top_six_correct_60_Mefloquine_NULL

#top6_predicted_60_Mefloquine
#top6_real_60_Mefloquine




#Now by means:
top6_predicted_60_Mefloquine_means <- plot_data_60_Mefloquine_endpoint %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)

# Get top 6 species based on the lower bound from Mefloquine_16S_60uM_summarised
top6_real_60_Mefloquine_means <- Mefloquine_16S_60uM_summarised %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)

top6_NULL_means <- Null_model_summarised %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)



top_six_correct_60_Mefloquine_means <- length(intersect(top6_predicted_60_Mefloquine_means, top6_real_60_Mefloquine_means))
#top_six_correct_60_Mefloquine_means

top_six_correct_60_Mefloquine_means_NULL <- length(intersect(top6_NULL_means, top6_real_60_Mefloquine_means))
#top_six_correct_60_Mefloquine_means_NULL

#top6_predicted_60_Mefloquine_means
#top6_real_60_Mefloquine_means




# Merge dataframes by Species
merged_data_60_Mefloquine <- merge(plot_data_60_Mefloquine_endpoint, Mefloquine_16S_60uM_summarised, by = "Species", suffixes = c(".pred", ".real"))
merged_data_60_Mefloquine_NULL <- merge(Niclosamide_16S_0uM_summarised, Mefloquine_16S_60uM_summarised, by = "Species", suffixes = c(".null", ".real"))



# Create lower and upper bounds considering mean ¬± sd
merged_data_60_Mefloquine$lower_bound_pred <- merged_data_60_Mefloquine$mean_rel_ab.pred - merged_data_60_Mefloquine$sd_rel_ab.pred
merged_data_60_Mefloquine$upper_bound_pred <- merged_data_60_Mefloquine$mean_rel_ab.pred + merged_data_60_Mefloquine$sd_rel_ab.pred
merged_data_60_Mefloquine$lower_bound_real <- merged_data_60_Mefloquine$mean_rel_ab.real - merged_data_60_Mefloquine$sd_rel_ab.real
merged_data_60_Mefloquine$upper_bound_real <- merged_data_60_Mefloquine$mean_rel_ab.real + merged_data_60_Mefloquine$sd_rel_ab.real

# Ensure lower and upper bounds are non-negative, adjusting as necessary
merged_data_60_Mefloquine$lower_bound_pred[merged_data_60_Mefloquine$lower_bound_pred <= 0] <- 1e-10
merged_data_60_Mefloquine$lower_bound_real[merged_data_60_Mefloquine$lower_bound_real <= 0] <- 1e-10
merged_data_60_Mefloquine$upper_bound_pred[merged_data_60_Mefloquine$upper_bound_pred <= 0] <- 1e-10
merged_data_60_Mefloquine$upper_bound_real[merged_data_60_Mefloquine$upper_bound_real <= 0] <- 1e-10

##and for NULL model:
# Create lower and upper bounds considering mean ¬± sd
merged_data_60_Mefloquine_NULL$lower_bound_null <- merged_data_60_Mefloquine_NULL$mean_rel_ab.null - merged_data_60_Mefloquine_NULL$sd_rel_ab.null
merged_data_60_Mefloquine_NULL$upper_bound_null <- merged_data_60_Mefloquine_NULL$mean_rel_ab.null + merged_data_60_Mefloquine_NULL$sd_rel_ab.null
merged_data_60_Mefloquine_NULL$lower_bound_real <- merged_data_60_Mefloquine_NULL$mean_rel_ab.real - merged_data_60_Mefloquine_NULL$sd_rel_ab.real
merged_data_60_Mefloquine_NULL$upper_bound_real <- merged_data_60_Mefloquine_NULL$mean_rel_ab.real + merged_data_60_Mefloquine_NULL$sd_rel_ab.real

# Ensure lower and upper bounds are non-negative, adjusting as necessary
merged_data_60_Mefloquine_NULL$lower_bound_null[merged_data_60_Mefloquine_NULL$lower_bound_null <= 0] <- 1e-10
merged_data_60_Mefloquine_NULL$lower_bound_real[merged_data_60_Mefloquine_NULL$lower_bound_real <= 0] <- 1e-10
merged_data_60_Mefloquine_NULL$upper_bound_null[merged_data_60_Mefloquine_NULL$upper_bound_null <= 0] <- 1e-10
merged_data_60_Mefloquine_NULL$upper_bound_real[merged_data_60_Mefloquine_NULL$upper_bound_real <= 0] <- 1e-10

# Filter to include only species with a mean relative abundance > 0.01 in the 'real' dataset
significant_species <- merged_data_60_Mefloquine[merged_data_60_Mefloquine$mean_rel_ab.real > 0.01, ]
survivors_60_Mefloquine <- nrow(significant_species)
survivors_60_Mefloquine

#should be the same as survivors defined above, since it is calculated from .real
significant_species_NULL <- merged_data_60_Mefloquine_NULL[merged_data_60_Mefloquine_NULL$mean_rel_ab.real > 0.01, ]
survivors_60_Mefloquine_NULL <- nrow(significant_species_NULL)
survivors_60_Mefloquine_NULL

# Adjusted order of magnitude check to include SD, only for significant species
significant_species$Predicted_magnitude_correct <- ifelse(
  (floor(log10(significant_species$lower_bound_pred)) <= floor(log10(significant_species$upper_bound_real)) &
     floor(log10(significant_species$upper_bound_pred)) >= floor(log10(significant_species$lower_bound_real))),
  1,
  0
)

#and for the Null model:
significant_species_NULL$Predicted_magnitude_correct <- ifelse(
  (floor(log10(significant_species_NULL$lower_bound_null)) <= floor(log10(significant_species_NULL$upper_bound_real)) &
     floor(log10(significant_species_NULL$upper_bound_null)) >= floor(log10(significant_species_NULL$lower_bound_real))),
  1,
  0
)

# Calculate the fraction of correctly predicted magnitudes for significant species
predicted_magnitude_correct_fraction_60_Mefloquine <- sum(significant_species$Predicted_magnitude_correct) / nrow(significant_species)
predicted_magnitude_correct_fraction_60_Mefloquine

predicted_magnitude_correct_fraction_60_Mefloquine_NULL <- sum(significant_species_NULL$Predicted_magnitude_correct) / nrow(significant_species_NULL)
predicted_magnitude_correct_fraction_60_Mefloquine_NULL


top_species_missing_60_Mefloquine <- setdiff(top6_real_60_Mefloquine_means, top6_predicted_60_Mefloquine_means)
top_species_wrong_60_Mefloquine <- setdiff(top6_predicted_60_Mefloquine_means, top6_real_60_Mefloquine_means)

Prediction_quality_60_Mefloquine <- data.frame(
  Top_six_correct = paste(top_six_correct_60_Mefloquine, sep=""),
  Top_six_correct_NULL = paste(top_six_correct_60_Mefloquine_NULL, sep=""),
  Top_six_correct_means = paste(top_six_correct_60_Mefloquine_means, sep=""),
  Top_six_correct_means_NULL = paste(top_six_correct_60_Mefloquine_means_NULL, sep=""),
  Predicted_magnitude_correct = paste(round(predicted_magnitude_correct_fraction_60_Mefloquine * 100, 2), "%", sep=""),
  Predicted_magnitude_correct_NULL = paste(round(predicted_magnitude_correct_fraction_60_Mefloquine_NULL * 100, 2), "%", sep=""),
  survivors_total = survivors_60_Mefloquine,
  top_species_missing <- top_species_missing_60_Mefloquine,
  top_species_wrong <- top_species_wrong_60_Mefloquine, 
  predicted_mean_final_OD <- predicted_mean_final_od_60_Mefloquine,
  real_mean_final_OD <- real_mean_final_od_60_Mefloquine,
  sims_total = length(successful_sim_ids)
)

Prediction_quality_60_Mefloquine









##Methotrexate

combined_monoculture_aucs2_Methotrexate <- subset(combined_monoculture_aucs2, drug == "Methotrexate")


#drug sensitivity terms: define once outside of ODEs
y_function_B_vulgatus_Methotrexate <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("B_vulgatus", "Methotrexate", best_fitting_models_df_Methotrexate)), collapse = " ")))
y_function_B_uniformis_Methotrexate <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("B_uniformis", "Methotrexate", best_fitting_models_df_Methotrexate)), collapse = " ")))
y_function_B_fragilis_Methotrexate <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("B_fragilis", "Methotrexate", best_fitting_models_df_Methotrexate)), collapse = " ")))
y_function_B_thetaiotaomicron_Methotrexate <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("B_thetaiotaomicron", "Methotrexate", best_fitting_models_df_Methotrexate)), collapse = " ")))
y_function_C_ramosum_Methotrexate <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("C_ramosum", "Methotrexate", best_fitting_models_df_Methotrexate)), collapse = " ")))
y_function_E_rectale_Methotrexate <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("E_rectale", "Methotrexate", best_fitting_models_df_Methotrexate)), collapse = " ")))
y_function_R_intestinalis_Methotrexate <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("R_intestinalis", "Methotrexate", best_fitting_models_df_Methotrexate)), collapse = " ")))
y_function_V_parvula_Methotrexate <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("V_parvula", "Methotrexate", best_fitting_models_df_Methotrexate)), collapse = " ")))
y_function_E_lenta_Methotrexate <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("E_lenta", "Methotrexate", best_fitting_models_df_Methotrexate)), collapse = " ")))
y_function_F_nucleatum_Methotrexate <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("F_nucleatum", "Methotrexate", best_fitting_models_df_Methotrexate)), collapse = " ")))
y_function_C_bolteae_Methotrexate <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("C_bolteae", "Methotrexate", best_fitting_models_df_Methotrexate)), collapse = " ")))
y_function_C_perfringens_Methotrexate <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("C_perfringens", "Methotrexate", best_fitting_models_df_Methotrexate)), collapse = " ")))
y_function_C_saccharolyticum_Methotrexate <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("C_saccharolyticum", "Methotrexate", best_fitting_models_df_Methotrexate)), collapse = " ")))
y_function_S_salivarius_Methotrexate <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("S_salivarius", "Methotrexate", best_fitting_models_df_Methotrexate)), collapse = " ")))
y_function_R_gnavus_Methotrexate <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("R_gnavus", "Methotrexate", best_fitting_models_df_Methotrexate)), collapse = " ")))
y_function_C_comes_Methotrexate <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("C_comes", "Methotrexate", best_fitting_models_df_Methotrexate)), collapse = " ")))
y_function_P_merdae_Methotrexate <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("P_merdae", "Methotrexate", best_fitting_models_df_Methotrexate)), collapse = " ")))
y_function_S_parasanguinis_Methotrexate <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("S_parasanguinis", "Methotrexate", best_fitting_models_df_Methotrexate)), collapse = " ")))
y_function_C_aerofaciens_Methotrexate <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("C_aerofaciens", "Methotrexate", best_fitting_models_df_Methotrexate)), collapse = " ")))
y_function_D_formicigenerans_Methotrexate <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("D_formicigenerans", "Methotrexate", best_fitting_models_df_Methotrexate)), collapse = " ")))
y_function_E_coli_Methotrexate <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("E_coli", "Methotrexate", best_fitting_models_df_Methotrexate)), collapse = " ")))



y_function_B_vulgatus_Methotrexate_func <- eval(parse(text = paste("function(Drug) {", y_function_B_vulgatus_Methotrexate, "}")))
y_function_B_uniformis_Methotrexate_func <- eval(parse(text = paste("function(Drug) {", y_function_B_uniformis_Methotrexate, "}")))
y_function_B_fragilis_Methotrexate_func <- eval(parse(text = paste("function(Drug) {", y_function_B_fragilis_Methotrexate, "}")))
y_function_B_thetaiotaomicron_Methotrexate_func <- eval(parse(text = paste("function(Drug) {", y_function_B_thetaiotaomicron_Methotrexate, "}")))
y_function_C_ramosum_Methotrexate_func <- eval(parse(text = paste("function(Drug) {", y_function_C_ramosum_Methotrexate, "}")))
y_function_E_rectale_Methotrexate_func <- eval(parse(text = paste("function(Drug) {", y_function_E_rectale_Methotrexate, "}")))
y_function_R_intestinalis_Methotrexate_func <- eval(parse(text = paste("function(Drug) {", y_function_R_intestinalis_Methotrexate, "}")))
y_function_E_lenta_Methotrexate_func <- eval(parse(text = paste("function(Drug) {", y_function_E_lenta_Methotrexate, "}")))
y_function_F_nucleatum_Methotrexate_func <- eval(parse(text = paste("function(Drug) {", y_function_F_nucleatum_Methotrexate, "}")))
y_function_C_bolteae_Methotrexate_func <- eval(parse(text = paste("function(Drug) {", y_function_C_bolteae_Methotrexate, "}")))
y_function_C_perfringens_Methotrexate_func <- eval(parse(text = paste("function(Drug) {", y_function_C_perfringens_Methotrexate, "}")))
y_function_C_saccharolyticum_Methotrexate_func <- eval(parse(text = paste("function(Drug) {", y_function_C_saccharolyticum_Methotrexate, "}")))
y_function_S_salivarius_Methotrexate_func <- eval(parse(text = paste("function(Drug) {", y_function_S_salivarius_Methotrexate, "}")))
y_function_R_gnavus_Methotrexate_func <- eval(parse(text = paste("function(Drug) {", y_function_R_gnavus_Methotrexate, "}")))
y_function_C_comes_Methotrexate_func <- eval(parse(text = paste("function(Drug) {", y_function_C_comes_Methotrexate, "}")))
y_function_P_merdae_Methotrexate_func <- eval(parse(text = paste("function(Drug) {", y_function_P_merdae_Methotrexate, "}")))
y_function_S_parasanguinis_Methotrexate_func <- eval(parse(text = paste("function(Drug) {", y_function_S_parasanguinis_Methotrexate, "}")))
y_function_C_aerofaciens_Methotrexate_func <- eval(parse(text = paste("function(Drug) {", y_function_C_aerofaciens_Methotrexate, "}")))
y_function_D_formicigenerans_Methotrexate_func <- eval(parse(text = paste("function(Drug) {", y_function_D_formicigenerans_Methotrexate, "}")))
y_function_E_coli_Methotrexate_func <- eval(parse(text = paste("function(Drug) {", y_function_E_coli_Methotrexate, "}")))
y_function_V_parvula_Methotrexate_func <- eval(parse(text = paste("function(Drug) {", y_function_V_parvula_Methotrexate, "}")))



unique(combined_monoculture_aucs2_Methotrexate$conc)
##dictate drug concentration tested for simulation cycle here:
#drug_concentration_tested <- 5 #if manually or:
drug_concentration_tested <- unique(combined_monoculture_aucs2_Methotrexate$conc)[1] 
initial_conditions <- rep(0.01/32, 32)
initial_conditions <- c(initial_conditions, drug_concentration_tested)


##drug effect fitted for species showing sensitivity in monoculture:
#unique(combined_monoculture_aucs2_Methotrexate$Species)

##for more simple linear fits
closed.sir.model_Methotrexate <- function (t, x, params) {
  ## first extract the state variables
  A_muciniphila <- x[1]
  B_adolescentis <- x[2]
  B_fragilis <- x[3]
  B_longum <- x[4]
  B_obeum <- x[5]
  B_thetaiotaomicron <- x[6]
  B_uniformis <- x[7]
  B_vulgatus <- x[8]
  B_wadsworthia <- x[9]
  C_aerofaciens <- x[10]
  C_bolteae <- x[11]
  C_comes <- x[12]
  C_perfringens <- x[13]
  C_ramosum <- x[14]
  C_saccharolyticum <- x[15]
  D_formicigenerans <- x[16]
  E_coli <- x[17]
  E_lenta <- x[18]
  E_rectale <- x[19]
  F_nucleatum <- x[20]
  L_paracasei <- x[21]
  O_splanchnicus <- x[22]
  P_copri <- x[23]
  P_distasonis <- x[24]
  P_merdae <- x[25]
  R_bromii <- x[26]
  R_gnavus <- x[27]
  R_intestinalis <- x[28]
  R_torques <- x[29]
  S_parasanguinis <- x[30]
  S_salivarius <- x[31]
  V_parvula <- x[32]
  Drug <- x[33]
  
  
  ## now extract the parameters
  r_B_fragilis <- flat_params[["B._fragilis.r"]]
  K_B_fragilis <- flat_params[["B._fragilis.K"]]
  r_B_longum <- flat_params[["B._longum.r"]]
  K_B_longum <- flat_params[["B._longum.K"]]
  r_B_thetaiotaomicron <- flat_params[["B._thetaiotaomicron.r"]]
  K_B_thetaiotaomicron <- flat_params[["B._thetaiotaomicron.K"]]
  r_B_uniformis <- flat_params[["B._uniformis.r"]]
  K_B_uniformis <- flat_params[["B._uniformis.K"]]
  r_B_vulgatus <- flat_params[["B._vulgatus.r"]]
  K_B_vulgatus <- flat_params[["B._vulgatus.K"]]
  r_B_wadsworthia <- flat_params[["B._wadsworthia.r"]]
  K_B_wadsworthia <- flat_params[["B._wadsworthia.K"]]
  r_C_aerofaciens <- flat_params[["C._aerofaciens.r"]]
  K_C_aerofaciens <- flat_params[["C._aerofaciens.K"]]
  r_C_bolteae <- flat_params[["C._bolteae.r"]]
  K_C_bolteae <- flat_params[["C._bolteae.K"]]
  r_C_comes <- flat_params[["C._comes.r"]]
  K_C_comes <- flat_params[["C._comes.K"]]
  r_C_perfringens <- flat_params[["C._perfringens.r"]]
  K_C_perfringens <- flat_params[["C._perfringens.K"]]
  r_C_ramosum <- flat_params[["C._ramosum.r"]]
  K_C_ramosum <- flat_params[["C._ramosum.K"]]
  r_C_saccharolyticum <- flat_params[["C._saccharolyticum.r"]]
  K_C_saccharolyticum <- flat_params[["C._saccharolyticum.K"]]
  r_D_formicigenerans <- flat_params[["D._formicigenerans.r"]]
  K_D_formicigenerans <- flat_params[["D._formicigenerans.K"]]
  r_E_coli <- flat_params[["E._coli.r"]]
  K_E_coli <- flat_params[["E._coli.K"]]
  r_E_lenta <- flat_params[["E._lenta.r"]]
  K_E_lenta <- flat_params[["E._lenta.K"]]
  r_E_rectale <- flat_params[["E._rectale.r"]]
  K_E_rectale <- flat_params[["E._rectale.K"]]
  r_F_nucleatum <- flat_params[["F._nucleatum.r"]]
  K_F_nucleatum <- flat_params[["F._nucleatum.K"]]
  r_P_copri <- flat_params[["P._copri.r"]]
  K_P_copri <- flat_params[["P._copri.K"]]
  r_P_merdae <- flat_params[["P._merdae.r"]]
  K_P_merdae <- flat_params[["P._merdae.K"]]
  r_R_gnavus <- flat_params[["R._gnavus.r"]]
  K_R_gnavus <- flat_params[["R._gnavus.K"]]
  r_R_intestinalis <- flat_params[["R._intestinalis.r"]]
  K_R_intestinalis <- flat_params[["R._intestinalis.K"]]
  r_V_parvula <- flat_params[["V._parvula.r"]]
  K_V_parvula <- flat_params[["V._parvula.K"]]
  r_A_muciniphila <- flat_params[["A._muciniphila.r"]]
  K_A_muciniphila <- flat_params[["A._muciniphila.K"]]
  r_B_adolescentis <- flat_params[["B._adolescentis.r"]]
  K_B_adolescentis <- flat_params[["B._adolescentis.K"]]
  r_B_obeum <- flat_params[["B._obeum.r"]]
  K_B_obeum <- flat_params[["B._obeum.K"]]
  r_O_splanchnicus <- flat_params[["O._splanchnicus.r"]]
  K_O_splanchnicus <- flat_params[["O._splanchnicus.K"]]
  r_P_distasonis <- flat_params[["P._distasonis.r"]]
  K_P_distasonis <- flat_params[["P._distasonis.K"]]
  r_R_bromii <- flat_params[["R._bromii.r"]]
  K_R_bromii <- flat_params[["R._bromii.K"]]
  r_R_torques <- flat_params[["R._torques.r"]]
  K_R_torques <- flat_params[["R._torques.K"]]
  r_S_parasanguinis <- flat_params[["S._parasanguinis.r"]]
  K_S_parasanguinis <-flat_params[["S._parasanguinis.K"]]
  r_S_salivarius <- flat_params[["S._salivarius.r"]]
  K_S_salivarius <- flat_params[["S._salivarius.K"]]
  r_L_paracasei <- flat_params[["L._paracasei.r"]]
  K_L_paracasei <- flat_params[["L._paracasei.K"]]
  
  
  t_mod <- ifelse(t > 24.1, t - 24.1, t)
  
  
  ## now code the model equations
  dA_muciniphila_dt <- r_A_muciniphila * A_muciniphila * (1 - A_muciniphila / K_A_muciniphila)
  dB_adolescentis_dt <- r_B_adolescentis * B_adolescentis * (1 - B_adolescentis / K_B_adolescentis)
  dB_fragilis_dt <- r_B_fragilis * B_fragilis * (1 - B_fragilis / max(0.0001, K_B_fragilis * (y_function_B_fragilis_Methotrexate_func(Drug))))
  dB_longum_dt <- r_B_longum * B_longum * (1 - B_longum / K_B_longum)
  dB_obeum_dt <- r_B_obeum * B_obeum * (1 - B_obeum / K_B_obeum)
  dB_thetaiotaomicron_dt <- r_B_thetaiotaomicron * B_thetaiotaomicron * (1 - B_thetaiotaomicron / max(0.0001, K_B_thetaiotaomicron * (y_function_B_thetaiotaomicron_Methotrexate_func(Drug))))  
  dB_uniformis_dt <- r_B_uniformis * B_uniformis * (1 - B_uniformis / max(0.0001, K_B_uniformis * (y_function_B_uniformis_Methotrexate_func(Drug))))
  dB_vulgatus_dt <- r_B_vulgatus * B_vulgatus * (1 - B_vulgatus / max(0.0001, K_B_vulgatus * (y_function_B_vulgatus_Methotrexate_func(Drug))))
  dB_wadsworthia_dt <- r_B_wadsworthia * B_wadsworthia * (1 - B_wadsworthia / K_B_wadsworthia)
  dC_aerofaciens_dt <- r_C_aerofaciens * C_aerofaciens * (1 - C_aerofaciens / max(0.0001, K_C_aerofaciens * (y_function_C_aerofaciens_Methotrexate_func(Drug))))
  dC_bolteae_dt <- r_C_bolteae * C_bolteae * (1 - C_bolteae /  max(0.0001, K_C_bolteae * (y_function_C_bolteae_Methotrexate_func(Drug))))
  dC_comes_dt <- r_C_comes * C_comes * (1 - C_comes / max(0.0001, K_C_comes * (y_function_C_comes_Methotrexate_func(Drug))))
  dC_perfringens_dt <- r_C_perfringens * C_perfringens * (1 - C_perfringens / max(0.0001, K_C_perfringens * (y_function_C_perfringens_Methotrexate_func(Drug))))
  dC_ramosum_dt <- r_C_ramosum * C_ramosum * (1 - C_ramosum / max(0.0001, K_C_ramosum * (y_function_C_ramosum_Methotrexate_func(Drug))))
  dC_saccharolyticum_dt <- r_C_saccharolyticum * C_saccharolyticum * (1 - C_saccharolyticum / max(0.0001, K_C_saccharolyticum * (y_function_C_saccharolyticum_Methotrexate_func(Drug))))
  dD_formicigenerans_dt <- r_D_formicigenerans * D_formicigenerans * (1 - D_formicigenerans / max(0.0001, K_D_formicigenerans * (y_function_D_formicigenerans_Methotrexate_func(Drug))))
  dE_coli_dt <- r_E_coli * E_coli * (1 - E_coli / max(0.0001, K_E_coli * (y_function_E_coli_Methotrexate_func(Drug))))
  dE_lenta_dt <- r_E_lenta * E_lenta * (1 - E_lenta / max(0.0001, K_E_lenta * (y_function_E_lenta_Methotrexate_func(Drug))))
  dE_rectale_dt <- r_E_rectale * E_rectale * (1 - E_rectale / max(0.0001, K_E_rectale * (y_function_E_rectale_Methotrexate_func(Drug))))
  dF_nucleatum_dt <- r_F_nucleatum * F_nucleatum * (1 - F_nucleatum / max(0.0001, K_F_nucleatum * (y_function_F_nucleatum_Methotrexate_func(Drug))))
  dL_paracasei_dt <- r_L_paracasei * L_paracasei * (1 - L_paracasei / K_L_paracasei)  
  dO_splanchnicus_dt <- r_O_splanchnicus * O_splanchnicus * (1 - O_splanchnicus / K_O_splanchnicus)  
  dP_copri_dt <- r_P_copri * P_copri * (1 - P_copri / K_P_copri)
  dP_distasonis_dt <- r_P_distasonis * P_distasonis * (1 - P_distasonis / K_P_distasonis)  
  dP_merdae_dt <- r_P_merdae * P_merdae * (1 - P_merdae / max(0.0001, K_P_merdae * (y_function_P_merdae_Methotrexate_func(Drug))))
  dR_bromii_dt <- r_R_bromii * R_bromii * (1 - R_bromii / K_R_bromii) 
  dR_gnavus_dt <- r_R_gnavus * R_gnavus * (1 - R_gnavus / max(0.0001, K_R_gnavus * (y_function_R_gnavus_Methotrexate_func(Drug))))
  dR_intestinalis_dt <- r_R_intestinalis * R_intestinalis * (1 - R_intestinalis / max(0.0001, K_R_intestinalis * (y_function_R_intestinalis_Methotrexate_func(Drug))))
  dR_torques_dt <- r_R_torques * R_torques * (1 - R_torques /K_R_torques) 
  dS_parasanguinis_dt <- r_S_parasanguinis * S_parasanguinis * (1 - S_parasanguinis / max(0.0001, K_S_parasanguinis * (y_function_S_parasanguinis_Methotrexate_func(Drug))))
  dS_salivarius_dt <- r_S_salivarius * S_salivarius * (1 - S_salivarius / max(0.0001, K_S_salivarius * (y_function_S_salivarius_Methotrexate_func(Drug))))
  dV_parvula_dt <- r_V_parvula * V_parvula * (1 - V_parvula / max(0.0001, K_V_parvula * (y_function_V_parvula_Methotrexate_func(Drug))))
  
  
  
  #Drug differential:
  dDrug_dt <- (subset(drug_dynamics, Drug == "Methotrexate")$Steepness_param_community * exp(-subset(drug_dynamics, Drug == "Methotrexate")$Steepness_param_community * t_mod)) * (drug_concentration_tested * prop_left_Methotrexate - drug_concentration_tested)
  #dDrug_dt <- 0
  
  ## Combine results into a single vector
  dxdt <- c(dA_muciniphila_dt, dB_adolescentis_dt, dB_fragilis_dt, dB_longum_dt, dB_obeum_dt, dB_thetaiotaomicron_dt, dB_uniformis_dt, dB_vulgatus_dt, dB_wadsworthia_dt, dC_aerofaciens_dt, dC_bolteae_dt, dC_comes_dt, dC_perfringens_dt, dC_ramosum_dt, dC_saccharolyticum_dt, dD_formicigenerans_dt, dE_coli_dt, dE_lenta_dt, dE_rectale_dt, dF_nucleatum_dt, dL_paracasei_dt, dO_splanchnicus_dt, dP_copri_dt, dP_distasonis_dt, dP_merdae_dt, dR_bromii_dt, dR_gnavus_dt, dR_intestinalis_dt, dR_torques_dt, dS_parasanguinis_dt, dS_salivarius_dt, dV_parvula_dt, dDrug_dt)
  
  ## Return result as a list
  list(dxdt)
}




#calculate the co-culture correction factor per species based on community composition in absence of drug, just like done for Niclosamide

growth_data_all_0_Niclosamide
growth_data_all_0_Niclosamide1 <- growth_data_all_0_Niclosamide %>%
  dplyr::mutate(Species = gsub(" ", "_", Species))


# Merge rel_ab_control with growth_data_all_0_Niclosamide on Species
# Function to remove duplicated columns by name pattern
clean_columns_base <- function(df, pattern) {
  cols_to_keep <- !grepl(pattern, names(df))
  df <- df[, cols_to_keep]
  return(df)
}

# Use the new function to clean up your dataframe
rel_ab_control <- clean_columns_base(rel_ab_control, "mean_max_OD.[xy]")
str(rel_ab_control)


#rel_ab_control$correction_factor <- rel_ab_control$mean_rel_ab / (rel_ab_control$mean_max_OD/sum(rel_ab_control$mean_max_OD))
# Calculate correction factor with a minimum value of ~1
rel_ab_control$correction_factor <- pmax(rel_ab_control$mean_rel_ab / (rel_ab_control$mean_max_OD / sum(rel_ab_control$mean_max_OD)), 1.1)


# Create a new dataframe for co-culture correction
co_culture_correction <- data.frame(
  species = rel_ab_control$Species,
  correction_factor = rel_ab_control$correction_factor
)


#summarise community data
#Adjust based on tested concentrations for each drug
unique(Community_compositions_focus_drugs_Methotrexate$concentration)

Community_compositions_focus_drugs_Methotrexate_5uM <- subset(Community_compositions_focus_drugs_Methotrexate, concentration == 5)
Community_compositions_focus_drugs_Methotrexate_20uM <- subset(Community_compositions_focus_drugs_Methotrexate, concentration == 20)
Community_compositions_focus_drugs_Methotrexate_80uM <- subset(Community_compositions_focus_drugs_Methotrexate, concentration == 80)


#5 uM
Community_compositions_focus_drugs_Methotrexate_5uM_summarised <- Community_compositions_focus_drugs_Methotrexate_5uM %>%
  dplyr::group_by(species) %>%                                  
  dplyr::summarize(
    mean_rel_ab = mean(rel_abundance, na.rm = TRUE),     
    sd_rel_ab = sd(rel_abundance, na.rm = TRUE) ,
    mean_max_OD = mean(maxOD, na.rm = TRUE),
    sd_max_OD = sd(maxOD, na.rm = TRUE),
    mean_final_OD = mean(finalOD, na.rm = TRUE),
    sd_final_OD = sd(finalOD, na.rm = TRUE)
  ) %>%
  dplyr::ungroup() 


Community_compositions_focus_drugs_Methotrexate_5uM_summarised <- Community_compositions_focus_drugs_Methotrexate_5uM_summarised %>%
  dplyr::mutate(Species = sub("^(\\w)\\w*\\s(.*)", "\\1._\\2", species))

#remove (sub)strain info
Community_compositions_focus_drugs_Methotrexate_5uM_summarised <- Community_compositions_focus_drugs_Methotrexate_5uM_summarised %>%
  dplyr::mutate(Species = sub("^(\\w\\._\\w+).*", "\\1", Species))


#20 uM
Community_compositions_focus_drugs_Methotrexate_20uM_summarised <- Community_compositions_focus_drugs_Methotrexate_20uM %>%
  dplyr::group_by(species) %>%                                  
  dplyr::summarize(
    mean_rel_ab = mean(rel_abundance, na.rm = TRUE),     
    sd_rel_ab = sd(rel_abundance, na.rm = TRUE) ,
    mean_max_OD = mean(maxOD, na.rm = TRUE),
    sd_max_OD = sd(maxOD, na.rm = TRUE),
    mean_final_OD = mean(finalOD, na.rm = TRUE),
    sd_final_OD = sd(finalOD, na.rm = TRUE)
  ) %>%
  dplyr::ungroup() 


Community_compositions_focus_drugs_Methotrexate_20uM_summarised <- Community_compositions_focus_drugs_Methotrexate_20uM_summarised %>%
  dplyr::mutate(Species = sub("^(\\w)\\w*\\s(.*)", "\\1._\\2", species))

#remove (sub)strain info
Community_compositions_focus_drugs_Methotrexate_20uM_summarised <- Community_compositions_focus_drugs_Methotrexate_20uM_summarised %>%
  dplyr::mutate(Species = sub("^(\\w\\._\\w+).*", "\\1", Species))


#80 uM
Community_compositions_focus_drugs_Methotrexate_80uM_summarised <- Community_compositions_focus_drugs_Methotrexate_80uM %>%
  dplyr::group_by(species) %>%                                  
  dplyr::summarize(
    mean_rel_ab = mean(rel_abundance, na.rm = TRUE),     
    sd_rel_ab = sd(rel_abundance, na.rm = TRUE) ,
    mean_max_OD = mean(maxOD, na.rm = TRUE),
    sd_max_OD = sd(maxOD, na.rm = TRUE),    
    mean_final_OD = mean(finalOD, na.rm = TRUE),
    sd_final_OD = sd(finalOD, na.rm = TRUE)
  ) %>%
  dplyr::ungroup() 



Community_compositions_focus_drugs_Methotrexate_80uM_summarised <- Community_compositions_focus_drugs_Methotrexate_80uM_summarised %>%
  dplyr::mutate(Species = sub("^(\\w)\\w*\\s(.*)", "\\1._\\2", species))

#remove (sub)strain info
Community_compositions_focus_drugs_Methotrexate_80uM_summarised <- Community_compositions_focus_drugs_Methotrexate_80uM_summarised %>%
  dplyr::mutate(Species = sub("^(\\w\\._\\w+).*", "\\1", Species))


#Initialise data frames
sim_output <- data.frame()
input_params_list <- list() #Use a list to collect parameters for each simulation

#number of simulations
num_sims <- 250


for (i in 1:num_sims) {
  tryCatch({
    # generate model parameters
    set.seed(i) #set a different seed for each simulation for variation
    params <- lapply(1:nrow(growth_data_all_0_Niclosamide), function(idx) {
      species_params <- growth_data_all_0_Niclosamide[idx, ]
      list(
        r = rnorm(1, mean = species_params$mean_max_Growth_rate, sd = species_params$sd_max_Growth_rate),
        K = rnorm(1, mean = species_params$mean_max_OD, sd = species_params$sd_max_OD)
      )
    })
    names(params) <- gsub(" ", "_", growth_data_all_0_Niclosamide$Species)
    flat_params <- unlist(params)
    names(flat_params) <- gsub("\\.\\d$", "", names(flat_params))
    
    #replace spaces with underscores to match formatting
    co_culture_correction$species <- gsub(" ", "_", co_culture_correction$species, fixed = TRUE)
    
    #replace the species-specific K parameters extracted from monoculture growth data 
    #with drawn relative abundance values at Niclosamide = 0, scaled to K
    rel_ab_control$Species <- gsub(" ", "_", rel_ab_control$Species)
    
    #Initialise an empty vector to store drawn values
    drawn_values <- numeric(nrow(rel_ab_control))
    
    #draw values from their respective distributions
    for (k in 1:nrow(rel_ab_control)) {
      species_name <- rel_ab_control$Species[k]
      drawn_value <- rnorm(1, mean = rel_ab_control$mean_rel_ab[k], sd = rel_ab_control$sd_rel_ab[k])
      drawn_values[k] <- max(drawn_value, 0)  # Ensure no negative values
    }
    
    #Normalise drawn relative abundance values so they sum to 1 (to reflect a 'true' relative abundance distribution)
    #this is needed so when we convert the values into OD units by multiplying with the drawn community maxOD,
    # the sum of K_i parameters and the drawn K are equal
    normalised_values <- drawn_values / sum(drawn_values)
    
    #Pull community maxOD (K) at 0 drugs from respective normal distribution:
    K <- rnorm(n = 1, mean = rel_ab_control$mean_com_max_OD[1], sd = rel_ab_control$sd_com_max_OD[1])
    
    # Assign these normalised values to their respective species' .K parameters
    for (k in 1:nrow(rel_ab_control)) {
      species_name <- rel_ab_control$Species[k]
      k_index <- grep(paste0("^", species_name, "\\.K$"), names(flat_params))
      
      if (length(k_index) > 0) {
        old_value <- flat_params[k_index]
        flat_params[k_index] <- (normalised_values[k] + 0.0001) * K #add small value in case drawn K_i is 0, which would cause issues with the solver
        cat(sprintf("Updated %s from %f to %f using normalised value %f scaled by K %f\n", names(flat_params)[k_index], old_value, flat_params[k_index], normalised_values[k], K))
      }
    }
    
    #Accounting for variation in drug degradation by community, with standard deviation of end concentration (at 10h) around the fitted predicted (relative) end concentration at 24h
    #prop_left_Methotrexate <- abs(rnorm(1, (subset(drug_dynamics, Drug == "Methotrexate")$Prop_left_24h_community), (subset(drug_dynamics, Drug == "Methotrexate")$SD_drug_community))) 
    #below, we account for measurement error rather than ecological drivers that lead to the variability of degradation at the final point measured 
    prop_left_Methotrexate <- abs(rnorm(
      n = 1, 
      mean = subset(drug_dynamics, Drug == "Methotrexate")$Prop_left_24h_community, 
      sd = ifelse(
        subset(drug_dynamics, Drug == "Methotrexate")$SD_drug_community > subset(drug_dynamics, Drug == "Methotrexate")$SD_drug_community_start, 
        subset(drug_dynamics, Drug == "Methotrexate")$SD_drug_community - subset(drug_dynamics, Drug == "Methotrexate")$SD_drug_community_start, 
        subset(drug_dynamics, Drug == "Methotrexate")$SD_drug_community
      )
    ))
    
    
    #loop through each species in co_culture_correction
    for (j in 1:nrow(co_culture_correction)) {
      # Extract the species name and correction factor
      species_name <- co_culture_correction$species[j]
      correction_factor <- co_culture_correction$correction_factor[j]
      
      # Identify the corresponding growth rate parameter in flat_params
      #by matching the base species name (without .r)
      growth_rate_indices <- grep(paste0("^", species_name, "\\.r$"), names(flat_params))
      
      #take the growth rate parameter and apply the correction factor 
      for (index in growth_rate_indices) {
        flat_params[index] <- flat_params[index] * correction_factor
      }
    }
    
    flat_params
    # Store parameters for each simulation
    input_params_list[[i]] <- c(sim_ID = i, flat_params)
    
    # Run the model for the first 24-hour cycle
    solution_cycle_1 <- ode(y = initial_conditions, times = seq(from = 0, to = 24, by = 0.1), func = closed.sir.model_Methotrexate, parms = flat_params,   method = "lsoda", rtol = 1e-6, atol = 1e-6)
    
    # Dilution and second cycle
    end_of_cycle_1 <- solution_cycle_1[nrow(solution_cycle_1), -1]
    initial_conditions_cycle_2 <- end_of_cycle_1 / 50
    #accounting for the drugs being added with the new growth cycle as well:
    initial_conditions_cycle_2[33] <- initial_conditions_cycle_2[33] + drug_concentration_tested
    solution_cycle_2 <- ode(y = initial_conditions_cycle_2, times = seq(from = 24, to = 48, by = 0.1), func = closed.sir.model_Methotrexate, parms = flat_params,  method = "lsoda", rtol = 1e-6, atol = 1e-6)
    
    # Combine and format results
    combined_solution <- rbind(as.data.frame(solution_cycle_1), as.data.frame(solution_cycle_2)[-1,])
    combined_solution$sim_ID <- rep(i, nrow(combined_solution))
    combined_solution <- combined_solution %>%
      tidyr::gather(key = "Species", value = "Density", -time, -sim_ID) %>%
      dplyr::mutate(Hour = time) %>%
      dplyr::select(sim_ID, Hour, Species, Density)
    
    ##Append to sim_output
    sim_output <- rbind(sim_output, combined_solution)
  }, error = function(e) {
    cat(sprintf("Skipping simulation %d due to an error: %s\n", i, e$message))
  })
}



##Combine all parameter data into a single dataframe
input_params <- do.call(rbind, input_params_list)

# Add a "Species" column 
sim_output$Species_name <- species_names[as.numeric(as.character(sim_output$Species))]
sim_output$Species_name <- replace_na(sim_output$Species_name, "Drug")

#View(input_params)
#View(sim_output)

sim_output <- na.omit(sim_output)
successful_sim_ids <- unique(subset(sim_output, Hour == 48)$sim_ID)
length(successful_sim_ids)
sim_output1 <- sim_output[sim_output$sim_ID %in% successful_sim_ids, ]


#Transform sim_output so we have wide format by Species
sim_output_wide <- tidyr::pivot_wider(sim_output1, 
                                      names_from = Species_name, 
                                      values_from = Density,
                                      id_cols = c(sim_ID, Hour))

length(unique(sim_output_wide$sim_ID))
#calc community OD per timepoint
sim_output_wide$Total_OD <- rowSums(sim_output_wide[, 3:34], na.rm = TRUE)
#calculate and add relative abundances here as well:
species_columns <- colnames(sim_output_wide)[3:34] 

for (species in species_columns) {
  sim_output_wide[[paste0("rel_", species)]] <- sim_output_wide[[species]] / sim_output_wide$Total_OD
}


#assign sim_output_wide test conditions to dataframe name
drug_tested <- "Methotrexate"
variable_name_1 <- paste0("sim_output_wide_", ifelse(drug_concentration_tested == 1e-04, 0, drug_concentration_tested), "_", drug_tested)
assign(variable_name_1, sim_output_wide)

#turn back into long format if interested in plotting relative abundances
cols_needed <- c("sim_ID", "Hour")

sim_output_long <- sim_output_wide %>% 
  dplyr::select(sim_ID, Hour, Drug, starts_with("rel_")) %>% 
  tidyr::pivot_longer(
    cols = c(Drug, starts_with("rel_")),
    names_to = "Species", 
    values_to = "Relative_abundance",
    names_prefix = "rel_",
    names_transform = list(Species = ~ ifelse(.x == "Drug", "Drug", .x))
  ) 

str(sim_output_long)


species_names_1 <- c(
  "A_muciniphila",
  "B_adolescentis",
  "B_fragilis",
  "B_longum",
  "B_obeum",
  "B_thetaiotaomicron",
  "B_uniformis",
  "B_vulgatus",
  "B_wadsworthia",
  "C_aerofaciens",
  "C_bolteae",
  "C_comes",
  "C_perfringens",
  "C_ramosum",
  "C_saccharolyticum",
  "D_formicigenerans",
  "E_coli",
  "E_lenta",
  "E_rectale",
  "F_nucleatum",
  "L_paracasei",
  "O_splanchnicus",
  "P_copri",
  "P_distasonis",
  "P_merdae",
  "R_bromii",
  "R_gnavus",
  "R_intestinalis",
  "R_torques",
  "S_parasanguinis",
  "S_salivarius",
  "V_parvula",
  "Drug"
)

species_colours_1 <- c(
  "A_muciniphila" = "#1f77b4",
  "B_adolescentis" = "#ff7f0e",
  "B_fragilis" = "#2ca02c",
  "B_longum" = "#d62728",
  "B_obeum" = "#9467bd",
  "B_thetaiotaomicron" = "black",
  "B_uniformis" = "#e377c2",
  "B_vulgatus" = "#7f7f7f",
  "B_wadsworthia" = "gold1",
  "C_aerofaciens" = "#aec7e8",
  "C_bolteae" = "#ffbb78",
  "C_comes" = "magenta",
  "C_perfringens" = "#ff9896",
  "C_ramosum" = "#c5b0d5",
  "C_saccharolyticum" = "#c49c94",
  "D_formicigenerans" = "#f7b6d2",
  "E_coli" = "yellow",
  "E_lenta" = "turquoise",
  "E_rectale" = "#393b79",
  "F_nucleatum" = "royalblue2",
  "L_paracasei" = "blue",
  "O_splanchnicus" = "#637939",
  "P_copri" = "cyan",
  "P_distasonis" = "#8c6d31",
  "P_merdae" = "#c7c7c7",
  "R_bromii" = "#e6550d",
  "R_gnavus" = "#e7cb94",
  "R_intestinalis" = "#843c39",
  "R_torques" = "#d6616b",
  "S_parasanguinis" = "orange3",
  "S_salivarius" = "#7b4173",
  "V_parvula" = "#ce6dbd",
  "Drug" = "green"
)



##Plot output for any specific sim:
# ggplot(subset(sim_output, sim_ID == 1 & Species_name != "Drug"), aes(x = Hour, y = Density, group = Species_name, color = Species_name)) +
#   geom_line(size = 1, alpha = 0.7) +
#   scale_color_manual(values = species_colours_1) +
#   labs(title = paste0("Methotrexate = ", drug_concentration_tested),
#        x = "Time (hours)",
#        y = "Population Density (OD)",
#        color = "Species") +
#   theme_minimal() +
#   theme(legend.position = "right")
# 
# ggplot(subset(sim_output, sim_ID == 3 & Species_name != "Drug"), aes(x = Hour, y = Density, group = Species_name, color = Species_name)) +
#   geom_line(size = 1, alpha = 0.7) +
#   scale_color_manual(values = species_colours_1) +
#   labs(title = paste0("Methotrexate = ", drug_concentration_tested),
#        x = "Time (hours)",
#        y = "Population Density (OD)",
#        color = "Species") +
#   theme_minimal() +
#   theme(legend.position = "right")


ggplot(subset(sim_output_long, sim_ID == 1), aes(x = Hour, y = Relative_abundance, group = Species, color = Species)) +
  geom_line(size = 1, alpha = 0.7) +
  scale_color_manual(values = species_colours_1) +
  labs(title = paste0("Methotrexate = ", drug_concentration_tested),
       x = "Time (hours)",
       y = "Relative abundance",
       color = "Species") +
  theme_minimal() +
  theme(legend.position = "right")


ggplot(subset(sim_output_long, sim_ID == 3), aes(x = Hour, y = Relative_abundance, group = Species, color = Species)) +
  geom_line(size = 1, alpha = 0.7) +
  scale_color_manual(values = species_colours_1) +
  labs(title = paste0("Methotrexate = ", drug_concentration_tested),
       x = "Time (hours)",
       y = "Relative abundance",
       color = "Species") +
  theme_minimal() +
  theme(legend.position = "right")


#calc mean and standard deviation across sims
sim_stats <- sim_output_long %>%
  dplyr::group_by(Hour, Species) %>%
  dplyr::summarise(
    mean_rel_ab = mean(Relative_abundance),
    sd_rel_ab = sd(Relative_abundance),
    .groups = 'drop'
  )

# Prepare the data for plotting
plot_data <- sim_stats %>%
  dplyr::mutate(Upper = mean_rel_ab + sd_rel_ab, Lower = mean_rel_ab - sd_rel_ab)

ggplot(subset(plot_data, Species != "Drug"), aes(x = Hour, y = mean_rel_ab, group = Species, color = Species)) +
  geom_ribbon(aes(ymin = Lower, ymax = Upper, fill = Species), colour = NA, alpha = 0.2) +  
  geom_line(size = 1, alpha = 0.7) + 
  scale_color_manual(values = species_colours_1) +
  scale_fill_manual(values = species_colours_1) +  
  labs(title = "Mean and SD of Relative Abundance Across Simulations",
       subtitle = paste0("Methotrexate = ", drug_concentration_tested),       
       x = "Time (hours)",
       y = "Relative abundance",
       color = "Species",
       fill = "Species") +
  theme_minimal() +
  theme(legend.position = "right")

#log-scaled mean trends
ggplot(plot_data, aes(x = Hour, y = log10(mean_rel_ab + 0.0001), group = Species, color = Species)) +
  geom_line(size = 1, alpha = 0.7) +  # Mean line
  scale_color_manual(values = species_colours_1) +
  scale_fill_manual(values = species_colours_1) +  # Ensure consistent colors for lines and fills
  labs(title = "Mean and SD of Relative Abundance Across Simulations",
       subtitle = paste0("Methotrexate = ", drug_concentration_tested),
       x = "Time (hours)",
       y = "Relative abundance",
       color = "Species",
       fill = "Species") +
  theme_minimal() +
  theme(legend.position = "right")




##prediction quality evaluation
drug_tested <- "Methotrexate"
variable_name <- paste0("plot_data_", ifelse(drug_concentration_tested == 1e-04, 0, drug_concentration_tested), "_", drug_tested)
assign(variable_name, plot_data)


#extract total OD info:
predicted_mean_final_od_NULL <- Niclosamide_16S_0uM_summarised$mean_com_final_OD[1]
predicted_sd_final_od_NULL <- Niclosamide_16S_0uM_summarised$sd_com_final_OD[1]

predicted_mean_final_od_5_Methotrexate <- mean(subset(sim_output_wide_5_Methotrexate, Hour == 48)$Total_OD, na.rm = TRUE)
predicted_sd_final_od_5_Methotrexate <- sd(subset(sim_output_wide_5_Methotrexate, Hour == 48)$Total_OD, na.rm = TRUE)

real_mean_final_od_5_Methotrexate <- Community_compositions_focus_drugs_Methotrexate_5uM_summarised$mean_final_OD[1]
real_sd_final_od_5_Methotrexate <- Community_compositions_focus_drugs_Methotrexate_5uM_summarised$sd_final_OD[1]


predicted_mean_final_od_20_Methotrexate <- mean(subset(sim_output_wide_20_Methotrexate, Hour == 48)$Total_OD, na.rm = TRUE)
predicted_sd_final_od_20_Methotrexate <- sd(subset(sim_output_wide_20_Methotrexate, Hour == 48)$Total_OD, na.rm = TRUE)

real_mean_final_od_20_Methotrexate <- Community_compositions_focus_drugs_Methotrexate_20uM_summarised$mean_final_OD[1]
real_sd_final_od_20_Methotrexate <- Community_compositions_focus_drugs_Methotrexate_20uM_summarised$sd_final_OD[1]


predicted_mean_final_od_80_Methotrexate <- mean(subset(sim_output_wide_80_Methotrexate, Hour == 48)$Total_OD, na.rm = TRUE)
predicted_sd_final_od_80_Methotrexate <- sd(subset(sim_output_wide_80_Methotrexate, Hour == 48)$Total_OD, na.rm = TRUE)

real_mean_final_od_80_Methotrexate <- Community_compositions_focus_drugs_Methotrexate_80uM_summarised$mean_final_OD[1]
real_sd_final_od_80_Methotrexate <- Community_compositions_focus_drugs_Methotrexate_80uM_summarised$sd_final_OD[1]




#plot_data_0_Methotrexate_endpoint was used to test model performance at 0 drugs
#plot_data_0_Methotrexate_endpoint <- subset(plot_data_0_Methotrexate, Hour == 48 & Species != "Drug")
plot_data_5_Methotrexate_endpoint <- subset(plot_data_5_Methotrexate, Hour == 48 & Species != "Drug")
plot_data_20_Methotrexate_endpoint <- subset(plot_data_20_Methotrexate, Hour == 48 & Species != "Drug")
plot_data_80_Methotrexate_endpoint <- subset(plot_data_80_Methotrexate, Hour == 48 & Species != "Drug")

##Inspecting 'match' to real relative abundance distributions:
Niclosamide_16S_0uM_summarised <- rel_ab_control
Niclosamide_16S_0uM_summarised$Species <- gsub("\\.", "", Niclosamide_16S_0uM_summarised$Species)

Methotrexate_16S_5uM_summarised <- Community_compositions_focus_drugs_Methotrexate_5uM_summarised
Methotrexate_16S_20uM_summarised <- Community_compositions_focus_drugs_Methotrexate_20uM_summarised
Methotrexate_16S_80uM_summarised <- Community_compositions_focus_drugs_Methotrexate_80uM_summarised

Niclosamide_16S_0uM_summarised
Methotrexate_16S_5uM_summarised 
Methotrexate_16S_20uM_summarised 
Methotrexate_16S_80uM_summarised 

#Rename 'species' so the outputs become comparable
original_names_80 <- unique(Methotrexate_16S_80uM_summarised$species)
original_names_20 <- unique(Methotrexate_16S_20uM_summarised$species)
original_names_5 <- unique(Methotrexate_16S_5uM_summarised$species)


##Create a named vector with the original and new names mapping
name_changes <- c(
  "Akkermansia muciniphila" = "A_muciniphila",
  "Bacteroides fragilis" = "B_fragilis",
  "Bacteroides thetaiotaomicron" = "B_thetaiotaomicron",
  "Bacteroides uniformis" = "B_uniformis",
  "Bifidobacterium adolescentis" = "B_adolescentis",
  "Bifidobacterium longum subsp. longum" = "B_longum",
  "Bilophila wadsworthia" = "B_wadsworthia",
  "Blautia obeum" = "B_obeum",
  "Clostridium perfringens" = "C_perfringens",
  "Collinsella aerofaciens" = "C_aerofaciens",
  "Coprococcus comes" = "C_comes",
  "Dorea formicigenerans" = "D_formicigenerans",
  "Eggerthella lenta" = "E_lenta",
  "Enterocloster bolteae" = "C_bolteae",
  "Erysipelatoclostridium ramosum" = "C_ramosum",
  "Escherichia coli ED1a" = "E_coli",
  "Eubacterium rectale" = "E_rectale",
  "Fusobacterium nucleatum subsp. nucleatum" = "F_nucleatum",
  "Lacrimispora saccharolytica" = "C_saccharolyticum",
  "Lacticaseibacillus paracasei" = "L_paracasei",
  "Odoribacter splanchnicus" = "O_splanchnicus",
  "Parabacteroides distasonis" = "P_distasonis",
  "Parabacteroides merdae" = "P_merdae",
  "Phocaeicola vulgatus" = "B_vulgatus",
  "Prevotella copri" = "P_copri",
  "Roseburia intestinalis" = "R_intestinalis",
  "Ruminococcus bromii" = "R_bromii",
  "Ruminococcus gnavus" = "R_gnavus",
  "Ruminococcus torques" = "R_torques",
  "Streptococcus parasanguinis" = "S_parasanguinis",
  "Streptococcus salivarius" = "S_salivarius",
  "Veillonella parvula" = "V_parvula"
)

# Apply name changes to the species column in Methotrexate_16S_80uM_summarised

Methotrexate_16S_80uM_summarised$Species <- name_changes[Methotrexate_16S_80uM_summarised$species]
Methotrexate_16S_20uM_summarised$Species <- name_changes[Methotrexate_16S_20uM_summarised$species]
Methotrexate_16S_5uM_summarised$Species <- name_changes[Methotrexate_16S_5uM_summarised$species]

# Verify the changes
unique(Methotrexate_16S_80uM_summarised$Species)
unique(Methotrexate_16S_20uM_summarised$Species)
unique(Methotrexate_16S_5uM_summarised$Species)



##First, for 5 uM:
# Get top 6 species from plot_data_5_endpoint
# Adjust the plot_data_5_endpoint with confidence bounds

# #plot_data_0_Methotrexate_endpoint was used to test model performance at 0 drugs
# plot_data_0_Methotrexate_endpoint <- plot_data_0_Methotrexate_endpoint %>%
#   dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)

plot_data_5_Methotrexate_endpoint <- plot_data_5_Methotrexate_endpoint %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)

# Adjust the Methotrexate_16S_5uM_summarised with confidence bounds
Methotrexate_16S_5uM_summarised <- Methotrexate_16S_5uM_summarised %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)

#NULL model:
Null_model_summarised <- Niclosamide_16S_0uM_summarised %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)


# Get top 6 species based on the lower bound from plot_data_5_endpoint

#top6_predicted_0_Methotrexate was used to test model performance at 0 drugs
# top6_predicted_0_Methotrexate <- plot_data_0_Methotrexate_endpoint %>%
#    arrange(desc(lower_bound)) %>%
#    slice(1:6) %>%
#    pull(Species)

top6_predicted_5_Methotrexate <- plot_data_5_Methotrexate_endpoint %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

# Get top 6 species based on the lower bound from Methotrexate_16S_5uM_summarised
top6_real_5_Methotrexate <- Methotrexate_16S_5uM_summarised %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

top6_NULL <- Null_model_summarised %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

# Calculate the overlap of top 6 species

#top_six_correct_0_Methotrexate was used to assess model performance at 0 drugs
# top_six_correct_0_Methotrexate <- length(intersect(top6_predicted_0_Methotrexate, top6_NULL))
# top_six_correct_0_Methotrexate

top_six_correct_5_Methotrexate <- length(intersect(top6_predicted_5_Methotrexate, top6_real_5_Methotrexate))
top_six_correct_5_Methotrexate

top_six_correct_5_Methotrexate_NULL <- length(intersect(top6_NULL, top6_real_5_Methotrexate))
top_six_correct_5_Methotrexate_NULL

top6_predicted_5_Methotrexate
top6_real_5_Methotrexate

#top6_NULL

#Now by means:
# #top6_predicted_0_Methotrexate_means was used to assess model performance at 0 drugs
# top6_predicted_0_Methotrexate_means <- plot_data_0_Methotrexate_endpoint %>%
#    arrange(desc(mean_rel_ab)) %>%
#    slice(1:6) %>%
#    pull(Species)

top6_predicted_5_Methotrexate_means <- plot_data_5_Methotrexate_endpoint %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)

# Get top 6 species based on the lower bound from Methotrexate_16S_5uM_summarised
top6_real_5_Methotrexate_means <- Methotrexate_16S_5uM_summarised %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)

top6_NULL_means <- Null_model_summarised %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)


# #top_six_correct_0_Methotrexate_means was used to assess model performance at 0 drugs
# top_six_correct_0_Methotrexate_means <- length(intersect(top6_predicted_0_Methotrexate_means, top6_NULL_means))
# top_six_correct_0_Methotrexate_means

top_six_correct_5_Methotrexate_means <- length(intersect(top6_predicted_5_Methotrexate_means, top6_real_5_Methotrexate_means))
top_six_correct_5_Methotrexate_means

top_six_correct_5_Methotrexate_means_NULL <- length(intersect(top6_NULL_means, top6_real_5_Methotrexate_means))
top_six_correct_5_Methotrexate_means_NULL

top6_predicted_5_Methotrexate_means
top6_real_5_Methotrexate_means

#top6_NULL_means


# Merge dataframes by Species

#merged_data_0_Methotrexate was used to assess model performance at 0 drugs
#merged_data_0_Methotrexate <- merge(plot_data_0_Methotrexate_endpoint, Niclosamide_16S_0uM_summarised, by = "Species", suffixes = c(".pred", ".real"))
merged_data_5_Methotrexate <- merge(plot_data_5_Methotrexate_endpoint, Methotrexate_16S_5uM_summarised, by = "Species", suffixes = c(".pred", ".real"))
merged_data_5_Methotrexate_NULL <- merge(Niclosamide_16S_0uM_summarised, Methotrexate_16S_5uM_summarised, by = "Species", suffixes = c(".null", ".real"))


## Below lines used for assessing model performance at 0 drugs; ignore for nonzero concentrations
# # Create lower and upper bounds considering mean ¬± sd
# merged_data_0_Methotrexate$lower_bound_pred <- merged_data_0_Methotrexate$mean_rel_ab.pred - merged_data_0_Methotrexate$sd_rel_ab.pred
# merged_data_0_Methotrexate$upper_bound_pred <- merged_data_0_Methotrexate$mean_rel_ab.pred + merged_data_0_Methotrexate$sd_rel_ab.pred
# merged_data_0_Methotrexate$lower_bound_real <- merged_data_0_Methotrexate$mean_rel_ab.real - merged_data_0_Methotrexate$sd_rel_ab.real
# merged_data_0_Methotrexate$upper_bound_real <- merged_data_0_Methotrexate$mean_rel_ab.real + merged_data_0_Methotrexate$sd_rel_ab.real
# 
# # Ensure lower and upper bounds are non-negative, adjusting as necessary
# merged_data_0_Methotrexate$lower_bound_pred[merged_data_0_Methotrexate$lower_bound_pred <= 0] <- 1e-10
# merged_data_0_Methotrexate$lower_bound_real[merged_data_0_Methotrexate$lower_bound_real <= 0] <- 1e-10
# merged_data_0_Methotrexate$upper_bound_pred[merged_data_0_Methotrexate$upper_bound_pred <= 0] <- 1e-10
# merged_data_0_Methotrexate$upper_bound_real[merged_data_0_Methotrexate$upper_bound_real <= 0] <- 1e-10


# Create lower and upper bounds considering mean ¬± sd
merged_data_5_Methotrexate$lower_bound_pred <- merged_data_5_Methotrexate$mean_rel_ab.pred - merged_data_5_Methotrexate$sd_rel_ab.pred
merged_data_5_Methotrexate$upper_bound_pred <- merged_data_5_Methotrexate$mean_rel_ab.pred + merged_data_5_Methotrexate$sd_rel_ab.pred
merged_data_5_Methotrexate$lower_bound_real <- merged_data_5_Methotrexate$mean_rel_ab.real - merged_data_5_Methotrexate$sd_rel_ab.real
merged_data_5_Methotrexate$upper_bound_real <- merged_data_5_Methotrexate$mean_rel_ab.real + merged_data_5_Methotrexate$sd_rel_ab.real

# Ensure lower and upper bounds are non-negative, adjusting as necessary
merged_data_5_Methotrexate$lower_bound_pred[merged_data_5_Methotrexate$lower_bound_pred <= 0] <- 1e-10
merged_data_5_Methotrexate$lower_bound_real[merged_data_5_Methotrexate$lower_bound_real <= 0] <- 1e-10
merged_data_5_Methotrexate$upper_bound_pred[merged_data_5_Methotrexate$upper_bound_pred <= 0] <- 1e-10
merged_data_5_Methotrexate$upper_bound_real[merged_data_5_Methotrexate$upper_bound_real <= 0] <- 1e-10

##and for NULL model:
# Create lower and upper bounds considering mean ¬± sd
merged_data_5_Methotrexate_NULL$lower_bound_null <- merged_data_5_Methotrexate_NULL$mean_rel_ab.null - merged_data_5_Methotrexate_NULL$sd_rel_ab.null
merged_data_5_Methotrexate_NULL$upper_bound_null <- merged_data_5_Methotrexate_NULL$mean_rel_ab.null + merged_data_5_Methotrexate_NULL$sd_rel_ab.null
merged_data_5_Methotrexate_NULL$lower_bound_real <- merged_data_5_Methotrexate_NULL$mean_rel_ab.real - merged_data_5_Methotrexate_NULL$sd_rel_ab.real
merged_data_5_Methotrexate_NULL$upper_bound_real <- merged_data_5_Methotrexate_NULL$mean_rel_ab.real + merged_data_5_Methotrexate_NULL$sd_rel_ab.real

# Ensure lower and upper bounds are non-negative, adjusting as necessary
merged_data_5_Methotrexate_NULL$lower_bound_null[merged_data_5_Methotrexate_NULL$lower_bound_null <= 0] <- 1e-10
merged_data_5_Methotrexate_NULL$lower_bound_real[merged_data_5_Methotrexate_NULL$lower_bound_real <= 0] <- 1e-10
merged_data_5_Methotrexate_NULL$upper_bound_null[merged_data_5_Methotrexate_NULL$upper_bound_null <= 0] <- 1e-10
merged_data_5_Methotrexate_NULL$upper_bound_real[merged_data_5_Methotrexate_NULL$upper_bound_real <= 0] <- 1e-10

# Filter to include only species with a mean relative abundance > 0.01 in the 'real' dataset

## significant_species_0 was used to assess model performance at 0 drugs
#significant_species_0 <- merged_data_0_Methotrexate[merged_data_0_Methotrexate$mean_rel_ab.real > 0.01, ]
significant_species <- merged_data_5_Methotrexate[merged_data_5_Methotrexate$mean_rel_ab.real > 0.01, ]
survivors_5_Methotrexate <- nrow(significant_species)
survivors_5_Methotrexate

#should be the same as survivors defined above, since it is calculated from .real
significant_species_NULL <- merged_data_5_Methotrexate_NULL[merged_data_5_Methotrexate_NULL$mean_rel_ab.real > 0.01, ]
survivors_5_Methotrexate_NULL <- nrow(significant_species_NULL)
survivors_5_Methotrexate_NULL

# Adjusted order of magnitude check to include SD, only for significant species
## below code was used to assess model performance at 0 drugs
# significant_species_0$Predicted_magnitude_correct <- ifelse(
#   (floor(log10(significant_species_0$lower_bound_pred)) <= floor(log10(significant_species_0$upper_bound_real)) &
#      floor(log10(significant_species_0$upper_bound_pred)) >= floor(log10(significant_species_0$lower_bound_real))),
#   1,
#   0
# )

significant_species$Predicted_magnitude_correct <- ifelse(
  (floor(log10(significant_species$lower_bound_pred)) <= floor(log10(significant_species$upper_bound_real)) &
     floor(log10(significant_species$upper_bound_pred)) >= floor(log10(significant_species$lower_bound_real))),
  1,
  0
)

#and for the Null model:
significant_species_NULL$Predicted_magnitude_correct <- ifelse(
  (floor(log10(significant_species_NULL$lower_bound_null)) <= floor(log10(significant_species_NULL$upper_bound_real)) &
     floor(log10(significant_species_NULL$upper_bound_null)) >= floor(log10(significant_species_NULL$lower_bound_real))),
  1,
  0
)

# Calculate the fraction of correctly predicted magnitudes for significant species
## below code was used to assess model performance at 0 drugs
#predicted_magnitude_correct_fraction_0_Methotrexate <- sum(significant_species_0$Predicted_magnitude_correct) / nrow(significant_species_0)
#predicted_magnitude_correct_fraction_0_Methotrexate

predicted_magnitude_correct_fraction_5_Methotrexate <- sum(significant_species$Predicted_magnitude_correct) / nrow(significant_species)
predicted_magnitude_correct_fraction_5_Methotrexate

predicted_magnitude_correct_fraction_5_Methotrexate_NULL <- sum(significant_species_NULL$Predicted_magnitude_correct) / nrow(significant_species_NULL)
predicted_magnitude_correct_fraction_5_Methotrexate_NULL

top_species_missing_5_Methotrexate <- setdiff(top6_real_5_Methotrexate_means, top6_predicted_5_Methotrexate_means)
top_species_wrong_5_Methotrexate <- setdiff(top6_predicted_5_Methotrexate_means, top6_real_5_Methotrexate_means)


Prediction_quality_5_Methotrexate <- data.frame(
  Top_six_correct = paste(top_six_correct_5_Methotrexate, sep=""),
  Top_six_correct_NULL = paste(top_six_correct_5_Methotrexate_NULL, sep=""),
  Top_six_correct_means = paste(top_six_correct_5_Methotrexate_means, sep=""),
  Top_six_correct_means_NULL = paste(top_six_correct_5_Methotrexate_means_NULL, sep=""),
  Predicted_magnitude_correct = paste(round(predicted_magnitude_correct_fraction_5_Methotrexate * 100, 2), "%", sep=""),
  Predicted_magnitude_correct_NULL = paste(round(predicted_magnitude_correct_fraction_5_Methotrexate_NULL * 100, 2), "%", sep=""),
  survivors_total = survivors_5_Methotrexate,
  top_species_missing <- top_species_missing_5_Methotrexate,
  top_species_wrong <- top_species_wrong_5_Methotrexate, 
  predicted_mean_final_OD <- predicted_mean_final_od_5_Methotrexate,
  real_mean_final_OD <- real_mean_final_od_5_Methotrexate,
  sims_total = length(successful_sim_ids)
)



Prediction_quality_5_Methotrexate



##Next, for 20 uM:
# Get top 6 species from plot_data_20_endpoint
# Adjust the plot_data_20_endpoint with confidence bounds
plot_data_20_Methotrexate_endpoint <- plot_data_20_Methotrexate_endpoint %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)

# Adjust the Methotrexate_16S_20uM_summarised with confidence bounds
Methotrexate_16S_20uM_summarised <- Methotrexate_16S_20uM_summarised %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)

#NULL model:
Null_model_summarised <- Niclosamide_16S_0uM_summarised %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)


# Get top 6 species based on the lower bound from plot_data_20_endpoint
top6_predicted_20_Methotrexate <- plot_data_20_Methotrexate_endpoint %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

# Get top 6 species based on the lower bound from Methotrexate_16S_20uM_summarised
top6_real_20_Methotrexate <- Methotrexate_16S_20uM_summarised %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

top6_NULL <- Null_model_summarised %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

# Calculate the overlap of top 6 species
top_six_correct_20_Methotrexate <- length(intersect(top6_predicted_20_Methotrexate, top6_real_20_Methotrexate))
#top_six_correct_20_Methotrexate

top_six_correct_20_Methotrexate_NULL <- length(intersect(top6_NULL, top6_real_20_Methotrexate))
#top_six_correct_20_Methotrexate_NULL

#top6_predicted_20_Methotrexate
#top6_real_20_Methotrexate



#Now by means:
top6_predicted_20_Methotrexate_means <- plot_data_20_Methotrexate_endpoint %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)

# Get top 6 species based on the lower bound from Methotrexate_16S_20uM_summarised
top6_real_20_Methotrexate_means <- Methotrexate_16S_20uM_summarised %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)

top6_NULL_means <- Null_model_summarised %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)



top_six_correct_20_Methotrexate_means <- length(intersect(top6_predicted_20_Methotrexate_means, top6_real_20_Methotrexate_means))
#top_six_correct_20_Methotrexate_means

top_six_correct_20_Methotrexate_means_NULL <- length(intersect(top6_NULL_means, top6_real_20_Methotrexate_means))
#top_six_correct_20_Methotrexate_means_NULL

top6_predicted_20_Methotrexate_means
#top6_real_20_Methotrexate_means




# Merge dataframes by Species
merged_data_20_Methotrexate <- merge(plot_data_20_Methotrexate_endpoint, Methotrexate_16S_20uM_summarised, by = "Species", suffixes = c(".pred", ".real"))
merged_data_20_Methotrexate_NULL <- merge(Niclosamide_16S_0uM_summarised, Methotrexate_16S_20uM_summarised, by = "Species", suffixes = c(".null", ".real"))



# Create lower and upper bounds considering mean ¬± sd
merged_data_20_Methotrexate$lower_bound_pred <- merged_data_20_Methotrexate$mean_rel_ab.pred - merged_data_20_Methotrexate$sd_rel_ab.pred
merged_data_20_Methotrexate$upper_bound_pred <- merged_data_20_Methotrexate$mean_rel_ab.pred + merged_data_20_Methotrexate$sd_rel_ab.pred
merged_data_20_Methotrexate$lower_bound_real <- merged_data_20_Methotrexate$mean_rel_ab.real - merged_data_20_Methotrexate$sd_rel_ab.real
merged_data_20_Methotrexate$upper_bound_real <- merged_data_20_Methotrexate$mean_rel_ab.real + merged_data_20_Methotrexate$sd_rel_ab.real

# Ensure lower and upper bounds are non-negative, adjusting as necessary
merged_data_20_Methotrexate$lower_bound_pred[merged_data_20_Methotrexate$lower_bound_pred <= 0] <- 1e-10
merged_data_20_Methotrexate$lower_bound_real[merged_data_20_Methotrexate$lower_bound_real <= 0] <- 1e-10
merged_data_20_Methotrexate$upper_bound_pred[merged_data_20_Methotrexate$upper_bound_pred <= 0] <- 1e-10
merged_data_20_Methotrexate$upper_bound_real[merged_data_20_Methotrexate$upper_bound_real <= 0] <- 1e-10

##and for NULL model:
# Create lower and upper bounds considering mean ¬± sd
merged_data_20_Methotrexate_NULL$lower_bound_null <- merged_data_20_Methotrexate_NULL$mean_rel_ab.null - merged_data_20_Methotrexate_NULL$sd_rel_ab.null
merged_data_20_Methotrexate_NULL$upper_bound_null <- merged_data_20_Methotrexate_NULL$mean_rel_ab.null + merged_data_20_Methotrexate_NULL$sd_rel_ab.null
merged_data_20_Methotrexate_NULL$lower_bound_real <- merged_data_20_Methotrexate_NULL$mean_rel_ab.real - merged_data_20_Methotrexate_NULL$sd_rel_ab.real
merged_data_20_Methotrexate_NULL$upper_bound_real <- merged_data_20_Methotrexate_NULL$mean_rel_ab.real + merged_data_20_Methotrexate_NULL$sd_rel_ab.real

# Ensure lower and upper bounds are non-negative, adjusting as necessary
merged_data_20_Methotrexate_NULL$lower_bound_null[merged_data_20_Methotrexate_NULL$lower_bound_null <= 0] <- 1e-10
merged_data_20_Methotrexate_NULL$lower_bound_real[merged_data_20_Methotrexate_NULL$lower_bound_real <= 0] <- 1e-10
merged_data_20_Methotrexate_NULL$upper_bound_null[merged_data_20_Methotrexate_NULL$upper_bound_null <= 0] <- 1e-10
merged_data_20_Methotrexate_NULL$upper_bound_real[merged_data_20_Methotrexate_NULL$upper_bound_real <= 0] <- 1e-10

# Filter to include only species with a mean relative abundance > 0.01 in the 'real' dataset
significant_species <- merged_data_20_Methotrexate[merged_data_20_Methotrexate$mean_rel_ab.real > 0.01, ]
survivors_20_Methotrexate <- nrow(significant_species)
survivors_20_Methotrexate

#should be the same as survivors defined above, since it is calculated from .real
significant_species_NULL <- merged_data_20_Methotrexate_NULL[merged_data_20_Methotrexate_NULL$mean_rel_ab.real > 0.01, ]
survivors_20_Methotrexate_NULL <- nrow(significant_species_NULL)
survivors_20_Methotrexate_NULL

# Adjusted order of magnitude check to include SD, only for significant species
significant_species$Predicted_magnitude_correct <- ifelse(
  (floor(log10(significant_species$lower_bound_pred)) <= floor(log10(significant_species$upper_bound_real)) &
     floor(log10(significant_species$upper_bound_pred)) >= floor(log10(significant_species$lower_bound_real))),
  1,
  0
)

#and for the Null model:
significant_species_NULL$Predicted_magnitude_correct <- ifelse(
  (floor(log10(significant_species_NULL$lower_bound_null)) <= floor(log10(significant_species_NULL$upper_bound_real)) &
     floor(log10(significant_species_NULL$upper_bound_null)) >= floor(log10(significant_species_NULL$lower_bound_real))),
  1,
  0
)

# Calculate the fraction of correctly predicted magnitudes for significant species
predicted_magnitude_correct_fraction_20_Methotrexate <- sum(significant_species$Predicted_magnitude_correct) / nrow(significant_species)
predicted_magnitude_correct_fraction_20_Methotrexate

predicted_magnitude_correct_fraction_20_Methotrexate_NULL <- sum(significant_species_NULL$Predicted_magnitude_correct) / nrow(significant_species_NULL)
predicted_magnitude_correct_fraction_20_Methotrexate_NULL

top_species_missing_20_Methotrexate <- setdiff(top6_real_20_Methotrexate_means, top6_predicted_20_Methotrexate_means)
top_species_wrong_20_Methotrexate <- setdiff(top6_predicted_20_Methotrexate_means, top6_real_20_Methotrexate_means)

Prediction_quality_20_Methotrexate <- data.frame(
  Top_six_correct = paste(top_six_correct_20_Methotrexate, sep=""),
  Top_six_correct_NULL = paste(top_six_correct_20_Methotrexate_NULL, sep=""),
  Top_six_correct_means = paste(top_six_correct_20_Methotrexate_means, sep=""),
  Top_six_correct_means_NULL = paste(top_six_correct_20_Methotrexate_means_NULL, sep=""),
  Predicted_magnitude_correct = paste(round(predicted_magnitude_correct_fraction_20_Methotrexate * 100, 2), "%", sep=""),
  Predicted_magnitude_correct_NULL = paste(round(predicted_magnitude_correct_fraction_20_Methotrexate_NULL * 100, 2), "%", sep=""),
  survivors_total = survivors_20_Methotrexate,
  top_species_missing <- top_species_missing_20_Methotrexate,
  top_species_wrong <- top_species_wrong_20_Methotrexate, 
  predicted_mean_final_OD <- predicted_mean_final_od_20_Methotrexate,
  real_mean_final_OD <- real_mean_final_od_20_Methotrexate,
  sims_total = length(successful_sim_ids)
)

Prediction_quality_20_Methotrexate






##Next, for 80 uM:
# Get top 6 species from plot_data_80_endpoint
# Adjust the plot_data_80_endpoint with confidence bounds
plot_data_80_Methotrexate_endpoint <- plot_data_80_Methotrexate_endpoint %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)

# Adjust the Methotrexate_16S_80uM_summarised with confidence bounds
Methotrexate_16S_80uM_summarised <- Methotrexate_16S_80uM_summarised %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)

#NULL model:
Null_model_summarised <- Niclosamide_16S_0uM_summarised %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)


# Get top 6 species based on the lower bound from plot_data_80_endpoint
top6_predicted_80_Methotrexate <- plot_data_80_Methotrexate_endpoint %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

# Get top 6 species based on the lower bound from Methotrexate_16S_80uM_summarised
top6_real_80_Methotrexate <- Methotrexate_16S_80uM_summarised %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

top6_NULL <- Null_model_summarised %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

# Calculate the overlap of top 6 species
top_six_correct_80_Methotrexate <- length(intersect(top6_predicted_80_Methotrexate, top6_real_80_Methotrexate))
#top_six_correct_80_Methotrexate

top_six_correct_80_Methotrexate_NULL <- length(intersect(top6_NULL, top6_real_80_Methotrexate))
#top_six_correct_80_Methotrexate_NULL

#top6_predicted_80_Methotrexate
#top6_real_80_Methotrexate




#Now by means:
top6_predicted_80_Methotrexate_means <- plot_data_80_Methotrexate_endpoint %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)

# Get top 6 species based on the lower bound from Methotrexate_16S_80uM_summarised
top6_real_80_Methotrexate_means <- Methotrexate_16S_80uM_summarised %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)

top6_NULL_means <- Null_model_summarised %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)



top_six_correct_80_Methotrexate_means <- length(intersect(top6_predicted_80_Methotrexate_means, top6_real_80_Methotrexate_means))
#top_six_correct_80_Methotrexate_means

top_six_correct_80_Methotrexate_means_NULL <- length(intersect(top6_NULL_means, top6_real_80_Methotrexate_means))
#top_six_correct_80_Methotrexate_means_NULL

#top6_predicted_80_Methotrexate_means
#top6_real_80_Methotrexate_means




# Merge dataframes by Species
merged_data_80_Methotrexate <- merge(plot_data_80_Methotrexate_endpoint, Methotrexate_16S_80uM_summarised, by = "Species", suffixes = c(".pred", ".real"))
merged_data_80_Methotrexate_NULL <- merge(Niclosamide_16S_0uM_summarised, Methotrexate_16S_80uM_summarised, by = "Species", suffixes = c(".null", ".real"))



# Create lower and upper bounds considering mean ¬± sd
merged_data_80_Methotrexate$lower_bound_pred <- merged_data_80_Methotrexate$mean_rel_ab.pred - merged_data_80_Methotrexate$sd_rel_ab.pred
merged_data_80_Methotrexate$upper_bound_pred <- merged_data_80_Methotrexate$mean_rel_ab.pred + merged_data_80_Methotrexate$sd_rel_ab.pred
merged_data_80_Methotrexate$lower_bound_real <- merged_data_80_Methotrexate$mean_rel_ab.real - merged_data_80_Methotrexate$sd_rel_ab.real
merged_data_80_Methotrexate$upper_bound_real <- merged_data_80_Methotrexate$mean_rel_ab.real + merged_data_80_Methotrexate$sd_rel_ab.real

# Ensure lower and upper bounds are non-negative, adjusting as necessary
merged_data_80_Methotrexate$lower_bound_pred[merged_data_80_Methotrexate$lower_bound_pred <= 0] <- 1e-10
merged_data_80_Methotrexate$lower_bound_real[merged_data_80_Methotrexate$lower_bound_real <= 0] <- 1e-10
merged_data_80_Methotrexate$upper_bound_pred[merged_data_80_Methotrexate$upper_bound_pred <= 0] <- 1e-10
merged_data_80_Methotrexate$upper_bound_real[merged_data_80_Methotrexate$upper_bound_real <= 0] <- 1e-10

##and for NULL model:
# Create lower and upper bounds considering mean ¬± sd
merged_data_80_Methotrexate_NULL$lower_bound_null <- merged_data_80_Methotrexate_NULL$mean_rel_ab.null - merged_data_80_Methotrexate_NULL$sd_rel_ab.null
merged_data_80_Methotrexate_NULL$upper_bound_null <- merged_data_80_Methotrexate_NULL$mean_rel_ab.null + merged_data_80_Methotrexate_NULL$sd_rel_ab.null
merged_data_80_Methotrexate_NULL$lower_bound_real <- merged_data_80_Methotrexate_NULL$mean_rel_ab.real - merged_data_80_Methotrexate_NULL$sd_rel_ab.real
merged_data_80_Methotrexate_NULL$upper_bound_real <- merged_data_80_Methotrexate_NULL$mean_rel_ab.real + merged_data_80_Methotrexate_NULL$sd_rel_ab.real

# Ensure lower and upper bounds are non-negative, adjusting as necessary
merged_data_80_Methotrexate_NULL$lower_bound_null[merged_data_80_Methotrexate_NULL$lower_bound_null <= 0] <- 1e-10
merged_data_80_Methotrexate_NULL$lower_bound_real[merged_data_80_Methotrexate_NULL$lower_bound_real <= 0] <- 1e-10
merged_data_80_Methotrexate_NULL$upper_bound_null[merged_data_80_Methotrexate_NULL$upper_bound_null <= 0] <- 1e-10
merged_data_80_Methotrexate_NULL$upper_bound_real[merged_data_80_Methotrexate_NULL$upper_bound_real <= 0] <- 1e-10

# Filter to include only species with a mean relative abundance > 0.01 in the 'real' dataset
significant_species <- merged_data_80_Methotrexate[merged_data_80_Methotrexate$mean_rel_ab.real > 0.01, ]
survivors_80_Methotrexate <- nrow(significant_species)
survivors_80_Methotrexate

#should be the same as survivors defined above, since it is calculated from .real
significant_species_NULL <- merged_data_80_Methotrexate_NULL[merged_data_80_Methotrexate_NULL$mean_rel_ab.real > 0.01, ]
survivors_80_Methotrexate_NULL <- nrow(significant_species_NULL)
survivors_80_Methotrexate_NULL

# Adjusted order of magnitude check to include SD, only for significant species
significant_species$Predicted_magnitude_correct <- ifelse(
  (floor(log10(significant_species$lower_bound_pred)) <= floor(log10(significant_species$upper_bound_real)) &
     floor(log10(significant_species$upper_bound_pred)) >= floor(log10(significant_species$lower_bound_real))),
  1,
  0
)

#and for the Null model:
significant_species_NULL$Predicted_magnitude_correct <- ifelse(
  (floor(log10(significant_species_NULL$lower_bound_null)) <= floor(log10(significant_species_NULL$upper_bound_real)) &
     floor(log10(significant_species_NULL$upper_bound_null)) >= floor(log10(significant_species_NULL$lower_bound_real))),
  1,
  0
)

# Calculate the fraction of correctly predicted magnitudes for significant species
predicted_magnitude_correct_fraction_80_Methotrexate <- sum(significant_species$Predicted_magnitude_correct) / nrow(significant_species)
predicted_magnitude_correct_fraction_80_Methotrexate

predicted_magnitude_correct_fraction_80_Methotrexate_NULL <- sum(significant_species_NULL$Predicted_magnitude_correct) / nrow(significant_species_NULL)
predicted_magnitude_correct_fraction_80_Methotrexate_NULL


top_species_missing_80_Methotrexate <- setdiff(top6_real_80_Methotrexate_means, top6_predicted_80_Methotrexate_means)
top_species_wrong_80_Methotrexate <- setdiff(top6_predicted_80_Methotrexate_means, top6_real_80_Methotrexate_means)

Prediction_quality_80_Methotrexate <- data.frame(
  Top_six_correct = paste(top_six_correct_80_Methotrexate, sep=""),
  Top_six_correct_NULL = paste(top_six_correct_80_Methotrexate_NULL, sep=""),
  Top_six_correct_means = paste(top_six_correct_80_Methotrexate_means, sep=""),
  Top_six_correct_means_NULL = paste(top_six_correct_80_Methotrexate_means_NULL, sep=""),
  Predicted_magnitude_correct = paste(round(predicted_magnitude_correct_fraction_80_Methotrexate * 100, 2), "%", sep=""),
  Predicted_magnitude_correct_NULL = paste(round(predicted_magnitude_correct_fraction_80_Methotrexate_NULL * 100, 2), "%", sep=""),
  survivors_total = survivors_80_Methotrexate,
  top_species_missing <- top_species_missing_80_Methotrexate,
  top_species_wrong <- top_species_wrong_80_Methotrexate, 
  predicted_mean_final_OD <- predicted_mean_final_od_80_Methotrexate,
  real_mean_final_OD <- real_mean_final_od_80_Methotrexate,
  sims_total = length(successful_sim_ids)
)

Prediction_quality_80_Methotrexate









##Niclosamide

combined_monoculture_aucs2_Niclosamide <- subset(combined_monoculture_aucs2, drug == "Niclosamide")


#drug sensitivity terms: define once outside of ODEs
y_function_B_vulgatus_Niclosamide <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("B_vulgatus", "Niclosamide", best_fitting_models_df_Niclosamide)), collapse = " ")))
y_function_B_uniformis_Niclosamide <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("B_uniformis", "Niclosamide", best_fitting_models_df_Niclosamide)), collapse = " ")))
y_function_B_fragilis_Niclosamide <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("B_fragilis", "Niclosamide", best_fitting_models_df_Niclosamide)), collapse = " ")))
y_function_B_thetaiotaomicron_Niclosamide <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("B_thetaiotaomicron", "Niclosamide", best_fitting_models_df_Niclosamide)), collapse = " ")))
y_function_C_ramosum_Niclosamide <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("C_ramosum", "Niclosamide", best_fitting_models_df_Niclosamide)), collapse = " ")))
y_function_E_rectale_Niclosamide <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("E_rectale", "Niclosamide", best_fitting_models_df_Niclosamide)), collapse = " ")))
y_function_R_intestinalis_Niclosamide <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("R_intestinalis", "Niclosamide", best_fitting_models_df_Niclosamide)), collapse = " ")))
y_function_V_parvula_Niclosamide <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("V_parvula", "Niclosamide", best_fitting_models_df_Niclosamide)), collapse = " ")))
y_function_E_lenta_Niclosamide <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("E_lenta", "Niclosamide", best_fitting_models_df_Niclosamide)), collapse = " ")))
y_function_F_nucleatum_Niclosamide <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("F_nucleatum", "Niclosamide", best_fitting_models_df_Niclosamide)), collapse = " ")))
y_function_C_bolteae_Niclosamide <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("C_bolteae", "Niclosamide", best_fitting_models_df_Niclosamide)), collapse = " ")))
y_function_C_perfringens_Niclosamide <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("C_perfringens", "Niclosamide", best_fitting_models_df_Niclosamide)), collapse = " ")))
y_function_C_saccharolyticum_Niclosamide <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("C_saccharolyticum", "Niclosamide", best_fitting_models_df_Niclosamide)), collapse = " ")))
y_function_S_salivarius_Niclosamide <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("S_salivarius", "Niclosamide", best_fitting_models_df_Niclosamide)), collapse = " ")))
y_function_R_gnavus_Niclosamide <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("R_gnavus", "Niclosamide", best_fitting_models_df_Niclosamide)), collapse = " ")))
y_function_C_comes_Niclosamide <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("C_comes", "Niclosamide", best_fitting_models_df_Niclosamide)), collapse = " ")))
y_function_P_merdae_Niclosamide <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("P_merdae", "Niclosamide", best_fitting_models_df_Niclosamide)), collapse = " ")))
y_function_S_parasanguinis_Niclosamide <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("S_parasanguinis", "Niclosamide", best_fitting_models_df_Niclosamide)), collapse = " ")))
y_function_C_aerofaciens_Niclosamide <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("C_aerofaciens", "Niclosamide", best_fitting_models_df_Niclosamide)), collapse = " ")))
y_function_D_formicigenerans_Niclosamide <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("D_formicigenerans", "Niclosamide", best_fitting_models_df_Niclosamide)), collapse = " ")))
y_function_E_coli_Niclosamide <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("E_coli", "Niclosamide", best_fitting_models_df_Niclosamide)), collapse = " ")))



y_function_B_vulgatus_Niclosamide_func <- eval(parse(text = paste("function(Drug) {", y_function_B_vulgatus_Niclosamide, "}")))
y_function_B_uniformis_Niclosamide_func <- eval(parse(text = paste("function(Drug) {", y_function_B_uniformis_Niclosamide, "}")))
y_function_B_fragilis_Niclosamide_func <- eval(parse(text = paste("function(Drug) {", y_function_B_fragilis_Niclosamide, "}")))
y_function_B_thetaiotaomicron_Niclosamide_func <- eval(parse(text = paste("function(Drug) {", y_function_B_thetaiotaomicron_Niclosamide, "}")))
y_function_C_ramosum_Niclosamide_func <- eval(parse(text = paste("function(Drug) {", y_function_C_ramosum_Niclosamide, "}")))
y_function_E_rectale_Niclosamide_func <- eval(parse(text = paste("function(Drug) {", y_function_E_rectale_Niclosamide, "}")))
y_function_R_intestinalis_Niclosamide_func <- eval(parse(text = paste("function(Drug) {", y_function_R_intestinalis_Niclosamide, "}")))
y_function_E_lenta_Niclosamide_func <- eval(parse(text = paste("function(Drug) {", y_function_E_lenta_Niclosamide, "}")))
y_function_F_nucleatum_Niclosamide_func <- eval(parse(text = paste("function(Drug) {", y_function_F_nucleatum_Niclosamide, "}")))
y_function_C_bolteae_Niclosamide_func <- eval(parse(text = paste("function(Drug) {", y_function_C_bolteae_Niclosamide, "}")))
y_function_C_perfringens_Niclosamide_func <- eval(parse(text = paste("function(Drug) {", y_function_C_perfringens_Niclosamide, "}")))
y_function_C_saccharolyticum_Niclosamide_func <- eval(parse(text = paste("function(Drug) {", y_function_C_saccharolyticum_Niclosamide, "}")))
y_function_S_salivarius_Niclosamide_func <- eval(parse(text = paste("function(Drug) {", y_function_S_salivarius_Niclosamide, "}")))
y_function_R_gnavus_Niclosamide_func <- eval(parse(text = paste("function(Drug) {", y_function_R_gnavus_Niclosamide, "}")))
y_function_C_comes_Niclosamide_func <- eval(parse(text = paste("function(Drug) {", y_function_C_comes_Niclosamide, "}")))
y_function_P_merdae_Niclosamide_func <- eval(parse(text = paste("function(Drug) {", y_function_P_merdae_Niclosamide, "}")))
y_function_S_parasanguinis_Niclosamide_func <- eval(parse(text = paste("function(Drug) {", y_function_S_parasanguinis_Niclosamide, "}")))
y_function_C_aerofaciens_Niclosamide_func <- eval(parse(text = paste("function(Drug) {", y_function_C_aerofaciens_Niclosamide, "}")))
y_function_D_formicigenerans_Niclosamide_func <- eval(parse(text = paste("function(Drug) {", y_function_D_formicigenerans_Niclosamide, "}")))
y_function_E_coli_Niclosamide_func <- eval(parse(text = paste("function(Drug) {", y_function_E_coli_Niclosamide, "}")))
y_function_V_parvula_Niclosamide_func <- eval(parse(text = paste("function(Drug) {", y_function_V_parvula_Niclosamide, "}")))



unique(combined_monoculture_aucs2_Niclosamide$conc)
#only subset for tested non-zero concentrations (since Niclosamide is a drug with much more tested monoculture concentrations than co-culture concentrations):
combined_monoculture_aucs2_Niclosamide <- subset(combined_monoculture_aucs2_Niclosamide, conc %in% c(20, 80, 160))
##dictate drug concentration tested for simulation cycle here:
#drug_concentration_tested <- 20 #if manually or:
drug_concentration_tested <- unique(combined_monoculture_aucs2_Niclosamide$conc)[1] 
initial_conditions <- rep(0.01/32, 32)
initial_conditions <- c(initial_conditions, drug_concentration_tested)


##drug effect fitted for species showing sensitivity in monoculture:
#unique(combined_monoculture_aucs2_Niclosamide$Species)

##for more simple linear fits
closed.sir.model_Niclosamide <- function (t, x, params) {
  ## first extract the state variables
  A_muciniphila <- x[1]
  B_adolescentis <- x[2]
  B_fragilis <- x[3]
  B_longum <- x[4]
  B_obeum <- x[5]
  B_thetaiotaomicron <- x[6]
  B_uniformis <- x[7]
  B_vulgatus <- x[8]
  B_wadsworthia <- x[9]
  C_aerofaciens <- x[10]
  C_bolteae <- x[11]
  C_comes <- x[12]
  C_perfringens <- x[13]
  C_ramosum <- x[14]
  C_saccharolyticum <- x[15]
  D_formicigenerans <- x[16]
  E_coli <- x[17]
  E_lenta <- x[18]
  E_rectale <- x[19]
  F_nucleatum <- x[20]
  L_paracasei <- x[21]
  O_splanchnicus <- x[22]
  P_copri <- x[23]
  P_distasonis <- x[24]
  P_merdae <- x[25]
  R_bromii <- x[26]
  R_gnavus <- x[27]
  R_intestinalis <- x[28]
  R_torques <- x[29]
  S_parasanguinis <- x[30]
  S_salivarius <- x[31]
  V_parvula <- x[32]
  Drug <- x[33]
  
  
  ## now extract the parameters
  r_B_fragilis <- flat_params[["B._fragilis.r"]]
  K_B_fragilis <- flat_params[["B._fragilis.K"]]
  r_B_longum <- flat_params[["B._longum.r"]]
  K_B_longum <- flat_params[["B._longum.K"]]
  r_B_thetaiotaomicron <- flat_params[["B._thetaiotaomicron.r"]]
  K_B_thetaiotaomicron <- flat_params[["B._thetaiotaomicron.K"]]
  r_B_uniformis <- flat_params[["B._uniformis.r"]]
  K_B_uniformis <- flat_params[["B._uniformis.K"]]
  r_B_vulgatus <- flat_params[["B._vulgatus.r"]]
  K_B_vulgatus <- flat_params[["B._vulgatus.K"]]
  r_B_wadsworthia <- flat_params[["B._wadsworthia.r"]]
  K_B_wadsworthia <- flat_params[["B._wadsworthia.K"]]
  r_C_aerofaciens <- flat_params[["C._aerofaciens.r"]]
  K_C_aerofaciens <- flat_params[["C._aerofaciens.K"]]
  r_C_bolteae <- flat_params[["C._bolteae.r"]]
  K_C_bolteae <- flat_params[["C._bolteae.K"]]
  r_C_comes <- flat_params[["C._comes.r"]]
  K_C_comes <- flat_params[["C._comes.K"]]
  r_C_perfringens <- flat_params[["C._perfringens.r"]]
  K_C_perfringens <- flat_params[["C._perfringens.K"]]
  r_C_ramosum <- flat_params[["C._ramosum.r"]]
  K_C_ramosum <- flat_params[["C._ramosum.K"]]
  r_C_saccharolyticum <- flat_params[["C._saccharolyticum.r"]]
  K_C_saccharolyticum <- flat_params[["C._saccharolyticum.K"]]
  r_D_formicigenerans <- flat_params[["D._formicigenerans.r"]]
  K_D_formicigenerans <- flat_params[["D._formicigenerans.K"]]
  r_E_coli <- flat_params[["E._coli.r"]]
  K_E_coli <- flat_params[["E._coli.K"]]
  r_E_lenta <- flat_params[["E._lenta.r"]]
  K_E_lenta <- flat_params[["E._lenta.K"]]
  r_E_rectale <- flat_params[["E._rectale.r"]]
  K_E_rectale <- flat_params[["E._rectale.K"]]
  r_F_nucleatum <- flat_params[["F._nucleatum.r"]]
  K_F_nucleatum <- flat_params[["F._nucleatum.K"]]
  r_P_copri <- flat_params[["P._copri.r"]]
  K_P_copri <- flat_params[["P._copri.K"]]
  r_P_merdae <- flat_params[["P._merdae.r"]]
  K_P_merdae <- flat_params[["P._merdae.K"]]
  r_R_gnavus <- flat_params[["R._gnavus.r"]]
  K_R_gnavus <- flat_params[["R._gnavus.K"]]
  r_R_intestinalis <- flat_params[["R._intestinalis.r"]]
  K_R_intestinalis <- flat_params[["R._intestinalis.K"]]
  r_V_parvula <- flat_params[["V._parvula.r"]]
  K_V_parvula <- flat_params[["V._parvula.K"]]
  r_A_muciniphila <- flat_params[["A._muciniphila.r"]]
  K_A_muciniphila <- flat_params[["A._muciniphila.K"]]
  r_B_adolescentis <- flat_params[["B._adolescentis.r"]]
  K_B_adolescentis <- flat_params[["B._adolescentis.K"]]
  r_B_obeum <- flat_params[["B._obeum.r"]]
  K_B_obeum <- flat_params[["B._obeum.K"]]
  r_O_splanchnicus <- flat_params[["O._splanchnicus.r"]]
  K_O_splanchnicus <- flat_params[["O._splanchnicus.K"]]
  r_P_distasonis <- flat_params[["P._distasonis.r"]]
  K_P_distasonis <- flat_params[["P._distasonis.K"]]
  r_R_bromii <- flat_params[["R._bromii.r"]]
  K_R_bromii <- flat_params[["R._bromii.K"]]
  r_R_torques <- flat_params[["R._torques.r"]]
  K_R_torques <- flat_params[["R._torques.K"]]
  r_S_parasanguinis <- flat_params[["S._parasanguinis.r"]]
  K_S_parasanguinis <-flat_params[["S._parasanguinis.K"]]
  r_S_salivarius <- flat_params[["S._salivarius.r"]]
  K_S_salivarius <- flat_params[["S._salivarius.K"]]
  r_L_paracasei <- flat_params[["L._paracasei.r"]]
  K_L_paracasei <- flat_params[["L._paracasei.K"]]
  
  
  t_mod <- ifelse(t > 24.1, t - 24.1, t)
  
  
  ## now code the model equations
  dA_muciniphila_dt <- r_A_muciniphila * A_muciniphila * (1 - A_muciniphila / K_A_muciniphila)
  dB_adolescentis_dt <- r_B_adolescentis * B_adolescentis * (1 - B_adolescentis / K_B_adolescentis)
  dB_fragilis_dt <- r_B_fragilis * B_fragilis * (1 - B_fragilis / max(0.0001, K_B_fragilis * (y_function_B_fragilis_Niclosamide_func(Drug))))
  dB_longum_dt <- r_B_longum * B_longum * (1 - B_longum / K_B_longum)
  dB_obeum_dt <- r_B_obeum * B_obeum * (1 - B_obeum / K_B_obeum)
  dB_thetaiotaomicron_dt <- r_B_thetaiotaomicron * B_thetaiotaomicron * (1 - B_thetaiotaomicron / max(0.0001, K_B_thetaiotaomicron * (y_function_B_thetaiotaomicron_Niclosamide_func(Drug))))  
  dB_uniformis_dt <- r_B_uniformis * B_uniformis * (1 - B_uniformis / max(0.0001, K_B_uniformis * (y_function_B_uniformis_Niclosamide_func(Drug))))
  dB_vulgatus_dt <- r_B_vulgatus * B_vulgatus * (1 - B_vulgatus / max(0.0001, K_B_vulgatus * (y_function_B_vulgatus_Niclosamide_func(Drug))))
  dB_wadsworthia_dt <- r_B_wadsworthia * B_wadsworthia * (1 - B_wadsworthia / K_B_wadsworthia)
  dC_aerofaciens_dt <- r_C_aerofaciens * C_aerofaciens * (1 - C_aerofaciens / max(0.0001, K_C_aerofaciens * (y_function_C_aerofaciens_Niclosamide_func(Drug))))
  dC_bolteae_dt <- r_C_bolteae * C_bolteae * (1 - C_bolteae /  max(0.0001, K_C_bolteae * (y_function_C_bolteae_Niclosamide_func(Drug))))
  dC_comes_dt <- r_C_comes * C_comes * (1 - C_comes / max(0.0001, K_C_comes * (y_function_C_comes_Niclosamide_func(Drug))))
  dC_perfringens_dt <- r_C_perfringens * C_perfringens * (1 - C_perfringens / max(0.0001, K_C_perfringens * (y_function_C_perfringens_Niclosamide_func(Drug))))
  dC_ramosum_dt <- r_C_ramosum * C_ramosum * (1 - C_ramosum / max(0.0001, K_C_ramosum * (y_function_C_ramosum_Niclosamide_func(Drug))))
  dC_saccharolyticum_dt <- r_C_saccharolyticum * C_saccharolyticum * (1 - C_saccharolyticum / max(0.0001, K_C_saccharolyticum * (y_function_C_saccharolyticum_Niclosamide_func(Drug))))
  dD_formicigenerans_dt <- r_D_formicigenerans * D_formicigenerans * (1 - D_formicigenerans / max(0.0001, K_D_formicigenerans * (y_function_D_formicigenerans_Niclosamide_func(Drug))))
  dE_coli_dt <- r_E_coli * E_coli * (1 - E_coli / max(0.0001, K_E_coli * (y_function_E_coli_Niclosamide_func(Drug))))
  dE_lenta_dt <- r_E_lenta * E_lenta * (1 - E_lenta / max(0.0001, K_E_lenta * (y_function_E_lenta_Niclosamide_func(Drug))))
  dE_rectale_dt <- r_E_rectale * E_rectale * (1 - E_rectale / max(0.0001, K_E_rectale * (y_function_E_rectale_Niclosamide_func(Drug))))
  dF_nucleatum_dt <- r_F_nucleatum * F_nucleatum * (1 - F_nucleatum / max(0.0001, K_F_nucleatum * (y_function_F_nucleatum_Niclosamide_func(Drug))))
  dL_paracasei_dt <- r_L_paracasei * L_paracasei * (1 - L_paracasei / K_L_paracasei)  
  dO_splanchnicus_dt <- r_O_splanchnicus * O_splanchnicus * (1 - O_splanchnicus / K_O_splanchnicus)  
  dP_copri_dt <- r_P_copri * P_copri * (1 - P_copri / K_P_copri)
  dP_distasonis_dt <- r_P_distasonis * P_distasonis * (1 - P_distasonis / K_P_distasonis)  
  dP_merdae_dt <- r_P_merdae * P_merdae * (1 - P_merdae / max(0.0001, K_P_merdae * (y_function_P_merdae_Niclosamide_func(Drug))))
  dR_bromii_dt <- r_R_bromii * R_bromii * (1 - R_bromii / K_R_bromii) 
  dR_gnavus_dt <- r_R_gnavus * R_gnavus * (1 - R_gnavus / max(0.0001, K_R_gnavus * (y_function_R_gnavus_Niclosamide_func(Drug))))
  dR_intestinalis_dt <- r_R_intestinalis * R_intestinalis * (1 - R_intestinalis / max(0.0001, K_R_intestinalis * (y_function_R_intestinalis_Niclosamide_func(Drug))))
  dR_torques_dt <- r_R_torques * R_torques * (1 - R_torques /K_R_torques) 
  dS_parasanguinis_dt <- r_S_parasanguinis * S_parasanguinis * (1 - S_parasanguinis / max(0.0001, K_S_parasanguinis * (y_function_S_parasanguinis_Niclosamide_func(Drug))))
  dS_salivarius_dt <- r_S_salivarius * S_salivarius * (1 - S_salivarius / max(0.0001, K_S_salivarius * (y_function_S_salivarius_Niclosamide_func(Drug))))
  dV_parvula_dt <- r_V_parvula * V_parvula * (1 - V_parvula / max(0.0001, K_V_parvula * (y_function_V_parvula_Niclosamide_func(Drug))))
  
  
  
  #Drug differential:
  dDrug_dt <- (subset(drug_dynamics, Drug == "Niclosamide")$Steepness_param_community * exp(-subset(drug_dynamics, Drug == "Niclosamide")$Steepness_param_community * t_mod)) * (drug_concentration_tested * prop_left_Niclosamide - drug_concentration_tested)
  #dDrug_dt <- 0
  
  ## Combine results into a single vector
  dxdt <- c(dA_muciniphila_dt, dB_adolescentis_dt, dB_fragilis_dt, dB_longum_dt, dB_obeum_dt, dB_thetaiotaomicron_dt, dB_uniformis_dt, dB_vulgatus_dt, dB_wadsworthia_dt, dC_aerofaciens_dt, dC_bolteae_dt, dC_comes_dt, dC_perfringens_dt, dC_ramosum_dt, dC_saccharolyticum_dt, dD_formicigenerans_dt, dE_coli_dt, dE_lenta_dt, dE_rectale_dt, dF_nucleatum_dt, dL_paracasei_dt, dO_splanchnicus_dt, dP_copri_dt, dP_distasonis_dt, dP_merdae_dt, dR_bromii_dt, dR_gnavus_dt, dR_intestinalis_dt, dR_torques_dt, dS_parasanguinis_dt, dS_salivarius_dt, dV_parvula_dt, dDrug_dt)
  
  ## Return result as a list
  list(dxdt)
}




#calculate the co-culture correction factor per species based on community composition in absence of drug, just like done for Niclosamide

growth_data_all_0_Niclosamide
growth_data_all_0_Niclosamide1 <- growth_data_all_0_Niclosamide %>%
  dplyr::mutate(Species = gsub(" ", "_", Species))


# Merge rel_ab_control with growth_data_all_0_Niclosamide on Species
# Function to remove duplicated columns by name pattern
clean_columns_base <- function(df, pattern) {
  cols_to_keep <- !grepl(pattern, names(df))
  df <- df[, cols_to_keep]
  return(df)
}

# Use the new function to clean up your dataframe
rel_ab_control <- clean_columns_base(rel_ab_control, "mean_max_OD.[xy]")
str(rel_ab_control)


#rel_ab_control$correction_factor <- rel_ab_control$mean_rel_ab / (rel_ab_control$mean_max_OD/sum(rel_ab_control$mean_max_OD))
# Calculate correction factor with a minimum value of ~1
rel_ab_control$correction_factor <- pmax(rel_ab_control$mean_rel_ab / (rel_ab_control$mean_max_OD / sum(rel_ab_control$mean_max_OD)), 1.1)


# Create a new dataframe for co-culture correction
co_culture_correction <- data.frame(
  species = rel_ab_control$Species,
  correction_factor = rel_ab_control$correction_factor
)


#summarise community data
#Adjust based on tested concentrations for each drug
unique(Community_compositions_focus_drugs_Niclosamide$concentration)

Community_compositions_focus_drugs_Niclosamide_160uM <- subset(Community_compositions_focus_drugs_Niclosamide, concentration == 160)
Community_compositions_focus_drugs_Niclosamide_20uM <- subset(Community_compositions_focus_drugs_Niclosamide, concentration == 20)
Community_compositions_focus_drugs_Niclosamide_80uM <- subset(Community_compositions_focus_drugs_Niclosamide, concentration == 80)


#160 uM
Community_compositions_focus_drugs_Niclosamide_160uM_summarised <- Community_compositions_focus_drugs_Niclosamide_160uM %>%
  dplyr::group_by(species) %>%                                  
  dplyr::summarize(
    mean_rel_ab = mean(rel_abundance, na.rm = TRUE),     
    sd_rel_ab = sd(rel_abundance, na.rm = TRUE) ,
    mean_max_OD = mean(maxOD, na.rm = TRUE),
    sd_max_OD = sd(maxOD, na.rm = TRUE),
    mean_final_OD = mean(finalOD, na.rm = TRUE),
    sd_final_OD = sd(finalOD, na.rm = TRUE)
  ) %>%
  dplyr::ungroup() 


Community_compositions_focus_drugs_Niclosamide_160uM_summarised <- Community_compositions_focus_drugs_Niclosamide_160uM_summarised %>%
  dplyr::mutate(Species = sub("^(\\w)\\w*\\s(.*)", "\\1._\\2", species))

#remove (sub)strain info
Community_compositions_focus_drugs_Niclosamide_160uM_summarised <- Community_compositions_focus_drugs_Niclosamide_160uM_summarised %>%
  dplyr::mutate(Species = sub("^(\\w\\._\\w+).*", "\\1", Species))


#20 uM
Community_compositions_focus_drugs_Niclosamide_20uM_summarised <- Community_compositions_focus_drugs_Niclosamide_20uM %>%
  dplyr::group_by(species) %>%                                  
  dplyr::summarize(
    mean_rel_ab = mean(rel_abundance, na.rm = TRUE),     
    sd_rel_ab = sd(rel_abundance, na.rm = TRUE) ,
    mean_max_OD = mean(maxOD, na.rm = TRUE),
    sd_max_OD = sd(maxOD, na.rm = TRUE),
    mean_final_OD = mean(finalOD, na.rm = TRUE),
    sd_final_OD = sd(finalOD, na.rm = TRUE)
  ) %>%
  dplyr::ungroup() 


Community_compositions_focus_drugs_Niclosamide_20uM_summarised <- Community_compositions_focus_drugs_Niclosamide_20uM_summarised %>%
  dplyr::mutate(Species = sub("^(\\w)\\w*\\s(.*)", "\\1._\\2", species))

#remove (sub)strain info
Community_compositions_focus_drugs_Niclosamide_20uM_summarised <- Community_compositions_focus_drugs_Niclosamide_20uM_summarised %>%
  dplyr::mutate(Species = sub("^(\\w\\._\\w+).*", "\\1", Species))


#80 uM
Community_compositions_focus_drugs_Niclosamide_80uM_summarised <- Community_compositions_focus_drugs_Niclosamide_80uM %>%
  dplyr::group_by(species) %>%                                  
  dplyr::summarize(
    mean_rel_ab = mean(rel_abundance, na.rm = TRUE),     
    sd_rel_ab = sd(rel_abundance, na.rm = TRUE) ,
    mean_max_OD = mean(maxOD, na.rm = TRUE),
    sd_max_OD = sd(maxOD, na.rm = TRUE),    
    mean_final_OD = mean(finalOD, na.rm = TRUE),
    sd_final_OD = sd(finalOD, na.rm = TRUE)
  ) %>%
  dplyr::ungroup() 



Community_compositions_focus_drugs_Niclosamide_80uM_summarised <- Community_compositions_focus_drugs_Niclosamide_80uM_summarised %>%
  dplyr::mutate(Species = sub("^(\\w)\\w*\\s(.*)", "\\1._\\2", species))

#remove (sub)strain info
Community_compositions_focus_drugs_Niclosamide_80uM_summarised <- Community_compositions_focus_drugs_Niclosamide_80uM_summarised %>%
  dplyr::mutate(Species = sub("^(\\w\\._\\w+).*", "\\1", Species))


#Initialise data frames
sim_output <- data.frame()
input_params_list <- list() #Use a list to collect parameters for each simulation

#number of simulations
num_sims <- 250


for (i in 1:num_sims) {
  tryCatch({
    # generate model parameters
    set.seed(i) #set a different seed for each simulation for variation
    params <- lapply(1:nrow(growth_data_all_0_Niclosamide), function(idx) {
      species_params <- growth_data_all_0_Niclosamide[idx, ]
      list(
        r = rnorm(1, mean = species_params$mean_max_Growth_rate, sd = species_params$sd_max_Growth_rate),
        K = rnorm(1, mean = species_params$mean_max_OD, sd = species_params$sd_max_OD)
      )
    })
    names(params) <- gsub(" ", "_", growth_data_all_0_Niclosamide$Species)
    flat_params <- unlist(params)
    names(flat_params) <- gsub("\\.\\d$", "", names(flat_params))
    
    #replace spaces with underscores to match formatting
    co_culture_correction$species <- gsub(" ", "_", co_culture_correction$species, fixed = TRUE)
    
    #replace the species-specific K parameters extracted from monoculture growth data 
    #with drawn relative abundance values at Niclosamide = 0, scaled to K
    rel_ab_control$Species <- gsub(" ", "_", rel_ab_control$Species)
    
    #Initialise an empty vector to store drawn values
    drawn_values <- numeric(nrow(rel_ab_control))
    
    #draw values from their respective distributions
    for (k in 1:nrow(rel_ab_control)) {
      species_name <- rel_ab_control$Species[k]
      drawn_value <- rnorm(1, mean = rel_ab_control$mean_rel_ab[k], sd = rel_ab_control$sd_rel_ab[k])
      drawn_values[k] <- max(drawn_value, 0)  # Ensure no negative values
    }
    
    #Normalise drawn relative abundance values so they sum to 1 (to reflect a 'true' relative abundance distribution)
    #this is needed so when we convert the values into OD units by multiplying with the drawn community maxOD,
    # the sum of K_i parameters and the drawn K are equal
    normalised_values <- drawn_values / sum(drawn_values)
    
    #Pull community maxOD (K) at 0 drugs from respective normal distribution:
    K <- rnorm(n = 1, mean = rel_ab_control$mean_com_max_OD[1], sd = rel_ab_control$sd_com_max_OD[1])
    
    # Assign these normalised values to their respective species' .K parameters
    for (k in 1:nrow(rel_ab_control)) {
      species_name <- rel_ab_control$Species[k]
      k_index <- grep(paste0("^", species_name, "\\.K$"), names(flat_params))
      
      if (length(k_index) > 0) {
        old_value <- flat_params[k_index]
        flat_params[k_index] <- (normalised_values[k] + 0.0001) * K #add small value in case drawn K_i is 0, which would cause issues with the solver
        cat(sprintf("Updated %s from %f to %f using normalised value %f scaled by K %f\n", names(flat_params)[k_index], old_value, flat_params[k_index], normalised_values[k], K))
      }
    }
    
    #Accounting for variation in drug degradation by community, with standard deviation of end concentration (at 10h) around the fitted predicted (relative) end concentration at 24h
    #prop_left_Niclosamide <- abs(rnorm(1, (subset(drug_dynamics, Drug == "Niclosamide")$Prop_left_24h_community), (subset(drug_dynamics, Drug == "Niclosamide")$SD_drug_community))) 
    #below, we account for measurement error rather than ecological drivers that lead to the variability of degradation at the final point measured 
    prop_left_Niclosamide <- abs(rnorm(
      n = 1, 
      mean = subset(drug_dynamics, Drug == "Niclosamide")$Prop_left_24h_community, 
      sd = ifelse(
        subset(drug_dynamics, Drug == "Niclosamide")$SD_drug_community > subset(drug_dynamics, Drug == "Niclosamide")$SD_drug_community_start, 
        subset(drug_dynamics, Drug == "Niclosamide")$SD_drug_community - subset(drug_dynamics, Drug == "Niclosamide")$SD_drug_community_start, 
        subset(drug_dynamics, Drug == "Niclosamide")$SD_drug_community
      )
    ))
    
    
    #loop through each species in co_culture_correction
    for (j in 1:nrow(co_culture_correction)) {
      # Extract the species name and correction factor
      species_name <- co_culture_correction$species[j]
      correction_factor <- co_culture_correction$correction_factor[j]
      
      # Identify the corresponding growth rate parameter in flat_params
      #by matching the base species name (without .r)
      growth_rate_indices <- grep(paste0("^", species_name, "\\.r$"), names(flat_params))
      
      #take the growth rate parameter and apply the correction factor 
      for (index in growth_rate_indices) {
        flat_params[index] <- flat_params[index] * correction_factor
      }
    }
    
    flat_params
    # Store parameters for each simulation
    input_params_list[[i]] <- c(sim_ID = i, flat_params)
    
    # Run the model for the first 24-hour cycle
    solution_cycle_1 <- ode(y = initial_conditions, times = seq(from = 0, to = 24, by = 0.1), func = closed.sir.model_Niclosamide, parms = flat_params,   method = "lsoda", rtol = 1e-6, atol = 1e-6)
    
    # Dilution and second cycle
    end_of_cycle_1 <- solution_cycle_1[nrow(solution_cycle_1), -1]
    initial_conditions_cycle_2 <- end_of_cycle_1 / 50
    #accounting for the drugs being added with the new growth cycle as well:
    initial_conditions_cycle_2[33] <- initial_conditions_cycle_2[33] + drug_concentration_tested
    solution_cycle_2 <- ode(y = initial_conditions_cycle_2, times = seq(from = 24, to = 48, by = 0.1), func = closed.sir.model_Niclosamide, parms = flat_params,  method = "lsoda", rtol = 1e-6, atol = 1e-6)
    
    # Combine and format results
    combined_solution <- rbind(as.data.frame(solution_cycle_1), as.data.frame(solution_cycle_2)[-1,])
    combined_solution$sim_ID <- rep(i, nrow(combined_solution))
    combined_solution <- combined_solution %>%
      tidyr::gather(key = "Species", value = "Density", -time, -sim_ID) %>%
      dplyr::mutate(Hour = time) %>%
      dplyr::select(sim_ID, Hour, Species, Density)
    
    ##Append to sim_output
    sim_output <- rbind(sim_output, combined_solution)
  }, error = function(e) {
    cat(sprintf("Skipping simulation %d due to an error: %s\n", i, e$message))
  })
}



##Combine all parameter data into a single dataframe
input_params <- do.call(rbind, input_params_list)

# Add a "Species" column 
sim_output$Species_name <- species_names[as.numeric(as.character(sim_output$Species))]
sim_output$Species_name <- replace_na(sim_output$Species_name, "Drug")

#View(input_params)
#View(sim_output)

sim_output <- na.omit(sim_output)
successful_sim_ids <- unique(subset(sim_output, Hour == 48)$sim_ID)
length(successful_sim_ids)
sim_output1 <- sim_output[sim_output$sim_ID %in% successful_sim_ids, ]


#Transform sim_output so we have wide format by Species
sim_output_wide <- tidyr::pivot_wider(sim_output1, 
                                      names_from = Species_name, 
                                      values_from = Density,
                                      id_cols = c(sim_ID, Hour))

length(unique(sim_output_wide$sim_ID))
#calc community OD per timepoint
sim_output_wide$Total_OD <- rowSums(sim_output_wide[, 3:34], na.rm = TRUE)
#calculate and add relative abundances here as well:
species_columns <- colnames(sim_output_wide)[3:34] 

for (species in species_columns) {
  sim_output_wide[[paste0("rel_", species)]] <- sim_output_wide[[species]] / sim_output_wide$Total_OD
}


#assign sim_output_wide test conditions to dataframe name
drug_tested <- "Niclosamide"
variable_name_1 <- paste0("sim_output_wide_", ifelse(drug_concentration_tested == 1e-04, 0, drug_concentration_tested), "_", drug_tested)
assign(variable_name_1, sim_output_wide)

#turn back into long format if interested in plotting relative abundances
cols_needed <- c("sim_ID", "Hour")

sim_output_long <- sim_output_wide %>% 
  dplyr::select(sim_ID, Hour, Drug, starts_with("rel_")) %>% 
  tidyr::pivot_longer(
    cols = c(Drug, starts_with("rel_")),
    names_to = "Species", 
    values_to = "Relative_abundance",
    names_prefix = "rel_",
    names_transform = list(Species = ~ ifelse(.x == "Drug", "Drug", .x))
  ) 

str(sim_output_long)


species_names_1 <- c(
  "A_muciniphila",
  "B_adolescentis",
  "B_fragilis",
  "B_longum",
  "B_obeum",
  "B_thetaiotaomicron",
  "B_uniformis",
  "B_vulgatus",
  "B_wadsworthia",
  "C_aerofaciens",
  "C_bolteae",
  "C_comes",
  "C_perfringens",
  "C_ramosum",
  "C_saccharolyticum",
  "D_formicigenerans",
  "E_coli",
  "E_lenta",
  "E_rectale",
  "F_nucleatum",
  "L_paracasei",
  "O_splanchnicus",
  "P_copri",
  "P_distasonis",
  "P_merdae",
  "R_bromii",
  "R_gnavus",
  "R_intestinalis",
  "R_torques",
  "S_parasanguinis",
  "S_salivarius",
  "V_parvula",
  "Drug"
)

species_colours_1 <- c(
  "A_muciniphila" = "#1f77b4",
  "B_adolescentis" = "#ff7f0e",
  "B_fragilis" = "#2ca02c",
  "B_longum" = "#d62728",
  "B_obeum" = "#9467bd",
  "B_thetaiotaomicron" = "black",
  "B_uniformis" = "#e377c2",
  "B_vulgatus" = "#7f7f7f",
  "B_wadsworthia" = "gold1",
  "C_aerofaciens" = "#aec7e8",
  "C_bolteae" = "#ffbb78",
  "C_comes" = "magenta",
  "C_perfringens" = "#ff9896",
  "C_ramosum" = "#c5b0d5",
  "C_saccharolyticum" = "#c49c94",
  "D_formicigenerans" = "#f7b6d2",
  "E_coli" = "yellow",
  "E_lenta" = "turquoise",
  "E_rectale" = "#393b79",
  "F_nucleatum" = "royalblue2",
  "L_paracasei" = "blue",
  "O_splanchnicus" = "#637939",
  "P_copri" = "cyan",
  "P_distasonis" = "#8c6d31",
  "P_merdae" = "#c7c7c7",
  "R_bromii" = "#e6550d",
  "R_gnavus" = "#e7cb94",
  "R_intestinalis" = "#843c39",
  "R_torques" = "#d6616b",
  "S_parasanguinis" = "orange3",
  "S_salivarius" = "#7b4173",
  "V_parvula" = "#ce6dbd",
  "Drug" = "green"
)



##Plot output for any specific sim:
# ggplot(subset(sim_output, sim_ID == 1 & Species_name != "Drug"), aes(x = Hour, y = Density, group = Species_name, color = Species_name)) +
#   geom_line(size = 1, alpha = 0.7) +
#   scale_color_manual(values = species_colours_1) +
#   labs(title = paste0("Niclosamide = ", drug_concentration_tested),
#        x = "Time (hours)",
#        y = "Population Density (OD)",
#        color = "Species") +
#   theme_minimal() +
#   theme(legend.position = "right")
# 
# ggplot(subset(sim_output, sim_ID == 3 & Species_name != "Drug"), aes(x = Hour, y = Density, group = Species_name, color = Species_name)) +
#   geom_line(size = 1, alpha = 0.7) +
#   scale_color_manual(values = species_colours_1) +
#   labs(title = paste0("Niclosamide = ", drug_concentration_tested),
#        x = "Time (hours)",
#        y = "Population Density (OD)",
#        color = "Species") +
#   theme_minimal() +
#   theme(legend.position = "right")


ggplot(subset(sim_output_long, sim_ID == 1), aes(x = Hour, y = Relative_abundance, group = Species, color = Species)) +
  geom_line(size = 1, alpha = 0.7) +
  scale_color_manual(values = species_colours_1) +
  labs(title = paste0("Niclosamide = ", drug_concentration_tested),
       x = "Time (hours)",
       y = "Relative abundance",
       color = "Species") +
  theme_minimal() +
  theme(legend.position = "right")


ggplot(subset(sim_output_long, sim_ID == 3), aes(x = Hour, y = Relative_abundance, group = Species, color = Species)) +
  geom_line(size = 1, alpha = 0.7) +
  scale_color_manual(values = species_colours_1) +
  labs(title = paste0("Niclosamide = ", drug_concentration_tested),
       x = "Time (hours)",
       y = "Relative abundance",
       color = "Species") +
  theme_minimal() +
  theme(legend.position = "right")


#calc mean and standard deviation across sims
sim_stats <- sim_output_long %>%
  dplyr::group_by(Hour, Species) %>%
  dplyr::summarise(
    mean_rel_ab = mean(Relative_abundance),
    sd_rel_ab = sd(Relative_abundance),
    .groups = 'drop'
  )

# Prepare the data for plotting
plot_data <- sim_stats %>%
  dplyr::mutate(Upper = mean_rel_ab + sd_rel_ab, Lower = mean_rel_ab - sd_rel_ab)

ggplot(subset(plot_data, Species != "Drug"), aes(x = Hour, y = mean_rel_ab, group = Species, color = Species)) +
  geom_ribbon(aes(ymin = Lower, ymax = Upper, fill = Species), colour = NA, alpha = 0.2) +  
  geom_line(size = 1, alpha = 0.7) + 
  scale_color_manual(values = species_colours_1) +
  scale_fill_manual(values = species_colours_1) +  
  labs(title = "Mean and SD of Relative Abundance Across Simulations",
       subtitle = paste0("Niclosamide = ", drug_concentration_tested),       
       x = "Time (hours)",
       y = "Relative abundance",
       color = "Species",
       fill = "Species") +
  theme_minimal() +
  theme(legend.position = "right")

#log-scaled mean trends
ggplot(plot_data, aes(x = Hour, y = log10(mean_rel_ab + 0.0001), group = Species, color = Species)) +
  geom_line(size = 1, alpha = 0.7) +  # Mean line
  scale_color_manual(values = species_colours_1) +
  scale_fill_manual(values = species_colours_1) +  # Ensure consistent colors for lines and fills
  labs(title = "Mean and SD of Relative Abundance Across Simulations",
       subtitle = paste0("Niclosamide = ", drug_concentration_tested),
       x = "Time (hours)",
       y = "Relative abundance",
       color = "Species",
       fill = "Species") +
  theme_minimal() +
  theme(legend.position = "right")




##prediction quality evaluation
drug_tested <- "Niclosamide"
variable_name <- paste0("plot_data_", ifelse(drug_concentration_tested == 1e-04, 0, drug_concentration_tested), "_", drug_tested)
assign(variable_name, plot_data)


#extract total OD info:
predicted_mean_final_od_NULL <- Niclosamide_16S_0uM_summarised$mean_com_final_OD[1]
predicted_sd_final_od_NULL <- Niclosamide_16S_0uM_summarised$sd_com_final_OD[1]

predicted_mean_final_od_160_Niclosamide <- mean(subset(sim_output_wide_160_Niclosamide, Hour == 48)$Total_OD, na.rm = TRUE)
predicted_sd_final_od_160_Niclosamide <- sd(subset(sim_output_wide_160_Niclosamide, Hour == 48)$Total_OD, na.rm = TRUE)

real_mean_final_od_160_Niclosamide <- Community_compositions_focus_drugs_Niclosamide_160uM_summarised$mean_final_OD[1]
real_sd_final_od_160_Niclosamide <- Community_compositions_focus_drugs_Niclosamide_160uM_summarised$sd_final_OD[1]


predicted_mean_final_od_20_Niclosamide <- mean(subset(sim_output_wide_20_Niclosamide, Hour == 48)$Total_OD, na.rm = TRUE)
predicted_sd_final_od_20_Niclosamide <- sd(subset(sim_output_wide_20_Niclosamide, Hour == 48)$Total_OD, na.rm = TRUE)

real_mean_final_od_20_Niclosamide <- Community_compositions_focus_drugs_Niclosamide_20uM_summarised$mean_final_OD[1]
real_sd_final_od_20_Niclosamide <- Community_compositions_focus_drugs_Niclosamide_20uM_summarised$sd_final_OD[1]


predicted_mean_final_od_80_Niclosamide <- mean(subset(sim_output_wide_80_Niclosamide, Hour == 48)$Total_OD, na.rm = TRUE)
predicted_sd_final_od_80_Niclosamide <- sd(subset(sim_output_wide_80_Niclosamide, Hour == 48)$Total_OD, na.rm = TRUE)

real_mean_final_od_80_Niclosamide <- Community_compositions_focus_drugs_Niclosamide_80uM_summarised$mean_final_OD[1]
real_sd_final_od_80_Niclosamide <- Community_compositions_focus_drugs_Niclosamide_80uM_summarised$sd_final_OD[1]




#plot_data_0_Niclosamide_endpoint was used to test model performance at 0 drugs
#plot_data_0_Niclosamide_endpoint <- subset(plot_data_0_Niclosamide, Hour == 48 & Species != "Drug")
plot_data_160_Niclosamide_endpoint <- subset(plot_data_160_Niclosamide, Hour == 48 & Species != "Drug")
plot_data_20_Niclosamide_endpoint <- subset(plot_data_20_Niclosamide, Hour == 48 & Species != "Drug")
plot_data_80_Niclosamide_endpoint <- subset(plot_data_80_Niclosamide, Hour == 48 & Species != "Drug")

##Inspecting 'match' to real relative abundance distributions:
Niclosamide_16S_0uM_summarised <- rel_ab_control
Niclosamide_16S_0uM_summarised$Species <- gsub("\\.", "", Niclosamide_16S_0uM_summarised$Species)

Niclosamide_16S_160uM_summarised <- Community_compositions_focus_drugs_Niclosamide_160uM_summarised
Niclosamide_16S_20uM_summarised <- Community_compositions_focus_drugs_Niclosamide_20uM_summarised
Niclosamide_16S_80uM_summarised <- Community_compositions_focus_drugs_Niclosamide_80uM_summarised

Niclosamide_16S_0uM_summarised
Niclosamide_16S_160uM_summarised 
Niclosamide_16S_20uM_summarised 
Niclosamide_16S_80uM_summarised 

#Rename 'species' so the outputs become comparable
original_names_80 <- unique(Niclosamide_16S_80uM_summarised$species)
original_names_20 <- unique(Niclosamide_16S_20uM_summarised$species)
original_names_160 <- unique(Niclosamide_16S_160uM_summarised$species)


##Create a named vector with the original and new names mapping
name_changes <- c(
  "Akkermansia muciniphila" = "A_muciniphila",
  "Bacteroides fragilis" = "B_fragilis",
  "Bacteroides thetaiotaomicron" = "B_thetaiotaomicron",
  "Bacteroides uniformis" = "B_uniformis",
  "Bifidobacterium adolescentis" = "B_adolescentis",
  "Bifidobacterium longum subsp. longum" = "B_longum",
  "Bilophila wadsworthia" = "B_wadsworthia",
  "Blautia obeum" = "B_obeum",
  "Clostridium perfringens" = "C_perfringens",
  "Collinsella aerofaciens" = "C_aerofaciens",
  "Coprococcus comes" = "C_comes",
  "Dorea formicigenerans" = "D_formicigenerans",
  "Eggerthella lenta" = "E_lenta",
  "Enterocloster bolteae" = "C_bolteae",
  "Erysipelatoclostridium ramosum" = "C_ramosum",
  "Escherichia coli ED1a" = "E_coli",
  "Eubacterium rectale" = "E_rectale",
  "Fusobacterium nucleatum subsp. nucleatum" = "F_nucleatum",
  "Lacrimispora saccharolytica" = "C_saccharolyticum",
  "Lacticaseibacillus paracasei" = "L_paracasei",
  "Odoribacter splanchnicus" = "O_splanchnicus",
  "Parabacteroides distasonis" = "P_distasonis",
  "Parabacteroides merdae" = "P_merdae",
  "Phocaeicola vulgatus" = "B_vulgatus",
  "Prevotella copri" = "P_copri",
  "Roseburia intestinalis" = "R_intestinalis",
  "Ruminococcus bromii" = "R_bromii",
  "Ruminococcus gnavus" = "R_gnavus",
  "Ruminococcus torques" = "R_torques",
  "Streptococcus parasanguinis" = "S_parasanguinis",
  "Streptococcus salivarius" = "S_salivarius",
  "Veillonella parvula" = "V_parvula"
)

# Apply name changes to the species column in Niclosamide_16S_80uM_summarised

Niclosamide_16S_80uM_summarised$Species <- name_changes[Niclosamide_16S_80uM_summarised$species]
Niclosamide_16S_20uM_summarised$Species <- name_changes[Niclosamide_16S_20uM_summarised$species]
Niclosamide_16S_160uM_summarised$Species <- name_changes[Niclosamide_16S_160uM_summarised$species]

# Verify the changes
unique(Niclosamide_16S_80uM_summarised$Species)
unique(Niclosamide_16S_20uM_summarised$Species)
unique(Niclosamide_16S_160uM_summarised$Species)



##First, for 160 uM:
# Get top 6 species from plot_data_160_endpoint
# Adjust the plot_data_160_endpoint with confidence bounds

# #plot_data_0_Niclosamide_endpoint was used to test model performance at 0 drugs
# plot_data_0_Niclosamide_endpoint <- plot_data_0_Niclosamide_endpoint %>%
#   dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)

plot_data_160_Niclosamide_endpoint <- plot_data_160_Niclosamide_endpoint %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)

# Adjust the Niclosamide_16S_160uM_summarised with confidence bounds
Niclosamide_16S_160uM_summarised <- Niclosamide_16S_160uM_summarised %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)

#NULL model:
Null_model_summarised <- Niclosamide_16S_0uM_summarised %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)


# Get top 6 species based on the lower bound from plot_data_160_endpoint

#top6_predicted_0_Niclosamide was used to test model performance at 0 drugs
# top6_predicted_0_Niclosamide <- plot_data_0_Niclosamide_endpoint %>%
#    arrange(desc(lower_bound)) %>%
#    slice(1:6) %>%
#    pull(Species)

top6_predicted_160_Niclosamide <- plot_data_160_Niclosamide_endpoint %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

# Get top 6 species based on the lower bound from Niclosamide_16S_160uM_summarised
top6_real_160_Niclosamide <- Niclosamide_16S_160uM_summarised %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

top6_NULL <- Null_model_summarised %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

# Calculate the overlap of top 6 species

#top_six_correct_0_Niclosamide was used to assess model performance at 0 drugs
# top_six_correct_0_Niclosamide <- length(intersect(top6_predicted_0_Niclosamide, top6_NULL))
# top_six_correct_0_Niclosamide

top_six_correct_160_Niclosamide <- length(intersect(top6_predicted_160_Niclosamide, top6_real_160_Niclosamide))
top_six_correct_160_Niclosamide

top_six_correct_160_Niclosamide_NULL <- length(intersect(top6_NULL, top6_real_160_Niclosamide))
top_six_correct_160_Niclosamide_NULL

top6_predicted_160_Niclosamide
top6_real_160_Niclosamide

#top6_NULL

#Now by means:
# #top6_predicted_0_Niclosamide_means was used to assess model performance at 0 drugs
# top6_predicted_0_Niclosamide_means <- plot_data_0_Niclosamide_endpoint %>%
#    arrange(desc(mean_rel_ab)) %>%
#    slice(1:6) %>%
#    pull(Species)

top6_predicted_160_Niclosamide_means <- plot_data_160_Niclosamide_endpoint %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)

# Get top 6 species based on the lower bound from Niclosamide_16S_160uM_summarised
top6_real_160_Niclosamide_means <- Niclosamide_16S_160uM_summarised %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)

top6_NULL_means <- Null_model_summarised %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)


# #top_six_correct_0_Niclosamide_means was used to assess model performance at 0 drugs
# top_six_correct_0_Niclosamide_means <- length(intersect(top6_predicted_0_Niclosamide_means, top6_NULL_means))
# top_six_correct_0_Niclosamide_means

top_six_correct_160_Niclosamide_means <- length(intersect(top6_predicted_160_Niclosamide_means, top6_real_160_Niclosamide_means))
top_six_correct_160_Niclosamide_means

top_six_correct_160_Niclosamide_means_NULL <- length(intersect(top6_NULL_means, top6_real_160_Niclosamide_means))
top_six_correct_160_Niclosamide_means_NULL

top6_predicted_160_Niclosamide_means
top6_real_160_Niclosamide_means

#top6_NULL_means


# Merge dataframes by Species

#merged_data_0_Niclosamide was used to assess model performance at 0 drugs
#merged_data_0_Niclosamide <- merge(plot_data_0_Niclosamide_endpoint, Niclosamide_16S_0uM_summarised, by = "Species", suffixes = c(".pred", ".real"))
merged_data_160_Niclosamide <- merge(plot_data_160_Niclosamide_endpoint, Niclosamide_16S_160uM_summarised, by = "Species", suffixes = c(".pred", ".real"))
merged_data_160_Niclosamide_NULL <- merge(Niclosamide_16S_0uM_summarised, Niclosamide_16S_160uM_summarised, by = "Species", suffixes = c(".null", ".real"))


## Below lines used for assessing model performance at 0 drugs; ignore for nonzero concentrations
# # Create lower and upper bounds considering mean ¬± sd
# merged_data_0_Niclosamide$lower_bound_pred <- merged_data_0_Niclosamide$mean_rel_ab.pred - merged_data_0_Niclosamide$sd_rel_ab.pred
# merged_data_0_Niclosamide$upper_bound_pred <- merged_data_0_Niclosamide$mean_rel_ab.pred + merged_data_0_Niclosamide$sd_rel_ab.pred
# merged_data_0_Niclosamide$lower_bound_real <- merged_data_0_Niclosamide$mean_rel_ab.real - merged_data_0_Niclosamide$sd_rel_ab.real
# merged_data_0_Niclosamide$upper_bound_real <- merged_data_0_Niclosamide$mean_rel_ab.real + merged_data_0_Niclosamide$sd_rel_ab.real
# 
# # Ensure lower and upper bounds are non-negative, adjusting as necessary
# merged_data_0_Niclosamide$lower_bound_pred[merged_data_0_Niclosamide$lower_bound_pred <= 0] <- 1e-10
# merged_data_0_Niclosamide$lower_bound_real[merged_data_0_Niclosamide$lower_bound_real <= 0] <- 1e-10
# merged_data_0_Niclosamide$upper_bound_pred[merged_data_0_Niclosamide$upper_bound_pred <= 0] <- 1e-10
# merged_data_0_Niclosamide$upper_bound_real[merged_data_0_Niclosamide$upper_bound_real <= 0] <- 1e-10


# Create lower and upper bounds considering mean ¬± sd
merged_data_160_Niclosamide$lower_bound_pred <- merged_data_160_Niclosamide$mean_rel_ab.pred - merged_data_160_Niclosamide$sd_rel_ab.pred
merged_data_160_Niclosamide$upper_bound_pred <- merged_data_160_Niclosamide$mean_rel_ab.pred + merged_data_160_Niclosamide$sd_rel_ab.pred
merged_data_160_Niclosamide$lower_bound_real <- merged_data_160_Niclosamide$mean_rel_ab.real - merged_data_160_Niclosamide$sd_rel_ab.real
merged_data_160_Niclosamide$upper_bound_real <- merged_data_160_Niclosamide$mean_rel_ab.real + merged_data_160_Niclosamide$sd_rel_ab.real

# Ensure lower and upper bounds are non-negative, adjusting as necessary
merged_data_160_Niclosamide$lower_bound_pred[merged_data_160_Niclosamide$lower_bound_pred <= 0] <- 1e-10
merged_data_160_Niclosamide$lower_bound_real[merged_data_160_Niclosamide$lower_bound_real <= 0] <- 1e-10
merged_data_160_Niclosamide$upper_bound_pred[merged_data_160_Niclosamide$upper_bound_pred <= 0] <- 1e-10
merged_data_160_Niclosamide$upper_bound_real[merged_data_160_Niclosamide$upper_bound_real <= 0] <- 1e-10

##and for NULL model:
# Create lower and upper bounds considering mean ¬± sd
merged_data_160_Niclosamide_NULL$lower_bound_null <- merged_data_160_Niclosamide_NULL$mean_rel_ab.null - merged_data_160_Niclosamide_NULL$sd_rel_ab.null
merged_data_160_Niclosamide_NULL$upper_bound_null <- merged_data_160_Niclosamide_NULL$mean_rel_ab.null + merged_data_160_Niclosamide_NULL$sd_rel_ab.null
merged_data_160_Niclosamide_NULL$lower_bound_real <- merged_data_160_Niclosamide_NULL$mean_rel_ab.real - merged_data_160_Niclosamide_NULL$sd_rel_ab.real
merged_data_160_Niclosamide_NULL$upper_bound_real <- merged_data_160_Niclosamide_NULL$mean_rel_ab.real + merged_data_160_Niclosamide_NULL$sd_rel_ab.real

# Ensure lower and upper bounds are non-negative, adjusting as necessary
merged_data_160_Niclosamide_NULL$lower_bound_null[merged_data_160_Niclosamide_NULL$lower_bound_null <= 0] <- 1e-10
merged_data_160_Niclosamide_NULL$lower_bound_real[merged_data_160_Niclosamide_NULL$lower_bound_real <= 0] <- 1e-10
merged_data_160_Niclosamide_NULL$upper_bound_null[merged_data_160_Niclosamide_NULL$upper_bound_null <= 0] <- 1e-10
merged_data_160_Niclosamide_NULL$upper_bound_real[merged_data_160_Niclosamide_NULL$upper_bound_real <= 0] <- 1e-10

# Filter to include only species with a mean relative abundance > 0.01 in the 'real' dataset

## significant_species_0 was used to assess model performance at 0 drugs
#significant_species_0 <- merged_data_0_Niclosamide[merged_data_0_Niclosamide$mean_rel_ab.real > 0.01, ]
significant_species <- merged_data_160_Niclosamide[merged_data_160_Niclosamide$mean_rel_ab.real > 0.01, ]
survivors_160_Niclosamide <- nrow(significant_species)
survivors_160_Niclosamide

#should be the same as survivors defined above, since it is calculated from .real
significant_species_NULL <- merged_data_160_Niclosamide_NULL[merged_data_160_Niclosamide_NULL$mean_rel_ab.real > 0.01, ]
survivors_160_Niclosamide_NULL <- nrow(significant_species_NULL)
survivors_160_Niclosamide_NULL

# Adjusted order of magnitude check to include SD, only for significant species
## below code was used to assess model performance at 0 drugs
# significant_species_0$Predicted_magnitude_correct <- ifelse(
#   (floor(log10(significant_species_0$lower_bound_pred)) <= floor(log10(significant_species_0$upper_bound_real)) &
#      floor(log10(significant_species_0$upper_bound_pred)) >= floor(log10(significant_species_0$lower_bound_real))),
#   1,
#   0
# )

significant_species$Predicted_magnitude_correct <- ifelse(
  (floor(log10(significant_species$lower_bound_pred)) <= floor(log10(significant_species$upper_bound_real)) &
     floor(log10(significant_species$upper_bound_pred)) >= floor(log10(significant_species$lower_bound_real))),
  1,
  0
)

#and for the Null model:
significant_species_NULL$Predicted_magnitude_correct <- ifelse(
  (floor(log10(significant_species_NULL$lower_bound_null)) <= floor(log10(significant_species_NULL$upper_bound_real)) &
     floor(log10(significant_species_NULL$upper_bound_null)) >= floor(log10(significant_species_NULL$lower_bound_real))),
  1,
  0
)

# Calculate the fraction of correctly predicted magnitudes for significant species
## below code was used to assess model performance at 0 drugs
#predicted_magnitude_correct_fraction_0_Niclosamide <- sum(significant_species_0$Predicted_magnitude_correct) / nrow(significant_species_0)
#predicted_magnitude_correct_fraction_0_Niclosamide

predicted_magnitude_correct_fraction_160_Niclosamide <- sum(significant_species$Predicted_magnitude_correct) / nrow(significant_species)
predicted_magnitude_correct_fraction_160_Niclosamide

predicted_magnitude_correct_fraction_160_Niclosamide_NULL <- sum(significant_species_NULL$Predicted_magnitude_correct) / nrow(significant_species_NULL)
predicted_magnitude_correct_fraction_160_Niclosamide_NULL

top_species_missing_160_Niclosamide <- setdiff(top6_real_160_Niclosamide_means, top6_predicted_160_Niclosamide_means)
top_species_wrong_160_Niclosamide <- setdiff(top6_predicted_160_Niclosamide_means, top6_real_160_Niclosamide_means)


Prediction_quality_160_Niclosamide <- data.frame(
  Top_six_correct = paste(top_six_correct_160_Niclosamide, sep=""),
  Top_six_correct_NULL = paste(top_six_correct_160_Niclosamide_NULL, sep=""),
  Top_six_correct_means = paste(top_six_correct_160_Niclosamide_means, sep=""),
  Top_six_correct_means_NULL = paste(top_six_correct_160_Niclosamide_means_NULL, sep=""),
  Predicted_magnitude_correct = paste(round(predicted_magnitude_correct_fraction_160_Niclosamide * 100, 2), "%", sep=""),
  Predicted_magnitude_correct_NULL = paste(round(predicted_magnitude_correct_fraction_160_Niclosamide_NULL * 100, 2), "%", sep=""),
  survivors_total = survivors_160_Niclosamide,
  top_species_missing <- top_species_missing_160_Niclosamide,
  top_species_wrong <- top_species_wrong_160_Niclosamide, 
  predicted_mean_final_OD <- predicted_mean_final_od_160_Niclosamide,
  real_mean_final_OD <- real_mean_final_od_160_Niclosamide,
  sims_total = length(successful_sim_ids)
)



Prediction_quality_160_Niclosamide



##Next, for 20 uM:
# Get top 6 species from plot_data_20_endpoint
# Adjust the plot_data_20_endpoint with confidence bounds
plot_data_20_Niclosamide_endpoint <- plot_data_20_Niclosamide_endpoint %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)

# Adjust the Niclosamide_16S_20uM_summarised with confidence bounds
Niclosamide_16S_20uM_summarised <- Niclosamide_16S_20uM_summarised %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)

#NULL model:
Null_model_summarised <- Niclosamide_16S_0uM_summarised %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)


# Get top 6 species based on the lower bound from plot_data_20_endpoint
top6_predicted_20_Niclosamide <- plot_data_20_Niclosamide_endpoint %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

# Get top 6 species based on the lower bound from Niclosamide_16S_20uM_summarised
top6_real_20_Niclosamide <- Niclosamide_16S_20uM_summarised %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

top6_NULL <- Null_model_summarised %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

# Calculate the overlap of top 6 species
top_six_correct_20_Niclosamide <- length(intersect(top6_predicted_20_Niclosamide, top6_real_20_Niclosamide))
#top_six_correct_20_Niclosamide

top_six_correct_20_Niclosamide_NULL <- length(intersect(top6_NULL, top6_real_20_Niclosamide))
#top_six_correct_20_Niclosamide_NULL

#top6_predicted_20_Niclosamide
#top6_real_20_Niclosamide



#Now by means:
top6_predicted_20_Niclosamide_means <- plot_data_20_Niclosamide_endpoint %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)

# Get top 6 species based on the lower bound from Niclosamide_16S_20uM_summarised
top6_real_20_Niclosamide_means <- Niclosamide_16S_20uM_summarised %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)

top6_NULL_means <- Null_model_summarised %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)



top_six_correct_20_Niclosamide_means <- length(intersect(top6_predicted_20_Niclosamide_means, top6_real_20_Niclosamide_means))
#top_six_correct_20_Niclosamide_means

top_six_correct_20_Niclosamide_means_NULL <- length(intersect(top6_NULL_means, top6_real_20_Niclosamide_means))
#top_six_correct_20_Niclosamide_means_NULL

top6_predicted_20_Niclosamide_means
#top6_real_20_Niclosamide_means




# Merge dataframes by Species
merged_data_20_Niclosamide <- merge(plot_data_20_Niclosamide_endpoint, Niclosamide_16S_20uM_summarised, by = "Species", suffixes = c(".pred", ".real"))
merged_data_20_Niclosamide_NULL <- merge(Niclosamide_16S_0uM_summarised, Niclosamide_16S_20uM_summarised, by = "Species", suffixes = c(".null", ".real"))



# Create lower and upper bounds considering mean ¬± sd
merged_data_20_Niclosamide$lower_bound_pred <- merged_data_20_Niclosamide$mean_rel_ab.pred - merged_data_20_Niclosamide$sd_rel_ab.pred
merged_data_20_Niclosamide$upper_bound_pred <- merged_data_20_Niclosamide$mean_rel_ab.pred + merged_data_20_Niclosamide$sd_rel_ab.pred
merged_data_20_Niclosamide$lower_bound_real <- merged_data_20_Niclosamide$mean_rel_ab.real - merged_data_20_Niclosamide$sd_rel_ab.real
merged_data_20_Niclosamide$upper_bound_real <- merged_data_20_Niclosamide$mean_rel_ab.real + merged_data_20_Niclosamide$sd_rel_ab.real

# Ensure lower and upper bounds are non-negative, adjusting as necessary
merged_data_20_Niclosamide$lower_bound_pred[merged_data_20_Niclosamide$lower_bound_pred <= 0] <- 1e-10
merged_data_20_Niclosamide$lower_bound_real[merged_data_20_Niclosamide$lower_bound_real <= 0] <- 1e-10
merged_data_20_Niclosamide$upper_bound_pred[merged_data_20_Niclosamide$upper_bound_pred <= 0] <- 1e-10
merged_data_20_Niclosamide$upper_bound_real[merged_data_20_Niclosamide$upper_bound_real <= 0] <- 1e-10

##and for NULL model:
# Create lower and upper bounds considering mean ¬± sd
merged_data_20_Niclosamide_NULL$lower_bound_null <- merged_data_20_Niclosamide_NULL$mean_rel_ab.null - merged_data_20_Niclosamide_NULL$sd_rel_ab.null
merged_data_20_Niclosamide_NULL$upper_bound_null <- merged_data_20_Niclosamide_NULL$mean_rel_ab.null + merged_data_20_Niclosamide_NULL$sd_rel_ab.null
merged_data_20_Niclosamide_NULL$lower_bound_real <- merged_data_20_Niclosamide_NULL$mean_rel_ab.real - merged_data_20_Niclosamide_NULL$sd_rel_ab.real
merged_data_20_Niclosamide_NULL$upper_bound_real <- merged_data_20_Niclosamide_NULL$mean_rel_ab.real + merged_data_20_Niclosamide_NULL$sd_rel_ab.real

# Ensure lower and upper bounds are non-negative, adjusting as necessary
merged_data_20_Niclosamide_NULL$lower_bound_null[merged_data_20_Niclosamide_NULL$lower_bound_null <= 0] <- 1e-10
merged_data_20_Niclosamide_NULL$lower_bound_real[merged_data_20_Niclosamide_NULL$lower_bound_real <= 0] <- 1e-10
merged_data_20_Niclosamide_NULL$upper_bound_null[merged_data_20_Niclosamide_NULL$upper_bound_null <= 0] <- 1e-10
merged_data_20_Niclosamide_NULL$upper_bound_real[merged_data_20_Niclosamide_NULL$upper_bound_real <= 0] <- 1e-10

# Filter to include only species with a mean relative abundance > 0.01 in the 'real' dataset
significant_species <- merged_data_20_Niclosamide[merged_data_20_Niclosamide$mean_rel_ab.real > 0.01, ]
survivors_20_Niclosamide <- nrow(significant_species)
survivors_20_Niclosamide

#should be the same as survivors defined above, since it is calculated from .real
significant_species_NULL <- merged_data_20_Niclosamide_NULL[merged_data_20_Niclosamide_NULL$mean_rel_ab.real > 0.01, ]
survivors_20_Niclosamide_NULL <- nrow(significant_species_NULL)
survivors_20_Niclosamide_NULL

# Adjusted order of magnitude check to include SD, only for significant species
significant_species$Predicted_magnitude_correct <- ifelse(
  (floor(log10(significant_species$lower_bound_pred)) <= floor(log10(significant_species$upper_bound_real)) &
     floor(log10(significant_species$upper_bound_pred)) >= floor(log10(significant_species$lower_bound_real))),
  1,
  0
)

#and for the Null model:
significant_species_NULL$Predicted_magnitude_correct <- ifelse(
  (floor(log10(significant_species_NULL$lower_bound_null)) <= floor(log10(significant_species_NULL$upper_bound_real)) &
     floor(log10(significant_species_NULL$upper_bound_null)) >= floor(log10(significant_species_NULL$lower_bound_real))),
  1,
  0
)

# Calculate the fraction of correctly predicted magnitudes for significant species
predicted_magnitude_correct_fraction_20_Niclosamide <- sum(significant_species$Predicted_magnitude_correct) / nrow(significant_species)
predicted_magnitude_correct_fraction_20_Niclosamide

predicted_magnitude_correct_fraction_20_Niclosamide_NULL <- sum(significant_species_NULL$Predicted_magnitude_correct) / nrow(significant_species_NULL)
predicted_magnitude_correct_fraction_20_Niclosamide_NULL

top_species_missing_20_Niclosamide <- setdiff(top6_real_20_Niclosamide_means, top6_predicted_20_Niclosamide_means)
top_species_wrong_20_Niclosamide <- setdiff(top6_predicted_20_Niclosamide_means, top6_real_20_Niclosamide_means)

Prediction_quality_20_Niclosamide <- data.frame(
  Top_six_correct = paste(top_six_correct_20_Niclosamide, sep=""),
  Top_six_correct_NULL = paste(top_six_correct_20_Niclosamide_NULL, sep=""),
  Top_six_correct_means = paste(top_six_correct_20_Niclosamide_means, sep=""),
  Top_six_correct_means_NULL = paste(top_six_correct_20_Niclosamide_means_NULL, sep=""),
  Predicted_magnitude_correct = paste(round(predicted_magnitude_correct_fraction_20_Niclosamide * 100, 2), "%", sep=""),
  Predicted_magnitude_correct_NULL = paste(round(predicted_magnitude_correct_fraction_20_Niclosamide_NULL * 100, 2), "%", sep=""),
  survivors_total = survivors_20_Niclosamide,
  top_species_missing <- top_species_missing_20_Niclosamide,
  top_species_wrong <- top_species_wrong_20_Niclosamide, 
  predicted_mean_final_OD <- predicted_mean_final_od_20_Niclosamide,
  real_mean_final_OD <- real_mean_final_od_20_Niclosamide,
  sims_total = length(successful_sim_ids)
)

Prediction_quality_20_Niclosamide






##Next, for 80 uM:
# Get top 6 species from plot_data_80_endpoint
# Adjust the plot_data_80_endpoint with confidence bounds
plot_data_80_Niclosamide_endpoint <- plot_data_80_Niclosamide_endpoint %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)

# Adjust the Niclosamide_16S_80uM_summarised with confidence bounds
Niclosamide_16S_80uM_summarised <- Niclosamide_16S_80uM_summarised %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)

#NULL model:
Null_model_summarised <- Niclosamide_16S_0uM_summarised %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)


# Get top 6 species based on the lower bound from plot_data_80_endpoint
top6_predicted_80_Niclosamide <- plot_data_80_Niclosamide_endpoint %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

# Get top 6 species based on the lower bound from Niclosamide_16S_80uM_summarised
top6_real_80_Niclosamide <- Niclosamide_16S_80uM_summarised %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

top6_NULL <- Null_model_summarised %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

# Calculate the overlap of top 6 species
top_six_correct_80_Niclosamide <- length(intersect(top6_predicted_80_Niclosamide, top6_real_80_Niclosamide))
#top_six_correct_80_Niclosamide

top_six_correct_80_Niclosamide_NULL <- length(intersect(top6_NULL, top6_real_80_Niclosamide))
#top_six_correct_80_Niclosamide_NULL

#top6_predicted_80_Niclosamide
#top6_real_80_Niclosamide




#Now by means:
top6_predicted_80_Niclosamide_means <- plot_data_80_Niclosamide_endpoint %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)

# Get top 6 species based on the lower bound from Niclosamide_16S_80uM_summarised
top6_real_80_Niclosamide_means <- Niclosamide_16S_80uM_summarised %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)

top6_NULL_means <- Null_model_summarised %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)



top_six_correct_80_Niclosamide_means <- length(intersect(top6_predicted_80_Niclosamide_means, top6_real_80_Niclosamide_means))
#top_six_correct_80_Niclosamide_means

top_six_correct_80_Niclosamide_means_NULL <- length(intersect(top6_NULL_means, top6_real_80_Niclosamide_means))
#top_six_correct_80_Niclosamide_means_NULL

#top6_predicted_80_Niclosamide_means
#top6_real_80_Niclosamide_means




# Merge dataframes by Species
merged_data_80_Niclosamide <- merge(plot_data_80_Niclosamide_endpoint, Niclosamide_16S_80uM_summarised, by = "Species", suffixes = c(".pred", ".real"))
merged_data_80_Niclosamide_NULL <- merge(Niclosamide_16S_0uM_summarised, Niclosamide_16S_80uM_summarised, by = "Species", suffixes = c(".null", ".real"))



# Create lower and upper bounds considering mean ¬± sd
merged_data_80_Niclosamide$lower_bound_pred <- merged_data_80_Niclosamide$mean_rel_ab.pred - merged_data_80_Niclosamide$sd_rel_ab.pred
merged_data_80_Niclosamide$upper_bound_pred <- merged_data_80_Niclosamide$mean_rel_ab.pred + merged_data_80_Niclosamide$sd_rel_ab.pred
merged_data_80_Niclosamide$lower_bound_real <- merged_data_80_Niclosamide$mean_rel_ab.real - merged_data_80_Niclosamide$sd_rel_ab.real
merged_data_80_Niclosamide$upper_bound_real <- merged_data_80_Niclosamide$mean_rel_ab.real + merged_data_80_Niclosamide$sd_rel_ab.real

# Ensure lower and upper bounds are non-negative, adjusting as necessary
merged_data_80_Niclosamide$lower_bound_pred[merged_data_80_Niclosamide$lower_bound_pred <= 0] <- 1e-10
merged_data_80_Niclosamide$lower_bound_real[merged_data_80_Niclosamide$lower_bound_real <= 0] <- 1e-10
merged_data_80_Niclosamide$upper_bound_pred[merged_data_80_Niclosamide$upper_bound_pred <= 0] <- 1e-10
merged_data_80_Niclosamide$upper_bound_real[merged_data_80_Niclosamide$upper_bound_real <= 0] <- 1e-10

##and for NULL model:
# Create lower and upper bounds considering mean ¬± sd
merged_data_80_Niclosamide_NULL$lower_bound_null <- merged_data_80_Niclosamide_NULL$mean_rel_ab.null - merged_data_80_Niclosamide_NULL$sd_rel_ab.null
merged_data_80_Niclosamide_NULL$upper_bound_null <- merged_data_80_Niclosamide_NULL$mean_rel_ab.null + merged_data_80_Niclosamide_NULL$sd_rel_ab.null
merged_data_80_Niclosamide_NULL$lower_bound_real <- merged_data_80_Niclosamide_NULL$mean_rel_ab.real - merged_data_80_Niclosamide_NULL$sd_rel_ab.real
merged_data_80_Niclosamide_NULL$upper_bound_real <- merged_data_80_Niclosamide_NULL$mean_rel_ab.real + merged_data_80_Niclosamide_NULL$sd_rel_ab.real

# Ensure lower and upper bounds are non-negative, adjusting as necessary
merged_data_80_Niclosamide_NULL$lower_bound_null[merged_data_80_Niclosamide_NULL$lower_bound_null <= 0] <- 1e-10
merged_data_80_Niclosamide_NULL$lower_bound_real[merged_data_80_Niclosamide_NULL$lower_bound_real <= 0] <- 1e-10
merged_data_80_Niclosamide_NULL$upper_bound_null[merged_data_80_Niclosamide_NULL$upper_bound_null <= 0] <- 1e-10
merged_data_80_Niclosamide_NULL$upper_bound_real[merged_data_80_Niclosamide_NULL$upper_bound_real <= 0] <- 1e-10

# Filter to include only species with a mean relative abundance > 0.01 in the 'real' dataset
significant_species <- merged_data_80_Niclosamide[merged_data_80_Niclosamide$mean_rel_ab.real > 0.01, ]
survivors_80_Niclosamide <- nrow(significant_species)
survivors_80_Niclosamide

#should be the same as survivors defined above, since it is calculated from .real
significant_species_NULL <- merged_data_80_Niclosamide_NULL[merged_data_80_Niclosamide_NULL$mean_rel_ab.real > 0.01, ]
survivors_80_Niclosamide_NULL <- nrow(significant_species_NULL)
survivors_80_Niclosamide_NULL

# Adjusted order of magnitude check to include SD, only for significant species
significant_species$Predicted_magnitude_correct <- ifelse(
  (floor(log10(significant_species$lower_bound_pred)) <= floor(log10(significant_species$upper_bound_real)) &
     floor(log10(significant_species$upper_bound_pred)) >= floor(log10(significant_species$lower_bound_real))),
  1,
  0
)

#and for the Null model:
significant_species_NULL$Predicted_magnitude_correct <- ifelse(
  (floor(log10(significant_species_NULL$lower_bound_null)) <= floor(log10(significant_species_NULL$upper_bound_real)) &
     floor(log10(significant_species_NULL$upper_bound_null)) >= floor(log10(significant_species_NULL$lower_bound_real))),
  1,
  0
)

# Calculate the fraction of correctly predicted magnitudes for significant species
predicted_magnitude_correct_fraction_80_Niclosamide <- sum(significant_species$Predicted_magnitude_correct) / nrow(significant_species)
predicted_magnitude_correct_fraction_80_Niclosamide

predicted_magnitude_correct_fraction_80_Niclosamide_NULL <- sum(significant_species_NULL$Predicted_magnitude_correct) / nrow(significant_species_NULL)
predicted_magnitude_correct_fraction_80_Niclosamide_NULL


top_species_missing_80_Niclosamide <- setdiff(top6_real_80_Niclosamide_means, top6_predicted_80_Niclosamide_means)
top_species_wrong_80_Niclosamide <- setdiff(top6_predicted_80_Niclosamide_means, top6_real_80_Niclosamide_means)

Prediction_quality_80_Niclosamide <- data.frame(
  Top_six_correct = paste(top_six_correct_80_Niclosamide, sep=""),
  Top_six_correct_NULL = paste(top_six_correct_80_Niclosamide_NULL, sep=""),
  Top_six_correct_means = paste(top_six_correct_80_Niclosamide_means, sep=""),
  Top_six_correct_means_NULL = paste(top_six_correct_80_Niclosamide_means_NULL, sep=""),
  Predicted_magnitude_correct = paste(round(predicted_magnitude_correct_fraction_80_Niclosamide * 100, 2), "%", sep=""),
  Predicted_magnitude_correct_NULL = paste(round(predicted_magnitude_correct_fraction_80_Niclosamide_NULL * 100, 2), "%", sep=""),
  survivors_total = survivors_80_Niclosamide,
  top_species_missing <- top_species_missing_80_Niclosamide,
  top_species_wrong <- top_species_wrong_80_Niclosamide, 
  predicted_mean_final_OD <- predicted_mean_final_od_80_Niclosamide,
  real_mean_final_OD <- real_mean_final_od_80_Niclosamide,
  sims_total = length(successful_sim_ids)
)

Prediction_quality_80_Niclosamide









##Nifurtimox

combined_monoculture_aucs2_Nifurtimox <- subset(combined_monoculture_aucs2, drug == "Nifurtimox")


#drug sensitivity terms: define once outside of ODEs
y_function_B_vulgatus_Nifurtimox <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("B_vulgatus", "Nifurtimox", best_fitting_models_df_Nifurtimox)), collapse = " ")))
y_function_B_uniformis_Nifurtimox <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("B_uniformis", "Nifurtimox", best_fitting_models_df_Nifurtimox)), collapse = " ")))
y_function_B_fragilis_Nifurtimox <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("B_fragilis", "Nifurtimox", best_fitting_models_df_Nifurtimox)), collapse = " ")))
y_function_B_thetaiotaomicron_Nifurtimox <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("B_thetaiotaomicron", "Nifurtimox", best_fitting_models_df_Nifurtimox)), collapse = " ")))
y_function_C_ramosum_Nifurtimox <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("C_ramosum", "Nifurtimox", best_fitting_models_df_Nifurtimox)), collapse = " ")))
y_function_E_rectale_Nifurtimox <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("E_rectale", "Nifurtimox", best_fitting_models_df_Nifurtimox)), collapse = " ")))
y_function_R_intestinalis_Nifurtimox <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("R_intestinalis", "Nifurtimox", best_fitting_models_df_Nifurtimox)), collapse = " ")))
y_function_V_parvula_Nifurtimox <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("V_parvula", "Nifurtimox", best_fitting_models_df_Nifurtimox)), collapse = " ")))
y_function_E_lenta_Nifurtimox <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("E_lenta", "Nifurtimox", best_fitting_models_df_Nifurtimox)), collapse = " ")))
y_function_F_nucleatum_Nifurtimox <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("F_nucleatum", "Nifurtimox", best_fitting_models_df_Nifurtimox)), collapse = " ")))
y_function_C_bolteae_Nifurtimox <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("C_bolteae", "Nifurtimox", best_fitting_models_df_Nifurtimox)), collapse = " ")))
y_function_C_perfringens_Nifurtimox <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("C_perfringens", "Nifurtimox", best_fitting_models_df_Nifurtimox)), collapse = " ")))
y_function_C_saccharolyticum_Nifurtimox <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("C_saccharolyticum", "Nifurtimox", best_fitting_models_df_Nifurtimox)), collapse = " ")))
y_function_S_salivarius_Nifurtimox <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("S_salivarius", "Nifurtimox", best_fitting_models_df_Nifurtimox)), collapse = " ")))
y_function_R_gnavus_Nifurtimox <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("R_gnavus", "Nifurtimox", best_fitting_models_df_Nifurtimox)), collapse = " ")))
y_function_C_comes_Nifurtimox <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("C_comes", "Nifurtimox", best_fitting_models_df_Nifurtimox)), collapse = " ")))
y_function_P_merdae_Nifurtimox <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("P_merdae", "Nifurtimox", best_fitting_models_df_Nifurtimox)), collapse = " ")))
y_function_S_parasanguinis_Nifurtimox <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("S_parasanguinis", "Nifurtimox", best_fitting_models_df_Nifurtimox)), collapse = " ")))
y_function_C_aerofaciens_Nifurtimox <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("C_aerofaciens", "Nifurtimox", best_fitting_models_df_Nifurtimox)), collapse = " ")))
y_function_D_formicigenerans_Nifurtimox <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("D_formicigenerans", "Nifurtimox", best_fitting_models_df_Nifurtimox)), collapse = " ")))
y_function_E_coli_Nifurtimox <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("E_coli", "Nifurtimox", best_fitting_models_df_Nifurtimox)), collapse = " ")))



y_function_B_vulgatus_Nifurtimox_func <- eval(parse(text = paste("function(Drug) {", y_function_B_vulgatus_Nifurtimox, "}")))
y_function_B_uniformis_Nifurtimox_func <- eval(parse(text = paste("function(Drug) {", y_function_B_uniformis_Nifurtimox, "}")))
y_function_B_fragilis_Nifurtimox_func <- eval(parse(text = paste("function(Drug) {", y_function_B_fragilis_Nifurtimox, "}")))
y_function_B_thetaiotaomicron_Nifurtimox_func <- eval(parse(text = paste("function(Drug) {", y_function_B_thetaiotaomicron_Nifurtimox, "}")))
y_function_C_ramosum_Nifurtimox_func <- eval(parse(text = paste("function(Drug) {", y_function_C_ramosum_Nifurtimox, "}")))
y_function_E_rectale_Nifurtimox_func <- eval(parse(text = paste("function(Drug) {", y_function_E_rectale_Nifurtimox, "}")))
y_function_R_intestinalis_Nifurtimox_func <- eval(parse(text = paste("function(Drug) {", y_function_R_intestinalis_Nifurtimox, "}")))
y_function_E_lenta_Nifurtimox_func <- eval(parse(text = paste("function(Drug) {", y_function_E_lenta_Nifurtimox, "}")))
y_function_F_nucleatum_Nifurtimox_func <- eval(parse(text = paste("function(Drug) {", y_function_F_nucleatum_Nifurtimox, "}")))
y_function_C_bolteae_Nifurtimox_func <- eval(parse(text = paste("function(Drug) {", y_function_C_bolteae_Nifurtimox, "}")))
y_function_C_perfringens_Nifurtimox_func <- eval(parse(text = paste("function(Drug) {", y_function_C_perfringens_Nifurtimox, "}")))
y_function_C_saccharolyticum_Nifurtimox_func <- eval(parse(text = paste("function(Drug) {", y_function_C_saccharolyticum_Nifurtimox, "}")))
y_function_S_salivarius_Nifurtimox_func <- eval(parse(text = paste("function(Drug) {", y_function_S_salivarius_Nifurtimox, "}")))
y_function_R_gnavus_Nifurtimox_func <- eval(parse(text = paste("function(Drug) {", y_function_R_gnavus_Nifurtimox, "}")))
y_function_C_comes_Nifurtimox_func <- eval(parse(text = paste("function(Drug) {", y_function_C_comes_Nifurtimox, "}")))
y_function_P_merdae_Nifurtimox_func <- eval(parse(text = paste("function(Drug) {", y_function_P_merdae_Nifurtimox, "}")))
y_function_S_parasanguinis_Nifurtimox_func <- eval(parse(text = paste("function(Drug) {", y_function_S_parasanguinis_Nifurtimox, "}")))
y_function_C_aerofaciens_Nifurtimox_func <- eval(parse(text = paste("function(Drug) {", y_function_C_aerofaciens_Nifurtimox, "}")))
y_function_D_formicigenerans_Nifurtimox_func <- eval(parse(text = paste("function(Drug) {", y_function_D_formicigenerans_Nifurtimox, "}")))
y_function_E_coli_Nifurtimox_func <- eval(parse(text = paste("function(Drug) {", y_function_E_coli_Nifurtimox, "}")))
y_function_V_parvula_Nifurtimox_func <- eval(parse(text = paste("function(Drug) {", y_function_V_parvula_Nifurtimox, "}")))



unique(combined_monoculture_aucs2_Nifurtimox$conc)
##dictate drug concentration tested for simulation cycle here:
#drug_concentration_tested <- 2.5  #if manually or:
drug_concentration_tested <- unique(combined_monoculture_aucs2_Nifurtimox$conc)[1] 
initial_conditions <- rep(0.01/32, 32)
initial_conditions <- c(initial_conditions, drug_concentration_tested)


##drug effect fitted for species showing sensitivity in monoculture:
#unique(combined_monoculture_aucs2_Nifurtimox$Species)

##for more simple linear fits
closed.sir.model_Nifurtimox <- function (t, x, params) {
  ## first extract the state variables
  A_muciniphila <- x[1]
  B_adolescentis <- x[2]
  B_fragilis <- x[3]
  B_longum <- x[4]
  B_obeum <- x[5]
  B_thetaiotaomicron <- x[6]
  B_uniformis <- x[7]
  B_vulgatus <- x[8]
  B_wadsworthia <- x[9]
  C_aerofaciens <- x[10]
  C_bolteae <- x[11]
  C_comes <- x[12]
  C_perfringens <- x[13]
  C_ramosum <- x[14]
  C_saccharolyticum <- x[15]
  D_formicigenerans <- x[16]
  E_coli <- x[17]
  E_lenta <- x[18]
  E_rectale <- x[19]
  F_nucleatum <- x[20]
  L_paracasei <- x[21]
  O_splanchnicus <- x[22]
  P_copri <- x[23]
  P_distasonis <- x[24]
  P_merdae <- x[25]
  R_bromii <- x[26]
  R_gnavus <- x[27]
  R_intestinalis <- x[28]
  R_torques <- x[29]
  S_parasanguinis <- x[30]
  S_salivarius <- x[31]
  V_parvula <- x[32]
  Drug <- x[33]
  
  
  ## now extract the parameters
  r_B_fragilis <- flat_params[["B._fragilis.r"]]
  K_B_fragilis <- flat_params[["B._fragilis.K"]]
  r_B_longum <- flat_params[["B._longum.r"]]
  K_B_longum <- flat_params[["B._longum.K"]]
  r_B_thetaiotaomicron <- flat_params[["B._thetaiotaomicron.r"]]
  K_B_thetaiotaomicron <- flat_params[["B._thetaiotaomicron.K"]]
  r_B_uniformis <- flat_params[["B._uniformis.r"]]
  K_B_uniformis <- flat_params[["B._uniformis.K"]]
  r_B_vulgatus <- flat_params[["B._vulgatus.r"]]
  K_B_vulgatus <- flat_params[["B._vulgatus.K"]]
  r_B_wadsworthia <- flat_params[["B._wadsworthia.r"]]
  K_B_wadsworthia <- flat_params[["B._wadsworthia.K"]]
  r_C_aerofaciens <- flat_params[["C._aerofaciens.r"]]
  K_C_aerofaciens <- flat_params[["C._aerofaciens.K"]]
  r_C_bolteae <- flat_params[["C._bolteae.r"]]
  K_C_bolteae <- flat_params[["C._bolteae.K"]]
  r_C_comes <- flat_params[["C._comes.r"]]
  K_C_comes <- flat_params[["C._comes.K"]]
  r_C_perfringens <- flat_params[["C._perfringens.r"]]
  K_C_perfringens <- flat_params[["C._perfringens.K"]]
  r_C_ramosum <- flat_params[["C._ramosum.r"]]
  K_C_ramosum <- flat_params[["C._ramosum.K"]]
  r_C_saccharolyticum <- flat_params[["C._saccharolyticum.r"]]
  K_C_saccharolyticum <- flat_params[["C._saccharolyticum.K"]]
  r_D_formicigenerans <- flat_params[["D._formicigenerans.r"]]
  K_D_formicigenerans <- flat_params[["D._formicigenerans.K"]]
  r_E_coli <- flat_params[["E._coli.r"]]
  K_E_coli <- flat_params[["E._coli.K"]]
  r_E_lenta <- flat_params[["E._lenta.r"]]
  K_E_lenta <- flat_params[["E._lenta.K"]]
  r_E_rectale <- flat_params[["E._rectale.r"]]
  K_E_rectale <- flat_params[["E._rectale.K"]]
  r_F_nucleatum <- flat_params[["F._nucleatum.r"]]
  K_F_nucleatum <- flat_params[["F._nucleatum.K"]]
  r_P_copri <- flat_params[["P._copri.r"]]
  K_P_copri <- flat_params[["P._copri.K"]]
  r_P_merdae <- flat_params[["P._merdae.r"]]
  K_P_merdae <- flat_params[["P._merdae.K"]]
  r_R_gnavus <- flat_params[["R._gnavus.r"]]
  K_R_gnavus <- flat_params[["R._gnavus.K"]]
  r_R_intestinalis <- flat_params[["R._intestinalis.r"]]
  K_R_intestinalis <- flat_params[["R._intestinalis.K"]]
  r_V_parvula <- flat_params[["V._parvula.r"]]
  K_V_parvula <- flat_params[["V._parvula.K"]]
  r_A_muciniphila <- flat_params[["A._muciniphila.r"]]
  K_A_muciniphila <- flat_params[["A._muciniphila.K"]]
  r_B_adolescentis <- flat_params[["B._adolescentis.r"]]
  K_B_adolescentis <- flat_params[["B._adolescentis.K"]]
  r_B_obeum <- flat_params[["B._obeum.r"]]
  K_B_obeum <- flat_params[["B._obeum.K"]]
  r_O_splanchnicus <- flat_params[["O._splanchnicus.r"]]
  K_O_splanchnicus <- flat_params[["O._splanchnicus.K"]]
  r_P_distasonis <- flat_params[["P._distasonis.r"]]
  K_P_distasonis <- flat_params[["P._distasonis.K"]]
  r_R_bromii <- flat_params[["R._bromii.r"]]
  K_R_bromii <- flat_params[["R._bromii.K"]]
  r_R_torques <- flat_params[["R._torques.r"]]
  K_R_torques <- flat_params[["R._torques.K"]]
  r_S_parasanguinis <- flat_params[["S._parasanguinis.r"]]
  K_S_parasanguinis <-flat_params[["S._parasanguinis.K"]]
  r_S_salivarius <- flat_params[["S._salivarius.r"]]
  K_S_salivarius <- flat_params[["S._salivarius.K"]]
  r_L_paracasei <- flat_params[["L._paracasei.r"]]
  K_L_paracasei <- flat_params[["L._paracasei.K"]]
  
  
  t_mod <- ifelse(t > 24.1, t - 24.1, t)
  
  
  ## now code the model equations
  dA_muciniphila_dt <- r_A_muciniphila * A_muciniphila * (1 - A_muciniphila / K_A_muciniphila)
  dB_adolescentis_dt <- r_B_adolescentis * B_adolescentis * (1 - B_adolescentis / K_B_adolescentis)
  dB_fragilis_dt <- r_B_fragilis * B_fragilis * (1 - B_fragilis / max(0.0001, K_B_fragilis * (y_function_B_fragilis_Nifurtimox_func(Drug))))
  dB_longum_dt <- r_B_longum * B_longum * (1 - B_longum / K_B_longum)
  dB_obeum_dt <- r_B_obeum * B_obeum * (1 - B_obeum / K_B_obeum)
  dB_thetaiotaomicron_dt <- r_B_thetaiotaomicron * B_thetaiotaomicron * (1 - B_thetaiotaomicron / max(0.0001, K_B_thetaiotaomicron * (y_function_B_thetaiotaomicron_Nifurtimox_func(Drug))))  
  dB_uniformis_dt <- r_B_uniformis * B_uniformis * (1 - B_uniformis / max(0.0001, K_B_uniformis * (y_function_B_uniformis_Nifurtimox_func(Drug))))
  dB_vulgatus_dt <- r_B_vulgatus * B_vulgatus * (1 - B_vulgatus / max(0.0001, K_B_vulgatus * (y_function_B_vulgatus_Nifurtimox_func(Drug))))
  dB_wadsworthia_dt <- r_B_wadsworthia * B_wadsworthia * (1 - B_wadsworthia / K_B_wadsworthia)
  dC_aerofaciens_dt <- r_C_aerofaciens * C_aerofaciens * (1 - C_aerofaciens / max(0.0001, K_C_aerofaciens * (y_function_C_aerofaciens_Nifurtimox_func(Drug))))
  dC_bolteae_dt <- r_C_bolteae * C_bolteae * (1 - C_bolteae /  max(0.0001, K_C_bolteae * (y_function_C_bolteae_Nifurtimox_func(Drug))))
  dC_comes_dt <- r_C_comes * C_comes * (1 - C_comes / max(0.0001, K_C_comes * (y_function_C_comes_Nifurtimox_func(Drug))))
  dC_perfringens_dt <- r_C_perfringens * C_perfringens * (1 - C_perfringens / max(0.0001, K_C_perfringens * (y_function_C_perfringens_Nifurtimox_func(Drug))))
  dC_ramosum_dt <- r_C_ramosum * C_ramosum * (1 - C_ramosum / max(0.0001, K_C_ramosum * (y_function_C_ramosum_Nifurtimox_func(Drug))))
  dC_saccharolyticum_dt <- r_C_saccharolyticum * C_saccharolyticum * (1 - C_saccharolyticum / max(0.0001, K_C_saccharolyticum * (y_function_C_saccharolyticum_Nifurtimox_func(Drug))))
  dD_formicigenerans_dt <- r_D_formicigenerans * D_formicigenerans * (1 - D_formicigenerans / max(0.0001, K_D_formicigenerans * (y_function_D_formicigenerans_Nifurtimox_func(Drug))))
  dE_coli_dt <- r_E_coli * E_coli * (1 - E_coli / max(0.0001, K_E_coli * (y_function_E_coli_Nifurtimox_func(Drug))))
  dE_lenta_dt <- r_E_lenta * E_lenta * (1 - E_lenta / max(0.0001, K_E_lenta * (y_function_E_lenta_Nifurtimox_func(Drug))))
  dE_rectale_dt <- r_E_rectale * E_rectale * (1 - E_rectale / max(0.0001, K_E_rectale * (y_function_E_rectale_Nifurtimox_func(Drug))))
  dF_nucleatum_dt <- r_F_nucleatum * F_nucleatum * (1 - F_nucleatum / max(0.0001, K_F_nucleatum * (y_function_F_nucleatum_Nifurtimox_func(Drug))))
  dL_paracasei_dt <- r_L_paracasei * L_paracasei * (1 - L_paracasei / K_L_paracasei)  
  dO_splanchnicus_dt <- r_O_splanchnicus * O_splanchnicus * (1 - O_splanchnicus / K_O_splanchnicus)  
  dP_copri_dt <- r_P_copri * P_copri * (1 - P_copri / K_P_copri)
  dP_distasonis_dt <- r_P_distasonis * P_distasonis * (1 - P_distasonis / K_P_distasonis)  
  dP_merdae_dt <- r_P_merdae * P_merdae * (1 - P_merdae / max(0.0001, K_P_merdae * (y_function_P_merdae_Nifurtimox_func(Drug))))
  dR_bromii_dt <- r_R_bromii * R_bromii * (1 - R_bromii / K_R_bromii) 
  dR_gnavus_dt <- r_R_gnavus * R_gnavus * (1 - R_gnavus / max(0.0001, K_R_gnavus * (y_function_R_gnavus_Nifurtimox_func(Drug))))
  dR_intestinalis_dt <- r_R_intestinalis * R_intestinalis * (1 - R_intestinalis / max(0.0001, K_R_intestinalis * (y_function_R_intestinalis_Nifurtimox_func(Drug))))
  dR_torques_dt <- r_R_torques * R_torques * (1 - R_torques /K_R_torques) 
  dS_parasanguinis_dt <- r_S_parasanguinis * S_parasanguinis * (1 - S_parasanguinis / max(0.0001, K_S_parasanguinis * (y_function_S_parasanguinis_Nifurtimox_func(Drug))))
  dS_salivarius_dt <- r_S_salivarius * S_salivarius * (1 - S_salivarius / max(0.0001, K_S_salivarius * (y_function_S_salivarius_Nifurtimox_func(Drug))))
  dV_parvula_dt <- r_V_parvula * V_parvula * (1 - V_parvula / max(0.0001, K_V_parvula * (y_function_V_parvula_Nifurtimox_func(Drug))))
  
  
  
  #Drug differential:
  #because it is degraded to near-zero levels, we need to ensure it doesnt upset the non-linear dependencies; hence the + 0.0001 to the prop_left term:
  dDrug_dt <- (subset(drug_dynamics, Drug == "Nifurtimox")$Steepness_param_community * exp(-subset(drug_dynamics, Drug == "Nifurtimox")$Steepness_param_community * t_mod)) * (drug_concentration_tested * (prop_left_Nifurtimox + 0.0001) - drug_concentration_tested)
  #dDrug_dt <- 0
  
  ## Combine results into a single vector
  dxdt <- c(dA_muciniphila_dt, dB_adolescentis_dt, dB_fragilis_dt, dB_longum_dt, dB_obeum_dt, dB_thetaiotaomicron_dt, dB_uniformis_dt, dB_vulgatus_dt, dB_wadsworthia_dt, dC_aerofaciens_dt, dC_bolteae_dt, dC_comes_dt, dC_perfringens_dt, dC_ramosum_dt, dC_saccharolyticum_dt, dD_formicigenerans_dt, dE_coli_dt, dE_lenta_dt, dE_rectale_dt, dF_nucleatum_dt, dL_paracasei_dt, dO_splanchnicus_dt, dP_copri_dt, dP_distasonis_dt, dP_merdae_dt, dR_bromii_dt, dR_gnavus_dt, dR_intestinalis_dt, dR_torques_dt, dS_parasanguinis_dt, dS_salivarius_dt, dV_parvula_dt, dDrug_dt)
  
  ## Return result as a list
  list(dxdt)
}




#calculate the co-culture correction factor per species based on community composition in absence of drug, just like done for Niclosamide

growth_data_all_0_Niclosamide
growth_data_all_0_Niclosamide1 <- growth_data_all_0_Niclosamide %>%
  dplyr::mutate(Species = gsub(" ", "_", Species))


# Merge rel_ab_control with growth_data_all_0_Niclosamide on Species
# Function to remove duplicated columns by name pattern
clean_columns_base <- function(df, pattern) {
  cols_to_keep <- !grepl(pattern, names(df))
  df <- df[, cols_to_keep]
  return(df)
}

# Use the new function to clean up your dataframe
rel_ab_control <- clean_columns_base(rel_ab_control, "mean_max_OD.[xy]")
str(rel_ab_control)


#rel_ab_control$correction_factor <- rel_ab_control$mean_rel_ab / (rel_ab_control$mean_max_OD/sum(rel_ab_control$mean_max_OD))
# Calculate correction factor with a minimum value of ~1
rel_ab_control$correction_factor <- pmax(rel_ab_control$mean_rel_ab / (rel_ab_control$mean_max_OD / sum(rel_ab_control$mean_max_OD)), 1.1)


# Create a new dataframe for co-culture correction
co_culture_correction <- data.frame(
  species = rel_ab_control$Species,
  correction_factor = rel_ab_control$correction_factor
)


#summarise community data
#Adjust based on tested concentrations for each drug
unique(Community_compositions_focus_drugs_Nifurtimox$concentration)

Community_compositions_focus_drugs_Nifurtimox_35uM <- subset(Community_compositions_focus_drugs_Nifurtimox, concentration == 35)
Community_compositions_focus_drugs_Nifurtimox_20uM <- subset(Community_compositions_focus_drugs_Nifurtimox, concentration == 20)
Community_compositions_focus_drugs_Nifurtimox_2.5uM <- subset(Community_compositions_focus_drugs_Nifurtimox, concentration == 2.5)


#35 uM
Community_compositions_focus_drugs_Nifurtimox_35uM_summarised <- Community_compositions_focus_drugs_Nifurtimox_35uM %>%
  dplyr::group_by(species) %>%                                  
  dplyr::summarize(
    mean_rel_ab = mean(rel_abundance, na.rm = TRUE),     
    sd_rel_ab = sd(rel_abundance, na.rm = TRUE) ,
    mean_max_OD = mean(maxOD, na.rm = TRUE),
    sd_max_OD = sd(maxOD, na.rm = TRUE),
    mean_final_OD = mean(finalOD, na.rm = TRUE),
    sd_final_OD = sd(finalOD, na.rm = TRUE)
  ) %>%
  dplyr::ungroup() 


Community_compositions_focus_drugs_Nifurtimox_35uM_summarised <- Community_compositions_focus_drugs_Nifurtimox_35uM_summarised %>%
  dplyr::mutate(Species = sub("^(\\w)\\w*\\s(.*)", "\\1._\\2", species))

#remove (sub)strain info
Community_compositions_focus_drugs_Nifurtimox_35uM_summarised <- Community_compositions_focus_drugs_Nifurtimox_35uM_summarised %>%
  dplyr::mutate(Species = sub("^(\\w\\._\\w+).*", "\\1", Species))


#20 uM
Community_compositions_focus_drugs_Nifurtimox_20uM_summarised <- Community_compositions_focus_drugs_Nifurtimox_20uM %>%
  dplyr::group_by(species) %>%                                  
  dplyr::summarize(
    mean_rel_ab = mean(rel_abundance, na.rm = TRUE),     
    sd_rel_ab = sd(rel_abundance, na.rm = TRUE) ,
    mean_max_OD = mean(maxOD, na.rm = TRUE),
    sd_max_OD = sd(maxOD, na.rm = TRUE),
    mean_final_OD = mean(finalOD, na.rm = TRUE),
    sd_final_OD = sd(finalOD, na.rm = TRUE)
  ) %>%
  dplyr::ungroup() 


Community_compositions_focus_drugs_Nifurtimox_20uM_summarised <- Community_compositions_focus_drugs_Nifurtimox_20uM_summarised %>%
  dplyr::mutate(Species = sub("^(\\w)\\w*\\s(.*)", "\\1._\\2", species))

#remove (sub)strain info
Community_compositions_focus_drugs_Nifurtimox_20uM_summarised <- Community_compositions_focus_drugs_Nifurtimox_20uM_summarised %>%
  dplyr::mutate(Species = sub("^(\\w\\._\\w+).*", "\\1", Species))


#2.5uM
Community_compositions_focus_drugs_Nifurtimox_2.5uM_summarised <- Community_compositions_focus_drugs_Nifurtimox_2.5uM %>%
  dplyr::group_by(species) %>%                                  
  dplyr::summarize(
    mean_rel_ab = mean(rel_abundance, na.rm = TRUE),     
    sd_rel_ab = sd(rel_abundance, na.rm = TRUE) ,
    mean_max_OD = mean(maxOD, na.rm = TRUE),
    sd_max_OD = sd(maxOD, na.rm = TRUE),    
    mean_final_OD = mean(finalOD, na.rm = TRUE),
    sd_final_OD = sd(finalOD, na.rm = TRUE)
  ) %>%
  dplyr::ungroup() 



Community_compositions_focus_drugs_Nifurtimox_2.5uM_summarised <- Community_compositions_focus_drugs_Nifurtimox_2.5uM_summarised %>%
  dplyr::mutate(Species = sub("^(\\w)\\w*\\s(.*)", "\\1._\\2", species))

#remove (sub)strain info
Community_compositions_focus_drugs_Nifurtimox_2.5uM_summarised <- Community_compositions_focus_drugs_Nifurtimox_2.5uM_summarised %>%
  dplyr::mutate(Species = sub("^(\\w\\._\\w+).*", "\\1", Species))


#Initialise data frames
sim_output <- data.frame()
input_params_list <- list() #Use a list to collect parameters for each simulation

#number of simulations
num_sims <- 250


for (i in 1:num_sims) {
  tryCatch({
    # generate model parameters
    set.seed(i) #set a different seed for each simulation for variation
    params <- lapply(1:nrow(growth_data_all_0_Niclosamide), function(idx) {
      species_params <- growth_data_all_0_Niclosamide[idx, ]
      list(
        r = rnorm(1, mean = species_params$mean_max_Growth_rate, sd = species_params$sd_max_Growth_rate),
        K = rnorm(1, mean = species_params$mean_max_OD, sd = species_params$sd_max_OD)
      )
    })
    names(params) <- gsub(" ", "_", growth_data_all_0_Niclosamide$Species)
    flat_params <- unlist(params)
    names(flat_params) <- gsub("\\.\\d$", "", names(flat_params))
    
    #replace spaces with underscores to match formatting
    co_culture_correction$species <- gsub(" ", "_", co_culture_correction$species, fixed = TRUE)
    
    #replace the species-specific K parameters extracted from monoculture growth data 
    #with drawn relative abundance values at Niclosamide = 0, scaled to K
    rel_ab_control$Species <- gsub(" ", "_", rel_ab_control$Species)
    
    #Initialise an empty vector to store drawn values
    drawn_values <- numeric(nrow(rel_ab_control))
    
    #draw values from their respective distributions
    for (k in 1:nrow(rel_ab_control)) {
      species_name <- rel_ab_control$Species[k]
      drawn_value <- rnorm(1, mean = rel_ab_control$mean_rel_ab[k], sd = rel_ab_control$sd_rel_ab[k])
      drawn_values[k] <- max(drawn_value, 0)  # Ensure no negative values
    }
    
    #Normalise drawn relative abundance values so they sum to 1 (to reflect a 'true' relative abundance distribution)
    #this is needed so when we convert the values into OD units by multiplying with the drawn community maxOD,
    # the sum of K_i parameters and the drawn K are equal
    normalised_values <- drawn_values / sum(drawn_values)
    
    #Pull community maxOD (K) at 0 drugs from respective normal distribution:
    K <- rnorm(n = 1, mean = rel_ab_control$mean_com_max_OD[1], sd = rel_ab_control$sd_com_max_OD[1])
    
    # Assign these normalised values to their respective species' .K parameters
    for (k in 1:nrow(rel_ab_control)) {
      species_name <- rel_ab_control$Species[k]
      k_index <- grep(paste0("^", species_name, "\\.K$"), names(flat_params))
      
      if (length(k_index) > 0) {
        old_value <- flat_params[k_index]
        flat_params[k_index] <- (normalised_values[k] + 0.0001) * K #add small value in case drawn K_i is 0, which would cause issues with the solver
        cat(sprintf("Updated %s from %f to %f using normalised value %f scaled by K %f\n", names(flat_params)[k_index], old_value, flat_params[k_index], normalised_values[k], K))
      }
    }
    
    #Accounting for variation in drug degradation by community, with standard deviation of end concentration (at 10h) around the fitted predicted (relative) end concentration at 24h
    #prop_left_Nifurtimox <- abs(rnorm(1, (subset(drug_dynamics, Drug == "Nifurtimox")$Prop_left_24h_community), (subset(drug_dynamics, Drug == "Nifurtimox")$SD_drug_community))) 
    #below, we account for measurement error rather than ecological drivers that lead to the variability of degradation at the final point measured 
    prop_left_Nifurtimox <- abs(rnorm(
      n = 1, 
      mean = subset(drug_dynamics, Drug == "Nifurtimox")$Prop_left_24h_community, 
      sd = ifelse(
        subset(drug_dynamics, Drug == "Nifurtimox")$SD_drug_community > subset(drug_dynamics, Drug == "Nifurtimox")$SD_drug_community_start, 
        subset(drug_dynamics, Drug == "Nifurtimox")$SD_drug_community - subset(drug_dynamics, Drug == "Nifurtimox")$SD_drug_community_start, 
        subset(drug_dynamics, Drug == "Nifurtimox")$SD_drug_community
      )
    ))
    
    
    #loop through each species in co_culture_correction
    for (j in 1:nrow(co_culture_correction)) {
      # Extract the species name and correction factor
      species_name <- co_culture_correction$species[j]
      correction_factor <- co_culture_correction$correction_factor[j]
      
      # Identify the corresponding growth rate parameter in flat_params
      #by matching the base species name (without .r)
      growth_rate_indices <- grep(paste0("^", species_name, "\\.r$"), names(flat_params))
      
      #take the growth rate parameter and apply the correction factor 
      for (index in growth_rate_indices) {
        flat_params[index] <- flat_params[index] * correction_factor
      }
    }
    
    flat_params
    # Store parameters for each simulation
    input_params_list[[i]] <- c(sim_ID = i, flat_params)
    
    # Run the model for the first 24-hour cycle
    solution_cycle_1 <- ode(y = initial_conditions, times = seq(from = 0, to = 24, by = 0.1), func = closed.sir.model_Nifurtimox, parms = flat_params,   method = "lsoda", rtol = 1e-6, atol = 1e-6)
    
    # Dilution and second cycle
    end_of_cycle_1 <- solution_cycle_1[nrow(solution_cycle_1), -1]
    initial_conditions_cycle_2 <- end_of_cycle_1 / 50
    #accounting for the drugs being added with the new growth cycle as well:
    initial_conditions_cycle_2[33] <- initial_conditions_cycle_2[33] + drug_concentration_tested
    solution_cycle_2 <- ode(y = initial_conditions_cycle_2, times = seq(from = 24, to = 48, by = 0.1), func = closed.sir.model_Nifurtimox, parms = flat_params,  method = "lsoda", rtol = 1e-6, atol = 1e-6)
    
    # Combine and format results
    combined_solution <- rbind(as.data.frame(solution_cycle_1), as.data.frame(solution_cycle_2)[-1,])
    combined_solution$sim_ID <- rep(i, nrow(combined_solution))
    combined_solution <- combined_solution %>%
      tidyr::gather(key = "Species", value = "Density", -time, -sim_ID) %>%
      dplyr::mutate(Hour = time) %>%
      dplyr::select(sim_ID, Hour, Species, Density)
    
    ##Append to sim_output
    sim_output <- rbind(sim_output, combined_solution)
  }, error = function(e) {
    cat(sprintf("Skipping simulation %d due to an error: %s\n", i, e$message))
  })
}



##Combine all parameter data into a single dataframe
input_params <- do.call(rbind, input_params_list)

# Add a "Species" column 
sim_output$Species_name <- species_names[as.numeric(as.character(sim_output$Species))]
sim_output$Species_name <- replace_na(sim_output$Species_name, "Drug")

#View(input_params)
#View(sim_output)

sim_output <- na.omit(sim_output)
successful_sim_ids <- unique(subset(sim_output, Hour == 48)$sim_ID)
length(successful_sim_ids)
sim_output1 <- sim_output[sim_output$sim_ID %in% successful_sim_ids, ]


#Transform sim_output so we have wide format by Species
sim_output_wide <- tidyr::pivot_wider(sim_output1, 
                                      names_from = Species_name, 
                                      values_from = Density,
                                      id_cols = c(sim_ID, Hour))

length(unique(sim_output_wide$sim_ID))
#calc community OD per timepoint
sim_output_wide$Total_OD <- rowSums(sim_output_wide[, 3:34], na.rm = TRUE)
#calculate and add relative abundances here as well:
species_columns <- colnames(sim_output_wide)[3:34] 

for (species in species_columns) {
  sim_output_wide[[paste0("rel_", species)]] <- sim_output_wide[[species]] / sim_output_wide$Total_OD
}


#assign sim_output_wide test conditions to dataframe name
drug_tested <- "Nifurtimox"
variable_name_1 <- paste0("sim_output_wide_", ifelse(drug_concentration_tested == 1e-04, 0, drug_concentration_tested), "_", drug_tested)
assign(variable_name_1, sim_output_wide)

#turn back into long format if interested in plotting relative abundances
cols_needed <- c("sim_ID", "Hour")

sim_output_long <- sim_output_wide %>% 
  dplyr::select(sim_ID, Hour, Drug, starts_with("rel_")) %>% 
  tidyr::pivot_longer(
    cols = c(Drug, starts_with("rel_")),
    names_to = "Species", 
    values_to = "Relative_abundance",
    names_prefix = "rel_",
    names_transform = list(Species = ~ ifelse(.x == "Drug", "Drug", .x))
  ) 

str(sim_output_long)


species_names_1 <- c(
  "A_muciniphila",
  "B_adolescentis",
  "B_fragilis",
  "B_longum",
  "B_obeum",
  "B_thetaiotaomicron",
  "B_uniformis",
  "B_vulgatus",
  "B_wadsworthia",
  "C_aerofaciens",
  "C_bolteae",
  "C_comes",
  "C_perfringens",
  "C_ramosum",
  "C_saccharolyticum",
  "D_formicigenerans",
  "E_coli",
  "E_lenta",
  "E_rectale",
  "F_nucleatum",
  "L_paracasei",
  "O_splanchnicus",
  "P_copri",
  "P_distasonis",
  "P_merdae",
  "R_bromii",
  "R_gnavus",
  "R_intestinalis",
  "R_torques",
  "S_parasanguinis",
  "S_salivarius",
  "V_parvula",
  "Drug"
)

species_colours_1 <- c(
  "A_muciniphila" = "#1f77b4",
  "B_adolescentis" = "#ff7f0e",
  "B_fragilis" = "#2ca02c",
  "B_longum" = "#d62728",
  "B_obeum" = "#9467bd",
  "B_thetaiotaomicron" = "black",
  "B_uniformis" = "#e377c2",
  "B_vulgatus" = "#7f7f7f",
  "B_wadsworthia" = "gold1",
  "C_aerofaciens" = "#aec7e8",
  "C_bolteae" = "#ffbb78",
  "C_comes" = "magenta",
  "C_perfringens" = "#ff9896",
  "C_ramosum" = "#c5b0d5",
  "C_saccharolyticum" = "#c49c94",
  "D_formicigenerans" = "#f7b6d2",
  "E_coli" = "yellow",
  "E_lenta" = "turquoise",
  "E_rectale" = "#393b79",
  "F_nucleatum" = "royalblue2",
  "L_paracasei" = "blue",
  "O_splanchnicus" = "#637939",
  "P_copri" = "cyan",
  "P_distasonis" = "#8c6d31",
  "P_merdae" = "#c7c7c7",
  "R_bromii" = "#e6550d",
  "R_gnavus" = "#e7cb94",
  "R_intestinalis" = "#843c39",
  "R_torques" = "#d6616b",
  "S_parasanguinis" = "orange3",
  "S_salivarius" = "#7b4173",
  "V_parvula" = "#ce6dbd",
  "Drug" = "green"
)



##Plot output for any specific sim:
# ggplot(subset(sim_output, sim_ID == 1 & Species_name != "Drug"), aes(x = Hour, y = Density, group = Species_name, color = Species_name)) +
#   geom_line(size = 1, alpha = 0.7) +
#   scale_color_manual(values = species_colours_1) +
#   labs(title = paste0("Nifurtimox = ", drug_concentration_tested),
#        x = "Time (hours)",
#        y = "Population Density (OD)",
#        color = "Species") +
#   theme_minimal() +
#   theme(legend.position = "right")
# 
# ggplot(subset(sim_output, sim_ID == 3 & Species_name != "Drug"), aes(x = Hour, y = Density, group = Species_name, color = Species_name)) +
#   geom_line(size = 1, alpha = 0.7) +
#   scale_color_manual(values = species_colours_1) +
#   labs(title = paste0("Nifurtimox = ", drug_concentration_tested),
#        x = "Time (hours)",
#        y = "Population Density (OD)",
#        color = "Species") +
#   theme_minimal() +
#   theme(legend.position = "right")


ggplot(subset(sim_output_long, sim_ID == 1), aes(x = Hour, y = Relative_abundance, group = Species, color = Species)) +
  geom_line(size = 1, alpha = 0.7) +
  scale_color_manual(values = species_colours_1) +
  labs(title = paste0("Nifurtimox = ", drug_concentration_tested),
       x = "Time (hours)",
       y = "Relative abundance",
       color = "Species") +
  theme_minimal() +
  theme(legend.position = "right")


ggplot(subset(sim_output_long, sim_ID == 3), aes(x = Hour, y = Relative_abundance, group = Species, color = Species)) +
  geom_line(size = 1, alpha = 0.7) +
  scale_color_manual(values = species_colours_1) +
  labs(title = paste0("Nifurtimox = ", drug_concentration_tested),
       x = "Time (hours)",
       y = "Relative abundance",
       color = "Species") +
  theme_minimal() +
  theme(legend.position = "right")


#calc mean and standard deviation across sims
sim_stats <- sim_output_long %>%
  dplyr::group_by(Hour, Species) %>%
  dplyr::summarise(
    mean_rel_ab = mean(Relative_abundance),
    sd_rel_ab = sd(Relative_abundance),
    .groups = 'drop'
  )

# Prepare the data for plotting
plot_data <- sim_stats %>%
  dplyr::mutate(Upper = mean_rel_ab + sd_rel_ab, Lower = mean_rel_ab - sd_rel_ab)

ggplot(subset(plot_data, Species != "Drug"), aes(x = Hour, y = mean_rel_ab, group = Species, color = Species)) +
  geom_ribbon(aes(ymin = Lower, ymax = Upper, fill = Species), colour = NA, alpha = 0.2) +  
  geom_line(size = 1, alpha = 0.7) + 
  scale_color_manual(values = species_colours_1) +
  scale_fill_manual(values = species_colours_1) +  
  labs(title = "Mean and SD of Relative Abundance Across Simulations",
       subtitle = paste0("Nifurtimox = ", drug_concentration_tested),       
       x = "Time (hours)",
       y = "Relative abundance",
       color = "Species",
       fill = "Species") +
  theme_minimal() +
  theme(legend.position = "right")

#log-scaled mean trends
ggplot(plot_data, aes(x = Hour, y = log10(mean_rel_ab + 0.0001), group = Species, color = Species)) +
  geom_line(size = 1, alpha = 0.7) +  # Mean line
  scale_color_manual(values = species_colours_1) +
  scale_fill_manual(values = species_colours_1) +  # Ensure consistent colors for lines and fills
  labs(title = "Mean and SD of Relative Abundance Across Simulations",
       subtitle = paste0("Nifurtimox = ", drug_concentration_tested),
       x = "Time (hours)",
       y = "Relative abundance",
       color = "Species",
       fill = "Species") +
  theme_minimal() +
  theme(legend.position = "right")




##prediction quality evaluation
drug_tested <- "Nifurtimox"
variable_name <- paste0("plot_data_", ifelse(drug_concentration_tested == 1e-04, 0, drug_concentration_tested), "_", drug_tested)
assign(variable_name, plot_data)


#extract total OD info:
predicted_mean_final_od_NULL <- Niclosamide_16S_0uM_summarised$mean_com_final_OD[1]
predicted_sd_final_od_NULL <- Niclosamide_16S_0uM_summarised$sd_com_final_OD[1]

predicted_mean_final_od_35_Nifurtimox <- mean(subset(sim_output_wide_35_Nifurtimox, Hour == 48)$Total_OD, na.rm = TRUE)
predicted_sd_final_od_35_Nifurtimox <- sd(subset(sim_output_wide_35_Nifurtimox, Hour == 48)$Total_OD, na.rm = TRUE)

real_mean_final_od_35_Nifurtimox <- Community_compositions_focus_drugs_Nifurtimox_35uM_summarised$mean_final_OD[1]
real_sd_final_od_35_Nifurtimox <- Community_compositions_focus_drugs_Nifurtimox_35uM_summarised$sd_final_OD[1]


predicted_mean_final_od_20_Nifurtimox <- mean(subset(sim_output_wide_20_Nifurtimox, Hour == 48)$Total_OD, na.rm = TRUE)
predicted_sd_final_od_20_Nifurtimox <- sd(subset(sim_output_wide_20_Nifurtimox, Hour == 48)$Total_OD, na.rm = TRUE)

real_mean_final_od_20_Nifurtimox <- Community_compositions_focus_drugs_Nifurtimox_20uM_summarised$mean_final_OD[1]
real_sd_final_od_20_Nifurtimox <- Community_compositions_focus_drugs_Nifurtimox_20uM_summarised$sd_final_OD[1]


predicted_mean_final_od_2.5_Nifurtimox <- mean(subset(sim_output_wide_2.5_Nifurtimox, Hour == 48)$Total_OD, na.rm = TRUE)
predicted_sd_final_od_2.5_Nifurtimox <- sd(subset(sim_output_wide_2.5_Nifurtimox, Hour == 48)$Total_OD, na.rm = TRUE)

real_mean_final_od_2.5_Nifurtimox <- Community_compositions_focus_drugs_Nifurtimox_2.5uM_summarised$mean_final_OD[1]
real_sd_final_od_2.5_Nifurtimox <- Community_compositions_focus_drugs_Nifurtimox_2.5uM_summarised$sd_final_OD[1]




#plot_data_0_Nifurtimox_endpoint was used to test model performance at 0 drugs
#plot_data_0_Nifurtimox_endpoint <- subset(plot_data_0_Nifurtimox, Hour == 48 & Species != "Drug")
plot_data_35_Nifurtimox_endpoint <- subset(plot_data_35_Nifurtimox, Hour == 48 & Species != "Drug")
plot_data_20_Nifurtimox_endpoint <- subset(plot_data_20_Nifurtimox, Hour == 48 & Species != "Drug")
plot_data_2.5_Nifurtimox_endpoint <- subset(plot_data_2.5_Nifurtimox, Hour == 48 & Species != "Drug")

##Inspecting 'match' to real relative abundance distributions:
Niclosamide_16S_0uM_summarised <- rel_ab_control
Niclosamide_16S_0uM_summarised$Species <- gsub("\\.", "", Niclosamide_16S_0uM_summarised$Species)

Nifurtimox_16S_35uM_summarised <- Community_compositions_focus_drugs_Nifurtimox_35uM_summarised
Nifurtimox_16S_20uM_summarised <- Community_compositions_focus_drugs_Nifurtimox_20uM_summarised
Nifurtimox_16S_2.5uM_summarised <- Community_compositions_focus_drugs_Nifurtimox_2.5uM_summarised

Niclosamide_16S_0uM_summarised
Nifurtimox_16S_35uM_summarised 
Nifurtimox_16S_20uM_summarised 
Nifurtimox_16S_2.5uM_summarised 

#Rename 'species' so the outputs become comparable
original_names_2.5 <- unique(Nifurtimox_16S_2.5uM_summarised$species)
original_names_20 <- unique(Nifurtimox_16S_20uM_summarised$species)
original_names_35 <- unique(Nifurtimox_16S_35uM_summarised$species)


##Create a named vector with the original and new names mapping
name_changes <- c(
  "Akkermansia muciniphila" = "A_muciniphila",
  "Bacteroides fragilis" = "B_fragilis",
  "Bacteroides thetaiotaomicron" = "B_thetaiotaomicron",
  "Bacteroides uniformis" = "B_uniformis",
  "Bifidobacterium adolescentis" = "B_adolescentis",
  "Bifidobacterium longum subsp. longum" = "B_longum",
  "Bilophila wadsworthia" = "B_wadsworthia",
  "Blautia obeum" = "B_obeum",
  "Clostridium perfringens" = "C_perfringens",
  "Collinsella aerofaciens" = "C_aerofaciens",
  "Coprococcus comes" = "C_comes",
  "Dorea formicigenerans" = "D_formicigenerans",
  "Eggerthella lenta" = "E_lenta",
  "Enterocloster bolteae" = "C_bolteae",
  "Erysipelatoclostridium ramosum" = "C_ramosum",
  "Escherichia coli ED1a" = "E_coli",
  "Eubacterium rectale" = "E_rectale",
  "Fusobacterium nucleatum subsp. nucleatum" = "F_nucleatum",
  "Lacrimispora saccharolytica" = "C_saccharolyticum",
  "Lacticaseibacillus paracasei" = "L_paracasei",
  "Odoribacter splanchnicus" = "O_splanchnicus",
  "Parabacteroides distasonis" = "P_distasonis",
  "Parabacteroides merdae" = "P_merdae",
  "Phocaeicola vulgatus" = "B_vulgatus",
  "Prevotella copri" = "P_copri",
  "Roseburia intestinalis" = "R_intestinalis",
  "Ruminococcus bromii" = "R_bromii",
  "Ruminococcus gnavus" = "R_gnavus",
  "Ruminococcus torques" = "R_torques",
  "Streptococcus parasanguinis" = "S_parasanguinis",
  "Streptococcus salivarius" = "S_salivarius",
  "Veillonella parvula" = "V_parvula"
)

# Apply name changes to the species column in Nifurtimox_16S_2.5uM_summarised

Nifurtimox_16S_2.5uM_summarised$Species <- name_changes[Nifurtimox_16S_2.5uM_summarised$species]
Nifurtimox_16S_20uM_summarised$Species <- name_changes[Nifurtimox_16S_20uM_summarised$species]
Nifurtimox_16S_35uM_summarised$Species <- name_changes[Nifurtimox_16S_35uM_summarised$species]

# Verify the changes
unique(Nifurtimox_16S_2.5uM_summarised$Species)
unique(Nifurtimox_16S_20uM_summarised$Species)
unique(Nifurtimox_16S_35uM_summarised$Species)



##First, for 35 uM:
# Get top 6 species from plot_data_35_endpoint
# Adjust the plot_data_35_endpoint with confidence bounds

# #plot_data_0_Nifurtimox_endpoint was used to test model performance at 0 drugs
# plot_data_0_Nifurtimox_endpoint <- plot_data_0_Nifurtimox_endpoint %>%
#   dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)

plot_data_35_Nifurtimox_endpoint <- plot_data_35_Nifurtimox_endpoint %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)

# Adjust the Nifurtimox_16S_35uM_summarised with confidence bounds
Nifurtimox_16S_35uM_summarised <- Nifurtimox_16S_35uM_summarised %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)

#NULL model:
Null_model_summarised <- Niclosamide_16S_0uM_summarised %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)


# Get top 6 species based on the lower bound from plot_data_35_endpoint

#top6_predicted_0_Nifurtimox was used to test model performance at 0 drugs
# top6_predicted_0_Nifurtimox <- plot_data_0_Nifurtimox_endpoint %>%
#    arrange(desc(lower_bound)) %>%
#    slice(1:6) %>%
#    pull(Species)

top6_predicted_35_Nifurtimox <- plot_data_35_Nifurtimox_endpoint %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

# Get top 6 species based on the lower bound from Nifurtimox_16S_35uM_summarised
top6_real_35_Nifurtimox <- Nifurtimox_16S_35uM_summarised %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

top6_NULL <- Null_model_summarised %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

# Calculate the overlap of top 6 species

#top_six_correct_0_Nifurtimox was used to assess model performance at 0 drugs
# top_six_correct_0_Nifurtimox <- length(intersect(top6_predicted_0_Nifurtimox, top6_NULL))
# top_six_correct_0_Nifurtimox

top_six_correct_35_Nifurtimox <- length(intersect(top6_predicted_35_Nifurtimox, top6_real_35_Nifurtimox))
top_six_correct_35_Nifurtimox

top_six_correct_35_Nifurtimox_NULL <- length(intersect(top6_NULL, top6_real_35_Nifurtimox))
top_six_correct_35_Nifurtimox_NULL

top6_predicted_35_Nifurtimox
top6_real_35_Nifurtimox

#top6_NULL

#Now by means:
# #top6_predicted_0_Nifurtimox_means was used to assess model performance at 0 drugs
# top6_predicted_0_Nifurtimox_means <- plot_data_0_Nifurtimox_endpoint %>%
#    arrange(desc(mean_rel_ab)) %>%
#    slice(1:6) %>%
#    pull(Species)

top6_predicted_35_Nifurtimox_means <- plot_data_35_Nifurtimox_endpoint %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)

# Get top 6 species based on the lower bound from Nifurtimox_16S_35uM_summarised
top6_real_35_Nifurtimox_means <- Nifurtimox_16S_35uM_summarised %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)

top6_NULL_means <- Null_model_summarised %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)


# #top_six_correct_0_Nifurtimox_means was used to assess model performance at 0 drugs
# top_six_correct_0_Nifurtimox_means <- length(intersect(top6_predicted_0_Nifurtimox_means, top6_NULL_means))
# top_six_correct_0_Nifurtimox_means

top_six_correct_35_Nifurtimox_means <- length(intersect(top6_predicted_35_Nifurtimox_means, top6_real_35_Nifurtimox_means))
top_six_correct_35_Nifurtimox_means

top_six_correct_35_Nifurtimox_means_NULL <- length(intersect(top6_NULL_means, top6_real_35_Nifurtimox_means))
top_six_correct_35_Nifurtimox_means_NULL

top6_predicted_35_Nifurtimox_means
top6_real_35_Nifurtimox_means

#top6_NULL_means


# Merge dataframes by Species

#merged_data_0_Nifurtimox was used to assess model performance at 0 drugs
#merged_data_0_Nifurtimox <- merge(plot_data_0_Nifurtimox_endpoint, Niclosamide_16S_0uM_summarised, by = "Species", suffixes = c(".pred", ".real"))
merged_data_35_Nifurtimox <- merge(plot_data_35_Nifurtimox_endpoint, Nifurtimox_16S_35uM_summarised, by = "Species", suffixes = c(".pred", ".real"))
merged_data_35_Nifurtimox_NULL <- merge(Niclosamide_16S_0uM_summarised, Nifurtimox_16S_35uM_summarised, by = "Species", suffixes = c(".null", ".real"))


## Below lines used for assessing model performance at 0 drugs; ignore for nonzero concentrations
# # Create lower and upper bounds considering mean ¬± sd
# merged_data_0_Nifurtimox$lower_bound_pred <- merged_data_0_Nifurtimox$mean_rel_ab.pred - merged_data_0_Nifurtimox$sd_rel_ab.pred
# merged_data_0_Nifurtimox$upper_bound_pred <- merged_data_0_Nifurtimox$mean_rel_ab.pred + merged_data_0_Nifurtimox$sd_rel_ab.pred
# merged_data_0_Nifurtimox$lower_bound_real <- merged_data_0_Nifurtimox$mean_rel_ab.real - merged_data_0_Nifurtimox$sd_rel_ab.real
# merged_data_0_Nifurtimox$upper_bound_real <- merged_data_0_Nifurtimox$mean_rel_ab.real + merged_data_0_Nifurtimox$sd_rel_ab.real
# 
# # Ensure lower and upper bounds are non-negative, adjusting as necessary
# merged_data_0_Nifurtimox$lower_bound_pred[merged_data_0_Nifurtimox$lower_bound_pred <= 0] <- 1e-10
# merged_data_0_Nifurtimox$lower_bound_real[merged_data_0_Nifurtimox$lower_bound_real <= 0] <- 1e-10
# merged_data_0_Nifurtimox$upper_bound_pred[merged_data_0_Nifurtimox$upper_bound_pred <= 0] <- 1e-10
# merged_data_0_Nifurtimox$upper_bound_real[merged_data_0_Nifurtimox$upper_bound_real <= 0] <- 1e-10


# Create lower and upper bounds considering mean ¬± sd
merged_data_35_Nifurtimox$lower_bound_pred <- merged_data_35_Nifurtimox$mean_rel_ab.pred - merged_data_35_Nifurtimox$sd_rel_ab.pred
merged_data_35_Nifurtimox$upper_bound_pred <- merged_data_35_Nifurtimox$mean_rel_ab.pred + merged_data_35_Nifurtimox$sd_rel_ab.pred
merged_data_35_Nifurtimox$lower_bound_real <- merged_data_35_Nifurtimox$mean_rel_ab.real - merged_data_35_Nifurtimox$sd_rel_ab.real
merged_data_35_Nifurtimox$upper_bound_real <- merged_data_35_Nifurtimox$mean_rel_ab.real + merged_data_35_Nifurtimox$sd_rel_ab.real

# Ensure lower and upper bounds are non-negative, adjusting as necessary
merged_data_35_Nifurtimox$lower_bound_pred[merged_data_35_Nifurtimox$lower_bound_pred <= 0] <- 1e-10
merged_data_35_Nifurtimox$lower_bound_real[merged_data_35_Nifurtimox$lower_bound_real <= 0] <- 1e-10
merged_data_35_Nifurtimox$upper_bound_pred[merged_data_35_Nifurtimox$upper_bound_pred <= 0] <- 1e-10
merged_data_35_Nifurtimox$upper_bound_real[merged_data_35_Nifurtimox$upper_bound_real <= 0] <- 1e-10

##and for NULL model:
# Create lower and upper bounds considering mean ¬± sd
merged_data_35_Nifurtimox_NULL$lower_bound_null <- merged_data_35_Nifurtimox_NULL$mean_rel_ab.null - merged_data_35_Nifurtimox_NULL$sd_rel_ab.null
merged_data_35_Nifurtimox_NULL$upper_bound_null <- merged_data_35_Nifurtimox_NULL$mean_rel_ab.null + merged_data_35_Nifurtimox_NULL$sd_rel_ab.null
merged_data_35_Nifurtimox_NULL$lower_bound_real <- merged_data_35_Nifurtimox_NULL$mean_rel_ab.real - merged_data_35_Nifurtimox_NULL$sd_rel_ab.real
merged_data_35_Nifurtimox_NULL$upper_bound_real <- merged_data_35_Nifurtimox_NULL$mean_rel_ab.real + merged_data_35_Nifurtimox_NULL$sd_rel_ab.real

# Ensure lower and upper bounds are non-negative, adjusting as necessary
merged_data_35_Nifurtimox_NULL$lower_bound_null[merged_data_35_Nifurtimox_NULL$lower_bound_null <= 0] <- 1e-10
merged_data_35_Nifurtimox_NULL$lower_bound_real[merged_data_35_Nifurtimox_NULL$lower_bound_real <= 0] <- 1e-10
merged_data_35_Nifurtimox_NULL$upper_bound_null[merged_data_35_Nifurtimox_NULL$upper_bound_null <= 0] <- 1e-10
merged_data_35_Nifurtimox_NULL$upper_bound_real[merged_data_35_Nifurtimox_NULL$upper_bound_real <= 0] <- 1e-10

# Filter to include only species with a mean relative abundance > 0.01 in the 'real' dataset

## significant_species_0 was used to assess model performance at 0 drugs
#significant_species_0 <- merged_data_0_Nifurtimox[merged_data_0_Nifurtimox$mean_rel_ab.real > 0.01, ]
significant_species <- merged_data_35_Nifurtimox[merged_data_35_Nifurtimox$mean_rel_ab.real > 0.01, ]
survivors_35_Nifurtimox <- nrow(significant_species)
survivors_35_Nifurtimox

#should be the same as survivors defined above, since it is calculated from .real
significant_species_NULL <- merged_data_35_Nifurtimox_NULL[merged_data_35_Nifurtimox_NULL$mean_rel_ab.real > 0.01, ]
survivors_35_Nifurtimox_NULL <- nrow(significant_species_NULL)
survivors_35_Nifurtimox_NULL

# Adjusted order of magnitude check to include SD, only for significant species
## below code was used to assess model performance at 0 drugs
# significant_species_0$Predicted_magnitude_correct <- ifelse(
#   (floor(log10(significant_species_0$lower_bound_pred)) <= floor(log10(significant_species_0$upper_bound_real)) &
#      floor(log10(significant_species_0$upper_bound_pred)) >= floor(log10(significant_species_0$lower_bound_real))),
#   1,
#   0
# )

significant_species$Predicted_magnitude_correct <- ifelse(
  (floor(log10(significant_species$lower_bound_pred)) <= floor(log10(significant_species$upper_bound_real)) &
     floor(log10(significant_species$upper_bound_pred)) >= floor(log10(significant_species$lower_bound_real))),
  1,
  0
)

#and for the Null model:
significant_species_NULL$Predicted_magnitude_correct <- ifelse(
  (floor(log10(significant_species_NULL$lower_bound_null)) <= floor(log10(significant_species_NULL$upper_bound_real)) &
     floor(log10(significant_species_NULL$upper_bound_null)) >= floor(log10(significant_species_NULL$lower_bound_real))),
  1,
  0
)

# Calculate the fraction of correctly predicted magnitudes for significant species
## below code was used to assess model performance at 0 drugs
#predicted_magnitude_correct_fraction_0_Nifurtimox <- sum(significant_species_0$Predicted_magnitude_correct) / nrow(significant_species_0)
#predicted_magnitude_correct_fraction_0_Nifurtimox

predicted_magnitude_correct_fraction_35_Nifurtimox <- sum(significant_species$Predicted_magnitude_correct) / nrow(significant_species)
predicted_magnitude_correct_fraction_35_Nifurtimox

predicted_magnitude_correct_fraction_35_Nifurtimox_NULL <- sum(significant_species_NULL$Predicted_magnitude_correct) / nrow(significant_species_NULL)
predicted_magnitude_correct_fraction_35_Nifurtimox_NULL

top_species_missing_35_Nifurtimox <- setdiff(top6_real_35_Nifurtimox_means, top6_predicted_35_Nifurtimox_means)
top_species_wrong_35_Nifurtimox <- setdiff(top6_predicted_35_Nifurtimox_means, top6_real_35_Nifurtimox_means)


Prediction_quality_35_Nifurtimox <- data.frame(
  Top_six_correct = paste(top_six_correct_35_Nifurtimox, sep=""),
  Top_six_correct_NULL = paste(top_six_correct_35_Nifurtimox_NULL, sep=""),
  Top_six_correct_means = paste(top_six_correct_35_Nifurtimox_means, sep=""),
  Top_six_correct_means_NULL = paste(top_six_correct_35_Nifurtimox_means_NULL, sep=""),
  Predicted_magnitude_correct = paste(round(predicted_magnitude_correct_fraction_35_Nifurtimox * 100, 2), "%", sep=""),
  Predicted_magnitude_correct_NULL = paste(round(predicted_magnitude_correct_fraction_35_Nifurtimox_NULL * 100, 2), "%", sep=""),
  survivors_total = survivors_35_Nifurtimox,
  top_species_missing <- top_species_missing_35_Nifurtimox,
  top_species_wrong <- top_species_wrong_35_Nifurtimox, 
  predicted_mean_final_OD <- predicted_mean_final_od_35_Nifurtimox,
  real_mean_final_OD <- real_mean_final_od_35_Nifurtimox,
  sims_total = length(successful_sim_ids)
)



Prediction_quality_35_Nifurtimox



##Next, for 20 uM:
# Get top 6 species from plot_data_20_endpoint
# Adjust the plot_data_20_endpoint with confidence bounds
plot_data_20_Nifurtimox_endpoint <- plot_data_20_Nifurtimox_endpoint %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)

# Adjust the Nifurtimox_16S_20uM_summarised with confidence bounds
Nifurtimox_16S_20uM_summarised <- Nifurtimox_16S_20uM_summarised %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)

#NULL model:
Null_model_summarised <- Niclosamide_16S_0uM_summarised %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)


# Get top 6 species based on the lower bound from plot_data_20_endpoint
top6_predicted_20_Nifurtimox <- plot_data_20_Nifurtimox_endpoint %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

# Get top 6 species based on the lower bound from Nifurtimox_16S_20uM_summarised
top6_real_20_Nifurtimox <- Nifurtimox_16S_20uM_summarised %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

top6_NULL <- Null_model_summarised %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

# Calculate the overlap of top 6 species
top_six_correct_20_Nifurtimox <- length(intersect(top6_predicted_20_Nifurtimox, top6_real_20_Nifurtimox))
#top_six_correct_20_Nifurtimox

top_six_correct_20_Nifurtimox_NULL <- length(intersect(top6_NULL, top6_real_20_Nifurtimox))
#top_six_correct_20_Nifurtimox_NULL

#top6_predicted_20_Nifurtimox
#top6_real_20_Nifurtimox



#Now by means:
top6_predicted_20_Nifurtimox_means <- plot_data_20_Nifurtimox_endpoint %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)

# Get top 6 species based on the lower bound from Nifurtimox_16S_20uM_summarised
top6_real_20_Nifurtimox_means <- Nifurtimox_16S_20uM_summarised %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)

top6_NULL_means <- Null_model_summarised %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)



top_six_correct_20_Nifurtimox_means <- length(intersect(top6_predicted_20_Nifurtimox_means, top6_real_20_Nifurtimox_means))
#top_six_correct_20_Nifurtimox_means

top_six_correct_20_Nifurtimox_means_NULL <- length(intersect(top6_NULL_means, top6_real_20_Nifurtimox_means))
#top_six_correct_20_Nifurtimox_means_NULL

top6_predicted_20_Nifurtimox_means
#top6_real_20_Nifurtimox_means




# Merge dataframes by Species
merged_data_20_Nifurtimox <- merge(plot_data_20_Nifurtimox_endpoint, Nifurtimox_16S_20uM_summarised, by = "Species", suffixes = c(".pred", ".real"))
merged_data_20_Nifurtimox_NULL <- merge(Niclosamide_16S_0uM_summarised, Nifurtimox_16S_20uM_summarised, by = "Species", suffixes = c(".null", ".real"))



# Create lower and upper bounds considering mean ¬± sd
merged_data_20_Nifurtimox$lower_bound_pred <- merged_data_20_Nifurtimox$mean_rel_ab.pred - merged_data_20_Nifurtimox$sd_rel_ab.pred
merged_data_20_Nifurtimox$upper_bound_pred <- merged_data_20_Nifurtimox$mean_rel_ab.pred + merged_data_20_Nifurtimox$sd_rel_ab.pred
merged_data_20_Nifurtimox$lower_bound_real <- merged_data_20_Nifurtimox$mean_rel_ab.real - merged_data_20_Nifurtimox$sd_rel_ab.real
merged_data_20_Nifurtimox$upper_bound_real <- merged_data_20_Nifurtimox$mean_rel_ab.real + merged_data_20_Nifurtimox$sd_rel_ab.real

# Ensure lower and upper bounds are non-negative, adjusting as necessary
merged_data_20_Nifurtimox$lower_bound_pred[merged_data_20_Nifurtimox$lower_bound_pred <= 0] <- 1e-10
merged_data_20_Nifurtimox$lower_bound_real[merged_data_20_Nifurtimox$lower_bound_real <= 0] <- 1e-10
merged_data_20_Nifurtimox$upper_bound_pred[merged_data_20_Nifurtimox$upper_bound_pred <= 0] <- 1e-10
merged_data_20_Nifurtimox$upper_bound_real[merged_data_20_Nifurtimox$upper_bound_real <= 0] <- 1e-10

##and for NULL model:
# Create lower and upper bounds considering mean ¬± sd
merged_data_20_Nifurtimox_NULL$lower_bound_null <- merged_data_20_Nifurtimox_NULL$mean_rel_ab.null - merged_data_20_Nifurtimox_NULL$sd_rel_ab.null
merged_data_20_Nifurtimox_NULL$upper_bound_null <- merged_data_20_Nifurtimox_NULL$mean_rel_ab.null + merged_data_20_Nifurtimox_NULL$sd_rel_ab.null
merged_data_20_Nifurtimox_NULL$lower_bound_real <- merged_data_20_Nifurtimox_NULL$mean_rel_ab.real - merged_data_20_Nifurtimox_NULL$sd_rel_ab.real
merged_data_20_Nifurtimox_NULL$upper_bound_real <- merged_data_20_Nifurtimox_NULL$mean_rel_ab.real + merged_data_20_Nifurtimox_NULL$sd_rel_ab.real

# Ensure lower and upper bounds are non-negative, adjusting as necessary
merged_data_20_Nifurtimox_NULL$lower_bound_null[merged_data_20_Nifurtimox_NULL$lower_bound_null <= 0] <- 1e-10
merged_data_20_Nifurtimox_NULL$lower_bound_real[merged_data_20_Nifurtimox_NULL$lower_bound_real <= 0] <- 1e-10
merged_data_20_Nifurtimox_NULL$upper_bound_null[merged_data_20_Nifurtimox_NULL$upper_bound_null <= 0] <- 1e-10
merged_data_20_Nifurtimox_NULL$upper_bound_real[merged_data_20_Nifurtimox_NULL$upper_bound_real <= 0] <- 1e-10

# Filter to include only species with a mean relative abundance > 0.01 in the 'real' dataset
significant_species <- merged_data_20_Nifurtimox[merged_data_20_Nifurtimox$mean_rel_ab.real > 0.01, ]
survivors_20_Nifurtimox <- nrow(significant_species)
survivors_20_Nifurtimox

#should be the same as survivors defined above, since it is calculated from .real
significant_species_NULL <- merged_data_20_Nifurtimox_NULL[merged_data_20_Nifurtimox_NULL$mean_rel_ab.real > 0.01, ]
survivors_20_Nifurtimox_NULL <- nrow(significant_species_NULL)
survivors_20_Nifurtimox_NULL

# Adjusted order of magnitude check to include SD, only for significant species
significant_species$Predicted_magnitude_correct <- ifelse(
  (floor(log10(significant_species$lower_bound_pred)) <= floor(log10(significant_species$upper_bound_real)) &
     floor(log10(significant_species$upper_bound_pred)) >= floor(log10(significant_species$lower_bound_real))),
  1,
  0
)

#and for the Null model:
significant_species_NULL$Predicted_magnitude_correct <- ifelse(
  (floor(log10(significant_species_NULL$lower_bound_null)) <= floor(log10(significant_species_NULL$upper_bound_real)) &
     floor(log10(significant_species_NULL$upper_bound_null)) >= floor(log10(significant_species_NULL$lower_bound_real))),
  1,
  0
)

# Calculate the fraction of correctly predicted magnitudes for significant species
predicted_magnitude_correct_fraction_20_Nifurtimox <- sum(significant_species$Predicted_magnitude_correct) / nrow(significant_species)
predicted_magnitude_correct_fraction_20_Nifurtimox

predicted_magnitude_correct_fraction_20_Nifurtimox_NULL <- sum(significant_species_NULL$Predicted_magnitude_correct) / nrow(significant_species_NULL)
predicted_magnitude_correct_fraction_20_Nifurtimox_NULL

top_species_missing_20_Nifurtimox <- setdiff(top6_real_20_Nifurtimox_means, top6_predicted_20_Nifurtimox_means)
top_species_wrong_20_Nifurtimox <- setdiff(top6_predicted_20_Nifurtimox_means, top6_real_20_Nifurtimox_means)

Prediction_quality_20_Nifurtimox <- data.frame(
  Top_six_correct = paste(top_six_correct_20_Nifurtimox, sep=""),
  Top_six_correct_NULL = paste(top_six_correct_20_Nifurtimox_NULL, sep=""),
  Top_six_correct_means = paste(top_six_correct_20_Nifurtimox_means, sep=""),
  Top_six_correct_means_NULL = paste(top_six_correct_20_Nifurtimox_means_NULL, sep=""),
  Predicted_magnitude_correct = paste(round(predicted_magnitude_correct_fraction_20_Nifurtimox * 100, 2), "%", sep=""),
  Predicted_magnitude_correct_NULL = paste(round(predicted_magnitude_correct_fraction_20_Nifurtimox_NULL * 100, 2), "%", sep=""),
  survivors_total = survivors_20_Nifurtimox,
  top_species_missing <- top_species_missing_20_Nifurtimox,
  top_species_wrong <- top_species_wrong_20_Nifurtimox, 
  predicted_mean_final_OD <- predicted_mean_final_od_20_Nifurtimox,
  real_mean_final_OD <- real_mean_final_od_20_Nifurtimox,
  sims_total = length(successful_sim_ids)
)

Prediction_quality_20_Nifurtimox






##Next, for 2.5uM:
# Get top 6 species from plot_data_2.5_endpoint
# Adjust the plot_data_2.5_endpoint with confidence bounds
plot_data_2.5_Nifurtimox_endpoint <- plot_data_2.5_Nifurtimox_endpoint %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)

# Adjust the Nifurtimox_16S_2.5uM_summarised with confidence bounds
Nifurtimox_16S_2.5uM_summarised <- Nifurtimox_16S_2.5uM_summarised %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)

#NULL model:
Null_model_summarised <- Niclosamide_16S_0uM_summarised %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)


# Get top 6 species based on the lower bound from plot_data_2.5_endpoint
top6_predicted_2.5_Nifurtimox <- plot_data_2.5_Nifurtimox_endpoint %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

# Get top 6 species based on the lower bound from Nifurtimox_16S_2.5uM_summarised
top6_real_2.5_Nifurtimox <- Nifurtimox_16S_2.5uM_summarised %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

top6_NULL <- Null_model_summarised %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

# Calculate the overlap of top 6 species
top_six_correct_2.5_Nifurtimox <- length(intersect(top6_predicted_2.5_Nifurtimox, top6_real_2.5_Nifurtimox))
#top_six_correct_2.5_Nifurtimox

top_six_correct_2.5_Nifurtimox_NULL <- length(intersect(top6_NULL, top6_real_2.5_Nifurtimox))
#top_six_correct_2.5_Nifurtimox_NULL

#top6_predicted_2.5_Nifurtimox
#top6_real_2.5_Nifurtimox




#Now by means:
top6_predicted_2.5_Nifurtimox_means <- plot_data_2.5_Nifurtimox_endpoint %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)

# Get top 6 species based on the lower bound from Nifurtimox_16S_2.5uM_summarised
top6_real_2.5_Nifurtimox_means <- Nifurtimox_16S_2.5uM_summarised %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)

top6_NULL_means <- Null_model_summarised %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)



top_six_correct_2.5_Nifurtimox_means <- length(intersect(top6_predicted_2.5_Nifurtimox_means, top6_real_2.5_Nifurtimox_means))
#top_six_correct_2.5_Nifurtimox_means

top_six_correct_2.5_Nifurtimox_means_NULL <- length(intersect(top6_NULL_means, top6_real_2.5_Nifurtimox_means))
#top_six_correct_2.5_Nifurtimox_means_NULL

#top6_predicted_2.5_Nifurtimox_means
#top6_real_2.5_Nifurtimox_means




# Merge dataframes by Species
merged_data_2.5_Nifurtimox <- merge(plot_data_2.5_Nifurtimox_endpoint, Nifurtimox_16S_2.5uM_summarised, by = "Species", suffixes = c(".pred", ".real"))
merged_data_2.5_Nifurtimox_NULL <- merge(Niclosamide_16S_0uM_summarised, Nifurtimox_16S_2.5uM_summarised, by = "Species", suffixes = c(".null", ".real"))



# Create lower and upper bounds considering mean ¬± sd
merged_data_2.5_Nifurtimox$lower_bound_pred <- merged_data_2.5_Nifurtimox$mean_rel_ab.pred - merged_data_2.5_Nifurtimox$sd_rel_ab.pred
merged_data_2.5_Nifurtimox$upper_bound_pred <- merged_data_2.5_Nifurtimox$mean_rel_ab.pred + merged_data_2.5_Nifurtimox$sd_rel_ab.pred
merged_data_2.5_Nifurtimox$lower_bound_real <- merged_data_2.5_Nifurtimox$mean_rel_ab.real - merged_data_2.5_Nifurtimox$sd_rel_ab.real
merged_data_2.5_Nifurtimox$upper_bound_real <- merged_data_2.5_Nifurtimox$mean_rel_ab.real + merged_data_2.5_Nifurtimox$sd_rel_ab.real

# Ensure lower and upper bounds are non-negative, adjusting as necessary
merged_data_2.5_Nifurtimox$lower_bound_pred[merged_data_2.5_Nifurtimox$lower_bound_pred <= 0] <- 1e-10
merged_data_2.5_Nifurtimox$lower_bound_real[merged_data_2.5_Nifurtimox$lower_bound_real <= 0] <- 1e-10
merged_data_2.5_Nifurtimox$upper_bound_pred[merged_data_2.5_Nifurtimox$upper_bound_pred <= 0] <- 1e-10
merged_data_2.5_Nifurtimox$upper_bound_real[merged_data_2.5_Nifurtimox$upper_bound_real <= 0] <- 1e-10

##and for NULL model:
# Create lower and upper bounds considering mean ¬± sd
merged_data_2.5_Nifurtimox_NULL$lower_bound_null <- merged_data_2.5_Nifurtimox_NULL$mean_rel_ab.null - merged_data_2.5_Nifurtimox_NULL$sd_rel_ab.null
merged_data_2.5_Nifurtimox_NULL$upper_bound_null <- merged_data_2.5_Nifurtimox_NULL$mean_rel_ab.null + merged_data_2.5_Nifurtimox_NULL$sd_rel_ab.null
merged_data_2.5_Nifurtimox_NULL$lower_bound_real <- merged_data_2.5_Nifurtimox_NULL$mean_rel_ab.real - merged_data_2.5_Nifurtimox_NULL$sd_rel_ab.real
merged_data_2.5_Nifurtimox_NULL$upper_bound_real <- merged_data_2.5_Nifurtimox_NULL$mean_rel_ab.real + merged_data_2.5_Nifurtimox_NULL$sd_rel_ab.real

# Ensure lower and upper bounds are non-negative, adjusting as necessary
merged_data_2.5_Nifurtimox_NULL$lower_bound_null[merged_data_2.5_Nifurtimox_NULL$lower_bound_null <= 0] <- 1e-10
merged_data_2.5_Nifurtimox_NULL$lower_bound_real[merged_data_2.5_Nifurtimox_NULL$lower_bound_real <= 0] <- 1e-10
merged_data_2.5_Nifurtimox_NULL$upper_bound_null[merged_data_2.5_Nifurtimox_NULL$upper_bound_null <= 0] <- 1e-10
merged_data_2.5_Nifurtimox_NULL$upper_bound_real[merged_data_2.5_Nifurtimox_NULL$upper_bound_real <= 0] <- 1e-10

# Filter to include only species with a mean relative abundance > 0.01 in the 'real' dataset
significant_species <- merged_data_2.5_Nifurtimox[merged_data_2.5_Nifurtimox$mean_rel_ab.real > 0.01, ]
survivors_2.5_Nifurtimox <- nrow(significant_species)
survivors_2.5_Nifurtimox

#should be the same as survivors defined above, since it is calculated from .real
significant_species_NULL <- merged_data_2.5_Nifurtimox_NULL[merged_data_2.5_Nifurtimox_NULL$mean_rel_ab.real > 0.01, ]
survivors_2.5_Nifurtimox_NULL <- nrow(significant_species_NULL)
survivors_2.5_Nifurtimox_NULL

# Adjusted order of magnitude check to include SD, only for significant species
significant_species$Predicted_magnitude_correct <- ifelse(
  (floor(log10(significant_species$lower_bound_pred)) <= floor(log10(significant_species$upper_bound_real)) &
     floor(log10(significant_species$upper_bound_pred)) >= floor(log10(significant_species$lower_bound_real))),
  1,
  0
)

#and for the Null model:
significant_species_NULL$Predicted_magnitude_correct <- ifelse(
  (floor(log10(significant_species_NULL$lower_bound_null)) <= floor(log10(significant_species_NULL$upper_bound_real)) &
     floor(log10(significant_species_NULL$upper_bound_null)) >= floor(log10(significant_species_NULL$lower_bound_real))),
  1,
  0
)

# Calculate the fraction of correctly predicted magnitudes for significant species
predicted_magnitude_correct_fraction_2.5_Nifurtimox <- sum(significant_species$Predicted_magnitude_correct) / nrow(significant_species)
predicted_magnitude_correct_fraction_2.5_Nifurtimox

predicted_magnitude_correct_fraction_2.5_Nifurtimox_NULL <- sum(significant_species_NULL$Predicted_magnitude_correct) / nrow(significant_species_NULL)
predicted_magnitude_correct_fraction_2.5_Nifurtimox_NULL


top_species_missing_2.5_Nifurtimox <- setdiff(top6_real_2.5_Nifurtimox_means, top6_predicted_2.5_Nifurtimox_means)
top_species_wrong_2.5_Nifurtimox <- setdiff(top6_predicted_2.5_Nifurtimox_means, top6_real_2.5_Nifurtimox_means)

Prediction_quality_2.5_Nifurtimox <- data.frame(
  Top_six_correct = paste(top_six_correct_2.5_Nifurtimox, sep=""),
  Top_six_correct_NULL = paste(top_six_correct_2.5_Nifurtimox_NULL, sep=""),
  Top_six_correct_means = paste(top_six_correct_2.5_Nifurtimox_means, sep=""),
  Top_six_correct_means_NULL = paste(top_six_correct_2.5_Nifurtimox_means_NULL, sep=""),
  Predicted_magnitude_correct = paste(round(predicted_magnitude_correct_fraction_2.5_Nifurtimox * 100, 2), "%", sep=""),
  Predicted_magnitude_correct_NULL = paste(round(predicted_magnitude_correct_fraction_2.5_Nifurtimox_NULL * 100, 2), "%", sep=""),
  survivors_total = survivors_2.5_Nifurtimox,
  top_species_missing <- top_species_missing_2.5_Nifurtimox,
  top_species_wrong <- top_species_wrong_2.5_Nifurtimox, 
  predicted_mean_final_OD <- predicted_mean_final_od_2.5_Nifurtimox,
  real_mean_final_OD <- real_mean_final_od_2.5_Nifurtimox,
  sims_total = length(successful_sim_ids)
)

Prediction_quality_2.5_Nifurtimox







##Olanzapine

combined_monoculture_aucs2_Olanzapine <- subset(combined_monoculture_aucs2, drug == "Olanzapine")


#drug sensitivity terms: define once outside of ODEs
y_function_B_vulgatus_Olanzapine <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("B_vulgatus", "Olanzapine", best_fitting_models_df_Olanzapine)), collapse = " ")))
y_function_B_uniformis_Olanzapine <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("B_uniformis", "Olanzapine", best_fitting_models_df_Olanzapine)), collapse = " ")))
y_function_B_fragilis_Olanzapine <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("B_fragilis", "Olanzapine", best_fitting_models_df_Olanzapine)), collapse = " ")))
y_function_B_thetaiotaomicron_Olanzapine <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("B_thetaiotaomicron", "Olanzapine", best_fitting_models_df_Olanzapine)), collapse = " ")))
y_function_C_ramosum_Olanzapine <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("C_ramosum", "Olanzapine", best_fitting_models_df_Olanzapine)), collapse = " ")))
y_function_E_rectale_Olanzapine <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("E_rectale", "Olanzapine", best_fitting_models_df_Olanzapine)), collapse = " ")))
y_function_R_intestinalis_Olanzapine <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("R_intestinalis", "Olanzapine", best_fitting_models_df_Olanzapine)), collapse = " ")))
y_function_V_parvula_Olanzapine <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("V_parvula", "Olanzapine", best_fitting_models_df_Olanzapine)), collapse = " ")))
y_function_E_lenta_Olanzapine <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("E_lenta", "Olanzapine", best_fitting_models_df_Olanzapine)), collapse = " ")))
y_function_F_nucleatum_Olanzapine <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("F_nucleatum", "Olanzapine", best_fitting_models_df_Olanzapine)), collapse = " ")))
y_function_C_bolteae_Olanzapine <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("C_bolteae", "Olanzapine", best_fitting_models_df_Olanzapine)), collapse = " ")))
y_function_C_perfringens_Olanzapine <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("C_perfringens", "Olanzapine", best_fitting_models_df_Olanzapine)), collapse = " ")))
y_function_C_saccharolyticum_Olanzapine <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("C_saccharolyticum", "Olanzapine", best_fitting_models_df_Olanzapine)), collapse = " ")))
y_function_S_salivarius_Olanzapine <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("S_salivarius", "Olanzapine", best_fitting_models_df_Olanzapine)), collapse = " ")))
y_function_R_gnavus_Olanzapine <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("R_gnavus", "Olanzapine", best_fitting_models_df_Olanzapine)), collapse = " ")))
y_function_C_comes_Olanzapine <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("C_comes", "Olanzapine", best_fitting_models_df_Olanzapine)), collapse = " ")))
y_function_P_merdae_Olanzapine <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("P_merdae", "Olanzapine", best_fitting_models_df_Olanzapine)), collapse = " ")))
y_function_S_parasanguinis_Olanzapine <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("S_parasanguinis", "Olanzapine", best_fitting_models_df_Olanzapine)), collapse = " ")))
y_function_C_aerofaciens_Olanzapine <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("C_aerofaciens", "Olanzapine", best_fitting_models_df_Olanzapine)), collapse = " ")))
y_function_D_formicigenerans_Olanzapine <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("D_formicigenerans", "Olanzapine", best_fitting_models_df_Olanzapine)), collapse = " ")))
y_function_E_coli_Olanzapine <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("E_coli", "Olanzapine", best_fitting_models_df_Olanzapine)), collapse = " ")))



y_function_B_vulgatus_Olanzapine_func <- eval(parse(text = paste("function(Drug) {", y_function_B_vulgatus_Olanzapine, "}")))
y_function_B_uniformis_Olanzapine_func <- eval(parse(text = paste("function(Drug) {", y_function_B_uniformis_Olanzapine, "}")))
y_function_B_fragilis_Olanzapine_func <- eval(parse(text = paste("function(Drug) {", y_function_B_fragilis_Olanzapine, "}")))
y_function_B_thetaiotaomicron_Olanzapine_func <- eval(parse(text = paste("function(Drug) {", y_function_B_thetaiotaomicron_Olanzapine, "}")))
y_function_C_ramosum_Olanzapine_func <- eval(parse(text = paste("function(Drug) {", y_function_C_ramosum_Olanzapine, "}")))
y_function_E_rectale_Olanzapine_func <- eval(parse(text = paste("function(Drug) {", y_function_E_rectale_Olanzapine, "}")))
y_function_R_intestinalis_Olanzapine_func <- eval(parse(text = paste("function(Drug) {", y_function_R_intestinalis_Olanzapine, "}")))
y_function_E_lenta_Olanzapine_func <- eval(parse(text = paste("function(Drug) {", y_function_E_lenta_Olanzapine, "}")))
y_function_F_nucleatum_Olanzapine_func <- eval(parse(text = paste("function(Drug) {", y_function_F_nucleatum_Olanzapine, "}")))
y_function_C_bolteae_Olanzapine_func <- eval(parse(text = paste("function(Drug) {", y_function_C_bolteae_Olanzapine, "}")))
y_function_C_perfringens_Olanzapine_func <- eval(parse(text = paste("function(Drug) {", y_function_C_perfringens_Olanzapine, "}")))
y_function_C_saccharolyticum_Olanzapine_func <- eval(parse(text = paste("function(Drug) {", y_function_C_saccharolyticum_Olanzapine, "}")))
y_function_S_salivarius_Olanzapine_func <- eval(parse(text = paste("function(Drug) {", y_function_S_salivarius_Olanzapine, "}")))
y_function_R_gnavus_Olanzapine_func <- eval(parse(text = paste("function(Drug) {", y_function_R_gnavus_Olanzapine, "}")))
y_function_C_comes_Olanzapine_func <- eval(parse(text = paste("function(Drug) {", y_function_C_comes_Olanzapine, "}")))
y_function_P_merdae_Olanzapine_func <- eval(parse(text = paste("function(Drug) {", y_function_P_merdae_Olanzapine, "}")))
y_function_S_parasanguinis_Olanzapine_func <- eval(parse(text = paste("function(Drug) {", y_function_S_parasanguinis_Olanzapine, "}")))
y_function_C_aerofaciens_Olanzapine_func <- eval(parse(text = paste("function(Drug) {", y_function_C_aerofaciens_Olanzapine, "}")))
y_function_D_formicigenerans_Olanzapine_func <- eval(parse(text = paste("function(Drug) {", y_function_D_formicigenerans_Olanzapine, "}")))
y_function_E_coli_Olanzapine_func <- eval(parse(text = paste("function(Drug) {", y_function_E_coli_Olanzapine, "}")))
y_function_V_parvula_Olanzapine_func <- eval(parse(text = paste("function(Drug) {", y_function_V_parvula_Olanzapine, "}")))



unique(combined_monoculture_aucs2_Olanzapine$conc)
##dictate drug concentration tested for simulation cycle here:
#drug_concentration_tested <- 5 #if manually or:
drug_concentration_tested <- unique(combined_monoculture_aucs2_Olanzapine$conc)[1] 
initial_conditions <- rep(0.01/32, 32)
initial_conditions <- c(initial_conditions, drug_concentration_tested)


##drug effect fitted for species showing sensitivity in monoculture:
#unique(combined_monoculture_aucs2_Olanzapine$Species)

##for more simple linear fits
closed.sir.model_Olanzapine <- function (t, x, params) {
  ## first extract the state variables
  A_muciniphila <- x[1]
  B_adolescentis <- x[2]
  B_fragilis <- x[3]
  B_longum <- x[4]
  B_obeum <- x[5]
  B_thetaiotaomicron <- x[6]
  B_uniformis <- x[7]
  B_vulgatus <- x[8]
  B_wadsworthia <- x[9]
  C_aerofaciens <- x[10]
  C_bolteae <- x[11]
  C_comes <- x[12]
  C_perfringens <- x[13]
  C_ramosum <- x[14]
  C_saccharolyticum <- x[15]
  D_formicigenerans <- x[16]
  E_coli <- x[17]
  E_lenta <- x[18]
  E_rectale <- x[19]
  F_nucleatum <- x[20]
  L_paracasei <- x[21]
  O_splanchnicus <- x[22]
  P_copri <- x[23]
  P_distasonis <- x[24]
  P_merdae <- x[25]
  R_bromii <- x[26]
  R_gnavus <- x[27]
  R_intestinalis <- x[28]
  R_torques <- x[29]
  S_parasanguinis <- x[30]
  S_salivarius <- x[31]
  V_parvula <- x[32]
  Drug <- x[33]
  
  
  ## now extract the parameters
  r_B_fragilis <- flat_params[["B._fragilis.r"]]
  K_B_fragilis <- flat_params[["B._fragilis.K"]]
  r_B_longum <- flat_params[["B._longum.r"]]
  K_B_longum <- flat_params[["B._longum.K"]]
  r_B_thetaiotaomicron <- flat_params[["B._thetaiotaomicron.r"]]
  K_B_thetaiotaomicron <- flat_params[["B._thetaiotaomicron.K"]]
  r_B_uniformis <- flat_params[["B._uniformis.r"]]
  K_B_uniformis <- flat_params[["B._uniformis.K"]]
  r_B_vulgatus <- flat_params[["B._vulgatus.r"]]
  K_B_vulgatus <- flat_params[["B._vulgatus.K"]]
  r_B_wadsworthia <- flat_params[["B._wadsworthia.r"]]
  K_B_wadsworthia <- flat_params[["B._wadsworthia.K"]]
  r_C_aerofaciens <- flat_params[["C._aerofaciens.r"]]
  K_C_aerofaciens <- flat_params[["C._aerofaciens.K"]]
  r_C_bolteae <- flat_params[["C._bolteae.r"]]
  K_C_bolteae <- flat_params[["C._bolteae.K"]]
  r_C_comes <- flat_params[["C._comes.r"]]
  K_C_comes <- flat_params[["C._comes.K"]]
  r_C_perfringens <- flat_params[["C._perfringens.r"]]
  K_C_perfringens <- flat_params[["C._perfringens.K"]]
  r_C_ramosum <- flat_params[["C._ramosum.r"]]
  K_C_ramosum <- flat_params[["C._ramosum.K"]]
  r_C_saccharolyticum <- flat_params[["C._saccharolyticum.r"]]
  K_C_saccharolyticum <- flat_params[["C._saccharolyticum.K"]]
  r_D_formicigenerans <- flat_params[["D._formicigenerans.r"]]
  K_D_formicigenerans <- flat_params[["D._formicigenerans.K"]]
  r_E_coli <- flat_params[["E._coli.r"]]
  K_E_coli <- flat_params[["E._coli.K"]]
  r_E_lenta <- flat_params[["E._lenta.r"]]
  K_E_lenta <- flat_params[["E._lenta.K"]]
  r_E_rectale <- flat_params[["E._rectale.r"]]
  K_E_rectale <- flat_params[["E._rectale.K"]]
  r_F_nucleatum <- flat_params[["F._nucleatum.r"]]
  K_F_nucleatum <- flat_params[["F._nucleatum.K"]]
  r_P_copri <- flat_params[["P._copri.r"]]
  K_P_copri <- flat_params[["P._copri.K"]]
  r_P_merdae <- flat_params[["P._merdae.r"]]
  K_P_merdae <- flat_params[["P._merdae.K"]]
  r_R_gnavus <- flat_params[["R._gnavus.r"]]
  K_R_gnavus <- flat_params[["R._gnavus.K"]]
  r_R_intestinalis <- flat_params[["R._intestinalis.r"]]
  K_R_intestinalis <- flat_params[["R._intestinalis.K"]]
  r_V_parvula <- flat_params[["V._parvula.r"]]
  K_V_parvula <- flat_params[["V._parvula.K"]]
  r_A_muciniphila <- flat_params[["A._muciniphila.r"]]
  K_A_muciniphila <- flat_params[["A._muciniphila.K"]]
  r_B_adolescentis <- flat_params[["B._adolescentis.r"]]
  K_B_adolescentis <- flat_params[["B._adolescentis.K"]]
  r_B_obeum <- flat_params[["B._obeum.r"]]
  K_B_obeum <- flat_params[["B._obeum.K"]]
  r_O_splanchnicus <- flat_params[["O._splanchnicus.r"]]
  K_O_splanchnicus <- flat_params[["O._splanchnicus.K"]]
  r_P_distasonis <- flat_params[["P._distasonis.r"]]
  K_P_distasonis <- flat_params[["P._distasonis.K"]]
  r_R_bromii <- flat_params[["R._bromii.r"]]
  K_R_bromii <- flat_params[["R._bromii.K"]]
  r_R_torques <- flat_params[["R._torques.r"]]
  K_R_torques <- flat_params[["R._torques.K"]]
  r_S_parasanguinis <- flat_params[["S._parasanguinis.r"]]
  K_S_parasanguinis <-flat_params[["S._parasanguinis.K"]]
  r_S_salivarius <- flat_params[["S._salivarius.r"]]
  K_S_salivarius <- flat_params[["S._salivarius.K"]]
  r_L_paracasei <- flat_params[["L._paracasei.r"]]
  K_L_paracasei <- flat_params[["L._paracasei.K"]]
  
  
  t_mod <- ifelse(t > 24.1, t - 24.1, t)
  
  
  ## now code the model equations
  dA_muciniphila_dt <- r_A_muciniphila * A_muciniphila * (1 - A_muciniphila / K_A_muciniphila)
  dB_adolescentis_dt <- r_B_adolescentis * B_adolescentis * (1 - B_adolescentis / K_B_adolescentis)
  dB_fragilis_dt <- r_B_fragilis * B_fragilis * (1 - B_fragilis / max(0.0001, K_B_fragilis * (y_function_B_fragilis_Olanzapine_func(Drug))))
  dB_longum_dt <- r_B_longum * B_longum * (1 - B_longum / K_B_longum)
  dB_obeum_dt <- r_B_obeum * B_obeum * (1 - B_obeum / K_B_obeum)
  dB_thetaiotaomicron_dt <- r_B_thetaiotaomicron * B_thetaiotaomicron * (1 - B_thetaiotaomicron / max(0.0001, K_B_thetaiotaomicron * (y_function_B_thetaiotaomicron_Olanzapine_func(Drug))))  
  dB_uniformis_dt <- r_B_uniformis * B_uniformis * (1 - B_uniformis / max(0.0001, K_B_uniformis * (y_function_B_uniformis_Olanzapine_func(Drug))))
  dB_vulgatus_dt <- r_B_vulgatus * B_vulgatus * (1 - B_vulgatus / max(0.0001, K_B_vulgatus * (y_function_B_vulgatus_Olanzapine_func(Drug))))
  dB_wadsworthia_dt <- r_B_wadsworthia * B_wadsworthia * (1 - B_wadsworthia / K_B_wadsworthia)
  dC_aerofaciens_dt <- r_C_aerofaciens * C_aerofaciens * (1 - C_aerofaciens / max(0.0001, K_C_aerofaciens * (y_function_C_aerofaciens_Olanzapine_func(Drug))))
  dC_bolteae_dt <- r_C_bolteae * C_bolteae * (1 - C_bolteae /  max(0.0001, K_C_bolteae * (y_function_C_bolteae_Olanzapine_func(Drug))))
  dC_comes_dt <- r_C_comes * C_comes * (1 - C_comes / max(0.0001, K_C_comes * (y_function_C_comes_Olanzapine_func(Drug))))
  dC_perfringens_dt <- r_C_perfringens * C_perfringens * (1 - C_perfringens / max(0.0001, K_C_perfringens * (y_function_C_perfringens_Olanzapine_func(Drug))))
  dC_ramosum_dt <- r_C_ramosum * C_ramosum * (1 - C_ramosum / max(0.0001, K_C_ramosum * (y_function_C_ramosum_Olanzapine_func(Drug))))
  dC_saccharolyticum_dt <- r_C_saccharolyticum * C_saccharolyticum * (1 - C_saccharolyticum / max(0.0001, K_C_saccharolyticum * (y_function_C_saccharolyticum_Olanzapine_func(Drug))))
  dD_formicigenerans_dt <- r_D_formicigenerans * D_formicigenerans * (1 - D_formicigenerans / max(0.0001, K_D_formicigenerans * (y_function_D_formicigenerans_Olanzapine_func(Drug))))
  dE_coli_dt <- r_E_coli * E_coli * (1 - E_coli / max(0.0001, K_E_coli * (y_function_E_coli_Olanzapine_func(Drug))))
  dE_lenta_dt <- r_E_lenta * E_lenta * (1 - E_lenta / max(0.0001, K_E_lenta * (y_function_E_lenta_Olanzapine_func(Drug))))
  dE_rectale_dt <- r_E_rectale * E_rectale * (1 - E_rectale / max(0.0001, K_E_rectale * (y_function_E_rectale_Olanzapine_func(Drug))))
  dF_nucleatum_dt <- r_F_nucleatum * F_nucleatum * (1 - F_nucleatum / max(0.0001, K_F_nucleatum * (y_function_F_nucleatum_Olanzapine_func(Drug))))
  dL_paracasei_dt <- r_L_paracasei * L_paracasei * (1 - L_paracasei / K_L_paracasei)  
  dO_splanchnicus_dt <- r_O_splanchnicus * O_splanchnicus * (1 - O_splanchnicus / K_O_splanchnicus)  
  dP_copri_dt <- r_P_copri * P_copri * (1 - P_copri / K_P_copri)
  dP_distasonis_dt <- r_P_distasonis * P_distasonis * (1 - P_distasonis / K_P_distasonis)  
  dP_merdae_dt <- r_P_merdae * P_merdae * (1 - P_merdae / max(0.0001, K_P_merdae * (y_function_P_merdae_Olanzapine_func(Drug))))
  dR_bromii_dt <- r_R_bromii * R_bromii * (1 - R_bromii / K_R_bromii) 
  dR_gnavus_dt <- r_R_gnavus * R_gnavus * (1 - R_gnavus / max(0.0001, K_R_gnavus * (y_function_R_gnavus_Olanzapine_func(Drug))))
  dR_intestinalis_dt <- r_R_intestinalis * R_intestinalis * (1 - R_intestinalis / max(0.0001, K_R_intestinalis * (y_function_R_intestinalis_Olanzapine_func(Drug))))
  dR_torques_dt <- r_R_torques * R_torques * (1 - R_torques /K_R_torques) 
  dS_parasanguinis_dt <- r_S_parasanguinis * S_parasanguinis * (1 - S_parasanguinis / max(0.0001, K_S_parasanguinis * (y_function_S_parasanguinis_Olanzapine_func(Drug))))
  dS_salivarius_dt <- r_S_salivarius * S_salivarius * (1 - S_salivarius / max(0.0001, K_S_salivarius * (y_function_S_salivarius_Olanzapine_func(Drug))))
  dV_parvula_dt <- r_V_parvula * V_parvula * (1 - V_parvula / max(0.0001, K_V_parvula * (y_function_V_parvula_Olanzapine_func(Drug))))
  
  
  
  #Drug differential:
  dDrug_dt <- (subset(drug_dynamics, Drug == "Olanzapine")$Steepness_param_community * exp(-subset(drug_dynamics, Drug == "Olanzapine")$Steepness_param_community * t_mod)) * (drug_concentration_tested * prop_left_Olanzapine - drug_concentration_tested)
  #dDrug_dt <- 0
  
  ## Combine results into a single vector
  dxdt <- c(dA_muciniphila_dt, dB_adolescentis_dt, dB_fragilis_dt, dB_longum_dt, dB_obeum_dt, dB_thetaiotaomicron_dt, dB_uniformis_dt, dB_vulgatus_dt, dB_wadsworthia_dt, dC_aerofaciens_dt, dC_bolteae_dt, dC_comes_dt, dC_perfringens_dt, dC_ramosum_dt, dC_saccharolyticum_dt, dD_formicigenerans_dt, dE_coli_dt, dE_lenta_dt, dE_rectale_dt, dF_nucleatum_dt, dL_paracasei_dt, dO_splanchnicus_dt, dP_copri_dt, dP_distasonis_dt, dP_merdae_dt, dR_bromii_dt, dR_gnavus_dt, dR_intestinalis_dt, dR_torques_dt, dS_parasanguinis_dt, dS_salivarius_dt, dV_parvula_dt, dDrug_dt)
  
  ## Return result as a list
  list(dxdt)
}




#calculate the co-culture correction factor per species based on community composition in absence of drug, just like done for Niclosamide

growth_data_all_0_Niclosamide
growth_data_all_0_Niclosamide1 <- growth_data_all_0_Niclosamide %>%
  dplyr::mutate(Species = gsub(" ", "_", Species))


# Merge rel_ab_control with growth_data_all_0_Niclosamide on Species
# Function to remove duplicated columns by name pattern
clean_columns_base <- function(df, pattern) {
  cols_to_keep <- !grepl(pattern, names(df))
  df <- df[, cols_to_keep]
  return(df)
}

# Use the new function to clean up your dataframe
rel_ab_control <- clean_columns_base(rel_ab_control, "mean_max_OD.[xy]")
str(rel_ab_control)


#rel_ab_control$correction_factor <- rel_ab_control$mean_rel_ab / (rel_ab_control$mean_max_OD/sum(rel_ab_control$mean_max_OD))
# Calculate correction factor with a minimum value of ~1
rel_ab_control$correction_factor <- pmax(rel_ab_control$mean_rel_ab / (rel_ab_control$mean_max_OD / sum(rel_ab_control$mean_max_OD)), 1.1)


# Create a new dataframe for co-culture correction
co_culture_correction <- data.frame(
  species = rel_ab_control$Species,
  correction_factor = rel_ab_control$correction_factor
)


#summarise community data
#Adjust based on tested concentrations for each drug
unique(Community_compositions_focus_drugs_Olanzapine$concentration)

Community_compositions_focus_drugs_Olanzapine_5uM <- subset(Community_compositions_focus_drugs_Olanzapine, concentration == 5)
Community_compositions_focus_drugs_Olanzapine_20uM <- subset(Community_compositions_focus_drugs_Olanzapine, concentration == 20)
Community_compositions_focus_drugs_Olanzapine_80uM <- subset(Community_compositions_focus_drugs_Olanzapine, concentration == 80)


#5 uM
Community_compositions_focus_drugs_Olanzapine_5uM_summarised <- Community_compositions_focus_drugs_Olanzapine_5uM %>%
  dplyr::group_by(species) %>%                                  
  dplyr::summarize(
    mean_rel_ab = mean(rel_abundance, na.rm = TRUE),     
    sd_rel_ab = sd(rel_abundance, na.rm = TRUE) ,
    mean_max_OD = mean(maxOD, na.rm = TRUE),
    sd_max_OD = sd(maxOD, na.rm = TRUE),
    mean_final_OD = mean(finalOD, na.rm = TRUE),
    sd_final_OD = sd(finalOD, na.rm = TRUE)
  ) %>%
  dplyr::ungroup() 


Community_compositions_focus_drugs_Olanzapine_5uM_summarised <- Community_compositions_focus_drugs_Olanzapine_5uM_summarised %>%
  dplyr::mutate(Species = sub("^(\\w)\\w*\\s(.*)", "\\1._\\2", species))

#remove (sub)strain info
Community_compositions_focus_drugs_Olanzapine_5uM_summarised <- Community_compositions_focus_drugs_Olanzapine_5uM_summarised %>%
  dplyr::mutate(Species = sub("^(\\w\\._\\w+).*", "\\1", Species))


#20 uM
Community_compositions_focus_drugs_Olanzapine_20uM_summarised <- Community_compositions_focus_drugs_Olanzapine_20uM %>%
  dplyr::group_by(species) %>%                                  
  dplyr::summarize(
    mean_rel_ab = mean(rel_abundance, na.rm = TRUE),     
    sd_rel_ab = sd(rel_abundance, na.rm = TRUE) ,
    mean_max_OD = mean(maxOD, na.rm = TRUE),
    sd_max_OD = sd(maxOD, na.rm = TRUE),
    mean_final_OD = mean(finalOD, na.rm = TRUE),
    sd_final_OD = sd(finalOD, na.rm = TRUE)
  ) %>%
  dplyr::ungroup() 


Community_compositions_focus_drugs_Olanzapine_20uM_summarised <- Community_compositions_focus_drugs_Olanzapine_20uM_summarised %>%
  dplyr::mutate(Species = sub("^(\\w)\\w*\\s(.*)", "\\1._\\2", species))

#remove (sub)strain info
Community_compositions_focus_drugs_Olanzapine_20uM_summarised <- Community_compositions_focus_drugs_Olanzapine_20uM_summarised %>%
  dplyr::mutate(Species = sub("^(\\w\\._\\w+).*", "\\1", Species))


#80 uM
Community_compositions_focus_drugs_Olanzapine_80uM_summarised <- Community_compositions_focus_drugs_Olanzapine_80uM %>%
  dplyr::group_by(species) %>%                                  
  dplyr::summarize(
    mean_rel_ab = mean(rel_abundance, na.rm = TRUE),     
    sd_rel_ab = sd(rel_abundance, na.rm = TRUE) ,
    mean_max_OD = mean(maxOD, na.rm = TRUE),
    sd_max_OD = sd(maxOD, na.rm = TRUE),    
    mean_final_OD = mean(finalOD, na.rm = TRUE),
    sd_final_OD = sd(finalOD, na.rm = TRUE)
  ) %>%
  dplyr::ungroup() 



Community_compositions_focus_drugs_Olanzapine_80uM_summarised <- Community_compositions_focus_drugs_Olanzapine_80uM_summarised %>%
  dplyr::mutate(Species = sub("^(\\w)\\w*\\s(.*)", "\\1._\\2", species))

#remove (sub)strain info
Community_compositions_focus_drugs_Olanzapine_80uM_summarised <- Community_compositions_focus_drugs_Olanzapine_80uM_summarised %>%
  dplyr::mutate(Species = sub("^(\\w\\._\\w+).*", "\\1", Species))


#Initialise data frames
sim_output <- data.frame()
input_params_list <- list() #Use a list to collect parameters for each simulation

#number of simulations
num_sims <- 250


for (i in 1:num_sims) {
  tryCatch({
    # generate model parameters
    set.seed(i) #set a different seed for each simulation for variation
    params <- lapply(1:nrow(growth_data_all_0_Niclosamide), function(idx) {
      species_params <- growth_data_all_0_Niclosamide[idx, ]
      list(
        r = rnorm(1, mean = species_params$mean_max_Growth_rate, sd = species_params$sd_max_Growth_rate),
        K = rnorm(1, mean = species_params$mean_max_OD, sd = species_params$sd_max_OD)
      )
    })
    names(params) <- gsub(" ", "_", growth_data_all_0_Niclosamide$Species)
    flat_params <- unlist(params)
    names(flat_params) <- gsub("\\.\\d$", "", names(flat_params))
    
    #replace spaces with underscores to match formatting
    co_culture_correction$species <- gsub(" ", "_", co_culture_correction$species, fixed = TRUE)
    
    #replace the species-specific K parameters extracted from monoculture growth data 
    #with drawn relative abundance values at Niclosamide = 0, scaled to K
    rel_ab_control$Species <- gsub(" ", "_", rel_ab_control$Species)
    
    #Initialise an empty vector to store drawn values
    drawn_values <- numeric(nrow(rel_ab_control))
    
    #draw values from their respective distributions
    for (k in 1:nrow(rel_ab_control)) {
      species_name <- rel_ab_control$Species[k]
      drawn_value <- rnorm(1, mean = rel_ab_control$mean_rel_ab[k], sd = rel_ab_control$sd_rel_ab[k])
      drawn_values[k] <- max(drawn_value, 0)  # Ensure no negative values
    }
    
    #Normalise drawn relative abundance values so they sum to 1 (to reflect a 'true' relative abundance distribution)
    #this is needed so when we convert the values into OD units by multiplying with the drawn community maxOD,
    # the sum of K_i parameters and the drawn K are equal
    normalised_values <- drawn_values / sum(drawn_values)
    
    #Pull community maxOD (K) at 0 drugs from respective normal distribution:
    K <- rnorm(n = 1, mean = rel_ab_control$mean_com_max_OD[1], sd = rel_ab_control$sd_com_max_OD[1])
    
    # Assign these normalised values to their respective species' .K parameters
    for (k in 1:nrow(rel_ab_control)) {
      species_name <- rel_ab_control$Species[k]
      k_index <- grep(paste0("^", species_name, "\\.K$"), names(flat_params))
      
      if (length(k_index) > 0) {
        old_value <- flat_params[k_index]
        flat_params[k_index] <- (normalised_values[k] + 0.0001) * K #add small value in case drawn K_i is 0, which would cause issues with the solver
        cat(sprintf("Updated %s from %f to %f using normalised value %f scaled by K %f\n", names(flat_params)[k_index], old_value, flat_params[k_index], normalised_values[k], K))
      }
    }
    
    #Accounting for variation in drug degradation by community, with standard deviation of end concentration (at 10h) around the fitted predicted (relative) end concentration at 24h
    #prop_left_Olanzapine <- abs(rnorm(1, (subset(drug_dynamics, Drug == "Olanzapine")$Prop_left_24h_community), (subset(drug_dynamics, Drug == "Olanzapine")$SD_drug_community))) 
    #below, we account for measurement error rather than ecological drivers that lead to the variability of degradation at the final point measured 
    prop_left_Olanzapine <- abs(rnorm(
      n = 1, 
      mean = subset(drug_dynamics, Drug == "Olanzapine")$Prop_left_24h_community, 
      sd = ifelse(
        subset(drug_dynamics, Drug == "Olanzapine")$SD_drug_community > subset(drug_dynamics, Drug == "Olanzapine")$SD_drug_community_start, 
        subset(drug_dynamics, Drug == "Olanzapine")$SD_drug_community - subset(drug_dynamics, Drug == "Olanzapine")$SD_drug_community_start, 
        subset(drug_dynamics, Drug == "Olanzapine")$SD_drug_community
      )
    ))
    
    
    #loop through each species in co_culture_correction
    for (j in 1:nrow(co_culture_correction)) {
      # Extract the species name and correction factor
      species_name <- co_culture_correction$species[j]
      correction_factor <- co_culture_correction$correction_factor[j]
      
      # Identify the corresponding growth rate parameter in flat_params
      #by matching the base species name (without .r)
      growth_rate_indices <- grep(paste0("^", species_name, "\\.r$"), names(flat_params))
      
      #take the growth rate parameter and apply the correction factor 
      for (index in growth_rate_indices) {
        flat_params[index] <- flat_params[index] * correction_factor
      }
    }
    
    flat_params
    # Store parameters for each simulation
    input_params_list[[i]] <- c(sim_ID = i, flat_params)
    
    # Run the model for the first 24-hour cycle
    solution_cycle_1 <- ode(y = initial_conditions, times = seq(from = 0, to = 24, by = 0.1), func = closed.sir.model_Olanzapine, parms = flat_params,   method = "lsoda", rtol = 1e-6, atol = 1e-6)
    
    # Dilution and second cycle
    end_of_cycle_1 <- solution_cycle_1[nrow(solution_cycle_1), -1]
    initial_conditions_cycle_2 <- end_of_cycle_1 / 50
    #accounting for the drugs being added with the new growth cycle as well:
    initial_conditions_cycle_2[33] <- initial_conditions_cycle_2[33] + drug_concentration_tested
    solution_cycle_2 <- ode(y = initial_conditions_cycle_2, times = seq(from = 24, to = 48, by = 0.1), func = closed.sir.model_Olanzapine, parms = flat_params,  method = "lsoda", rtol = 1e-6, atol = 1e-6)
    
    # Combine and format results
    combined_solution <- rbind(as.data.frame(solution_cycle_1), as.data.frame(solution_cycle_2)[-1,])
    combined_solution$sim_ID <- rep(i, nrow(combined_solution))
    combined_solution <- combined_solution %>%
      tidyr::gather(key = "Species", value = "Density", -time, -sim_ID) %>%
      dplyr::mutate(Hour = time) %>%
      dplyr::select(sim_ID, Hour, Species, Density)
    
    ##Append to sim_output
    sim_output <- rbind(sim_output, combined_solution)
  }, error = function(e) {
    cat(sprintf("Skipping simulation %d due to an error: %s\n", i, e$message))
  })
}



##Combine all parameter data into a single dataframe
input_params <- do.call(rbind, input_params_list)

# Add a "Species" column 
sim_output$Species_name <- species_names[as.numeric(as.character(sim_output$Species))]
sim_output$Species_name <- replace_na(sim_output$Species_name, "Drug")

#View(input_params)
#View(sim_output)

sim_output <- na.omit(sim_output)
successful_sim_ids <- unique(subset(sim_output, Hour == 48)$sim_ID)
length(successful_sim_ids)
sim_output1 <- sim_output[sim_output$sim_ID %in% successful_sim_ids, ]


#Transform sim_output so we have wide format by Species
sim_output_wide <- tidyr::pivot_wider(sim_output1, 
                                      names_from = Species_name, 
                                      values_from = Density,
                                      id_cols = c(sim_ID, Hour))

length(unique(sim_output_wide$sim_ID))
#calc community OD per timepoint
sim_output_wide$Total_OD <- rowSums(sim_output_wide[, 3:34], na.rm = TRUE)
#calculate and add relative abundances here as well:
species_columns <- colnames(sim_output_wide)[3:34] 

for (species in species_columns) {
  sim_output_wide[[paste0("rel_", species)]] <- sim_output_wide[[species]] / sim_output_wide$Total_OD
}


#assign sim_output_wide test conditions to dataframe name
drug_tested <- "Olanzapine"
variable_name_1 <- paste0("sim_output_wide_", ifelse(drug_concentration_tested == 1e-04, 0, drug_concentration_tested), "_", drug_tested)
assign(variable_name_1, sim_output_wide)

#turn back into long format if interested in plotting relative abundances
cols_needed <- c("sim_ID", "Hour")

sim_output_long <- sim_output_wide %>% 
  dplyr::select(sim_ID, Hour, Drug, starts_with("rel_")) %>% 
  tidyr::pivot_longer(
    cols = c(Drug, starts_with("rel_")),
    names_to = "Species", 
    values_to = "Relative_abundance",
    names_prefix = "rel_",
    names_transform = list(Species = ~ ifelse(.x == "Drug", "Drug", .x))
  ) 

str(sim_output_long)


species_names_1 <- c(
  "A_muciniphila",
  "B_adolescentis",
  "B_fragilis",
  "B_longum",
  "B_obeum",
  "B_thetaiotaomicron",
  "B_uniformis",
  "B_vulgatus",
  "B_wadsworthia",
  "C_aerofaciens",
  "C_bolteae",
  "C_comes",
  "C_perfringens",
  "C_ramosum",
  "C_saccharolyticum",
  "D_formicigenerans",
  "E_coli",
  "E_lenta",
  "E_rectale",
  "F_nucleatum",
  "L_paracasei",
  "O_splanchnicus",
  "P_copri",
  "P_distasonis",
  "P_merdae",
  "R_bromii",
  "R_gnavus",
  "R_intestinalis",
  "R_torques",
  "S_parasanguinis",
  "S_salivarius",
  "V_parvula",
  "Drug"
)

species_colours_1 <- c(
  "A_muciniphila" = "#1f77b4",
  "B_adolescentis" = "#ff7f0e",
  "B_fragilis" = "#2ca02c",
  "B_longum" = "#d62728",
  "B_obeum" = "#9467bd",
  "B_thetaiotaomicron" = "black",
  "B_uniformis" = "#e377c2",
  "B_vulgatus" = "#7f7f7f",
  "B_wadsworthia" = "gold1",
  "C_aerofaciens" = "#aec7e8",
  "C_bolteae" = "#ffbb78",
  "C_comes" = "magenta",
  "C_perfringens" = "#ff9896",
  "C_ramosum" = "#c5b0d5",
  "C_saccharolyticum" = "#c49c94",
  "D_formicigenerans" = "#f7b6d2",
  "E_coli" = "yellow",
  "E_lenta" = "turquoise",
  "E_rectale" = "#393b79",
  "F_nucleatum" = "royalblue2",
  "L_paracasei" = "blue",
  "O_splanchnicus" = "#637939",
  "P_copri" = "cyan",
  "P_distasonis" = "#8c6d31",
  "P_merdae" = "#c7c7c7",
  "R_bromii" = "#e6550d",
  "R_gnavus" = "#e7cb94",
  "R_intestinalis" = "#843c39",
  "R_torques" = "#d6616b",
  "S_parasanguinis" = "orange3",
  "S_salivarius" = "#7b4173",
  "V_parvula" = "#ce6dbd",
  "Drug" = "green"
)



##Plot output for any specific sim:
# ggplot(subset(sim_output, sim_ID == 1 & Species_name != "Drug"), aes(x = Hour, y = Density, group = Species_name, color = Species_name)) +
#   geom_line(size = 1, alpha = 0.7) +
#   scale_color_manual(values = species_colours_1) +
#   labs(title = paste0("Olanzapine = ", drug_concentration_tested),
#        x = "Time (hours)",
#        y = "Population Density (OD)",
#        color = "Species") +
#   theme_minimal() +
#   theme(legend.position = "right")
# 
# ggplot(subset(sim_output, sim_ID == 3 & Species_name != "Drug"), aes(x = Hour, y = Density, group = Species_name, color = Species_name)) +
#   geom_line(size = 1, alpha = 0.7) +
#   scale_color_manual(values = species_colours_1) +
#   labs(title = paste0("Olanzapine = ", drug_concentration_tested),
#        x = "Time (hours)",
#        y = "Population Density (OD)",
#        color = "Species") +
#   theme_minimal() +
#   theme(legend.position = "right")


ggplot(subset(sim_output_long, sim_ID == 1), aes(x = Hour, y = Relative_abundance, group = Species, color = Species)) +
  geom_line(size = 1, alpha = 0.7) +
  scale_color_manual(values = species_colours_1) +
  labs(title = paste0("Olanzapine = ", drug_concentration_tested),
       x = "Time (hours)",
       y = "Relative abundance",
       color = "Species") +
  theme_minimal() +
  theme(legend.position = "right")


ggplot(subset(sim_output_long, sim_ID == 3), aes(x = Hour, y = Relative_abundance, group = Species, color = Species)) +
  geom_line(size = 1, alpha = 0.7) +
  scale_color_manual(values = species_colours_1) +
  labs(title = paste0("Olanzapine = ", drug_concentration_tested),
       x = "Time (hours)",
       y = "Relative abundance",
       color = "Species") +
  theme_minimal() +
  theme(legend.position = "right")


#calc mean and standard deviation across sims
sim_stats <- sim_output_long %>%
  dplyr::group_by(Hour, Species) %>%
  dplyr::summarise(
    mean_rel_ab = mean(Relative_abundance),
    sd_rel_ab = sd(Relative_abundance),
    .groups = 'drop'
  )

# Prepare the data for plotting
plot_data <- sim_stats %>%
  dplyr::mutate(Upper = mean_rel_ab + sd_rel_ab, Lower = mean_rel_ab - sd_rel_ab)

ggplot(subset(plot_data, Species != "Drug"), aes(x = Hour, y = mean_rel_ab, group = Species, color = Species)) +
  geom_ribbon(aes(ymin = Lower, ymax = Upper, fill = Species), colour = NA, alpha = 0.2) +  
  geom_line(size = 1, alpha = 0.7) + 
  scale_color_manual(values = species_colours_1) +
  scale_fill_manual(values = species_colours_1) +  
  labs(title = "Mean and SD of Relative Abundance Across Simulations",
       subtitle = paste0("Olanzapine = ", drug_concentration_tested),       
       x = "Time (hours)",
       y = "Relative abundance",
       color = "Species",
       fill = "Species") +
  theme_minimal() +
  theme(legend.position = "right")

#log-scaled mean trends
ggplot(plot_data, aes(x = Hour, y = log10(mean_rel_ab + 0.0001), group = Species, color = Species)) +
  geom_line(size = 1, alpha = 0.7) +  # Mean line
  scale_color_manual(values = species_colours_1) +
  scale_fill_manual(values = species_colours_1) +  # Ensure consistent colors for lines and fills
  labs(title = "Mean and SD of Relative Abundance Across Simulations",
       subtitle = paste0("Olanzapine = ", drug_concentration_tested),
       x = "Time (hours)",
       y = "Relative abundance",
       color = "Species",
       fill = "Species") +
  theme_minimal() +
  theme(legend.position = "right")




##prediction quality evaluation
drug_tested <- "Olanzapine"
variable_name <- paste0("plot_data_", ifelse(drug_concentration_tested == 1e-04, 0, drug_concentration_tested), "_", drug_tested)
assign(variable_name, plot_data)


#extract total OD info:
predicted_mean_final_od_NULL <- Niclosamide_16S_0uM_summarised$mean_com_final_OD[1]
predicted_sd_final_od_NULL <- Niclosamide_16S_0uM_summarised$sd_com_final_OD[1]

predicted_mean_final_od_5_Olanzapine <- mean(subset(sim_output_wide_5_Olanzapine, Hour == 48)$Total_OD, na.rm = TRUE)
predicted_sd_final_od_5_Olanzapine <- sd(subset(sim_output_wide_5_Olanzapine, Hour == 48)$Total_OD, na.rm = TRUE)

real_mean_final_od_5_Olanzapine <- Community_compositions_focus_drugs_Olanzapine_5uM_summarised$mean_final_OD[1]
real_sd_final_od_5_Olanzapine <- Community_compositions_focus_drugs_Olanzapine_5uM_summarised$sd_final_OD[1]


predicted_mean_final_od_20_Olanzapine <- mean(subset(sim_output_wide_20_Olanzapine, Hour == 48)$Total_OD, na.rm = TRUE)
predicted_sd_final_od_20_Olanzapine <- sd(subset(sim_output_wide_20_Olanzapine, Hour == 48)$Total_OD, na.rm = TRUE)

real_mean_final_od_20_Olanzapine <- Community_compositions_focus_drugs_Olanzapine_20uM_summarised$mean_final_OD[1]
real_sd_final_od_20_Olanzapine <- Community_compositions_focus_drugs_Olanzapine_20uM_summarised$sd_final_OD[1]


predicted_mean_final_od_80_Olanzapine <- mean(subset(sim_output_wide_80_Olanzapine, Hour == 48)$Total_OD, na.rm = TRUE)
predicted_sd_final_od_80_Olanzapine <- sd(subset(sim_output_wide_80_Olanzapine, Hour == 48)$Total_OD, na.rm = TRUE)

real_mean_final_od_80_Olanzapine <- Community_compositions_focus_drugs_Olanzapine_80uM_summarised$mean_final_OD[1]
real_sd_final_od_80_Olanzapine <- Community_compositions_focus_drugs_Olanzapine_80uM_summarised$sd_final_OD[1]




#plot_data_0_Olanzapine_endpoint was used to test model performance at 0 drugs
#plot_data_0_Olanzapine_endpoint <- subset(plot_data_0_Olanzapine, Hour == 48 & Species != "Drug")
plot_data_5_Olanzapine_endpoint <- subset(plot_data_5_Olanzapine, Hour == 48 & Species != "Drug")
plot_data_20_Olanzapine_endpoint <- subset(plot_data_20_Olanzapine, Hour == 48 & Species != "Drug")
plot_data_80_Olanzapine_endpoint <- subset(plot_data_80_Olanzapine, Hour == 48 & Species != "Drug")

##Inspecting 'match' to real relative abundance distributions:
Niclosamide_16S_0uM_summarised <- rel_ab_control
Niclosamide_16S_0uM_summarised$Species <- gsub("\\.", "", Niclosamide_16S_0uM_summarised$Species)

Olanzapine_16S_5uM_summarised <- Community_compositions_focus_drugs_Olanzapine_5uM_summarised
Olanzapine_16S_20uM_summarised <- Community_compositions_focus_drugs_Olanzapine_20uM_summarised
Olanzapine_16S_80uM_summarised <- Community_compositions_focus_drugs_Olanzapine_80uM_summarised

Niclosamide_16S_0uM_summarised
Olanzapine_16S_5uM_summarised 
Olanzapine_16S_20uM_summarised 
Olanzapine_16S_80uM_summarised 

#Rename 'species' so the outputs become comparable
original_names_80 <- unique(Olanzapine_16S_80uM_summarised$species)
original_names_20 <- unique(Olanzapine_16S_20uM_summarised$species)
original_names_5 <- unique(Olanzapine_16S_5uM_summarised$species)


##Create a named vector with the original and new names mapping
name_changes <- c(
  "Akkermansia muciniphila" = "A_muciniphila",
  "Bacteroides fragilis" = "B_fragilis",
  "Bacteroides thetaiotaomicron" = "B_thetaiotaomicron",
  "Bacteroides uniformis" = "B_uniformis",
  "Bifidobacterium adolescentis" = "B_adolescentis",
  "Bifidobacterium longum subsp. longum" = "B_longum",
  "Bilophila wadsworthia" = "B_wadsworthia",
  "Blautia obeum" = "B_obeum",
  "Clostridium perfringens" = "C_perfringens",
  "Collinsella aerofaciens" = "C_aerofaciens",
  "Coprococcus comes" = "C_comes",
  "Dorea formicigenerans" = "D_formicigenerans",
  "Eggerthella lenta" = "E_lenta",
  "Enterocloster bolteae" = "C_bolteae",
  "Erysipelatoclostridium ramosum" = "C_ramosum",
  "Escherichia coli ED1a" = "E_coli",
  "Eubacterium rectale" = "E_rectale",
  "Fusobacterium nucleatum subsp. nucleatum" = "F_nucleatum",
  "Lacrimispora saccharolytica" = "C_saccharolyticum",
  "Lacticaseibacillus paracasei" = "L_paracasei",
  "Odoribacter splanchnicus" = "O_splanchnicus",
  "Parabacteroides distasonis" = "P_distasonis",
  "Parabacteroides merdae" = "P_merdae",
  "Phocaeicola vulgatus" = "B_vulgatus",
  "Prevotella copri" = "P_copri",
  "Roseburia intestinalis" = "R_intestinalis",
  "Ruminococcus bromii" = "R_bromii",
  "Ruminococcus gnavus" = "R_gnavus",
  "Ruminococcus torques" = "R_torques",
  "Streptococcus parasanguinis" = "S_parasanguinis",
  "Streptococcus salivarius" = "S_salivarius",
  "Veillonella parvula" = "V_parvula"
)

# Apply name changes to the species column in Olanzapine_16S_80uM_summarised

Olanzapine_16S_80uM_summarised$Species <- name_changes[Olanzapine_16S_80uM_summarised$species]
Olanzapine_16S_20uM_summarised$Species <- name_changes[Olanzapine_16S_20uM_summarised$species]
Olanzapine_16S_5uM_summarised$Species <- name_changes[Olanzapine_16S_5uM_summarised$species]

# Verify the changes
unique(Olanzapine_16S_80uM_summarised$Species)
unique(Olanzapine_16S_20uM_summarised$Species)
unique(Olanzapine_16S_5uM_summarised$Species)



##First, for 5 uM:
# Get top 6 species from plot_data_5_endpoint
# Adjust the plot_data_5_endpoint with confidence bounds

# #plot_data_0_Olanzapine_endpoint was used to test model performance at 0 drugs
# plot_data_0_Olanzapine_endpoint <- plot_data_0_Olanzapine_endpoint %>%
#   dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)

plot_data_5_Olanzapine_endpoint <- plot_data_5_Olanzapine_endpoint %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)

# Adjust the Olanzapine_16S_5uM_summarised with confidence bounds
Olanzapine_16S_5uM_summarised <- Olanzapine_16S_5uM_summarised %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)

#NULL model:
Null_model_summarised <- Niclosamide_16S_0uM_summarised %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)


# Get top 6 species based on the lower bound from plot_data_5_endpoint

#top6_predicted_0_Olanzapine was used to test model performance at 0 drugs
# top6_predicted_0_Olanzapine <- plot_data_0_Olanzapine_endpoint %>%
#    arrange(desc(lower_bound)) %>%
#    slice(1:6) %>%
#    pull(Species)

top6_predicted_5_Olanzapine <- plot_data_5_Olanzapine_endpoint %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

# Get top 6 species based on the lower bound from Olanzapine_16S_5uM_summarised
top6_real_5_Olanzapine <- Olanzapine_16S_5uM_summarised %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

top6_NULL <- Null_model_summarised %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

# Calculate the overlap of top 6 species

#top_six_correct_0_Olanzapine was used to assess model performance at 0 drugs
# top_six_correct_0_Olanzapine <- length(intersect(top6_predicted_0_Olanzapine, top6_NULL))
# top_six_correct_0_Olanzapine

top_six_correct_5_Olanzapine <- length(intersect(top6_predicted_5_Olanzapine, top6_real_5_Olanzapine))
top_six_correct_5_Olanzapine

top_six_correct_5_Olanzapine_NULL <- length(intersect(top6_NULL, top6_real_5_Olanzapine))
top_six_correct_5_Olanzapine_NULL

top6_predicted_5_Olanzapine
top6_real_5_Olanzapine

#top6_NULL

#Now by means:
# #top6_predicted_0_Olanzapine_means was used to assess model performance at 0 drugs
# top6_predicted_0_Olanzapine_means <- plot_data_0_Olanzapine_endpoint %>%
#    arrange(desc(mean_rel_ab)) %>%
#    slice(1:6) %>%
#    pull(Species)

top6_predicted_5_Olanzapine_means <- plot_data_5_Olanzapine_endpoint %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)

# Get top 6 species based on the lower bound from Olanzapine_16S_5uM_summarised
top6_real_5_Olanzapine_means <- Olanzapine_16S_5uM_summarised %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)

top6_NULL_means <- Null_model_summarised %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)


# #top_six_correct_0_Olanzapine_means was used to assess model performance at 0 drugs
# top_six_correct_0_Olanzapine_means <- length(intersect(top6_predicted_0_Olanzapine_means, top6_NULL_means))
# top_six_correct_0_Olanzapine_means

top_six_correct_5_Olanzapine_means <- length(intersect(top6_predicted_5_Olanzapine_means, top6_real_5_Olanzapine_means))
top_six_correct_5_Olanzapine_means

top_six_correct_5_Olanzapine_means_NULL <- length(intersect(top6_NULL_means, top6_real_5_Olanzapine_means))
top_six_correct_5_Olanzapine_means_NULL

top6_predicted_5_Olanzapine_means
top6_real_5_Olanzapine_means

#top6_NULL_means


# Merge dataframes by Species

#merged_data_0_Olanzapine was used to assess model performance at 0 drugs
#merged_data_0_Olanzapine <- merge(plot_data_0_Olanzapine_endpoint, Niclosamide_16S_0uM_summarised, by = "Species", suffixes = c(".pred", ".real"))
merged_data_5_Olanzapine <- merge(plot_data_5_Olanzapine_endpoint, Olanzapine_16S_5uM_summarised, by = "Species", suffixes = c(".pred", ".real"))
merged_data_5_Olanzapine_NULL <- merge(Niclosamide_16S_0uM_summarised, Olanzapine_16S_5uM_summarised, by = "Species", suffixes = c(".null", ".real"))


## Below lines used for assessing model performance at 0 drugs; ignore for nonzero concentrations
# # Create lower and upper bounds considering mean ¬± sd
# merged_data_0_Olanzapine$lower_bound_pred <- merged_data_0_Olanzapine$mean_rel_ab.pred - merged_data_0_Olanzapine$sd_rel_ab.pred
# merged_data_0_Olanzapine$upper_bound_pred <- merged_data_0_Olanzapine$mean_rel_ab.pred + merged_data_0_Olanzapine$sd_rel_ab.pred
# merged_data_0_Olanzapine$lower_bound_real <- merged_data_0_Olanzapine$mean_rel_ab.real - merged_data_0_Olanzapine$sd_rel_ab.real
# merged_data_0_Olanzapine$upper_bound_real <- merged_data_0_Olanzapine$mean_rel_ab.real + merged_data_0_Olanzapine$sd_rel_ab.real
# 
# # Ensure lower and upper bounds are non-negative, adjusting as necessary
# merged_data_0_Olanzapine$lower_bound_pred[merged_data_0_Olanzapine$lower_bound_pred <= 0] <- 1e-10
# merged_data_0_Olanzapine$lower_bound_real[merged_data_0_Olanzapine$lower_bound_real <= 0] <- 1e-10
# merged_data_0_Olanzapine$upper_bound_pred[merged_data_0_Olanzapine$upper_bound_pred <= 0] <- 1e-10
# merged_data_0_Olanzapine$upper_bound_real[merged_data_0_Olanzapine$upper_bound_real <= 0] <- 1e-10


# Create lower and upper bounds considering mean ¬± sd
merged_data_5_Olanzapine$lower_bound_pred <- merged_data_5_Olanzapine$mean_rel_ab.pred - merged_data_5_Olanzapine$sd_rel_ab.pred
merged_data_5_Olanzapine$upper_bound_pred <- merged_data_5_Olanzapine$mean_rel_ab.pred + merged_data_5_Olanzapine$sd_rel_ab.pred
merged_data_5_Olanzapine$lower_bound_real <- merged_data_5_Olanzapine$mean_rel_ab.real - merged_data_5_Olanzapine$sd_rel_ab.real
merged_data_5_Olanzapine$upper_bound_real <- merged_data_5_Olanzapine$mean_rel_ab.real + merged_data_5_Olanzapine$sd_rel_ab.real

# Ensure lower and upper bounds are non-negative, adjusting as necessary
merged_data_5_Olanzapine$lower_bound_pred[merged_data_5_Olanzapine$lower_bound_pred <= 0] <- 1e-10
merged_data_5_Olanzapine$lower_bound_real[merged_data_5_Olanzapine$lower_bound_real <= 0] <- 1e-10
merged_data_5_Olanzapine$upper_bound_pred[merged_data_5_Olanzapine$upper_bound_pred <= 0] <- 1e-10
merged_data_5_Olanzapine$upper_bound_real[merged_data_5_Olanzapine$upper_bound_real <= 0] <- 1e-10

##and for NULL model:
# Create lower and upper bounds considering mean ¬± sd
merged_data_5_Olanzapine_NULL$lower_bound_null <- merged_data_5_Olanzapine_NULL$mean_rel_ab.null - merged_data_5_Olanzapine_NULL$sd_rel_ab.null
merged_data_5_Olanzapine_NULL$upper_bound_null <- merged_data_5_Olanzapine_NULL$mean_rel_ab.null + merged_data_5_Olanzapine_NULL$sd_rel_ab.null
merged_data_5_Olanzapine_NULL$lower_bound_real <- merged_data_5_Olanzapine_NULL$mean_rel_ab.real - merged_data_5_Olanzapine_NULL$sd_rel_ab.real
merged_data_5_Olanzapine_NULL$upper_bound_real <- merged_data_5_Olanzapine_NULL$mean_rel_ab.real + merged_data_5_Olanzapine_NULL$sd_rel_ab.real

# Ensure lower and upper bounds are non-negative, adjusting as necessary
merged_data_5_Olanzapine_NULL$lower_bound_null[merged_data_5_Olanzapine_NULL$lower_bound_null <= 0] <- 1e-10
merged_data_5_Olanzapine_NULL$lower_bound_real[merged_data_5_Olanzapine_NULL$lower_bound_real <= 0] <- 1e-10
merged_data_5_Olanzapine_NULL$upper_bound_null[merged_data_5_Olanzapine_NULL$upper_bound_null <= 0] <- 1e-10
merged_data_5_Olanzapine_NULL$upper_bound_real[merged_data_5_Olanzapine_NULL$upper_bound_real <= 0] <- 1e-10

# Filter to include only species with a mean relative abundance > 0.01 in the 'real' dataset

## significant_species_0 was used to assess model performance at 0 drugs
#significant_species_0 <- merged_data_0_Olanzapine[merged_data_0_Olanzapine$mean_rel_ab.real > 0.01, ]
significant_species <- merged_data_5_Olanzapine[merged_data_5_Olanzapine$mean_rel_ab.real > 0.01, ]
survivors_5_Olanzapine <- nrow(significant_species)
survivors_5_Olanzapine

#should be the same as survivors defined above, since it is calculated from .real
significant_species_NULL <- merged_data_5_Olanzapine_NULL[merged_data_5_Olanzapine_NULL$mean_rel_ab.real > 0.01, ]
survivors_5_Olanzapine_NULL <- nrow(significant_species_NULL)
survivors_5_Olanzapine_NULL

# Adjusted order of magnitude check to include SD, only for significant species
## below code was used to assess model performance at 0 drugs
# significant_species_0$Predicted_magnitude_correct <- ifelse(
#   (floor(log10(significant_species_0$lower_bound_pred)) <= floor(log10(significant_species_0$upper_bound_real)) &
#      floor(log10(significant_species_0$upper_bound_pred)) >= floor(log10(significant_species_0$lower_bound_real))),
#   1,
#   0
# )

significant_species$Predicted_magnitude_correct <- ifelse(
  (floor(log10(significant_species$lower_bound_pred)) <= floor(log10(significant_species$upper_bound_real)) &
     floor(log10(significant_species$upper_bound_pred)) >= floor(log10(significant_species$lower_bound_real))),
  1,
  0
)

#and for the Null model:
significant_species_NULL$Predicted_magnitude_correct <- ifelse(
  (floor(log10(significant_species_NULL$lower_bound_null)) <= floor(log10(significant_species_NULL$upper_bound_real)) &
     floor(log10(significant_species_NULL$upper_bound_null)) >= floor(log10(significant_species_NULL$lower_bound_real))),
  1,
  0
)

# Calculate the fraction of correctly predicted magnitudes for significant species
## below code was used to assess model performance at 0 drugs
#predicted_magnitude_correct_fraction_0_Olanzapine <- sum(significant_species_0$Predicted_magnitude_correct) / nrow(significant_species_0)
#predicted_magnitude_correct_fraction_0_Olanzapine

predicted_magnitude_correct_fraction_5_Olanzapine <- sum(significant_species$Predicted_magnitude_correct) / nrow(significant_species)
predicted_magnitude_correct_fraction_5_Olanzapine

predicted_magnitude_correct_fraction_5_Olanzapine_NULL <- sum(significant_species_NULL$Predicted_magnitude_correct) / nrow(significant_species_NULL)
predicted_magnitude_correct_fraction_5_Olanzapine_NULL

top_species_missing_5_Olanzapine <- setdiff(top6_real_5_Olanzapine_means, top6_predicted_5_Olanzapine_means)
top_species_wrong_5_Olanzapine <- setdiff(top6_predicted_5_Olanzapine_means, top6_real_5_Olanzapine_means)

top_species_missing_5_Olanzapine <- if(length(top_species_missing_5_Olanzapine) == 0) "None" else top_species_missing_5_Olanzapine
top_species_wrong_5_Olanzapine <- if(length(top_species_wrong_5_Olanzapine) == 0) "None" else top_species_wrong_5_Olanzapine

Prediction_quality_5_Olanzapine <- data.frame(
  Top_six_correct = paste(top_six_correct_5_Olanzapine, sep=""),
  Top_six_correct_NULL = paste(top_six_correct_5_Olanzapine_NULL, sep=""),
  Top_six_correct_means = paste(top_six_correct_5_Olanzapine_means, sep=""),
  Top_six_correct_means_NULL = paste(top_six_correct_5_Olanzapine_means_NULL, sep=""),
  Predicted_magnitude_correct = paste(round(predicted_magnitude_correct_fraction_5_Olanzapine * 100, 2), "%", sep=""),
  Predicted_magnitude_correct_NULL = paste(round(predicted_magnitude_correct_fraction_5_Olanzapine_NULL * 100, 2), "%", sep=""),
  survivors_total = survivors_5_Olanzapine,
  top_species_missing <- top_species_missing_5_Olanzapine,
  top_species_wrong <- top_species_wrong_5_Olanzapine, 
  predicted_mean_final_OD <- predicted_mean_final_od_5_Olanzapine,
  real_mean_final_OD <- real_mean_final_od_5_Olanzapine,
  sims_total = length(successful_sim_ids)
)



Prediction_quality_5_Olanzapine



##Next, for 20 uM:
# Get top 6 species from plot_data_20_endpoint
# Adjust the plot_data_20_endpoint with confidence bounds
plot_data_20_Olanzapine_endpoint <- plot_data_20_Olanzapine_endpoint %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)

# Adjust the Olanzapine_16S_20uM_summarised with confidence bounds
Olanzapine_16S_20uM_summarised <- Olanzapine_16S_20uM_summarised %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)

#NULL model:
Null_model_summarised <- Niclosamide_16S_0uM_summarised %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)


# Get top 6 species based on the lower bound from plot_data_20_endpoint
top6_predicted_20_Olanzapine <- plot_data_20_Olanzapine_endpoint %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

# Get top 6 species based on the lower bound from Olanzapine_16S_20uM_summarised
top6_real_20_Olanzapine <- Olanzapine_16S_20uM_summarised %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

top6_NULL <- Null_model_summarised %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

# Calculate the overlap of top 6 species
top_six_correct_20_Olanzapine <- length(intersect(top6_predicted_20_Olanzapine, top6_real_20_Olanzapine))
#top_six_correct_20_Olanzapine

top_six_correct_20_Olanzapine_NULL <- length(intersect(top6_NULL, top6_real_20_Olanzapine))
#top_six_correct_20_Olanzapine_NULL

#top6_predicted_20_Olanzapine
#top6_real_20_Olanzapine



#Now by means:
top6_predicted_20_Olanzapine_means <- plot_data_20_Olanzapine_endpoint %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)

# Get top 6 species based on the lower bound from Olanzapine_16S_20uM_summarised
top6_real_20_Olanzapine_means <- Olanzapine_16S_20uM_summarised %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)

top6_NULL_means <- Null_model_summarised %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)



top_six_correct_20_Olanzapine_means <- length(intersect(top6_predicted_20_Olanzapine_means, top6_real_20_Olanzapine_means))
#top_six_correct_20_Olanzapine_means

top_six_correct_20_Olanzapine_means_NULL <- length(intersect(top6_NULL_means, top6_real_20_Olanzapine_means))
#top_six_correct_20_Olanzapine_means_NULL

top6_predicted_20_Olanzapine_means
#top6_real_20_Olanzapine_means




# Merge dataframes by Species
merged_data_20_Olanzapine <- merge(plot_data_20_Olanzapine_endpoint, Olanzapine_16S_20uM_summarised, by = "Species", suffixes = c(".pred", ".real"))
merged_data_20_Olanzapine_NULL <- merge(Niclosamide_16S_0uM_summarised, Olanzapine_16S_20uM_summarised, by = "Species", suffixes = c(".null", ".real"))



# Create lower and upper bounds considering mean ¬± sd
merged_data_20_Olanzapine$lower_bound_pred <- merged_data_20_Olanzapine$mean_rel_ab.pred - merged_data_20_Olanzapine$sd_rel_ab.pred
merged_data_20_Olanzapine$upper_bound_pred <- merged_data_20_Olanzapine$mean_rel_ab.pred + merged_data_20_Olanzapine$sd_rel_ab.pred
merged_data_20_Olanzapine$lower_bound_real <- merged_data_20_Olanzapine$mean_rel_ab.real - merged_data_20_Olanzapine$sd_rel_ab.real
merged_data_20_Olanzapine$upper_bound_real <- merged_data_20_Olanzapine$mean_rel_ab.real + merged_data_20_Olanzapine$sd_rel_ab.real

# Ensure lower and upper bounds are non-negative, adjusting as necessary
merged_data_20_Olanzapine$lower_bound_pred[merged_data_20_Olanzapine$lower_bound_pred <= 0] <- 1e-10
merged_data_20_Olanzapine$lower_bound_real[merged_data_20_Olanzapine$lower_bound_real <= 0] <- 1e-10
merged_data_20_Olanzapine$upper_bound_pred[merged_data_20_Olanzapine$upper_bound_pred <= 0] <- 1e-10
merged_data_20_Olanzapine$upper_bound_real[merged_data_20_Olanzapine$upper_bound_real <= 0] <- 1e-10

##and for NULL model:
# Create lower and upper bounds considering mean ¬± sd
merged_data_20_Olanzapine_NULL$lower_bound_null <- merged_data_20_Olanzapine_NULL$mean_rel_ab.null - merged_data_20_Olanzapine_NULL$sd_rel_ab.null
merged_data_20_Olanzapine_NULL$upper_bound_null <- merged_data_20_Olanzapine_NULL$mean_rel_ab.null + merged_data_20_Olanzapine_NULL$sd_rel_ab.null
merged_data_20_Olanzapine_NULL$lower_bound_real <- merged_data_20_Olanzapine_NULL$mean_rel_ab.real - merged_data_20_Olanzapine_NULL$sd_rel_ab.real
merged_data_20_Olanzapine_NULL$upper_bound_real <- merged_data_20_Olanzapine_NULL$mean_rel_ab.real + merged_data_20_Olanzapine_NULL$sd_rel_ab.real

# Ensure lower and upper bounds are non-negative, adjusting as necessary
merged_data_20_Olanzapine_NULL$lower_bound_null[merged_data_20_Olanzapine_NULL$lower_bound_null <= 0] <- 1e-10
merged_data_20_Olanzapine_NULL$lower_bound_real[merged_data_20_Olanzapine_NULL$lower_bound_real <= 0] <- 1e-10
merged_data_20_Olanzapine_NULL$upper_bound_null[merged_data_20_Olanzapine_NULL$upper_bound_null <= 0] <- 1e-10
merged_data_20_Olanzapine_NULL$upper_bound_real[merged_data_20_Olanzapine_NULL$upper_bound_real <= 0] <- 1e-10

# Filter to include only species with a mean relative abundance > 0.01 in the 'real' dataset
significant_species <- merged_data_20_Olanzapine[merged_data_20_Olanzapine$mean_rel_ab.real > 0.01, ]
survivors_20_Olanzapine <- nrow(significant_species)
survivors_20_Olanzapine

#should be the same as survivors defined above, since it is calculated from .real
significant_species_NULL <- merged_data_20_Olanzapine_NULL[merged_data_20_Olanzapine_NULL$mean_rel_ab.real > 0.01, ]
survivors_20_Olanzapine_NULL <- nrow(significant_species_NULL)
survivors_20_Olanzapine_NULL

# Adjusted order of magnitude check to include SD, only for significant species
significant_species$Predicted_magnitude_correct <- ifelse(
  (floor(log10(significant_species$lower_bound_pred)) <= floor(log10(significant_species$upper_bound_real)) &
     floor(log10(significant_species$upper_bound_pred)) >= floor(log10(significant_species$lower_bound_real))),
  1,
  0
)

#and for the Null model:
significant_species_NULL$Predicted_magnitude_correct <- ifelse(
  (floor(log10(significant_species_NULL$lower_bound_null)) <= floor(log10(significant_species_NULL$upper_bound_real)) &
     floor(log10(significant_species_NULL$upper_bound_null)) >= floor(log10(significant_species_NULL$lower_bound_real))),
  1,
  0
)

# Calculate the fraction of correctly predicted magnitudes for significant species
predicted_magnitude_correct_fraction_20_Olanzapine <- sum(significant_species$Predicted_magnitude_correct) / nrow(significant_species)
predicted_magnitude_correct_fraction_20_Olanzapine

predicted_magnitude_correct_fraction_20_Olanzapine_NULL <- sum(significant_species_NULL$Predicted_magnitude_correct) / nrow(significant_species_NULL)
predicted_magnitude_correct_fraction_20_Olanzapine_NULL

top_species_missing_20_Olanzapine <- setdiff(top6_real_20_Olanzapine_means, top6_predicted_20_Olanzapine_means)
top_species_wrong_20_Olanzapine <- setdiff(top6_predicted_20_Olanzapine_means, top6_real_20_Olanzapine_means)

top_species_missing_20_Olanzapine <- if(length(top_species_missing_20_Olanzapine) == 0) "None" else top_species_missing_20_Olanzapine
top_species_wrong_20_Olanzapine <- if(length(top_species_wrong_20_Olanzapine) == 0) "None" else top_species_wrong_20_Olanzapine

Prediction_quality_20_Olanzapine <- data.frame(
  Top_six_correct = paste(top_six_correct_20_Olanzapine, sep=""),
  Top_six_correct_NULL = paste(top_six_correct_20_Olanzapine_NULL, sep=""),
  Top_six_correct_means = paste(top_six_correct_20_Olanzapine_means, sep=""),
  Top_six_correct_means_NULL = paste(top_six_correct_20_Olanzapine_means_NULL, sep=""),
  Predicted_magnitude_correct = paste(round(predicted_magnitude_correct_fraction_20_Olanzapine * 100, 2), "%", sep=""),
  Predicted_magnitude_correct_NULL = paste(round(predicted_magnitude_correct_fraction_20_Olanzapine_NULL * 100, 2), "%", sep=""),
  survivors_total = survivors_20_Olanzapine,
  top_species_missing <- top_species_missing_20_Olanzapine,
  top_species_wrong <- top_species_wrong_20_Olanzapine, 
  predicted_mean_final_OD <- predicted_mean_final_od_20_Olanzapine,
  real_mean_final_OD <- real_mean_final_od_20_Olanzapine,
  sims_total = length(successful_sim_ids)
)

Prediction_quality_20_Olanzapine






##Next, for 80 uM:
# Get top 6 species from plot_data_80_endpoint
# Adjust the plot_data_80_endpoint with confidence bounds
plot_data_80_Olanzapine_endpoint <- plot_data_80_Olanzapine_endpoint %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)

# Adjust the Olanzapine_16S_80uM_summarised with confidence bounds
Olanzapine_16S_80uM_summarised <- Olanzapine_16S_80uM_summarised %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)

#NULL model:
Null_model_summarised <- Niclosamide_16S_0uM_summarised %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)


# Get top 6 species based on the lower bound from plot_data_80_endpoint
top6_predicted_80_Olanzapine <- plot_data_80_Olanzapine_endpoint %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

# Get top 6 species based on the lower bound from Olanzapine_16S_80uM_summarised
top6_real_80_Olanzapine <- Olanzapine_16S_80uM_summarised %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

top6_NULL <- Null_model_summarised %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

# Calculate the overlap of top 6 species
top_six_correct_80_Olanzapine <- length(intersect(top6_predicted_80_Olanzapine, top6_real_80_Olanzapine))
#top_six_correct_80_Olanzapine

top_six_correct_80_Olanzapine_NULL <- length(intersect(top6_NULL, top6_real_80_Olanzapine))
#top_six_correct_80_Olanzapine_NULL

#top6_predicted_80_Olanzapine
#top6_real_80_Olanzapine




#Now by means:
top6_predicted_80_Olanzapine_means <- plot_data_80_Olanzapine_endpoint %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)

# Get top 6 species based on the lower bound from Olanzapine_16S_80uM_summarised
top6_real_80_Olanzapine_means <- Olanzapine_16S_80uM_summarised %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)

top6_NULL_means <- Null_model_summarised %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)



top_six_correct_80_Olanzapine_means <- length(intersect(top6_predicted_80_Olanzapine_means, top6_real_80_Olanzapine_means))
#top_six_correct_80_Olanzapine_means

top_six_correct_80_Olanzapine_means_NULL <- length(intersect(top6_NULL_means, top6_real_80_Olanzapine_means))
#top_six_correct_80_Olanzapine_means_NULL

#top6_predicted_80_Olanzapine_means
#top6_real_80_Olanzapine_means




# Merge dataframes by Species
merged_data_80_Olanzapine <- merge(plot_data_80_Olanzapine_endpoint, Olanzapine_16S_80uM_summarised, by = "Species", suffixes = c(".pred", ".real"))
merged_data_80_Olanzapine_NULL <- merge(Niclosamide_16S_0uM_summarised, Olanzapine_16S_80uM_summarised, by = "Species", suffixes = c(".null", ".real"))



# Create lower and upper bounds considering mean ¬± sd
merged_data_80_Olanzapine$lower_bound_pred <- merged_data_80_Olanzapine$mean_rel_ab.pred - merged_data_80_Olanzapine$sd_rel_ab.pred
merged_data_80_Olanzapine$upper_bound_pred <- merged_data_80_Olanzapine$mean_rel_ab.pred + merged_data_80_Olanzapine$sd_rel_ab.pred
merged_data_80_Olanzapine$lower_bound_real <- merged_data_80_Olanzapine$mean_rel_ab.real - merged_data_80_Olanzapine$sd_rel_ab.real
merged_data_80_Olanzapine$upper_bound_real <- merged_data_80_Olanzapine$mean_rel_ab.real + merged_data_80_Olanzapine$sd_rel_ab.real

# Ensure lower and upper bounds are non-negative, adjusting as necessary
merged_data_80_Olanzapine$lower_bound_pred[merged_data_80_Olanzapine$lower_bound_pred <= 0] <- 1e-10
merged_data_80_Olanzapine$lower_bound_real[merged_data_80_Olanzapine$lower_bound_real <= 0] <- 1e-10
merged_data_80_Olanzapine$upper_bound_pred[merged_data_80_Olanzapine$upper_bound_pred <= 0] <- 1e-10
merged_data_80_Olanzapine$upper_bound_real[merged_data_80_Olanzapine$upper_bound_real <= 0] <- 1e-10

##and for NULL model:
# Create lower and upper bounds considering mean ¬± sd
merged_data_80_Olanzapine_NULL$lower_bound_null <- merged_data_80_Olanzapine_NULL$mean_rel_ab.null - merged_data_80_Olanzapine_NULL$sd_rel_ab.null
merged_data_80_Olanzapine_NULL$upper_bound_null <- merged_data_80_Olanzapine_NULL$mean_rel_ab.null + merged_data_80_Olanzapine_NULL$sd_rel_ab.null
merged_data_80_Olanzapine_NULL$lower_bound_real <- merged_data_80_Olanzapine_NULL$mean_rel_ab.real - merged_data_80_Olanzapine_NULL$sd_rel_ab.real
merged_data_80_Olanzapine_NULL$upper_bound_real <- merged_data_80_Olanzapine_NULL$mean_rel_ab.real + merged_data_80_Olanzapine_NULL$sd_rel_ab.real

# Ensure lower and upper bounds are non-negative, adjusting as necessary
merged_data_80_Olanzapine_NULL$lower_bound_null[merged_data_80_Olanzapine_NULL$lower_bound_null <= 0] <- 1e-10
merged_data_80_Olanzapine_NULL$lower_bound_real[merged_data_80_Olanzapine_NULL$lower_bound_real <= 0] <- 1e-10
merged_data_80_Olanzapine_NULL$upper_bound_null[merged_data_80_Olanzapine_NULL$upper_bound_null <= 0] <- 1e-10
merged_data_80_Olanzapine_NULL$upper_bound_real[merged_data_80_Olanzapine_NULL$upper_bound_real <= 0] <- 1e-10

# Filter to include only species with a mean relative abundance > 0.01 in the 'real' dataset
significant_species <- merged_data_80_Olanzapine[merged_data_80_Olanzapine$mean_rel_ab.real > 0.01, ]
survivors_80_Olanzapine <- nrow(significant_species)
survivors_80_Olanzapine

#should be the same as survivors defined above, since it is calculated from .real
significant_species_NULL <- merged_data_80_Olanzapine_NULL[merged_data_80_Olanzapine_NULL$mean_rel_ab.real > 0.01, ]
survivors_80_Olanzapine_NULL <- nrow(significant_species_NULL)
survivors_80_Olanzapine_NULL

# Adjusted order of magnitude check to include SD, only for significant species
significant_species$Predicted_magnitude_correct <- ifelse(
  (floor(log10(significant_species$lower_bound_pred)) <= floor(log10(significant_species$upper_bound_real)) &
     floor(log10(significant_species$upper_bound_pred)) >= floor(log10(significant_species$lower_bound_real))),
  1,
  0
)

#and for the Null model:
significant_species_NULL$Predicted_magnitude_correct <- ifelse(
  (floor(log10(significant_species_NULL$lower_bound_null)) <= floor(log10(significant_species_NULL$upper_bound_real)) &
     floor(log10(significant_species_NULL$upper_bound_null)) >= floor(log10(significant_species_NULL$lower_bound_real))),
  1,
  0
)

# Calculate the fraction of correctly predicted magnitudes for significant species
predicted_magnitude_correct_fraction_80_Olanzapine <- sum(significant_species$Predicted_magnitude_correct) / nrow(significant_species)
predicted_magnitude_correct_fraction_80_Olanzapine

predicted_magnitude_correct_fraction_80_Olanzapine_NULL <- sum(significant_species_NULL$Predicted_magnitude_correct) / nrow(significant_species_NULL)
predicted_magnitude_correct_fraction_80_Olanzapine_NULL


top_species_missing_80_Olanzapine <- setdiff(top6_real_80_Olanzapine_means, top6_predicted_80_Olanzapine_means)
top_species_wrong_80_Olanzapine <- setdiff(top6_predicted_80_Olanzapine_means, top6_real_80_Olanzapine_means)

top_species_missing_80_Olanzapine <- if(length(top_species_missing_80_Olanzapine) == 0) "None" else top_species_missing_80_Olanzapine
top_species_wrong_80_Olanzapine <- if(length(top_species_wrong_80_Olanzapine) == 0) "None" else top_species_wrong_80_Olanzapine

Prediction_quality_80_Olanzapine <- data.frame(
  Top_six_correct = paste(top_six_correct_80_Olanzapine, sep=""),
  Top_six_correct_NULL = paste(top_six_correct_80_Olanzapine_NULL, sep=""),
  Top_six_correct_means = paste(top_six_correct_80_Olanzapine_means, sep=""),
  Top_six_correct_means_NULL = paste(top_six_correct_80_Olanzapine_means_NULL, sep=""),
  Predicted_magnitude_correct = paste(round(predicted_magnitude_correct_fraction_80_Olanzapine * 100, 2), "%", sep=""),
  Predicted_magnitude_correct_NULL = paste(round(predicted_magnitude_correct_fraction_80_Olanzapine_NULL * 100, 2), "%", sep=""),
  survivors_total = survivors_80_Olanzapine,
  top_species_missing <- top_species_missing_80_Olanzapine,
  top_species_wrong <- top_species_wrong_80_Olanzapine, 
  predicted_mean_final_OD <- predicted_mean_final_od_80_Olanzapine,
  real_mean_final_OD <- real_mean_final_od_80_Olanzapine,
  sims_total = length(successful_sim_ids)
)

Prediction_quality_80_Olanzapine










##Omeprazole

combined_monoculture_aucs2_Omeprazole <- subset(combined_monoculture_aucs2, drug == "Omeprazole")


#drug sensitivity terms: define once outside of ODEs
y_function_B_vulgatus_Omeprazole <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("B_vulgatus", "Omeprazole", best_fitting_models_df_Omeprazole)), collapse = " ")))
y_function_B_uniformis_Omeprazole <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("B_uniformis", "Omeprazole", best_fitting_models_df_Omeprazole)), collapse = " ")))
y_function_B_fragilis_Omeprazole <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("B_fragilis", "Omeprazole", best_fitting_models_df_Omeprazole)), collapse = " ")))
y_function_B_thetaiotaomicron_Omeprazole <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("B_thetaiotaomicron", "Omeprazole", best_fitting_models_df_Omeprazole)), collapse = " ")))
y_function_C_ramosum_Omeprazole <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("C_ramosum", "Omeprazole", best_fitting_models_df_Omeprazole)), collapse = " ")))
y_function_E_rectale_Omeprazole <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("E_rectale", "Omeprazole", best_fitting_models_df_Omeprazole)), collapse = " ")))
y_function_R_intestinalis_Omeprazole <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("R_intestinalis", "Omeprazole", best_fitting_models_df_Omeprazole)), collapse = " ")))
y_function_V_parvula_Omeprazole <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("V_parvula", "Omeprazole", best_fitting_models_df_Omeprazole)), collapse = " ")))
y_function_E_lenta_Omeprazole <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("E_lenta", "Omeprazole", best_fitting_models_df_Omeprazole)), collapse = " ")))
y_function_F_nucleatum_Omeprazole <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("F_nucleatum", "Omeprazole", best_fitting_models_df_Omeprazole)), collapse = " ")))
y_function_C_bolteae_Omeprazole <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("C_bolteae", "Omeprazole", best_fitting_models_df_Omeprazole)), collapse = " ")))
y_function_C_perfringens_Omeprazole <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("C_perfringens", "Omeprazole", best_fitting_models_df_Omeprazole)), collapse = " ")))
y_function_C_saccharolyticum_Omeprazole <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("C_saccharolyticum", "Omeprazole", best_fitting_models_df_Omeprazole)), collapse = " ")))
y_function_S_salivarius_Omeprazole <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("S_salivarius", "Omeprazole", best_fitting_models_df_Omeprazole)), collapse = " ")))
y_function_R_gnavus_Omeprazole <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("R_gnavus", "Omeprazole", best_fitting_models_df_Omeprazole)), collapse = " ")))
y_function_C_comes_Omeprazole <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("C_comes", "Omeprazole", best_fitting_models_df_Omeprazole)), collapse = " ")))
y_function_P_merdae_Omeprazole <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("P_merdae", "Omeprazole", best_fitting_models_df_Omeprazole)), collapse = " ")))
y_function_S_parasanguinis_Omeprazole <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("S_parasanguinis", "Omeprazole", best_fitting_models_df_Omeprazole)), collapse = " ")))
y_function_C_aerofaciens_Omeprazole <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("C_aerofaciens", "Omeprazole", best_fitting_models_df_Omeprazole)), collapse = " ")))
y_function_D_formicigenerans_Omeprazole <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("D_formicigenerans", "Omeprazole", best_fitting_models_df_Omeprazole)), collapse = " ")))
y_function_E_coli_Omeprazole <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("E_coli", "Omeprazole", best_fitting_models_df_Omeprazole)), collapse = " ")))



y_function_B_vulgatus_Omeprazole_func <- eval(parse(text = paste("function(Drug) {", y_function_B_vulgatus_Omeprazole, "}")))
y_function_B_uniformis_Omeprazole_func <- eval(parse(text = paste("function(Drug) {", y_function_B_uniformis_Omeprazole, "}")))
y_function_B_fragilis_Omeprazole_func <- eval(parse(text = paste("function(Drug) {", y_function_B_fragilis_Omeprazole, "}")))
y_function_B_thetaiotaomicron_Omeprazole_func <- eval(parse(text = paste("function(Drug) {", y_function_B_thetaiotaomicron_Omeprazole, "}")))
y_function_C_ramosum_Omeprazole_func <- eval(parse(text = paste("function(Drug) {", y_function_C_ramosum_Omeprazole, "}")))
y_function_E_rectale_Omeprazole_func <- eval(parse(text = paste("function(Drug) {", y_function_E_rectale_Omeprazole, "}")))
y_function_R_intestinalis_Omeprazole_func <- eval(parse(text = paste("function(Drug) {", y_function_R_intestinalis_Omeprazole, "}")))
y_function_E_lenta_Omeprazole_func <- eval(parse(text = paste("function(Drug) {", y_function_E_lenta_Omeprazole, "}")))
y_function_F_nucleatum_Omeprazole_func <- eval(parse(text = paste("function(Drug) {", y_function_F_nucleatum_Omeprazole, "}")))
y_function_C_bolteae_Omeprazole_func <- eval(parse(text = paste("function(Drug) {", y_function_C_bolteae_Omeprazole, "}")))
y_function_C_perfringens_Omeprazole_func <- eval(parse(text = paste("function(Drug) {", y_function_C_perfringens_Omeprazole, "}")))
y_function_C_saccharolyticum_Omeprazole_func <- eval(parse(text = paste("function(Drug) {", y_function_C_saccharolyticum_Omeprazole, "}")))
y_function_S_salivarius_Omeprazole_func <- eval(parse(text = paste("function(Drug) {", y_function_S_salivarius_Omeprazole, "}")))
y_function_R_gnavus_Omeprazole_func <- eval(parse(text = paste("function(Drug) {", y_function_R_gnavus_Omeprazole, "}")))
y_function_C_comes_Omeprazole_func <- eval(parse(text = paste("function(Drug) {", y_function_C_comes_Omeprazole, "}")))
y_function_P_merdae_Omeprazole_func <- eval(parse(text = paste("function(Drug) {", y_function_P_merdae_Omeprazole, "}")))
y_function_S_parasanguinis_Omeprazole_func <- eval(parse(text = paste("function(Drug) {", y_function_S_parasanguinis_Omeprazole, "}")))
y_function_C_aerofaciens_Omeprazole_func <- eval(parse(text = paste("function(Drug) {", y_function_C_aerofaciens_Omeprazole, "}")))
y_function_D_formicigenerans_Omeprazole_func <- eval(parse(text = paste("function(Drug) {", y_function_D_formicigenerans_Omeprazole, "}")))
y_function_E_coli_Omeprazole_func <- eval(parse(text = paste("function(Drug) {", y_function_E_coli_Omeprazole, "}")))
y_function_V_parvula_Omeprazole_func <- eval(parse(text = paste("function(Drug) {", y_function_V_parvula_Omeprazole, "}")))



unique(combined_monoculture_aucs2_Omeprazole$conc)
##dictate drug concentration tested for simulation cycle here:
#drug_concentration_tested <- 5 #if manually or:
drug_concentration_tested <- unique(combined_monoculture_aucs2_Omeprazole$conc)[1]
initial_conditions <- rep(0.01/32, 32)
initial_conditions <- c(initial_conditions, drug_concentration_tested)


##drug effect fitted for species showing sensitivity in monoculture:
#unique(combined_monoculture_aucs2_Omeprazole$Species)

##for more simple linear fits
closed.sir.model_Omeprazole <- function (t, x, params) {
  ## first extract the state variables
  A_muciniphila <- x[1]
  B_adolescentis <- x[2]
  B_fragilis <- x[3]
  B_longum <- x[4]
  B_obeum <- x[5]
  B_thetaiotaomicron <- x[6]
  B_uniformis <- x[7]
  B_vulgatus <- x[8]
  B_wadsworthia <- x[9]
  C_aerofaciens <- x[10]
  C_bolteae <- x[11]
  C_comes <- x[12]
  C_perfringens <- x[13]
  C_ramosum <- x[14]
  C_saccharolyticum <- x[15]
  D_formicigenerans <- x[16]
  E_coli <- x[17]
  E_lenta <- x[18]
  E_rectale <- x[19]
  F_nucleatum <- x[20]
  L_paracasei <- x[21]
  O_splanchnicus <- x[22]
  P_copri <- x[23]
  P_distasonis <- x[24]
  P_merdae <- x[25]
  R_bromii <- x[26]
  R_gnavus <- x[27]
  R_intestinalis <- x[28]
  R_torques <- x[29]
  S_parasanguinis <- x[30]
  S_salivarius <- x[31]
  V_parvula <- x[32]
  Drug <- x[33]
  
  
  ## now extract the parameters
  r_B_fragilis <- flat_params[["B._fragilis.r"]]
  K_B_fragilis <- flat_params[["B._fragilis.K"]]
  r_B_longum <- flat_params[["B._longum.r"]]
  K_B_longum <- flat_params[["B._longum.K"]]
  r_B_thetaiotaomicron <- flat_params[["B._thetaiotaomicron.r"]]
  K_B_thetaiotaomicron <- flat_params[["B._thetaiotaomicron.K"]]
  r_B_uniformis <- flat_params[["B._uniformis.r"]]
  K_B_uniformis <- flat_params[["B._uniformis.K"]]
  r_B_vulgatus <- flat_params[["B._vulgatus.r"]]
  K_B_vulgatus <- flat_params[["B._vulgatus.K"]]
  r_B_wadsworthia <- flat_params[["B._wadsworthia.r"]]
  K_B_wadsworthia <- flat_params[["B._wadsworthia.K"]]
  r_C_aerofaciens <- flat_params[["C._aerofaciens.r"]]
  K_C_aerofaciens <- flat_params[["C._aerofaciens.K"]]
  r_C_bolteae <- flat_params[["C._bolteae.r"]]
  K_C_bolteae <- flat_params[["C._bolteae.K"]]
  r_C_comes <- flat_params[["C._comes.r"]]
  K_C_comes <- flat_params[["C._comes.K"]]
  r_C_perfringens <- flat_params[["C._perfringens.r"]]
  K_C_perfringens <- flat_params[["C._perfringens.K"]]
  r_C_ramosum <- flat_params[["C._ramosum.r"]]
  K_C_ramosum <- flat_params[["C._ramosum.K"]]
  r_C_saccharolyticum <- flat_params[["C._saccharolyticum.r"]]
  K_C_saccharolyticum <- flat_params[["C._saccharolyticum.K"]]
  r_D_formicigenerans <- flat_params[["D._formicigenerans.r"]]
  K_D_formicigenerans <- flat_params[["D._formicigenerans.K"]]
  r_E_coli <- flat_params[["E._coli.r"]]
  K_E_coli <- flat_params[["E._coli.K"]]
  r_E_lenta <- flat_params[["E._lenta.r"]]
  K_E_lenta <- flat_params[["E._lenta.K"]]
  r_E_rectale <- flat_params[["E._rectale.r"]]
  K_E_rectale <- flat_params[["E._rectale.K"]]
  r_F_nucleatum <- flat_params[["F._nucleatum.r"]]
  K_F_nucleatum <- flat_params[["F._nucleatum.K"]]
  r_P_copri <- flat_params[["P._copri.r"]]
  K_P_copri <- flat_params[["P._copri.K"]]
  r_P_merdae <- flat_params[["P._merdae.r"]]
  K_P_merdae <- flat_params[["P._merdae.K"]]
  r_R_gnavus <- flat_params[["R._gnavus.r"]]
  K_R_gnavus <- flat_params[["R._gnavus.K"]]
  r_R_intestinalis <- flat_params[["R._intestinalis.r"]]
  K_R_intestinalis <- flat_params[["R._intestinalis.K"]]
  r_V_parvula <- flat_params[["V._parvula.r"]]
  K_V_parvula <- flat_params[["V._parvula.K"]]
  r_A_muciniphila <- flat_params[["A._muciniphila.r"]]
  K_A_muciniphila <- flat_params[["A._muciniphila.K"]]
  r_B_adolescentis <- flat_params[["B._adolescentis.r"]]
  K_B_adolescentis <- flat_params[["B._adolescentis.K"]]
  r_B_obeum <- flat_params[["B._obeum.r"]]
  K_B_obeum <- flat_params[["B._obeum.K"]]
  r_O_splanchnicus <- flat_params[["O._splanchnicus.r"]]
  K_O_splanchnicus <- flat_params[["O._splanchnicus.K"]]
  r_P_distasonis <- flat_params[["P._distasonis.r"]]
  K_P_distasonis <- flat_params[["P._distasonis.K"]]
  r_R_bromii <- flat_params[["R._bromii.r"]]
  K_R_bromii <- flat_params[["R._bromii.K"]]
  r_R_torques <- flat_params[["R._torques.r"]]
  K_R_torques <- flat_params[["R._torques.K"]]
  r_S_parasanguinis <- flat_params[["S._parasanguinis.r"]]
  K_S_parasanguinis <-flat_params[["S._parasanguinis.K"]]
  r_S_salivarius <- flat_params[["S._salivarius.r"]]
  K_S_salivarius <- flat_params[["S._salivarius.K"]]
  r_L_paracasei <- flat_params[["L._paracasei.r"]]
  K_L_paracasei <- flat_params[["L._paracasei.K"]]
  
  
  t_mod <- ifelse(t > 24.1, t - 24.1, t)
  
  
  ## now code the model equations
  dA_muciniphila_dt <- r_A_muciniphila * A_muciniphila * (1 - A_muciniphila / K_A_muciniphila)
  dB_adolescentis_dt <- r_B_adolescentis * B_adolescentis * (1 - B_adolescentis / K_B_adolescentis)
  dB_fragilis_dt <- r_B_fragilis * B_fragilis * (1 - B_fragilis / max(0.0001, K_B_fragilis * (y_function_B_fragilis_Omeprazole_func(Drug))))
  dB_longum_dt <- r_B_longum * B_longum * (1 - B_longum / K_B_longum)
  dB_obeum_dt <- r_B_obeum * B_obeum * (1 - B_obeum / K_B_obeum)
  dB_thetaiotaomicron_dt <- r_B_thetaiotaomicron * B_thetaiotaomicron * (1 - B_thetaiotaomicron / max(0.0001, K_B_thetaiotaomicron * (y_function_B_thetaiotaomicron_Omeprazole_func(Drug))))  
  dB_uniformis_dt <- r_B_uniformis * B_uniformis * (1 - B_uniformis / max(0.0001, K_B_uniformis * (y_function_B_uniformis_Omeprazole_func(Drug))))
  dB_vulgatus_dt <- r_B_vulgatus * B_vulgatus * (1 - B_vulgatus / max(0.0001, K_B_vulgatus * (y_function_B_vulgatus_Omeprazole_func(Drug))))
  dB_wadsworthia_dt <- r_B_wadsworthia * B_wadsworthia * (1 - B_wadsworthia / K_B_wadsworthia)
  dC_aerofaciens_dt <- r_C_aerofaciens * C_aerofaciens * (1 - C_aerofaciens / max(0.0001, K_C_aerofaciens * (y_function_C_aerofaciens_Omeprazole_func(Drug))))
  dC_bolteae_dt <- r_C_bolteae * C_bolteae * (1 - C_bolteae /  max(0.0001, K_C_bolteae * (y_function_C_bolteae_Omeprazole_func(Drug))))
  dC_comes_dt <- r_C_comes * C_comes * (1 - C_comes / max(0.0001, K_C_comes * (y_function_C_comes_Omeprazole_func(Drug))))
  dC_perfringens_dt <- r_C_perfringens * C_perfringens * (1 - C_perfringens / max(0.0001, K_C_perfringens * (y_function_C_perfringens_Omeprazole_func(Drug))))
  dC_ramosum_dt <- r_C_ramosum * C_ramosum * (1 - C_ramosum / max(0.0001, K_C_ramosum * (y_function_C_ramosum_Omeprazole_func(Drug))))
  dC_saccharolyticum_dt <- r_C_saccharolyticum * C_saccharolyticum * (1 - C_saccharolyticum / max(0.0001, K_C_saccharolyticum * (y_function_C_saccharolyticum_Omeprazole_func(Drug))))
  dD_formicigenerans_dt <- r_D_formicigenerans * D_formicigenerans * (1 - D_formicigenerans / max(0.0001, K_D_formicigenerans * (y_function_D_formicigenerans_Omeprazole_func(Drug))))
  dE_coli_dt <- r_E_coli * E_coli * (1 - E_coli / max(0.0001, K_E_coli * (y_function_E_coli_Omeprazole_func(Drug))))
  dE_lenta_dt <- r_E_lenta * E_lenta * (1 - E_lenta / max(0.0001, K_E_lenta * (y_function_E_lenta_Omeprazole_func(Drug))))
  dE_rectale_dt <- r_E_rectale * E_rectale * (1 - E_rectale / max(0.0001, K_E_rectale * (y_function_E_rectale_Omeprazole_func(Drug))))
  dF_nucleatum_dt <- r_F_nucleatum * F_nucleatum * (1 - F_nucleatum / max(0.0001, K_F_nucleatum * (y_function_F_nucleatum_Omeprazole_func(Drug))))
  dL_paracasei_dt <- r_L_paracasei * L_paracasei * (1 - L_paracasei / K_L_paracasei)  
  dO_splanchnicus_dt <- r_O_splanchnicus * O_splanchnicus * (1 - O_splanchnicus / K_O_splanchnicus)  
  dP_copri_dt <- r_P_copri * P_copri * (1 - P_copri / K_P_copri)
  dP_distasonis_dt <- r_P_distasonis * P_distasonis * (1 - P_distasonis / K_P_distasonis)  
  dP_merdae_dt <- r_P_merdae * P_merdae * (1 - P_merdae / max(0.0001, K_P_merdae * (y_function_P_merdae_Omeprazole_func(Drug))))
  dR_bromii_dt <- r_R_bromii * R_bromii * (1 - R_bromii / K_R_bromii) 
  dR_gnavus_dt <- r_R_gnavus * R_gnavus * (1 - R_gnavus / max(0.0001, K_R_gnavus * (y_function_R_gnavus_Omeprazole_func(Drug))))
  dR_intestinalis_dt <- r_R_intestinalis * R_intestinalis * (1 - R_intestinalis / max(0.0001, K_R_intestinalis * (y_function_R_intestinalis_Omeprazole_func(Drug))))
  dR_torques_dt <- r_R_torques * R_torques * (1 - R_torques /K_R_torques) 
  dS_parasanguinis_dt <- r_S_parasanguinis * S_parasanguinis * (1 - S_parasanguinis / max(0.0001, K_S_parasanguinis * (y_function_S_parasanguinis_Omeprazole_func(Drug))))
  dS_salivarius_dt <- r_S_salivarius * S_salivarius * (1 - S_salivarius / max(0.0001, K_S_salivarius * (y_function_S_salivarius_Omeprazole_func(Drug))))
  dV_parvula_dt <- r_V_parvula * V_parvula * (1 - V_parvula / max(0.0001, K_V_parvula * (y_function_V_parvula_Omeprazole_func(Drug))))
  
  
  
  #Drug differential:
  dDrug_dt <- (subset(drug_dynamics, Drug == "Omeprazole")$Steepness_param_community * exp(-subset(drug_dynamics, Drug == "Omeprazole")$Steepness_param_community * t_mod)) * (drug_concentration_tested * prop_left_Omeprazole - drug_concentration_tested)
  #dDrug_dt <- 0
  
  ## Combine results into a single vector
  dxdt <- c(dA_muciniphila_dt, dB_adolescentis_dt, dB_fragilis_dt, dB_longum_dt, dB_obeum_dt, dB_thetaiotaomicron_dt, dB_uniformis_dt, dB_vulgatus_dt, dB_wadsworthia_dt, dC_aerofaciens_dt, dC_bolteae_dt, dC_comes_dt, dC_perfringens_dt, dC_ramosum_dt, dC_saccharolyticum_dt, dD_formicigenerans_dt, dE_coli_dt, dE_lenta_dt, dE_rectale_dt, dF_nucleatum_dt, dL_paracasei_dt, dO_splanchnicus_dt, dP_copri_dt, dP_distasonis_dt, dP_merdae_dt, dR_bromii_dt, dR_gnavus_dt, dR_intestinalis_dt, dR_torques_dt, dS_parasanguinis_dt, dS_salivarius_dt, dV_parvula_dt, dDrug_dt)
  
  ## Return result as a list
  list(dxdt)
}




#calculate the co-culture correction factor per species based on community composition in absence of drug, just like done for Niclosamide

growth_data_all_0_Niclosamide
growth_data_all_0_Niclosamide1 <- growth_data_all_0_Niclosamide %>%
  dplyr::mutate(Species = gsub(" ", "_", Species))


# Merge rel_ab_control with growth_data_all_0_Niclosamide on Species
# Function to remove duplicated columns by name pattern
clean_columns_base <- function(df, pattern) {
  cols_to_keep <- !grepl(pattern, names(df))
  df <- df[, cols_to_keep]
  return(df)
}

# Use the new function to clean up your dataframe
rel_ab_control <- clean_columns_base(rel_ab_control, "mean_max_OD.[xy]")
str(rel_ab_control)


#rel_ab_control$correction_factor <- rel_ab_control$mean_rel_ab / (rel_ab_control$mean_max_OD/sum(rel_ab_control$mean_max_OD))
# Calculate correction factor with a minimum value of ~1
rel_ab_control$correction_factor <- pmax(rel_ab_control$mean_rel_ab / (rel_ab_control$mean_max_OD / sum(rel_ab_control$mean_max_OD)), 1.1)


# Create a new dataframe for co-culture correction
co_culture_correction <- data.frame(
  species = rel_ab_control$Species,
  correction_factor = rel_ab_control$correction_factor
)


#summarise community data
#Adjust based on tested concentrations for each drug
unique(Community_compositions_focus_drugs_Omeprazole$concentration)

Community_compositions_focus_drugs_Omeprazole_5uM <- subset(Community_compositions_focus_drugs_Omeprazole, concentration == 5)
Community_compositions_focus_drugs_Omeprazole_20uM <- subset(Community_compositions_focus_drugs_Omeprazole, concentration == 20)
Community_compositions_focus_drugs_Omeprazole_80uM <- subset(Community_compositions_focus_drugs_Omeprazole, concentration == 80)


#5 uM
Community_compositions_focus_drugs_Omeprazole_5uM_summarised <- Community_compositions_focus_drugs_Omeprazole_5uM %>%
  dplyr::group_by(species) %>%                                  
  dplyr::summarize(
    mean_rel_ab = mean(rel_abundance, na.rm = TRUE),     
    sd_rel_ab = sd(rel_abundance, na.rm = TRUE) ,
    mean_max_OD = mean(maxOD, na.rm = TRUE),
    sd_max_OD = sd(maxOD, na.rm = TRUE),
    mean_final_OD = mean(finalOD, na.rm = TRUE),
    sd_final_OD = sd(finalOD, na.rm = TRUE)
  ) %>%
  dplyr::ungroup() 


Community_compositions_focus_drugs_Omeprazole_5uM_summarised <- Community_compositions_focus_drugs_Omeprazole_5uM_summarised %>%
  dplyr::mutate(Species = sub("^(\\w)\\w*\\s(.*)", "\\1._\\2", species))

#remove (sub)strain info
Community_compositions_focus_drugs_Omeprazole_5uM_summarised <- Community_compositions_focus_drugs_Omeprazole_5uM_summarised %>%
  dplyr::mutate(Species = sub("^(\\w\\._\\w+).*", "\\1", Species))


#20 uM
Community_compositions_focus_drugs_Omeprazole_20uM_summarised <- Community_compositions_focus_drugs_Omeprazole_20uM %>%
  dplyr::group_by(species) %>%                                  
  dplyr::summarize(
    mean_rel_ab = mean(rel_abundance, na.rm = TRUE),     
    sd_rel_ab = sd(rel_abundance, na.rm = TRUE) ,
    mean_max_OD = mean(maxOD, na.rm = TRUE),
    sd_max_OD = sd(maxOD, na.rm = TRUE),
    mean_final_OD = mean(finalOD, na.rm = TRUE),
    sd_final_OD = sd(finalOD, na.rm = TRUE)
  ) %>%
  dplyr::ungroup() 


Community_compositions_focus_drugs_Omeprazole_20uM_summarised <- Community_compositions_focus_drugs_Omeprazole_20uM_summarised %>%
  dplyr::mutate(Species = sub("^(\\w)\\w*\\s(.*)", "\\1._\\2", species))

#remove (sub)strain info
Community_compositions_focus_drugs_Omeprazole_20uM_summarised <- Community_compositions_focus_drugs_Omeprazole_20uM_summarised %>%
  dplyr::mutate(Species = sub("^(\\w\\._\\w+).*", "\\1", Species))


#80 uM
Community_compositions_focus_drugs_Omeprazole_80uM_summarised <- Community_compositions_focus_drugs_Omeprazole_80uM %>%
  dplyr::group_by(species) %>%                                  
  dplyr::summarize(
    mean_rel_ab = mean(rel_abundance, na.rm = TRUE),     
    sd_rel_ab = sd(rel_abundance, na.rm = TRUE) ,
    mean_max_OD = mean(maxOD, na.rm = TRUE),
    sd_max_OD = sd(maxOD, na.rm = TRUE),    
    mean_final_OD = mean(finalOD, na.rm = TRUE),
    sd_final_OD = sd(finalOD, na.rm = TRUE)
  ) %>%
  dplyr::ungroup() 



Community_compositions_focus_drugs_Omeprazole_80uM_summarised <- Community_compositions_focus_drugs_Omeprazole_80uM_summarised %>%
  dplyr::mutate(Species = sub("^(\\w)\\w*\\s(.*)", "\\1._\\2", species))

#remove (sub)strain info
Community_compositions_focus_drugs_Omeprazole_80uM_summarised <- Community_compositions_focus_drugs_Omeprazole_80uM_summarised %>%
  dplyr::mutate(Species = sub("^(\\w\\._\\w+).*", "\\1", Species))


#Initialise data frames
sim_output <- data.frame()
input_params_list <- list() #Use a list to collect parameters for each simulation

#number of simulations
num_sims <- 250


for (i in 1:num_sims) {
  tryCatch({
    # generate model parameters
    set.seed(i) #set a different seed for each simulation for variation
    params <- lapply(1:nrow(growth_data_all_0_Niclosamide), function(idx) {
      species_params <- growth_data_all_0_Niclosamide[idx, ]
      list(
        r = rnorm(1, mean = species_params$mean_max_Growth_rate, sd = species_params$sd_max_Growth_rate),
        K = rnorm(1, mean = species_params$mean_max_OD, sd = species_params$sd_max_OD)
      )
    })
    names(params) <- gsub(" ", "_", growth_data_all_0_Niclosamide$Species)
    flat_params <- unlist(params)
    names(flat_params) <- gsub("\\.\\d$", "", names(flat_params))
    
    #replace spaces with underscores to match formatting
    co_culture_correction$species <- gsub(" ", "_", co_culture_correction$species, fixed = TRUE)
    
    #replace the species-specific K parameters extracted from monoculture growth data 
    #with drawn relative abundance values at Niclosamide = 0, scaled to K
    rel_ab_control$Species <- gsub(" ", "_", rel_ab_control$Species)
    
    #Initialise an empty vector to store drawn values
    drawn_values <- numeric(nrow(rel_ab_control))
    
    #draw values from their respective distributions
    for (k in 1:nrow(rel_ab_control)) {
      species_name <- rel_ab_control$Species[k]
      drawn_value <- rnorm(1, mean = rel_ab_control$mean_rel_ab[k], sd = rel_ab_control$sd_rel_ab[k])
      drawn_values[k] <- max(drawn_value, 0)  # Ensure no negative values
    }
    
    #Normalise drawn relative abundance values so they sum to 1 (to reflect a 'true' relative abundance distribution)
    #this is needed so when we convert the values into OD units by multiplying with the drawn community maxOD,
    # the sum of K_i parameters and the drawn K are equal
    normalised_values <- drawn_values / sum(drawn_values)
    
    #Pull community maxOD (K) at 0 drugs from respective normal distribution:
    K <- rnorm(n = 1, mean = rel_ab_control$mean_com_max_OD[1], sd = rel_ab_control$sd_com_max_OD[1])
    
    # Assign these normalised values to their respective species' .K parameters
    for (k in 1:nrow(rel_ab_control)) {
      species_name <- rel_ab_control$Species[k]
      k_index <- grep(paste0("^", species_name, "\\.K$"), names(flat_params))
      
      if (length(k_index) > 0) {
        old_value <- flat_params[k_index]
        flat_params[k_index] <- (normalised_values[k] + 0.0001) * K #add small value in case drawn K_i is 0, which would cause issues with the solver
        cat(sprintf("Updated %s from %f to %f using normalised value %f scaled by K %f\n", names(flat_params)[k_index], old_value, flat_params[k_index], normalised_values[k], K))
      }
    }
    
    #Accounting for variation in drug degradation by community, with standard deviation of end concentration (at 10h) around the fitted predicted (relative) end concentration at 24h
    #prop_left_Omeprazole <- abs(rnorm(1, (subset(drug_dynamics, Drug == "Omeprazole")$Prop_left_24h_community), (subset(drug_dynamics, Drug == "Omeprazole")$SD_drug_community))) 
    #below, we account for measurement error rather than ecological drivers that lead to the variability of degradation at the final point measured 
    prop_left_Omeprazole <- abs(rnorm(
      n = 1, 
      mean = subset(drug_dynamics, Drug == "Omeprazole")$Prop_left_24h_community, 
      sd = ifelse(
        subset(drug_dynamics, Drug == "Omeprazole")$SD_drug_community > subset(drug_dynamics, Drug == "Omeprazole")$SD_drug_community_start, 
        subset(drug_dynamics, Drug == "Omeprazole")$SD_drug_community - subset(drug_dynamics, Drug == "Omeprazole")$SD_drug_community_start, 
        subset(drug_dynamics, Drug == "Omeprazole")$SD_drug_community
      )
    ))
    
    
    #loop through each species in co_culture_correction
    for (j in 1:nrow(co_culture_correction)) {
      # Extract the species name and correction factor
      species_name <- co_culture_correction$species[j]
      correction_factor <- co_culture_correction$correction_factor[j]
      
      # Identify the corresponding growth rate parameter in flat_params
      #by matching the base species name (without .r)
      growth_rate_indices <- grep(paste0("^", species_name, "\\.r$"), names(flat_params))
      
      #take the growth rate parameter and apply the correction factor 
      for (index in growth_rate_indices) {
        flat_params[index] <- flat_params[index] * correction_factor
      }
    }
    
    flat_params
    # Store parameters for each simulation
    input_params_list[[i]] <- c(sim_ID = i, flat_params)
    
    # Run the model for the first 24-hour cycle
    solution_cycle_1 <- ode(y = initial_conditions, times = seq(from = 0, to = 24, by = 0.1), func = closed.sir.model_Omeprazole, parms = flat_params,   method = "lsoda", rtol = 1e-6, atol = 1e-6)
    
    # Dilution and second cycle
    end_of_cycle_1 <- solution_cycle_1[nrow(solution_cycle_1), -1]
    initial_conditions_cycle_2 <- end_of_cycle_1 / 50
    #accounting for the drugs being added with the new growth cycle as well:
    initial_conditions_cycle_2[33] <- initial_conditions_cycle_2[33] + drug_concentration_tested
    solution_cycle_2 <- ode(y = initial_conditions_cycle_2, times = seq(from = 24, to = 48, by = 0.1), func = closed.sir.model_Omeprazole, parms = flat_params,  method = "lsoda", rtol = 1e-6, atol = 1e-6)
    
    # Combine and format results
    combined_solution <- rbind(as.data.frame(solution_cycle_1), as.data.frame(solution_cycle_2)[-1,])
    combined_solution$sim_ID <- rep(i, nrow(combined_solution))
    combined_solution <- combined_solution %>%
      tidyr::gather(key = "Species", value = "Density", -time, -sim_ID) %>%
      dplyr::mutate(Hour = time) %>%
      dplyr::select(sim_ID, Hour, Species, Density)
    
    ##Append to sim_output
    sim_output <- rbind(sim_output, combined_solution)
  }, error = function(e) {
    cat(sprintf("Skipping simulation %d due to an error: %s\n", i, e$message))
  })
}



##Combine all parameter data into a single dataframe
input_params <- do.call(rbind, input_params_list)

# Add a "Species" column 
sim_output$Species_name <- species_names[as.numeric(as.character(sim_output$Species))]
sim_output$Species_name <- replace_na(sim_output$Species_name, "Drug")

#View(input_params)
#View(sim_output)

sim_output <- na.omit(sim_output)
successful_sim_ids <- unique(subset(sim_output, Hour == 48)$sim_ID)
length(successful_sim_ids)
sim_output1 <- sim_output[sim_output$sim_ID %in% successful_sim_ids, ]


#Transform sim_output so we have wide format by Species
sim_output_wide <- tidyr::pivot_wider(sim_output1, 
                                      names_from = Species_name, 
                                      values_from = Density,
                                      id_cols = c(sim_ID, Hour))

length(unique(sim_output_wide$sim_ID))
#calc community OD per timepoint
sim_output_wide$Total_OD <- rowSums(sim_output_wide[, 3:34], na.rm = TRUE)
#calculate and add relative abundances here as well:
species_columns <- colnames(sim_output_wide)[3:34] 

for (species in species_columns) {
  sim_output_wide[[paste0("rel_", species)]] <- sim_output_wide[[species]] / sim_output_wide$Total_OD
}


#assign sim_output_wide test conditions to dataframe name
drug_tested <- "Omeprazole"
variable_name_1 <- paste0("sim_output_wide_", ifelse(drug_concentration_tested == 1e-04, 0, drug_concentration_tested), "_", drug_tested)
assign(variable_name_1, sim_output_wide)

#turn back into long format if interested in plotting relative abundances
cols_needed <- c("sim_ID", "Hour")

sim_output_long <- sim_output_wide %>% 
  dplyr::select(sim_ID, Hour, Drug, starts_with("rel_")) %>% 
  tidyr::pivot_longer(
    cols = c(Drug, starts_with("rel_")),
    names_to = "Species", 
    values_to = "Relative_abundance",
    names_prefix = "rel_",
    names_transform = list(Species = ~ ifelse(.x == "Drug", "Drug", .x))
  ) 

str(sim_output_long)


species_names_1 <- c(
  "A_muciniphila",
  "B_adolescentis",
  "B_fragilis",
  "B_longum",
  "B_obeum",
  "B_thetaiotaomicron",
  "B_uniformis",
  "B_vulgatus",
  "B_wadsworthia",
  "C_aerofaciens",
  "C_bolteae",
  "C_comes",
  "C_perfringens",
  "C_ramosum",
  "C_saccharolyticum",
  "D_formicigenerans",
  "E_coli",
  "E_lenta",
  "E_rectale",
  "F_nucleatum",
  "L_paracasei",
  "O_splanchnicus",
  "P_copri",
  "P_distasonis",
  "P_merdae",
  "R_bromii",
  "R_gnavus",
  "R_intestinalis",
  "R_torques",
  "S_parasanguinis",
  "S_salivarius",
  "V_parvula",
  "Drug"
)

species_colours_1 <- c(
  "A_muciniphila" = "#1f77b4",
  "B_adolescentis" = "#ff7f0e",
  "B_fragilis" = "#2ca02c",
  "B_longum" = "#d62728",
  "B_obeum" = "#9467bd",
  "B_thetaiotaomicron" = "black",
  "B_uniformis" = "#e377c2",
  "B_vulgatus" = "#7f7f7f",
  "B_wadsworthia" = "gold1",
  "C_aerofaciens" = "#aec7e8",
  "C_bolteae" = "#ffbb78",
  "C_comes" = "magenta",
  "C_perfringens" = "#ff9896",
  "C_ramosum" = "#c5b0d5",
  "C_saccharolyticum" = "#c49c94",
  "D_formicigenerans" = "#f7b6d2",
  "E_coli" = "yellow",
  "E_lenta" = "turquoise",
  "E_rectale" = "#393b79",
  "F_nucleatum" = "royalblue2",
  "L_paracasei" = "blue",
  "O_splanchnicus" = "#637939",
  "P_copri" = "cyan",
  "P_distasonis" = "#8c6d31",
  "P_merdae" = "#c7c7c7",
  "R_bromii" = "#e6550d",
  "R_gnavus" = "#e7cb94",
  "R_intestinalis" = "#843c39",
  "R_torques" = "#d6616b",
  "S_parasanguinis" = "orange3",
  "S_salivarius" = "#7b4173",
  "V_parvula" = "#ce6dbd",
  "Drug" = "green"
)



##Plot output for any specific sim:
# ggplot(subset(sim_output, sim_ID == 1 & Species_name != "Drug"), aes(x = Hour, y = Density, group = Species_name, color = Species_name)) +
#   geom_line(size = 1, alpha = 0.7) +
#   scale_color_manual(values = species_colours_1) +
#   labs(title = paste0("Omeprazole = ", drug_concentration_tested),
#        x = "Time (hours)",
#        y = "Population Density (OD)",
#        color = "Species") +
#   theme_minimal() +
#   theme(legend.position = "right")
# 
# ggplot(subset(sim_output, sim_ID == 3 & Species_name != "Drug"), aes(x = Hour, y = Density, group = Species_name, color = Species_name)) +
#   geom_line(size = 1, alpha = 0.7) +
#   scale_color_manual(values = species_colours_1) +
#   labs(title = paste0("Omeprazole = ", drug_concentration_tested),
#        x = "Time (hours)",
#        y = "Population Density (OD)",
#        color = "Species") +
#   theme_minimal() +
#   theme(legend.position = "right")


ggplot(subset(sim_output_long, sim_ID == 1), aes(x = Hour, y = Relative_abundance, group = Species, color = Species)) +
  geom_line(size = 1, alpha = 0.7) +
  scale_color_manual(values = species_colours_1) +
  labs(title = paste0("Omeprazole = ", drug_concentration_tested),
       x = "Time (hours)",
       y = "Relative abundance",
       color = "Species") +
  theme_minimal() +
  theme(legend.position = "right")


ggplot(subset(sim_output_long, sim_ID == 3), aes(x = Hour, y = Relative_abundance, group = Species, color = Species)) +
  geom_line(size = 1, alpha = 0.7) +
  scale_color_manual(values = species_colours_1) +
  labs(title = paste0("Omeprazole = ", drug_concentration_tested),
       x = "Time (hours)",
       y = "Relative abundance",
       color = "Species") +
  theme_minimal() +
  theme(legend.position = "right")


#calc mean and standard deviation across sims
sim_stats <- sim_output_long %>%
  dplyr::group_by(Hour, Species) %>%
  dplyr::summarise(
    mean_rel_ab = mean(Relative_abundance),
    sd_rel_ab = sd(Relative_abundance),
    .groups = 'drop'
  )

# Prepare the data for plotting
plot_data <- sim_stats %>%
  dplyr::mutate(Upper = mean_rel_ab + sd_rel_ab, Lower = mean_rel_ab - sd_rel_ab)

ggplot(subset(plot_data, Species != "Drug"), aes(x = Hour, y = mean_rel_ab, group = Species, color = Species)) +
  geom_ribbon(aes(ymin = Lower, ymax = Upper, fill = Species), colour = NA, alpha = 0.2) +  
  geom_line(size = 1, alpha = 0.7) + 
  scale_color_manual(values = species_colours_1) +
  scale_fill_manual(values = species_colours_1) +  
  labs(title = "Mean and SD of Relative Abundance Across Simulations",
       subtitle = paste0("Omeprazole = ", drug_concentration_tested),       
       x = "Time (hours)",
       y = "Relative abundance",
       color = "Species",
       fill = "Species") +
  theme_minimal() +
  theme(legend.position = "right")

#log-scaled mean trends
ggplot(plot_data, aes(x = Hour, y = log10(mean_rel_ab + 0.0001), group = Species, color = Species)) +
  geom_line(size = 1, alpha = 0.7) +  # Mean line
  scale_color_manual(values = species_colours_1) +
  scale_fill_manual(values = species_colours_1) +  # Ensure consistent colors for lines and fills
  labs(title = "Mean and SD of Relative Abundance Across Simulations",
       subtitle = paste0("Omeprazole = ", drug_concentration_tested),
       x = "Time (hours)",
       y = "Relative abundance",
       color = "Species",
       fill = "Species") +
  theme_minimal() +
  theme(legend.position = "right")




##prediction quality evaluation
drug_tested <- "Omeprazole"
variable_name <- paste0("plot_data_", ifelse(drug_concentration_tested == 1e-04, 0, drug_concentration_tested), "_", drug_tested)
assign(variable_name, plot_data)


#extract total OD info:
predicted_mean_final_od_NULL <- Niclosamide_16S_0uM_summarised$mean_com_final_OD[1]
predicted_sd_final_od_NULL <- Niclosamide_16S_0uM_summarised$sd_com_final_OD[1]

predicted_mean_final_od_5_Omeprazole <- mean(subset(sim_output_wide_5_Omeprazole, Hour == 48)$Total_OD, na.rm = TRUE)
predicted_sd_final_od_5_Omeprazole <- sd(subset(sim_output_wide_5_Omeprazole, Hour == 48)$Total_OD, na.rm = TRUE)

real_mean_final_od_5_Omeprazole <- Community_compositions_focus_drugs_Omeprazole_5uM_summarised$mean_final_OD[1]
real_sd_final_od_5_Omeprazole <- Community_compositions_focus_drugs_Omeprazole_5uM_summarised$sd_final_OD[1]


predicted_mean_final_od_20_Omeprazole <- mean(subset(sim_output_wide_20_Omeprazole, Hour == 48)$Total_OD, na.rm = TRUE)
predicted_sd_final_od_20_Omeprazole <- sd(subset(sim_output_wide_20_Omeprazole, Hour == 48)$Total_OD, na.rm = TRUE)

real_mean_final_od_20_Omeprazole <- Community_compositions_focus_drugs_Omeprazole_20uM_summarised$mean_final_OD[1]
real_sd_final_od_20_Omeprazole <- Community_compositions_focus_drugs_Omeprazole_20uM_summarised$sd_final_OD[1]


predicted_mean_final_od_80_Omeprazole <- mean(subset(sim_output_wide_80_Omeprazole, Hour == 48)$Total_OD, na.rm = TRUE)
predicted_sd_final_od_80_Omeprazole <- sd(subset(sim_output_wide_80_Omeprazole, Hour == 48)$Total_OD, na.rm = TRUE)

real_mean_final_od_80_Omeprazole <- Community_compositions_focus_drugs_Omeprazole_80uM_summarised$mean_final_OD[1]
real_sd_final_od_80_Omeprazole <- Community_compositions_focus_drugs_Omeprazole_80uM_summarised$sd_final_OD[1]




#plot_data_0_Omeprazole_endpoint was used to test model performance at 0 drugs
#plot_data_0_Omeprazole_endpoint <- subset(plot_data_0_Omeprazole, Hour == 48 & Species != "Drug")
plot_data_5_Omeprazole_endpoint <- subset(plot_data_5_Omeprazole, Hour == 48 & Species != "Drug")
plot_data_20_Omeprazole_endpoint <- subset(plot_data_20_Omeprazole, Hour == 48 & Species != "Drug")
plot_data_80_Omeprazole_endpoint <- subset(plot_data_80_Omeprazole, Hour == 48 & Species != "Drug")

##Inspecting 'match' to real relative abundance distributions:
Niclosamide_16S_0uM_summarised <- rel_ab_control
Niclosamide_16S_0uM_summarised$Species <- gsub("\\.", "", Niclosamide_16S_0uM_summarised$Species)

Omeprazole_16S_5uM_summarised <- Community_compositions_focus_drugs_Omeprazole_5uM_summarised
Omeprazole_16S_20uM_summarised <- Community_compositions_focus_drugs_Omeprazole_20uM_summarised
Omeprazole_16S_80uM_summarised <- Community_compositions_focus_drugs_Omeprazole_80uM_summarised

Niclosamide_16S_0uM_summarised
Omeprazole_16S_5uM_summarised 
Omeprazole_16S_20uM_summarised 
Omeprazole_16S_80uM_summarised 

#Rename 'species' so the outputs become comparable
original_names_80 <- unique(Omeprazole_16S_80uM_summarised$species)
original_names_20 <- unique(Omeprazole_16S_20uM_summarised$species)
original_names_5 <- unique(Omeprazole_16S_5uM_summarised$species)


##Create a named vector with the original and new names mapping
name_changes <- c(
  "Akkermansia muciniphila" = "A_muciniphila",
  "Bacteroides fragilis" = "B_fragilis",
  "Bacteroides thetaiotaomicron" = "B_thetaiotaomicron",
  "Bacteroides uniformis" = "B_uniformis",
  "Bifidobacterium adolescentis" = "B_adolescentis",
  "Bifidobacterium longum subsp. longum" = "B_longum",
  "Bilophila wadsworthia" = "B_wadsworthia",
  "Blautia obeum" = "B_obeum",
  "Clostridium perfringens" = "C_perfringens",
  "Collinsella aerofaciens" = "C_aerofaciens",
  "Coprococcus comes" = "C_comes",
  "Dorea formicigenerans" = "D_formicigenerans",
  "Eggerthella lenta" = "E_lenta",
  "Enterocloster bolteae" = "C_bolteae",
  "Erysipelatoclostridium ramosum" = "C_ramosum",
  "Escherichia coli ED1a" = "E_coli",
  "Eubacterium rectale" = "E_rectale",
  "Fusobacterium nucleatum subsp. nucleatum" = "F_nucleatum",
  "Lacrimispora saccharolytica" = "C_saccharolyticum",
  "Lacticaseibacillus paracasei" = "L_paracasei",
  "Odoribacter splanchnicus" = "O_splanchnicus",
  "Parabacteroides distasonis" = "P_distasonis",
  "Parabacteroides merdae" = "P_merdae",
  "Phocaeicola vulgatus" = "B_vulgatus",
  "Prevotella copri" = "P_copri",
  "Roseburia intestinalis" = "R_intestinalis",
  "Ruminococcus bromii" = "R_bromii",
  "Ruminococcus gnavus" = "R_gnavus",
  "Ruminococcus torques" = "R_torques",
  "Streptococcus parasanguinis" = "S_parasanguinis",
  "Streptococcus salivarius" = "S_salivarius",
  "Veillonella parvula" = "V_parvula"
)

# Apply name changes to the species column in Omeprazole_16S_80uM_summarised

Omeprazole_16S_80uM_summarised$Species <- name_changes[Omeprazole_16S_80uM_summarised$species]
Omeprazole_16S_20uM_summarised$Species <- name_changes[Omeprazole_16S_20uM_summarised$species]
Omeprazole_16S_5uM_summarised$Species <- name_changes[Omeprazole_16S_5uM_summarised$species]

# Verify the changes
unique(Omeprazole_16S_80uM_summarised$Species)
unique(Omeprazole_16S_20uM_summarised$Species)
unique(Omeprazole_16S_5uM_summarised$Species)



##First, for 5 uM:
# Get top 6 species from plot_data_5_endpoint
# Adjust the plot_data_5_endpoint with confidence bounds

# #plot_data_0_Omeprazole_endpoint was used to test model performance at 0 drugs
# plot_data_0_Omeprazole_endpoint <- plot_data_0_Omeprazole_endpoint %>%
#   dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)

plot_data_5_Omeprazole_endpoint <- plot_data_5_Omeprazole_endpoint %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)

# Adjust the Omeprazole_16S_5uM_summarised with confidence bounds
Omeprazole_16S_5uM_summarised <- Omeprazole_16S_5uM_summarised %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)

#NULL model:
Null_model_summarised <- Niclosamide_16S_0uM_summarised %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)


# Get top 6 species based on the lower bound from plot_data_5_endpoint

#top6_predicted_0_Omeprazole was used to test model performance at 0 drugs
# top6_predicted_0_Omeprazole <- plot_data_0_Omeprazole_endpoint %>%
#    arrange(desc(lower_bound)) %>%
#    slice(1:6) %>%
#    pull(Species)

top6_predicted_5_Omeprazole <- plot_data_5_Omeprazole_endpoint %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

# Get top 6 species based on the lower bound from Omeprazole_16S_5uM_summarised
top6_real_5_Omeprazole <- Omeprazole_16S_5uM_summarised %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

top6_NULL <- Null_model_summarised %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

# Calculate the overlap of top 6 species

#top_six_correct_0_Omeprazole was used to assess model performance at 0 drugs
# top_six_correct_0_Omeprazole <- length(intersect(top6_predicted_0_Omeprazole, top6_NULL))
# top_six_correct_0_Omeprazole

top_six_correct_5_Omeprazole <- length(intersect(top6_predicted_5_Omeprazole, top6_real_5_Omeprazole))
top_six_correct_5_Omeprazole

top_six_correct_5_Omeprazole_NULL <- length(intersect(top6_NULL, top6_real_5_Omeprazole))
top_six_correct_5_Omeprazole_NULL

top6_predicted_5_Omeprazole
top6_real_5_Omeprazole

#top6_NULL

#Now by means:
# #top6_predicted_0_Omeprazole_means was used to assess model performance at 0 drugs
# top6_predicted_0_Omeprazole_means <- plot_data_0_Omeprazole_endpoint %>%
#    arrange(desc(mean_rel_ab)) %>%
#    slice(1:6) %>%
#    pull(Species)

top6_predicted_5_Omeprazole_means <- plot_data_5_Omeprazole_endpoint %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)

# Get top 6 species based on the lower bound from Omeprazole_16S_5uM_summarised
top6_real_5_Omeprazole_means <- Omeprazole_16S_5uM_summarised %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)

top6_NULL_means <- Null_model_summarised %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)


# #top_six_correct_0_Omeprazole_means was used to assess model performance at 0 drugs
# top_six_correct_0_Omeprazole_means <- length(intersect(top6_predicted_0_Omeprazole_means, top6_NULL_means))
# top_six_correct_0_Omeprazole_means

top_six_correct_5_Omeprazole_means <- length(intersect(top6_predicted_5_Omeprazole_means, top6_real_5_Omeprazole_means))
top_six_correct_5_Omeprazole_means

top_six_correct_5_Omeprazole_means_NULL <- length(intersect(top6_NULL_means, top6_real_5_Omeprazole_means))
top_six_correct_5_Omeprazole_means_NULL

top6_predicted_5_Omeprazole_means
top6_real_5_Omeprazole_means

#top6_NULL_means


# Merge dataframes by Species

#merged_data_0_Omeprazole was used to assess model performance at 0 drugs
#merged_data_0_Omeprazole <- merge(plot_data_0_Omeprazole_endpoint, Niclosamide_16S_0uM_summarised, by = "Species", suffixes = c(".pred", ".real"))
merged_data_5_Omeprazole <- merge(plot_data_5_Omeprazole_endpoint, Omeprazole_16S_5uM_summarised, by = "Species", suffixes = c(".pred", ".real"))
merged_data_5_Omeprazole_NULL <- merge(Niclosamide_16S_0uM_summarised, Omeprazole_16S_5uM_summarised, by = "Species", suffixes = c(".null", ".real"))


## Below lines used for assessing model performance at 0 drugs; ignore for nonzero concentrations
# # Create lower and upper bounds considering mean ¬± sd
# merged_data_0_Omeprazole$lower_bound_pred <- merged_data_0_Omeprazole$mean_rel_ab.pred - merged_data_0_Omeprazole$sd_rel_ab.pred
# merged_data_0_Omeprazole$upper_bound_pred <- merged_data_0_Omeprazole$mean_rel_ab.pred + merged_data_0_Omeprazole$sd_rel_ab.pred
# merged_data_0_Omeprazole$lower_bound_real <- merged_data_0_Omeprazole$mean_rel_ab.real - merged_data_0_Omeprazole$sd_rel_ab.real
# merged_data_0_Omeprazole$upper_bound_real <- merged_data_0_Omeprazole$mean_rel_ab.real + merged_data_0_Omeprazole$sd_rel_ab.real
# 
# # Ensure lower and upper bounds are non-negative, adjusting as necessary
# merged_data_0_Omeprazole$lower_bound_pred[merged_data_0_Omeprazole$lower_bound_pred <= 0] <- 1e-10
# merged_data_0_Omeprazole$lower_bound_real[merged_data_0_Omeprazole$lower_bound_real <= 0] <- 1e-10
# merged_data_0_Omeprazole$upper_bound_pred[merged_data_0_Omeprazole$upper_bound_pred <= 0] <- 1e-10
# merged_data_0_Omeprazole$upper_bound_real[merged_data_0_Omeprazole$upper_bound_real <= 0] <- 1e-10


# Create lower and upper bounds considering mean ¬± sd
merged_data_5_Omeprazole$lower_bound_pred <- merged_data_5_Omeprazole$mean_rel_ab.pred - merged_data_5_Omeprazole$sd_rel_ab.pred
merged_data_5_Omeprazole$upper_bound_pred <- merged_data_5_Omeprazole$mean_rel_ab.pred + merged_data_5_Omeprazole$sd_rel_ab.pred
merged_data_5_Omeprazole$lower_bound_real <- merged_data_5_Omeprazole$mean_rel_ab.real - merged_data_5_Omeprazole$sd_rel_ab.real
merged_data_5_Omeprazole$upper_bound_real <- merged_data_5_Omeprazole$mean_rel_ab.real + merged_data_5_Omeprazole$sd_rel_ab.real

# Ensure lower and upper bounds are non-negative, adjusting as necessary
merged_data_5_Omeprazole$lower_bound_pred[merged_data_5_Omeprazole$lower_bound_pred <= 0] <- 1e-10
merged_data_5_Omeprazole$lower_bound_real[merged_data_5_Omeprazole$lower_bound_real <= 0] <- 1e-10
merged_data_5_Omeprazole$upper_bound_pred[merged_data_5_Omeprazole$upper_bound_pred <= 0] <- 1e-10
merged_data_5_Omeprazole$upper_bound_real[merged_data_5_Omeprazole$upper_bound_real <= 0] <- 1e-10

##and for NULL model:
# Create lower and upper bounds considering mean ¬± sd
merged_data_5_Omeprazole_NULL$lower_bound_null <- merged_data_5_Omeprazole_NULL$mean_rel_ab.null - merged_data_5_Omeprazole_NULL$sd_rel_ab.null
merged_data_5_Omeprazole_NULL$upper_bound_null <- merged_data_5_Omeprazole_NULL$mean_rel_ab.null + merged_data_5_Omeprazole_NULL$sd_rel_ab.null
merged_data_5_Omeprazole_NULL$lower_bound_real <- merged_data_5_Omeprazole_NULL$mean_rel_ab.real - merged_data_5_Omeprazole_NULL$sd_rel_ab.real
merged_data_5_Omeprazole_NULL$upper_bound_real <- merged_data_5_Omeprazole_NULL$mean_rel_ab.real + merged_data_5_Omeprazole_NULL$sd_rel_ab.real

# Ensure lower and upper bounds are non-negative, adjusting as necessary
merged_data_5_Omeprazole_NULL$lower_bound_null[merged_data_5_Omeprazole_NULL$lower_bound_null <= 0] <- 1e-10
merged_data_5_Omeprazole_NULL$lower_bound_real[merged_data_5_Omeprazole_NULL$lower_bound_real <= 0] <- 1e-10
merged_data_5_Omeprazole_NULL$upper_bound_null[merged_data_5_Omeprazole_NULL$upper_bound_null <= 0] <- 1e-10
merged_data_5_Omeprazole_NULL$upper_bound_real[merged_data_5_Omeprazole_NULL$upper_bound_real <= 0] <- 1e-10

# Filter to include only species with a mean relative abundance > 0.01 in the 'real' dataset

## significant_species_0 was used to assess model performance at 0 drugs
#significant_species_0 <- merged_data_0_Omeprazole[merged_data_0_Omeprazole$mean_rel_ab.real > 0.01, ]
significant_species <- merged_data_5_Omeprazole[merged_data_5_Omeprazole$mean_rel_ab.real > 0.01, ]
survivors_5_Omeprazole <- nrow(significant_species)
survivors_5_Omeprazole

#should be the same as survivors defined above, since it is calculated from .real
significant_species_NULL <- merged_data_5_Omeprazole_NULL[merged_data_5_Omeprazole_NULL$mean_rel_ab.real > 0.01, ]
survivors_5_Omeprazole_NULL <- nrow(significant_species_NULL)
survivors_5_Omeprazole_NULL

# Adjusted order of magnitude check to include SD, only for significant species
## below code was used to assess model performance at 0 drugs
# significant_species_0$Predicted_magnitude_correct <- ifelse(
#   (floor(log10(significant_species_0$lower_bound_pred)) <= floor(log10(significant_species_0$upper_bound_real)) &
#      floor(log10(significant_species_0$upper_bound_pred)) >= floor(log10(significant_species_0$lower_bound_real))),
#   1,
#   0
# )

significant_species$Predicted_magnitude_correct <- ifelse(
  (floor(log10(significant_species$lower_bound_pred)) <= floor(log10(significant_species$upper_bound_real)) &
     floor(log10(significant_species$upper_bound_pred)) >= floor(log10(significant_species$lower_bound_real))),
  1,
  0
)

#and for the Null model:
significant_species_NULL$Predicted_magnitude_correct <- ifelse(
  (floor(log10(significant_species_NULL$lower_bound_null)) <= floor(log10(significant_species_NULL$upper_bound_real)) &
     floor(log10(significant_species_NULL$upper_bound_null)) >= floor(log10(significant_species_NULL$lower_bound_real))),
  1,
  0
)

# Calculate the fraction of correctly predicted magnitudes for significant species
## below code was used to assess model performance at 0 drugs
#predicted_magnitude_correct_fraction_0_Omeprazole <- sum(significant_species_0$Predicted_magnitude_correct) / nrow(significant_species_0)
#predicted_magnitude_correct_fraction_0_Omeprazole

predicted_magnitude_correct_fraction_5_Omeprazole <- sum(significant_species$Predicted_magnitude_correct) / nrow(significant_species)
predicted_magnitude_correct_fraction_5_Omeprazole

predicted_magnitude_correct_fraction_5_Omeprazole_NULL <- sum(significant_species_NULL$Predicted_magnitude_correct) / nrow(significant_species_NULL)
predicted_magnitude_correct_fraction_5_Omeprazole_NULL

top_species_missing_5_Omeprazole <- setdiff(top6_real_5_Omeprazole_means, top6_predicted_5_Omeprazole_means)
top_species_wrong_5_Omeprazole <- setdiff(top6_predicted_5_Omeprazole_means, top6_real_5_Omeprazole_means)

top_species_missing_5_Omeprazole <- if(length(top_species_missing_5_Omeprazole) == 0) "None" else top_species_missing_5_Omeprazole
top_species_wrong_5_Omeprazole <- if(length(top_species_wrong_5_Omeprazole) == 0) "None" else top_species_wrong_5_Omeprazole

Prediction_quality_5_Omeprazole <- data.frame(
  Top_six_correct = paste(top_six_correct_5_Omeprazole, sep=""),
  Top_six_correct_NULL = paste(top_six_correct_5_Omeprazole_NULL, sep=""),
  Top_six_correct_means = paste(top_six_correct_5_Omeprazole_means, sep=""),
  Top_six_correct_means_NULL = paste(top_six_correct_5_Omeprazole_means_NULL, sep=""),
  Predicted_magnitude_correct = paste(round(predicted_magnitude_correct_fraction_5_Omeprazole * 100, 2), "%", sep=""),
  Predicted_magnitude_correct_NULL = paste(round(predicted_magnitude_correct_fraction_5_Omeprazole_NULL * 100, 2), "%", sep=""),
  survivors_total = survivors_5_Omeprazole,
  top_species_missing <- top_species_missing_5_Omeprazole,
  top_species_wrong <- top_species_wrong_5_Omeprazole, 
  predicted_mean_final_OD <- predicted_mean_final_od_5_Omeprazole,
  real_mean_final_OD <- real_mean_final_od_5_Omeprazole,
  sims_total = length(successful_sim_ids)
)



Prediction_quality_5_Omeprazole



##Next, for 20 uM:
# Get top 6 species from plot_data_20_endpoint
# Adjust the plot_data_20_endpoint with confidence bounds
plot_data_20_Omeprazole_endpoint <- plot_data_20_Omeprazole_endpoint %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)

# Adjust the Omeprazole_16S_20uM_summarised with confidence bounds
Omeprazole_16S_20uM_summarised <- Omeprazole_16S_20uM_summarised %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)

#NULL model:
Null_model_summarised <- Niclosamide_16S_0uM_summarised %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)


# Get top 6 species based on the lower bound from plot_data_20_endpoint
top6_predicted_20_Omeprazole <- plot_data_20_Omeprazole_endpoint %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

# Get top 6 species based on the lower bound from Omeprazole_16S_20uM_summarised
top6_real_20_Omeprazole <- Omeprazole_16S_20uM_summarised %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

top6_NULL <- Null_model_summarised %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

# Calculate the overlap of top 6 species
top_six_correct_20_Omeprazole <- length(intersect(top6_predicted_20_Omeprazole, top6_real_20_Omeprazole))
#top_six_correct_20_Omeprazole

top_six_correct_20_Omeprazole_NULL <- length(intersect(top6_NULL, top6_real_20_Omeprazole))
#top_six_correct_20_Omeprazole_NULL

#top6_predicted_20_Omeprazole
#top6_real_20_Omeprazole



#Now by means:
top6_predicted_20_Omeprazole_means <- plot_data_20_Omeprazole_endpoint %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)

# Get top 6 species based on the lower bound from Omeprazole_16S_20uM_summarised
top6_real_20_Omeprazole_means <- Omeprazole_16S_20uM_summarised %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)

top6_NULL_means <- Null_model_summarised %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)



top_six_correct_20_Omeprazole_means <- length(intersect(top6_predicted_20_Omeprazole_means, top6_real_20_Omeprazole_means))
#top_six_correct_20_Omeprazole_means

top_six_correct_20_Omeprazole_means_NULL <- length(intersect(top6_NULL_means, top6_real_20_Omeprazole_means))
#top_six_correct_20_Omeprazole_means_NULL

top6_predicted_20_Omeprazole_means
#top6_real_20_Omeprazole_means




# Merge dataframes by Species
merged_data_20_Omeprazole <- merge(plot_data_20_Omeprazole_endpoint, Omeprazole_16S_20uM_summarised, by = "Species", suffixes = c(".pred", ".real"))
merged_data_20_Omeprazole_NULL <- merge(Niclosamide_16S_0uM_summarised, Omeprazole_16S_20uM_summarised, by = "Species", suffixes = c(".null", ".real"))



# Create lower and upper bounds considering mean ¬± sd
merged_data_20_Omeprazole$lower_bound_pred <- merged_data_20_Omeprazole$mean_rel_ab.pred - merged_data_20_Omeprazole$sd_rel_ab.pred
merged_data_20_Omeprazole$upper_bound_pred <- merged_data_20_Omeprazole$mean_rel_ab.pred + merged_data_20_Omeprazole$sd_rel_ab.pred
merged_data_20_Omeprazole$lower_bound_real <- merged_data_20_Omeprazole$mean_rel_ab.real - merged_data_20_Omeprazole$sd_rel_ab.real
merged_data_20_Omeprazole$upper_bound_real <- merged_data_20_Omeprazole$mean_rel_ab.real + merged_data_20_Omeprazole$sd_rel_ab.real

# Ensure lower and upper bounds are non-negative, adjusting as necessary
merged_data_20_Omeprazole$lower_bound_pred[merged_data_20_Omeprazole$lower_bound_pred <= 0] <- 1e-10
merged_data_20_Omeprazole$lower_bound_real[merged_data_20_Omeprazole$lower_bound_real <= 0] <- 1e-10
merged_data_20_Omeprazole$upper_bound_pred[merged_data_20_Omeprazole$upper_bound_pred <= 0] <- 1e-10
merged_data_20_Omeprazole$upper_bound_real[merged_data_20_Omeprazole$upper_bound_real <= 0] <- 1e-10

##and for NULL model:
# Create lower and upper bounds considering mean ¬± sd
merged_data_20_Omeprazole_NULL$lower_bound_null <- merged_data_20_Omeprazole_NULL$mean_rel_ab.null - merged_data_20_Omeprazole_NULL$sd_rel_ab.null
merged_data_20_Omeprazole_NULL$upper_bound_null <- merged_data_20_Omeprazole_NULL$mean_rel_ab.null + merged_data_20_Omeprazole_NULL$sd_rel_ab.null
merged_data_20_Omeprazole_NULL$lower_bound_real <- merged_data_20_Omeprazole_NULL$mean_rel_ab.real - merged_data_20_Omeprazole_NULL$sd_rel_ab.real
merged_data_20_Omeprazole_NULL$upper_bound_real <- merged_data_20_Omeprazole_NULL$mean_rel_ab.real + merged_data_20_Omeprazole_NULL$sd_rel_ab.real

# Ensure lower and upper bounds are non-negative, adjusting as necessary
merged_data_20_Omeprazole_NULL$lower_bound_null[merged_data_20_Omeprazole_NULL$lower_bound_null <= 0] <- 1e-10
merged_data_20_Omeprazole_NULL$lower_bound_real[merged_data_20_Omeprazole_NULL$lower_bound_real <= 0] <- 1e-10
merged_data_20_Omeprazole_NULL$upper_bound_null[merged_data_20_Omeprazole_NULL$upper_bound_null <= 0] <- 1e-10
merged_data_20_Omeprazole_NULL$upper_bound_real[merged_data_20_Omeprazole_NULL$upper_bound_real <= 0] <- 1e-10

# Filter to include only species with a mean relative abundance > 0.01 in the 'real' dataset
significant_species <- merged_data_20_Omeprazole[merged_data_20_Omeprazole$mean_rel_ab.real > 0.01, ]
survivors_20_Omeprazole <- nrow(significant_species)
survivors_20_Omeprazole

#should be the same as survivors defined above, since it is calculated from .real
significant_species_NULL <- merged_data_20_Omeprazole_NULL[merged_data_20_Omeprazole_NULL$mean_rel_ab.real > 0.01, ]
survivors_20_Omeprazole_NULL <- nrow(significant_species_NULL)
survivors_20_Omeprazole_NULL

# Adjusted order of magnitude check to include SD, only for significant species
significant_species$Predicted_magnitude_correct <- ifelse(
  (floor(log10(significant_species$lower_bound_pred)) <= floor(log10(significant_species$upper_bound_real)) &
     floor(log10(significant_species$upper_bound_pred)) >= floor(log10(significant_species$lower_bound_real))),
  1,
  0
)

#and for the Null model:
significant_species_NULL$Predicted_magnitude_correct <- ifelse(
  (floor(log10(significant_species_NULL$lower_bound_null)) <= floor(log10(significant_species_NULL$upper_bound_real)) &
     floor(log10(significant_species_NULL$upper_bound_null)) >= floor(log10(significant_species_NULL$lower_bound_real))),
  1,
  0
)

# Calculate the fraction of correctly predicted magnitudes for significant species
predicted_magnitude_correct_fraction_20_Omeprazole <- sum(significant_species$Predicted_magnitude_correct) / nrow(significant_species)
predicted_magnitude_correct_fraction_20_Omeprazole

predicted_magnitude_correct_fraction_20_Omeprazole_NULL <- sum(significant_species_NULL$Predicted_magnitude_correct) / nrow(significant_species_NULL)
predicted_magnitude_correct_fraction_20_Omeprazole_NULL

top_species_missing_20_Omeprazole <- setdiff(top6_real_20_Omeprazole_means, top6_predicted_20_Omeprazole_means)
top_species_wrong_20_Omeprazole <- setdiff(top6_predicted_20_Omeprazole_means, top6_real_20_Omeprazole_means)

top_species_missing_20_Omeprazole <- if(length(top_species_missing_20_Omeprazole) == 0) "None" else top_species_missing_20_Omeprazole
top_species_wrong_20_Omeprazole <- if(length(top_species_wrong_20_Omeprazole) == 0) "None" else top_species_wrong_20_Omeprazole

Prediction_quality_20_Omeprazole <- data.frame(
  Top_six_correct = paste(top_six_correct_20_Omeprazole, sep=""),
  Top_six_correct_NULL = paste(top_six_correct_20_Omeprazole_NULL, sep=""),
  Top_six_correct_means = paste(top_six_correct_20_Omeprazole_means, sep=""),
  Top_six_correct_means_NULL = paste(top_six_correct_20_Omeprazole_means_NULL, sep=""),
  Predicted_magnitude_correct = paste(round(predicted_magnitude_correct_fraction_20_Omeprazole * 100, 2), "%", sep=""),
  Predicted_magnitude_correct_NULL = paste(round(predicted_magnitude_correct_fraction_20_Omeprazole_NULL * 100, 2), "%", sep=""),
  survivors_total = survivors_20_Omeprazole,
  top_species_missing <- top_species_missing_20_Omeprazole,
  top_species_wrong <- top_species_wrong_20_Omeprazole, 
  predicted_mean_final_OD <- predicted_mean_final_od_20_Omeprazole,
  real_mean_final_OD <- real_mean_final_od_20_Omeprazole,
  sims_total = length(successful_sim_ids)
)

Prediction_quality_20_Omeprazole






##Next, for 80 uM:
# Get top 6 species from plot_data_80_endpoint
# Adjust the plot_data_80_endpoint with confidence bounds
plot_data_80_Omeprazole_endpoint <- plot_data_80_Omeprazole_endpoint %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)

# Adjust the Omeprazole_16S_80uM_summarised with confidence bounds
Omeprazole_16S_80uM_summarised <- Omeprazole_16S_80uM_summarised %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)

#NULL model:
Null_model_summarised <- Niclosamide_16S_0uM_summarised %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)


# Get top 6 species based on the lower bound from plot_data_80_endpoint
top6_predicted_80_Omeprazole <- plot_data_80_Omeprazole_endpoint %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

# Get top 6 species based on the lower bound from Omeprazole_16S_80uM_summarised
top6_real_80_Omeprazole <- Omeprazole_16S_80uM_summarised %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

top6_NULL <- Null_model_summarised %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

# Calculate the overlap of top 6 species
top_six_correct_80_Omeprazole <- length(intersect(top6_predicted_80_Omeprazole, top6_real_80_Omeprazole))
#top_six_correct_80_Omeprazole

top_six_correct_80_Omeprazole_NULL <- length(intersect(top6_NULL, top6_real_80_Omeprazole))
#top_six_correct_80_Omeprazole_NULL

#top6_predicted_80_Omeprazole
#top6_real_80_Omeprazole




#Now by means:
top6_predicted_80_Omeprazole_means <- plot_data_80_Omeprazole_endpoint %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)

# Get top 6 species based on the lower bound from Omeprazole_16S_80uM_summarised
top6_real_80_Omeprazole_means <- Omeprazole_16S_80uM_summarised %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)

top6_NULL_means <- Null_model_summarised %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)



top_six_correct_80_Omeprazole_means <- length(intersect(top6_predicted_80_Omeprazole_means, top6_real_80_Omeprazole_means))
#top_six_correct_80_Omeprazole_means

top_six_correct_80_Omeprazole_means_NULL <- length(intersect(top6_NULL_means, top6_real_80_Omeprazole_means))
#top_six_correct_80_Omeprazole_means_NULL

#top6_predicted_80_Omeprazole_means
#top6_real_80_Omeprazole_means




# Merge dataframes by Species
merged_data_80_Omeprazole <- merge(plot_data_80_Omeprazole_endpoint, Omeprazole_16S_80uM_summarised, by = "Species", suffixes = c(".pred", ".real"))
merged_data_80_Omeprazole_NULL <- merge(Niclosamide_16S_0uM_summarised, Omeprazole_16S_80uM_summarised, by = "Species", suffixes = c(".null", ".real"))



# Create lower and upper bounds considering mean ¬± sd
merged_data_80_Omeprazole$lower_bound_pred <- merged_data_80_Omeprazole$mean_rel_ab.pred - merged_data_80_Omeprazole$sd_rel_ab.pred
merged_data_80_Omeprazole$upper_bound_pred <- merged_data_80_Omeprazole$mean_rel_ab.pred + merged_data_80_Omeprazole$sd_rel_ab.pred
merged_data_80_Omeprazole$lower_bound_real <- merged_data_80_Omeprazole$mean_rel_ab.real - merged_data_80_Omeprazole$sd_rel_ab.real
merged_data_80_Omeprazole$upper_bound_real <- merged_data_80_Omeprazole$mean_rel_ab.real + merged_data_80_Omeprazole$sd_rel_ab.real

# Ensure lower and upper bounds are non-negative, adjusting as necessary
merged_data_80_Omeprazole$lower_bound_pred[merged_data_80_Omeprazole$lower_bound_pred <= 0] <- 1e-10
merged_data_80_Omeprazole$lower_bound_real[merged_data_80_Omeprazole$lower_bound_real <= 0] <- 1e-10
merged_data_80_Omeprazole$upper_bound_pred[merged_data_80_Omeprazole$upper_bound_pred <= 0] <- 1e-10
merged_data_80_Omeprazole$upper_bound_real[merged_data_80_Omeprazole$upper_bound_real <= 0] <- 1e-10

##and for NULL model:
# Create lower and upper bounds considering mean ¬± sd
merged_data_80_Omeprazole_NULL$lower_bound_null <- merged_data_80_Omeprazole_NULL$mean_rel_ab.null - merged_data_80_Omeprazole_NULL$sd_rel_ab.null
merged_data_80_Omeprazole_NULL$upper_bound_null <- merged_data_80_Omeprazole_NULL$mean_rel_ab.null + merged_data_80_Omeprazole_NULL$sd_rel_ab.null
merged_data_80_Omeprazole_NULL$lower_bound_real <- merged_data_80_Omeprazole_NULL$mean_rel_ab.real - merged_data_80_Omeprazole_NULL$sd_rel_ab.real
merged_data_80_Omeprazole_NULL$upper_bound_real <- merged_data_80_Omeprazole_NULL$mean_rel_ab.real + merged_data_80_Omeprazole_NULL$sd_rel_ab.real

# Ensure lower and upper bounds are non-negative, adjusting as necessary
merged_data_80_Omeprazole_NULL$lower_bound_null[merged_data_80_Omeprazole_NULL$lower_bound_null <= 0] <- 1e-10
merged_data_80_Omeprazole_NULL$lower_bound_real[merged_data_80_Omeprazole_NULL$lower_bound_real <= 0] <- 1e-10
merged_data_80_Omeprazole_NULL$upper_bound_null[merged_data_80_Omeprazole_NULL$upper_bound_null <= 0] <- 1e-10
merged_data_80_Omeprazole_NULL$upper_bound_real[merged_data_80_Omeprazole_NULL$upper_bound_real <= 0] <- 1e-10

# Filter to include only species with a mean relative abundance > 0.01 in the 'real' dataset
significant_species <- merged_data_80_Omeprazole[merged_data_80_Omeprazole$mean_rel_ab.real > 0.01, ]
survivors_80_Omeprazole <- nrow(significant_species)
survivors_80_Omeprazole

#should be the same as survivors defined above, since it is calculated from .real
significant_species_NULL <- merged_data_80_Omeprazole_NULL[merged_data_80_Omeprazole_NULL$mean_rel_ab.real > 0.01, ]
survivors_80_Omeprazole_NULL <- nrow(significant_species_NULL)
survivors_80_Omeprazole_NULL

# Adjusted order of magnitude check to include SD, only for significant species
significant_species$Predicted_magnitude_correct <- ifelse(
  (floor(log10(significant_species$lower_bound_pred)) <= floor(log10(significant_species$upper_bound_real)) &
     floor(log10(significant_species$upper_bound_pred)) >= floor(log10(significant_species$lower_bound_real))),
  1,
  0
)

#and for the Null model:
significant_species_NULL$Predicted_magnitude_correct <- ifelse(
  (floor(log10(significant_species_NULL$lower_bound_null)) <= floor(log10(significant_species_NULL$upper_bound_real)) &
     floor(log10(significant_species_NULL$upper_bound_null)) >= floor(log10(significant_species_NULL$lower_bound_real))),
  1,
  0
)

# Calculate the fraction of correctly predicted magnitudes for significant species
predicted_magnitude_correct_fraction_80_Omeprazole <- sum(significant_species$Predicted_magnitude_correct) / nrow(significant_species)
predicted_magnitude_correct_fraction_80_Omeprazole

predicted_magnitude_correct_fraction_80_Omeprazole_NULL <- sum(significant_species_NULL$Predicted_magnitude_correct) / nrow(significant_species_NULL)
predicted_magnitude_correct_fraction_80_Omeprazole_NULL


top_species_missing_80_Omeprazole <- setdiff(top6_real_80_Omeprazole_means, top6_predicted_80_Omeprazole_means)
top_species_wrong_80_Omeprazole <- setdiff(top6_predicted_80_Omeprazole_means, top6_real_80_Omeprazole_means)

top_species_missing_80_Omeprazole <- if(length(top_species_missing_80_Omeprazole) == 0) "None" else top_species_missing_80_Omeprazole
top_species_wrong_80_Omeprazole <- if(length(top_species_wrong_80_Omeprazole) == 0) "None" else top_species_wrong_80_Omeprazole


Prediction_quality_80_Omeprazole <- data.frame(
  Top_six_correct = paste(top_six_correct_80_Omeprazole, sep=""),
  Top_six_correct_NULL = paste(top_six_correct_80_Omeprazole_NULL, sep=""),
  Top_six_correct_means = paste(top_six_correct_80_Omeprazole_means, sep=""),
  Top_six_correct_means_NULL = paste(top_six_correct_80_Omeprazole_means_NULL, sep=""),
  Predicted_magnitude_correct = paste(round(predicted_magnitude_correct_fraction_80_Omeprazole * 100, 2), "%", sep=""),
  Predicted_magnitude_correct_NULL = paste(round(predicted_magnitude_correct_fraction_80_Omeprazole_NULL * 100, 2), "%", sep=""),
  survivors_total = survivors_80_Omeprazole,
  top_species_missing <- top_species_missing_80_Omeprazole,
  top_species_wrong <- top_species_wrong_80_Omeprazole, 
  predicted_mean_final_OD <- predicted_mean_final_od_80_Omeprazole,
  real_mean_final_OD <- real_mean_final_od_80_Omeprazole,
  sims_total = length(successful_sim_ids)
)

Prediction_quality_80_Omeprazole











##Oxolinic_acid

combined_monoculture_aucs2_Oxolinic_acid <- subset(combined_monoculture_aucs2, drug == "Oxolinic acid")


#drug sensitivity terms: define once outside of ODEs
y_function_B_vulgatus_Oxolinic_acid <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("B_vulgatus", "Oxolinic_acid", best_fitting_models_df_Oxolinic_acid)), collapse = " ")))
y_function_B_uniformis_Oxolinic_acid <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("B_uniformis", "Oxolinic_acid", best_fitting_models_df_Oxolinic_acid)), collapse = " ")))
y_function_B_fragilis_Oxolinic_acid <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("B_fragilis", "Oxolinic_acid", best_fitting_models_df_Oxolinic_acid)), collapse = " ")))
y_function_B_thetaiotaomicron_Oxolinic_acid <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("B_thetaiotaomicron", "Oxolinic_acid", best_fitting_models_df_Oxolinic_acid)), collapse = " ")))
y_function_C_ramosum_Oxolinic_acid <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("C_ramosum", "Oxolinic_acid", best_fitting_models_df_Oxolinic_acid)), collapse = " ")))
y_function_E_rectale_Oxolinic_acid <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("E_rectale", "Oxolinic_acid", best_fitting_models_df_Oxolinic_acid)), collapse = " ")))
y_function_R_intestinalis_Oxolinic_acid <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("R_intestinalis", "Oxolinic_acid", best_fitting_models_df_Oxolinic_acid)), collapse = " ")))
y_function_V_parvula_Oxolinic_acid <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("V_parvula", "Oxolinic_acid", best_fitting_models_df_Oxolinic_acid)), collapse = " ")))
y_function_E_lenta_Oxolinic_acid <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("E_lenta", "Oxolinic_acid", best_fitting_models_df_Oxolinic_acid)), collapse = " ")))
y_function_F_nucleatum_Oxolinic_acid <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("F_nucleatum", "Oxolinic_acid", best_fitting_models_df_Oxolinic_acid)), collapse = " ")))
y_function_C_bolteae_Oxolinic_acid <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("C_bolteae", "Oxolinic_acid", best_fitting_models_df_Oxolinic_acid)), collapse = " ")))
y_function_C_perfringens_Oxolinic_acid <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("C_perfringens", "Oxolinic_acid", best_fitting_models_df_Oxolinic_acid)), collapse = " ")))
y_function_C_saccharolyticum_Oxolinic_acid <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("C_saccharolyticum", "Oxolinic_acid", best_fitting_models_df_Oxolinic_acid)), collapse = " ")))
y_function_S_salivarius_Oxolinic_acid <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("S_salivarius", "Oxolinic_acid", best_fitting_models_df_Oxolinic_acid)), collapse = " ")))
y_function_R_gnavus_Oxolinic_acid <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("R_gnavus", "Oxolinic_acid", best_fitting_models_df_Oxolinic_acid)), collapse = " ")))
y_function_C_comes_Oxolinic_acid <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("C_comes", "Oxolinic_acid", best_fitting_models_df_Oxolinic_acid)), collapse = " ")))
y_function_P_merdae_Oxolinic_acid <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("P_merdae", "Oxolinic_acid", best_fitting_models_df_Oxolinic_acid)), collapse = " ")))
y_function_S_parasanguinis_Oxolinic_acid <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("S_parasanguinis", "Oxolinic_acid", best_fitting_models_df_Oxolinic_acid)), collapse = " ")))
y_function_C_aerofaciens_Oxolinic_acid <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("C_aerofaciens", "Oxolinic_acid", best_fitting_models_df_Oxolinic_acid)), collapse = " ")))
y_function_D_formicigenerans_Oxolinic_acid <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("D_formicigenerans", "Oxolinic_acid", best_fitting_models_df_Oxolinic_acid)), collapse = " ")))
y_function_E_coli_Oxolinic_acid <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("E_coli", "Oxolinic_acid", best_fitting_models_df_Oxolinic_acid)), collapse = " ")))



y_function_B_vulgatus_Oxolinic_acid_func <- eval(parse(text = paste("function(Drug) {", y_function_B_vulgatus_Oxolinic_acid, "}")))
y_function_B_uniformis_Oxolinic_acid_func <- eval(parse(text = paste("function(Drug) {", y_function_B_uniformis_Oxolinic_acid, "}")))
y_function_B_fragilis_Oxolinic_acid_func <- eval(parse(text = paste("function(Drug) {", y_function_B_fragilis_Oxolinic_acid, "}")))
y_function_B_thetaiotaomicron_Oxolinic_acid_func <- eval(parse(text = paste("function(Drug) {", y_function_B_thetaiotaomicron_Oxolinic_acid, "}")))
y_function_C_ramosum_Oxolinic_acid_func <- eval(parse(text = paste("function(Drug) {", y_function_C_ramosum_Oxolinic_acid, "}")))
y_function_E_rectale_Oxolinic_acid_func <- eval(parse(text = paste("function(Drug) {", y_function_E_rectale_Oxolinic_acid, "}")))
y_function_R_intestinalis_Oxolinic_acid_func <- eval(parse(text = paste("function(Drug) {", y_function_R_intestinalis_Oxolinic_acid, "}")))
y_function_E_lenta_Oxolinic_acid_func <- eval(parse(text = paste("function(Drug) {", y_function_E_lenta_Oxolinic_acid, "}")))
y_function_F_nucleatum_Oxolinic_acid_func <- eval(parse(text = paste("function(Drug) {", y_function_F_nucleatum_Oxolinic_acid, "}")))
y_function_C_bolteae_Oxolinic_acid_func <- eval(parse(text = paste("function(Drug) {", y_function_C_bolteae_Oxolinic_acid, "}")))
y_function_C_perfringens_Oxolinic_acid_func <- eval(parse(text = paste("function(Drug) {", y_function_C_perfringens_Oxolinic_acid, "}")))
y_function_C_saccharolyticum_Oxolinic_acid_func <- eval(parse(text = paste("function(Drug) {", y_function_C_saccharolyticum_Oxolinic_acid, "}")))
y_function_S_salivarius_Oxolinic_acid_func <- eval(parse(text = paste("function(Drug) {", y_function_S_salivarius_Oxolinic_acid, "}")))
y_function_R_gnavus_Oxolinic_acid_func <- eval(parse(text = paste("function(Drug) {", y_function_R_gnavus_Oxolinic_acid, "}")))
y_function_C_comes_Oxolinic_acid_func <- eval(parse(text = paste("function(Drug) {", y_function_C_comes_Oxolinic_acid, "}")))
y_function_P_merdae_Oxolinic_acid_func <- eval(parse(text = paste("function(Drug) {", y_function_P_merdae_Oxolinic_acid, "}")))
y_function_S_parasanguinis_Oxolinic_acid_func <- eval(parse(text = paste("function(Drug) {", y_function_S_parasanguinis_Oxolinic_acid, "}")))
y_function_C_aerofaciens_Oxolinic_acid_func <- eval(parse(text = paste("function(Drug) {", y_function_C_aerofaciens_Oxolinic_acid, "}")))
y_function_D_formicigenerans_Oxolinic_acid_func <- eval(parse(text = paste("function(Drug) {", y_function_D_formicigenerans_Oxolinic_acid, "}")))
y_function_E_coli_Oxolinic_acid_func <- eval(parse(text = paste("function(Drug) {", y_function_E_coli_Oxolinic_acid, "}")))
y_function_V_parvula_Oxolinic_acid_func <- eval(parse(text = paste("function(Drug) {", y_function_V_parvula_Oxolinic_acid, "}")))



unique(combined_monoculture_aucs2_Oxolinic_acid$conc)
##dictate drug concentration tested for simulation cycle here:
#drug_concentration_tested <- 0.5 #if manually or:
drug_concentration_tested <- unique(combined_monoculture_aucs2_Oxolinic_acid$conc)[1]
initial_conditions <- rep(0.01/32, 32)
initial_conditions <- c(initial_conditions, drug_concentration_tested)


##drug effect fitted for species showing sensitivity in monoculture:
#unique(combined_monoculture_aucs2_Oxolinic_acid$Species)

##for more simple linear fits
closed.sir.model_Oxolinic_acid <- function (t, x, params) {
  ## first extract the state variables
  A_muciniphila <- x[1]
  B_adolescentis <- x[2]
  B_fragilis <- x[3]
  B_longum <- x[4]
  B_obeum <- x[5]
  B_thetaiotaomicron <- x[6]
  B_uniformis <- x[7]
  B_vulgatus <- x[8]
  B_wadsworthia <- x[9]
  C_aerofaciens <- x[10]
  C_bolteae <- x[11]
  C_comes <- x[12]
  C_perfringens <- x[13]
  C_ramosum <- x[14]
  C_saccharolyticum <- x[15]
  D_formicigenerans <- x[16]
  E_coli <- x[17]
  E_lenta <- x[18]
  E_rectale <- x[19]
  F_nucleatum <- x[20]
  L_paracasei <- x[21]
  O_splanchnicus <- x[22]
  P_copri <- x[23]
  P_distasonis <- x[24]
  P_merdae <- x[25]
  R_bromii <- x[26]
  R_gnavus <- x[27]
  R_intestinalis <- x[28]
  R_torques <- x[29]
  S_parasanguinis <- x[30]
  S_salivarius <- x[31]
  V_parvula <- x[32]
  Drug <- x[33]
  
  
  ## now extract the parameters
  r_B_fragilis <- flat_params[["B._fragilis.r"]]
  K_B_fragilis <- flat_params[["B._fragilis.K"]]
  r_B_longum <- flat_params[["B._longum.r"]]
  K_B_longum <- flat_params[["B._longum.K"]]
  r_B_thetaiotaomicron <- flat_params[["B._thetaiotaomicron.r"]]
  K_B_thetaiotaomicron <- flat_params[["B._thetaiotaomicron.K"]]
  r_B_uniformis <- flat_params[["B._uniformis.r"]]
  K_B_uniformis <- flat_params[["B._uniformis.K"]]
  r_B_vulgatus <- flat_params[["B._vulgatus.r"]]
  K_B_vulgatus <- flat_params[["B._vulgatus.K"]]
  r_B_wadsworthia <- flat_params[["B._wadsworthia.r"]]
  K_B_wadsworthia <- flat_params[["B._wadsworthia.K"]]
  r_C_aerofaciens <- flat_params[["C._aerofaciens.r"]]
  K_C_aerofaciens <- flat_params[["C._aerofaciens.K"]]
  r_C_bolteae <- flat_params[["C._bolteae.r"]]
  K_C_bolteae <- flat_params[["C._bolteae.K"]]
  r_C_comes <- flat_params[["C._comes.r"]]
  K_C_comes <- flat_params[["C._comes.K"]]
  r_C_perfringens <- flat_params[["C._perfringens.r"]]
  K_C_perfringens <- flat_params[["C._perfringens.K"]]
  r_C_ramosum <- flat_params[["C._ramosum.r"]]
  K_C_ramosum <- flat_params[["C._ramosum.K"]]
  r_C_saccharolyticum <- flat_params[["C._saccharolyticum.r"]]
  K_C_saccharolyticum <- flat_params[["C._saccharolyticum.K"]]
  r_D_formicigenerans <- flat_params[["D._formicigenerans.r"]]
  K_D_formicigenerans <- flat_params[["D._formicigenerans.K"]]
  r_E_coli <- flat_params[["E._coli.r"]]
  K_E_coli <- flat_params[["E._coli.K"]]
  r_E_lenta <- flat_params[["E._lenta.r"]]
  K_E_lenta <- flat_params[["E._lenta.K"]]
  r_E_rectale <- flat_params[["E._rectale.r"]]
  K_E_rectale <- flat_params[["E._rectale.K"]]
  r_F_nucleatum <- flat_params[["F._nucleatum.r"]]
  K_F_nucleatum <- flat_params[["F._nucleatum.K"]]
  r_P_copri <- flat_params[["P._copri.r"]]
  K_P_copri <- flat_params[["P._copri.K"]]
  r_P_merdae <- flat_params[["P._merdae.r"]]
  K_P_merdae <- flat_params[["P._merdae.K"]]
  r_R_gnavus <- flat_params[["R._gnavus.r"]]
  K_R_gnavus <- flat_params[["R._gnavus.K"]]
  r_R_intestinalis <- flat_params[["R._intestinalis.r"]]
  K_R_intestinalis <- flat_params[["R._intestinalis.K"]]
  r_V_parvula <- flat_params[["V._parvula.r"]]
  K_V_parvula <- flat_params[["V._parvula.K"]]
  r_A_muciniphila <- flat_params[["A._muciniphila.r"]]
  K_A_muciniphila <- flat_params[["A._muciniphila.K"]]
  r_B_adolescentis <- flat_params[["B._adolescentis.r"]]
  K_B_adolescentis <- flat_params[["B._adolescentis.K"]]
  r_B_obeum <- flat_params[["B._obeum.r"]]
  K_B_obeum <- flat_params[["B._obeum.K"]]
  r_O_splanchnicus <- flat_params[["O._splanchnicus.r"]]
  K_O_splanchnicus <- flat_params[["O._splanchnicus.K"]]
  r_P_distasonis <- flat_params[["P._distasonis.r"]]
  K_P_distasonis <- flat_params[["P._distasonis.K"]]
  r_R_bromii <- flat_params[["R._bromii.r"]]
  K_R_bromii <- flat_params[["R._bromii.K"]]
  r_R_torques <- flat_params[["R._torques.r"]]
  K_R_torques <- flat_params[["R._torques.K"]]
  r_S_parasanguinis <- flat_params[["S._parasanguinis.r"]]
  K_S_parasanguinis <-flat_params[["S._parasanguinis.K"]]
  r_S_salivarius <- flat_params[["S._salivarius.r"]]
  K_S_salivarius <- flat_params[["S._salivarius.K"]]
  r_L_paracasei <- flat_params[["L._paracasei.r"]]
  K_L_paracasei <- flat_params[["L._paracasei.K"]]
  
  
  t_mod <- ifelse(t > 24.1, t - 24.1, t)
  
  
  ## now code the model equations
  dA_muciniphila_dt <- r_A_muciniphila * A_muciniphila * (1 - A_muciniphila / K_A_muciniphila)
  dB_adolescentis_dt <- r_B_adolescentis * B_adolescentis * (1 - B_adolescentis / K_B_adolescentis)
  dB_fragilis_dt <- r_B_fragilis * B_fragilis * (1 - B_fragilis / max(0.0001, K_B_fragilis * (y_function_B_fragilis_Oxolinic_acid_func(Drug))))
  dB_longum_dt <- r_B_longum * B_longum * (1 - B_longum / K_B_longum)
  dB_obeum_dt <- r_B_obeum * B_obeum * (1 - B_obeum / K_B_obeum)
  dB_thetaiotaomicron_dt <- r_B_thetaiotaomicron * B_thetaiotaomicron * (1 - B_thetaiotaomicron / max(0.0001, K_B_thetaiotaomicron * (y_function_B_thetaiotaomicron_Oxolinic_acid_func(Drug))))  
  dB_uniformis_dt <- r_B_uniformis * B_uniformis * (1 - B_uniformis / max(0.0001, K_B_uniformis * (y_function_B_uniformis_Oxolinic_acid_func(Drug))))
  dB_vulgatus_dt <- r_B_vulgatus * B_vulgatus * (1 - B_vulgatus / max(0.0001, K_B_vulgatus * (y_function_B_vulgatus_Oxolinic_acid_func(Drug))))
  dB_wadsworthia_dt <- r_B_wadsworthia * B_wadsworthia * (1 - B_wadsworthia / K_B_wadsworthia)
  dC_aerofaciens_dt <- r_C_aerofaciens * C_aerofaciens * (1 - C_aerofaciens / max(0.0001, K_C_aerofaciens * (y_function_C_aerofaciens_Oxolinic_acid_func(Drug))))
  dC_bolteae_dt <- r_C_bolteae * C_bolteae * (1 - C_bolteae /  max(0.0001, K_C_bolteae * (y_function_C_bolteae_Oxolinic_acid_func(Drug))))
  dC_comes_dt <- r_C_comes * C_comes * (1 - C_comes / max(0.0001, K_C_comes * (y_function_C_comes_Oxolinic_acid_func(Drug))))
  dC_perfringens_dt <- r_C_perfringens * C_perfringens * (1 - C_perfringens / max(0.0001, K_C_perfringens * (y_function_C_perfringens_Oxolinic_acid_func(Drug))))
  dC_ramosum_dt <- r_C_ramosum * C_ramosum * (1 - C_ramosum / max(0.0001, K_C_ramosum * (y_function_C_ramosum_Oxolinic_acid_func(Drug))))
  dC_saccharolyticum_dt <- r_C_saccharolyticum * C_saccharolyticum * (1 - C_saccharolyticum / max(0.0001, K_C_saccharolyticum * (y_function_C_saccharolyticum_Oxolinic_acid_func(Drug))))
  dD_formicigenerans_dt <- r_D_formicigenerans * D_formicigenerans * (1 - D_formicigenerans / max(0.0001, K_D_formicigenerans * (y_function_D_formicigenerans_Oxolinic_acid_func(Drug))))
  dE_coli_dt <- r_E_coli * E_coli * (1 - E_coli / max(0.0001, K_E_coli * (y_function_E_coli_Oxolinic_acid_func(Drug))))
  dE_lenta_dt <- r_E_lenta * E_lenta * (1 - E_lenta / max(0.0001, K_E_lenta * (y_function_E_lenta_Oxolinic_acid_func(Drug))))
  dE_rectale_dt <- r_E_rectale * E_rectale * (1 - E_rectale / max(0.0001, K_E_rectale * (y_function_E_rectale_Oxolinic_acid_func(Drug))))
  dF_nucleatum_dt <- r_F_nucleatum * F_nucleatum * (1 - F_nucleatum / max(0.0001, K_F_nucleatum * (y_function_F_nucleatum_Oxolinic_acid_func(Drug))))
  dL_paracasei_dt <- r_L_paracasei * L_paracasei * (1 - L_paracasei / K_L_paracasei)  
  dO_splanchnicus_dt <- r_O_splanchnicus * O_splanchnicus * (1 - O_splanchnicus / K_O_splanchnicus)  
  dP_copri_dt <- r_P_copri * P_copri * (1 - P_copri / K_P_copri)
  dP_distasonis_dt <- r_P_distasonis * P_distasonis * (1 - P_distasonis / K_P_distasonis)  
  dP_merdae_dt <- r_P_merdae * P_merdae * (1 - P_merdae / max(0.0001, K_P_merdae * (y_function_P_merdae_Oxolinic_acid_func(Drug))))
  dR_bromii_dt <- r_R_bromii * R_bromii * (1 - R_bromii / K_R_bromii) 
  dR_gnavus_dt <- r_R_gnavus * R_gnavus * (1 - R_gnavus / max(0.0001, K_R_gnavus * (y_function_R_gnavus_Oxolinic_acid_func(Drug))))
  dR_intestinalis_dt <- r_R_intestinalis * R_intestinalis * (1 - R_intestinalis / max(0.0001, K_R_intestinalis * (y_function_R_intestinalis_Oxolinic_acid_func(Drug))))
  dR_torques_dt <- r_R_torques * R_torques * (1 - R_torques /K_R_torques) 
  dS_parasanguinis_dt <- r_S_parasanguinis * S_parasanguinis * (1 - S_parasanguinis / max(0.0001, K_S_parasanguinis * (y_function_S_parasanguinis_Oxolinic_acid_func(Drug))))
  dS_salivarius_dt <- r_S_salivarius * S_salivarius * (1 - S_salivarius / max(0.0001, K_S_salivarius * (y_function_S_salivarius_Oxolinic_acid_func(Drug))))
  dV_parvula_dt <- r_V_parvula * V_parvula * (1 - V_parvula / max(0.0001, K_V_parvula * (y_function_V_parvula_Oxolinic_acid_func(Drug))))
  
  
  
  #Drug differential:
  dDrug_dt <- (subset(drug_dynamics, Drug == "Oxolinic acid")$Steepness_param_community * exp(-subset(drug_dynamics, Drug == "Oxolinic acid")$Steepness_param_community * t_mod)) * (drug_concentration_tested * prop_left_Oxolinic_acid - drug_concentration_tested)
  #dDrug_dt <- 0
  
  ## Combine results into a single vector
  dxdt <- c(dA_muciniphila_dt, dB_adolescentis_dt, dB_fragilis_dt, dB_longum_dt, dB_obeum_dt, dB_thetaiotaomicron_dt, dB_uniformis_dt, dB_vulgatus_dt, dB_wadsworthia_dt, dC_aerofaciens_dt, dC_bolteae_dt, dC_comes_dt, dC_perfringens_dt, dC_ramosum_dt, dC_saccharolyticum_dt, dD_formicigenerans_dt, dE_coli_dt, dE_lenta_dt, dE_rectale_dt, dF_nucleatum_dt, dL_paracasei_dt, dO_splanchnicus_dt, dP_copri_dt, dP_distasonis_dt, dP_merdae_dt, dR_bromii_dt, dR_gnavus_dt, dR_intestinalis_dt, dR_torques_dt, dS_parasanguinis_dt, dS_salivarius_dt, dV_parvula_dt, dDrug_dt)
  
  ## Return result as a list
  list(dxdt)
}




#calculate the co-culture correction factor per species based on community composition in absence of drug, just like done for Niclosamide

growth_data_all_0_Niclosamide
growth_data_all_0_Niclosamide1 <- growth_data_all_0_Niclosamide %>%
  dplyr::mutate(Species = gsub(" ", "_", Species))


# Merge rel_ab_control with growth_data_all_0_Niclosamide on Species
# Function to remove duplicated columns by name pattern
clean_columns_base <- function(df, pattern) {
  cols_to_keep <- !grepl(pattern, names(df))
  df <- df[, cols_to_keep]
  return(df)
}

# Use the new function to clean up your dataframe
rel_ab_control <- clean_columns_base(rel_ab_control, "mean_max_OD.[xy]")
str(rel_ab_control)


#rel_ab_control$correction_factor <- rel_ab_control$mean_rel_ab / (rel_ab_control$mean_max_OD/sum(rel_ab_control$mean_max_OD))
# Calculate correction factor with a minimum value of ~1
rel_ab_control$correction_factor <- pmax(rel_ab_control$mean_rel_ab / (rel_ab_control$mean_max_OD / sum(rel_ab_control$mean_max_OD)), 1.1)


# Create a new dataframe for co-culture correction
co_culture_correction <- data.frame(
  species = rel_ab_control$Species,
  correction_factor = rel_ab_control$correction_factor
)


#summarise community data
#Adjust based on tested concentrations for each drug
unique(Community_compositions_focus_drugs_Oxolinic_acid$concentration)

Community_compositions_focus_drugs_Oxolinic_acid_0.5uM <- subset(Community_compositions_focus_drugs_Oxolinic_acid, concentration == 0.5)
Community_compositions_focus_drugs_Oxolinic_acid_20uM <- subset(Community_compositions_focus_drugs_Oxolinic_acid, concentration == 20)
Community_compositions_focus_drugs_Oxolinic_acid_2.5uM <- subset(Community_compositions_focus_drugs_Oxolinic_acid, concentration == 2.5)


#0.5 uM
Community_compositions_focus_drugs_Oxolinic_acid_0.5uM_summarised <- Community_compositions_focus_drugs_Oxolinic_acid_0.5uM %>%
  dplyr::group_by(species) %>%                                  
  dplyr::summarize(
    mean_rel_ab = mean(rel_abundance, na.rm = TRUE),     
    sd_rel_ab = sd(rel_abundance, na.rm = TRUE) ,
    mean_max_OD = mean(maxOD, na.rm = TRUE),
    sd_max_OD = sd(maxOD, na.rm = TRUE),
    mean_final_OD = mean(finalOD, na.rm = TRUE),
    sd_final_OD = sd(finalOD, na.rm = TRUE)
  ) %>%
  dplyr::ungroup() 


Community_compositions_focus_drugs_Oxolinic_acid_0.5uM_summarised <- Community_compositions_focus_drugs_Oxolinic_acid_0.5uM_summarised %>%
  dplyr::mutate(Species = sub("^(\\w)\\w*\\s(.*)", "\\1._\\2", species))

#remove (sub)strain info
Community_compositions_focus_drugs_Oxolinic_acid_0.5uM_summarised <- Community_compositions_focus_drugs_Oxolinic_acid_0.5uM_summarised %>%
  dplyr::mutate(Species = sub("^(\\w\\._\\w+).*", "\\1", Species))


#20 uM
Community_compositions_focus_drugs_Oxolinic_acid_20uM_summarised <- Community_compositions_focus_drugs_Oxolinic_acid_20uM %>%
  dplyr::group_by(species) %>%                                  
  dplyr::summarize(
    mean_rel_ab = mean(rel_abundance, na.rm = TRUE),     
    sd_rel_ab = sd(rel_abundance, na.rm = TRUE) ,
    mean_max_OD = mean(maxOD, na.rm = TRUE),
    sd_max_OD = sd(maxOD, na.rm = TRUE),
    mean_final_OD = mean(finalOD, na.rm = TRUE),
    sd_final_OD = sd(finalOD, na.rm = TRUE)
  ) %>%
  dplyr::ungroup() 


Community_compositions_focus_drugs_Oxolinic_acid_20uM_summarised <- Community_compositions_focus_drugs_Oxolinic_acid_20uM_summarised %>%
  dplyr::mutate(Species = sub("^(\\w)\\w*\\s(.*)", "\\1._\\2", species))

#remove (sub)strain info
Community_compositions_focus_drugs_Oxolinic_acid_20uM_summarised <- Community_compositions_focus_drugs_Oxolinic_acid_20uM_summarised %>%
  dplyr::mutate(Species = sub("^(\\w\\._\\w+).*", "\\1", Species))


#2.5 uM
Community_compositions_focus_drugs_Oxolinic_acid_2.5uM_summarised <- Community_compositions_focus_drugs_Oxolinic_acid_2.5uM %>%
  dplyr::group_by(species) %>%                                  
  dplyr::summarize(
    mean_rel_ab = mean(rel_abundance, na.rm = TRUE),     
    sd_rel_ab = sd(rel_abundance, na.rm = TRUE) ,
    mean_max_OD = mean(maxOD, na.rm = TRUE),
    sd_max_OD = sd(maxOD, na.rm = TRUE),    
    mean_final_OD = mean(finalOD, na.rm = TRUE),
    sd_final_OD = sd(finalOD, na.rm = TRUE)
  ) %>%
  dplyr::ungroup() 



Community_compositions_focus_drugs_Oxolinic_acid_2.5uM_summarised <- Community_compositions_focus_drugs_Oxolinic_acid_2.5uM_summarised %>%
  dplyr::mutate(Species = sub("^(\\w)\\w*\\s(.*)", "\\1._\\2", species))

#remove (sub)strain info
Community_compositions_focus_drugs_Oxolinic_acid_2.5uM_summarised <- Community_compositions_focus_drugs_Oxolinic_acid_2.5uM_summarised %>%
  dplyr::mutate(Species = sub("^(\\w\\._\\w+).*", "\\1", Species))


#Initialise data frames
sim_output <- data.frame()
input_params_list <- list() #Use a list to collect parameters for each simulation

#number of simulations
num_sims <- 250


for (i in 1:num_sims) {
  tryCatch({
    # generate model parameters
    set.seed(i) #set a different seed for each simulation for variation
    params <- lapply(1:nrow(growth_data_all_0_Niclosamide), function(idx) {
      species_params <- growth_data_all_0_Niclosamide[idx, ]
      list(
        r = rnorm(1, mean = species_params$mean_max_Growth_rate, sd = species_params$sd_max_Growth_rate),
        K = rnorm(1, mean = species_params$mean_max_OD, sd = species_params$sd_max_OD)
      )
    })
    names(params) <- gsub(" ", "_", growth_data_all_0_Niclosamide$Species)
    flat_params <- unlist(params)
    names(flat_params) <- gsub("\\.\\d$", "", names(flat_params))
    
    #replace spaces with underscores to match formatting
    co_culture_correction$species <- gsub(" ", "_", co_culture_correction$species, fixed = TRUE)
    
    #replace the species-specific K parameters extracted from monoculture growth data 
    #with drawn relative abundance values at Niclosamide = 0, scaled to K
    rel_ab_control$Species <- gsub(" ", "_", rel_ab_control$Species)
    
    #Initialise an empty vector to store drawn values
    drawn_values <- numeric(nrow(rel_ab_control))
    
    #draw values from their respective distributions
    for (k in 1:nrow(rel_ab_control)) {
      species_name <- rel_ab_control$Species[k]
      drawn_value <- rnorm(1, mean = rel_ab_control$mean_rel_ab[k], sd = rel_ab_control$sd_rel_ab[k])
      drawn_values[k] <- max(drawn_value, 0)  # Ensure no negative values
    }
    
    #Normalise drawn relative abundance values so they sum to 1 (to reflect a 'true' relative abundance distribution)
    #this is needed so when we convert the values into OD units by multiplying with the drawn community maxOD,
    # the sum of K_i parameters and the drawn K are equal
    normalised_values <- drawn_values / sum(drawn_values)
    
    #Pull community maxOD (K) at 0 drugs from respective normal distribution:
    K <- rnorm(n = 1, mean = rel_ab_control$mean_com_max_OD[1], sd = rel_ab_control$sd_com_max_OD[1])
    
    # Assign these normalised values to their respective species' .K parameters
    for (k in 1:nrow(rel_ab_control)) {
      species_name <- rel_ab_control$Species[k]
      k_index <- grep(paste0("^", species_name, "\\.K$"), names(flat_params))
      
      if (length(k_index) > 0) {
        old_value <- flat_params[k_index]
        flat_params[k_index] <- (normalised_values[k] + 0.0001) * K #add small value in case drawn K_i is 0, which would cause issues with the solver
        cat(sprintf("Updated %s from %f to %f using normalised value %f scaled by K %f\n", names(flat_params)[k_index], old_value, flat_params[k_index], normalised_values[k], K))
      }
    }
    
    #Accounting for variation in drug degradation by community, with standard deviation of end concentration (at 10h) around the fitted predicted (relative) end concentration at 24h
    #prop_left_Oxolinic_acid <- abs(rnorm(1, (subset(drug_dynamics, Drug == "Oxolinic_acid")$Prop_left_24h_community), (subset(drug_dynamics, Drug == "Oxolinic_acid")$SD_drug_community))) 
    #below, we account for measurement error rather than ecological drivers that lead to the variability of degradation at the final point measured 
    prop_left_Oxolinic_acid <- abs(rnorm(
      n = 1, 
      mean = subset(drug_dynamics, Drug == "Oxolinic acid")$Prop_left_24h_community, 
      sd = ifelse(
        subset(drug_dynamics, Drug == "Oxolinic acid")$SD_drug_community > subset(drug_dynamics, Drug == "Oxolinic acid")$SD_drug_community_start, 
        subset(drug_dynamics, Drug == "Oxolinic acid")$SD_drug_community - subset(drug_dynamics, Drug == "Oxolinic acid")$SD_drug_community_start, 
        subset(drug_dynamics, Drug == "Oxolinic acid")$SD_drug_community
      )
    ))
    
    
    #loop through each species in co_culture_correction
    for (j in 1:nrow(co_culture_correction)) {
      # Extract the species name and correction factor
      species_name <- co_culture_correction$species[j]
      correction_factor <- co_culture_correction$correction_factor[j]
      
      # Identify the corresponding growth rate parameter in flat_params
      #by matching the base species name (without .r)
      growth_rate_indices <- grep(paste0("^", species_name, "\\.r$"), names(flat_params))
      
      #take the growth rate parameter and apply the correction factor 
      for (index in growth_rate_indices) {
        flat_params[index] <- flat_params[index] * correction_factor
      }
    }
    
    flat_params
    # Store parameters for each simulation
    input_params_list[[i]] <- c(sim_ID = i, flat_params)
    
    # Run the model for the first 24-hour cycle
    solution_cycle_1 <- ode(y = initial_conditions, times = seq(from = 0, to = 24, by = 0.1), func = closed.sir.model_Oxolinic_acid, parms = flat_params,   method = "lsoda", rtol = 1e-6, atol = 1e-6)
    
    # Dilution and second cycle
    end_of_cycle_1 <- solution_cycle_1[nrow(solution_cycle_1), -1]
    initial_conditions_cycle_2 <- end_of_cycle_1 / 50
    #accounting for the drugs being added with the new growth cycle as well:
    initial_conditions_cycle_2[33] <- initial_conditions_cycle_2[33] + drug_concentration_tested
    solution_cycle_2 <- ode(y = initial_conditions_cycle_2, times = seq(from = 24, to = 48, by = 0.1), func = closed.sir.model_Oxolinic_acid, parms = flat_params,  method = "lsoda", rtol = 1e-6, atol = 1e-6)
    
    # Combine and format results
    combined_solution <- rbind(as.data.frame(solution_cycle_1), as.data.frame(solution_cycle_2)[-1,])
    combined_solution$sim_ID <- rep(i, nrow(combined_solution))
    combined_solution <- combined_solution %>%
      tidyr::gather(key = "Species", value = "Density", -time, -sim_ID) %>%
      dplyr::mutate(Hour = time) %>%
      dplyr::select(sim_ID, Hour, Species, Density)
    
    ##Append to sim_output
    sim_output <- rbind(sim_output, combined_solution)
  }, error = function(e) {
    cat(sprintf("Skipping simulation %d due to an error: %s\n", i, e$message))
  })
}



##Combine all parameter data into a single dataframe
input_params <- do.call(rbind, input_params_list)

# Add a "Species" column 
sim_output$Species_name <- species_names[as.numeric(as.character(sim_output$Species))]
sim_output$Species_name <- replace_na(sim_output$Species_name, "Drug")

#View(input_params)
#View(sim_output)

sim_output <- na.omit(sim_output)
successful_sim_ids <- unique(subset(sim_output, Hour == 48)$sim_ID)
length(successful_sim_ids)
sim_output1 <- sim_output[sim_output$sim_ID %in% successful_sim_ids, ]


#Transform sim_output so we have wide format by Species
sim_output_wide <- tidyr::pivot_wider(sim_output1, 
                                      names_from = Species_name, 
                                      values_from = Density,
                                      id_cols = c(sim_ID, Hour))

length(unique(sim_output_wide$sim_ID))
#calc community OD per timepoint
sim_output_wide$Total_OD <- rowSums(sim_output_wide[, 3:34], na.rm = TRUE)
#calculate and add relative abundances here as well:
species_columns <- colnames(sim_output_wide)[3:34] 

for (species in species_columns) {
  sim_output_wide[[paste0("rel_", species)]] <- sim_output_wide[[species]] / sim_output_wide$Total_OD
}


#assign sim_output_wide test conditions to dataframe name
drug_tested <- "Oxolinic_acid"
variable_name_1 <- paste0("sim_output_wide_", ifelse(drug_concentration_tested == 1e-04, 0, drug_concentration_tested), "_", drug_tested)
assign(variable_name_1, sim_output_wide)

#turn back into long format if interested in plotting relative abundances
cols_needed <- c("sim_ID", "Hour")

sim_output_long <- sim_output_wide %>% 
  dplyr::select(sim_ID, Hour, Drug, starts_with("rel_")) %>% 
  tidyr::pivot_longer(
    cols = c(Drug, starts_with("rel_")),
    names_to = "Species", 
    values_to = "Relative_abundance",
    names_prefix = "rel_",
    names_transform = list(Species = ~ ifelse(.x == "Drug", "Drug", .x))
  ) 

str(sim_output_long)


species_names_1 <- c(
  "A_muciniphila",
  "B_adolescentis",
  "B_fragilis",
  "B_longum",
  "B_obeum",
  "B_thetaiotaomicron",
  "B_uniformis",
  "B_vulgatus",
  "B_wadsworthia",
  "C_aerofaciens",
  "C_bolteae",
  "C_comes",
  "C_perfringens",
  "C_ramosum",
  "C_saccharolyticum",
  "D_formicigenerans",
  "E_coli",
  "E_lenta",
  "E_rectale",
  "F_nucleatum",
  "L_paracasei",
  "O_splanchnicus",
  "P_copri",
  "P_distasonis",
  "P_merdae",
  "R_bromii",
  "R_gnavus",
  "R_intestinalis",
  "R_torques",
  "S_parasanguinis",
  "S_salivarius",
  "V_parvula",
  "Drug"
)

species_colours_1 <- c(
  "A_muciniphila" = "#1f77b4",
  "B_adolescentis" = "#ff7f0e",
  "B_fragilis" = "#2ca02c",
  "B_longum" = "#d62728",
  "B_obeum" = "#9467bd",
  "B_thetaiotaomicron" = "black",
  "B_uniformis" = "#e377c2",
  "B_vulgatus" = "#7f7f7f",
  "B_wadsworthia" = "gold1",
  "C_aerofaciens" = "#aec7e8",
  "C_bolteae" = "#ffbb78",
  "C_comes" = "magenta",
  "C_perfringens" = "#ff9896",
  "C_ramosum" = "#c5b0d5",
  "C_saccharolyticum" = "#c49c94",
  "D_formicigenerans" = "#f7b6d2",
  "E_coli" = "yellow",
  "E_lenta" = "turquoise",
  "E_rectale" = "#393b79",
  "F_nucleatum" = "royalblue2",
  "L_paracasei" = "blue",
  "O_splanchnicus" = "#637939",
  "P_copri" = "cyan",
  "P_distasonis" = "#8c6d31",
  "P_merdae" = "#c7c7c7",
  "R_bromii" = "#e6550d",
  "R_gnavus" = "#e7cb94",
  "R_intestinalis" = "#843c39",
  "R_torques" = "#d6616b",
  "S_parasanguinis" = "orange3",
  "S_salivarius" = "#7b4173",
  "V_parvula" = "#ce6dbd",
  "Drug" = "green"
)



##Plot output for any specific sim:
# ggplot(subset(sim_output, sim_ID == 1 & Species_name != "Drug"), aes(x = Hour, y = Density, group = Species_name, color = Species_name)) +
#   geom_line(size = 1, alpha = 0.7) +
#   scale_color_manual(values = species_colours_1) +
#   labs(title = paste0("Oxolinic_acid = ", drug_concentration_tested),
#        x = "Time (hours)",
#        y = "Population Density (OD)",
#        color = "Species") +
#   theme_minimal() +
#   theme(legend.position = "right")
# 
# ggplot(subset(sim_output, sim_ID == 3 & Species_name != "Drug"), aes(x = Hour, y = Density, group = Species_name, color = Species_name)) +
#   geom_line(size = 1, alpha = 0.7) +
#   scale_color_manual(values = species_colours_1) +
#   labs(title = paste0("Oxolinic_acid = ", drug_concentration_tested),
#        x = "Time (hours)",
#        y = "Population Density (OD)",
#        color = "Species") +
#   theme_minimal() +
#   theme(legend.position = "right")


ggplot(subset(sim_output_long, sim_ID == 1), aes(x = Hour, y = Relative_abundance, group = Species, color = Species)) +
  geom_line(size = 1, alpha = 0.7) +
  scale_color_manual(values = species_colours_1) +
  labs(title = paste0("Oxolinic_acid = ", drug_concentration_tested),
       x = "Time (hours)",
       y = "Relative abundance",
       color = "Species") +
  theme_minimal() +
  theme(legend.position = "right")


ggplot(subset(sim_output_long, sim_ID == 3), aes(x = Hour, y = Relative_abundance, group = Species, color = Species)) +
  geom_line(size = 1, alpha = 0.7) +
  scale_color_manual(values = species_colours_1) +
  labs(title = paste0("Oxolinic_acid = ", drug_concentration_tested),
       x = "Time (hours)",
       y = "Relative abundance",
       color = "Species") +
  theme_minimal() +
  theme(legend.position = "right")


#calc mean and standard deviation across sims
sim_stats <- sim_output_long %>%
  dplyr::group_by(Hour, Species) %>%
  dplyr::summarise(
    mean_rel_ab = mean(Relative_abundance),
    sd_rel_ab = sd(Relative_abundance),
    .groups = 'drop'
  )

# Prepare the data for plotting
plot_data <- sim_stats %>%
  dplyr::mutate(Upper = mean_rel_ab + sd_rel_ab, Lower = mean_rel_ab - sd_rel_ab)

ggplot(subset(plot_data, Species != "Drug"), aes(x = Hour, y = mean_rel_ab, group = Species, color = Species)) +
  geom_ribbon(aes(ymin = Lower, ymax = Upper, fill = Species), colour = NA, alpha = 0.2) +  
  geom_line(size = 1, alpha = 0.7) + 
  scale_color_manual(values = species_colours_1) +
  scale_fill_manual(values = species_colours_1) +  
  labs(title = "Mean and SD of Relative Abundance Across Simulations",
       subtitle = paste0("Oxolinic_acid = ", drug_concentration_tested),       
       x = "Time (hours)",
       y = "Relative abundance",
       color = "Species",
       fill = "Species") +
  theme_minimal() +
  theme(legend.position = "right")

#log-scaled mean trends
ggplot(plot_data, aes(x = Hour, y = log10(mean_rel_ab + 0.0001), group = Species, color = Species)) +
  geom_line(size = 1, alpha = 0.7) +  # Mean line
  scale_color_manual(values = species_colours_1) +
  scale_fill_manual(values = species_colours_1) +  # Ensure consistent colors for lines and fills
  labs(title = "Mean and SD of Relative Abundance Across Simulations",
       subtitle = paste0("Oxolinic_acid = ", drug_concentration_tested),
       x = "Time (hours)",
       y = "Relative abundance",
       color = "Species",
       fill = "Species") +
  theme_minimal() +
  theme(legend.position = "right")




##prediction quality evaluation
drug_tested <- "Oxolinic_acid"
variable_name <- paste0("plot_data_", ifelse(drug_concentration_tested == 1e-04, 0, drug_concentration_tested), "_", drug_tested)
assign(variable_name, plot_data)


#extract total OD info:
predicted_mean_final_od_NULL <- Niclosamide_16S_0uM_summarised$mean_com_final_OD[1]
predicted_sd_final_od_NULL <- Niclosamide_16S_0uM_summarised$sd_com_final_OD[1]

predicted_mean_final_od_0.5_Oxolinic_acid <- mean(subset(sim_output_wide_0.5_Oxolinic_acid, Hour == 48)$Total_OD, na.rm = TRUE)
predicted_sd_final_od_0.5_Oxolinic_acid <- sd(subset(sim_output_wide_0.5_Oxolinic_acid, Hour == 48)$Total_OD, na.rm = TRUE)

real_mean_final_od_0.5_Oxolinic_acid <- Community_compositions_focus_drugs_Oxolinic_acid_0.5uM_summarised$mean_final_OD[1]
real_sd_final_od_0.5_Oxolinic_acid <- Community_compositions_focus_drugs_Oxolinic_acid_0.5uM_summarised$sd_final_OD[1]


predicted_mean_final_od_20_Oxolinic_acid <- mean(subset(sim_output_wide_20_Oxolinic_acid, Hour == 48)$Total_OD, na.rm = TRUE)
predicted_sd_final_od_20_Oxolinic_acid <- sd(subset(sim_output_wide_20_Oxolinic_acid, Hour == 48)$Total_OD, na.rm = TRUE)

real_mean_final_od_20_Oxolinic_acid <- Community_compositions_focus_drugs_Oxolinic_acid_20uM_summarised$mean_final_OD[1]
real_sd_final_od_20_Oxolinic_acid <- Community_compositions_focus_drugs_Oxolinic_acid_20uM_summarised$sd_final_OD[1]


predicted_mean_final_od_2.5_Oxolinic_acid <- mean(subset(sim_output_wide_2.5_Oxolinic_acid, Hour == 48)$Total_OD, na.rm = TRUE)
predicted_sd_final_od_2.5_Oxolinic_acid <- sd(subset(sim_output_wide_2.5_Oxolinic_acid, Hour == 48)$Total_OD, na.rm = TRUE)

real_mean_final_od_2.5_Oxolinic_acid <- Community_compositions_focus_drugs_Oxolinic_acid_2.5uM_summarised$mean_final_OD[1]
real_sd_final_od_2.5_Oxolinic_acid <- Community_compositions_focus_drugs_Oxolinic_acid_2.5uM_summarised$sd_final_OD[1]




#plot_data_0_Oxolinic_acid_endpoint was used to test model performance at 0 drugs
#plot_data_0_Oxolinic_acid_endpoint <- subset(plot_data_0_Oxolinic_acid, Hour == 48 & Species != "Drug")
plot_data_0.5_Oxolinic_acid_endpoint <- subset(plot_data_0.5_Oxolinic_acid, Hour == 48 & Species != "Drug")
plot_data_20_Oxolinic_acid_endpoint <- subset(plot_data_20_Oxolinic_acid, Hour == 48 & Species != "Drug")
plot_data_2.5_Oxolinic_acid_endpoint <- subset(plot_data_2.5_Oxolinic_acid, Hour == 48 & Species != "Drug")

##Inspecting 'match' to real relative abundance distributions:
Niclosamide_16S_0uM_summarised <- rel_ab_control
Niclosamide_16S_0uM_summarised$Species <- gsub("\\.", "", Niclosamide_16S_0uM_summarised$Species)

Oxolinic_acid_16S_0.5uM_summarised <- Community_compositions_focus_drugs_Oxolinic_acid_0.5uM_summarised
Oxolinic_acid_16S_20uM_summarised <- Community_compositions_focus_drugs_Oxolinic_acid_20uM_summarised
Oxolinic_acid_16S_2.5uM_summarised <- Community_compositions_focus_drugs_Oxolinic_acid_2.5uM_summarised

Niclosamide_16S_0uM_summarised
Oxolinic_acid_16S_0.5uM_summarised 
Oxolinic_acid_16S_20uM_summarised 
Oxolinic_acid_16S_2.5uM_summarised 

#Rename 'species' so the outputs become comparable
original_names_2.5 <- unique(Oxolinic_acid_16S_2.5uM_summarised$species)
original_names_20 <- unique(Oxolinic_acid_16S_20uM_summarised$species)
original_names_0.5 <- unique(Oxolinic_acid_16S_0.5uM_summarised$species)


##Create a named vector with the original and new names mapping
name_changes <- c(
  "Akkermansia muciniphila" = "A_muciniphila",
  "Bacteroides fragilis" = "B_fragilis",
  "Bacteroides thetaiotaomicron" = "B_thetaiotaomicron",
  "Bacteroides uniformis" = "B_uniformis",
  "Bifidobacterium adolescentis" = "B_adolescentis",
  "Bifidobacterium longum subsp. longum" = "B_longum",
  "Bilophila wadsworthia" = "B_wadsworthia",
  "Blautia obeum" = "B_obeum",
  "Clostridium perfringens" = "C_perfringens",
  "Collinsella aerofaciens" = "C_aerofaciens",
  "Coprococcus comes" = "C_comes",
  "Dorea formicigenerans" = "D_formicigenerans",
  "Eggerthella lenta" = "E_lenta",
  "Enterocloster bolteae" = "C_bolteae",
  "Erysipelatoclostridium ramosum" = "C_ramosum",
  "Escherichia coli ED1a" = "E_coli",
  "Eubacterium rectale" = "E_rectale",
  "Fusobacterium nucleatum subsp. nucleatum" = "F_nucleatum",
  "Lacrimispora saccharolytica" = "C_saccharolyticum",
  "Lacticaseibacillus paracasei" = "L_paracasei",
  "Odoribacter splanchnicus" = "O_splanchnicus",
  "Parabacteroides distasonis" = "P_distasonis",
  "Parabacteroides merdae" = "P_merdae",
  "Phocaeicola vulgatus" = "B_vulgatus",
  "Prevotella copri" = "P_copri",
  "Roseburia intestinalis" = "R_intestinalis",
  "Ruminococcus bromii" = "R_bromii",
  "Ruminococcus gnavus" = "R_gnavus",
  "Ruminococcus torques" = "R_torques",
  "Streptococcus parasanguinis" = "S_parasanguinis",
  "Streptococcus salivarius" = "S_salivarius",
  "Veillonella parvula" = "V_parvula"
)

# Apply name changes to the species column in Oxolinic_acid_16S_2.5uM_summarised

Oxolinic_acid_16S_2.5uM_summarised$Species <- name_changes[Oxolinic_acid_16S_2.5uM_summarised$species]
Oxolinic_acid_16S_20uM_summarised$Species <- name_changes[Oxolinic_acid_16S_20uM_summarised$species]
Oxolinic_acid_16S_0.5uM_summarised$Species <- name_changes[Oxolinic_acid_16S_0.5uM_summarised$species]

# Verify the changes
unique(Oxolinic_acid_16S_2.5uM_summarised$Species)
unique(Oxolinic_acid_16S_20uM_summarised$Species)
unique(Oxolinic_acid_16S_0.5uM_summarised$Species)



##First, for 0.5 uM:
# Get top 6 species from plot_data_0.5_endpoint
# Adjust the plot_data_0.5_endpoint with confidence bounds

# #plot_data_0_Oxolinic_acid_endpoint was used to test model performance at 0 drugs
# plot_data_0_Oxolinic_acid_endpoint <- plot_data_0_Oxolinic_acid_endpoint %>%
#   dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)

plot_data_0.5_Oxolinic_acid_endpoint <- plot_data_0.5_Oxolinic_acid_endpoint %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)

# Adjust the Oxolinic_acid_16S_0.5uM_summarised with confidence bounds
Oxolinic_acid_16S_0.5uM_summarised <- Oxolinic_acid_16S_0.5uM_summarised %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)

#NULL model:
Null_model_summarised <- Niclosamide_16S_0uM_summarised %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)


# Get top 6 species based on the lower bound from plot_data_0.5_endpoint

#top6_predicted_0_Oxolinic_acid was used to test model performance at 0 drugs
# top6_predicted_0_Oxolinic_acid <- plot_data_0_Oxolinic_acid_endpoint %>%
#    arrange(desc(lower_bound)) %>%
#    slice(1:6) %>%
#    pull(Species)

top6_predicted_0.5_Oxolinic_acid <- plot_data_0.5_Oxolinic_acid_endpoint %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

# Get top 6 species based on the lower bound from Oxolinic_acid_16S_0.5uM_summarised
top6_real_0.5_Oxolinic_acid <- Oxolinic_acid_16S_0.5uM_summarised %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

top6_NULL <- Null_model_summarised %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

# Calculate the overlap of top 6 species

#top_six_correct_0_Oxolinic_acid was used to assess model performance at 0 drugs
# top_six_correct_0_Oxolinic_acid <- length(intersect(top6_predicted_0_Oxolinic_acid, top6_NULL))
# top_six_correct_0_Oxolinic_acid

top_six_correct_0.5_Oxolinic_acid <- length(intersect(top6_predicted_0.5_Oxolinic_acid, top6_real_0.5_Oxolinic_acid))
top_six_correct_0.5_Oxolinic_acid

top_six_correct_0.5_Oxolinic_acid_NULL <- length(intersect(top6_NULL, top6_real_0.5_Oxolinic_acid))
top_six_correct_0.5_Oxolinic_acid_NULL

top6_predicted_0.5_Oxolinic_acid
top6_real_0.5_Oxolinic_acid

#top6_NULL

#Now by means:
# #top6_predicted_0_Oxolinic_acid_means was used to assess model performance at 0 drugs
# top6_predicted_0_Oxolinic_acid_means <- plot_data_0_Oxolinic_acid_endpoint %>%
#    arrange(desc(mean_rel_ab)) %>%
#    slice(1:6) %>%
#    pull(Species)

top6_predicted_0.5_Oxolinic_acid_means <- plot_data_0.5_Oxolinic_acid_endpoint %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)

# Get top 6 species based on the lower bound from Oxolinic_acid_16S_0.5uM_summarised
top6_real_0.5_Oxolinic_acid_means <- Oxolinic_acid_16S_0.5uM_summarised %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)

top6_NULL_means <- Null_model_summarised %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)


# #top_six_correct_0_Oxolinic_acid_means was used to assess model performance at 0 drugs
# top_six_correct_0_Oxolinic_acid_means <- length(intersect(top6_predicted_0_Oxolinic_acid_means, top6_NULL_means))
# top_six_correct_0_Oxolinic_acid_means

top_six_correct_0.5_Oxolinic_acid_means <- length(intersect(top6_predicted_0.5_Oxolinic_acid_means, top6_real_0.5_Oxolinic_acid_means))
top_six_correct_0.5_Oxolinic_acid_means

top_six_correct_0.5_Oxolinic_acid_means_NULL <- length(intersect(top6_NULL_means, top6_real_0.5_Oxolinic_acid_means))
top_six_correct_0.5_Oxolinic_acid_means_NULL

top6_predicted_0.5_Oxolinic_acid_means
top6_real_0.5_Oxolinic_acid_means

#top6_NULL_means


# Merge dataframes by Species

#merged_data_0_Oxolinic_acid was used to assess model performance at 0 drugs
#merged_data_0_Oxolinic_acid <- merge(plot_data_0_Oxolinic_acid_endpoint, Niclosamide_16S_0uM_summarised, by = "Species", suffixes = c(".pred", ".real"))
merged_data_0.5_Oxolinic_acid <- merge(plot_data_0.5_Oxolinic_acid_endpoint, Oxolinic_acid_16S_0.5uM_summarised, by = "Species", suffixes = c(".pred", ".real"))
merged_data_0.5_Oxolinic_acid_NULL <- merge(Niclosamide_16S_0uM_summarised, Oxolinic_acid_16S_0.5uM_summarised, by = "Species", suffixes = c(".null", ".real"))


## Below lines used for assessing model performance at 0 drugs; ignore for nonzero concentrations
# # Create lower and upper bounds considering mean ¬± sd
# merged_data_0_Oxolinic_acid$lower_bound_pred <- merged_data_0_Oxolinic_acid$mean_rel_ab.pred - merged_data_0_Oxolinic_acid$sd_rel_ab.pred
# merged_data_0_Oxolinic_acid$upper_bound_pred <- merged_data_0_Oxolinic_acid$mean_rel_ab.pred + merged_data_0_Oxolinic_acid$sd_rel_ab.pred
# merged_data_0_Oxolinic_acid$lower_bound_real <- merged_data_0_Oxolinic_acid$mean_rel_ab.real - merged_data_0_Oxolinic_acid$sd_rel_ab.real
# merged_data_0_Oxolinic_acid$upper_bound_real <- merged_data_0_Oxolinic_acid$mean_rel_ab.real + merged_data_0_Oxolinic_acid$sd_rel_ab.real
# 
# # Ensure lower and upper bounds are non-negative, adjusting as necessary
# merged_data_0_Oxolinic_acid$lower_bound_pred[merged_data_0_Oxolinic_acid$lower_bound_pred <= 0] <- 1e-10
# merged_data_0_Oxolinic_acid$lower_bound_real[merged_data_0_Oxolinic_acid$lower_bound_real <= 0] <- 1e-10
# merged_data_0_Oxolinic_acid$upper_bound_pred[merged_data_0_Oxolinic_acid$upper_bound_pred <= 0] <- 1e-10
# merged_data_0_Oxolinic_acid$upper_bound_real[merged_data_0_Oxolinic_acid$upper_bound_real <= 0] <- 1e-10


# Create lower and upper bounds considering mean ¬± sd
merged_data_0.5_Oxolinic_acid$lower_bound_pred <- merged_data_0.5_Oxolinic_acid$mean_rel_ab.pred - merged_data_0.5_Oxolinic_acid$sd_rel_ab.pred
merged_data_0.5_Oxolinic_acid$upper_bound_pred <- merged_data_0.5_Oxolinic_acid$mean_rel_ab.pred + merged_data_0.5_Oxolinic_acid$sd_rel_ab.pred
merged_data_0.5_Oxolinic_acid$lower_bound_real <- merged_data_0.5_Oxolinic_acid$mean_rel_ab.real - merged_data_0.5_Oxolinic_acid$sd_rel_ab.real
merged_data_0.5_Oxolinic_acid$upper_bound_real <- merged_data_0.5_Oxolinic_acid$mean_rel_ab.real + merged_data_0.5_Oxolinic_acid$sd_rel_ab.real

# Ensure lower and upper bounds are non-negative, adjusting as necessary
merged_data_0.5_Oxolinic_acid$lower_bound_pred[merged_data_0.5_Oxolinic_acid$lower_bound_pred <= 0] <- 1e-10
merged_data_0.5_Oxolinic_acid$lower_bound_real[merged_data_0.5_Oxolinic_acid$lower_bound_real <= 0] <- 1e-10
merged_data_0.5_Oxolinic_acid$upper_bound_pred[merged_data_0.5_Oxolinic_acid$upper_bound_pred <= 0] <- 1e-10
merged_data_0.5_Oxolinic_acid$upper_bound_real[merged_data_0.5_Oxolinic_acid$upper_bound_real <= 0] <- 1e-10

##and for NULL model:
# Create lower and upper bounds considering mean ¬± sd
merged_data_0.5_Oxolinic_acid_NULL$lower_bound_null <- merged_data_0.5_Oxolinic_acid_NULL$mean_rel_ab.null - merged_data_0.5_Oxolinic_acid_NULL$sd_rel_ab.null
merged_data_0.5_Oxolinic_acid_NULL$upper_bound_null <- merged_data_0.5_Oxolinic_acid_NULL$mean_rel_ab.null + merged_data_0.5_Oxolinic_acid_NULL$sd_rel_ab.null
merged_data_0.5_Oxolinic_acid_NULL$lower_bound_real <- merged_data_0.5_Oxolinic_acid_NULL$mean_rel_ab.real - merged_data_0.5_Oxolinic_acid_NULL$sd_rel_ab.real
merged_data_0.5_Oxolinic_acid_NULL$upper_bound_real <- merged_data_0.5_Oxolinic_acid_NULL$mean_rel_ab.real + merged_data_0.5_Oxolinic_acid_NULL$sd_rel_ab.real

# Ensure lower and upper bounds are non-negative, adjusting as necessary
merged_data_0.5_Oxolinic_acid_NULL$lower_bound_null[merged_data_0.5_Oxolinic_acid_NULL$lower_bound_null <= 0] <- 1e-10
merged_data_0.5_Oxolinic_acid_NULL$lower_bound_real[merged_data_0.5_Oxolinic_acid_NULL$lower_bound_real <= 0] <- 1e-10
merged_data_0.5_Oxolinic_acid_NULL$upper_bound_null[merged_data_0.5_Oxolinic_acid_NULL$upper_bound_null <= 0] <- 1e-10
merged_data_0.5_Oxolinic_acid_NULL$upper_bound_real[merged_data_0.5_Oxolinic_acid_NULL$upper_bound_real <= 0] <- 1e-10

# Filter to include only species with a mean relative abundance > 0.01 in the 'real' dataset

## significant_species_0 was used to assess model performance at 0 drugs
#significant_species_0 <- merged_data_0_Oxolinic_acid[merged_data_0_Oxolinic_acid$mean_rel_ab.real > 0.01, ]
significant_species <- merged_data_0.5_Oxolinic_acid[merged_data_0.5_Oxolinic_acid$mean_rel_ab.real > 0.01, ]
survivors_0.5_Oxolinic_acid <- nrow(significant_species)
survivors_0.5_Oxolinic_acid

#should be the same as survivors defined above, since it is calculated from .real
significant_species_NULL <- merged_data_0.5_Oxolinic_acid_NULL[merged_data_0.5_Oxolinic_acid_NULL$mean_rel_ab.real > 0.01, ]
survivors_0.5_Oxolinic_acid_NULL <- nrow(significant_species_NULL)
survivors_0.5_Oxolinic_acid_NULL

# Adjusted order of magnitude check to include SD, only for significant species
## below code was used to assess model performance at 0 drugs
# significant_species_0$Predicted_magnitude_correct <- ifelse(
#   (floor(log10(significant_species_0$lower_bound_pred)) <= floor(log10(significant_species_0$upper_bound_real)) &
#      floor(log10(significant_species_0$upper_bound_pred)) >= floor(log10(significant_species_0$lower_bound_real))),
#   1,
#   0
# )

significant_species$Predicted_magnitude_correct <- ifelse(
  (floor(log10(significant_species$lower_bound_pred)) <= floor(log10(significant_species$upper_bound_real)) &
     floor(log10(significant_species$upper_bound_pred)) >= floor(log10(significant_species$lower_bound_real))),
  1,
  0
)

#and for the Null model:
significant_species_NULL$Predicted_magnitude_correct <- ifelse(
  (floor(log10(significant_species_NULL$lower_bound_null)) <= floor(log10(significant_species_NULL$upper_bound_real)) &
     floor(log10(significant_species_NULL$upper_bound_null)) >= floor(log10(significant_species_NULL$lower_bound_real))),
  1,
  0
)

# Calculate the fraction of correctly predicted magnitudes for significant species
## below code was used to assess model performance at 0 drugs
#predicted_magnitude_correct_fraction_0_Oxolinic_acid <- sum(significant_species_0$Predicted_magnitude_correct) / nrow(significant_species_0)
#predicted_magnitude_correct_fraction_0_Oxolinic_acid

predicted_magnitude_correct_fraction_0.5_Oxolinic_acid <- sum(significant_species$Predicted_magnitude_correct) / nrow(significant_species)
predicted_magnitude_correct_fraction_0.5_Oxolinic_acid

predicted_magnitude_correct_fraction_0.5_Oxolinic_acid_NULL <- sum(significant_species_NULL$Predicted_magnitude_correct) / nrow(significant_species_NULL)
predicted_magnitude_correct_fraction_0.5_Oxolinic_acid_NULL

top_species_missing_0.5_Oxolinic_acid <- setdiff(top6_real_0.5_Oxolinic_acid_means, top6_predicted_0.5_Oxolinic_acid_means)
top_species_wrong_0.5_Oxolinic_acid <- setdiff(top6_predicted_0.5_Oxolinic_acid_means, top6_real_0.5_Oxolinic_acid_means)

top_species_missing_0.5_Oxolinic_acid <- if(length(top_species_missing_0.5_Oxolinic_acid) == 0) "None" else top_species_missing_0.5_Oxolinic_acid
top_species_wrong_0.5_Oxolinic_acid <- if(length(top_species_wrong_0.5_Oxolinic_acid) == 0) "None" else top_species_wrong_0.5_Oxolinic_acid

Prediction_quality_0.5_Oxolinic_acid <- data.frame(
  Top_six_correct = paste(top_six_correct_0.5_Oxolinic_acid, sep=""),
  Top_six_correct_NULL = paste(top_six_correct_0.5_Oxolinic_acid_NULL, sep=""),
  Top_six_correct_means = paste(top_six_correct_0.5_Oxolinic_acid_means, sep=""),
  Top_six_correct_means_NULL = paste(top_six_correct_0.5_Oxolinic_acid_means_NULL, sep=""),
  Predicted_magnitude_correct = paste(round(predicted_magnitude_correct_fraction_0.5_Oxolinic_acid * 100, 2), "%", sep=""),
  Predicted_magnitude_correct_NULL = paste(round(predicted_magnitude_correct_fraction_0.5_Oxolinic_acid_NULL * 100, 2), "%", sep=""),
  survivors_total = survivors_0.5_Oxolinic_acid,
  top_species_missing <- top_species_missing_0.5_Oxolinic_acid,
  top_species_wrong <- top_species_wrong_0.5_Oxolinic_acid, 
  predicted_mean_final_OD <- predicted_mean_final_od_0.5_Oxolinic_acid,
  real_mean_final_OD <- real_mean_final_od_0.5_Oxolinic_acid,
  sims_total = length(successful_sim_ids)
)



Prediction_quality_0.5_Oxolinic_acid



##Next, for 20 uM:
# Get top 6 species from plot_data_20_endpoint
# Adjust the plot_data_20_endpoint with confidence bounds
plot_data_20_Oxolinic_acid_endpoint <- plot_data_20_Oxolinic_acid_endpoint %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)

# Adjust the Oxolinic_acid_16S_20uM_summarised with confidence bounds
Oxolinic_acid_16S_20uM_summarised <- Oxolinic_acid_16S_20uM_summarised %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)

#NULL model:
Null_model_summarised <- Niclosamide_16S_0uM_summarised %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)


# Get top 6 species based on the lower bound from plot_data_20_endpoint
top6_predicted_20_Oxolinic_acid <- plot_data_20_Oxolinic_acid_endpoint %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

# Get top 6 species based on the lower bound from Oxolinic_acid_16S_20uM_summarised
top6_real_20_Oxolinic_acid <- Oxolinic_acid_16S_20uM_summarised %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

top6_NULL <- Null_model_summarised %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

# Calculate the overlap of top 6 species
top_six_correct_20_Oxolinic_acid <- length(intersect(top6_predicted_20_Oxolinic_acid, top6_real_20_Oxolinic_acid))
#top_six_correct_20_Oxolinic_acid

top_six_correct_20_Oxolinic_acid_NULL <- length(intersect(top6_NULL, top6_real_20_Oxolinic_acid))
#top_six_correct_20_Oxolinic_acid_NULL

#top6_predicted_20_Oxolinic_acid
#top6_real_20_Oxolinic_acid



#Now by means:
top6_predicted_20_Oxolinic_acid_means <- plot_data_20_Oxolinic_acid_endpoint %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)

# Get top 6 species based on the lower bound from Oxolinic_acid_16S_20uM_summarised
top6_real_20_Oxolinic_acid_means <- Oxolinic_acid_16S_20uM_summarised %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)

top6_NULL_means <- Null_model_summarised %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)



top_six_correct_20_Oxolinic_acid_means <- length(intersect(top6_predicted_20_Oxolinic_acid_means, top6_real_20_Oxolinic_acid_means))
#top_six_correct_20_Oxolinic_acid_means

top_six_correct_20_Oxolinic_acid_means_NULL <- length(intersect(top6_NULL_means, top6_real_20_Oxolinic_acid_means))
#top_six_correct_20_Oxolinic_acid_means_NULL

top6_predicted_20_Oxolinic_acid_means
#top6_real_20_Oxolinic_acid_means




# Merge dataframes by Species
merged_data_20_Oxolinic_acid <- merge(plot_data_20_Oxolinic_acid_endpoint, Oxolinic_acid_16S_20uM_summarised, by = "Species", suffixes = c(".pred", ".real"))
merged_data_20_Oxolinic_acid_NULL <- merge(Niclosamide_16S_0uM_summarised, Oxolinic_acid_16S_20uM_summarised, by = "Species", suffixes = c(".null", ".real"))



# Create lower and upper bounds considering mean ¬± sd
merged_data_20_Oxolinic_acid$lower_bound_pred <- merged_data_20_Oxolinic_acid$mean_rel_ab.pred - merged_data_20_Oxolinic_acid$sd_rel_ab.pred
merged_data_20_Oxolinic_acid$upper_bound_pred <- merged_data_20_Oxolinic_acid$mean_rel_ab.pred + merged_data_20_Oxolinic_acid$sd_rel_ab.pred
merged_data_20_Oxolinic_acid$lower_bound_real <- merged_data_20_Oxolinic_acid$mean_rel_ab.real - merged_data_20_Oxolinic_acid$sd_rel_ab.real
merged_data_20_Oxolinic_acid$upper_bound_real <- merged_data_20_Oxolinic_acid$mean_rel_ab.real + merged_data_20_Oxolinic_acid$sd_rel_ab.real

# Ensure lower and upper bounds are non-negative, adjusting as necessary
merged_data_20_Oxolinic_acid$lower_bound_pred[merged_data_20_Oxolinic_acid$lower_bound_pred <= 0] <- 1e-10
merged_data_20_Oxolinic_acid$lower_bound_real[merged_data_20_Oxolinic_acid$lower_bound_real <= 0] <- 1e-10
merged_data_20_Oxolinic_acid$upper_bound_pred[merged_data_20_Oxolinic_acid$upper_bound_pred <= 0] <- 1e-10
merged_data_20_Oxolinic_acid$upper_bound_real[merged_data_20_Oxolinic_acid$upper_bound_real <= 0] <- 1e-10

##and for NULL model:
# Create lower and upper bounds considering mean ¬± sd
merged_data_20_Oxolinic_acid_NULL$lower_bound_null <- merged_data_20_Oxolinic_acid_NULL$mean_rel_ab.null - merged_data_20_Oxolinic_acid_NULL$sd_rel_ab.null
merged_data_20_Oxolinic_acid_NULL$upper_bound_null <- merged_data_20_Oxolinic_acid_NULL$mean_rel_ab.null + merged_data_20_Oxolinic_acid_NULL$sd_rel_ab.null
merged_data_20_Oxolinic_acid_NULL$lower_bound_real <- merged_data_20_Oxolinic_acid_NULL$mean_rel_ab.real - merged_data_20_Oxolinic_acid_NULL$sd_rel_ab.real
merged_data_20_Oxolinic_acid_NULL$upper_bound_real <- merged_data_20_Oxolinic_acid_NULL$mean_rel_ab.real + merged_data_20_Oxolinic_acid_NULL$sd_rel_ab.real

# Ensure lower and upper bounds are non-negative, adjusting as necessary
merged_data_20_Oxolinic_acid_NULL$lower_bound_null[merged_data_20_Oxolinic_acid_NULL$lower_bound_null <= 0] <- 1e-10
merged_data_20_Oxolinic_acid_NULL$lower_bound_real[merged_data_20_Oxolinic_acid_NULL$lower_bound_real <= 0] <- 1e-10
merged_data_20_Oxolinic_acid_NULL$upper_bound_null[merged_data_20_Oxolinic_acid_NULL$upper_bound_null <= 0] <- 1e-10
merged_data_20_Oxolinic_acid_NULL$upper_bound_real[merged_data_20_Oxolinic_acid_NULL$upper_bound_real <= 0] <- 1e-10

# Filter to include only species with a mean relative abundance > 0.01 in the 'real' dataset
significant_species <- merged_data_20_Oxolinic_acid[merged_data_20_Oxolinic_acid$mean_rel_ab.real > 0.01, ]
survivors_20_Oxolinic_acid <- nrow(significant_species)
survivors_20_Oxolinic_acid

#should be the same as survivors defined above, since it is calculated from .real
significant_species_NULL <- merged_data_20_Oxolinic_acid_NULL[merged_data_20_Oxolinic_acid_NULL$mean_rel_ab.real > 0.01, ]
survivors_20_Oxolinic_acid_NULL <- nrow(significant_species_NULL)
survivors_20_Oxolinic_acid_NULL

# Adjusted order of magnitude check to include SD, only for significant species
significant_species$Predicted_magnitude_correct <- ifelse(
  (floor(log10(significant_species$lower_bound_pred)) <= floor(log10(significant_species$upper_bound_real)) &
     floor(log10(significant_species$upper_bound_pred)) >= floor(log10(significant_species$lower_bound_real))),
  1,
  0
)

#and for the Null model:
significant_species_NULL$Predicted_magnitude_correct <- ifelse(
  (floor(log10(significant_species_NULL$lower_bound_null)) <= floor(log10(significant_species_NULL$upper_bound_real)) &
     floor(log10(significant_species_NULL$upper_bound_null)) >= floor(log10(significant_species_NULL$lower_bound_real))),
  1,
  0
)

# Calculate the fraction of correctly predicted magnitudes for significant species
predicted_magnitude_correct_fraction_20_Oxolinic_acid <- sum(significant_species$Predicted_magnitude_correct) / nrow(significant_species)
predicted_magnitude_correct_fraction_20_Oxolinic_acid

predicted_magnitude_correct_fraction_20_Oxolinic_acid_NULL <- sum(significant_species_NULL$Predicted_magnitude_correct) / nrow(significant_species_NULL)
predicted_magnitude_correct_fraction_20_Oxolinic_acid_NULL

top_species_missing_20_Oxolinic_acid <- setdiff(top6_real_20_Oxolinic_acid_means, top6_predicted_20_Oxolinic_acid_means)
top_species_wrong_20_Oxolinic_acid <- setdiff(top6_predicted_20_Oxolinic_acid_means, top6_real_20_Oxolinic_acid_means)

Prediction_quality_20_Oxolinic_acid <- data.frame(
  Top_six_correct = paste(top_six_correct_20_Oxolinic_acid, sep=""),
  Top_six_correct_NULL = paste(top_six_correct_20_Oxolinic_acid_NULL, sep=""),
  Top_six_correct_means = paste(top_six_correct_20_Oxolinic_acid_means, sep=""),
  Top_six_correct_means_NULL = paste(top_six_correct_20_Oxolinic_acid_means_NULL, sep=""),
  Predicted_magnitude_correct = paste(round(predicted_magnitude_correct_fraction_20_Oxolinic_acid * 100, 2), "%", sep=""),
  Predicted_magnitude_correct_NULL = paste(round(predicted_magnitude_correct_fraction_20_Oxolinic_acid_NULL * 100, 2), "%", sep=""),
  survivors_total = survivors_20_Oxolinic_acid,
  top_species_missing <- top_species_missing_20_Oxolinic_acid,
  top_species_wrong <- top_species_wrong_20_Oxolinic_acid, 
  predicted_mean_final_OD <- predicted_mean_final_od_20_Oxolinic_acid,
  real_mean_final_OD <- real_mean_final_od_20_Oxolinic_acid,
  sims_total = length(successful_sim_ids)
)

Prediction_quality_20_Oxolinic_acid






##Next, for 2.5 uM:
# Get top 6 species from plot_data_2.5_endpoint
# Adjust the plot_data_2.5_endpoint with confidence bounds
plot_data_2.5_Oxolinic_acid_endpoint <- plot_data_2.5_Oxolinic_acid_endpoint %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)

# Adjust the Oxolinic_acid_16S_2.5uM_summarised with confidence bounds
Oxolinic_acid_16S_2.5uM_summarised <- Oxolinic_acid_16S_2.5uM_summarised %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)

#NULL model:
Null_model_summarised <- Niclosamide_16S_0uM_summarised %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)


# Get top 6 species based on the lower bound from plot_data_2.5_endpoint
top6_predicted_2.5_Oxolinic_acid <- plot_data_2.5_Oxolinic_acid_endpoint %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

# Get top 6 species based on the lower bound from Oxolinic_acid_16S_2.5uM_summarised
top6_real_2.5_Oxolinic_acid <- Oxolinic_acid_16S_2.5uM_summarised %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

top6_NULL <- Null_model_summarised %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

# Calculate the overlap of top 6 species
top_six_correct_2.5_Oxolinic_acid <- length(intersect(top6_predicted_2.5_Oxolinic_acid, top6_real_2.5_Oxolinic_acid))
#top_six_correct_2.5_Oxolinic_acid

top_six_correct_2.5_Oxolinic_acid_NULL <- length(intersect(top6_NULL, top6_real_2.5_Oxolinic_acid))
#top_six_correct_2.5_Oxolinic_acid_NULL

#top6_predicted_2.5_Oxolinic_acid
#top6_real_2.5_Oxolinic_acid




#Now by means:
top6_predicted_2.5_Oxolinic_acid_means <- plot_data_2.5_Oxolinic_acid_endpoint %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)

# Get top 6 species based on the lower bound from Oxolinic_acid_16S_2.5uM_summarised
top6_real_2.5_Oxolinic_acid_means <- Oxolinic_acid_16S_2.5uM_summarised %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)

top6_NULL_means <- Null_model_summarised %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)



top_six_correct_2.5_Oxolinic_acid_means <- length(intersect(top6_predicted_2.5_Oxolinic_acid_means, top6_real_2.5_Oxolinic_acid_means))
#top_six_correct_2.5_Oxolinic_acid_means

top_six_correct_2.5_Oxolinic_acid_means_NULL <- length(intersect(top6_NULL_means, top6_real_2.5_Oxolinic_acid_means))
#top_six_correct_2.5_Oxolinic_acid_means_NULL

#top6_predicted_2.5_Oxolinic_acid_means
#top6_real_2.5_Oxolinic_acid_means




# Merge dataframes by Species
merged_data_2.5_Oxolinic_acid <- merge(plot_data_2.5_Oxolinic_acid_endpoint, Oxolinic_acid_16S_2.5uM_summarised, by = "Species", suffixes = c(".pred", ".real"))
merged_data_2.5_Oxolinic_acid_NULL <- merge(Niclosamide_16S_0uM_summarised, Oxolinic_acid_16S_2.5uM_summarised, by = "Species", suffixes = c(".null", ".real"))



# Create lower and upper bounds considering mean ¬± sd
merged_data_2.5_Oxolinic_acid$lower_bound_pred <- merged_data_2.5_Oxolinic_acid$mean_rel_ab.pred - merged_data_2.5_Oxolinic_acid$sd_rel_ab.pred
merged_data_2.5_Oxolinic_acid$upper_bound_pred <- merged_data_2.5_Oxolinic_acid$mean_rel_ab.pred + merged_data_2.5_Oxolinic_acid$sd_rel_ab.pred
merged_data_2.5_Oxolinic_acid$lower_bound_real <- merged_data_2.5_Oxolinic_acid$mean_rel_ab.real - merged_data_2.5_Oxolinic_acid$sd_rel_ab.real
merged_data_2.5_Oxolinic_acid$upper_bound_real <- merged_data_2.5_Oxolinic_acid$mean_rel_ab.real + merged_data_2.5_Oxolinic_acid$sd_rel_ab.real

# Ensure lower and upper bounds are non-negative, adjusting as necessary
merged_data_2.5_Oxolinic_acid$lower_bound_pred[merged_data_2.5_Oxolinic_acid$lower_bound_pred <= 0] <- 1e-10
merged_data_2.5_Oxolinic_acid$lower_bound_real[merged_data_2.5_Oxolinic_acid$lower_bound_real <= 0] <- 1e-10
merged_data_2.5_Oxolinic_acid$upper_bound_pred[merged_data_2.5_Oxolinic_acid$upper_bound_pred <= 0] <- 1e-10
merged_data_2.5_Oxolinic_acid$upper_bound_real[merged_data_2.5_Oxolinic_acid$upper_bound_real <= 0] <- 1e-10

##and for NULL model:
# Create lower and upper bounds considering mean ¬± sd
merged_data_2.5_Oxolinic_acid_NULL$lower_bound_null <- merged_data_2.5_Oxolinic_acid_NULL$mean_rel_ab.null - merged_data_2.5_Oxolinic_acid_NULL$sd_rel_ab.null
merged_data_2.5_Oxolinic_acid_NULL$upper_bound_null <- merged_data_2.5_Oxolinic_acid_NULL$mean_rel_ab.null + merged_data_2.5_Oxolinic_acid_NULL$sd_rel_ab.null
merged_data_2.5_Oxolinic_acid_NULL$lower_bound_real <- merged_data_2.5_Oxolinic_acid_NULL$mean_rel_ab.real - merged_data_2.5_Oxolinic_acid_NULL$sd_rel_ab.real
merged_data_2.5_Oxolinic_acid_NULL$upper_bound_real <- merged_data_2.5_Oxolinic_acid_NULL$mean_rel_ab.real + merged_data_2.5_Oxolinic_acid_NULL$sd_rel_ab.real

# Ensure lower and upper bounds are non-negative, adjusting as necessary
merged_data_2.5_Oxolinic_acid_NULL$lower_bound_null[merged_data_2.5_Oxolinic_acid_NULL$lower_bound_null <= 0] <- 1e-10
merged_data_2.5_Oxolinic_acid_NULL$lower_bound_real[merged_data_2.5_Oxolinic_acid_NULL$lower_bound_real <= 0] <- 1e-10
merged_data_2.5_Oxolinic_acid_NULL$upper_bound_null[merged_data_2.5_Oxolinic_acid_NULL$upper_bound_null <= 0] <- 1e-10
merged_data_2.5_Oxolinic_acid_NULL$upper_bound_real[merged_data_2.5_Oxolinic_acid_NULL$upper_bound_real <= 0] <- 1e-10

# Filter to include only species with a mean relative abundance > 0.01 in the 'real' dataset
significant_species <- merged_data_2.5_Oxolinic_acid[merged_data_2.5_Oxolinic_acid$mean_rel_ab.real > 0.01, ]
survivors_2.5_Oxolinic_acid <- nrow(significant_species)
survivors_2.5_Oxolinic_acid

#should be the same as survivors defined above, since it is calculated from .real
significant_species_NULL <- merged_data_2.5_Oxolinic_acid_NULL[merged_data_2.5_Oxolinic_acid_NULL$mean_rel_ab.real > 0.01, ]
survivors_2.5_Oxolinic_acid_NULL <- nrow(significant_species_NULL)
survivors_2.5_Oxolinic_acid_NULL

# Adjusted order of magnitude check to include SD, only for significant species
significant_species$Predicted_magnitude_correct <- ifelse(
  (floor(log10(significant_species$lower_bound_pred)) <= floor(log10(significant_species$upper_bound_real)) &
     floor(log10(significant_species$upper_bound_pred)) >= floor(log10(significant_species$lower_bound_real))),
  1,
  0
)

#and for the Null model:
significant_species_NULL$Predicted_magnitude_correct <- ifelse(
  (floor(log10(significant_species_NULL$lower_bound_null)) <= floor(log10(significant_species_NULL$upper_bound_real)) &
     floor(log10(significant_species_NULL$upper_bound_null)) >= floor(log10(significant_species_NULL$lower_bound_real))),
  1,
  0
)

# Calculate the fraction of correctly predicted magnitudes for significant species
predicted_magnitude_correct_fraction_2.5_Oxolinic_acid <- sum(significant_species$Predicted_magnitude_correct) / nrow(significant_species)
predicted_magnitude_correct_fraction_2.5_Oxolinic_acid

predicted_magnitude_correct_fraction_2.5_Oxolinic_acid_NULL <- sum(significant_species_NULL$Predicted_magnitude_correct) / nrow(significant_species_NULL)
predicted_magnitude_correct_fraction_2.5_Oxolinic_acid_NULL


top_species_missing_2.5_Oxolinic_acid <- setdiff(top6_real_2.5_Oxolinic_acid_means, top6_predicted_2.5_Oxolinic_acid_means)
top_species_wrong_2.5_Oxolinic_acid <- setdiff(top6_predicted_2.5_Oxolinic_acid_means, top6_real_2.5_Oxolinic_acid_means)

top_species_missing_2.5_Oxolinic_acid <- if(length(top_species_missing_2.5_Oxolinic_acid) == 0) "None" else top_species_missing_2.5_Oxolinic_acid
top_species_wrong_2.5_Oxolinic_acid <- if(length(top_species_wrong_2.5_Oxolinic_acid) == 0) "None" else top_species_wrong_2.5_Oxolinic_acid

Prediction_quality_2.5_Oxolinic_acid <- data.frame(
  Top_six_correct = paste(top_six_correct_2.5_Oxolinic_acid, sep=""),
  Top_six_correct_NULL = paste(top_six_correct_2.5_Oxolinic_acid_NULL, sep=""),
  Top_six_correct_means = paste(top_six_correct_2.5_Oxolinic_acid_means, sep=""),
  Top_six_correct_means_NULL = paste(top_six_correct_2.5_Oxolinic_acid_means_NULL, sep=""),
  Predicted_magnitude_correct = paste(round(predicted_magnitude_correct_fraction_2.5_Oxolinic_acid * 100, 2), "%", sep=""),
  Predicted_magnitude_correct_NULL = paste(round(predicted_magnitude_correct_fraction_2.5_Oxolinic_acid_NULL * 100, 2), "%", sep=""),
  survivors_total = survivors_2.5_Oxolinic_acid,
  top_species_missing <- top_species_missing_2.5_Oxolinic_acid,
  top_species_wrong <- top_species_wrong_2.5_Oxolinic_acid, 
  predicted_mean_final_OD <- predicted_mean_final_od_2.5_Oxolinic_acid,
  real_mean_final_OD <- real_mean_final_od_2.5_Oxolinic_acid,
  sims_total = length(successful_sim_ids)
)

Prediction_quality_2.5_Oxolinic_acid









##Sertindole

combined_monoculture_aucs2_Sertindole <- subset(combined_monoculture_aucs2, drug == "Sertindole")


#drug sensitivity terms: define once outside of ODEs
y_function_B_vulgatus_Sertindole <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("B_vulgatus", "Sertindole", best_fitting_models_df_Sertindole)), collapse = " ")))
y_function_B_uniformis_Sertindole <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("B_uniformis", "Sertindole", best_fitting_models_df_Sertindole)), collapse = " ")))
y_function_B_fragilis_Sertindole <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("B_fragilis", "Sertindole", best_fitting_models_df_Sertindole)), collapse = " ")))
y_function_B_thetaiotaomicron_Sertindole <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("B_thetaiotaomicron", "Sertindole", best_fitting_models_df_Sertindole)), collapse = " ")))
y_function_C_ramosum_Sertindole <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("C_ramosum", "Sertindole", best_fitting_models_df_Sertindole)), collapse = " ")))
y_function_E_rectale_Sertindole <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("E_rectale", "Sertindole", best_fitting_models_df_Sertindole)), collapse = " ")))
y_function_R_intestinalis_Sertindole <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("R_intestinalis", "Sertindole", best_fitting_models_df_Sertindole)), collapse = " ")))
y_function_V_parvula_Sertindole <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("V_parvula", "Sertindole", best_fitting_models_df_Sertindole)), collapse = " ")))
y_function_E_lenta_Sertindole <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("E_lenta", "Sertindole", best_fitting_models_df_Sertindole)), collapse = " ")))
y_function_F_nucleatum_Sertindole <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("F_nucleatum", "Sertindole", best_fitting_models_df_Sertindole)), collapse = " ")))
y_function_C_bolteae_Sertindole <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("C_bolteae", "Sertindole", best_fitting_models_df_Sertindole)), collapse = " ")))
y_function_C_perfringens_Sertindole <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("C_perfringens", "Sertindole", best_fitting_models_df_Sertindole)), collapse = " ")))
y_function_C_saccharolyticum_Sertindole <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("C_saccharolyticum", "Sertindole", best_fitting_models_df_Sertindole)), collapse = " ")))
y_function_S_salivarius_Sertindole <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("S_salivarius", "Sertindole", best_fitting_models_df_Sertindole)), collapse = " ")))
y_function_R_gnavus_Sertindole <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("R_gnavus", "Sertindole", best_fitting_models_df_Sertindole)), collapse = " ")))
y_function_C_comes_Sertindole <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("C_comes", "Sertindole", best_fitting_models_df_Sertindole)), collapse = " ")))
y_function_P_merdae_Sertindole <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("P_merdae", "Sertindole", best_fitting_models_df_Sertindole)), collapse = " ")))
y_function_S_parasanguinis_Sertindole <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("S_parasanguinis", "Sertindole", best_fitting_models_df_Sertindole)), collapse = " ")))
y_function_C_aerofaciens_Sertindole <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("C_aerofaciens", "Sertindole", best_fitting_models_df_Sertindole)), collapse = " ")))
y_function_D_formicigenerans_Sertindole <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("D_formicigenerans", "Sertindole", best_fitting_models_df_Sertindole)), collapse = " ")))
y_function_E_coli_Sertindole <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("E_coli", "Sertindole", best_fitting_models_df_Sertindole)), collapse = " ")))



y_function_B_vulgatus_Sertindole_func <- eval(parse(text = paste("function(Drug) {", y_function_B_vulgatus_Sertindole, "}")))
y_function_B_uniformis_Sertindole_func <- eval(parse(text = paste("function(Drug) {", y_function_B_uniformis_Sertindole, "}")))
y_function_B_fragilis_Sertindole_func <- eval(parse(text = paste("function(Drug) {", y_function_B_fragilis_Sertindole, "}")))
y_function_B_thetaiotaomicron_Sertindole_func <- eval(parse(text = paste("function(Drug) {", y_function_B_thetaiotaomicron_Sertindole, "}")))
y_function_C_ramosum_Sertindole_func <- eval(parse(text = paste("function(Drug) {", y_function_C_ramosum_Sertindole, "}")))
y_function_E_rectale_Sertindole_func <- eval(parse(text = paste("function(Drug) {", y_function_E_rectale_Sertindole, "}")))
y_function_R_intestinalis_Sertindole_func <- eval(parse(text = paste("function(Drug) {", y_function_R_intestinalis_Sertindole, "}")))
y_function_E_lenta_Sertindole_func <- eval(parse(text = paste("function(Drug) {", y_function_E_lenta_Sertindole, "}")))
y_function_F_nucleatum_Sertindole_func <- eval(parse(text = paste("function(Drug) {", y_function_F_nucleatum_Sertindole, "}")))
y_function_C_bolteae_Sertindole_func <- eval(parse(text = paste("function(Drug) {", y_function_C_bolteae_Sertindole, "}")))
y_function_C_perfringens_Sertindole_func <- eval(parse(text = paste("function(Drug) {", y_function_C_perfringens_Sertindole, "}")))
y_function_C_saccharolyticum_Sertindole_func <- eval(parse(text = paste("function(Drug) {", y_function_C_saccharolyticum_Sertindole, "}")))
y_function_S_salivarius_Sertindole_func <- eval(parse(text = paste("function(Drug) {", y_function_S_salivarius_Sertindole, "}")))
y_function_R_gnavus_Sertindole_func <- eval(parse(text = paste("function(Drug) {", y_function_R_gnavus_Sertindole, "}")))
y_function_C_comes_Sertindole_func <- eval(parse(text = paste("function(Drug) {", y_function_C_comes_Sertindole, "}")))
y_function_P_merdae_Sertindole_func <- eval(parse(text = paste("function(Drug) {", y_function_P_merdae_Sertindole, "}")))
y_function_S_parasanguinis_Sertindole_func <- eval(parse(text = paste("function(Drug) {", y_function_S_parasanguinis_Sertindole, "}")))
y_function_C_aerofaciens_Sertindole_func <- eval(parse(text = paste("function(Drug) {", y_function_C_aerofaciens_Sertindole, "}")))
y_function_D_formicigenerans_Sertindole_func <- eval(parse(text = paste("function(Drug) {", y_function_D_formicigenerans_Sertindole, "}")))
y_function_E_coli_Sertindole_func <- eval(parse(text = paste("function(Drug) {", y_function_E_coli_Sertindole, "}")))
y_function_V_parvula_Sertindole_func <- eval(parse(text = paste("function(Drug) {", y_function_V_parvula_Sertindole, "}")))



unique(combined_monoculture_aucs2_Sertindole$conc)
##dictate drug concentration tested for simulation cycle here:
#drug_concentration_tested <- 5  #if manually or:
drug_concentration_tested <- unique(combined_monoculture_aucs2_Sertindole$conc)[1]
initial_conditions <- rep(0.01/32, 32)
initial_conditions <- c(initial_conditions, drug_concentration_tested)


##drug effect fitted for species showing sensitivity in monoculture:
#unique(combined_monoculture_aucs2_Sertindole$Species)

##for more simple linear fits
closed.sir.model_Sertindole <- function (t, x, params) {
  ## first extract the state variables
  A_muciniphila <- x[1]
  B_adolescentis <- x[2]
  B_fragilis <- x[3]
  B_longum <- x[4]
  B_obeum <- x[5]
  B_thetaiotaomicron <- x[6]
  B_uniformis <- x[7]
  B_vulgatus <- x[8]
  B_wadsworthia <- x[9]
  C_aerofaciens <- x[10]
  C_bolteae <- x[11]
  C_comes <- x[12]
  C_perfringens <- x[13]
  C_ramosum <- x[14]
  C_saccharolyticum <- x[15]
  D_formicigenerans <- x[16]
  E_coli <- x[17]
  E_lenta <- x[18]
  E_rectale <- x[19]
  F_nucleatum <- x[20]
  L_paracasei <- x[21]
  O_splanchnicus <- x[22]
  P_copri <- x[23]
  P_distasonis <- x[24]
  P_merdae <- x[25]
  R_bromii <- x[26]
  R_gnavus <- x[27]
  R_intestinalis <- x[28]
  R_torques <- x[29]
  S_parasanguinis <- x[30]
  S_salivarius <- x[31]
  V_parvula <- x[32]
  Drug <- x[33]
  
  
  ## now extract the parameters
  r_B_fragilis <- flat_params[["B._fragilis.r"]]
  K_B_fragilis <- flat_params[["B._fragilis.K"]]
  r_B_longum <- flat_params[["B._longum.r"]]
  K_B_longum <- flat_params[["B._longum.K"]]
  r_B_thetaiotaomicron <- flat_params[["B._thetaiotaomicron.r"]]
  K_B_thetaiotaomicron <- flat_params[["B._thetaiotaomicron.K"]]
  r_B_uniformis <- flat_params[["B._uniformis.r"]]
  K_B_uniformis <- flat_params[["B._uniformis.K"]]
  r_B_vulgatus <- flat_params[["B._vulgatus.r"]]
  K_B_vulgatus <- flat_params[["B._vulgatus.K"]]
  r_B_wadsworthia <- flat_params[["B._wadsworthia.r"]]
  K_B_wadsworthia <- flat_params[["B._wadsworthia.K"]]
  r_C_aerofaciens <- flat_params[["C._aerofaciens.r"]]
  K_C_aerofaciens <- flat_params[["C._aerofaciens.K"]]
  r_C_bolteae <- flat_params[["C._bolteae.r"]]
  K_C_bolteae <- flat_params[["C._bolteae.K"]]
  r_C_comes <- flat_params[["C._comes.r"]]
  K_C_comes <- flat_params[["C._comes.K"]]
  r_C_perfringens <- flat_params[["C._perfringens.r"]]
  K_C_perfringens <- flat_params[["C._perfringens.K"]]
  r_C_ramosum <- flat_params[["C._ramosum.r"]]
  K_C_ramosum <- flat_params[["C._ramosum.K"]]
  r_C_saccharolyticum <- flat_params[["C._saccharolyticum.r"]]
  K_C_saccharolyticum <- flat_params[["C._saccharolyticum.K"]]
  r_D_formicigenerans <- flat_params[["D._formicigenerans.r"]]
  K_D_formicigenerans <- flat_params[["D._formicigenerans.K"]]
  r_E_coli <- flat_params[["E._coli.r"]]
  K_E_coli <- flat_params[["E._coli.K"]]
  r_E_lenta <- flat_params[["E._lenta.r"]]
  K_E_lenta <- flat_params[["E._lenta.K"]]
  r_E_rectale <- flat_params[["E._rectale.r"]]
  K_E_rectale <- flat_params[["E._rectale.K"]]
  r_F_nucleatum <- flat_params[["F._nucleatum.r"]]
  K_F_nucleatum <- flat_params[["F._nucleatum.K"]]
  r_P_copri <- flat_params[["P._copri.r"]]
  K_P_copri <- flat_params[["P._copri.K"]]
  r_P_merdae <- flat_params[["P._merdae.r"]]
  K_P_merdae <- flat_params[["P._merdae.K"]]
  r_R_gnavus <- flat_params[["R._gnavus.r"]]
  K_R_gnavus <- flat_params[["R._gnavus.K"]]
  r_R_intestinalis <- flat_params[["R._intestinalis.r"]]
  K_R_intestinalis <- flat_params[["R._intestinalis.K"]]
  r_V_parvula <- flat_params[["V._parvula.r"]]
  K_V_parvula <- flat_params[["V._parvula.K"]]
  r_A_muciniphila <- flat_params[["A._muciniphila.r"]]
  K_A_muciniphila <- flat_params[["A._muciniphila.K"]]
  r_B_adolescentis <- flat_params[["B._adolescentis.r"]]
  K_B_adolescentis <- flat_params[["B._adolescentis.K"]]
  r_B_obeum <- flat_params[["B._obeum.r"]]
  K_B_obeum <- flat_params[["B._obeum.K"]]
  r_O_splanchnicus <- flat_params[["O._splanchnicus.r"]]
  K_O_splanchnicus <- flat_params[["O._splanchnicus.K"]]
  r_P_distasonis <- flat_params[["P._distasonis.r"]]
  K_P_distasonis <- flat_params[["P._distasonis.K"]]
  r_R_bromii <- flat_params[["R._bromii.r"]]
  K_R_bromii <- flat_params[["R._bromii.K"]]
  r_R_torques <- flat_params[["R._torques.r"]]
  K_R_torques <- flat_params[["R._torques.K"]]
  r_S_parasanguinis <- flat_params[["S._parasanguinis.r"]]
  K_S_parasanguinis <-flat_params[["S._parasanguinis.K"]]
  r_S_salivarius <- flat_params[["S._salivarius.r"]]
  K_S_salivarius <- flat_params[["S._salivarius.K"]]
  r_L_paracasei <- flat_params[["L._paracasei.r"]]
  K_L_paracasei <- flat_params[["L._paracasei.K"]]
  
  
  t_mod <- ifelse(t > 24.1, t - 24.1, t)
  
  
  ## now code the model equations
  dA_muciniphila_dt <- r_A_muciniphila * A_muciniphila * (1 - A_muciniphila / K_A_muciniphila)
  dB_adolescentis_dt <- r_B_adolescentis * B_adolescentis * (1 - B_adolescentis / K_B_adolescentis)
  dB_fragilis_dt <- r_B_fragilis * B_fragilis * (1 - B_fragilis / max(0.0001, K_B_fragilis * (y_function_B_fragilis_Sertindole_func(Drug))))
  dB_longum_dt <- r_B_longum * B_longum * (1 - B_longum / K_B_longum)
  dB_obeum_dt <- r_B_obeum * B_obeum * (1 - B_obeum / K_B_obeum)
  dB_thetaiotaomicron_dt <- r_B_thetaiotaomicron * B_thetaiotaomicron * (1 - B_thetaiotaomicron / max(0.0001, K_B_thetaiotaomicron * (y_function_B_thetaiotaomicron_Sertindole_func(Drug))))  
  dB_uniformis_dt <- r_B_uniformis * B_uniformis * (1 - B_uniformis / max(0.0001, K_B_uniformis * (y_function_B_uniformis_Sertindole_func(Drug))))
  dB_vulgatus_dt <- r_B_vulgatus * B_vulgatus * (1 - B_vulgatus / max(0.0001, K_B_vulgatus * (y_function_B_vulgatus_Sertindole_func(Drug))))
  dB_wadsworthia_dt <- r_B_wadsworthia * B_wadsworthia * (1 - B_wadsworthia / K_B_wadsworthia)
  dC_aerofaciens_dt <- r_C_aerofaciens * C_aerofaciens * (1 - C_aerofaciens / max(0.0001, K_C_aerofaciens * (y_function_C_aerofaciens_Sertindole_func(Drug))))
  dC_bolteae_dt <- r_C_bolteae * C_bolteae * (1 - C_bolteae /  max(0.0001, K_C_bolteae * (y_function_C_bolteae_Sertindole_func(Drug))))
  dC_comes_dt <- r_C_comes * C_comes * (1 - C_comes / max(0.0001, K_C_comes * (y_function_C_comes_Sertindole_func(Drug))))
  dC_perfringens_dt <- r_C_perfringens * C_perfringens * (1 - C_perfringens / max(0.0001, K_C_perfringens * (y_function_C_perfringens_Sertindole_func(Drug))))
  dC_ramosum_dt <- r_C_ramosum * C_ramosum * (1 - C_ramosum / max(0.0001, K_C_ramosum * (y_function_C_ramosum_Sertindole_func(Drug))))
  dC_saccharolyticum_dt <- r_C_saccharolyticum * C_saccharolyticum * (1 - C_saccharolyticum / max(0.0001, K_C_saccharolyticum * (y_function_C_saccharolyticum_Sertindole_func(Drug))))
  dD_formicigenerans_dt <- r_D_formicigenerans * D_formicigenerans * (1 - D_formicigenerans / max(0.0001, K_D_formicigenerans * (y_function_D_formicigenerans_Sertindole_func(Drug))))
  dE_coli_dt <- r_E_coli * E_coli * (1 - E_coli / max(0.0001, K_E_coli * (y_function_E_coli_Sertindole_func(Drug))))
  dE_lenta_dt <- r_E_lenta * E_lenta * (1 - E_lenta / max(0.0001, K_E_lenta * (y_function_E_lenta_Sertindole_func(Drug))))
  dE_rectale_dt <- r_E_rectale * E_rectale * (1 - E_rectale / max(0.0001, K_E_rectale * (y_function_E_rectale_Sertindole_func(Drug))))
  dF_nucleatum_dt <- r_F_nucleatum * F_nucleatum * (1 - F_nucleatum / max(0.0001, K_F_nucleatum * (y_function_F_nucleatum_Sertindole_func(Drug))))
  dL_paracasei_dt <- r_L_paracasei * L_paracasei * (1 - L_paracasei / K_L_paracasei)  
  dO_splanchnicus_dt <- r_O_splanchnicus * O_splanchnicus * (1 - O_splanchnicus / K_O_splanchnicus)  
  dP_copri_dt <- r_P_copri * P_copri * (1 - P_copri / K_P_copri)
  dP_distasonis_dt <- r_P_distasonis * P_distasonis * (1 - P_distasonis / K_P_distasonis)  
  dP_merdae_dt <- r_P_merdae * P_merdae * (1 - P_merdae / max(0.0001, K_P_merdae * (y_function_P_merdae_Sertindole_func(Drug))))
  dR_bromii_dt <- r_R_bromii * R_bromii * (1 - R_bromii / K_R_bromii) 
  dR_gnavus_dt <- r_R_gnavus * R_gnavus * (1 - R_gnavus / max(0.0001, K_R_gnavus * (y_function_R_gnavus_Sertindole_func(Drug))))
  dR_intestinalis_dt <- r_R_intestinalis * R_intestinalis * (1 - R_intestinalis / max(0.0001, K_R_intestinalis * (y_function_R_intestinalis_Sertindole_func(Drug))))
  dR_torques_dt <- r_R_torques * R_torques * (1 - R_torques /K_R_torques) 
  dS_parasanguinis_dt <- r_S_parasanguinis * S_parasanguinis * (1 - S_parasanguinis / max(0.0001, K_S_parasanguinis * (y_function_S_parasanguinis_Sertindole_func(Drug))))
  dS_salivarius_dt <- r_S_salivarius * S_salivarius * (1 - S_salivarius / max(0.0001, K_S_salivarius * (y_function_S_salivarius_Sertindole_func(Drug))))
  dV_parvula_dt <- r_V_parvula * V_parvula * (1 - V_parvula / max(0.0001, K_V_parvula * (y_function_V_parvula_Sertindole_func(Drug))))
  
  
  
  #Drug differential:
  dDrug_dt <- (subset(drug_dynamics, Drug == "Sertindole")$Steepness_param_community * exp(-subset(drug_dynamics, Drug == "Sertindole")$Steepness_param_community * t_mod)) * (drug_concentration_tested * prop_left_Sertindole - drug_concentration_tested)
  #dDrug_dt <- 0
  
  ## Combine results into a single vector
  dxdt <- c(dA_muciniphila_dt, dB_adolescentis_dt, dB_fragilis_dt, dB_longum_dt, dB_obeum_dt, dB_thetaiotaomicron_dt, dB_uniformis_dt, dB_vulgatus_dt, dB_wadsworthia_dt, dC_aerofaciens_dt, dC_bolteae_dt, dC_comes_dt, dC_perfringens_dt, dC_ramosum_dt, dC_saccharolyticum_dt, dD_formicigenerans_dt, dE_coli_dt, dE_lenta_dt, dE_rectale_dt, dF_nucleatum_dt, dL_paracasei_dt, dO_splanchnicus_dt, dP_copri_dt, dP_distasonis_dt, dP_merdae_dt, dR_bromii_dt, dR_gnavus_dt, dR_intestinalis_dt, dR_torques_dt, dS_parasanguinis_dt, dS_salivarius_dt, dV_parvula_dt, dDrug_dt)
  
  ## Return result as a list
  list(dxdt)
}




#calculate the co-culture correction factor per species based on community composition in absence of drug, just like done for Niclosamide

growth_data_all_0_Niclosamide
growth_data_all_0_Niclosamide1 <- growth_data_all_0_Niclosamide %>%
  dplyr::mutate(Species = gsub(" ", "_", Species))


# Merge rel_ab_control with growth_data_all_0_Niclosamide on Species
# Function to remove duplicated columns by name pattern
clean_columns_base <- function(df, pattern) {
  cols_to_keep <- !grepl(pattern, names(df))
  df <- df[, cols_to_keep]
  return(df)
}

# Use the new function to clean up your dataframe
rel_ab_control <- clean_columns_base(rel_ab_control, "mean_max_OD.[xy]")
str(rel_ab_control)


#rel_ab_control$correction_factor <- rel_ab_control$mean_rel_ab / (rel_ab_control$mean_max_OD/sum(rel_ab_control$mean_max_OD))
# Calculate correction factor with a minimum value of ~1
rel_ab_control$correction_factor <- pmax(rel_ab_control$mean_rel_ab / (rel_ab_control$mean_max_OD / sum(rel_ab_control$mean_max_OD)), 1.1)


# Create a new dataframe for co-culture correction
co_culture_correction <- data.frame(
  species = rel_ab_control$Species,
  correction_factor = rel_ab_control$correction_factor
)


#summarise community data
#Adjust based on tested concentrations for each drug
unique(Community_compositions_focus_drugs_Sertindole$concentration)

Community_compositions_focus_drugs_Sertindole_5uM <- subset(Community_compositions_focus_drugs_Sertindole, concentration == 5)
Community_compositions_focus_drugs_Sertindole_20uM <- subset(Community_compositions_focus_drugs_Sertindole, concentration == 20)
Community_compositions_focus_drugs_Sertindole_80uM <- subset(Community_compositions_focus_drugs_Sertindole, concentration == 80)


#5 uM
Community_compositions_focus_drugs_Sertindole_5uM_summarised <- Community_compositions_focus_drugs_Sertindole_5uM %>%
  dplyr::group_by(species) %>%                                  
  dplyr::summarize(
    mean_rel_ab = mean(rel_abundance, na.rm = TRUE),     
    sd_rel_ab = sd(rel_abundance, na.rm = TRUE) ,
    mean_max_OD = mean(maxOD, na.rm = TRUE),
    sd_max_OD = sd(maxOD, na.rm = TRUE),
    mean_final_OD = mean(finalOD, na.rm = TRUE),
    sd_final_OD = sd(finalOD, na.rm = TRUE)
  ) %>%
  dplyr::ungroup() 


Community_compositions_focus_drugs_Sertindole_5uM_summarised <- Community_compositions_focus_drugs_Sertindole_5uM_summarised %>%
  dplyr::mutate(Species = sub("^(\\w)\\w*\\s(.*)", "\\1._\\2", species))

#remove (sub)strain info
Community_compositions_focus_drugs_Sertindole_5uM_summarised <- Community_compositions_focus_drugs_Sertindole_5uM_summarised %>%
  dplyr::mutate(Species = sub("^(\\w\\._\\w+).*", "\\1", Species))


#20 uM
Community_compositions_focus_drugs_Sertindole_20uM_summarised <- Community_compositions_focus_drugs_Sertindole_20uM %>%
  dplyr::group_by(species) %>%                                  
  dplyr::summarize(
    mean_rel_ab = mean(rel_abundance, na.rm = TRUE),     
    sd_rel_ab = sd(rel_abundance, na.rm = TRUE) ,
    mean_max_OD = mean(maxOD, na.rm = TRUE),
    sd_max_OD = sd(maxOD, na.rm = TRUE),
    mean_final_OD = mean(finalOD, na.rm = TRUE),
    sd_final_OD = sd(finalOD, na.rm = TRUE)
  ) %>%
  dplyr::ungroup() 


Community_compositions_focus_drugs_Sertindole_20uM_summarised <- Community_compositions_focus_drugs_Sertindole_20uM_summarised %>%
  dplyr::mutate(Species = sub("^(\\w)\\w*\\s(.*)", "\\1._\\2", species))

#remove (sub)strain info
Community_compositions_focus_drugs_Sertindole_20uM_summarised <- Community_compositions_focus_drugs_Sertindole_20uM_summarised %>%
  dplyr::mutate(Species = sub("^(\\w\\._\\w+).*", "\\1", Species))


#80 uM
Community_compositions_focus_drugs_Sertindole_80uM_summarised <- Community_compositions_focus_drugs_Sertindole_80uM %>%
  dplyr::group_by(species) %>%                                  
  dplyr::summarize(
    mean_rel_ab = mean(rel_abundance, na.rm = TRUE),     
    sd_rel_ab = sd(rel_abundance, na.rm = TRUE) ,
    mean_max_OD = mean(maxOD, na.rm = TRUE),
    sd_max_OD = sd(maxOD, na.rm = TRUE),    
    mean_final_OD = mean(finalOD, na.rm = TRUE),
    sd_final_OD = sd(finalOD, na.rm = TRUE)
  ) %>%
  dplyr::ungroup() 



Community_compositions_focus_drugs_Sertindole_80uM_summarised <- Community_compositions_focus_drugs_Sertindole_80uM_summarised %>%
  dplyr::mutate(Species = sub("^(\\w)\\w*\\s(.*)", "\\1._\\2", species))

#remove (sub)strain info
Community_compositions_focus_drugs_Sertindole_80uM_summarised <- Community_compositions_focus_drugs_Sertindole_80uM_summarised %>%
  dplyr::mutate(Species = sub("^(\\w\\._\\w+).*", "\\1", Species))


#Initialise data frames
sim_output <- data.frame()
input_params_list <- list() #Use a list to collect parameters for each simulation

#number of simulations
num_sims <- 250


for (i in 1:num_sims) {
  tryCatch({
    # generate model parameters
    set.seed(i) #set a different seed for each simulation for variation
    params <- lapply(1:nrow(growth_data_all_0_Niclosamide), function(idx) {
      species_params <- growth_data_all_0_Niclosamide[idx, ]
      list(
        r = rnorm(1, mean = species_params$mean_max_Growth_rate, sd = species_params$sd_max_Growth_rate),
        K = rnorm(1, mean = species_params$mean_max_OD, sd = species_params$sd_max_OD)
      )
    })
    names(params) <- gsub(" ", "_", growth_data_all_0_Niclosamide$Species)
    flat_params <- unlist(params)
    names(flat_params) <- gsub("\\.\\d$", "", names(flat_params))
    
    #replace spaces with underscores to match formatting
    co_culture_correction$species <- gsub(" ", "_", co_culture_correction$species, fixed = TRUE)
    
    #replace the species-specific K parameters extracted from monoculture growth data 
    #with drawn relative abundance values at Niclosamide = 0, scaled to K
    rel_ab_control$Species <- gsub(" ", "_", rel_ab_control$Species)
    
    #Initialise an empty vector to store drawn values
    drawn_values <- numeric(nrow(rel_ab_control))
    
    #draw values from their respective distributions
    for (k in 1:nrow(rel_ab_control)) {
      species_name <- rel_ab_control$Species[k]
      drawn_value <- rnorm(1, mean = rel_ab_control$mean_rel_ab[k], sd = rel_ab_control$sd_rel_ab[k])
      drawn_values[k] <- max(drawn_value, 0)  # Ensure no negative values
    }
    
    #Normalise drawn relative abundance values so they sum to 1 (to reflect a 'true' relative abundance distribution)
    #this is needed so when we convert the values into OD units by multiplying with the drawn community maxOD,
    # the sum of K_i parameters and the drawn K are equal
    normalised_values <- drawn_values / sum(drawn_values)
    
    #Pull community maxOD (K) at 0 drugs from respective normal distribution:
    K <- rnorm(n = 1, mean = rel_ab_control$mean_com_max_OD[1], sd = rel_ab_control$sd_com_max_OD[1])
    
    # Assign these normalised values to their respective species' .K parameters
    for (k in 1:nrow(rel_ab_control)) {
      species_name <- rel_ab_control$Species[k]
      k_index <- grep(paste0("^", species_name, "\\.K$"), names(flat_params))
      
      if (length(k_index) > 0) {
        old_value <- flat_params[k_index]
        flat_params[k_index] <- (normalised_values[k] + 0.0001) * K #add small value in case drawn K_i is 0, which would cause issues with the solver
        cat(sprintf("Updated %s from %f to %f using normalised value %f scaled by K %f\n", names(flat_params)[k_index], old_value, flat_params[k_index], normalised_values[k], K))
      }
    }
    
    #Accounting for variation in drug degradation by community, with standard deviation of end concentration (at 10h) around the fitted predicted (relative) end concentration at 24h
    #prop_left_Sertindole <- abs(rnorm(1, (subset(drug_dynamics, Drug == "Sertindole")$Prop_left_24h_community), (subset(drug_dynamics, Drug == "Sertindole")$SD_drug_community))) 
    #below, we account for measurement error rather than ecological drivers that lead to the variability of degradation at the final point measured 
    prop_left_Sertindole <- abs(rnorm(
      n = 1, 
      mean = subset(drug_dynamics, Drug == "Sertindole")$Prop_left_24h_community, 
      sd = ifelse(
        subset(drug_dynamics, Drug == "Sertindole")$SD_drug_community > subset(drug_dynamics, Drug == "Sertindole")$SD_drug_community_start, 
        subset(drug_dynamics, Drug == "Sertindole")$SD_drug_community - subset(drug_dynamics, Drug == "Sertindole")$SD_drug_community_start, 
        subset(drug_dynamics, Drug == "Sertindole")$SD_drug_community
      )
    ))
    
    
    #loop through each species in co_culture_correction
    for (j in 1:nrow(co_culture_correction)) {
      # Extract the species name and correction factor
      species_name <- co_culture_correction$species[j]
      correction_factor <- co_culture_correction$correction_factor[j]
      
      # Identify the corresponding growth rate parameter in flat_params
      #by matching the base species name (without .r)
      growth_rate_indices <- grep(paste0("^", species_name, "\\.r$"), names(flat_params))
      
      #take the growth rate parameter and apply the correction factor 
      for (index in growth_rate_indices) {
        flat_params[index] <- flat_params[index] * correction_factor
      }
    }
    
    flat_params
    # Store parameters for each simulation
    input_params_list[[i]] <- c(sim_ID = i, flat_params)
    
    # Run the model for the first 24-hour cycle
    solution_cycle_1 <- ode(y = initial_conditions, times = seq(from = 0, to = 24, by = 0.1), func = closed.sir.model_Sertindole, parms = flat_params,   method = "lsoda", rtol = 1e-6, atol = 1e-6)
    
    # Dilution and second cycle
    end_of_cycle_1 <- solution_cycle_1[nrow(solution_cycle_1), -1]
    initial_conditions_cycle_2 <- end_of_cycle_1 / 50
    #accounting for the drugs being added with the new growth cycle as well:
    initial_conditions_cycle_2[33] <- initial_conditions_cycle_2[33] + drug_concentration_tested
    solution_cycle_2 <- ode(y = initial_conditions_cycle_2, times = seq(from = 24, to = 48, by = 0.1), func = closed.sir.model_Sertindole, parms = flat_params,  method = "lsoda", rtol = 1e-6, atol = 1e-6)
    
    # Combine and format results
    combined_solution <- rbind(as.data.frame(solution_cycle_1), as.data.frame(solution_cycle_2)[-1,])
    combined_solution$sim_ID <- rep(i, nrow(combined_solution))
    combined_solution <- combined_solution %>%
      tidyr::gather(key = "Species", value = "Density", -time, -sim_ID) %>%
      dplyr::mutate(Hour = time) %>%
      dplyr::select(sim_ID, Hour, Species, Density)
    
    ##Append to sim_output
    sim_output <- rbind(sim_output, combined_solution)
  }, error = function(e) {
    cat(sprintf("Skipping simulation %d due to an error: %s\n", i, e$message))
  })
}



##Combine all parameter data into a single dataframe
input_params <- do.call(rbind, input_params_list)

# Add a "Species" column 
sim_output$Species_name <- species_names[as.numeric(as.character(sim_output$Species))]
sim_output$Species_name <- replace_na(sim_output$Species_name, "Drug")

#View(input_params)
#View(sim_output)

sim_output <- na.omit(sim_output)
successful_sim_ids <- unique(subset(sim_output, Hour == 48)$sim_ID)
length(successful_sim_ids)
sim_output1 <- sim_output[sim_output$sim_ID %in% successful_sim_ids, ]


#Transform sim_output so we have wide format by Species
sim_output_wide <- tidyr::pivot_wider(sim_output1, 
                                      names_from = Species_name, 
                                      values_from = Density,
                                      id_cols = c(sim_ID, Hour))

length(unique(sim_output_wide$sim_ID))
#calc community OD per timepoint
sim_output_wide$Total_OD <- rowSums(sim_output_wide[, 3:34], na.rm = TRUE)
#calculate and add relative abundances here as well:
species_columns <- colnames(sim_output_wide)[3:34] 

for (species in species_columns) {
  sim_output_wide[[paste0("rel_", species)]] <- sim_output_wide[[species]] / sim_output_wide$Total_OD
}


#assign sim_output_wide test conditions to dataframe name
drug_tested <- "Sertindole"
variable_name_1 <- paste0("sim_output_wide_", ifelse(drug_concentration_tested == 1e-04, 0, drug_concentration_tested), "_", drug_tested)
assign(variable_name_1, sim_output_wide)

#turn back into long format if interested in plotting relative abundances
cols_needed <- c("sim_ID", "Hour")

sim_output_long <- sim_output_wide %>% 
  dplyr::select(sim_ID, Hour, Drug, starts_with("rel_")) %>% 
  tidyr::pivot_longer(
    cols = c(Drug, starts_with("rel_")),
    names_to = "Species", 
    values_to = "Relative_abundance",
    names_prefix = "rel_",
    names_transform = list(Species = ~ ifelse(.x == "Drug", "Drug", .x))
  ) 

str(sim_output_long)


species_names_1 <- c(
  "A_muciniphila",
  "B_adolescentis",
  "B_fragilis",
  "B_longum",
  "B_obeum",
  "B_thetaiotaomicron",
  "B_uniformis",
  "B_vulgatus",
  "B_wadsworthia",
  "C_aerofaciens",
  "C_bolteae",
  "C_comes",
  "C_perfringens",
  "C_ramosum",
  "C_saccharolyticum",
  "D_formicigenerans",
  "E_coli",
  "E_lenta",
  "E_rectale",
  "F_nucleatum",
  "L_paracasei",
  "O_splanchnicus",
  "P_copri",
  "P_distasonis",
  "P_merdae",
  "R_bromii",
  "R_gnavus",
  "R_intestinalis",
  "R_torques",
  "S_parasanguinis",
  "S_salivarius",
  "V_parvula",
  "Drug"
)

species_colours_1 <- c(
  "A_muciniphila" = "#1f77b4",
  "B_adolescentis" = "#ff7f0e",
  "B_fragilis" = "#2ca02c",
  "B_longum" = "#d62728",
  "B_obeum" = "#9467bd",
  "B_thetaiotaomicron" = "black",
  "B_uniformis" = "#e377c2",
  "B_vulgatus" = "#7f7f7f",
  "B_wadsworthia" = "gold1",
  "C_aerofaciens" = "#aec7e8",
  "C_bolteae" = "#ffbb78",
  "C_comes" = "magenta",
  "C_perfringens" = "#ff9896",
  "C_ramosum" = "#c5b0d5",
  "C_saccharolyticum" = "#c49c94",
  "D_formicigenerans" = "#f7b6d2",
  "E_coli" = "yellow",
  "E_lenta" = "turquoise",
  "E_rectale" = "#393b79",
  "F_nucleatum" = "royalblue2",
  "L_paracasei" = "blue",
  "O_splanchnicus" = "#637939",
  "P_copri" = "cyan",
  "P_distasonis" = "#8c6d31",
  "P_merdae" = "#c7c7c7",
  "R_bromii" = "#e6550d",
  "R_gnavus" = "#e7cb94",
  "R_intestinalis" = "#843c39",
  "R_torques" = "#d6616b",
  "S_parasanguinis" = "orange3",
  "S_salivarius" = "#7b4173",
  "V_parvula" = "#ce6dbd",
  "Drug" = "green"
)



##Plot output for any specific sim:
# ggplot(subset(sim_output, sim_ID == 1 & Species_name != "Drug"), aes(x = Hour, y = Density, group = Species_name, color = Species_name)) +
#   geom_line(size = 1, alpha = 0.7) +
#   scale_color_manual(values = species_colours_1) +
#   labs(title = paste0("Sertindole = ", drug_concentration_tested),
#        x = "Time (hours)",
#        y = "Population Density (OD)",
#        color = "Species") +
#   theme_minimal() +
#   theme(legend.position = "right")
# 
# ggplot(subset(sim_output, sim_ID == 3 & Species_name != "Drug"), aes(x = Hour, y = Density, group = Species_name, color = Species_name)) +
#   geom_line(size = 1, alpha = 0.7) +
#   scale_color_manual(values = species_colours_1) +
#   labs(title = paste0("Sertindole = ", drug_concentration_tested),
#        x = "Time (hours)",
#        y = "Population Density (OD)",
#        color = "Species") +
#   theme_minimal() +
#   theme(legend.position = "right")


ggplot(subset(sim_output_long, sim_ID == 1), aes(x = Hour, y = Relative_abundance, group = Species, color = Species)) +
  geom_line(size = 1, alpha = 0.7) +
  scale_color_manual(values = species_colours_1) +
  labs(title = paste0("Sertindole = ", drug_concentration_tested),
       x = "Time (hours)",
       y = "Relative abundance",
       color = "Species") +
  theme_minimal() +
  theme(legend.position = "right")


ggplot(subset(sim_output_long, sim_ID == 3), aes(x = Hour, y = Relative_abundance, group = Species, color = Species)) +
  geom_line(size = 1, alpha = 0.7) +
  scale_color_manual(values = species_colours_1) +
  labs(title = paste0("Sertindole = ", drug_concentration_tested),
       x = "Time (hours)",
       y = "Relative abundance",
       color = "Species") +
  theme_minimal() +
  theme(legend.position = "right")


#calc mean and standard deviation across sims
sim_stats <- sim_output_long %>%
  dplyr::group_by(Hour, Species) %>%
  dplyr::summarise(
    mean_rel_ab = mean(Relative_abundance),
    sd_rel_ab = sd(Relative_abundance),
    .groups = 'drop'
  )

# Prepare the data for plotting
plot_data <- sim_stats %>%
  dplyr::mutate(Upper = mean_rel_ab + sd_rel_ab, Lower = mean_rel_ab - sd_rel_ab)

ggplot(subset(plot_data, Species != "Drug"), aes(x = Hour, y = mean_rel_ab, group = Species, color = Species)) +
  geom_ribbon(aes(ymin = Lower, ymax = Upper, fill = Species), colour = NA, alpha = 0.2) +  
  geom_line(size = 1, alpha = 0.7) + 
  scale_color_manual(values = species_colours_1) +
  scale_fill_manual(values = species_colours_1) +  
  labs(title = "Mean and SD of Relative Abundance Across Simulations",
       subtitle = paste0("Sertindole = ", drug_concentration_tested),       
       x = "Time (hours)",
       y = "Relative abundance",
       color = "Species",
       fill = "Species") +
  theme_minimal() +
  theme(legend.position = "right")

#log-scaled mean trends
ggplot(plot_data, aes(x = Hour, y = log10(mean_rel_ab + 0.0001), group = Species, color = Species)) +
  geom_line(size = 1, alpha = 0.7) +  # Mean line
  scale_color_manual(values = species_colours_1) +
  scale_fill_manual(values = species_colours_1) +  # Ensure consistent colors for lines and fills
  labs(title = "Mean and SD of Relative Abundance Across Simulations",
       subtitle = paste0("Sertindole = ", drug_concentration_tested),
       x = "Time (hours)",
       y = "Relative abundance",
       color = "Species",
       fill = "Species") +
  theme_minimal() +
  theme(legend.position = "right")




##prediction quality evaluation
drug_tested <- "Sertindole"
variable_name <- paste0("plot_data_", ifelse(drug_concentration_tested == 1e-04, 0, drug_concentration_tested), "_", drug_tested)
assign(variable_name, plot_data)


#extract total OD info:
predicted_mean_final_od_NULL <- Niclosamide_16S_0uM_summarised$mean_com_final_OD[1]
predicted_sd_final_od_NULL <- Niclosamide_16S_0uM_summarised$sd_com_final_OD[1]

predicted_mean_final_od_5_Sertindole <- mean(subset(sim_output_wide_5_Sertindole, Hour == 48)$Total_OD, na.rm = TRUE)
predicted_sd_final_od_5_Sertindole <- sd(subset(sim_output_wide_5_Sertindole, Hour == 48)$Total_OD, na.rm = TRUE)

real_mean_final_od_5_Sertindole <- Community_compositions_focus_drugs_Sertindole_5uM_summarised$mean_final_OD[1]
real_sd_final_od_5_Sertindole <- Community_compositions_focus_drugs_Sertindole_5uM_summarised$sd_final_OD[1]


predicted_mean_final_od_20_Sertindole <- mean(subset(sim_output_wide_20_Sertindole, Hour == 48)$Total_OD, na.rm = TRUE)
predicted_sd_final_od_20_Sertindole <- sd(subset(sim_output_wide_20_Sertindole, Hour == 48)$Total_OD, na.rm = TRUE)

real_mean_final_od_20_Sertindole <- Community_compositions_focus_drugs_Sertindole_20uM_summarised$mean_final_OD[1]
real_sd_final_od_20_Sertindole <- Community_compositions_focus_drugs_Sertindole_20uM_summarised$sd_final_OD[1]


predicted_mean_final_od_80_Sertindole <- mean(subset(sim_output_wide_80_Sertindole, Hour == 48)$Total_OD, na.rm = TRUE)
predicted_sd_final_od_80_Sertindole <- sd(subset(sim_output_wide_80_Sertindole, Hour == 48)$Total_OD, na.rm = TRUE)

real_mean_final_od_80_Sertindole <- Community_compositions_focus_drugs_Sertindole_80uM_summarised$mean_final_OD[1]
real_sd_final_od_80_Sertindole <- Community_compositions_focus_drugs_Sertindole_80uM_summarised$sd_final_OD[1]




#plot_data_0_Sertindole_endpoint was used to test model performance at 0 drugs
#plot_data_0_Sertindole_endpoint <- subset(plot_data_0_Sertindole, Hour == 48 & Species != "Drug")
plot_data_5_Sertindole_endpoint <- subset(plot_data_5_Sertindole, Hour == 48 & Species != "Drug")
plot_data_20_Sertindole_endpoint <- subset(plot_data_20_Sertindole, Hour == 48 & Species != "Drug")
plot_data_80_Sertindole_endpoint <- subset(plot_data_80_Sertindole, Hour == 48 & Species != "Drug")

##Inspecting 'match' to real relative abundance distributions:
Niclosamide_16S_0uM_summarised <- rel_ab_control
Niclosamide_16S_0uM_summarised$Species <- gsub("\\.", "", Niclosamide_16S_0uM_summarised$Species)

Sertindole_16S_5uM_summarised <- Community_compositions_focus_drugs_Sertindole_5uM_summarised
Sertindole_16S_20uM_summarised <- Community_compositions_focus_drugs_Sertindole_20uM_summarised
Sertindole_16S_80uM_summarised <- Community_compositions_focus_drugs_Sertindole_80uM_summarised

Niclosamide_16S_0uM_summarised
Sertindole_16S_5uM_summarised 
Sertindole_16S_20uM_summarised 
Sertindole_16S_80uM_summarised 

#Rename 'species' so the outputs become comparable
original_names_80 <- unique(Sertindole_16S_80uM_summarised$species)
original_names_20 <- unique(Sertindole_16S_20uM_summarised$species)
original_names_5 <- unique(Sertindole_16S_5uM_summarised$species)


##Create a named vector with the original and new names mapping
name_changes <- c(
  "Akkermansia muciniphila" = "A_muciniphila",
  "Bacteroides fragilis" = "B_fragilis",
  "Bacteroides thetaiotaomicron" = "B_thetaiotaomicron",
  "Bacteroides uniformis" = "B_uniformis",
  "Bifidobacterium adolescentis" = "B_adolescentis",
  "Bifidobacterium longum subsp. longum" = "B_longum",
  "Bilophila wadsworthia" = "B_wadsworthia",
  "Blautia obeum" = "B_obeum",
  "Clostridium perfringens" = "C_perfringens",
  "Collinsella aerofaciens" = "C_aerofaciens",
  "Coprococcus comes" = "C_comes",
  "Dorea formicigenerans" = "D_formicigenerans",
  "Eggerthella lenta" = "E_lenta",
  "Enterocloster bolteae" = "C_bolteae",
  "Erysipelatoclostridium ramosum" = "C_ramosum",
  "Escherichia coli ED1a" = "E_coli",
  "Eubacterium rectale" = "E_rectale",
  "Fusobacterium nucleatum subsp. nucleatum" = "F_nucleatum",
  "Lacrimispora saccharolytica" = "C_saccharolyticum",
  "Lacticaseibacillus paracasei" = "L_paracasei",
  "Odoribacter splanchnicus" = "O_splanchnicus",
  "Parabacteroides distasonis" = "P_distasonis",
  "Parabacteroides merdae" = "P_merdae",
  "Phocaeicola vulgatus" = "B_vulgatus",
  "Prevotella copri" = "P_copri",
  "Roseburia intestinalis" = "R_intestinalis",
  "Ruminococcus bromii" = "R_bromii",
  "Ruminococcus gnavus" = "R_gnavus",
  "Ruminococcus torques" = "R_torques",
  "Streptococcus parasanguinis" = "S_parasanguinis",
  "Streptococcus salivarius" = "S_salivarius",
  "Veillonella parvula" = "V_parvula"
)

# Apply name changes to the species column in Sertindole_16S_80uM_summarised

Sertindole_16S_80uM_summarised$Species <- name_changes[Sertindole_16S_80uM_summarised$species]
Sertindole_16S_20uM_summarised$Species <- name_changes[Sertindole_16S_20uM_summarised$species]
Sertindole_16S_5uM_summarised$Species <- name_changes[Sertindole_16S_5uM_summarised$species]

# Verify the changes
unique(Sertindole_16S_80uM_summarised$Species)
unique(Sertindole_16S_20uM_summarised$Species)
unique(Sertindole_16S_5uM_summarised$Species)



##First, for 5 uM:
# Get top 6 species from plot_data_5_endpoint
# Adjust the plot_data_5_endpoint with confidence bounds

# #plot_data_0_Sertindole_endpoint was used to test model performance at 0 drugs
# plot_data_0_Sertindole_endpoint <- plot_data_0_Sertindole_endpoint %>%
#   dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)

plot_data_5_Sertindole_endpoint <- plot_data_5_Sertindole_endpoint %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)

# Adjust the Sertindole_16S_5uM_summarised with confidence bounds
Sertindole_16S_5uM_summarised <- Sertindole_16S_5uM_summarised %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)

#NULL model:
Null_model_summarised <- Niclosamide_16S_0uM_summarised %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)


# Get top 6 species based on the lower bound from plot_data_5_endpoint

#top6_predicted_0_Sertindole was used to test model performance at 0 drugs
# top6_predicted_0_Sertindole <- plot_data_0_Sertindole_endpoint %>%
#    arrange(desc(lower_bound)) %>%
#    slice(1:6) %>%
#    pull(Species)

top6_predicted_5_Sertindole <- plot_data_5_Sertindole_endpoint %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

# Get top 6 species based on the lower bound from Sertindole_16S_5uM_summarised
top6_real_5_Sertindole <- Sertindole_16S_5uM_summarised %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

top6_NULL <- Null_model_summarised %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

# Calculate the overlap of top 6 species

#top_six_correct_0_Sertindole was used to assess model performance at 0 drugs
# top_six_correct_0_Sertindole <- length(intersect(top6_predicted_0_Sertindole, top6_NULL))
# top_six_correct_0_Sertindole

top_six_correct_5_Sertindole <- length(intersect(top6_predicted_5_Sertindole, top6_real_5_Sertindole))
top_six_correct_5_Sertindole

top_six_correct_5_Sertindole_NULL <- length(intersect(top6_NULL, top6_real_5_Sertindole))
top_six_correct_5_Sertindole_NULL

top6_predicted_5_Sertindole
top6_real_5_Sertindole

#top6_NULL

#Now by means:
# #top6_predicted_0_Sertindole_means was used to assess model performance at 0 drugs
# top6_predicted_0_Sertindole_means <- plot_data_0_Sertindole_endpoint %>%
#    arrange(desc(mean_rel_ab)) %>%
#    slice(1:6) %>%
#    pull(Species)

top6_predicted_5_Sertindole_means <- plot_data_5_Sertindole_endpoint %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)

# Get top 6 species based on the lower bound from Sertindole_16S_5uM_summarised
top6_real_5_Sertindole_means <- Sertindole_16S_5uM_summarised %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)

top6_NULL_means <- Null_model_summarised %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)


# #top_six_correct_0_Sertindole_means was used to assess model performance at 0 drugs
# top_six_correct_0_Sertindole_means <- length(intersect(top6_predicted_0_Sertindole_means, top6_NULL_means))
# top_six_correct_0_Sertindole_means

top_six_correct_5_Sertindole_means <- length(intersect(top6_predicted_5_Sertindole_means, top6_real_5_Sertindole_means))
top_six_correct_5_Sertindole_means

top_six_correct_5_Sertindole_means_NULL <- length(intersect(top6_NULL_means, top6_real_5_Sertindole_means))
top_six_correct_5_Sertindole_means_NULL

top6_predicted_5_Sertindole_means
top6_real_5_Sertindole_means

#top6_NULL_means


# Merge dataframes by Species

#merged_data_0_Sertindole was used to assess model performance at 0 drugs
#merged_data_0_Sertindole <- merge(plot_data_0_Sertindole_endpoint, Niclosamide_16S_0uM_summarised, by = "Species", suffixes = c(".pred", ".real"))
merged_data_5_Sertindole <- merge(plot_data_5_Sertindole_endpoint, Sertindole_16S_5uM_summarised, by = "Species", suffixes = c(".pred", ".real"))
merged_data_5_Sertindole_NULL <- merge(Niclosamide_16S_0uM_summarised, Sertindole_16S_5uM_summarised, by = "Species", suffixes = c(".null", ".real"))


## Below lines used for assessing model performance at 0 drugs; ignore for nonzero concentrations
# # Create lower and upper bounds considering mean ¬± sd
# merged_data_0_Sertindole$lower_bound_pred <- merged_data_0_Sertindole$mean_rel_ab.pred - merged_data_0_Sertindole$sd_rel_ab.pred
# merged_data_0_Sertindole$upper_bound_pred <- merged_data_0_Sertindole$mean_rel_ab.pred + merged_data_0_Sertindole$sd_rel_ab.pred
# merged_data_0_Sertindole$lower_bound_real <- merged_data_0_Sertindole$mean_rel_ab.real - merged_data_0_Sertindole$sd_rel_ab.real
# merged_data_0_Sertindole$upper_bound_real <- merged_data_0_Sertindole$mean_rel_ab.real + merged_data_0_Sertindole$sd_rel_ab.real
# 
# # Ensure lower and upper bounds are non-negative, adjusting as necessary
# merged_data_0_Sertindole$lower_bound_pred[merged_data_0_Sertindole$lower_bound_pred <= 0] <- 1e-10
# merged_data_0_Sertindole$lower_bound_real[merged_data_0_Sertindole$lower_bound_real <= 0] <- 1e-10
# merged_data_0_Sertindole$upper_bound_pred[merged_data_0_Sertindole$upper_bound_pred <= 0] <- 1e-10
# merged_data_0_Sertindole$upper_bound_real[merged_data_0_Sertindole$upper_bound_real <= 0] <- 1e-10


# Create lower and upper bounds considering mean ¬± sd
merged_data_5_Sertindole$lower_bound_pred <- merged_data_5_Sertindole$mean_rel_ab.pred - merged_data_5_Sertindole$sd_rel_ab.pred
merged_data_5_Sertindole$upper_bound_pred <- merged_data_5_Sertindole$mean_rel_ab.pred + merged_data_5_Sertindole$sd_rel_ab.pred
merged_data_5_Sertindole$lower_bound_real <- merged_data_5_Sertindole$mean_rel_ab.real - merged_data_5_Sertindole$sd_rel_ab.real
merged_data_5_Sertindole$upper_bound_real <- merged_data_5_Sertindole$mean_rel_ab.real + merged_data_5_Sertindole$sd_rel_ab.real

# Ensure lower and upper bounds are non-negative, adjusting as necessary
merged_data_5_Sertindole$lower_bound_pred[merged_data_5_Sertindole$lower_bound_pred <= 0] <- 1e-10
merged_data_5_Sertindole$lower_bound_real[merged_data_5_Sertindole$lower_bound_real <= 0] <- 1e-10
merged_data_5_Sertindole$upper_bound_pred[merged_data_5_Sertindole$upper_bound_pred <= 0] <- 1e-10
merged_data_5_Sertindole$upper_bound_real[merged_data_5_Sertindole$upper_bound_real <= 0] <- 1e-10

##and for NULL model:
# Create lower and upper bounds considering mean ¬± sd
merged_data_5_Sertindole_NULL$lower_bound_null <- merged_data_5_Sertindole_NULL$mean_rel_ab.null - merged_data_5_Sertindole_NULL$sd_rel_ab.null
merged_data_5_Sertindole_NULL$upper_bound_null <- merged_data_5_Sertindole_NULL$mean_rel_ab.null + merged_data_5_Sertindole_NULL$sd_rel_ab.null
merged_data_5_Sertindole_NULL$lower_bound_real <- merged_data_5_Sertindole_NULL$mean_rel_ab.real - merged_data_5_Sertindole_NULL$sd_rel_ab.real
merged_data_5_Sertindole_NULL$upper_bound_real <- merged_data_5_Sertindole_NULL$mean_rel_ab.real + merged_data_5_Sertindole_NULL$sd_rel_ab.real

# Ensure lower and upper bounds are non-negative, adjusting as necessary
merged_data_5_Sertindole_NULL$lower_bound_null[merged_data_5_Sertindole_NULL$lower_bound_null <= 0] <- 1e-10
merged_data_5_Sertindole_NULL$lower_bound_real[merged_data_5_Sertindole_NULL$lower_bound_real <= 0] <- 1e-10
merged_data_5_Sertindole_NULL$upper_bound_null[merged_data_5_Sertindole_NULL$upper_bound_null <= 0] <- 1e-10
merged_data_5_Sertindole_NULL$upper_bound_real[merged_data_5_Sertindole_NULL$upper_bound_real <= 0] <- 1e-10

# Filter to include only species with a mean relative abundance > 0.01 in the 'real' dataset

## significant_species_0 was used to assess model performance at 0 drugs
#significant_species_0 <- merged_data_0_Sertindole[merged_data_0_Sertindole$mean_rel_ab.real > 0.01, ]
significant_species <- merged_data_5_Sertindole[merged_data_5_Sertindole$mean_rel_ab.real > 0.01, ]
survivors_5_Sertindole <- nrow(significant_species)
survivors_5_Sertindole

#should be the same as survivors defined above, since it is calculated from .real
significant_species_NULL <- merged_data_5_Sertindole_NULL[merged_data_5_Sertindole_NULL$mean_rel_ab.real > 0.01, ]
survivors_5_Sertindole_NULL <- nrow(significant_species_NULL)
survivors_5_Sertindole_NULL

# Adjusted order of magnitude check to include SD, only for significant species
## below code was used to assess model performance at 0 drugs
# significant_species_0$Predicted_magnitude_correct <- ifelse(
#   (floor(log10(significant_species_0$lower_bound_pred)) <= floor(log10(significant_species_0$upper_bound_real)) &
#      floor(log10(significant_species_0$upper_bound_pred)) >= floor(log10(significant_species_0$lower_bound_real))),
#   1,
#   0
# )

significant_species$Predicted_magnitude_correct <- ifelse(
  (floor(log10(significant_species$lower_bound_pred)) <= floor(log10(significant_species$upper_bound_real)) &
     floor(log10(significant_species$upper_bound_pred)) >= floor(log10(significant_species$lower_bound_real))),
  1,
  0
)

#and for the Null model:
significant_species_NULL$Predicted_magnitude_correct <- ifelse(
  (floor(log10(significant_species_NULL$lower_bound_null)) <= floor(log10(significant_species_NULL$upper_bound_real)) &
     floor(log10(significant_species_NULL$upper_bound_null)) >= floor(log10(significant_species_NULL$lower_bound_real))),
  1,
  0
)

# Calculate the fraction of correctly predicted magnitudes for significant species
## below code was used to assess model performance at 0 drugs
#predicted_magnitude_correct_fraction_0_Sertindole <- sum(significant_species_0$Predicted_magnitude_correct) / nrow(significant_species_0)
#predicted_magnitude_correct_fraction_0_Sertindole

predicted_magnitude_correct_fraction_5_Sertindole <- sum(significant_species$Predicted_magnitude_correct) / nrow(significant_species)
predicted_magnitude_correct_fraction_5_Sertindole

predicted_magnitude_correct_fraction_5_Sertindole_NULL <- sum(significant_species_NULL$Predicted_magnitude_correct) / nrow(significant_species_NULL)
predicted_magnitude_correct_fraction_5_Sertindole_NULL

top_species_missing_5_Sertindole <- setdiff(top6_real_5_Sertindole_means, top6_predicted_5_Sertindole_means)
top_species_wrong_5_Sertindole <- setdiff(top6_predicted_5_Sertindole_means, top6_real_5_Sertindole_means)

top_species_missing_5_Sertindole <- if(length(top_species_missing_5_Sertindole) == 0) "None" else top_species_missing_5_Sertindole
top_species_wrong_5_Sertindole <- if(length(top_species_wrong_5_Sertindole) == 0) "None" else top_species_wrong_5_Sertindole

Prediction_quality_5_Sertindole <- data.frame(
  Top_six_correct = paste(top_six_correct_5_Sertindole, sep=""),
  Top_six_correct_NULL = paste(top_six_correct_5_Sertindole_NULL, sep=""),
  Top_six_correct_means = paste(top_six_correct_5_Sertindole_means, sep=""),
  Top_six_correct_means_NULL = paste(top_six_correct_5_Sertindole_means_NULL, sep=""),
  Predicted_magnitude_correct = paste(round(predicted_magnitude_correct_fraction_5_Sertindole * 100, 2), "%", sep=""),
  Predicted_magnitude_correct_NULL = paste(round(predicted_magnitude_correct_fraction_5_Sertindole_NULL * 100, 2), "%", sep=""),
  survivors_total = survivors_5_Sertindole,
  top_species_missing <- top_species_missing_5_Sertindole,
  top_species_wrong <- top_species_wrong_5_Sertindole, 
  predicted_mean_final_OD <- predicted_mean_final_od_5_Sertindole,
  real_mean_final_OD <- real_mean_final_od_5_Sertindole,
  sims_total = length(successful_sim_ids)
)



Prediction_quality_5_Sertindole



##Next, for 20 uM:
# Get top 6 species from plot_data_20_endpoint
# Adjust the plot_data_20_endpoint with confidence bounds
plot_data_20_Sertindole_endpoint <- plot_data_20_Sertindole_endpoint %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)

# Adjust the Sertindole_16S_20uM_summarised with confidence bounds
Sertindole_16S_20uM_summarised <- Sertindole_16S_20uM_summarised %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)

#NULL model:
Null_model_summarised <- Niclosamide_16S_0uM_summarised %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)


# Get top 6 species based on the lower bound from plot_data_20_endpoint
top6_predicted_20_Sertindole <- plot_data_20_Sertindole_endpoint %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

# Get top 6 species based on the lower bound from Sertindole_16S_20uM_summarised
top6_real_20_Sertindole <- Sertindole_16S_20uM_summarised %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

top6_NULL <- Null_model_summarised %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

# Calculate the overlap of top 6 species
top_six_correct_20_Sertindole <- length(intersect(top6_predicted_20_Sertindole, top6_real_20_Sertindole))
#top_six_correct_20_Sertindole

top_six_correct_20_Sertindole_NULL <- length(intersect(top6_NULL, top6_real_20_Sertindole))
#top_six_correct_20_Sertindole_NULL

#top6_predicted_20_Sertindole
#top6_real_20_Sertindole



#Now by means:
top6_predicted_20_Sertindole_means <- plot_data_20_Sertindole_endpoint %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)

# Get top 6 species based on the lower bound from Sertindole_16S_20uM_summarised
top6_real_20_Sertindole_means <- Sertindole_16S_20uM_summarised %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)

top6_NULL_means <- Null_model_summarised %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)



top_six_correct_20_Sertindole_means <- length(intersect(top6_predicted_20_Sertindole_means, top6_real_20_Sertindole_means))
#top_six_correct_20_Sertindole_means

top_six_correct_20_Sertindole_means_NULL <- length(intersect(top6_NULL_means, top6_real_20_Sertindole_means))
#top_six_correct_20_Sertindole_means_NULL

top6_predicted_20_Sertindole_means
#top6_real_20_Sertindole_means




# Merge dataframes by Species
merged_data_20_Sertindole <- merge(plot_data_20_Sertindole_endpoint, Sertindole_16S_20uM_summarised, by = "Species", suffixes = c(".pred", ".real"))
merged_data_20_Sertindole_NULL <- merge(Niclosamide_16S_0uM_summarised, Sertindole_16S_20uM_summarised, by = "Species", suffixes = c(".null", ".real"))



# Create lower and upper bounds considering mean ¬± sd
merged_data_20_Sertindole$lower_bound_pred <- merged_data_20_Sertindole$mean_rel_ab.pred - merged_data_20_Sertindole$sd_rel_ab.pred
merged_data_20_Sertindole$upper_bound_pred <- merged_data_20_Sertindole$mean_rel_ab.pred + merged_data_20_Sertindole$sd_rel_ab.pred
merged_data_20_Sertindole$lower_bound_real <- merged_data_20_Sertindole$mean_rel_ab.real - merged_data_20_Sertindole$sd_rel_ab.real
merged_data_20_Sertindole$upper_bound_real <- merged_data_20_Sertindole$mean_rel_ab.real + merged_data_20_Sertindole$sd_rel_ab.real

# Ensure lower and upper bounds are non-negative, adjusting as necessary
merged_data_20_Sertindole$lower_bound_pred[merged_data_20_Sertindole$lower_bound_pred <= 0] <- 1e-10
merged_data_20_Sertindole$lower_bound_real[merged_data_20_Sertindole$lower_bound_real <= 0] <- 1e-10
merged_data_20_Sertindole$upper_bound_pred[merged_data_20_Sertindole$upper_bound_pred <= 0] <- 1e-10
merged_data_20_Sertindole$upper_bound_real[merged_data_20_Sertindole$upper_bound_real <= 0] <- 1e-10

##and for NULL model:
# Create lower and upper bounds considering mean ¬± sd
merged_data_20_Sertindole_NULL$lower_bound_null <- merged_data_20_Sertindole_NULL$mean_rel_ab.null - merged_data_20_Sertindole_NULL$sd_rel_ab.null
merged_data_20_Sertindole_NULL$upper_bound_null <- merged_data_20_Sertindole_NULL$mean_rel_ab.null + merged_data_20_Sertindole_NULL$sd_rel_ab.null
merged_data_20_Sertindole_NULL$lower_bound_real <- merged_data_20_Sertindole_NULL$mean_rel_ab.real - merged_data_20_Sertindole_NULL$sd_rel_ab.real
merged_data_20_Sertindole_NULL$upper_bound_real <- merged_data_20_Sertindole_NULL$mean_rel_ab.real + merged_data_20_Sertindole_NULL$sd_rel_ab.real

# Ensure lower and upper bounds are non-negative, adjusting as necessary
merged_data_20_Sertindole_NULL$lower_bound_null[merged_data_20_Sertindole_NULL$lower_bound_null <= 0] <- 1e-10
merged_data_20_Sertindole_NULL$lower_bound_real[merged_data_20_Sertindole_NULL$lower_bound_real <= 0] <- 1e-10
merged_data_20_Sertindole_NULL$upper_bound_null[merged_data_20_Sertindole_NULL$upper_bound_null <= 0] <- 1e-10
merged_data_20_Sertindole_NULL$upper_bound_real[merged_data_20_Sertindole_NULL$upper_bound_real <= 0] <- 1e-10

# Filter to include only species with a mean relative abundance > 0.01 in the 'real' dataset
significant_species <- merged_data_20_Sertindole[merged_data_20_Sertindole$mean_rel_ab.real > 0.01, ]
survivors_20_Sertindole <- nrow(significant_species)
survivors_20_Sertindole

#should be the same as survivors defined above, since it is calculated from .real
significant_species_NULL <- merged_data_20_Sertindole_NULL[merged_data_20_Sertindole_NULL$mean_rel_ab.real > 0.01, ]
survivors_20_Sertindole_NULL <- nrow(significant_species_NULL)
survivors_20_Sertindole_NULL

# Adjusted order of magnitude check to include SD, only for significant species
significant_species$Predicted_magnitude_correct <- ifelse(
  (floor(log10(significant_species$lower_bound_pred)) <= floor(log10(significant_species$upper_bound_real)) &
     floor(log10(significant_species$upper_bound_pred)) >= floor(log10(significant_species$lower_bound_real))),
  1,
  0
)

#and for the Null model:
significant_species_NULL$Predicted_magnitude_correct <- ifelse(
  (floor(log10(significant_species_NULL$lower_bound_null)) <= floor(log10(significant_species_NULL$upper_bound_real)) &
     floor(log10(significant_species_NULL$upper_bound_null)) >= floor(log10(significant_species_NULL$lower_bound_real))),
  1,
  0
)

# Calculate the fraction of correctly predicted magnitudes for significant species
predicted_magnitude_correct_fraction_20_Sertindole <- sum(significant_species$Predicted_magnitude_correct) / nrow(significant_species)
predicted_magnitude_correct_fraction_20_Sertindole

predicted_magnitude_correct_fraction_20_Sertindole_NULL <- sum(significant_species_NULL$Predicted_magnitude_correct) / nrow(significant_species_NULL)
predicted_magnitude_correct_fraction_20_Sertindole_NULL

top_species_missing_20_Sertindole <- setdiff(top6_real_20_Sertindole_means, top6_predicted_20_Sertindole_means)
top_species_wrong_20_Sertindole <- setdiff(top6_predicted_20_Sertindole_means, top6_real_20_Sertindole_means)

top_species_missing_20_Sertindole <- if(length(top_species_missing_20_Sertindole) == 0) "None" else top_species_missing_20_Sertindole
top_species_wrong_20_Sertindole <- if(length(top_species_wrong_20_Sertindole) == 0) "None" else top_species_wrong_20_Sertindole


Prediction_quality_20_Sertindole <- data.frame(
  Top_six_correct = paste(top_six_correct_20_Sertindole, sep=""),
  Top_six_correct_NULL = paste(top_six_correct_20_Sertindole_NULL, sep=""),
  Top_six_correct_means = paste(top_six_correct_20_Sertindole_means, sep=""),
  Top_six_correct_means_NULL = paste(top_six_correct_20_Sertindole_means_NULL, sep=""),
  Predicted_magnitude_correct = paste(round(predicted_magnitude_correct_fraction_20_Sertindole * 100, 2), "%", sep=""),
  Predicted_magnitude_correct_NULL = paste(round(predicted_magnitude_correct_fraction_20_Sertindole_NULL * 100, 2), "%", sep=""),
  survivors_total = survivors_20_Sertindole,
  top_species_missing <- top_species_missing_20_Sertindole,
  top_species_wrong <- top_species_wrong_20_Sertindole, 
  predicted_mean_final_OD <- predicted_mean_final_od_20_Sertindole,
  real_mean_final_OD <- real_mean_final_od_20_Sertindole,
  sims_total = length(successful_sim_ids)
)

Prediction_quality_20_Sertindole






##Next, for 80 uM:
# Get top 6 species from plot_data_80_endpoint
# Adjust the plot_data_80_endpoint with confidence bounds
plot_data_80_Sertindole_endpoint <- plot_data_80_Sertindole_endpoint %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)

# Adjust the Sertindole_16S_80uM_summarised with confidence bounds
Sertindole_16S_80uM_summarised <- Sertindole_16S_80uM_summarised %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)

#NULL model:
Null_model_summarised <- Niclosamide_16S_0uM_summarised %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)


# Get top 6 species based on the lower bound from plot_data_80_endpoint
top6_predicted_80_Sertindole <- plot_data_80_Sertindole_endpoint %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

# Get top 6 species based on the lower bound from Sertindole_16S_80uM_summarised
top6_real_80_Sertindole <- Sertindole_16S_80uM_summarised %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

top6_NULL <- Null_model_summarised %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

# Calculate the overlap of top 6 species
top_six_correct_80_Sertindole <- length(intersect(top6_predicted_80_Sertindole, top6_real_80_Sertindole))
#top_six_correct_80_Sertindole

top_six_correct_80_Sertindole_NULL <- length(intersect(top6_NULL, top6_real_80_Sertindole))
#top_six_correct_80_Sertindole_NULL

#top6_predicted_80_Sertindole
#top6_real_80_Sertindole




#Now by means:
top6_predicted_80_Sertindole_means <- plot_data_80_Sertindole_endpoint %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)

# Get top 6 species based on the lower bound from Sertindole_16S_80uM_summarised
top6_real_80_Sertindole_means <- Sertindole_16S_80uM_summarised %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)

top6_NULL_means <- Null_model_summarised %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)



top_six_correct_80_Sertindole_means <- length(intersect(top6_predicted_80_Sertindole_means, top6_real_80_Sertindole_means))
#top_six_correct_80_Sertindole_means

top_six_correct_80_Sertindole_means_NULL <- length(intersect(top6_NULL_means, top6_real_80_Sertindole_means))
#top_six_correct_80_Sertindole_means_NULL

#top6_predicted_80_Sertindole_means
#top6_real_80_Sertindole_means




# Merge dataframes by Species
merged_data_80_Sertindole <- merge(plot_data_80_Sertindole_endpoint, Sertindole_16S_80uM_summarised, by = "Species", suffixes = c(".pred", ".real"))
merged_data_80_Sertindole_NULL <- merge(Niclosamide_16S_0uM_summarised, Sertindole_16S_80uM_summarised, by = "Species", suffixes = c(".null", ".real"))



# Create lower and upper bounds considering mean ¬± sd
merged_data_80_Sertindole$lower_bound_pred <- merged_data_80_Sertindole$mean_rel_ab.pred - merged_data_80_Sertindole$sd_rel_ab.pred
merged_data_80_Sertindole$upper_bound_pred <- merged_data_80_Sertindole$mean_rel_ab.pred + merged_data_80_Sertindole$sd_rel_ab.pred
merged_data_80_Sertindole$lower_bound_real <- merged_data_80_Sertindole$mean_rel_ab.real - merged_data_80_Sertindole$sd_rel_ab.real
merged_data_80_Sertindole$upper_bound_real <- merged_data_80_Sertindole$mean_rel_ab.real + merged_data_80_Sertindole$sd_rel_ab.real

# Ensure lower and upper bounds are non-negative, adjusting as necessary
merged_data_80_Sertindole$lower_bound_pred[merged_data_80_Sertindole$lower_bound_pred <= 0] <- 1e-10
merged_data_80_Sertindole$lower_bound_real[merged_data_80_Sertindole$lower_bound_real <= 0] <- 1e-10
merged_data_80_Sertindole$upper_bound_pred[merged_data_80_Sertindole$upper_bound_pred <= 0] <- 1e-10
merged_data_80_Sertindole$upper_bound_real[merged_data_80_Sertindole$upper_bound_real <= 0] <- 1e-10

##and for NULL model:
# Create lower and upper bounds considering mean ¬± sd
merged_data_80_Sertindole_NULL$lower_bound_null <- merged_data_80_Sertindole_NULL$mean_rel_ab.null - merged_data_80_Sertindole_NULL$sd_rel_ab.null
merged_data_80_Sertindole_NULL$upper_bound_null <- merged_data_80_Sertindole_NULL$mean_rel_ab.null + merged_data_80_Sertindole_NULL$sd_rel_ab.null
merged_data_80_Sertindole_NULL$lower_bound_real <- merged_data_80_Sertindole_NULL$mean_rel_ab.real - merged_data_80_Sertindole_NULL$sd_rel_ab.real
merged_data_80_Sertindole_NULL$upper_bound_real <- merged_data_80_Sertindole_NULL$mean_rel_ab.real + merged_data_80_Sertindole_NULL$sd_rel_ab.real

# Ensure lower and upper bounds are non-negative, adjusting as necessary
merged_data_80_Sertindole_NULL$lower_bound_null[merged_data_80_Sertindole_NULL$lower_bound_null <= 0] <- 1e-10
merged_data_80_Sertindole_NULL$lower_bound_real[merged_data_80_Sertindole_NULL$lower_bound_real <= 0] <- 1e-10
merged_data_80_Sertindole_NULL$upper_bound_null[merged_data_80_Sertindole_NULL$upper_bound_null <= 0] <- 1e-10
merged_data_80_Sertindole_NULL$upper_bound_real[merged_data_80_Sertindole_NULL$upper_bound_real <= 0] <- 1e-10

# Filter to include only species with a mean relative abundance > 0.01 in the 'real' dataset
significant_species <- merged_data_80_Sertindole[merged_data_80_Sertindole$mean_rel_ab.real > 0.01, ]
survivors_80_Sertindole <- nrow(significant_species)
survivors_80_Sertindole

#should be the same as survivors defined above, since it is calculated from .real
significant_species_NULL <- merged_data_80_Sertindole_NULL[merged_data_80_Sertindole_NULL$mean_rel_ab.real > 0.01, ]
survivors_80_Sertindole_NULL <- nrow(significant_species_NULL)
survivors_80_Sertindole_NULL

# Adjusted order of magnitude check to include SD, only for significant species
significant_species$Predicted_magnitude_correct <- ifelse(
  (floor(log10(significant_species$lower_bound_pred)) <= floor(log10(significant_species$upper_bound_real)) &
     floor(log10(significant_species$upper_bound_pred)) >= floor(log10(significant_species$lower_bound_real))),
  1,
  0
)

#and for the Null model:
significant_species_NULL$Predicted_magnitude_correct <- ifelse(
  (floor(log10(significant_species_NULL$lower_bound_null)) <= floor(log10(significant_species_NULL$upper_bound_real)) &
     floor(log10(significant_species_NULL$upper_bound_null)) >= floor(log10(significant_species_NULL$lower_bound_real))),
  1,
  0
)

# Calculate the fraction of correctly predicted magnitudes for significant species
predicted_magnitude_correct_fraction_80_Sertindole <- sum(significant_species$Predicted_magnitude_correct) / nrow(significant_species)
predicted_magnitude_correct_fraction_80_Sertindole

predicted_magnitude_correct_fraction_80_Sertindole_NULL <- sum(significant_species_NULL$Predicted_magnitude_correct) / nrow(significant_species_NULL)
predicted_magnitude_correct_fraction_80_Sertindole_NULL


top_species_missing_80_Sertindole <- setdiff(top6_real_80_Sertindole_means, top6_predicted_80_Sertindole_means)
top_species_wrong_80_Sertindole <- setdiff(top6_predicted_80_Sertindole_means, top6_real_80_Sertindole_means)

Prediction_quality_80_Sertindole <- data.frame(
  Top_six_correct = paste(top_six_correct_80_Sertindole, sep=""),
  Top_six_correct_NULL = paste(top_six_correct_80_Sertindole_NULL, sep=""),
  Top_six_correct_means = paste(top_six_correct_80_Sertindole_means, sep=""),
  Top_six_correct_means_NULL = paste(top_six_correct_80_Sertindole_means_NULL, sep=""),
  Predicted_magnitude_correct = paste(round(predicted_magnitude_correct_fraction_80_Sertindole * 100, 2), "%", sep=""),
  Predicted_magnitude_correct_NULL = paste(round(predicted_magnitude_correct_fraction_80_Sertindole_NULL * 100, 2), "%", sep=""),
  survivors_total = survivors_80_Sertindole,
  top_species_missing <- top_species_missing_80_Sertindole,
  top_species_wrong <- top_species_wrong_80_Sertindole, 
  predicted_mean_final_OD <- predicted_mean_final_od_80_Sertindole,
  real_mean_final_OD <- real_mean_final_od_80_Sertindole,
  sims_total = length(successful_sim_ids)
)

Prediction_quality_80_Sertindole











##Simvastatin

combined_monoculture_aucs2_Simvastatin <- subset(combined_monoculture_aucs2, drug == "Simvastatin")


#drug sensitivity terms: define once outside of ODEs
y_function_B_vulgatus_Simvastatin <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("B_vulgatus", "Simvastatin", best_fitting_models_df_Simvastatin)), collapse = " ")))
y_function_B_uniformis_Simvastatin <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("B_uniformis", "Simvastatin", best_fitting_models_df_Simvastatin)), collapse = " ")))
y_function_B_fragilis_Simvastatin <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("B_fragilis", "Simvastatin", best_fitting_models_df_Simvastatin)), collapse = " ")))
y_function_B_thetaiotaomicron_Simvastatin <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("B_thetaiotaomicron", "Simvastatin", best_fitting_models_df_Simvastatin)), collapse = " ")))
y_function_C_ramosum_Simvastatin <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("C_ramosum", "Simvastatin", best_fitting_models_df_Simvastatin)), collapse = " ")))
y_function_E_rectale_Simvastatin <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("E_rectale", "Simvastatin", best_fitting_models_df_Simvastatin)), collapse = " ")))
y_function_R_intestinalis_Simvastatin <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("R_intestinalis", "Simvastatin", best_fitting_models_df_Simvastatin)), collapse = " ")))
y_function_V_parvula_Simvastatin <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("V_parvula", "Simvastatin", best_fitting_models_df_Simvastatin)), collapse = " ")))
y_function_E_lenta_Simvastatin <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("E_lenta", "Simvastatin", best_fitting_models_df_Simvastatin)), collapse = " ")))
y_function_F_nucleatum_Simvastatin <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("F_nucleatum", "Simvastatin", best_fitting_models_df_Simvastatin)), collapse = " ")))
y_function_C_bolteae_Simvastatin <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("C_bolteae", "Simvastatin", best_fitting_models_df_Simvastatin)), collapse = " ")))
y_function_C_perfringens_Simvastatin <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("C_perfringens", "Simvastatin", best_fitting_models_df_Simvastatin)), collapse = " ")))
y_function_C_saccharolyticum_Simvastatin <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("C_saccharolyticum", "Simvastatin", best_fitting_models_df_Simvastatin)), collapse = " ")))
y_function_S_salivarius_Simvastatin <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("S_salivarius", "Simvastatin", best_fitting_models_df_Simvastatin)), collapse = " ")))
y_function_R_gnavus_Simvastatin <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("R_gnavus", "Simvastatin", best_fitting_models_df_Simvastatin)), collapse = " ")))
y_function_C_comes_Simvastatin <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("C_comes", "Simvastatin", best_fitting_models_df_Simvastatin)), collapse = " ")))
y_function_P_merdae_Simvastatin <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("P_merdae", "Simvastatin", best_fitting_models_df_Simvastatin)), collapse = " ")))
y_function_S_parasanguinis_Simvastatin <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("S_parasanguinis", "Simvastatin", best_fitting_models_df_Simvastatin)), collapse = " ")))
y_function_C_aerofaciens_Simvastatin <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("C_aerofaciens", "Simvastatin", best_fitting_models_df_Simvastatin)), collapse = " ")))
y_function_D_formicigenerans_Simvastatin <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("D_formicigenerans", "Simvastatin", best_fitting_models_df_Simvastatin)), collapse = " ")))
y_function_E_coli_Simvastatin <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("E_coli", "Simvastatin", best_fitting_models_df_Simvastatin)), collapse = " ")))



y_function_B_vulgatus_Simvastatin_func <- eval(parse(text = paste("function(Drug) {", y_function_B_vulgatus_Simvastatin, "}")))
y_function_B_uniformis_Simvastatin_func <- eval(parse(text = paste("function(Drug) {", y_function_B_uniformis_Simvastatin, "}")))
y_function_B_fragilis_Simvastatin_func <- eval(parse(text = paste("function(Drug) {", y_function_B_fragilis_Simvastatin, "}")))
y_function_B_thetaiotaomicron_Simvastatin_func <- eval(parse(text = paste("function(Drug) {", y_function_B_thetaiotaomicron_Simvastatin, "}")))
y_function_C_ramosum_Simvastatin_func <- eval(parse(text = paste("function(Drug) {", y_function_C_ramosum_Simvastatin, "}")))
y_function_E_rectale_Simvastatin_func <- eval(parse(text = paste("function(Drug) {", y_function_E_rectale_Simvastatin, "}")))
y_function_R_intestinalis_Simvastatin_func <- eval(parse(text = paste("function(Drug) {", y_function_R_intestinalis_Simvastatin, "}")))
y_function_E_lenta_Simvastatin_func <- eval(parse(text = paste("function(Drug) {", y_function_E_lenta_Simvastatin, "}")))
y_function_F_nucleatum_Simvastatin_func <- eval(parse(text = paste("function(Drug) {", y_function_F_nucleatum_Simvastatin, "}")))
y_function_C_bolteae_Simvastatin_func <- eval(parse(text = paste("function(Drug) {", y_function_C_bolteae_Simvastatin, "}")))
y_function_C_perfringens_Simvastatin_func <- eval(parse(text = paste("function(Drug) {", y_function_C_perfringens_Simvastatin, "}")))
y_function_C_saccharolyticum_Simvastatin_func <- eval(parse(text = paste("function(Drug) {", y_function_C_saccharolyticum_Simvastatin, "}")))
y_function_S_salivarius_Simvastatin_func <- eval(parse(text = paste("function(Drug) {", y_function_S_salivarius_Simvastatin, "}")))
y_function_R_gnavus_Simvastatin_func <- eval(parse(text = paste("function(Drug) {", y_function_R_gnavus_Simvastatin, "}")))
y_function_C_comes_Simvastatin_func <- eval(parse(text = paste("function(Drug) {", y_function_C_comes_Simvastatin, "}")))
y_function_P_merdae_Simvastatin_func <- eval(parse(text = paste("function(Drug) {", y_function_P_merdae_Simvastatin, "}")))
y_function_S_parasanguinis_Simvastatin_func <- eval(parse(text = paste("function(Drug) {", y_function_S_parasanguinis_Simvastatin, "}")))
y_function_C_aerofaciens_Simvastatin_func <- eval(parse(text = paste("function(Drug) {", y_function_C_aerofaciens_Simvastatin, "}")))
y_function_D_formicigenerans_Simvastatin_func <- eval(parse(text = paste("function(Drug) {", y_function_D_formicigenerans_Simvastatin, "}")))
y_function_E_coli_Simvastatin_func <- eval(parse(text = paste("function(Drug) {", y_function_E_coli_Simvastatin, "}")))
y_function_V_parvula_Simvastatin_func <- eval(parse(text = paste("function(Drug) {", y_function_V_parvula_Simvastatin, "}")))



unique(combined_monoculture_aucs2_Simvastatin$conc)
##dictate drug concentration tested for simulation cycle here:
#drug_concentration_tested <- 5 #if manually or:
drug_concentration_tested <- unique(combined_monoculture_aucs2_Simvastatin$conc)[1]
initial_conditions <- rep(0.01/32, 32)
initial_conditions <- c(initial_conditions, drug_concentration_tested)


##drug effect fitted for species showing sensitivity in monoculture:
#unique(combined_monoculture_aucs2_Simvastatin$Species)

##for more simple linear fits
closed.sir.model_Simvastatin <- function (t, x, params) {
  ## first extract the state variables
  A_muciniphila <- x[1]
  B_adolescentis <- x[2]
  B_fragilis <- x[3]
  B_longum <- x[4]
  B_obeum <- x[5]
  B_thetaiotaomicron <- x[6]
  B_uniformis <- x[7]
  B_vulgatus <- x[8]
  B_wadsworthia <- x[9]
  C_aerofaciens <- x[10]
  C_bolteae <- x[11]
  C_comes <- x[12]
  C_perfringens <- x[13]
  C_ramosum <- x[14]
  C_saccharolyticum <- x[15]
  D_formicigenerans <- x[16]
  E_coli <- x[17]
  E_lenta <- x[18]
  E_rectale <- x[19]
  F_nucleatum <- x[20]
  L_paracasei <- x[21]
  O_splanchnicus <- x[22]
  P_copri <- x[23]
  P_distasonis <- x[24]
  P_merdae <- x[25]
  R_bromii <- x[26]
  R_gnavus <- x[27]
  R_intestinalis <- x[28]
  R_torques <- x[29]
  S_parasanguinis <- x[30]
  S_salivarius <- x[31]
  V_parvula <- x[32]
  Drug <- x[33]
  
  
  ## now extract the parameters
  r_B_fragilis <- flat_params[["B._fragilis.r"]]
  K_B_fragilis <- flat_params[["B._fragilis.K"]]
  r_B_longum <- flat_params[["B._longum.r"]]
  K_B_longum <- flat_params[["B._longum.K"]]
  r_B_thetaiotaomicron <- flat_params[["B._thetaiotaomicron.r"]]
  K_B_thetaiotaomicron <- flat_params[["B._thetaiotaomicron.K"]]
  r_B_uniformis <- flat_params[["B._uniformis.r"]]
  K_B_uniformis <- flat_params[["B._uniformis.K"]]
  r_B_vulgatus <- flat_params[["B._vulgatus.r"]]
  K_B_vulgatus <- flat_params[["B._vulgatus.K"]]
  r_B_wadsworthia <- flat_params[["B._wadsworthia.r"]]
  K_B_wadsworthia <- flat_params[["B._wadsworthia.K"]]
  r_C_aerofaciens <- flat_params[["C._aerofaciens.r"]]
  K_C_aerofaciens <- flat_params[["C._aerofaciens.K"]]
  r_C_bolteae <- flat_params[["C._bolteae.r"]]
  K_C_bolteae <- flat_params[["C._bolteae.K"]]
  r_C_comes <- flat_params[["C._comes.r"]]
  K_C_comes <- flat_params[["C._comes.K"]]
  r_C_perfringens <- flat_params[["C._perfringens.r"]]
  K_C_perfringens <- flat_params[["C._perfringens.K"]]
  r_C_ramosum <- flat_params[["C._ramosum.r"]]
  K_C_ramosum <- flat_params[["C._ramosum.K"]]
  r_C_saccharolyticum <- flat_params[["C._saccharolyticum.r"]]
  K_C_saccharolyticum <- flat_params[["C._saccharolyticum.K"]]
  r_D_formicigenerans <- flat_params[["D._formicigenerans.r"]]
  K_D_formicigenerans <- flat_params[["D._formicigenerans.K"]]
  r_E_coli <- flat_params[["E._coli.r"]]
  K_E_coli <- flat_params[["E._coli.K"]]
  r_E_lenta <- flat_params[["E._lenta.r"]]
  K_E_lenta <- flat_params[["E._lenta.K"]]
  r_E_rectale <- flat_params[["E._rectale.r"]]
  K_E_rectale <- flat_params[["E._rectale.K"]]
  r_F_nucleatum <- flat_params[["F._nucleatum.r"]]
  K_F_nucleatum <- flat_params[["F._nucleatum.K"]]
  r_P_copri <- flat_params[["P._copri.r"]]
  K_P_copri <- flat_params[["P._copri.K"]]
  r_P_merdae <- flat_params[["P._merdae.r"]]
  K_P_merdae <- flat_params[["P._merdae.K"]]
  r_R_gnavus <- flat_params[["R._gnavus.r"]]
  K_R_gnavus <- flat_params[["R._gnavus.K"]]
  r_R_intestinalis <- flat_params[["R._intestinalis.r"]]
  K_R_intestinalis <- flat_params[["R._intestinalis.K"]]
  r_V_parvula <- flat_params[["V._parvula.r"]]
  K_V_parvula <- flat_params[["V._parvula.K"]]
  r_A_muciniphila <- flat_params[["A._muciniphila.r"]]
  K_A_muciniphila <- flat_params[["A._muciniphila.K"]]
  r_B_adolescentis <- flat_params[["B._adolescentis.r"]]
  K_B_adolescentis <- flat_params[["B._adolescentis.K"]]
  r_B_obeum <- flat_params[["B._obeum.r"]]
  K_B_obeum <- flat_params[["B._obeum.K"]]
  r_O_splanchnicus <- flat_params[["O._splanchnicus.r"]]
  K_O_splanchnicus <- flat_params[["O._splanchnicus.K"]]
  r_P_distasonis <- flat_params[["P._distasonis.r"]]
  K_P_distasonis <- flat_params[["P._distasonis.K"]]
  r_R_bromii <- flat_params[["R._bromii.r"]]
  K_R_bromii <- flat_params[["R._bromii.K"]]
  r_R_torques <- flat_params[["R._torques.r"]]
  K_R_torques <- flat_params[["R._torques.K"]]
  r_S_parasanguinis <- flat_params[["S._parasanguinis.r"]]
  K_S_parasanguinis <-flat_params[["S._parasanguinis.K"]]
  r_S_salivarius <- flat_params[["S._salivarius.r"]]
  K_S_salivarius <- flat_params[["S._salivarius.K"]]
  r_L_paracasei <- flat_params[["L._paracasei.r"]]
  K_L_paracasei <- flat_params[["L._paracasei.K"]]
  
  
  t_mod <- ifelse(t > 24.1, t - 24.1, t)
  
  
  ## now code the model equations
  dA_muciniphila_dt <- r_A_muciniphila * A_muciniphila * (1 - A_muciniphila / K_A_muciniphila)
  dB_adolescentis_dt <- r_B_adolescentis * B_adolescentis * (1 - B_adolescentis / K_B_adolescentis)
  dB_fragilis_dt <- r_B_fragilis * B_fragilis * (1 - B_fragilis / max(0.0001, K_B_fragilis * (y_function_B_fragilis_Simvastatin_func(Drug))))
  dB_longum_dt <- r_B_longum * B_longum * (1 - B_longum / K_B_longum)
  dB_obeum_dt <- r_B_obeum * B_obeum * (1 - B_obeum / K_B_obeum)
  dB_thetaiotaomicron_dt <- r_B_thetaiotaomicron * B_thetaiotaomicron * (1 - B_thetaiotaomicron / max(0.0001, K_B_thetaiotaomicron * (y_function_B_thetaiotaomicron_Simvastatin_func(Drug))))  
  dB_uniformis_dt <- r_B_uniformis * B_uniformis * (1 - B_uniformis / max(0.0001, K_B_uniformis * (y_function_B_uniformis_Simvastatin_func(Drug))))
  dB_vulgatus_dt <- r_B_vulgatus * B_vulgatus * (1 - B_vulgatus / max(0.0001, K_B_vulgatus * (y_function_B_vulgatus_Simvastatin_func(Drug))))
  dB_wadsworthia_dt <- r_B_wadsworthia * B_wadsworthia * (1 - B_wadsworthia / K_B_wadsworthia)
  dC_aerofaciens_dt <- r_C_aerofaciens * C_aerofaciens * (1 - C_aerofaciens / max(0.0001, K_C_aerofaciens * (y_function_C_aerofaciens_Simvastatin_func(Drug))))
  dC_bolteae_dt <- r_C_bolteae * C_bolteae * (1 - C_bolteae /  max(0.0001, K_C_bolteae * (y_function_C_bolteae_Simvastatin_func(Drug))))
  dC_comes_dt <- r_C_comes * C_comes * (1 - C_comes / max(0.0001, K_C_comes * (y_function_C_comes_Simvastatin_func(Drug))))
  dC_perfringens_dt <- r_C_perfringens * C_perfringens * (1 - C_perfringens / max(0.0001, K_C_perfringens * (y_function_C_perfringens_Simvastatin_func(Drug))))
  dC_ramosum_dt <- r_C_ramosum * C_ramosum * (1 - C_ramosum / max(0.0001, K_C_ramosum * (y_function_C_ramosum_Simvastatin_func(Drug))))
  dC_saccharolyticum_dt <- r_C_saccharolyticum * C_saccharolyticum * (1 - C_saccharolyticum / max(0.0001, K_C_saccharolyticum * (y_function_C_saccharolyticum_Simvastatin_func(Drug))))
  dD_formicigenerans_dt <- r_D_formicigenerans * D_formicigenerans * (1 - D_formicigenerans / max(0.0001, K_D_formicigenerans * (y_function_D_formicigenerans_Simvastatin_func(Drug))))
  dE_coli_dt <- r_E_coli * E_coli * (1 - E_coli / max(0.0001, K_E_coli * (y_function_E_coli_Simvastatin_func(Drug))))
  dE_lenta_dt <- r_E_lenta * E_lenta * (1 - E_lenta / max(0.0001, K_E_lenta * (y_function_E_lenta_Simvastatin_func(Drug))))
  dE_rectale_dt <- r_E_rectale * E_rectale * (1 - E_rectale / max(0.0001, K_E_rectale * (y_function_E_rectale_Simvastatin_func(Drug))))
  dF_nucleatum_dt <- r_F_nucleatum * F_nucleatum * (1 - F_nucleatum / max(0.0001, K_F_nucleatum * (y_function_F_nucleatum_Simvastatin_func(Drug))))
  dL_paracasei_dt <- r_L_paracasei * L_paracasei * (1 - L_paracasei / K_L_paracasei)  
  dO_splanchnicus_dt <- r_O_splanchnicus * O_splanchnicus * (1 - O_splanchnicus / K_O_splanchnicus)  
  dP_copri_dt <- r_P_copri * P_copri * (1 - P_copri / K_P_copri)
  dP_distasonis_dt <- r_P_distasonis * P_distasonis * (1 - P_distasonis / K_P_distasonis)  
  dP_merdae_dt <- r_P_merdae * P_merdae * (1 - P_merdae / max(0.0001, K_P_merdae * (y_function_P_merdae_Simvastatin_func(Drug))))
  dR_bromii_dt <- r_R_bromii * R_bromii * (1 - R_bromii / K_R_bromii) 
  dR_gnavus_dt <- r_R_gnavus * R_gnavus * (1 - R_gnavus / max(0.0001, K_R_gnavus * (y_function_R_gnavus_Simvastatin_func(Drug))))
  dR_intestinalis_dt <- r_R_intestinalis * R_intestinalis * (1 - R_intestinalis / max(0.0001, K_R_intestinalis * (y_function_R_intestinalis_Simvastatin_func(Drug))))
  dR_torques_dt <- r_R_torques * R_torques * (1 - R_torques /K_R_torques) 
  dS_parasanguinis_dt <- r_S_parasanguinis * S_parasanguinis * (1 - S_parasanguinis / max(0.0001, K_S_parasanguinis * (y_function_S_parasanguinis_Simvastatin_func(Drug))))
  dS_salivarius_dt <- r_S_salivarius * S_salivarius * (1 - S_salivarius / max(0.0001, K_S_salivarius * (y_function_S_salivarius_Simvastatin_func(Drug))))
  dV_parvula_dt <- r_V_parvula * V_parvula * (1 - V_parvula / max(0.0001, K_V_parvula * (y_function_V_parvula_Simvastatin_func(Drug))))
  
  
  
  #Drug differential:
  dDrug_dt <- (subset(drug_dynamics, Drug == "Simvastatin")$Steepness_param_community * exp(-subset(drug_dynamics, Drug == "Simvastatin")$Steepness_param_community * t_mod)) * (drug_concentration_tested * prop_left_Simvastatin - drug_concentration_tested)
  #dDrug_dt <- 0
  
  ## Combine results into a single vector
  dxdt <- c(dA_muciniphila_dt, dB_adolescentis_dt, dB_fragilis_dt, dB_longum_dt, dB_obeum_dt, dB_thetaiotaomicron_dt, dB_uniformis_dt, dB_vulgatus_dt, dB_wadsworthia_dt, dC_aerofaciens_dt, dC_bolteae_dt, dC_comes_dt, dC_perfringens_dt, dC_ramosum_dt, dC_saccharolyticum_dt, dD_formicigenerans_dt, dE_coli_dt, dE_lenta_dt, dE_rectale_dt, dF_nucleatum_dt, dL_paracasei_dt, dO_splanchnicus_dt, dP_copri_dt, dP_distasonis_dt, dP_merdae_dt, dR_bromii_dt, dR_gnavus_dt, dR_intestinalis_dt, dR_torques_dt, dS_parasanguinis_dt, dS_salivarius_dt, dV_parvula_dt, dDrug_dt)
  
  ## Return result as a list
  list(dxdt)
}




#calculate the co-culture correction factor per species based on community composition in absence of drug, just like done for Niclosamide

growth_data_all_0_Niclosamide
growth_data_all_0_Niclosamide1 <- growth_data_all_0_Niclosamide %>%
  dplyr::mutate(Species = gsub(" ", "_", Species))


# Merge rel_ab_control with growth_data_all_0_Niclosamide on Species
# Function to remove duplicated columns by name pattern
clean_columns_base <- function(df, pattern) {
  cols_to_keep <- !grepl(pattern, names(df))
  df <- df[, cols_to_keep]
  return(df)
}

# Use the new function to clean up your dataframe
rel_ab_control <- clean_columns_base(rel_ab_control, "mean_max_OD.[xy]")
str(rel_ab_control)


#rel_ab_control$correction_factor <- rel_ab_control$mean_rel_ab / (rel_ab_control$mean_max_OD/sum(rel_ab_control$mean_max_OD))
# Calculate correction factor with a minimum value of ~1
rel_ab_control$correction_factor <- pmax(rel_ab_control$mean_rel_ab / (rel_ab_control$mean_max_OD / sum(rel_ab_control$mean_max_OD)), 1.1)


# Create a new dataframe for co-culture correction
co_culture_correction <- data.frame(
  species = rel_ab_control$Species,
  correction_factor = rel_ab_control$correction_factor
)


#summarise community data
#Adjust based on tested concentrations for each drug
unique(Community_compositions_focus_drugs_Simvastatin$concentration)

Community_compositions_focus_drugs_Simvastatin_5uM <- subset(Community_compositions_focus_drugs_Simvastatin, concentration == 5)
Community_compositions_focus_drugs_Simvastatin_20uM <- subset(Community_compositions_focus_drugs_Simvastatin, concentration == 20)
Community_compositions_focus_drugs_Simvastatin_80uM <- subset(Community_compositions_focus_drugs_Simvastatin, concentration == 80)


#5 uM
Community_compositions_focus_drugs_Simvastatin_5uM_summarised <- Community_compositions_focus_drugs_Simvastatin_5uM %>%
  dplyr::group_by(species) %>%                                  
  dplyr::summarize(
    mean_rel_ab = mean(rel_abundance, na.rm = TRUE),     
    sd_rel_ab = sd(rel_abundance, na.rm = TRUE) ,
    mean_max_OD = mean(maxOD, na.rm = TRUE),
    sd_max_OD = sd(maxOD, na.rm = TRUE),
    mean_final_OD = mean(finalOD, na.rm = TRUE),
    sd_final_OD = sd(finalOD, na.rm = TRUE)
  ) %>%
  dplyr::ungroup() 


Community_compositions_focus_drugs_Simvastatin_5uM_summarised <- Community_compositions_focus_drugs_Simvastatin_5uM_summarised %>%
  dplyr::mutate(Species = sub("^(\\w)\\w*\\s(.*)", "\\1._\\2", species))

#remove (sub)strain info
Community_compositions_focus_drugs_Simvastatin_5uM_summarised <- Community_compositions_focus_drugs_Simvastatin_5uM_summarised %>%
  dplyr::mutate(Species = sub("^(\\w\\._\\w+).*", "\\1", Species))


#20 uM
Community_compositions_focus_drugs_Simvastatin_20uM_summarised <- Community_compositions_focus_drugs_Simvastatin_20uM %>%
  dplyr::group_by(species) %>%                                  
  dplyr::summarize(
    mean_rel_ab = mean(rel_abundance, na.rm = TRUE),     
    sd_rel_ab = sd(rel_abundance, na.rm = TRUE) ,
    mean_max_OD = mean(maxOD, na.rm = TRUE),
    sd_max_OD = sd(maxOD, na.rm = TRUE),
    mean_final_OD = mean(finalOD, na.rm = TRUE),
    sd_final_OD = sd(finalOD, na.rm = TRUE)
  ) %>%
  dplyr::ungroup() 


Community_compositions_focus_drugs_Simvastatin_20uM_summarised <- Community_compositions_focus_drugs_Simvastatin_20uM_summarised %>%
  dplyr::mutate(Species = sub("^(\\w)\\w*\\s(.*)", "\\1._\\2", species))

#remove (sub)strain info
Community_compositions_focus_drugs_Simvastatin_20uM_summarised <- Community_compositions_focus_drugs_Simvastatin_20uM_summarised %>%
  dplyr::mutate(Species = sub("^(\\w\\._\\w+).*", "\\1", Species))


#80 uM
Community_compositions_focus_drugs_Simvastatin_80uM_summarised <- Community_compositions_focus_drugs_Simvastatin_80uM %>%
  dplyr::group_by(species) %>%                                  
  dplyr::summarize(
    mean_rel_ab = mean(rel_abundance, na.rm = TRUE),     
    sd_rel_ab = sd(rel_abundance, na.rm = TRUE) ,
    mean_max_OD = mean(maxOD, na.rm = TRUE),
    sd_max_OD = sd(maxOD, na.rm = TRUE),    
    mean_final_OD = mean(finalOD, na.rm = TRUE),
    sd_final_OD = sd(finalOD, na.rm = TRUE)
  ) %>%
  dplyr::ungroup() 



Community_compositions_focus_drugs_Simvastatin_80uM_summarised <- Community_compositions_focus_drugs_Simvastatin_80uM_summarised %>%
  dplyr::mutate(Species = sub("^(\\w)\\w*\\s(.*)", "\\1._\\2", species))

#remove (sub)strain info
Community_compositions_focus_drugs_Simvastatin_80uM_summarised <- Community_compositions_focus_drugs_Simvastatin_80uM_summarised %>%
  dplyr::mutate(Species = sub("^(\\w\\._\\w+).*", "\\1", Species))


#Initialise data frames
sim_output <- data.frame()
input_params_list <- list() #Use a list to collect parameters for each simulation

#number of simulations
num_sims <- 250


for (i in 1:num_sims) {
  tryCatch({
    # generate model parameters
    set.seed(i) #set a different seed for each simulation for variation
    params <- lapply(1:nrow(growth_data_all_0_Niclosamide), function(idx) {
      species_params <- growth_data_all_0_Niclosamide[idx, ]
      list(
        r = rnorm(1, mean = species_params$mean_max_Growth_rate, sd = species_params$sd_max_Growth_rate),
        K = rnorm(1, mean = species_params$mean_max_OD, sd = species_params$sd_max_OD)
      )
    })
    names(params) <- gsub(" ", "_", growth_data_all_0_Niclosamide$Species)
    flat_params <- unlist(params)
    names(flat_params) <- gsub("\\.\\d$", "", names(flat_params))
    
    #replace spaces with underscores to match formatting
    co_culture_correction$species <- gsub(" ", "_", co_culture_correction$species, fixed = TRUE)
    
    #replace the species-specific K parameters extracted from monoculture growth data 
    #with drawn relative abundance values at Niclosamide = 0, scaled to K
    rel_ab_control$Species <- gsub(" ", "_", rel_ab_control$Species)
    
    #Initialise an empty vector to store drawn values
    drawn_values <- numeric(nrow(rel_ab_control))
    
    #draw values from their respective distributions
    for (k in 1:nrow(rel_ab_control)) {
      species_name <- rel_ab_control$Species[k]
      drawn_value <- rnorm(1, mean = rel_ab_control$mean_rel_ab[k], sd = rel_ab_control$sd_rel_ab[k])
      drawn_values[k] <- max(drawn_value, 0)  # Ensure no negative values
    }
    
    #Normalise drawn relative abundance values so they sum to 1 (to reflect a 'true' relative abundance distribution)
    #this is needed so when we convert the values into OD units by multiplying with the drawn community maxOD,
    # the sum of K_i parameters and the drawn K are equal
    normalised_values <- drawn_values / sum(drawn_values)
    
    #Pull community maxOD (K) at 0 drugs from respective normal distribution:
    K <- rnorm(n = 1, mean = rel_ab_control$mean_com_max_OD[1], sd = rel_ab_control$sd_com_max_OD[1])
    
    # Assign these normalised values to their respective species' .K parameters
    for (k in 1:nrow(rel_ab_control)) {
      species_name <- rel_ab_control$Species[k]
      k_index <- grep(paste0("^", species_name, "\\.K$"), names(flat_params))
      
      if (length(k_index) > 0) {
        old_value <- flat_params[k_index]
        flat_params[k_index] <- (normalised_values[k] + 0.0001) * K #add small value in case drawn K_i is 0, which would cause issues with the solver
        cat(sprintf("Updated %s from %f to %f using normalised value %f scaled by K %f\n", names(flat_params)[k_index], old_value, flat_params[k_index], normalised_values[k], K))
      }
    }
    
    #Accounting for variation in drug degradation by community, with standard deviation of end concentration (at 10h) around the fitted predicted (relative) end concentration at 24h
    #prop_left_Simvastatin <- abs(rnorm(1, (subset(drug_dynamics, Drug == "Simvastatin")$Prop_left_24h_community), (subset(drug_dynamics, Drug == "Simvastatin")$SD_drug_community))) 
    #below, we account for measurement error rather than ecological drivers that lead to the variability of degradation at the final point measured 
    prop_left_Simvastatin <- abs(rnorm(
      n = 1, 
      mean = subset(drug_dynamics, Drug == "Simvastatin")$Prop_left_24h_community, 
      sd = ifelse(
        subset(drug_dynamics, Drug == "Simvastatin")$SD_drug_community > subset(drug_dynamics, Drug == "Simvastatin")$SD_drug_community_start, 
        subset(drug_dynamics, Drug == "Simvastatin")$SD_drug_community - subset(drug_dynamics, Drug == "Simvastatin")$SD_drug_community_start, 
        subset(drug_dynamics, Drug == "Simvastatin")$SD_drug_community
      )
    ))
    
    
    #loop through each species in co_culture_correction
    for (j in 1:nrow(co_culture_correction)) {
      # Extract the species name and correction factor
      species_name <- co_culture_correction$species[j]
      correction_factor <- co_culture_correction$correction_factor[j]
      
      # Identify the corresponding growth rate parameter in flat_params
      #by matching the base species name (without .r)
      growth_rate_indices <- grep(paste0("^", species_name, "\\.r$"), names(flat_params))
      
      #take the growth rate parameter and apply the correction factor 
      for (index in growth_rate_indices) {
        flat_params[index] <- flat_params[index] * correction_factor
      }
    }
    
    flat_params
    # Store parameters for each simulation
    input_params_list[[i]] <- c(sim_ID = i, flat_params)
    
    # Run the model for the first 24-hour cycle
    solution_cycle_1 <- ode(y = initial_conditions, times = seq(from = 0, to = 24, by = 0.1), func = closed.sir.model_Simvastatin, parms = flat_params,   method = "lsoda", rtol = 1e-6, atol = 1e-6)
    
    # Dilution and second cycle
    end_of_cycle_1 <- solution_cycle_1[nrow(solution_cycle_1), -1]
    initial_conditions_cycle_2 <- end_of_cycle_1 / 50
    #accounting for the drugs being added with the new growth cycle as well:
    initial_conditions_cycle_2[33] <- initial_conditions_cycle_2[33] + drug_concentration_tested
    solution_cycle_2 <- ode(y = initial_conditions_cycle_2, times = seq(from = 24, to = 48, by = 0.1), func = closed.sir.model_Simvastatin, parms = flat_params,  method = "lsoda", rtol = 1e-6, atol = 1e-6)
    
    # Combine and format results
    combined_solution <- rbind(as.data.frame(solution_cycle_1), as.data.frame(solution_cycle_2)[-1,])
    combined_solution$sim_ID <- rep(i, nrow(combined_solution))
    combined_solution <- combined_solution %>%
      tidyr::gather(key = "Species", value = "Density", -time, -sim_ID) %>%
      dplyr::mutate(Hour = time) %>%
      dplyr::select(sim_ID, Hour, Species, Density)
    
    ##Append to sim_output
    sim_output <- rbind(sim_output, combined_solution)
  }, error = function(e) {
    cat(sprintf("Skipping simulation %d due to an error: %s\n", i, e$message))
  })
}



##Combine all parameter data into a single dataframe
input_params <- do.call(rbind, input_params_list)

# Add a "Species" column 
sim_output$Species_name <- species_names[as.numeric(as.character(sim_output$Species))]
sim_output$Species_name <- replace_na(sim_output$Species_name, "Drug")

#View(input_params)
#View(sim_output)

sim_output <- na.omit(sim_output)
successful_sim_ids <- unique(subset(sim_output, Hour == 48)$sim_ID)
length(successful_sim_ids)
sim_output1 <- sim_output[sim_output$sim_ID %in% successful_sim_ids, ]


#Transform sim_output so we have wide format by Species
sim_output_wide <- tidyr::pivot_wider(sim_output1, 
                                      names_from = Species_name, 
                                      values_from = Density,
                                      id_cols = c(sim_ID, Hour))

length(unique(sim_output_wide$sim_ID))
#calc community OD per timepoint
sim_output_wide$Total_OD <- rowSums(sim_output_wide[, 3:34], na.rm = TRUE)
#calculate and add relative abundances here as well:
species_columns <- colnames(sim_output_wide)[3:34] 

for (species in species_columns) {
  sim_output_wide[[paste0("rel_", species)]] <- sim_output_wide[[species]] / sim_output_wide$Total_OD
}


#assign sim_output_wide test conditions to dataframe name
drug_tested <- "Simvastatin"
variable_name_1 <- paste0("sim_output_wide_", ifelse(drug_concentration_tested == 1e-04, 0, drug_concentration_tested), "_", drug_tested)
assign(variable_name_1, sim_output_wide)

#turn back into long format if interested in plotting relative abundances
cols_needed <- c("sim_ID", "Hour")

sim_output_long <- sim_output_wide %>% 
  dplyr::select(sim_ID, Hour, Drug, starts_with("rel_")) %>% 
  tidyr::pivot_longer(
    cols = c(Drug, starts_with("rel_")),
    names_to = "Species", 
    values_to = "Relative_abundance",
    names_prefix = "rel_",
    names_transform = list(Species = ~ ifelse(.x == "Drug", "Drug", .x))
  ) 

str(sim_output_long)


species_names_1 <- c(
  "A_muciniphila",
  "B_adolescentis",
  "B_fragilis",
  "B_longum",
  "B_obeum",
  "B_thetaiotaomicron",
  "B_uniformis",
  "B_vulgatus",
  "B_wadsworthia",
  "C_aerofaciens",
  "C_bolteae",
  "C_comes",
  "C_perfringens",
  "C_ramosum",
  "C_saccharolyticum",
  "D_formicigenerans",
  "E_coli",
  "E_lenta",
  "E_rectale",
  "F_nucleatum",
  "L_paracasei",
  "O_splanchnicus",
  "P_copri",
  "P_distasonis",
  "P_merdae",
  "R_bromii",
  "R_gnavus",
  "R_intestinalis",
  "R_torques",
  "S_parasanguinis",
  "S_salivarius",
  "V_parvula",
  "Drug"
)

species_colours_1 <- c(
  "A_muciniphila" = "#1f77b4",
  "B_adolescentis" = "#ff7f0e",
  "B_fragilis" = "#2ca02c",
  "B_longum" = "#d62728",
  "B_obeum" = "#9467bd",
  "B_thetaiotaomicron" = "black",
  "B_uniformis" = "#e377c2",
  "B_vulgatus" = "#7f7f7f",
  "B_wadsworthia" = "gold1",
  "C_aerofaciens" = "#aec7e8",
  "C_bolteae" = "#ffbb78",
  "C_comes" = "magenta",
  "C_perfringens" = "#ff9896",
  "C_ramosum" = "#c5b0d5",
  "C_saccharolyticum" = "#c49c94",
  "D_formicigenerans" = "#f7b6d2",
  "E_coli" = "yellow",
  "E_lenta" = "turquoise",
  "E_rectale" = "#393b79",
  "F_nucleatum" = "royalblue2",
  "L_paracasei" = "blue",
  "O_splanchnicus" = "#637939",
  "P_copri" = "cyan",
  "P_distasonis" = "#8c6d31",
  "P_merdae" = "#c7c7c7",
  "R_bromii" = "#e6550d",
  "R_gnavus" = "#e7cb94",
  "R_intestinalis" = "#843c39",
  "R_torques" = "#d6616b",
  "S_parasanguinis" = "orange3",
  "S_salivarius" = "#7b4173",
  "V_parvula" = "#ce6dbd",
  "Drug" = "green"
)



##Plot output for any specific sim:
# ggplot(subset(sim_output, sim_ID == 1 & Species_name != "Drug"), aes(x = Hour, y = Density, group = Species_name, color = Species_name)) +
#   geom_line(size = 1, alpha = 0.7) +
#   scale_color_manual(values = species_colours_1) +
#   labs(title = paste0("Simvastatin = ", drug_concentration_tested),
#        x = "Time (hours)",
#        y = "Population Density (OD)",
#        color = "Species") +
#   theme_minimal() +
#   theme(legend.position = "right")
# 
# ggplot(subset(sim_output, sim_ID == 3 & Species_name != "Drug"), aes(x = Hour, y = Density, group = Species_name, color = Species_name)) +
#   geom_line(size = 1, alpha = 0.7) +
#   scale_color_manual(values = species_colours_1) +
#   labs(title = paste0("Simvastatin = ", drug_concentration_tested),
#        x = "Time (hours)",
#        y = "Population Density (OD)",
#        color = "Species") +
#   theme_minimal() +
#   theme(legend.position = "right")


ggplot(subset(sim_output_long, sim_ID == 1), aes(x = Hour, y = Relative_abundance, group = Species, color = Species)) +
  geom_line(size = 1, alpha = 0.7) +
  scale_color_manual(values = species_colours_1) +
  labs(title = paste0("Simvastatin = ", drug_concentration_tested),
       x = "Time (hours)",
       y = "Relative abundance",
       color = "Species") +
  theme_minimal() +
  theme(legend.position = "right")


ggplot(subset(sim_output_long, sim_ID == 3), aes(x = Hour, y = Relative_abundance, group = Species, color = Species)) +
  geom_line(size = 1, alpha = 0.7) +
  scale_color_manual(values = species_colours_1) +
  labs(title = paste0("Simvastatin = ", drug_concentration_tested),
       x = "Time (hours)",
       y = "Relative abundance",
       color = "Species") +
  theme_minimal() +
  theme(legend.position = "right")


#calc mean and standard deviation across sims
sim_stats <- sim_output_long %>%
  dplyr::group_by(Hour, Species) %>%
  dplyr::summarise(
    mean_rel_ab = mean(Relative_abundance),
    sd_rel_ab = sd(Relative_abundance),
    .groups = 'drop'
  )

# Prepare the data for plotting
plot_data <- sim_stats %>%
  dplyr::mutate(Upper = mean_rel_ab + sd_rel_ab, Lower = mean_rel_ab - sd_rel_ab)

ggplot(subset(plot_data, Species != "Drug"), aes(x = Hour, y = mean_rel_ab, group = Species, color = Species)) +
  geom_ribbon(aes(ymin = Lower, ymax = Upper, fill = Species), colour = NA, alpha = 0.2) +  
  geom_line(size = 1, alpha = 0.7) + 
  scale_color_manual(values = species_colours_1) +
  scale_fill_manual(values = species_colours_1) +  
  labs(title = "Mean and SD of Relative Abundance Across Simulations",
       subtitle = paste0("Simvastatin = ", drug_concentration_tested),       
       x = "Time (hours)",
       y = "Relative abundance",
       color = "Species",
       fill = "Species") +
  theme_minimal() +
  theme(legend.position = "right")

#log-scaled mean trends
ggplot(plot_data, aes(x = Hour, y = log10(mean_rel_ab + 0.0001), group = Species, color = Species)) +
  geom_line(size = 1, alpha = 0.7) +  # Mean line
  scale_color_manual(values = species_colours_1) +
  scale_fill_manual(values = species_colours_1) +  # Ensure consistent colors for lines and fills
  labs(title = "Mean and SD of Relative Abundance Across Simulations",
       subtitle = paste0("Simvastatin = ", drug_concentration_tested),
       x = "Time (hours)",
       y = "Relative abundance",
       color = "Species",
       fill = "Species") +
  theme_minimal() +
  theme(legend.position = "right")




##prediction quality evaluation
drug_tested <- "Simvastatin"
variable_name <- paste0("plot_data_", ifelse(drug_concentration_tested == 1e-04, 0, drug_concentration_tested), "_", drug_tested)
assign(variable_name, plot_data)


#extract total OD info:
predicted_mean_final_od_NULL <- Niclosamide_16S_0uM_summarised$mean_com_final_OD[1]
predicted_sd_final_od_NULL <- Niclosamide_16S_0uM_summarised$sd_com_final_OD[1]

predicted_mean_final_od_5_Simvastatin <- mean(subset(sim_output_wide_5_Simvastatin, Hour == 48)$Total_OD, na.rm = TRUE)
predicted_sd_final_od_5_Simvastatin <- sd(subset(sim_output_wide_5_Simvastatin, Hour == 48)$Total_OD, na.rm = TRUE)

real_mean_final_od_5_Simvastatin <- Community_compositions_focus_drugs_Simvastatin_5uM_summarised$mean_final_OD[1]
real_sd_final_od_5_Simvastatin <- Community_compositions_focus_drugs_Simvastatin_5uM_summarised$sd_final_OD[1]


predicted_mean_final_od_20_Simvastatin <- mean(subset(sim_output_wide_20_Simvastatin, Hour == 48)$Total_OD, na.rm = TRUE)
predicted_sd_final_od_20_Simvastatin <- sd(subset(sim_output_wide_20_Simvastatin, Hour == 48)$Total_OD, na.rm = TRUE)

real_mean_final_od_20_Simvastatin <- Community_compositions_focus_drugs_Simvastatin_20uM_summarised$mean_final_OD[1]
real_sd_final_od_20_Simvastatin <- Community_compositions_focus_drugs_Simvastatin_20uM_summarised$sd_final_OD[1]


predicted_mean_final_od_80_Simvastatin <- mean(subset(sim_output_wide_80_Simvastatin, Hour == 48)$Total_OD, na.rm = TRUE)
predicted_sd_final_od_80_Simvastatin <- sd(subset(sim_output_wide_80_Simvastatin, Hour == 48)$Total_OD, na.rm = TRUE)

real_mean_final_od_80_Simvastatin <- Community_compositions_focus_drugs_Simvastatin_80uM_summarised$mean_final_OD[1]
real_sd_final_od_80_Simvastatin <- Community_compositions_focus_drugs_Simvastatin_80uM_summarised$sd_final_OD[1]




#plot_data_0_Simvastatin_endpoint was used to test model performance at 0 drugs
#plot_data_0_Simvastatin_endpoint <- subset(plot_data_0_Simvastatin, Hour == 48 & Species != "Drug")
plot_data_5_Simvastatin_endpoint <- subset(plot_data_5_Simvastatin, Hour == 48 & Species != "Drug")
plot_data_20_Simvastatin_endpoint <- subset(plot_data_20_Simvastatin, Hour == 48 & Species != "Drug")
plot_data_80_Simvastatin_endpoint <- subset(plot_data_80_Simvastatin, Hour == 48 & Species != "Drug")

##Inspecting 'match' to real relative abundance distributions:
Niclosamide_16S_0uM_summarised <- rel_ab_control
Niclosamide_16S_0uM_summarised$Species <- gsub("\\.", "", Niclosamide_16S_0uM_summarised$Species)

Simvastatin_16S_5uM_summarised <- Community_compositions_focus_drugs_Simvastatin_5uM_summarised
Simvastatin_16S_20uM_summarised <- Community_compositions_focus_drugs_Simvastatin_20uM_summarised
Simvastatin_16S_80uM_summarised <- Community_compositions_focus_drugs_Simvastatin_80uM_summarised

Niclosamide_16S_0uM_summarised
Simvastatin_16S_5uM_summarised 
Simvastatin_16S_20uM_summarised 
Simvastatin_16S_80uM_summarised 

#Rename 'species' so the outputs become comparable
original_names_80 <- unique(Simvastatin_16S_80uM_summarised$species)
original_names_20 <- unique(Simvastatin_16S_20uM_summarised$species)
original_names_5 <- unique(Simvastatin_16S_5uM_summarised$species)


##Create a named vector with the original and new names mapping
name_changes <- c(
  "Akkermansia muciniphila" = "A_muciniphila",
  "Bacteroides fragilis" = "B_fragilis",
  "Bacteroides thetaiotaomicron" = "B_thetaiotaomicron",
  "Bacteroides uniformis" = "B_uniformis",
  "Bifidobacterium adolescentis" = "B_adolescentis",
  "Bifidobacterium longum subsp. longum" = "B_longum",
  "Bilophila wadsworthia" = "B_wadsworthia",
  "Blautia obeum" = "B_obeum",
  "Clostridium perfringens" = "C_perfringens",
  "Collinsella aerofaciens" = "C_aerofaciens",
  "Coprococcus comes" = "C_comes",
  "Dorea formicigenerans" = "D_formicigenerans",
  "Eggerthella lenta" = "E_lenta",
  "Enterocloster bolteae" = "C_bolteae",
  "Erysipelatoclostridium ramosum" = "C_ramosum",
  "Escherichia coli ED1a" = "E_coli",
  "Eubacterium rectale" = "E_rectale",
  "Fusobacterium nucleatum subsp. nucleatum" = "F_nucleatum",
  "Lacrimispora saccharolytica" = "C_saccharolyticum",
  "Lacticaseibacillus paracasei" = "L_paracasei",
  "Odoribacter splanchnicus" = "O_splanchnicus",
  "Parabacteroides distasonis" = "P_distasonis",
  "Parabacteroides merdae" = "P_merdae",
  "Phocaeicola vulgatus" = "B_vulgatus",
  "Prevotella copri" = "P_copri",
  "Roseburia intestinalis" = "R_intestinalis",
  "Ruminococcus bromii" = "R_bromii",
  "Ruminococcus gnavus" = "R_gnavus",
  "Ruminococcus torques" = "R_torques",
  "Streptococcus parasanguinis" = "S_parasanguinis",
  "Streptococcus salivarius" = "S_salivarius",
  "Veillonella parvula" = "V_parvula"
)

# Apply name changes to the species column in Simvastatin_16S_80uM_summarised

Simvastatin_16S_80uM_summarised$Species <- name_changes[Simvastatin_16S_80uM_summarised$species]
Simvastatin_16S_20uM_summarised$Species <- name_changes[Simvastatin_16S_20uM_summarised$species]
Simvastatin_16S_5uM_summarised$Species <- name_changes[Simvastatin_16S_5uM_summarised$species]

# Verify the changes
unique(Simvastatin_16S_80uM_summarised$Species)
unique(Simvastatin_16S_20uM_summarised$Species)
unique(Simvastatin_16S_5uM_summarised$Species)



##First, for 5 uM:
# Get top 6 species from plot_data_5_endpoint
# Adjust the plot_data_5_endpoint with confidence bounds

# #plot_data_0_Simvastatin_endpoint was used to test model performance at 0 drugs
# plot_data_0_Simvastatin_endpoint <- plot_data_0_Simvastatin_endpoint %>%
#   dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)

plot_data_5_Simvastatin_endpoint <- plot_data_5_Simvastatin_endpoint %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)

# Adjust the Simvastatin_16S_5uM_summarised with confidence bounds
Simvastatin_16S_5uM_summarised <- Simvastatin_16S_5uM_summarised %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)

#NULL model:
Null_model_summarised <- Niclosamide_16S_0uM_summarised %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)


# Get top 6 species based on the lower bound from plot_data_5_endpoint

#top6_predicted_0_Simvastatin was used to test model performance at 0 drugs
# top6_predicted_0_Simvastatin <- plot_data_0_Simvastatin_endpoint %>%
#    arrange(desc(lower_bound)) %>%
#    slice(1:6) %>%
#    pull(Species)

top6_predicted_5_Simvastatin <- plot_data_5_Simvastatin_endpoint %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

# Get top 6 species based on the lower bound from Simvastatin_16S_5uM_summarised
top6_real_5_Simvastatin <- Simvastatin_16S_5uM_summarised %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

top6_NULL <- Null_model_summarised %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

# Calculate the overlap of top 6 species

#top_six_correct_0_Simvastatin was used to assess model performance at 0 drugs
# top_six_correct_0_Simvastatin <- length(intersect(top6_predicted_0_Simvastatin, top6_NULL))
# top_six_correct_0_Simvastatin

top_six_correct_5_Simvastatin <- length(intersect(top6_predicted_5_Simvastatin, top6_real_5_Simvastatin))
top_six_correct_5_Simvastatin

top_six_correct_5_Simvastatin_NULL <- length(intersect(top6_NULL, top6_real_5_Simvastatin))
top_six_correct_5_Simvastatin_NULL

top6_predicted_5_Simvastatin
top6_real_5_Simvastatin

#top6_NULL

#Now by means:
# #top6_predicted_0_Simvastatin_means was used to assess model performance at 0 drugs
# top6_predicted_0_Simvastatin_means <- plot_data_0_Simvastatin_endpoint %>%
#    arrange(desc(mean_rel_ab)) %>%
#    slice(1:6) %>%
#    pull(Species)

top6_predicted_5_Simvastatin_means <- plot_data_5_Simvastatin_endpoint %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)

# Get top 6 species based on the lower bound from Simvastatin_16S_5uM_summarised
top6_real_5_Simvastatin_means <- Simvastatin_16S_5uM_summarised %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)

top6_NULL_means <- Null_model_summarised %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)


# #top_six_correct_0_Simvastatin_means was used to assess model performance at 0 drugs
# top_six_correct_0_Simvastatin_means <- length(intersect(top6_predicted_0_Simvastatin_means, top6_NULL_means))
# top_six_correct_0_Simvastatin_means

top_six_correct_5_Simvastatin_means <- length(intersect(top6_predicted_5_Simvastatin_means, top6_real_5_Simvastatin_means))
top_six_correct_5_Simvastatin_means

top_six_correct_5_Simvastatin_means_NULL <- length(intersect(top6_NULL_means, top6_real_5_Simvastatin_means))
top_six_correct_5_Simvastatin_means_NULL

top6_predicted_5_Simvastatin_means
top6_real_5_Simvastatin_means

#top6_NULL_means


# Merge dataframes by Species

#merged_data_0_Simvastatin was used to assess model performance at 0 drugs
#merged_data_0_Simvastatin <- merge(plot_data_0_Simvastatin_endpoint, Niclosamide_16S_0uM_summarised, by = "Species", suffixes = c(".pred", ".real"))
merged_data_5_Simvastatin <- merge(plot_data_5_Simvastatin_endpoint, Simvastatin_16S_5uM_summarised, by = "Species", suffixes = c(".pred", ".real"))
merged_data_5_Simvastatin_NULL <- merge(Niclosamide_16S_0uM_summarised, Simvastatin_16S_5uM_summarised, by = "Species", suffixes = c(".null", ".real"))


## Below lines used for assessing model performance at 0 drugs; ignore for nonzero concentrations
# # Create lower and upper bounds considering mean ¬± sd
# merged_data_0_Simvastatin$lower_bound_pred <- merged_data_0_Simvastatin$mean_rel_ab.pred - merged_data_0_Simvastatin$sd_rel_ab.pred
# merged_data_0_Simvastatin$upper_bound_pred <- merged_data_0_Simvastatin$mean_rel_ab.pred + merged_data_0_Simvastatin$sd_rel_ab.pred
# merged_data_0_Simvastatin$lower_bound_real <- merged_data_0_Simvastatin$mean_rel_ab.real - merged_data_0_Simvastatin$sd_rel_ab.real
# merged_data_0_Simvastatin$upper_bound_real <- merged_data_0_Simvastatin$mean_rel_ab.real + merged_data_0_Simvastatin$sd_rel_ab.real
# 
# # Ensure lower and upper bounds are non-negative, adjusting as necessary
# merged_data_0_Simvastatin$lower_bound_pred[merged_data_0_Simvastatin$lower_bound_pred <= 0] <- 1e-10
# merged_data_0_Simvastatin$lower_bound_real[merged_data_0_Simvastatin$lower_bound_real <= 0] <- 1e-10
# merged_data_0_Simvastatin$upper_bound_pred[merged_data_0_Simvastatin$upper_bound_pred <= 0] <- 1e-10
# merged_data_0_Simvastatin$upper_bound_real[merged_data_0_Simvastatin$upper_bound_real <= 0] <- 1e-10


# Create lower and upper bounds considering mean ¬± sd
merged_data_5_Simvastatin$lower_bound_pred <- merged_data_5_Simvastatin$mean_rel_ab.pred - merged_data_5_Simvastatin$sd_rel_ab.pred
merged_data_5_Simvastatin$upper_bound_pred <- merged_data_5_Simvastatin$mean_rel_ab.pred + merged_data_5_Simvastatin$sd_rel_ab.pred
merged_data_5_Simvastatin$lower_bound_real <- merged_data_5_Simvastatin$mean_rel_ab.real - merged_data_5_Simvastatin$sd_rel_ab.real
merged_data_5_Simvastatin$upper_bound_real <- merged_data_5_Simvastatin$mean_rel_ab.real + merged_data_5_Simvastatin$sd_rel_ab.real

# Ensure lower and upper bounds are non-negative, adjusting as necessary
merged_data_5_Simvastatin$lower_bound_pred[merged_data_5_Simvastatin$lower_bound_pred <= 0] <- 1e-10
merged_data_5_Simvastatin$lower_bound_real[merged_data_5_Simvastatin$lower_bound_real <= 0] <- 1e-10
merged_data_5_Simvastatin$upper_bound_pred[merged_data_5_Simvastatin$upper_bound_pred <= 0] <- 1e-10
merged_data_5_Simvastatin$upper_bound_real[merged_data_5_Simvastatin$upper_bound_real <= 0] <- 1e-10

##and for NULL model:
# Create lower and upper bounds considering mean ¬± sd
merged_data_5_Simvastatin_NULL$lower_bound_null <- merged_data_5_Simvastatin_NULL$mean_rel_ab.null - merged_data_5_Simvastatin_NULL$sd_rel_ab.null
merged_data_5_Simvastatin_NULL$upper_bound_null <- merged_data_5_Simvastatin_NULL$mean_rel_ab.null + merged_data_5_Simvastatin_NULL$sd_rel_ab.null
merged_data_5_Simvastatin_NULL$lower_bound_real <- merged_data_5_Simvastatin_NULL$mean_rel_ab.real - merged_data_5_Simvastatin_NULL$sd_rel_ab.real
merged_data_5_Simvastatin_NULL$upper_bound_real <- merged_data_5_Simvastatin_NULL$mean_rel_ab.real + merged_data_5_Simvastatin_NULL$sd_rel_ab.real

# Ensure lower and upper bounds are non-negative, adjusting as necessary
merged_data_5_Simvastatin_NULL$lower_bound_null[merged_data_5_Simvastatin_NULL$lower_bound_null <= 0] <- 1e-10
merged_data_5_Simvastatin_NULL$lower_bound_real[merged_data_5_Simvastatin_NULL$lower_bound_real <= 0] <- 1e-10
merged_data_5_Simvastatin_NULL$upper_bound_null[merged_data_5_Simvastatin_NULL$upper_bound_null <= 0] <- 1e-10
merged_data_5_Simvastatin_NULL$upper_bound_real[merged_data_5_Simvastatin_NULL$upper_bound_real <= 0] <- 1e-10

# Filter to include only species with a mean relative abundance > 0.01 in the 'real' dataset

## significant_species_0 was used to assess model performance at 0 drugs
#significant_species_0 <- merged_data_0_Simvastatin[merged_data_0_Simvastatin$mean_rel_ab.real > 0.01, ]
significant_species <- merged_data_5_Simvastatin[merged_data_5_Simvastatin$mean_rel_ab.real > 0.01, ]
survivors_5_Simvastatin <- nrow(significant_species)
survivors_5_Simvastatin

#should be the same as survivors defined above, since it is calculated from .real
significant_species_NULL <- merged_data_5_Simvastatin_NULL[merged_data_5_Simvastatin_NULL$mean_rel_ab.real > 0.01, ]
survivors_5_Simvastatin_NULL <- nrow(significant_species_NULL)
survivors_5_Simvastatin_NULL

# Adjusted order of magnitude check to include SD, only for significant species
## below code was used to assess model performance at 0 drugs
# significant_species_0$Predicted_magnitude_correct <- ifelse(
#   (floor(log10(significant_species_0$lower_bound_pred)) <= floor(log10(significant_species_0$upper_bound_real)) &
#      floor(log10(significant_species_0$upper_bound_pred)) >= floor(log10(significant_species_0$lower_bound_real))),
#   1,
#   0
# )

significant_species$Predicted_magnitude_correct <- ifelse(
  (floor(log10(significant_species$lower_bound_pred)) <= floor(log10(significant_species$upper_bound_real)) &
     floor(log10(significant_species$upper_bound_pred)) >= floor(log10(significant_species$lower_bound_real))),
  1,
  0
)

#and for the Null model:
significant_species_NULL$Predicted_magnitude_correct <- ifelse(
  (floor(log10(significant_species_NULL$lower_bound_null)) <= floor(log10(significant_species_NULL$upper_bound_real)) &
     floor(log10(significant_species_NULL$upper_bound_null)) >= floor(log10(significant_species_NULL$lower_bound_real))),
  1,
  0
)

# Calculate the fraction of correctly predicted magnitudes for significant species
## below code was used to assess model performance at 0 drugs
#predicted_magnitude_correct_fraction_0_Simvastatin <- sum(significant_species_0$Predicted_magnitude_correct) / nrow(significant_species_0)
#predicted_magnitude_correct_fraction_0_Simvastatin

predicted_magnitude_correct_fraction_5_Simvastatin <- sum(significant_species$Predicted_magnitude_correct) / nrow(significant_species)
predicted_magnitude_correct_fraction_5_Simvastatin

predicted_magnitude_correct_fraction_5_Simvastatin_NULL <- sum(significant_species_NULL$Predicted_magnitude_correct) / nrow(significant_species_NULL)
predicted_magnitude_correct_fraction_5_Simvastatin_NULL

top_species_missing_5_Simvastatin <- setdiff(top6_real_5_Simvastatin_means, top6_predicted_5_Simvastatin_means)
top_species_wrong_5_Simvastatin <- setdiff(top6_predicted_5_Simvastatin_means, top6_real_5_Simvastatin_means)

top_species_missing_5_Simvastatin <- if(length(top_species_missing_5_Simvastatin) == 0) "None" else top_species_missing_5_Simvastatin
top_species_wrong_5_Simvastatin <- if(length(top_species_wrong_5_Simvastatin) == 0) "None" else top_species_wrong_5_Simvastatin

Prediction_quality_5_Simvastatin <- data.frame(
  Top_six_correct = paste(top_six_correct_5_Simvastatin, sep=""),
  Top_six_correct_NULL = paste(top_six_correct_5_Simvastatin_NULL, sep=""),
  Top_six_correct_means = paste(top_six_correct_5_Simvastatin_means, sep=""),
  Top_six_correct_means_NULL = paste(top_six_correct_5_Simvastatin_means_NULL, sep=""),
  Predicted_magnitude_correct = paste(round(predicted_magnitude_correct_fraction_5_Simvastatin * 100, 2), "%", sep=""),
  Predicted_magnitude_correct_NULL = paste(round(predicted_magnitude_correct_fraction_5_Simvastatin_NULL * 100, 2), "%", sep=""),
  survivors_total = survivors_5_Simvastatin,
  top_species_missing <- top_species_missing_5_Simvastatin,
  top_species_wrong <- top_species_wrong_5_Simvastatin, 
  predicted_mean_final_OD <- predicted_mean_final_od_5_Simvastatin,
  real_mean_final_OD <- real_mean_final_od_5_Simvastatin,
  sims_total = length(successful_sim_ids)
)



Prediction_quality_5_Simvastatin



##Next, for 20 uM:
# Get top 6 species from plot_data_20_endpoint
# Adjust the plot_data_20_endpoint with confidence bounds
plot_data_20_Simvastatin_endpoint <- plot_data_20_Simvastatin_endpoint %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)

# Adjust the Simvastatin_16S_20uM_summarised with confidence bounds
Simvastatin_16S_20uM_summarised <- Simvastatin_16S_20uM_summarised %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)

#NULL model:
Null_model_summarised <- Niclosamide_16S_0uM_summarised %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)


# Get top 6 species based on the lower bound from plot_data_20_endpoint
top6_predicted_20_Simvastatin <- plot_data_20_Simvastatin_endpoint %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

# Get top 6 species based on the lower bound from Simvastatin_16S_20uM_summarised
top6_real_20_Simvastatin <- Simvastatin_16S_20uM_summarised %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

top6_NULL <- Null_model_summarised %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

# Calculate the overlap of top 6 species
top_six_correct_20_Simvastatin <- length(intersect(top6_predicted_20_Simvastatin, top6_real_20_Simvastatin))
#top_six_correct_20_Simvastatin

top_six_correct_20_Simvastatin_NULL <- length(intersect(top6_NULL, top6_real_20_Simvastatin))
#top_six_correct_20_Simvastatin_NULL

#top6_predicted_20_Simvastatin
#top6_real_20_Simvastatin



#Now by means:
top6_predicted_20_Simvastatin_means <- plot_data_20_Simvastatin_endpoint %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)

# Get top 6 species based on the lower bound from Simvastatin_16S_20uM_summarised
top6_real_20_Simvastatin_means <- Simvastatin_16S_20uM_summarised %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)

top6_NULL_means <- Null_model_summarised %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)



top_six_correct_20_Simvastatin_means <- length(intersect(top6_predicted_20_Simvastatin_means, top6_real_20_Simvastatin_means))
#top_six_correct_20_Simvastatin_means

top_six_correct_20_Simvastatin_means_NULL <- length(intersect(top6_NULL_means, top6_real_20_Simvastatin_means))
#top_six_correct_20_Simvastatin_means_NULL

top6_predicted_20_Simvastatin_means
#top6_real_20_Simvastatin_means




# Merge dataframes by Species
merged_data_20_Simvastatin <- merge(plot_data_20_Simvastatin_endpoint, Simvastatin_16S_20uM_summarised, by = "Species", suffixes = c(".pred", ".real"))
merged_data_20_Simvastatin_NULL <- merge(Niclosamide_16S_0uM_summarised, Simvastatin_16S_20uM_summarised, by = "Species", suffixes = c(".null", ".real"))



# Create lower and upper bounds considering mean ¬± sd
merged_data_20_Simvastatin$lower_bound_pred <- merged_data_20_Simvastatin$mean_rel_ab.pred - merged_data_20_Simvastatin$sd_rel_ab.pred
merged_data_20_Simvastatin$upper_bound_pred <- merged_data_20_Simvastatin$mean_rel_ab.pred + merged_data_20_Simvastatin$sd_rel_ab.pred
merged_data_20_Simvastatin$lower_bound_real <- merged_data_20_Simvastatin$mean_rel_ab.real - merged_data_20_Simvastatin$sd_rel_ab.real
merged_data_20_Simvastatin$upper_bound_real <- merged_data_20_Simvastatin$mean_rel_ab.real + merged_data_20_Simvastatin$sd_rel_ab.real

# Ensure lower and upper bounds are non-negative, adjusting as necessary
merged_data_20_Simvastatin$lower_bound_pred[merged_data_20_Simvastatin$lower_bound_pred <= 0] <- 1e-10
merged_data_20_Simvastatin$lower_bound_real[merged_data_20_Simvastatin$lower_bound_real <= 0] <- 1e-10
merged_data_20_Simvastatin$upper_bound_pred[merged_data_20_Simvastatin$upper_bound_pred <= 0] <- 1e-10
merged_data_20_Simvastatin$upper_bound_real[merged_data_20_Simvastatin$upper_bound_real <= 0] <- 1e-10

##and for NULL model:
# Create lower and upper bounds considering mean ¬± sd
merged_data_20_Simvastatin_NULL$lower_bound_null <- merged_data_20_Simvastatin_NULL$mean_rel_ab.null - merged_data_20_Simvastatin_NULL$sd_rel_ab.null
merged_data_20_Simvastatin_NULL$upper_bound_null <- merged_data_20_Simvastatin_NULL$mean_rel_ab.null + merged_data_20_Simvastatin_NULL$sd_rel_ab.null
merged_data_20_Simvastatin_NULL$lower_bound_real <- merged_data_20_Simvastatin_NULL$mean_rel_ab.real - merged_data_20_Simvastatin_NULL$sd_rel_ab.real
merged_data_20_Simvastatin_NULL$upper_bound_real <- merged_data_20_Simvastatin_NULL$mean_rel_ab.real + merged_data_20_Simvastatin_NULL$sd_rel_ab.real

# Ensure lower and upper bounds are non-negative, adjusting as necessary
merged_data_20_Simvastatin_NULL$lower_bound_null[merged_data_20_Simvastatin_NULL$lower_bound_null <= 0] <- 1e-10
merged_data_20_Simvastatin_NULL$lower_bound_real[merged_data_20_Simvastatin_NULL$lower_bound_real <= 0] <- 1e-10
merged_data_20_Simvastatin_NULL$upper_bound_null[merged_data_20_Simvastatin_NULL$upper_bound_null <= 0] <- 1e-10
merged_data_20_Simvastatin_NULL$upper_bound_real[merged_data_20_Simvastatin_NULL$upper_bound_real <= 0] <- 1e-10

# Filter to include only species with a mean relative abundance > 0.01 in the 'real' dataset
significant_species <- merged_data_20_Simvastatin[merged_data_20_Simvastatin$mean_rel_ab.real > 0.01, ]
survivors_20_Simvastatin <- nrow(significant_species)
survivors_20_Simvastatin

#should be the same as survivors defined above, since it is calculated from .real
significant_species_NULL <- merged_data_20_Simvastatin_NULL[merged_data_20_Simvastatin_NULL$mean_rel_ab.real > 0.01, ]
survivors_20_Simvastatin_NULL <- nrow(significant_species_NULL)
survivors_20_Simvastatin_NULL

# Adjusted order of magnitude check to include SD, only for significant species
significant_species$Predicted_magnitude_correct <- ifelse(
  (floor(log10(significant_species$lower_bound_pred)) <= floor(log10(significant_species$upper_bound_real)) &
     floor(log10(significant_species$upper_bound_pred)) >= floor(log10(significant_species$lower_bound_real))),
  1,
  0
)

#and for the Null model:
significant_species_NULL$Predicted_magnitude_correct <- ifelse(
  (floor(log10(significant_species_NULL$lower_bound_null)) <= floor(log10(significant_species_NULL$upper_bound_real)) &
     floor(log10(significant_species_NULL$upper_bound_null)) >= floor(log10(significant_species_NULL$lower_bound_real))),
  1,
  0
)

# Calculate the fraction of correctly predicted magnitudes for significant species
predicted_magnitude_correct_fraction_20_Simvastatin <- sum(significant_species$Predicted_magnitude_correct) / nrow(significant_species)
predicted_magnitude_correct_fraction_20_Simvastatin

predicted_magnitude_correct_fraction_20_Simvastatin_NULL <- sum(significant_species_NULL$Predicted_magnitude_correct) / nrow(significant_species_NULL)
predicted_magnitude_correct_fraction_20_Simvastatin_NULL

top_species_missing_20_Simvastatin <- setdiff(top6_real_20_Simvastatin_means, top6_predicted_20_Simvastatin_means)
top_species_wrong_20_Simvastatin <- setdiff(top6_predicted_20_Simvastatin_means, top6_real_20_Simvastatin_means)

top_species_missing_20_Simvastatin <- if(length(top_species_missing_20_Simvastatin) == 0) "None" else top_species_missing_20_Simvastatin
top_species_wrong_20_Simvastatin <- if(length(top_species_wrong_20_Simvastatin) == 0) "None" else top_species_wrong_20_Simvastatin

Prediction_quality_20_Simvastatin <- data.frame(
  Top_six_correct = paste(top_six_correct_20_Simvastatin, sep=""),
  Top_six_correct_NULL = paste(top_six_correct_20_Simvastatin_NULL, sep=""),
  Top_six_correct_means = paste(top_six_correct_20_Simvastatin_means, sep=""),
  Top_six_correct_means_NULL = paste(top_six_correct_20_Simvastatin_means_NULL, sep=""),
  Predicted_magnitude_correct = paste(round(predicted_magnitude_correct_fraction_20_Simvastatin * 100, 2), "%", sep=""),
  Predicted_magnitude_correct_NULL = paste(round(predicted_magnitude_correct_fraction_20_Simvastatin_NULL * 100, 2), "%", sep=""),
  survivors_total = survivors_20_Simvastatin,
  top_species_missing <- top_species_missing_20_Simvastatin,
  top_species_wrong <- top_species_wrong_20_Simvastatin, 
  predicted_mean_final_OD <- predicted_mean_final_od_20_Simvastatin,
  real_mean_final_OD <- real_mean_final_od_20_Simvastatin,
  sims_total = length(successful_sim_ids)
)

Prediction_quality_20_Simvastatin






##Next, for 80 uM:
# Get top 6 species from plot_data_80_endpoint
# Adjust the plot_data_80_endpoint with confidence bounds
plot_data_80_Simvastatin_endpoint <- plot_data_80_Simvastatin_endpoint %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)

# Adjust the Simvastatin_16S_80uM_summarised with confidence bounds
Simvastatin_16S_80uM_summarised <- Simvastatin_16S_80uM_summarised %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)

#NULL model:
Null_model_summarised <- Niclosamide_16S_0uM_summarised %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)


# Get top 6 species based on the lower bound from plot_data_80_endpoint
top6_predicted_80_Simvastatin <- plot_data_80_Simvastatin_endpoint %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

# Get top 6 species based on the lower bound from Simvastatin_16S_80uM_summarised
top6_real_80_Simvastatin <- Simvastatin_16S_80uM_summarised %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

top6_NULL <- Null_model_summarised %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

# Calculate the overlap of top 6 species
top_six_correct_80_Simvastatin <- length(intersect(top6_predicted_80_Simvastatin, top6_real_80_Simvastatin))
#top_six_correct_80_Simvastatin

top_six_correct_80_Simvastatin_NULL <- length(intersect(top6_NULL, top6_real_80_Simvastatin))
#top_six_correct_80_Simvastatin_NULL

#top6_predicted_80_Simvastatin
#top6_real_80_Simvastatin




#Now by means:
top6_predicted_80_Simvastatin_means <- plot_data_80_Simvastatin_endpoint %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)

# Get top 6 species based on the lower bound from Simvastatin_16S_80uM_summarised
top6_real_80_Simvastatin_means <- Simvastatin_16S_80uM_summarised %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)

top6_NULL_means <- Null_model_summarised %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)



top_six_correct_80_Simvastatin_means <- length(intersect(top6_predicted_80_Simvastatin_means, top6_real_80_Simvastatin_means))
#top_six_correct_80_Simvastatin_means

top_six_correct_80_Simvastatin_means_NULL <- length(intersect(top6_NULL_means, top6_real_80_Simvastatin_means))
#top_six_correct_80_Simvastatin_means_NULL

#top6_predicted_80_Simvastatin_means
#top6_real_80_Simvastatin_means




# Merge dataframes by Species
merged_data_80_Simvastatin <- merge(plot_data_80_Simvastatin_endpoint, Simvastatin_16S_80uM_summarised, by = "Species", suffixes = c(".pred", ".real"))
merged_data_80_Simvastatin_NULL <- merge(Niclosamide_16S_0uM_summarised, Simvastatin_16S_80uM_summarised, by = "Species", suffixes = c(".null", ".real"))



# Create lower and upper bounds considering mean ¬± sd
merged_data_80_Simvastatin$lower_bound_pred <- merged_data_80_Simvastatin$mean_rel_ab.pred - merged_data_80_Simvastatin$sd_rel_ab.pred
merged_data_80_Simvastatin$upper_bound_pred <- merged_data_80_Simvastatin$mean_rel_ab.pred + merged_data_80_Simvastatin$sd_rel_ab.pred
merged_data_80_Simvastatin$lower_bound_real <- merged_data_80_Simvastatin$mean_rel_ab.real - merged_data_80_Simvastatin$sd_rel_ab.real
merged_data_80_Simvastatin$upper_bound_real <- merged_data_80_Simvastatin$mean_rel_ab.real + merged_data_80_Simvastatin$sd_rel_ab.real

# Ensure lower and upper bounds are non-negative, adjusting as necessary
merged_data_80_Simvastatin$lower_bound_pred[merged_data_80_Simvastatin$lower_bound_pred <= 0] <- 1e-10
merged_data_80_Simvastatin$lower_bound_real[merged_data_80_Simvastatin$lower_bound_real <= 0] <- 1e-10
merged_data_80_Simvastatin$upper_bound_pred[merged_data_80_Simvastatin$upper_bound_pred <= 0] <- 1e-10
merged_data_80_Simvastatin$upper_bound_real[merged_data_80_Simvastatin$upper_bound_real <= 0] <- 1e-10

##and for NULL model:
# Create lower and upper bounds considering mean ¬± sd
merged_data_80_Simvastatin_NULL$lower_bound_null <- merged_data_80_Simvastatin_NULL$mean_rel_ab.null - merged_data_80_Simvastatin_NULL$sd_rel_ab.null
merged_data_80_Simvastatin_NULL$upper_bound_null <- merged_data_80_Simvastatin_NULL$mean_rel_ab.null + merged_data_80_Simvastatin_NULL$sd_rel_ab.null
merged_data_80_Simvastatin_NULL$lower_bound_real <- merged_data_80_Simvastatin_NULL$mean_rel_ab.real - merged_data_80_Simvastatin_NULL$sd_rel_ab.real
merged_data_80_Simvastatin_NULL$upper_bound_real <- merged_data_80_Simvastatin_NULL$mean_rel_ab.real + merged_data_80_Simvastatin_NULL$sd_rel_ab.real

# Ensure lower and upper bounds are non-negative, adjusting as necessary
merged_data_80_Simvastatin_NULL$lower_bound_null[merged_data_80_Simvastatin_NULL$lower_bound_null <= 0] <- 1e-10
merged_data_80_Simvastatin_NULL$lower_bound_real[merged_data_80_Simvastatin_NULL$lower_bound_real <= 0] <- 1e-10
merged_data_80_Simvastatin_NULL$upper_bound_null[merged_data_80_Simvastatin_NULL$upper_bound_null <= 0] <- 1e-10
merged_data_80_Simvastatin_NULL$upper_bound_real[merged_data_80_Simvastatin_NULL$upper_bound_real <= 0] <- 1e-10

# Filter to include only species with a mean relative abundance > 0.01 in the 'real' dataset
significant_species <- merged_data_80_Simvastatin[merged_data_80_Simvastatin$mean_rel_ab.real > 0.01, ]
survivors_80_Simvastatin <- nrow(significant_species)
survivors_80_Simvastatin

#should be the same as survivors defined above, since it is calculated from .real
significant_species_NULL <- merged_data_80_Simvastatin_NULL[merged_data_80_Simvastatin_NULL$mean_rel_ab.real > 0.01, ]
survivors_80_Simvastatin_NULL <- nrow(significant_species_NULL)
survivors_80_Simvastatin_NULL

# Adjusted order of magnitude check to include SD, only for significant species
significant_species$Predicted_magnitude_correct <- ifelse(
  (floor(log10(significant_species$lower_bound_pred)) <= floor(log10(significant_species$upper_bound_real)) &
     floor(log10(significant_species$upper_bound_pred)) >= floor(log10(significant_species$lower_bound_real))),
  1,
  0
)

#and for the Null model:
significant_species_NULL$Predicted_magnitude_correct <- ifelse(
  (floor(log10(significant_species_NULL$lower_bound_null)) <= floor(log10(significant_species_NULL$upper_bound_real)) &
     floor(log10(significant_species_NULL$upper_bound_null)) >= floor(log10(significant_species_NULL$lower_bound_real))),
  1,
  0
)

# Calculate the fraction of correctly predicted magnitudes for significant species
predicted_magnitude_correct_fraction_80_Simvastatin <- sum(significant_species$Predicted_magnitude_correct) / nrow(significant_species)
predicted_magnitude_correct_fraction_80_Simvastatin

predicted_magnitude_correct_fraction_80_Simvastatin_NULL <- sum(significant_species_NULL$Predicted_magnitude_correct) / nrow(significant_species_NULL)
predicted_magnitude_correct_fraction_80_Simvastatin_NULL


top_species_missing_80_Simvastatin <- setdiff(top6_real_80_Simvastatin_means, top6_predicted_80_Simvastatin_means)
top_species_wrong_80_Simvastatin <- setdiff(top6_predicted_80_Simvastatin_means, top6_real_80_Simvastatin_means)

top_species_missing_80_Simvastatin <- if(length(top_species_missing_80_Simvastatin) == 0) "None" else top_species_missing_80_Simvastatin
top_species_wrong_80_Simvastatin <- if(length(top_species_wrong_80_Simvastatin) == 0) "None" else top_species_wrong_80_Simvastatin

Prediction_quality_80_Simvastatin <- data.frame(
  Top_six_correct = paste(top_six_correct_80_Simvastatin, sep=""),
  Top_six_correct_NULL = paste(top_six_correct_80_Simvastatin_NULL, sep=""),
  Top_six_correct_means = paste(top_six_correct_80_Simvastatin_means, sep=""),
  Top_six_correct_means_NULL = paste(top_six_correct_80_Simvastatin_means_NULL, sep=""),
  Predicted_magnitude_correct = paste(round(predicted_magnitude_correct_fraction_80_Simvastatin * 100, 2), "%", sep=""),
  Predicted_magnitude_correct_NULL = paste(round(predicted_magnitude_correct_fraction_80_Simvastatin_NULL * 100, 2), "%", sep=""),
  survivors_total = survivors_80_Simvastatin,
  top_species_missing <- top_species_missing_80_Simvastatin,
  top_species_wrong <- top_species_wrong_80_Simvastatin, 
  predicted_mean_final_OD <- predicted_mean_final_od_80_Simvastatin,
  real_mean_final_OD <- real_mean_final_od_80_Simvastatin,
  sims_total = length(successful_sim_ids)
)

Prediction_quality_80_Simvastatin










##Tamoxifen

combined_monoculture_aucs2_Tamoxifen <- subset(combined_monoculture_aucs2, drug == "Tamoxifen")


#drug sensitivity terms: define once outside of ODEs
y_function_B_vulgatus_Tamoxifen <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("B_vulgatus", "Tamoxifen", best_fitting_models_df_Tamoxifen)), collapse = " ")))
y_function_B_uniformis_Tamoxifen <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("B_uniformis", "Tamoxifen", best_fitting_models_df_Tamoxifen)), collapse = " ")))
y_function_B_fragilis_Tamoxifen <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("B_fragilis", "Tamoxifen", best_fitting_models_df_Tamoxifen)), collapse = " ")))
y_function_B_thetaiotaomicron_Tamoxifen <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("B_thetaiotaomicron", "Tamoxifen", best_fitting_models_df_Tamoxifen)), collapse = " ")))
y_function_C_ramosum_Tamoxifen <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("C_ramosum", "Tamoxifen", best_fitting_models_df_Tamoxifen)), collapse = " ")))
y_function_E_rectale_Tamoxifen <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("E_rectale", "Tamoxifen", best_fitting_models_df_Tamoxifen)), collapse = " ")))
y_function_R_intestinalis_Tamoxifen <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("R_intestinalis", "Tamoxifen", best_fitting_models_df_Tamoxifen)), collapse = " ")))
y_function_V_parvula_Tamoxifen <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("V_parvula", "Tamoxifen", best_fitting_models_df_Tamoxifen)), collapse = " ")))
y_function_E_lenta_Tamoxifen <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("E_lenta", "Tamoxifen", best_fitting_models_df_Tamoxifen)), collapse = " ")))
y_function_F_nucleatum_Tamoxifen <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("F_nucleatum", "Tamoxifen", best_fitting_models_df_Tamoxifen)), collapse = " ")))
y_function_C_bolteae_Tamoxifen <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("C_bolteae", "Tamoxifen", best_fitting_models_df_Tamoxifen)), collapse = " ")))
y_function_C_perfringens_Tamoxifen <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("C_perfringens", "Tamoxifen", best_fitting_models_df_Tamoxifen)), collapse = " ")))
y_function_C_saccharolyticum_Tamoxifen <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("C_saccharolyticum", "Tamoxifen", best_fitting_models_df_Tamoxifen)), collapse = " ")))
y_function_S_salivarius_Tamoxifen <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("S_salivarius", "Tamoxifen", best_fitting_models_df_Tamoxifen)), collapse = " ")))
y_function_R_gnavus_Tamoxifen <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("R_gnavus", "Tamoxifen", best_fitting_models_df_Tamoxifen)), collapse = " ")))
y_function_C_comes_Tamoxifen <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("C_comes", "Tamoxifen", best_fitting_models_df_Tamoxifen)), collapse = " ")))
y_function_P_merdae_Tamoxifen <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("P_merdae", "Tamoxifen", best_fitting_models_df_Tamoxifen)), collapse = " ")))
y_function_S_parasanguinis_Tamoxifen <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("S_parasanguinis", "Tamoxifen", best_fitting_models_df_Tamoxifen)), collapse = " ")))
y_function_C_aerofaciens_Tamoxifen <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("C_aerofaciens", "Tamoxifen", best_fitting_models_df_Tamoxifen)), collapse = " ")))
y_function_D_formicigenerans_Tamoxifen <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("D_formicigenerans", "Tamoxifen", best_fitting_models_df_Tamoxifen)), collapse = " ")))
y_function_E_coli_Tamoxifen <- noquote(sub("^function\\s*\\(Drug\\)\\s*", "", paste(deparse(get_y_function("E_coli", "Tamoxifen", best_fitting_models_df_Tamoxifen)), collapse = " ")))



y_function_B_vulgatus_Tamoxifen_func <- eval(parse(text = paste("function(Drug) {", y_function_B_vulgatus_Tamoxifen, "}")))
y_function_B_uniformis_Tamoxifen_func <- eval(parse(text = paste("function(Drug) {", y_function_B_uniformis_Tamoxifen, "}")))
y_function_B_fragilis_Tamoxifen_func <- eval(parse(text = paste("function(Drug) {", y_function_B_fragilis_Tamoxifen, "}")))
y_function_B_thetaiotaomicron_Tamoxifen_func <- eval(parse(text = paste("function(Drug) {", y_function_B_thetaiotaomicron_Tamoxifen, "}")))
y_function_C_ramosum_Tamoxifen_func <- eval(parse(text = paste("function(Drug) {", y_function_C_ramosum_Tamoxifen, "}")))
y_function_E_rectale_Tamoxifen_func <- eval(parse(text = paste("function(Drug) {", y_function_E_rectale_Tamoxifen, "}")))
y_function_R_intestinalis_Tamoxifen_func <- eval(parse(text = paste("function(Drug) {", y_function_R_intestinalis_Tamoxifen, "}")))
y_function_E_lenta_Tamoxifen_func <- eval(parse(text = paste("function(Drug) {", y_function_E_lenta_Tamoxifen, "}")))
y_function_F_nucleatum_Tamoxifen_func <- eval(parse(text = paste("function(Drug) {", y_function_F_nucleatum_Tamoxifen, "}")))
y_function_C_bolteae_Tamoxifen_func <- eval(parse(text = paste("function(Drug) {", y_function_C_bolteae_Tamoxifen, "}")))
y_function_C_perfringens_Tamoxifen_func <- eval(parse(text = paste("function(Drug) {", y_function_C_perfringens_Tamoxifen, "}")))
y_function_C_saccharolyticum_Tamoxifen_func <- eval(parse(text = paste("function(Drug) {", y_function_C_saccharolyticum_Tamoxifen, "}")))
y_function_S_salivarius_Tamoxifen_func <- eval(parse(text = paste("function(Drug) {", y_function_S_salivarius_Tamoxifen, "}")))
y_function_R_gnavus_Tamoxifen_func <- eval(parse(text = paste("function(Drug) {", y_function_R_gnavus_Tamoxifen, "}")))
y_function_C_comes_Tamoxifen_func <- eval(parse(text = paste("function(Drug) {", y_function_C_comes_Tamoxifen, "}")))
y_function_P_merdae_Tamoxifen_func <- eval(parse(text = paste("function(Drug) {", y_function_P_merdae_Tamoxifen, "}")))
y_function_S_parasanguinis_Tamoxifen_func <- eval(parse(text = paste("function(Drug) {", y_function_S_parasanguinis_Tamoxifen, "}")))
y_function_C_aerofaciens_Tamoxifen_func <- eval(parse(text = paste("function(Drug) {", y_function_C_aerofaciens_Tamoxifen, "}")))
y_function_D_formicigenerans_Tamoxifen_func <- eval(parse(text = paste("function(Drug) {", y_function_D_formicigenerans_Tamoxifen, "}")))
y_function_E_coli_Tamoxifen_func <- eval(parse(text = paste("function(Drug) {", y_function_E_coli_Tamoxifen, "}")))
y_function_V_parvula_Tamoxifen_func <- eval(parse(text = paste("function(Drug) {", y_function_V_parvula_Tamoxifen, "}")))



unique(combined_monoculture_aucs2_Tamoxifen$conc)
##dictate drug concentration tested for simulation cycle here:
#drug_concentration_tested <- 20 #if manually or:
drug_concentration_tested <- unique(combined_monoculture_aucs2_Tamoxifen$conc)[1]
initial_conditions <- rep(0.01/32, 32)
initial_conditions <- c(initial_conditions, drug_concentration_tested)


##drug effect fitted for species showing sensitivity in monoculture:
#unique(combined_monoculture_aucs2_Tamoxifen$Species)

##for more simple linear fits
closed.sir.model_Tamoxifen <- function (t, x, params) {
  ## first extract the state variables
  A_muciniphila <- x[1]
  B_adolescentis <- x[2]
  B_fragilis <- x[3]
  B_longum <- x[4]
  B_obeum <- x[5]
  B_thetaiotaomicron <- x[6]
  B_uniformis <- x[7]
  B_vulgatus <- x[8]
  B_wadsworthia <- x[9]
  C_aerofaciens <- x[10]
  C_bolteae <- x[11]
  C_comes <- x[12]
  C_perfringens <- x[13]
  C_ramosum <- x[14]
  C_saccharolyticum <- x[15]
  D_formicigenerans <- x[16]
  E_coli <- x[17]
  E_lenta <- x[18]
  E_rectale <- x[19]
  F_nucleatum <- x[20]
  L_paracasei <- x[21]
  O_splanchnicus <- x[22]
  P_copri <- x[23]
  P_distasonis <- x[24]
  P_merdae <- x[25]
  R_bromii <- x[26]
  R_gnavus <- x[27]
  R_intestinalis <- x[28]
  R_torques <- x[29]
  S_parasanguinis <- x[30]
  S_salivarius <- x[31]
  V_parvula <- x[32]
  Drug <- x[33]
  
  
  ## now extract the parameters
  r_B_fragilis <- flat_params[["B._fragilis.r"]]
  K_B_fragilis <- flat_params[["B._fragilis.K"]]
  r_B_longum <- flat_params[["B._longum.r"]]
  K_B_longum <- flat_params[["B._longum.K"]]
  r_B_thetaiotaomicron <- flat_params[["B._thetaiotaomicron.r"]]
  K_B_thetaiotaomicron <- flat_params[["B._thetaiotaomicron.K"]]
  r_B_uniformis <- flat_params[["B._uniformis.r"]]
  K_B_uniformis <- flat_params[["B._uniformis.K"]]
  r_B_vulgatus <- flat_params[["B._vulgatus.r"]]
  K_B_vulgatus <- flat_params[["B._vulgatus.K"]]
  r_B_wadsworthia <- flat_params[["B._wadsworthia.r"]]
  K_B_wadsworthia <- flat_params[["B._wadsworthia.K"]]
  r_C_aerofaciens <- flat_params[["C._aerofaciens.r"]]
  K_C_aerofaciens <- flat_params[["C._aerofaciens.K"]]
  r_C_bolteae <- flat_params[["C._bolteae.r"]]
  K_C_bolteae <- flat_params[["C._bolteae.K"]]
  r_C_comes <- flat_params[["C._comes.r"]]
  K_C_comes <- flat_params[["C._comes.K"]]
  r_C_perfringens <- flat_params[["C._perfringens.r"]]
  K_C_perfringens <- flat_params[["C._perfringens.K"]]
  r_C_ramosum <- flat_params[["C._ramosum.r"]]
  K_C_ramosum <- flat_params[["C._ramosum.K"]]
  r_C_saccharolyticum <- flat_params[["C._saccharolyticum.r"]]
  K_C_saccharolyticum <- flat_params[["C._saccharolyticum.K"]]
  r_D_formicigenerans <- flat_params[["D._formicigenerans.r"]]
  K_D_formicigenerans <- flat_params[["D._formicigenerans.K"]]
  r_E_coli <- flat_params[["E._coli.r"]]
  K_E_coli <- flat_params[["E._coli.K"]]
  r_E_lenta <- flat_params[["E._lenta.r"]]
  K_E_lenta <- flat_params[["E._lenta.K"]]
  r_E_rectale <- flat_params[["E._rectale.r"]]
  K_E_rectale <- flat_params[["E._rectale.K"]]
  r_F_nucleatum <- flat_params[["F._nucleatum.r"]]
  K_F_nucleatum <- flat_params[["F._nucleatum.K"]]
  r_P_copri <- flat_params[["P._copri.r"]]
  K_P_copri <- flat_params[["P._copri.K"]]
  r_P_merdae <- flat_params[["P._merdae.r"]]
  K_P_merdae <- flat_params[["P._merdae.K"]]
  r_R_gnavus <- flat_params[["R._gnavus.r"]]
  K_R_gnavus <- flat_params[["R._gnavus.K"]]
  r_R_intestinalis <- flat_params[["R._intestinalis.r"]]
  K_R_intestinalis <- flat_params[["R._intestinalis.K"]]
  r_V_parvula <- flat_params[["V._parvula.r"]]
  K_V_parvula <- flat_params[["V._parvula.K"]]
  r_A_muciniphila <- flat_params[["A._muciniphila.r"]]
  K_A_muciniphila <- flat_params[["A._muciniphila.K"]]
  r_B_adolescentis <- flat_params[["B._adolescentis.r"]]
  K_B_adolescentis <- flat_params[["B._adolescentis.K"]]
  r_B_obeum <- flat_params[["B._obeum.r"]]
  K_B_obeum <- flat_params[["B._obeum.K"]]
  r_O_splanchnicus <- flat_params[["O._splanchnicus.r"]]
  K_O_splanchnicus <- flat_params[["O._splanchnicus.K"]]
  r_P_distasonis <- flat_params[["P._distasonis.r"]]
  K_P_distasonis <- flat_params[["P._distasonis.K"]]
  r_R_bromii <- flat_params[["R._bromii.r"]]
  K_R_bromii <- flat_params[["R._bromii.K"]]
  r_R_torques <- flat_params[["R._torques.r"]]
  K_R_torques <- flat_params[["R._torques.K"]]
  r_S_parasanguinis <- flat_params[["S._parasanguinis.r"]]
  K_S_parasanguinis <-flat_params[["S._parasanguinis.K"]]
  r_S_salivarius <- flat_params[["S._salivarius.r"]]
  K_S_salivarius <- flat_params[["S._salivarius.K"]]
  r_L_paracasei <- flat_params[["L._paracasei.r"]]
  K_L_paracasei <- flat_params[["L._paracasei.K"]]
  
  
  t_mod <- ifelse(t > 24.1, t - 24.1, t)
  
  
  ## now code the model equations
  dA_muciniphila_dt <- r_A_muciniphila * A_muciniphila * (1 - A_muciniphila / K_A_muciniphila)
  dB_adolescentis_dt <- r_B_adolescentis * B_adolescentis * (1 - B_adolescentis / K_B_adolescentis)
  dB_fragilis_dt <- r_B_fragilis * B_fragilis * (1 - B_fragilis / max(0.0001, K_B_fragilis * (y_function_B_fragilis_Tamoxifen_func(Drug))))
  dB_longum_dt <- r_B_longum * B_longum * (1 - B_longum / K_B_longum)
  dB_obeum_dt <- r_B_obeum * B_obeum * (1 - B_obeum / K_B_obeum)
  dB_thetaiotaomicron_dt <- r_B_thetaiotaomicron * B_thetaiotaomicron * (1 - B_thetaiotaomicron / max(0.0001, K_B_thetaiotaomicron * (y_function_B_thetaiotaomicron_Tamoxifen_func(Drug))))  
  dB_uniformis_dt <- r_B_uniformis * B_uniformis * (1 - B_uniformis / max(0.0001, K_B_uniformis * (y_function_B_uniformis_Tamoxifen_func(Drug))))
  dB_vulgatus_dt <- r_B_vulgatus * B_vulgatus * (1 - B_vulgatus / max(0.0001, K_B_vulgatus * (y_function_B_vulgatus_Tamoxifen_func(Drug))))
  dB_wadsworthia_dt <- r_B_wadsworthia * B_wadsworthia * (1 - B_wadsworthia / K_B_wadsworthia)
  dC_aerofaciens_dt <- r_C_aerofaciens * C_aerofaciens * (1 - C_aerofaciens / max(0.0001, K_C_aerofaciens * (y_function_C_aerofaciens_Tamoxifen_func(Drug))))
  dC_bolteae_dt <- r_C_bolteae * C_bolteae * (1 - C_bolteae /  max(0.0001, K_C_bolteae * (y_function_C_bolteae_Tamoxifen_func(Drug))))
  dC_comes_dt <- r_C_comes * C_comes * (1 - C_comes / max(0.0001, K_C_comes * (y_function_C_comes_Tamoxifen_func(Drug))))
  dC_perfringens_dt <- r_C_perfringens * C_perfringens * (1 - C_perfringens / max(0.0001, K_C_perfringens * (y_function_C_perfringens_Tamoxifen_func(Drug))))
  dC_ramosum_dt <- r_C_ramosum * C_ramosum * (1 - C_ramosum / max(0.0001, K_C_ramosum * (y_function_C_ramosum_Tamoxifen_func(Drug))))
  dC_saccharolyticum_dt <- r_C_saccharolyticum * C_saccharolyticum * (1 - C_saccharolyticum / max(0.0001, K_C_saccharolyticum * (y_function_C_saccharolyticum_Tamoxifen_func(Drug))))
  dD_formicigenerans_dt <- r_D_formicigenerans * D_formicigenerans * (1 - D_formicigenerans / max(0.0001, K_D_formicigenerans * (y_function_D_formicigenerans_Tamoxifen_func(Drug))))
  dE_coli_dt <- r_E_coli * E_coli * (1 - E_coli / max(0.0001, K_E_coli * (y_function_E_coli_Tamoxifen_func(Drug))))
  dE_lenta_dt <- r_E_lenta * E_lenta * (1 - E_lenta / max(0.0001, K_E_lenta * (y_function_E_lenta_Tamoxifen_func(Drug))))
  dE_rectale_dt <- r_E_rectale * E_rectale * (1 - E_rectale / max(0.0001, K_E_rectale * (y_function_E_rectale_Tamoxifen_func(Drug))))
  dF_nucleatum_dt <- r_F_nucleatum * F_nucleatum * (1 - F_nucleatum / max(0.0001, K_F_nucleatum * (y_function_F_nucleatum_Tamoxifen_func(Drug))))
  dL_paracasei_dt <- r_L_paracasei * L_paracasei * (1 - L_paracasei / K_L_paracasei)  
  dO_splanchnicus_dt <- r_O_splanchnicus * O_splanchnicus * (1 - O_splanchnicus / K_O_splanchnicus)  
  dP_copri_dt <- r_P_copri * P_copri * (1 - P_copri / K_P_copri)
  dP_distasonis_dt <- r_P_distasonis * P_distasonis * (1 - P_distasonis / K_P_distasonis)  
  dP_merdae_dt <- r_P_merdae * P_merdae * (1 - P_merdae / max(0.0001, K_P_merdae * (y_function_P_merdae_Tamoxifen_func(Drug))))
  dR_bromii_dt <- r_R_bromii * R_bromii * (1 - R_bromii / K_R_bromii) 
  dR_gnavus_dt <- r_R_gnavus * R_gnavus * (1 - R_gnavus / max(0.0001, K_R_gnavus * (y_function_R_gnavus_Tamoxifen_func(Drug))))
  dR_intestinalis_dt <- r_R_intestinalis * R_intestinalis * (1 - R_intestinalis / max(0.0001, K_R_intestinalis * (y_function_R_intestinalis_Tamoxifen_func(Drug))))
  dR_torques_dt <- r_R_torques * R_torques * (1 - R_torques /K_R_torques) 
  dS_parasanguinis_dt <- r_S_parasanguinis * S_parasanguinis * (1 - S_parasanguinis / max(0.0001, K_S_parasanguinis * (y_function_S_parasanguinis_Tamoxifen_func(Drug))))
  dS_salivarius_dt <- r_S_salivarius * S_salivarius * (1 - S_salivarius / max(0.0001, K_S_salivarius * (y_function_S_salivarius_Tamoxifen_func(Drug))))
  dV_parvula_dt <- r_V_parvula * V_parvula * (1 - V_parvula / max(0.0001, K_V_parvula * (y_function_V_parvula_Tamoxifen_func(Drug))))
  
  
  
  #Drug differential:
  dDrug_dt <- (subset(drug_dynamics, Drug == "Tamoxifen")$Steepness_param_community * exp(-subset(drug_dynamics, Drug == "Tamoxifen")$Steepness_param_community * t_mod)) * (drug_concentration_tested * prop_left_Tamoxifen - drug_concentration_tested)
  #dDrug_dt <- 0
  
  ## Combine results into a single vector
  dxdt <- c(dA_muciniphila_dt, dB_adolescentis_dt, dB_fragilis_dt, dB_longum_dt, dB_obeum_dt, dB_thetaiotaomicron_dt, dB_uniformis_dt, dB_vulgatus_dt, dB_wadsworthia_dt, dC_aerofaciens_dt, dC_bolteae_dt, dC_comes_dt, dC_perfringens_dt, dC_ramosum_dt, dC_saccharolyticum_dt, dD_formicigenerans_dt, dE_coli_dt, dE_lenta_dt, dE_rectale_dt, dF_nucleatum_dt, dL_paracasei_dt, dO_splanchnicus_dt, dP_copri_dt, dP_distasonis_dt, dP_merdae_dt, dR_bromii_dt, dR_gnavus_dt, dR_intestinalis_dt, dR_torques_dt, dS_parasanguinis_dt, dS_salivarius_dt, dV_parvula_dt, dDrug_dt)
  
  ## Return result as a list
  list(dxdt)
}




#calculate the co-culture correction factor per species based on community composition in absence of drug, just like done for Niclosamide

growth_data_all_0_Niclosamide
growth_data_all_0_Niclosamide1 <- growth_data_all_0_Niclosamide %>%
  dplyr::mutate(Species = gsub(" ", "_", Species))


# Merge rel_ab_control with growth_data_all_0_Niclosamide on Species
# Function to remove duplicated columns by name pattern
clean_columns_base <- function(df, pattern) {
  cols_to_keep <- !grepl(pattern, names(df))
  df <- df[, cols_to_keep]
  return(df)
}

# Use the new function to clean up your dataframe
rel_ab_control <- clean_columns_base(rel_ab_control, "mean_max_OD.[xy]")
str(rel_ab_control)


#rel_ab_control$correction_factor <- rel_ab_control$mean_rel_ab / (rel_ab_control$mean_max_OD/sum(rel_ab_control$mean_max_OD))
# Calculate correction factor with a minimum value of ~1
rel_ab_control$correction_factor <- pmax(rel_ab_control$mean_rel_ab / (rel_ab_control$mean_max_OD / sum(rel_ab_control$mean_max_OD)), 1.1)


# Create a new dataframe for co-culture correction
co_culture_correction <- data.frame(
  species = rel_ab_control$Species,
  correction_factor = rel_ab_control$correction_factor
)


#summarise community data
#Adjust based on tested concentrations for each drug
unique(Community_compositions_focus_drugs_Tamoxifen$concentration)

Community_compositions_focus_drugs_Tamoxifen_320uM <- subset(Community_compositions_focus_drugs_Tamoxifen, concentration == 320)
Community_compositions_focus_drugs_Tamoxifen_20uM <- subset(Community_compositions_focus_drugs_Tamoxifen, concentration == 20)
Community_compositions_focus_drugs_Tamoxifen_80uM <- subset(Community_compositions_focus_drugs_Tamoxifen, concentration == 80)


#320 uM
Community_compositions_focus_drugs_Tamoxifen_320uM_summarised <- Community_compositions_focus_drugs_Tamoxifen_320uM %>%
  dplyr::group_by(species) %>%                                  
  dplyr::summarize(
    mean_rel_ab = mean(rel_abundance, na.rm = TRUE),     
    sd_rel_ab = sd(rel_abundance, na.rm = TRUE) ,
    mean_max_OD = mean(maxOD, na.rm = TRUE),
    sd_max_OD = sd(maxOD, na.rm = TRUE),
    mean_final_OD = mean(finalOD, na.rm = TRUE),
    sd_final_OD = sd(finalOD, na.rm = TRUE)
  ) %>%
  dplyr::ungroup() 


Community_compositions_focus_drugs_Tamoxifen_320uM_summarised <- Community_compositions_focus_drugs_Tamoxifen_320uM_summarised %>%
  dplyr::mutate(Species = sub("^(\\w)\\w*\\s(.*)", "\\1._\\2", species))

#remove (sub)strain info
Community_compositions_focus_drugs_Tamoxifen_320uM_summarised <- Community_compositions_focus_drugs_Tamoxifen_320uM_summarised %>%
  dplyr::mutate(Species = sub("^(\\w\\._\\w+).*", "\\1", Species))


#20 uM
Community_compositions_focus_drugs_Tamoxifen_20uM_summarised <- Community_compositions_focus_drugs_Tamoxifen_20uM %>%
  dplyr::group_by(species) %>%                                  
  dplyr::summarize(
    mean_rel_ab = mean(rel_abundance, na.rm = TRUE),     
    sd_rel_ab = sd(rel_abundance, na.rm = TRUE) ,
    mean_max_OD = mean(maxOD, na.rm = TRUE),
    sd_max_OD = sd(maxOD, na.rm = TRUE),
    mean_final_OD = mean(finalOD, na.rm = TRUE),
    sd_final_OD = sd(finalOD, na.rm = TRUE)
  ) %>%
  dplyr::ungroup() 


Community_compositions_focus_drugs_Tamoxifen_20uM_summarised <- Community_compositions_focus_drugs_Tamoxifen_20uM_summarised %>%
  dplyr::mutate(Species = sub("^(\\w)\\w*\\s(.*)", "\\1._\\2", species))

#remove (sub)strain info
Community_compositions_focus_drugs_Tamoxifen_20uM_summarised <- Community_compositions_focus_drugs_Tamoxifen_20uM_summarised %>%
  dplyr::mutate(Species = sub("^(\\w\\._\\w+).*", "\\1", Species))


#80 uM
Community_compositions_focus_drugs_Tamoxifen_80uM_summarised <- Community_compositions_focus_drugs_Tamoxifen_80uM %>%
  dplyr::group_by(species) %>%                                  
  dplyr::summarize(
    mean_rel_ab = mean(rel_abundance, na.rm = TRUE),     
    sd_rel_ab = sd(rel_abundance, na.rm = TRUE) ,
    mean_max_OD = mean(maxOD, na.rm = TRUE),
    sd_max_OD = sd(maxOD, na.rm = TRUE),    
    mean_final_OD = mean(finalOD, na.rm = TRUE),
    sd_final_OD = sd(finalOD, na.rm = TRUE)
  ) %>%
  dplyr::ungroup() 



Community_compositions_focus_drugs_Tamoxifen_80uM_summarised <- Community_compositions_focus_drugs_Tamoxifen_80uM_summarised %>%
  dplyr::mutate(Species = sub("^(\\w)\\w*\\s(.*)", "\\1._\\2", species))

#remove (sub)strain info
Community_compositions_focus_drugs_Tamoxifen_80uM_summarised <- Community_compositions_focus_drugs_Tamoxifen_80uM_summarised %>%
  dplyr::mutate(Species = sub("^(\\w\\._\\w+).*", "\\1", Species))


#Initialise data frames
sim_output <- data.frame()
input_params_list <- list() #Use a list to collect parameters for each simulation

#number of simulations
num_sims <- 250


for (i in 1:num_sims) {
  tryCatch({
    # generate model parameters
    set.seed(i) #set a different seed for each simulation for variation
    params <- lapply(1:nrow(growth_data_all_0_Niclosamide), function(idx) {
      species_params <- growth_data_all_0_Niclosamide[idx, ]
      list(
        r = rnorm(1, mean = species_params$mean_max_Growth_rate, sd = species_params$sd_max_Growth_rate),
        K = rnorm(1, mean = species_params$mean_max_OD, sd = species_params$sd_max_OD)
      )
    })
    names(params) <- gsub(" ", "_", growth_data_all_0_Niclosamide$Species)
    flat_params <- unlist(params)
    names(flat_params) <- gsub("\\.\\d$", "", names(flat_params))
    
    #replace spaces with underscores to match formatting
    co_culture_correction$species <- gsub(" ", "_", co_culture_correction$species, fixed = TRUE)
    
    #replace the species-specific K parameters extracted from monoculture growth data 
    #with drawn relative abundance values at Niclosamide = 0, scaled to K
    rel_ab_control$Species <- gsub(" ", "_", rel_ab_control$Species)
    
    #Initialise an empty vector to store drawn values
    drawn_values <- numeric(nrow(rel_ab_control))
    
    #draw values from their respective distributions
    for (k in 1:nrow(rel_ab_control)) {
      species_name <- rel_ab_control$Species[k]
      drawn_value <- rnorm(1, mean = rel_ab_control$mean_rel_ab[k], sd = rel_ab_control$sd_rel_ab[k])
      drawn_values[k] <- max(drawn_value, 0)  # Ensure no negative values
    }
    
    #Normalise drawn relative abundance values so they sum to 1 (to reflect a 'true' relative abundance distribution)
    #this is needed so when we convert the values into OD units by multiplying with the drawn community maxOD,
    # the sum of K_i parameters and the drawn K are equal
    normalised_values <- drawn_values / sum(drawn_values)
    
    #Pull community maxOD (K) at 0 drugs from respective normal distribution:
    K <- rnorm(n = 1, mean = rel_ab_control$mean_com_max_OD[1], sd = rel_ab_control$sd_com_max_OD[1])
    
    # Assign these normalised values to their respective species' .K parameters
    for (k in 1:nrow(rel_ab_control)) {
      species_name <- rel_ab_control$Species[k]
      k_index <- grep(paste0("^", species_name, "\\.K$"), names(flat_params))
      
      if (length(k_index) > 0) {
        old_value <- flat_params[k_index]
        flat_params[k_index] <- (normalised_values[k] + 0.0001) * K #add small value in case drawn K_i is 0, which would cause issues with the solver
        cat(sprintf("Updated %s from %f to %f using normalised value %f scaled by K %f\n", names(flat_params)[k_index], old_value, flat_params[k_index], normalised_values[k], K))
      }
    }
    
    #Accounting for variation in drug degradation by community, with standard deviation of end concentration (at 10h) around the fitted predicted (relative) end concentration at 24h
    #prop_left_Tamoxifen <- abs(rnorm(1, (subset(drug_dynamics, Drug == "Tamoxifen")$Prop_left_24h_community), (subset(drug_dynamics, Drug == "Tamoxifen")$SD_drug_community))) 
    #below, we account for measurement error rather than ecological drivers that lead to the variability of degradation at the final point measured 
    prop_left_Tamoxifen <- abs(rnorm(
      n = 1, 
      mean = subset(drug_dynamics, Drug == "Tamoxifen")$Prop_left_24h_community, 
      sd = ifelse(
        subset(drug_dynamics, Drug == "Tamoxifen")$SD_drug_community > subset(drug_dynamics, Drug == "Tamoxifen")$SD_drug_community_start, 
        subset(drug_dynamics, Drug == "Tamoxifen")$SD_drug_community - subset(drug_dynamics, Drug == "Tamoxifen")$SD_drug_community_start, 
        subset(drug_dynamics, Drug == "Tamoxifen")$SD_drug_community
      )
    ))
    
    
    #loop through each species in co_culture_correction
    for (j in 1:nrow(co_culture_correction)) {
      # Extract the species name and correction factor
      species_name <- co_culture_correction$species[j]
      correction_factor <- co_culture_correction$correction_factor[j]
      
      # Identify the corresponding growth rate parameter in flat_params
      #by matching the base species name (without .r)
      growth_rate_indices <- grep(paste0("^", species_name, "\\.r$"), names(flat_params))
      
      #take the growth rate parameter and apply the correction factor 
      for (index in growth_rate_indices) {
        flat_params[index] <- flat_params[index] * correction_factor
      }
    }
    
    flat_params
    # Store parameters for each simulation
    input_params_list[[i]] <- c(sim_ID = i, flat_params)
    
    # Run the model for the first 24-hour cycle
    solution_cycle_1 <- ode(y = initial_conditions, times = seq(from = 0, to = 24, by = 0.1), func = closed.sir.model_Tamoxifen, parms = flat_params,   method = "lsoda", rtol = 1e-6, atol = 1e-6)
    
    # Dilution and second cycle
    end_of_cycle_1 <- solution_cycle_1[nrow(solution_cycle_1), -1]
    initial_conditions_cycle_2 <- end_of_cycle_1 / 50
    #accounting for the drugs being added with the new growth cycle as well:
    initial_conditions_cycle_2[33] <- initial_conditions_cycle_2[33] + drug_concentration_tested
    solution_cycle_2 <- ode(y = initial_conditions_cycle_2, times = seq(from = 24, to = 48, by = 0.1), func = closed.sir.model_Tamoxifen, parms = flat_params,  method = "lsoda", rtol = 1e-6, atol = 1e-6)
    
    # Combine and format results
    combined_solution <- rbind(as.data.frame(solution_cycle_1), as.data.frame(solution_cycle_2)[-1,])
    combined_solution$sim_ID <- rep(i, nrow(combined_solution))
    combined_solution <- combined_solution %>%
      tidyr::gather(key = "Species", value = "Density", -time, -sim_ID) %>%
      dplyr::mutate(Hour = time) %>%
      dplyr::select(sim_ID, Hour, Species, Density)
    
    ##Append to sim_output
    sim_output <- rbind(sim_output, combined_solution)
  }, error = function(e) {
    cat(sprintf("Skipping simulation %d due to an error: %s\n", i, e$message))
  })
}



##Combine all parameter data into a single dataframe
input_params <- do.call(rbind, input_params_list)

# Add a "Species" column 
sim_output$Species_name <- species_names[as.numeric(as.character(sim_output$Species))]
sim_output$Species_name <- replace_na(sim_output$Species_name, "Drug")

#View(input_params)
#View(sim_output)

sim_output <- na.omit(sim_output)
successful_sim_ids <- unique(subset(sim_output, Hour == 48)$sim_ID)
length(successful_sim_ids)
sim_output1 <- sim_output[sim_output$sim_ID %in% successful_sim_ids, ]


#Transform sim_output so we have wide format by Species
sim_output_wide <- tidyr::pivot_wider(sim_output1, 
                                      names_from = Species_name, 
                                      values_from = Density,
                                      id_cols = c(sim_ID, Hour))

length(unique(sim_output_wide$sim_ID))
#calc community OD per timepoint
sim_output_wide$Total_OD <- rowSums(sim_output_wide[, 3:34], na.rm = TRUE)
#calculate and add relative abundances here as well:
species_columns <- colnames(sim_output_wide)[3:34] 

for (species in species_columns) {
  sim_output_wide[[paste0("rel_", species)]] <- sim_output_wide[[species]] / sim_output_wide$Total_OD
}


#assign sim_output_wide test conditions to dataframe name
drug_tested <- "Tamoxifen"
variable_name_1 <- paste0("sim_output_wide_", ifelse(drug_concentration_tested == 1e-04, 0, drug_concentration_tested), "_", drug_tested)
assign(variable_name_1, sim_output_wide)

#turn back into long format if interested in plotting relative abundances
cols_needed <- c("sim_ID", "Hour")

sim_output_long <- sim_output_wide %>% 
  dplyr::select(sim_ID, Hour, Drug, starts_with("rel_")) %>% 
  tidyr::pivot_longer(
    cols = c(Drug, starts_with("rel_")),
    names_to = "Species", 
    values_to = "Relative_abundance",
    names_prefix = "rel_",
    names_transform = list(Species = ~ ifelse(.x == "Drug", "Drug", .x))
  ) 

str(sim_output_long)


species_names_1 <- c(
  "A_muciniphila",
  "B_adolescentis",
  "B_fragilis",
  "B_longum",
  "B_obeum",
  "B_thetaiotaomicron",
  "B_uniformis",
  "B_vulgatus",
  "B_wadsworthia",
  "C_aerofaciens",
  "C_bolteae",
  "C_comes",
  "C_perfringens",
  "C_ramosum",
  "C_saccharolyticum",
  "D_formicigenerans",
  "E_coli",
  "E_lenta",
  "E_rectale",
  "F_nucleatum",
  "L_paracasei",
  "O_splanchnicus",
  "P_copri",
  "P_distasonis",
  "P_merdae",
  "R_bromii",
  "R_gnavus",
  "R_intestinalis",
  "R_torques",
  "S_parasanguinis",
  "S_salivarius",
  "V_parvula",
  "Drug"
)

species_colours_1 <- c(
  "A_muciniphila" = "#1f77b4",
  "B_adolescentis" = "#ff7f0e",
  "B_fragilis" = "#2ca02c",
  "B_longum" = "#d62728",
  "B_obeum" = "#9467bd",
  "B_thetaiotaomicron" = "black",
  "B_uniformis" = "#e377c2",
  "B_vulgatus" = "#7f7f7f",
  "B_wadsworthia" = "gold1",
  "C_aerofaciens" = "#aec7e8",
  "C_bolteae" = "#ffbb78",
  "C_comes" = "magenta",
  "C_perfringens" = "#ff9896",
  "C_ramosum" = "#c5b0d5",
  "C_saccharolyticum" = "#c49c94",
  "D_formicigenerans" = "#f7b6d2",
  "E_coli" = "yellow",
  "E_lenta" = "turquoise",
  "E_rectale" = "#393b79",
  "F_nucleatum" = "royalblue2",
  "L_paracasei" = "blue",
  "O_splanchnicus" = "#637939",
  "P_copri" = "cyan",
  "P_distasonis" = "#8c6d31",
  "P_merdae" = "#c7c7c7",
  "R_bromii" = "#e6550d",
  "R_gnavus" = "#e7cb94",
  "R_intestinalis" = "#843c39",
  "R_torques" = "#d6616b",
  "S_parasanguinis" = "orange3",
  "S_salivarius" = "#7b4173",
  "V_parvula" = "#ce6dbd",
  "Drug" = "green"
)



##Plot output for any specific sim:
# ggplot(subset(sim_output, sim_ID == 1 & Species_name != "Drug"), aes(x = Hour, y = Density, group = Species_name, color = Species_name)) +
#   geom_line(size = 1, alpha = 0.7) +
#   scale_color_manual(values = species_colours_1) +
#   labs(title = paste0("Tamoxifen = ", drug_concentration_tested),
#        x = "Time (hours)",
#        y = "Population Density (OD)",
#        color = "Species") +
#   theme_minimal() +
#   theme(legend.position = "right")
# 
# ggplot(subset(sim_output, sim_ID == 3 & Species_name != "Drug"), aes(x = Hour, y = Density, group = Species_name, color = Species_name)) +
#   geom_line(size = 1, alpha = 0.7) +
#   scale_color_manual(values = species_colours_1) +
#   labs(title = paste0("Tamoxifen = ", drug_concentration_tested),
#        x = "Time (hours)",
#        y = "Population Density (OD)",
#        color = "Species") +
#   theme_minimal() +
#   theme(legend.position = "right")


ggplot(subset(sim_output_long, sim_ID == 1), aes(x = Hour, y = Relative_abundance, group = Species, color = Species)) +
  geom_line(size = 1, alpha = 0.7) +
  scale_color_manual(values = species_colours_1) +
  labs(title = paste0("Tamoxifen = ", drug_concentration_tested),
       x = "Time (hours)",
       y = "Relative abundance",
       color = "Species") +
  theme_minimal() +
  theme(legend.position = "right")


ggplot(subset(sim_output_long, sim_ID == 3), aes(x = Hour, y = Relative_abundance, group = Species, color = Species)) +
  geom_line(size = 1, alpha = 0.7) +
  scale_color_manual(values = species_colours_1) +
  labs(title = paste0("Tamoxifen = ", drug_concentration_tested),
       x = "Time (hours)",
       y = "Relative abundance",
       color = "Species") +
  theme_minimal() +
  theme(legend.position = "right")


#calc mean and standard deviation across sims
sim_stats <- sim_output_long %>%
  dplyr::group_by(Hour, Species) %>%
  dplyr::summarise(
    mean_rel_ab = mean(Relative_abundance),
    sd_rel_ab = sd(Relative_abundance),
    .groups = 'drop'
  )

# Prepare the data for plotting
plot_data <- sim_stats %>%
  dplyr::mutate(Upper = mean_rel_ab + sd_rel_ab, Lower = mean_rel_ab - sd_rel_ab)

ggplot(subset(plot_data, Species != "Drug"), aes(x = Hour, y = mean_rel_ab, group = Species, color = Species)) +
  geom_ribbon(aes(ymin = Lower, ymax = Upper, fill = Species), colour = NA, alpha = 0.2) +  
  geom_line(size = 1, alpha = 0.7) + 
  scale_color_manual(values = species_colours_1) +
  scale_fill_manual(values = species_colours_1) +  
  labs(title = "Mean and SD of Relative Abundance Across Simulations",
       subtitle = paste0("Tamoxifen = ", drug_concentration_tested),       
       x = "Time (hours)",
       y = "Relative abundance",
       color = "Species",
       fill = "Species") +
  theme_minimal() +
  theme(legend.position = "right")

#log-scaled mean trends
ggplot(plot_data, aes(x = Hour, y = log10(mean_rel_ab + 0.0001), group = Species, color = Species)) +
  geom_line(size = 1, alpha = 0.7) +  # Mean line
  scale_color_manual(values = species_colours_1) +
  scale_fill_manual(values = species_colours_1) +  # Ensure consistent colors for lines and fills
  labs(title = "Mean and SD of Relative Abundance Across Simulations",
       subtitle = paste0("Tamoxifen = ", drug_concentration_tested),
       x = "Time (hours)",
       y = "Relative abundance",
       color = "Species",
       fill = "Species") +
  theme_minimal() +
  theme(legend.position = "right")




##prediction quality evaluation
drug_tested <- "Tamoxifen"
variable_name <- paste0("plot_data_", ifelse(drug_concentration_tested == 1e-04, 0, drug_concentration_tested), "_", drug_tested)
assign(variable_name, plot_data)


#extract total OD info:
predicted_mean_final_od_NULL <- Niclosamide_16S_0uM_summarised$mean_com_final_OD[1]
predicted_sd_final_od_NULL <- Niclosamide_16S_0uM_summarised$sd_com_final_OD[1]

predicted_mean_final_od_320_Tamoxifen <- mean(subset(sim_output_wide_320_Tamoxifen, Hour == 48)$Total_OD, na.rm = TRUE)
predicted_sd_final_od_320_Tamoxifen <- sd(subset(sim_output_wide_320_Tamoxifen, Hour == 48)$Total_OD, na.rm = TRUE)

real_mean_final_od_320_Tamoxifen <- Community_compositions_focus_drugs_Tamoxifen_320uM_summarised$mean_final_OD[1]
real_sd_final_od_320_Tamoxifen <- Community_compositions_focus_drugs_Tamoxifen_320uM_summarised$sd_final_OD[1]


predicted_mean_final_od_20_Tamoxifen <- mean(subset(sim_output_wide_20_Tamoxifen, Hour == 48)$Total_OD, na.rm = TRUE)
predicted_sd_final_od_20_Tamoxifen <- sd(subset(sim_output_wide_20_Tamoxifen, Hour == 48)$Total_OD, na.rm = TRUE)

real_mean_final_od_20_Tamoxifen <- Community_compositions_focus_drugs_Tamoxifen_20uM_summarised$mean_final_OD[1]
real_sd_final_od_20_Tamoxifen <- Community_compositions_focus_drugs_Tamoxifen_20uM_summarised$sd_final_OD[1]


predicted_mean_final_od_80_Tamoxifen <- mean(subset(sim_output_wide_80_Tamoxifen, Hour == 48)$Total_OD, na.rm = TRUE)
predicted_sd_final_od_80_Tamoxifen <- sd(subset(sim_output_wide_80_Tamoxifen, Hour == 48)$Total_OD, na.rm = TRUE)

real_mean_final_od_80_Tamoxifen <- Community_compositions_focus_drugs_Tamoxifen_80uM_summarised$mean_final_OD[1]
real_sd_final_od_80_Tamoxifen <- Community_compositions_focus_drugs_Tamoxifen_80uM_summarised$sd_final_OD[1]




#plot_data_0_Tamoxifen_endpoint was used to test model performance at 0 drugs
#plot_data_0_Tamoxifen_endpoint <- subset(plot_data_0_Tamoxifen, Hour == 48 & Species != "Drug")
plot_data_320_Tamoxifen_endpoint <- subset(plot_data_320_Tamoxifen, Hour == 48 & Species != "Drug")
plot_data_20_Tamoxifen_endpoint <- subset(plot_data_20_Tamoxifen, Hour == 48 & Species != "Drug")
plot_data_80_Tamoxifen_endpoint <- subset(plot_data_80_Tamoxifen, Hour == 48 & Species != "Drug")

##Inspecting 'match' to real relative abundance distributions:
Niclosamide_16S_0uM_summarised <- rel_ab_control
Niclosamide_16S_0uM_summarised$Species <- gsub("\\.", "", Niclosamide_16S_0uM_summarised$Species)

Tamoxifen_16S_320uM_summarised <- Community_compositions_focus_drugs_Tamoxifen_320uM_summarised
Tamoxifen_16S_20uM_summarised <- Community_compositions_focus_drugs_Tamoxifen_20uM_summarised
Tamoxifen_16S_80uM_summarised <- Community_compositions_focus_drugs_Tamoxifen_80uM_summarised

Niclosamide_16S_0uM_summarised
Tamoxifen_16S_320uM_summarised 
Tamoxifen_16S_20uM_summarised 
Tamoxifen_16S_80uM_summarised 

#Rename 'species' so the outputs become comparable
original_names_80 <- unique(Tamoxifen_16S_80uM_summarised$species)
original_names_20 <- unique(Tamoxifen_16S_20uM_summarised$species)
original_names_320 <- unique(Tamoxifen_16S_320uM_summarised$species)


##Create a named vector with the original and new names mapping
name_changes <- c(
  "Akkermansia muciniphila" = "A_muciniphila",
  "Bacteroides fragilis" = "B_fragilis",
  "Bacteroides thetaiotaomicron" = "B_thetaiotaomicron",
  "Bacteroides uniformis" = "B_uniformis",
  "Bifidobacterium adolescentis" = "B_adolescentis",
  "Bifidobacterium longum subsp. longum" = "B_longum",
  "Bilophila wadsworthia" = "B_wadsworthia",
  "Blautia obeum" = "B_obeum",
  "Clostridium perfringens" = "C_perfringens",
  "Collinsella aerofaciens" = "C_aerofaciens",
  "Coprococcus comes" = "C_comes",
  "Dorea formicigenerans" = "D_formicigenerans",
  "Eggerthella lenta" = "E_lenta",
  "Enterocloster bolteae" = "C_bolteae",
  "Erysipelatoclostridium ramosum" = "C_ramosum",
  "Escherichia coli ED1a" = "E_coli",
  "Eubacterium rectale" = "E_rectale",
  "Fusobacterium nucleatum subsp. nucleatum" = "F_nucleatum",
  "Lacrimispora saccharolytica" = "C_saccharolyticum",
  "Lacticaseibacillus paracasei" = "L_paracasei",
  "Odoribacter splanchnicus" = "O_splanchnicus",
  "Parabacteroides distasonis" = "P_distasonis",
  "Parabacteroides merdae" = "P_merdae",
  "Phocaeicola vulgatus" = "B_vulgatus",
  "Prevotella copri" = "P_copri",
  "Roseburia intestinalis" = "R_intestinalis",
  "Ruminococcus bromii" = "R_bromii",
  "Ruminococcus gnavus" = "R_gnavus",
  "Ruminococcus torques" = "R_torques",
  "Streptococcus parasanguinis" = "S_parasanguinis",
  "Streptococcus salivarius" = "S_salivarius",
  "Veillonella parvula" = "V_parvula"
)

# Apply name changes to the species column in Tamoxifen_16S_80uM_summarised

Tamoxifen_16S_80uM_summarised$Species <- name_changes[Tamoxifen_16S_80uM_summarised$species]
Tamoxifen_16S_20uM_summarised$Species <- name_changes[Tamoxifen_16S_20uM_summarised$species]
Tamoxifen_16S_320uM_summarised$Species <- name_changes[Tamoxifen_16S_320uM_summarised$species]

# Verify the changes
unique(Tamoxifen_16S_80uM_summarised$Species)
unique(Tamoxifen_16S_20uM_summarised$Species)
unique(Tamoxifen_16S_320uM_summarised$Species)



##First, for 320 uM:
# Get top 6 species from plot_data_320_endpoint
# Adjust the plot_data_320_endpoint with confidence bounds

# #plot_data_0_Tamoxifen_endpoint was used to test model performance at 0 drugs
# plot_data_0_Tamoxifen_endpoint <- plot_data_0_Tamoxifen_endpoint %>%
#   dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)

plot_data_320_Tamoxifen_endpoint <- plot_data_320_Tamoxifen_endpoint %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)

# Adjust the Tamoxifen_16S_320uM_summarised with confidence bounds
Tamoxifen_16S_320uM_summarised <- Tamoxifen_16S_320uM_summarised %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)

#NULL model:
Null_model_summarised <- Niclosamide_16S_0uM_summarised %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)


# Get top 6 species based on the lower bound from plot_data_320_endpoint

#top6_predicted_0_Tamoxifen was used to test model performance at 0 drugs
# top6_predicted_0_Tamoxifen <- plot_data_0_Tamoxifen_endpoint %>%
#    arrange(desc(lower_bound)) %>%
#    slice(1:6) %>%
#    pull(Species)

top6_predicted_320_Tamoxifen <- plot_data_320_Tamoxifen_endpoint %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

# Get top 6 species based on the lower bound from Tamoxifen_16S_320uM_summarised
top6_real_320_Tamoxifen <- Tamoxifen_16S_320uM_summarised %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

top6_NULL <- Null_model_summarised %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

# Calculate the overlap of top 6 species

#top_six_correct_0_Tamoxifen was used to assess model performance at 0 drugs
# top_six_correct_0_Tamoxifen <- length(intersect(top6_predicted_0_Tamoxifen, top6_NULL))
# top_six_correct_0_Tamoxifen

top_six_correct_320_Tamoxifen <- length(intersect(top6_predicted_320_Tamoxifen, top6_real_320_Tamoxifen))
top_six_correct_320_Tamoxifen

top_six_correct_320_Tamoxifen_NULL <- length(intersect(top6_NULL, top6_real_320_Tamoxifen))
top_six_correct_320_Tamoxifen_NULL

top6_predicted_320_Tamoxifen
top6_real_320_Tamoxifen

#top6_NULL

#Now by means:
# #top6_predicted_0_Tamoxifen_means was used to assess model performance at 0 drugs
# top6_predicted_0_Tamoxifen_means <- plot_data_0_Tamoxifen_endpoint %>%
#    arrange(desc(mean_rel_ab)) %>%
#    slice(1:6) %>%
#    pull(Species)

top6_predicted_320_Tamoxifen_means <- plot_data_320_Tamoxifen_endpoint %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)

# Get top 6 species based on the lower bound from Tamoxifen_16S_320uM_summarised
top6_real_320_Tamoxifen_means <- Tamoxifen_16S_320uM_summarised %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)

top6_NULL_means <- Null_model_summarised %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)


# #top_six_correct_0_Tamoxifen_means was used to assess model performance at 0 drugs
# top_six_correct_0_Tamoxifen_means <- length(intersect(top6_predicted_0_Tamoxifen_means, top6_NULL_means))
# top_six_correct_0_Tamoxifen_means

top_six_correct_320_Tamoxifen_means <- length(intersect(top6_predicted_320_Tamoxifen_means, top6_real_320_Tamoxifen_means))
top_six_correct_320_Tamoxifen_means

top_six_correct_320_Tamoxifen_means_NULL <- length(intersect(top6_NULL_means, top6_real_320_Tamoxifen_means))
top_six_correct_320_Tamoxifen_means_NULL

top6_predicted_320_Tamoxifen_means
top6_real_320_Tamoxifen_means

#top6_NULL_means


# Merge dataframes by Species

#merged_data_0_Tamoxifen was used to assess model performance at 0 drugs
#merged_data_0_Tamoxifen <- merge(plot_data_0_Tamoxifen_endpoint, Niclosamide_16S_0uM_summarised, by = "Species", suffixes = c(".pred", ".real"))
merged_data_320_Tamoxifen <- merge(plot_data_320_Tamoxifen_endpoint, Tamoxifen_16S_320uM_summarised, by = "Species", suffixes = c(".pred", ".real"))
merged_data_320_Tamoxifen_NULL <- merge(Niclosamide_16S_0uM_summarised, Tamoxifen_16S_320uM_summarised, by = "Species", suffixes = c(".null", ".real"))


## Below lines used for assessing model performance at 0 drugs; ignore for nonzero concentrations
# # Create lower and upper bounds considering mean ¬± sd
# merged_data_0_Tamoxifen$lower_bound_pred <- merged_data_0_Tamoxifen$mean_rel_ab.pred - merged_data_0_Tamoxifen$sd_rel_ab.pred
# merged_data_0_Tamoxifen$upper_bound_pred <- merged_data_0_Tamoxifen$mean_rel_ab.pred + merged_data_0_Tamoxifen$sd_rel_ab.pred
# merged_data_0_Tamoxifen$lower_bound_real <- merged_data_0_Tamoxifen$mean_rel_ab.real - merged_data_0_Tamoxifen$sd_rel_ab.real
# merged_data_0_Tamoxifen$upper_bound_real <- merged_data_0_Tamoxifen$mean_rel_ab.real + merged_data_0_Tamoxifen$sd_rel_ab.real
# 
# # Ensure lower and upper bounds are non-negative, adjusting as necessary
# merged_data_0_Tamoxifen$lower_bound_pred[merged_data_0_Tamoxifen$lower_bound_pred <= 0] <- 1e-10
# merged_data_0_Tamoxifen$lower_bound_real[merged_data_0_Tamoxifen$lower_bound_real <= 0] <- 1e-10
# merged_data_0_Tamoxifen$upper_bound_pred[merged_data_0_Tamoxifen$upper_bound_pred <= 0] <- 1e-10
# merged_data_0_Tamoxifen$upper_bound_real[merged_data_0_Tamoxifen$upper_bound_real <= 0] <- 1e-10


# Create lower and upper bounds considering mean ¬± sd
merged_data_320_Tamoxifen$lower_bound_pred <- merged_data_320_Tamoxifen$mean_rel_ab.pred - merged_data_320_Tamoxifen$sd_rel_ab.pred
merged_data_320_Tamoxifen$upper_bound_pred <- merged_data_320_Tamoxifen$mean_rel_ab.pred + merged_data_320_Tamoxifen$sd_rel_ab.pred
merged_data_320_Tamoxifen$lower_bound_real <- merged_data_320_Tamoxifen$mean_rel_ab.real - merged_data_320_Tamoxifen$sd_rel_ab.real
merged_data_320_Tamoxifen$upper_bound_real <- merged_data_320_Tamoxifen$mean_rel_ab.real + merged_data_320_Tamoxifen$sd_rel_ab.real

# Ensure lower and upper bounds are non-negative, adjusting as necessary
merged_data_320_Tamoxifen$lower_bound_pred[merged_data_320_Tamoxifen$lower_bound_pred <= 0] <- 1e-10
merged_data_320_Tamoxifen$lower_bound_real[merged_data_320_Tamoxifen$lower_bound_real <= 0] <- 1e-10
merged_data_320_Tamoxifen$upper_bound_pred[merged_data_320_Tamoxifen$upper_bound_pred <= 0] <- 1e-10
merged_data_320_Tamoxifen$upper_bound_real[merged_data_320_Tamoxifen$upper_bound_real <= 0] <- 1e-10

##and for NULL model:
# Create lower and upper bounds considering mean ¬± sd
merged_data_320_Tamoxifen_NULL$lower_bound_null <- merged_data_320_Tamoxifen_NULL$mean_rel_ab.null - merged_data_320_Tamoxifen_NULL$sd_rel_ab.null
merged_data_320_Tamoxifen_NULL$upper_bound_null <- merged_data_320_Tamoxifen_NULL$mean_rel_ab.null + merged_data_320_Tamoxifen_NULL$sd_rel_ab.null
merged_data_320_Tamoxifen_NULL$lower_bound_real <- merged_data_320_Tamoxifen_NULL$mean_rel_ab.real - merged_data_320_Tamoxifen_NULL$sd_rel_ab.real
merged_data_320_Tamoxifen_NULL$upper_bound_real <- merged_data_320_Tamoxifen_NULL$mean_rel_ab.real + merged_data_320_Tamoxifen_NULL$sd_rel_ab.real

# Ensure lower and upper bounds are non-negative, adjusting as necessary
merged_data_320_Tamoxifen_NULL$lower_bound_null[merged_data_320_Tamoxifen_NULL$lower_bound_null <= 0] <- 1e-10
merged_data_320_Tamoxifen_NULL$lower_bound_real[merged_data_320_Tamoxifen_NULL$lower_bound_real <= 0] <- 1e-10
merged_data_320_Tamoxifen_NULL$upper_bound_null[merged_data_320_Tamoxifen_NULL$upper_bound_null <= 0] <- 1e-10
merged_data_320_Tamoxifen_NULL$upper_bound_real[merged_data_320_Tamoxifen_NULL$upper_bound_real <= 0] <- 1e-10

# Filter to include only species with a mean relative abundance > 0.01 in the 'real' dataset

## significant_species_0 was used to assess model performance at 0 drugs
#significant_species_0 <- merged_data_0_Tamoxifen[merged_data_0_Tamoxifen$mean_rel_ab.real > 0.01, ]
significant_species <- merged_data_320_Tamoxifen[merged_data_320_Tamoxifen$mean_rel_ab.real > 0.01, ]
survivors_320_Tamoxifen <- nrow(significant_species)
survivors_320_Tamoxifen

#should be the same as survivors defined above, since it is calculated from .real
significant_species_NULL <- merged_data_320_Tamoxifen_NULL[merged_data_320_Tamoxifen_NULL$mean_rel_ab.real > 0.01, ]
survivors_320_Tamoxifen_NULL <- nrow(significant_species_NULL)
survivors_320_Tamoxifen_NULL

# Adjusted order of magnitude check to include SD, only for significant species
## below code was used to assess model performance at 0 drugs
# significant_species_0$Predicted_magnitude_correct <- ifelse(
#   (floor(log10(significant_species_0$lower_bound_pred)) <= floor(log10(significant_species_0$upper_bound_real)) &
#      floor(log10(significant_species_0$upper_bound_pred)) >= floor(log10(significant_species_0$lower_bound_real))),
#   1,
#   0
# )

significant_species$Predicted_magnitude_correct <- ifelse(
  (floor(log10(significant_species$lower_bound_pred)) <= floor(log10(significant_species$upper_bound_real)) &
     floor(log10(significant_species$upper_bound_pred)) >= floor(log10(significant_species$lower_bound_real))),
  1,
  0
)

#and for the Null model:
significant_species_NULL$Predicted_magnitude_correct <- ifelse(
  (floor(log10(significant_species_NULL$lower_bound_null)) <= floor(log10(significant_species_NULL$upper_bound_real)) &
     floor(log10(significant_species_NULL$upper_bound_null)) >= floor(log10(significant_species_NULL$lower_bound_real))),
  1,
  0
)

# Calculate the fraction of correctly predicted magnitudes for significant species
## below code was used to assess model performance at 0 drugs
#predicted_magnitude_correct_fraction_0_Tamoxifen <- sum(significant_species_0$Predicted_magnitude_correct) / nrow(significant_species_0)
#predicted_magnitude_correct_fraction_0_Tamoxifen

predicted_magnitude_correct_fraction_320_Tamoxifen <- sum(significant_species$Predicted_magnitude_correct) / nrow(significant_species)
predicted_magnitude_correct_fraction_320_Tamoxifen

predicted_magnitude_correct_fraction_320_Tamoxifen_NULL <- sum(significant_species_NULL$Predicted_magnitude_correct) / nrow(significant_species_NULL)
predicted_magnitude_correct_fraction_320_Tamoxifen_NULL

top_species_missing_320_Tamoxifen <- setdiff(top6_real_320_Tamoxifen_means, top6_predicted_320_Tamoxifen_means)
top_species_wrong_320_Tamoxifen <- setdiff(top6_predicted_320_Tamoxifen_means, top6_real_320_Tamoxifen_means)


Prediction_quality_320_Tamoxifen <- data.frame(
  Top_six_correct = paste(top_six_correct_320_Tamoxifen, sep=""),
  Top_six_correct_NULL = paste(top_six_correct_320_Tamoxifen_NULL, sep=""),
  Top_six_correct_means = paste(top_six_correct_320_Tamoxifen_means, sep=""),
  Top_six_correct_means_NULL = paste(top_six_correct_320_Tamoxifen_means_NULL, sep=""),
  Predicted_magnitude_correct = paste(round(predicted_magnitude_correct_fraction_320_Tamoxifen * 100, 2), "%", sep=""),
  Predicted_magnitude_correct_NULL = paste(round(predicted_magnitude_correct_fraction_320_Tamoxifen_NULL * 100, 2), "%", sep=""),
  survivors_total = survivors_320_Tamoxifen,
  top_species_missing <- top_species_missing_320_Tamoxifen,
  top_species_wrong <- top_species_wrong_320_Tamoxifen, 
  predicted_mean_final_OD <- predicted_mean_final_od_320_Tamoxifen,
  real_mean_final_OD <- real_mean_final_od_320_Tamoxifen,
  sims_total = length(successful_sim_ids)
)



Prediction_quality_320_Tamoxifen



##Next, for 20 uM:
# Get top 6 species from plot_data_20_endpoint
# Adjust the plot_data_20_endpoint with confidence bounds
plot_data_20_Tamoxifen_endpoint <- plot_data_20_Tamoxifen_endpoint %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)

# Adjust the Tamoxifen_16S_20uM_summarised with confidence bounds
Tamoxifen_16S_20uM_summarised <- Tamoxifen_16S_20uM_summarised %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)

#NULL model:
Null_model_summarised <- Niclosamide_16S_0uM_summarised %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)


# Get top 6 species based on the lower bound from plot_data_20_endpoint
top6_predicted_20_Tamoxifen <- plot_data_20_Tamoxifen_endpoint %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

# Get top 6 species based on the lower bound from Tamoxifen_16S_20uM_summarised
top6_real_20_Tamoxifen <- Tamoxifen_16S_20uM_summarised %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

top6_NULL <- Null_model_summarised %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

# Calculate the overlap of top 6 species
top_six_correct_20_Tamoxifen <- length(intersect(top6_predicted_20_Tamoxifen, top6_real_20_Tamoxifen))
#top_six_correct_20_Tamoxifen

top_six_correct_20_Tamoxifen_NULL <- length(intersect(top6_NULL, top6_real_20_Tamoxifen))
#top_six_correct_20_Tamoxifen_NULL

#top6_predicted_20_Tamoxifen
#top6_real_20_Tamoxifen



#Now by means:
top6_predicted_20_Tamoxifen_means <- plot_data_20_Tamoxifen_endpoint %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)

# Get top 6 species based on the lower bound from Tamoxifen_16S_20uM_summarised
top6_real_20_Tamoxifen_means <- Tamoxifen_16S_20uM_summarised %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)

top6_NULL_means <- Null_model_summarised %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)



top_six_correct_20_Tamoxifen_means <- length(intersect(top6_predicted_20_Tamoxifen_means, top6_real_20_Tamoxifen_means))
#top_six_correct_20_Tamoxifen_means

top_six_correct_20_Tamoxifen_means_NULL <- length(intersect(top6_NULL_means, top6_real_20_Tamoxifen_means))
#top_six_correct_20_Tamoxifen_means_NULL

top6_predicted_20_Tamoxifen_means
#top6_real_20_Tamoxifen_means




# Merge dataframes by Species
merged_data_20_Tamoxifen <- merge(plot_data_20_Tamoxifen_endpoint, Tamoxifen_16S_20uM_summarised, by = "Species", suffixes = c(".pred", ".real"))
merged_data_20_Tamoxifen_NULL <- merge(Niclosamide_16S_0uM_summarised, Tamoxifen_16S_20uM_summarised, by = "Species", suffixes = c(".null", ".real"))



# Create lower and upper bounds considering mean ¬± sd
merged_data_20_Tamoxifen$lower_bound_pred <- merged_data_20_Tamoxifen$mean_rel_ab.pred - merged_data_20_Tamoxifen$sd_rel_ab.pred
merged_data_20_Tamoxifen$upper_bound_pred <- merged_data_20_Tamoxifen$mean_rel_ab.pred + merged_data_20_Tamoxifen$sd_rel_ab.pred
merged_data_20_Tamoxifen$lower_bound_real <- merged_data_20_Tamoxifen$mean_rel_ab.real - merged_data_20_Tamoxifen$sd_rel_ab.real
merged_data_20_Tamoxifen$upper_bound_real <- merged_data_20_Tamoxifen$mean_rel_ab.real + merged_data_20_Tamoxifen$sd_rel_ab.real

# Ensure lower and upper bounds are non-negative, adjusting as necessary
merged_data_20_Tamoxifen$lower_bound_pred[merged_data_20_Tamoxifen$lower_bound_pred <= 0] <- 1e-10
merged_data_20_Tamoxifen$lower_bound_real[merged_data_20_Tamoxifen$lower_bound_real <= 0] <- 1e-10
merged_data_20_Tamoxifen$upper_bound_pred[merged_data_20_Tamoxifen$upper_bound_pred <= 0] <- 1e-10
merged_data_20_Tamoxifen$upper_bound_real[merged_data_20_Tamoxifen$upper_bound_real <= 0] <- 1e-10

##and for NULL model:
# Create lower and upper bounds considering mean ¬± sd
merged_data_20_Tamoxifen_NULL$lower_bound_null <- merged_data_20_Tamoxifen_NULL$mean_rel_ab.null - merged_data_20_Tamoxifen_NULL$sd_rel_ab.null
merged_data_20_Tamoxifen_NULL$upper_bound_null <- merged_data_20_Tamoxifen_NULL$mean_rel_ab.null + merged_data_20_Tamoxifen_NULL$sd_rel_ab.null
merged_data_20_Tamoxifen_NULL$lower_bound_real <- merged_data_20_Tamoxifen_NULL$mean_rel_ab.real - merged_data_20_Tamoxifen_NULL$sd_rel_ab.real
merged_data_20_Tamoxifen_NULL$upper_bound_real <- merged_data_20_Tamoxifen_NULL$mean_rel_ab.real + merged_data_20_Tamoxifen_NULL$sd_rel_ab.real

# Ensure lower and upper bounds are non-negative, adjusting as necessary
merged_data_20_Tamoxifen_NULL$lower_bound_null[merged_data_20_Tamoxifen_NULL$lower_bound_null <= 0] <- 1e-10
merged_data_20_Tamoxifen_NULL$lower_bound_real[merged_data_20_Tamoxifen_NULL$lower_bound_real <= 0] <- 1e-10
merged_data_20_Tamoxifen_NULL$upper_bound_null[merged_data_20_Tamoxifen_NULL$upper_bound_null <= 0] <- 1e-10
merged_data_20_Tamoxifen_NULL$upper_bound_real[merged_data_20_Tamoxifen_NULL$upper_bound_real <= 0] <- 1e-10

# Filter to include only species with a mean relative abundance > 0.01 in the 'real' dataset
significant_species <- merged_data_20_Tamoxifen[merged_data_20_Tamoxifen$mean_rel_ab.real > 0.01, ]
survivors_20_Tamoxifen <- nrow(significant_species)
survivors_20_Tamoxifen

#should be the same as survivors defined above, since it is calculated from .real
significant_species_NULL <- merged_data_20_Tamoxifen_NULL[merged_data_20_Tamoxifen_NULL$mean_rel_ab.real > 0.01, ]
survivors_20_Tamoxifen_NULL <- nrow(significant_species_NULL)
survivors_20_Tamoxifen_NULL

# Adjusted order of magnitude check to include SD, only for significant species
significant_species$Predicted_magnitude_correct <- ifelse(
  (floor(log10(significant_species$lower_bound_pred)) <= floor(log10(significant_species$upper_bound_real)) &
     floor(log10(significant_species$upper_bound_pred)) >= floor(log10(significant_species$lower_bound_real))),
  1,
  0
)

#and for the Null model:
significant_species_NULL$Predicted_magnitude_correct <- ifelse(
  (floor(log10(significant_species_NULL$lower_bound_null)) <= floor(log10(significant_species_NULL$upper_bound_real)) &
     floor(log10(significant_species_NULL$upper_bound_null)) >= floor(log10(significant_species_NULL$lower_bound_real))),
  1,
  0
)

# Calculate the fraction of correctly predicted magnitudes for significant species
predicted_magnitude_correct_fraction_20_Tamoxifen <- sum(significant_species$Predicted_magnitude_correct) / nrow(significant_species)
predicted_magnitude_correct_fraction_20_Tamoxifen

predicted_magnitude_correct_fraction_20_Tamoxifen_NULL <- sum(significant_species_NULL$Predicted_magnitude_correct) / nrow(significant_species_NULL)
predicted_magnitude_correct_fraction_20_Tamoxifen_NULL

top_species_missing_20_Tamoxifen <- setdiff(top6_real_20_Tamoxifen_means, top6_predicted_20_Tamoxifen_means)
top_species_wrong_20_Tamoxifen <- setdiff(top6_predicted_20_Tamoxifen_means, top6_real_20_Tamoxifen_means)

top_species_missing_20_Tamoxifen <- if(length(top_species_missing_20_Tamoxifen) == 0) "None" else top_species_missing_20_Tamoxifen
top_species_wrong_20_Tamoxifen <- if(length(top_species_wrong_20_Tamoxifen) == 0) "None" else top_species_wrong_20_Tamoxifen

Prediction_quality_20_Tamoxifen <- data.frame(
  Top_six_correct = paste(top_six_correct_20_Tamoxifen, sep=""),
  Top_six_correct_NULL = paste(top_six_correct_20_Tamoxifen_NULL, sep=""),
  Top_six_correct_means = paste(top_six_correct_20_Tamoxifen_means, sep=""),
  Top_six_correct_means_NULL = paste(top_six_correct_20_Tamoxifen_means_NULL, sep=""),
  Predicted_magnitude_correct = paste(round(predicted_magnitude_correct_fraction_20_Tamoxifen * 100, 2), "%", sep=""),
  Predicted_magnitude_correct_NULL = paste(round(predicted_magnitude_correct_fraction_20_Tamoxifen_NULL * 100, 2), "%", sep=""),
  survivors_total = survivors_20_Tamoxifen,
  top_species_missing <- top_species_missing_20_Tamoxifen,
  top_species_wrong <- top_species_wrong_20_Tamoxifen, 
  predicted_mean_final_OD <- predicted_mean_final_od_20_Tamoxifen,
  real_mean_final_OD <- real_mean_final_od_20_Tamoxifen,
  sims_total = length(successful_sim_ids)
)

Prediction_quality_20_Tamoxifen




##Next, for 80 uM:
# Get top 6 species from plot_data_80_endpoint
# Adjust the plot_data_80_endpoint with confidence bounds
plot_data_80_Tamoxifen_endpoint <- plot_data_80_Tamoxifen_endpoint %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)

# Adjust the Tamoxifen_16S_80uM_summarised with confidence bounds
Tamoxifen_16S_80uM_summarised <- Tamoxifen_16S_80uM_summarised %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)

#NULL model:
Null_model_summarised <- Niclosamide_16S_0uM_summarised %>%
  dplyr::mutate(lower_bound = mean_rel_ab - sd_rel_ab)


# Get top 6 species based on the lower bound from plot_data_80_endpoint
top6_predicted_80_Tamoxifen <- plot_data_80_Tamoxifen_endpoint %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

# Get top 6 species based on the lower bound from Tamoxifen_16S_80uM_summarised
top6_real_80_Tamoxifen <- Tamoxifen_16S_80uM_summarised %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

top6_NULL <- Null_model_summarised %>%
  arrange(desc(lower_bound)) %>%
  slice(1:6) %>%
  pull(Species)

# Calculate the overlap of top 6 species
top_six_correct_80_Tamoxifen <- length(intersect(top6_predicted_80_Tamoxifen, top6_real_80_Tamoxifen))
#top_six_correct_80_Tamoxifen

top_six_correct_80_Tamoxifen_NULL <- length(intersect(top6_NULL, top6_real_80_Tamoxifen))
#top_six_correct_80_Tamoxifen_NULL

#top6_predicted_80_Tamoxifen
#top6_real_80_Tamoxifen




#Now by means:
top6_predicted_80_Tamoxifen_means <- plot_data_80_Tamoxifen_endpoint %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)

# Get top 6 species based on the lower bound from Tamoxifen_16S_80uM_summarised
top6_real_80_Tamoxifen_means <- Tamoxifen_16S_80uM_summarised %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)

top6_NULL_means <- Null_model_summarised %>%
  arrange(desc(mean_rel_ab)) %>%
  slice(1:6) %>%
  pull(Species)



top_six_correct_80_Tamoxifen_means <- length(intersect(top6_predicted_80_Tamoxifen_means, top6_real_80_Tamoxifen_means))
#top_six_correct_80_Tamoxifen_means

top_six_correct_80_Tamoxifen_means_NULL <- length(intersect(top6_NULL_means, top6_real_80_Tamoxifen_means))
#top_six_correct_80_Tamoxifen_means_NULL

#top6_predicted_80_Tamoxifen_means
#top6_real_80_Tamoxifen_means




# Merge dataframes by Species
merged_data_80_Tamoxifen <- merge(plot_data_80_Tamoxifen_endpoint, Tamoxifen_16S_80uM_summarised, by = "Species", suffixes = c(".pred", ".real"))
merged_data_80_Tamoxifen_NULL <- merge(Niclosamide_16S_0uM_summarised, Tamoxifen_16S_80uM_summarised, by = "Species", suffixes = c(".null", ".real"))



# Create lower and upper bounds considering mean ¬± sd
merged_data_80_Tamoxifen$lower_bound_pred <- merged_data_80_Tamoxifen$mean_rel_ab.pred - merged_data_80_Tamoxifen$sd_rel_ab.pred
merged_data_80_Tamoxifen$upper_bound_pred <- merged_data_80_Tamoxifen$mean_rel_ab.pred + merged_data_80_Tamoxifen$sd_rel_ab.pred
merged_data_80_Tamoxifen$lower_bound_real <- merged_data_80_Tamoxifen$mean_rel_ab.real - merged_data_80_Tamoxifen$sd_rel_ab.real
merged_data_80_Tamoxifen$upper_bound_real <- merged_data_80_Tamoxifen$mean_rel_ab.real + merged_data_80_Tamoxifen$sd_rel_ab.real

# Ensure lower and upper bounds are non-negative, adjusting as necessary
merged_data_80_Tamoxifen$lower_bound_pred[merged_data_80_Tamoxifen$lower_bound_pred <= 0] <- 1e-10
merged_data_80_Tamoxifen$lower_bound_real[merged_data_80_Tamoxifen$lower_bound_real <= 0] <- 1e-10
merged_data_80_Tamoxifen$upper_bound_pred[merged_data_80_Tamoxifen$upper_bound_pred <= 0] <- 1e-10
merged_data_80_Tamoxifen$upper_bound_real[merged_data_80_Tamoxifen$upper_bound_real <= 0] <- 1e-10

##and for NULL model:
# Create lower and upper bounds considering mean ¬± sd
merged_data_80_Tamoxifen_NULL$lower_bound_null <- merged_data_80_Tamoxifen_NULL$mean_rel_ab.null - merged_data_80_Tamoxifen_NULL$sd_rel_ab.null
merged_data_80_Tamoxifen_NULL$upper_bound_null <- merged_data_80_Tamoxifen_NULL$mean_rel_ab.null + merged_data_80_Tamoxifen_NULL$sd_rel_ab.null
merged_data_80_Tamoxifen_NULL$lower_bound_real <- merged_data_80_Tamoxifen_NULL$mean_rel_ab.real - merged_data_80_Tamoxifen_NULL$sd_rel_ab.real
merged_data_80_Tamoxifen_NULL$upper_bound_real <- merged_data_80_Tamoxifen_NULL$mean_rel_ab.real + merged_data_80_Tamoxifen_NULL$sd_rel_ab.real

# Ensure lower and upper bounds are non-negative, adjusting as necessary
merged_data_80_Tamoxifen_NULL$lower_bound_null[merged_data_80_Tamoxifen_NULL$lower_bound_null <= 0] <- 1e-10
merged_data_80_Tamoxifen_NULL$lower_bound_real[merged_data_80_Tamoxifen_NULL$lower_bound_real <= 0] <- 1e-10
merged_data_80_Tamoxifen_NULL$upper_bound_null[merged_data_80_Tamoxifen_NULL$upper_bound_null <= 0] <- 1e-10
merged_data_80_Tamoxifen_NULL$upper_bound_real[merged_data_80_Tamoxifen_NULL$upper_bound_real <= 0] <- 1e-10

# Filter to include only species with a mean relative abundance > 0.01 in the 'real' dataset
significant_species <- merged_data_80_Tamoxifen[merged_data_80_Tamoxifen$mean_rel_ab.real > 0.01, ]
survivors_80_Tamoxifen <- nrow(significant_species)
survivors_80_Tamoxifen

#should be the same as survivors defined above, since it is calculated from .real
significant_species_NULL <- merged_data_80_Tamoxifen_NULL[merged_data_80_Tamoxifen_NULL$mean_rel_ab.real > 0.01, ]
survivors_80_Tamoxifen_NULL <- nrow(significant_species_NULL)
survivors_80_Tamoxifen_NULL

# Adjusted order of magnitude check to include SD, only for significant species
significant_species$Predicted_magnitude_correct <- ifelse(
  (floor(log10(significant_species$lower_bound_pred)) <= floor(log10(significant_species$upper_bound_real)) &
     floor(log10(significant_species$upper_bound_pred)) >= floor(log10(significant_species$lower_bound_real))),
  1,
  0
)

#and for the Null model:
significant_species_NULL$Predicted_magnitude_correct <- ifelse(
  (floor(log10(significant_species_NULL$lower_bound_null)) <= floor(log10(significant_species_NULL$upper_bound_real)) &
     floor(log10(significant_species_NULL$upper_bound_null)) >= floor(log10(significant_species_NULL$lower_bound_real))),
  1,
  0
)

# Calculate the fraction of correctly predicted magnitudes for significant species
predicted_magnitude_correct_fraction_80_Tamoxifen <- sum(significant_species$Predicted_magnitude_correct) / nrow(significant_species)
predicted_magnitude_correct_fraction_80_Tamoxifen

predicted_magnitude_correct_fraction_80_Tamoxifen_NULL <- sum(significant_species_NULL$Predicted_magnitude_correct) / nrow(significant_species_NULL)
predicted_magnitude_correct_fraction_80_Tamoxifen_NULL


top_species_missing_80_Tamoxifen <- setdiff(top6_real_80_Tamoxifen_means, top6_predicted_80_Tamoxifen_means)
top_species_wrong_80_Tamoxifen <- setdiff(top6_predicted_80_Tamoxifen_means, top6_real_80_Tamoxifen_means)

top_species_missing_80_Tamoxifen <- if(length(top_species_missing_80_Tamoxifen) == 0) "None" else top_species_missing_80_Tamoxifen
top_species_wrong_80_Tamoxifen <- if(length(top_species_wrong_80_Tamoxifen) == 0) "None" else top_species_wrong_80_Tamoxifen

Prediction_quality_80_Tamoxifen <- data.frame(
  Top_six_correct = paste(top_six_correct_80_Tamoxifen, sep=""),
  Top_six_correct_NULL = paste(top_six_correct_80_Tamoxifen_NULL, sep=""),
  Top_six_correct_means = paste(top_six_correct_80_Tamoxifen_means, sep=""),
  Top_six_correct_means_NULL = paste(top_six_correct_80_Tamoxifen_means_NULL, sep=""),
  Predicted_magnitude_correct = paste(round(predicted_magnitude_correct_fraction_80_Tamoxifen * 100, 2), "%", sep=""),
  Predicted_magnitude_correct_NULL = paste(round(predicted_magnitude_correct_fraction_80_Tamoxifen_NULL * 100, 2), "%", sep=""),
  survivors_total = survivors_80_Tamoxifen,
  top_species_missing <- top_species_missing_80_Tamoxifen,
  top_species_wrong <- top_species_wrong_80_Tamoxifen, 
  predicted_mean_final_OD <- predicted_mean_final_od_80_Tamoxifen,
  real_mean_final_OD <- real_mean_final_od_80_Tamoxifen,
  sims_total = length(successful_sim_ids)
)

Prediction_quality_80_Tamoxifen









#Drug metadata
##List of unique drugs
drugs <- c("Niclosamide", "Mecillinam", "Aripiprazole", "Simvastatin", "Acarbose", 
           "Aprepitant", "Mefloquine", "control", "Nifurtimox", "Sertindole", "Ebselen", 
           "Loratadine", "Tamoxifen", "Methotrexate", "Clomiphene", "beta-estradiol 17-valerate", 
           "Diacerein", "Loxapine", "Entacapone", "Chlorpromazine", "Ciprofloxacin", 
           "Felodipine", "Amlodipine", "Omeprazole", "Azithromycin", "Olanzapine", 
           "Dienestrol", "Doxycycline", "Lansoprazole", "Ketoconazole", "Oxolinic acid")

##Corresponding function or class of each drug
functions <- c("Anthelmintic", "Antibiotic", "Antipsychotic", "Cholesterol-lowering", "Antidiabetic", 
               "Anti-nausea", "Antimalarial", "Control", "Antiprotozoal", "Antipsychotic", "Antioxidant", 
               "Antihistamine", "Hormone Treatment", "Chemotherapy", "Hormone Treatment", "Hormone Treatment", 
               "Anti-inflammatory", "Antipsychotic", "Parkinson's Disease Management", "Antipsychotic", 
               "Antibiotic", "Calcium Channel Blocker", "Calcium Channel Blocker", "Proton Pump Inhibitor", 
               "Antibiotic", "Antipsychotic", "Hormone Treatment", "Antibiotic", "Proton Pump Inhibitor", 
               "Antifungal", "Antibiotic")


drug_info <- data.frame(drug = drugs, Function = functions, stringsAsFactors = FALSE)

drug_info1 <- subset(drug_info, Function != "Control")


##Attach info (Bray-Curtis dissimilarity from control, Number of survivors, mean AUC effect on monocultures)
AUCs_and_BC
drug_info1

AUCs_and_BC_joined <- merge(AUCs_and_BC, drug_info1, by = "drug", all.x = TRUE)


#Also attach: degradation info
drug_dynamics_props_only <- drug_dynamics1[, c(9,8,2,4,6)]


AUCs_and_BC_joined1 <- merge(AUCs_and_BC_joined, drug_dynamics_props_only, by = "drug", all.x = TRUE)

AUCs_and_BC_joined1$Concentration_left_after_24h <- AUCs_and_BC_joined1$conc * AUCs_and_BC_joined1$Prop_left_24h_community 


#Linear regression for predicted 'high impact' drugs (based on effect observed in monoculture across species)
fit_BC_vs_Prop_left <- lm(Prop_left_24h_community ~ dissimilarity, data = subset(AUCs_and_BC_joined1, mean_abs_change_AUC > 0))

# Calculate R^2 and extract p-value
summary_fit_BC_vs_Prop_left <- summary(fit_BC_vs_Prop_left)
r_squared_BC_vs_Prop_left <- summary_fit_BC_vs_Prop_left$r.squared
p_value_BC_vs_Prop_left <- summary_fit_BC_vs_Prop_left$coefficients[2, 4]  

r_squared_BC_vs_Prop_left
p_value_BC_vs_Prop_left

##In the following figure we see the following things:
##If a drug is strongly degraded by the community, it generally has less impact on the community composition (lower BC)
# The more of a drug is left, the more likely it is to lead to changes in community composition
  # Especially if the drug also tended to have a large impact on bugs in monoculture:
# ggplot(AUCs_and_BC_joined1, aes(x = Prop_left_24h_community, y = dissimilarity, alpha = mean_abs_change_AUC, size = conc, color = drug)) +
ggplot(AUCs_and_BC_joined1, aes(x = Prop_left_24h_community, y = dissimilarity, alpha = mean_abs_change_AUC)) +
  geom_smooth(data = subset(AUCs_and_BC_joined1, mean_abs_change_AUC > 0.6), 
              aes(x = Prop_left_24h_community, y = dissimilarity), 
              method = "lm", 
              se = FALSE,   
              linetype = "dashed",  
              color = "red") +  
  geom_smooth(data = AUCs_and_BC_joined1, 
              aes(x = Prop_left_24h_community, y = dissimilarity), 
              method = "lm", 
              se = FALSE,   
              linetype = "dashed",  
              color = "darkred") +  
  geom_point(size = 3.5) +  
  labs(
    title = "Dissimilarity vs. Proportion Left after 24h",
    x = "Proportion Drug Left after 24h (Community)",
    y = "Bray-Curtis Dissimilarity from Control Community",
    #size = "Concentration tested",
    alpha = "Mean Impact Treatment 
in Monoculture"
  ) +
  scale_color_manual(values = drug_colours) +  
  theme_minimal() +  
  theme(legend.position = "right")  





ggplot(subset(AUCs_and_BC_joined1, conc < 100), aes(x = Concentration_left_after_24h, y = dissimilarity, size = mean_abs_change_AUC, color = drug)) +
  geom_point(alpha = 0.7) +  
  labs(
    title = "Dissimilarity vs. Concentration Left after 24h",
    x = "Concentration Drug Left after 24h (Community)",
    y = "Bray-Curtis Dissimilarity from Control Community",
    size = "Mean Impact Drug Treatment 
in Monoculture",
  ) +
  #scale_x_log10() +
  scale_color_manual(values = drug_colours) +  
  theme_minimal() +  
  theme(legend.position = "right") 


#concentration is not necessarily relevant as we are comparing a drug*concentration's effect on monoculture (size) versus community (y-axis)
#and how that relates to how much of said treatment is left (regardless of concentration; some drugs have a high effect at low concentration. If a lower proportion of this drug is left, we expect it will have a lower effect on community (y-axis))
ggplot(AUCs_and_BC_joined1, aes(x = Prop_left_24h_community, y = dissimilarity, alpha = mean_abs_change_AUC, color = drug)) +
  geom_point(size = 3.5) +  
  labs(
    title = "Dissimilarity vs. Proportion Left after 24h",
    x = "Proportion Drug Left after 24h (Community)",
    y = "Bray-Curtis Dissimilarity from Control Community",
    #size = "Concentration tested",
    alpha = "Mean Impact Drug Treatment 
in Monoculture",
  ) +
  scale_color_manual(values = drug_colours) +  
  theme_minimal() +  
  theme(legend.position = "right")  

##problem is that we used size before to indicate concentration. 
# and now there are many different colours to distill transparancy properly, whereas it might only be worth it to annotate the interesting cases...




##Next, we aim to investigate the link between variability in drug degradation, and variability in Bray-Curtis dissimilarity from control communities
str(drug_dynamics)
drug_dynamics_SD_only<- drug_dynamics[, c(1,6,7,8)]
drug_dynamics_SD_only$drug <- drug_dynamics_SD_only$Drug

#First, calculate BC dissimilarity per unique combination of drug, concentration, biol_repl and tech_repl:
#library(dplyr)
#library(vegan)

#Prepare the control community data
control_community_means <- Community_compositions_focus_drugs %>%
  dplyr::filter(drug == "control") %>%
  dplyr::group_by(species) %>%
  dplyr::summarise(rel_abundance = mean(rel_abundance), .groups = 'drop')

#Prepare the treatment data
treatment_communities <- Community_compositions_focus_drugs %>%
  dplyr::filter(drug != "control")

#Calc. Bray-Curtis dissimilarity for each unique treatment (drug * concentration * biol_repl * tech_repl * run) combination
Bray_Curtis_per_replicate <- treatment_communities %>%
  dplyr::group_by(drug, concentration, tech_repl, biol_repl, run) %>%
  dplyr::do({
    # Merge current group data with control data
    merged_data <- merge(., control_community_means, by = "species", suffixes = c("_treat", "_control"))
    
    # Calculate Bray-Curtis dissimilarity using the vegan package
    bc_dissimilarity <- vegdist(rbind(merged_data$rel_abundance_control, merged_data$rel_abundance_treat), method = "bray")[1]
    
    # Return the result as a data frame
    data.frame(Bray_Curtis = bc_dissimilarity)
  }) %>%
  ungroup()  


#View(Bray_Curtis_per_replicate)

#Then, extract the standard deviation of BC dissimilarity per drug*concentration combination:
SDs_BC_dissimilarities <- Bray_Curtis_per_replicate %>%
  dplyr::group_by(drug, concentration) %>%
  dplyr::summarise(SD_BC = sd(Bray_Curtis), .groups = 'drop')

AUCs_and_BC_joined1a <- AUCs_and_BC_joined1[, c(1:3, 6, 10)]
AUCs_and_BC_joined2 <- merge(drug_dynamics_SD_only, SDs_BC_dissimilarities, by = "drug", all.x = TRUE)
AUCs_and_BC_joined3 <- merge(AUCs_and_BC_joined2, AUCs_and_BC_joined1a, by = "drug", all.x = TRUE)



##Next, we only check for concentrations that were used to test the degradation in the community
#since we only have one metric per drug (i.e., community metabolomics were taken for one concentration)
#hence the variability measured in community-level degradation may be specific to this tested concentration
#for modelling, we extrapolate this degree of degradation to other initial/tested concentrations of the same drug, however, that assumes that the degree of degradation is the same.
# this obviously is a large assumption (since degradation itself may be dependent on the specific underlying community, which itself may be dependent on the initial load of the drug)
# hence, for a most reliable relationship between drug degradation variability and community composition variability, we here only look at the common drug concentrations:
AUCs_and_BC_joined1a$concentration <- AUCs_and_BC_joined1a$conc

drug_dynamics_SD_only$concentration <- drug_dynamics_SD_only$Concentration_tested


##remove "concentration" if interested in all drug * concentration combinations, not just the ones that align with condition for whcih drug metabolomics was tested
AUCs_and_BC_joined2 <- drug_dynamics_SD_only %>%
  dplyr::left_join(SDs_BC_dissimilarities, by = c("drug", "concentration"))

#join but avoid double copy column "SD_drug_community":
AUCs_and_BC_joined3 <- AUCs_and_BC_joined2[, c(2:7)] %>%
   dplyr::left_join(AUCs_and_BC_joined1a, by = c("drug", "concentration"))

#create a variable in which we account for the measurement error that might drive the endpoint SD of drug concentration
AUCs_and_BC_joined3$diff_SD_drug <- ifelse((AUCs_and_BC_joined3$SD_drug_community - AUCs_and_BC_joined3$SD_drug_community_start)>0, (AUCs_and_BC_joined3$SD_drug_community - AUCs_and_BC_joined3$SD_drug_community_start), AUCs_and_BC_joined3$SD_drug_community)

cor.test(AUCs_and_BC_joined3$SD_drug_community, AUCs_and_BC_joined3$SD_BC, method = "spearman")
cor.test(AUCs_and_BC_joined3$diff_SD_drug, AUCs_and_BC_joined3$SD_BC, method = "spearman")

ggplot(AUCs_and_BC_joined3, aes(x = SD_drug_community, y = SD_BC, size = concentration, alpha = mean_abs_change_AUC)) +
  geom_point() +  
  labs(
    title = "",
    x = "SD Drug Degradation by Community",
    y = "SD Bray-Curtis Dissimilarity from Control Community",
    alpha = "Mean Impact Treatment 
in Monoculture",
    size = "Concentration 
tested"
  ) +
  theme_minimal() +  
  theme(legend.position = "right")  


#Alternatively, we can explore how the change of each species' relative abundance, relative to its mean in control, can be averaged and relates to the variability in drug dynamics/variability
# Distance_per_replicate <- treatment_communities %>%
#   dplyr::group_by(drug, concentration, tech_repl, biol_repl, run) %>%
#   dplyr::do({
#     # Merge current group data with control data
#     merged_data <- merge(., control_community_means, by = "species", suffixes = c("_treat", "_control"))
#     
#     # Calculate the mean absolute difference in relative abundance
#     mean_abs_diff <- mean(abs(merged_data$rel_abundance_treat - merged_data$rel_abundance_control))
#     
#     # Return the result as a data frame
#     data.frame(Mean_Abs_Diff = mean_abs_diff)
#   }) %>%
#   ungroup() 
# 
# Distance_per_replicate
# 
# SDs_Distance <- Distance_per_replicate %>%
#   dplyr::group_by(drug, concentration) %>%
#   dplyr::summarise(SD_Distance = sd(Mean_Abs_Diff), .groups = 'drop')
# 
# 
# AUCs_and_BC_joined1a <- AUCs_and_BC_joined1[, c(1:3)]
# AUCs_and_BC_joined2b <- merge(drug_dynamics_SD_only, SDs_Distance, by = "drug", all.x = TRUE)
# AUCs_and_BC_joined3b <- merge(AUCs_and_BC_joined2b, AUCs_and_BC_joined1a, by = "drug", all.x = TRUE)
# 
# cor.test(AUCs_and_BC_joined3b$SD_drug_community, AUCs_and_BC_joined3b$SD_Distance, method = "kendall")


# ggplot(AUCs_and_BC_joined3b, aes(x = SD_drug_community, y = SD_Distance, alpha = mean_abs_change_AUC)) +
#   geom_point(size = 3) +  
#   labs(
#     title = "",
#     x = "SD Drug Degradation by Community",
#     y = "SD Mean absolute distance",
#     alpha = "Mean Absolute Change in AUC"
#   ) +
#   theme_minimal() +  
#   theme(legend.position = "right")  

##Very similar, perhaps need a different metric: SD in alpha diversity?




Shannon_Diversity_per_replicate <- treatment_communities %>%
  dplyr::group_by(drug, concentration, tech_repl, biol_repl, run) %>%
  dplyr::do({
    #merge current group data with control data
    merged_data <- merge(., control_community_means, by = "species", suffixes = c("_treat", "_control"))
    
    #Calc Shannon diversity for both treatment and control
    shannon_treat <- vegan::diversity(merged_data[, "rel_abundance_treat", drop = FALSE], index = "shannon")
    shannon_control <- vegan::diversity(merged_data[, "rel_abundance_control", drop = FALSE], index = "shannon")
    
    #Calc the difference in Shannon diversity
    shannon_diff <- abs(shannon_treat - shannon_control)
    
    #Return the result as a df
    data.frame(Shannon_Diff = shannon_diff)
  }) %>%
  dplyr::ungroup()  


View(Shannon_Diversity_per_replicate)

SDs_Shannon_diff <- Shannon_Diversity_per_replicate %>%
   dplyr::group_by(drug, concentration) %>%
   dplyr::summarise(SD_Shannon_diff = sd(Shannon_Diff), .groups = 'drop')



AUCs_and_BC_joined1a <- AUCs_and_BC_joined1[, c(1:3)]
AUCs_and_BC_joined1a$concentration <- AUCs_and_BC_joined1a$conc

drug_dynamics_SD_only$concentration <- drug_dynamics_SD_only$Concentration_tested


#take out "concentration" in left_join if okay with having datapoints for communities tested at concentrations 
#other than the concentrations at which the community metabolomics were measured:
AUCs_and_BC_joined2c <- drug_dynamics_SD_only %>%
  dplyr::left_join(SDs_Shannon_diff, by = c("drug", "concentration"))

AUCs_and_BC_joined3c <- AUCs_and_BC_joined2c %>%
  dplyr::left_join(AUCs_and_BC_joined1a, by = c("drug", "concentration"))

#AUCs_and_BC_joined3d <- AUCs_and_BC_joined3c %>%
#  dplyr::filter(Concentration_tested == conc)


##Positive and significant correlation if using all concentrations per drug (i.e., same value for SD drug degradation per drug since only taken from one concentration):
##Positive and significant correlation if using pearson for only a single concentration of each drug; namely the one tested
#spearman is near-significant
cor.test(AUCs_and_BC_joined3c$SD_drug_community, AUCs_and_BC_joined3c$SD_Shannon_diff, method = "pearson")
cor.test(AUCs_and_BC_joined3c$SD_drug_community, AUCs_and_BC_joined3c$SD_Shannon_diff, method = "spearman")
#accounting for degree of SD endpoint drug concentration that can be assigned to measurement error
AUCs_and_BC_joined3c$diff_SD_drug <- ifelse((AUCs_and_BC_joined3c$SD_drug_community - AUCs_and_BC_joined3c$SD_drug_community_start)>0, (AUCs_and_BC_joined3c$SD_drug_community - AUCs_and_BC_joined3c$SD_drug_community_start), AUCs_and_BC_joined3c$SD_drug_community)

cor.test(AUCs_and_BC_joined3c$diff_SD_drug, AUCs_and_BC_joined3c$SD_Shannon_diff, method = "spearman")


# ggplot(AUCs_and_BC_joined3c, aes(x = SD_drug_community, y = SD_Shannon_diff, alpha = mean_abs_change_AUC)) +
#   geom_point(size = 3) +
#   labs(
#     title = "",
#     x = "SD Drug Degradation by Community",
#     y = "SD Shannon Diversity Difference from Control",
#     alpha = "Mean Absolute Change in AUC"
#   ) +
#   theme_minimal() +
#   theme(legend.position = "right")


# Calculate R^2 and extract p-value
fit_SD_Diff_Shannon_vs_SD_degradation <- lm(SD_drug_community ~ SD_Shannon_diff, data = AUCs_and_BC_joined3c)
#fit_SD_Diff_Shannon_vs_SD_degradation1 <- lm(SD_drug_community ~ SD_Shannon_diff, data = subset(AUCs_and_BC_joined3c, drug != "Simvastatin"))
#fit_SD_Diff_Shannon_vs_SD_degradation <- lm(SD_drug_community ~ SD_Shannon_diff, data = subset(AUCs_and_BC_joined3c, concentration < 200))



summary_fit_SD_Diff_Shannon_vs_SD_degradation <- summary(fit_SD_Diff_Shannon_vs_SD_degradation)
r_squared_SD_Diff_Shannon_vs_SD_degradation <- summary_fit_SD_Diff_Shannon_vs_SD_degradation$r.squared
p_value_SD_Diff_Shannon_vs_SD_degradation <- summary_fit_SD_Diff_Shannon_vs_SD_degradation$coefficients[2, 4]  

r_squared_SD_Diff_Shannon_vs_SD_degradation
p_value_SD_Diff_Shannon_vs_SD_degradation



ggplot(AUCs_and_BC_joined3c, aes(x = SD_drug_community, y = SD_Shannon_diff, size = concentration, color = drug)) +
  geom_smooth(method = "lm", color = "grey", linetype = "dashed", se = FALSE) + 
  geom_point(alpha = 0.8) +
  labs(
    title = "",
    x = "SD Drug Degradation by Community",
    y = "SD Shannon Diversity Difference from Control",
    size = "Concentration tested"
  ) +
  theme_minimal() +
  scale_color_manual(values = drug_colours) +  
  theme(legend.position = "right")


#scaled proportions of size
ggplot(AUCs_and_BC_joined3c, aes(x = SD_drug_community, y = SD_Shannon_diff, size = concentration, color = drug)) +
  geom_smooth(method = "lm", color = "grey", linetype = "dashed", se = FALSE) + 
  geom_point(alpha = 0.8) + 
  scale_size_continuous(range = c(2, 6), breaks = unique(AUCs_and_BC_joined3c$concentration)) +  
  labs(
    title = " ",
    x = "SD Drug Degradation by Community",
    y = "SD Shannon Diversity Difference from Control",
    size = "Concentration tested" 
  ) +
  theme_minimal() +  
  scale_color_manual(values = drug_colours) +  
  theme(legend.position = "right")  





##Attaching model performance metrics to the dataframe
#Current dataframe contains, per drug and tested concentration:
  #mean and sd mean abs. change in AUCs (i.e., Mean Impact on Monoculture, MIM)
  #bray curtis dissimilairty (from mean relative abundances) relative to the control community
  #drug function
  #proportion drug left after 24h (projected) from community activity
  #proportion drug left after 24h (projected) from spontaneous/background activity (in empty MGAM)
  #estimated final concentration left based on initial concentration * projected proportion left after 24 hours
  

AUCs_and_BC_joined1


#Structured list of model performance metrics
#metrics_list_dynamic <- metrics_list

metrics_list <- list()

#Ensure all the following combinations of drugs and concentrations were simulated (see line ~2100 onwards)

metrics_list$Acarbose <- list(
  "5" = list(
    top_six_correct = top_six_correct_5_Acarbose,
    top_six_correct_means = top_six_correct_5_Acarbose_means,
    top_six_correct_NULL = top_six_correct_5_Acarbose_NULL,
    top_six_correct_means_NULL = top_six_correct_5_Acarbose_means_NULL,
    survivors = survivors_5_Acarbose,
    predicted_magnitude_correct_fraction = predicted_magnitude_correct_fraction_5_Acarbose,
    predicted_magnitude_correct_fraction_NULL = predicted_magnitude_correct_fraction_5_Acarbose_NULL,
    predicted_mean_final_od = predicted_mean_final_od_5_Acarbose,
    predicted_sd_final_od = predicted_sd_final_od_5_Acarbose,
    real_mean_final_od = real_mean_final_od_5_Acarbose,
    real_sd_final_od = real_sd_final_od_5_Acarbose
    
  ),
  "20" = list(
    top_six_correct = top_six_correct_20_Acarbose,
    top_six_correct_means = top_six_correct_20_Acarbose_means,
    top_six_correct_NULL = top_six_correct_20_Acarbose_NULL,
    top_six_correct_means_NULL = top_six_correct_20_Acarbose_means_NULL,
    survivors = survivors_20_Acarbose,
    predicted_magnitude_correct_fraction = predicted_magnitude_correct_fraction_20_Acarbose,
    predicted_magnitude_correct_fraction_NULL = predicted_magnitude_correct_fraction_20_Acarbose_NULL,
    predicted_mean_final_od = predicted_mean_final_od_20_Acarbose,
    predicted_sd_final_od = predicted_sd_final_od_20_Acarbose,
    real_mean_final_od = real_mean_final_od_20_Acarbose,
    real_sd_final_od = real_sd_final_od_20_Acarbose
  ),
  "80" = list(
    top_six_correct = top_six_correct_80_Acarbose,
    top_six_correct_means = top_six_correct_80_Acarbose_means,
    top_six_correct_NULL = top_six_correct_80_Acarbose_NULL,
    top_six_correct_means_NULL = top_six_correct_80_Acarbose_means_NULL,
    survivors = survivors_80_Acarbose,
    predicted_magnitude_correct_fraction = predicted_magnitude_correct_fraction_80_Acarbose,
    predicted_magnitude_correct_fraction_NULL = predicted_magnitude_correct_fraction_80_Acarbose_NULL,
    predicted_mean_final_od = predicted_mean_final_od_80_Acarbose,
    predicted_sd_final_od = predicted_sd_final_od_80_Acarbose,
    real_mean_final_od = real_mean_final_od_80_Acarbose,
    real_sd_final_od = real_sd_final_od_80_Acarbose
  )
)



metrics_list$Amlodipine <- list(
  "20" = list(
    top_six_correct = top_six_correct_20_Amlodipine,
    top_six_correct_means = top_six_correct_20_Amlodipine_means,
    top_six_correct_NULL = top_six_correct_20_Amlodipine_NULL,
    top_six_correct_means_NULL = top_six_correct_20_Amlodipine_means_NULL,
    survivors = survivors_20_Amlodipine,
    predicted_magnitude_correct_fraction = predicted_magnitude_correct_fraction_20_Amlodipine,
    predicted_magnitude_correct_fraction_NULL = predicted_magnitude_correct_fraction_20_Amlodipine_NULL,
    predicted_mean_final_od = predicted_mean_final_od_20_Amlodipine,
    predicted_sd_final_od = predicted_sd_final_od_20_Amlodipine,
    real_mean_final_od = real_mean_final_od_20_Amlodipine,
    real_sd_final_od = real_sd_final_od_20_Amlodipine
  ),
  "80" = list(
    top_six_correct = top_six_correct_80_Amlodipine,
    top_six_correct_means = top_six_correct_80_Amlodipine_means,
    top_six_correct_NULL = top_six_correct_80_Amlodipine_NULL,
    top_six_correct_means_NULL = top_six_correct_80_Amlodipine_means_NULL,
    survivors = survivors_80_Amlodipine,
    predicted_magnitude_correct_fraction = predicted_magnitude_correct_fraction_80_Amlodipine,
    predicted_magnitude_correct_fraction_NULL = predicted_magnitude_correct_fraction_80_Amlodipine_NULL,
    predicted_mean_final_od = predicted_mean_final_od_80_Amlodipine,
    predicted_sd_final_od = predicted_sd_final_od_80_Amlodipine,
    real_mean_final_od = real_mean_final_od_80_Amlodipine,
    real_sd_final_od = real_sd_final_od_80_Amlodipine
  ),
  "160" = list(
    top_six_correct = top_six_correct_160_Amlodipine,
    top_six_correct_means = top_six_correct_160_Amlodipine_means,
    top_six_correct_NULL = top_six_correct_160_Amlodipine_NULL,
    top_six_correct_means_NULL = top_six_correct_160_Amlodipine_means_NULL,
    survivors = survivors_160_Amlodipine,
    predicted_magnitude_correct_fraction = predicted_magnitude_correct_fraction_160_Amlodipine,
    predicted_magnitude_correct_fraction_NULL = predicted_magnitude_correct_fraction_160_Amlodipine_NULL,
    predicted_mean_final_od = predicted_mean_final_od_160_Amlodipine,
    predicted_sd_final_od = predicted_sd_final_od_160_Amlodipine,
    real_mean_final_od = real_mean_final_od_160_Amlodipine,
    real_sd_final_od = real_sd_final_od_160_Amlodipine
  )
)


# Metrics for Aprepitant
metrics_list$Aprepitant <- list(
  "5" = list(
    top_six_correct = top_six_correct_5_Aprepitant,
    top_six_correct_means = top_six_correct_5_Aprepitant_means,
    top_six_correct_NULL = top_six_correct_5_Aprepitant_NULL,
    top_six_correct_means_NULL = top_six_correct_5_Aprepitant_means_NULL,
    survivors = survivors_5_Aprepitant,
    predicted_magnitude_correct_fraction = predicted_magnitude_correct_fraction_5_Aprepitant,
    predicted_magnitude_correct_fraction_NULL = predicted_magnitude_correct_fraction_5_Aprepitant_NULL,
    predicted_mean_final_od = predicted_mean_final_od_5_Aprepitant,
    predicted_sd_final_od = predicted_sd_final_od_5_Aprepitant,
    real_mean_final_od = real_mean_final_od_5_Aprepitant,
    real_sd_final_od = real_sd_final_od_5_Aprepitant
  ),
  "20" = list(
    top_six_correct = top_six_correct_20_Aprepitant,
    top_six_correct_means = top_six_correct_20_Aprepitant_means,
    top_six_correct_NULL = top_six_correct_20_Aprepitant_NULL,
    top_six_correct_means_NULL = top_six_correct_20_Aprepitant_means_NULL,
    survivors = survivors_20_Aprepitant,
    predicted_magnitude_correct_fraction = predicted_magnitude_correct_fraction_20_Aprepitant,
    predicted_magnitude_correct_fraction_NULL = predicted_magnitude_correct_fraction_20_Aprepitant_NULL,
    predicted_mean_final_od = predicted_mean_final_od_20_Aprepitant,
    predicted_sd_final_od = predicted_sd_final_od_20_Aprepitant,
    real_mean_final_od = real_mean_final_od_20_Aprepitant,
    real_sd_final_od = real_sd_final_od_20_Aprepitant
  ),
  "30" = list(
    top_six_correct = top_six_correct_30_Aprepitant,
    top_six_correct_means = top_six_correct_30_Aprepitant_means,
    top_six_correct_NULL = top_six_correct_30_Aprepitant_NULL,
    top_six_correct_means_NULL = top_six_correct_30_Aprepitant_means_NULL,
    survivors = survivors_30_Aprepitant,
    predicted_magnitude_correct_fraction = predicted_magnitude_correct_fraction_30_Aprepitant,
    predicted_magnitude_correct_fraction_NULL = predicted_magnitude_correct_fraction_30_Aprepitant_NULL,
    predicted_mean_final_od = predicted_mean_final_od_30_Aprepitant,
    predicted_sd_final_od = predicted_sd_final_od_30_Aprepitant,
    real_mean_final_od = real_mean_final_od_30_Aprepitant,
    real_sd_final_od = real_sd_final_od_30_Aprepitant
  )
)

# Metrics for Aripiprazole
metrics_list$Aripiprazole <- list(
  "5" = list(
    top_six_correct = top_six_correct_5_Aripiprazole,
    top_six_correct_means = top_six_correct_5_Aripiprazole_means,
    top_six_correct_NULL = top_six_correct_5_Aripiprazole_NULL,
    top_six_correct_means_NULL = top_six_correct_5_Aripiprazole_means_NULL,
    survivors = survivors_5_Aripiprazole,
    predicted_magnitude_correct_fraction = predicted_magnitude_correct_fraction_5_Aripiprazole,
    predicted_magnitude_correct_fraction_NULL = predicted_magnitude_correct_fraction_5_Aripiprazole_NULL,
    predicted_mean_final_od = predicted_mean_final_od_5_Aripiprazole,
    predicted_sd_final_od = predicted_sd_final_od_5_Aripiprazole,
    real_mean_final_od = real_mean_final_od_5_Aripiprazole,
    real_sd_final_od = real_sd_final_od_5_Aripiprazole
  ),
  "20" = list(
    top_six_correct = top_six_correct_20_Aripiprazole,
    top_six_correct_means = top_six_correct_20_Aripiprazole_means,
    top_six_correct_NULL = top_six_correct_20_Aripiprazole_NULL,
    top_six_correct_means_NULL = top_six_correct_20_Aripiprazole_means_NULL,
    survivors = survivors_20_Aripiprazole,
    predicted_magnitude_correct_fraction = predicted_magnitude_correct_fraction_20_Aripiprazole,
    predicted_magnitude_correct_fraction_NULL = predicted_magnitude_correct_fraction_20_Aripiprazole_NULL,
    predicted_mean_final_od = predicted_mean_final_od_20_Aripiprazole,
    predicted_sd_final_od = predicted_sd_final_od_20_Aripiprazole,
    real_mean_final_od = real_mean_final_od_20_Aripiprazole,
    real_sd_final_od = real_sd_final_od_20_Aripiprazole
  ),
  "80" = list(
    top_six_correct = top_six_correct_80_Aripiprazole,
    top_six_correct_means = top_six_correct_80_Aripiprazole_means,
    top_six_correct_NULL = top_six_correct_80_Aripiprazole_NULL,
    top_six_correct_means_NULL = top_six_correct_80_Aripiprazole_means_NULL,
    survivors = survivors_80_Aripiprazole,
    predicted_magnitude_correct_fraction = predicted_magnitude_correct_fraction_80_Aripiprazole,
    predicted_magnitude_correct_fraction_NULL = predicted_magnitude_correct_fraction_80_Aripiprazole_NULL,
    predicted_mean_final_od = predicted_mean_final_od_80_Aripiprazole,
    predicted_sd_final_od = predicted_sd_final_od_80_Aripiprazole,
    real_mean_final_od = real_mean_final_od_80_Aripiprazole,
    real_sd_final_od = real_sd_final_od_80_Aripiprazole
  )
)

# Metrics for Azithromycin
metrics_list$Azithromycin <- list(
  "2.5" = list(
    top_six_correct = top_six_correct_2.5_Azithromycin,
    top_six_correct_means = top_six_correct_2.5_Azithromycin_means,
    top_six_correct_NULL = top_six_correct_2.5_Azithromycin_NULL,
    top_six_correct_means_NULL = top_six_correct_2.5_Azithromycin_means_NULL,
    survivors = survivors_2.5_Azithromycin,
    predicted_magnitude_correct_fraction = predicted_magnitude_correct_fraction_2.5_Azithromycin,
    predicted_magnitude_correct_fraction_NULL = predicted_magnitude_correct_fraction_2.5_Azithromycin_NULL,
    predicted_mean_final_od = predicted_mean_final_od_2.5_Azithromycin,
    predicted_sd_final_od = predicted_sd_final_od_2.5_Azithromycin,
    real_mean_final_od = real_mean_final_od_2.5_Azithromycin,
    real_sd_final_od = real_sd_final_od_2.5_Azithromycin
  ),
  "20" = list(
    top_six_correct = top_six_correct_20_Azithromycin,
    top_six_correct_means = top_six_correct_20_Azithromycin_means,
    top_six_correct_NULL = top_six_correct_20_Azithromycin_NULL,
    top_six_correct_means_NULL = top_six_correct_20_Azithromycin_means_NULL,
    survivors = survivors_20_Azithromycin,
    predicted_magnitude_correct_fraction = predicted_magnitude_correct_fraction_20_Azithromycin,
    predicted_magnitude_correct_fraction_NULL = predicted_magnitude_correct_fraction_20_Azithromycin_NULL,
    predicted_mean_final_od = predicted_mean_final_od_20_Azithromycin,
    predicted_sd_final_od = predicted_sd_final_od_20_Azithromycin,
    real_mean_final_od = real_mean_final_od_20_Azithromycin,
    real_sd_final_od = real_sd_final_od_20_Azithromycin
  ),
  "50" = list(
    top_six_correct = top_six_correct_50_Azithromycin,
    top_six_correct_means = top_six_correct_50_Azithromycin_means,
    top_six_correct_NULL = top_six_correct_50_Azithromycin_NULL,
    top_six_correct_means_NULL = top_six_correct_50_Azithromycin_means_NULL,
    survivors = survivors_50_Azithromycin,
    predicted_magnitude_correct_fraction = predicted_magnitude_correct_fraction_50_Azithromycin,
    predicted_magnitude_correct_fraction_NULL = predicted_magnitude_correct_fraction_50_Azithromycin_NULL,
    predicted_mean_final_od = predicted_mean_final_od_50_Azithromycin,
    predicted_sd_final_od = predicted_sd_final_od_50_Azithromycin,
    real_mean_final_od = real_mean_final_od_50_Azithromycin,
    real_sd_final_od = real_sd_final_od_50_Azithromycin
  )
)

# Metrics for beta_estradiol_17_valerate
metrics_list$beta_estradiol_17_valerate <- list(
  "5" = list(
    top_six_correct = top_six_correct_5_beta_estradiol_17_valerate,
    top_six_correct_means = top_six_correct_5_beta_estradiol_17_valerate_means,
    top_six_correct_NULL = top_six_correct_5_beta_estradiol_17_valerate_NULL,
    top_six_correct_means_NULL = top_six_correct_5_beta_estradiol_17_valerate_means_NULL,
    survivors = survivors_5_beta_estradiol_17_valerate,
    predicted_magnitude_correct_fraction = predicted_magnitude_correct_fraction_5_beta_estradiol_17_valerate,
    predicted_magnitude_correct_fraction_NULL = predicted_magnitude_correct_fraction_5_beta_estradiol_17_valerate_NULL,
    predicted_mean_final_od = predicted_mean_final_od_5_beta_estradiol_17_valerate,
    predicted_sd_final_od = predicted_sd_final_od_5_beta_estradiol_17_valerate,
    real_mean_final_od = real_mean_final_od_5_beta_estradiol_17_valerate,
    real_sd_final_od = real_sd_final_od_5_beta_estradiol_17_valerate
  ),
  "20" = list(
    top_six_correct = top_six_correct_20_beta_estradiol_17_valerate,
    top_six_correct_means = top_six_correct_20_beta_estradiol_17_valerate_means,
    top_six_correct_NULL = top_six_correct_20_beta_estradiol_17_valerate_NULL,
    top_six_correct_means_NULL = top_six_correct_20_beta_estradiol_17_valerate_means_NULL,
    survivors = survivors_20_beta_estradiol_17_valerate,
    predicted_magnitude_correct_fraction = predicted_magnitude_correct_fraction_20_beta_estradiol_17_valerate,
    predicted_magnitude_correct_fraction_NULL = predicted_magnitude_correct_fraction_20_beta_estradiol_17_valerate_NULL,
    predicted_mean_final_od = predicted_mean_final_od_20_beta_estradiol_17_valerate,
    predicted_sd_final_od = predicted_sd_final_od_20_beta_estradiol_17_valerate,
    real_mean_final_od = real_mean_final_od_20_beta_estradiol_17_valerate,
    real_sd_final_od = real_sd_final_od_20_beta_estradiol_17_valerate
  ),
  "80" = list(
    top_six_correct = top_six_correct_80_beta_estradiol_17_valerate,
    top_six_correct_means = top_six_correct_80_beta_estradiol_17_valerate_means,
    top_six_correct_NULL = top_six_correct_80_beta_estradiol_17_valerate_NULL,
    top_six_correct_means_NULL = top_six_correct_80_beta_estradiol_17_valerate_means_NULL,
    survivors = survivors_80_beta_estradiol_17_valerate,
    predicted_magnitude_correct_fraction = predicted_magnitude_correct_fraction_80_beta_estradiol_17_valerate,
    predicted_magnitude_correct_fraction_NULL = predicted_magnitude_correct_fraction_80_beta_estradiol_17_valerate_NULL,
    predicted_mean_final_od = predicted_mean_final_od_80_beta_estradiol_17_valerate,
    predicted_sd_final_od = predicted_sd_final_od_80_beta_estradiol_17_valerate,
    real_mean_final_od = real_mean_final_od_80_beta_estradiol_17_valerate,
    real_sd_final_od = real_sd_final_od_80_beta_estradiol_17_valerate
  )
)

# Chlorpromazine 
metrics_list$Chlorpromazine <- list(
  "5" = list(
    top_six_correct = top_six_correct_5_Chlorpromazine,
    top_six_correct_means = top_six_correct_5_Chlorpromazine_means,
    top_six_correct_NULL = top_six_correct_5_Chlorpromazine_NULL,
    top_six_correct_means_NULL = top_six_correct_5_Chlorpromazine_means_NULL,
    survivors = survivors_5_Chlorpromazine,
    predicted_magnitude_correct_fraction = predicted_magnitude_correct_fraction_5_Chlorpromazine,
    predicted_magnitude_correct_fraction_NULL = predicted_magnitude_correct_fraction_5_Chlorpromazine_NULL,
    predicted_mean_final_od = predicted_mean_final_od_5_Chlorpromazine,
    predicted_sd_final_od = predicted_sd_final_od_5_Chlorpromazine,
    real_mean_final_od = real_mean_final_od_5_Chlorpromazine,
    real_sd_final_od = real_sd_final_od_5_Chlorpromazine
  ),
  "20" = list(
    top_six_correct = top_six_correct_20_Chlorpromazine,
    top_six_correct_means = top_six_correct_20_Chlorpromazine_means,
    top_six_correct_NULL = top_six_correct_20_Chlorpromazine_NULL,
    top_six_correct_means_NULL = top_six_correct_20_Chlorpromazine_means_NULL,
    survivors = survivors_20_Chlorpromazine,
    predicted_magnitude_correct_fraction = predicted_magnitude_correct_fraction_20_Chlorpromazine,
    predicted_magnitude_correct_fraction_NULL = predicted_magnitude_correct_fraction_20_Chlorpromazine_NULL,
    predicted_mean_final_od = predicted_mean_final_od_20_Chlorpromazine,
    predicted_sd_final_od = predicted_sd_final_od_20_Chlorpromazine,
    real_mean_final_od = real_mean_final_od_20_Chlorpromazine,
    real_sd_final_od = real_sd_final_od_20_Chlorpromazine
  )
)

# Ciprofloxacin 
metrics_list$Ciprofloxacin <- list(
  "20" = list(
    top_six_correct = top_six_correct_20_Ciprofloxacin,
    top_six_correct_means = top_six_correct_20_Ciprofloxacin_means,
    top_six_correct_NULL = top_six_correct_20_Ciprofloxacin_NULL,
    top_six_correct_means_NULL = top_six_correct_20_Ciprofloxacin_means_NULL,
    survivors = survivors_20_Ciprofloxacin,
    predicted_magnitude_correct_fraction = predicted_magnitude_correct_fraction_20_Ciprofloxacin,
    predicted_magnitude_correct_fraction_NULL = predicted_magnitude_correct_fraction_20_Ciprofloxacin_NULL,
    predicted_mean_final_od = predicted_mean_final_od_20_Ciprofloxacin,
    predicted_sd_final_od = predicted_sd_final_od_20_Ciprofloxacin,
    real_mean_final_od = real_mean_final_od_20_Ciprofloxacin,
    real_sd_final_od = real_sd_final_od_20_Ciprofloxacin
  ),
  "80" = list(
    top_six_correct = top_six_correct_80_Ciprofloxacin,
    top_six_correct_means = top_six_correct_80_Ciprofloxacin_means,
    top_six_correct_NULL = top_six_correct_80_Ciprofloxacin_NULL,
    top_six_correct_means_NULL = top_six_correct_80_Ciprofloxacin_means_NULL,
    survivors = survivors_80_Ciprofloxacin,
    predicted_magnitude_correct_fraction = predicted_magnitude_correct_fraction_80_Ciprofloxacin,
    predicted_magnitude_correct_fraction_NULL = predicted_magnitude_correct_fraction_80_Ciprofloxacin_NULL,
    predicted_mean_final_od = predicted_mean_final_od_80_Ciprofloxacin,
    predicted_sd_final_od = predicted_sd_final_od_80_Ciprofloxacin,
    real_mean_final_od = real_mean_final_od_80_Ciprofloxacin,
    real_sd_final_od = real_sd_final_od_80_Ciprofloxacin
  )
)

# Metrics for Clomiphene
metrics_list$Clomiphene <- list(
  "5" = list(
    top_six_correct = top_six_correct_5_Clomiphene,
    top_six_correct_means = top_six_correct_5_Clomiphene_means,
    top_six_correct_NULL = top_six_correct_5_Clomiphene_NULL,
    top_six_correct_means_NULL = top_six_correct_5_Clomiphene_means_NULL,
    survivors = survivors_5_Clomiphene,
    predicted_magnitude_correct_fraction = predicted_magnitude_correct_fraction_5_Clomiphene,
    predicted_magnitude_correct_fraction_NULL = predicted_magnitude_correct_fraction_5_Clomiphene_NULL,
    predicted_mean_final_od = predicted_mean_final_od_5_Clomiphene,
    predicted_sd_final_od = predicted_sd_final_od_5_Clomiphene,
    real_mean_final_od = real_mean_final_od_5_Clomiphene,
    real_sd_final_od = real_sd_final_od_5_Clomiphene
  ),
  "20" = list(
    top_six_correct = top_six_correct_20_Clomiphene,
    top_six_correct_means = top_six_correct_20_Clomiphene_means,
    top_six_correct_NULL = top_six_correct_20_Clomiphene_NULL,
    top_six_correct_means_NULL = top_six_correct_20_Clomiphene_means_NULL,
    survivors = survivors_20_Clomiphene,
    predicted_magnitude_correct_fraction = predicted_magnitude_correct_fraction_20_Clomiphene,
    predicted_magnitude_correct_fraction_NULL = predicted_magnitude_correct_fraction_20_Clomiphene_NULL,
    predicted_mean_final_od = predicted_mean_final_od_20_Clomiphene,
    predicted_sd_final_od = predicted_sd_final_od_20_Clomiphene,
    real_mean_final_od = real_mean_final_od_20_Clomiphene,
    real_sd_final_od = real_sd_final_od_20_Clomiphene
  ),
  "80" = list(
    top_six_correct = top_six_correct_80_Clomiphene,
    top_six_correct_means = top_six_correct_80_Clomiphene_means,
    top_six_correct_NULL = top_six_correct_80_Clomiphene_NULL,
    top_six_correct_means_NULL = top_six_correct_80_Clomiphene_means_NULL,
    survivors = survivors_80_Clomiphene,
    predicted_magnitude_correct_fraction = predicted_magnitude_correct_fraction_80_Clomiphene,
    predicted_magnitude_correct_fraction_NULL = predicted_magnitude_correct_fraction_80_Clomiphene_NULL,
    predicted_mean_final_od = predicted_mean_final_od_80_Clomiphene,
    predicted_sd_final_od = predicted_sd_final_od_80_Clomiphene,
    real_mean_final_od = real_mean_final_od_80_Clomiphene,
    real_sd_final_od = real_sd_final_od_80_Clomiphene
  )
)

# Metrics for Diacerein
metrics_list$Diacerein <- list(
  "20" = list(
    top_six_correct = top_six_correct_20_Diacerein,
    top_six_correct_means = top_six_correct_20_Diacerein_means,
    top_six_correct_NULL = top_six_correct_20_Diacerein_NULL,
    top_six_correct_means_NULL = top_six_correct_20_Diacerein_means_NULL,
    survivors = survivors_20_Diacerein,
    predicted_magnitude_correct_fraction = predicted_magnitude_correct_fraction_20_Diacerein,
    predicted_magnitude_correct_fraction_NULL = predicted_magnitude_correct_fraction_20_Diacerein_NULL,
    predicted_mean_final_od = predicted_mean_final_od_20_Diacerein,
    predicted_sd_final_od = predicted_sd_final_od_20_Diacerein,
    real_mean_final_od = real_mean_final_od_20_Diacerein,
    real_sd_final_od = real_sd_final_od_20_Diacerein
  ),
  "80" = list(
    top_six_correct = top_six_correct_80_Diacerein,
    top_six_correct_means = top_six_correct_80_Diacerein_means,
    top_six_correct_NULL = top_six_correct_80_Diacerein_NULL,
    top_six_correct_means_NULL = top_six_correct_80_Diacerein_means_NULL,
    survivors = survivors_80_Diacerein,
    predicted_magnitude_correct_fraction = predicted_magnitude_correct_fraction_80_Diacerein,
    predicted_magnitude_correct_fraction_NULL = predicted_magnitude_correct_fraction_80_Diacerein_NULL,
    predicted_mean_final_od = predicted_mean_final_od_80_Diacerein,
    predicted_sd_final_od = predicted_sd_final_od_80_Diacerein,
    real_mean_final_od = real_mean_final_od_80_Diacerein,
    real_sd_final_od = real_sd_final_od_80_Diacerein
  ),
  "320" = list(
    top_six_correct = top_six_correct_320_Diacerein,
    top_six_correct_means = top_six_correct_320_Diacerein_means,
    top_six_correct_NULL = top_six_correct_320_Diacerein_NULL,
    top_six_correct_means_NULL = top_six_correct_320_Diacerein_means_NULL,
    survivors = survivors_320_Diacerein,
    predicted_magnitude_correct_fraction = predicted_magnitude_correct_fraction_320_Diacerein,
    predicted_magnitude_correct_fraction_NULL = predicted_magnitude_correct_fraction_320_Diacerein_NULL,
    predicted_mean_final_od = predicted_mean_final_od_320_Diacerein,
    predicted_sd_final_od = predicted_sd_final_od_320_Diacerein,
    real_mean_final_od = real_mean_final_od_320_Diacerein,
    real_sd_final_od = real_sd_final_od_320_Diacerein
  )
)

# Metrics for Dienestrol
metrics_list$Dienestrol <- list(
  "5" = list(
    top_six_correct = top_six_correct_5_Dienestrol,
    top_six_correct_means = top_six_correct_5_Dienestrol_means,
    top_six_correct_NULL = top_six_correct_5_Dienestrol_NULL,
    top_six_correct_means_NULL = top_six_correct_5_Dienestrol_means_NULL,
    survivors = survivors_5_Dienestrol,
    predicted_magnitude_correct_fraction = predicted_magnitude_correct_fraction_5_Dienestrol,
    predicted_magnitude_correct_fraction_NULL = predicted_magnitude_correct_fraction_5_Dienestrol_NULL,
    predicted_mean_final_od = predicted_mean_final_od_5_Dienestrol,
    predicted_sd_final_od = predicted_sd_final_od_5_Dienestrol,
    real_mean_final_od = real_mean_final_od_5_Dienestrol,
    real_sd_final_od = real_sd_final_od_5_Dienestrol
  ),
  "20" = list(
    top_six_correct = top_six_correct_20_Dienestrol,
    top_six_correct_means = top_six_correct_20_Dienestrol_means,
    top_six_correct_NULL = top_six_correct_20_Dienestrol_NULL,
    top_six_correct_means_NULL = top_six_correct_20_Dienestrol_means_NULL,
    survivors = survivors_20_Dienestrol,
    predicted_magnitude_correct_fraction = predicted_magnitude_correct_fraction_20_Dienestrol,
    predicted_magnitude_correct_fraction_NULL = predicted_magnitude_correct_fraction_20_Dienestrol_NULL,
    predicted_mean_final_od = predicted_mean_final_od_20_Dienestrol,
    predicted_sd_final_od = predicted_sd_final_od_20_Dienestrol,
    real_mean_final_od = real_mean_final_od_20_Dienestrol,
    real_sd_final_od = real_sd_final_od_20_Dienestrol
  ),
  "80" = list(
    top_six_correct = top_six_correct_80_Dienestrol,
    top_six_correct_means = top_six_correct_80_Dienestrol_means,
    top_six_correct_NULL = top_six_correct_80_Dienestrol_NULL,
    top_six_correct_means_NULL = top_six_correct_80_Dienestrol_means_NULL,
    survivors = survivors_80_Dienestrol,
    predicted_magnitude_correct_fraction = predicted_magnitude_correct_fraction_80_Dienestrol,
    predicted_magnitude_correct_fraction_NULL = predicted_magnitude_correct_fraction_80_Dienestrol_NULL,
    predicted_mean_final_od = predicted_mean_final_od_80_Dienestrol,
    predicted_sd_final_od = predicted_sd_final_od_80_Dienestrol,
    real_mean_final_od = real_mean_final_od_80_Dienestrol,
    real_sd_final_od = real_sd_final_od_80_Dienestrol
  )
)

# Metrics for Doxycycline
metrics_list$Doxycycline <- list(
  "0.5" = list(
    top_six_correct = top_six_correct_0.5_Doxycycline,
    top_six_correct_means = top_six_correct_0.5_Doxycycline_means,
    top_six_correct_NULL = top_six_correct_0.5_Doxycycline_NULL,
    top_six_correct_means_NULL = top_six_correct_0.5_Doxycycline_means_NULL,
    survivors = survivors_0.5_Doxycycline,
    predicted_magnitude_correct_fraction = predicted_magnitude_correct_fraction_0.5_Doxycycline,
    predicted_magnitude_correct_fraction_NULL = predicted_magnitude_correct_fraction_0.5_Doxycycline_NULL,
    predicted_mean_final_od = predicted_mean_final_od_0.5_Doxycycline,
    predicted_sd_final_od = predicted_sd_final_od_0.5_Doxycycline,
    real_mean_final_od = real_mean_final_od_0.5_Doxycycline,
    real_sd_final_od = real_sd_final_od_0.5_Doxycycline
  ),
  "2.5" = list(
    top_six_correct = top_six_correct_2.5_Doxycycline,
    top_six_correct_means = top_six_correct_2.5_Doxycycline_means,
    top_six_correct_NULL = top_six_correct_2.5_Doxycycline_NULL,
    top_six_correct_means_NULL = top_six_correct_2.5_Doxycycline_means_NULL,
    survivors = survivors_2.5_Doxycycline,
    predicted_magnitude_correct_fraction = predicted_magnitude_correct_fraction_2.5_Doxycycline,
    predicted_magnitude_correct_fraction_NULL = predicted_magnitude_correct_fraction_2.5_Doxycycline_NULL,
    predicted_mean_final_od = predicted_mean_final_od_2.5_Doxycycline,
    predicted_sd_final_od = predicted_sd_final_od_2.5_Doxycycline,
    real_mean_final_od = real_mean_final_od_2.5_Doxycycline,
    real_sd_final_od = real_sd_final_od_2.5_Doxycycline
  )
)

# Metrics for Ebselen
metrics_list$Ebselen <- list(
  "1.25" = list(
    top_six_correct = top_six_correct_1.25_Ebselen,
    top_six_correct_means = top_six_correct_1.25_Ebselen_means,
    top_six_correct_NULL = top_six_correct_1.25_Ebselen_NULL,
    top_six_correct_means_NULL = top_six_correct_1.25_Ebselen_means_NULL,
    survivors = survivors_1.25_Ebselen,
    predicted_magnitude_correct_fraction = predicted_magnitude_correct_fraction_1.25_Ebselen,
    predicted_magnitude_correct_fraction_NULL = predicted_magnitude_correct_fraction_1.25_Ebselen_NULL,
    predicted_mean_final_od = predicted_mean_final_od_1.25_Ebselen,
    predicted_sd_final_od = predicted_sd_final_od_1.25_Ebselen,
    real_mean_final_od = real_mean_final_od_1.25_Ebselen,
    real_sd_final_od = real_sd_final_od_1.25_Ebselen
  ),
  "5" = list(
    top_six_correct = top_six_correct_5_Ebselen,
    top_six_correct_means = top_six_correct_5_Ebselen_means,
    top_six_correct_NULL = top_six_correct_5_Ebselen_NULL,
    top_six_correct_means_NULL = top_six_correct_5_Ebselen_means_NULL,
    survivors = survivors_5_Ebselen,
    predicted_magnitude_correct_fraction = predicted_magnitude_correct_fraction_5_Ebselen,
    predicted_magnitude_correct_fraction_NULL = predicted_magnitude_correct_fraction_5_Ebselen_NULL,
    predicted_mean_final_od = predicted_mean_final_od_5_Ebselen,
    predicted_sd_final_od = predicted_sd_final_od_5_Ebselen,
    real_mean_final_od = real_mean_final_od_5_Ebselen,
    real_sd_final_od = real_sd_final_od_5_Ebselen
  ),
  "20" = list(
    top_six_correct = top_six_correct_20_Ebselen,
    top_six_correct_means = top_six_correct_20_Ebselen_means,
    top_six_correct_NULL = top_six_correct_20_Ebselen_NULL,
    top_six_correct_means_NULL = top_six_correct_20_Ebselen_means_NULL,
    survivors = survivors_20_Ebselen,
    predicted_magnitude_correct_fraction = predicted_magnitude_correct_fraction_20_Ebselen,
    predicted_magnitude_correct_fraction_NULL = predicted_magnitude_correct_fraction_20_Ebselen_NULL,
    predicted_mean_final_od = predicted_mean_final_od_20_Ebselen,
    predicted_sd_final_od = predicted_sd_final_od_20_Ebselen,
    real_mean_final_od = real_mean_final_od_20_Ebselen,
    real_sd_final_od = real_sd_final_od_20_Ebselen
  )
)

# Metrics for Entacapone
metrics_list$Entacapone <- list(
  "5" = list(
    top_six_correct = top_six_correct_5_Entacapone,
    top_six_correct_means = top_six_correct_5_Entacapone_means,
    top_six_correct_NULL = top_six_correct_5_Entacapone_NULL,
    top_six_correct_means_NULL = top_six_correct_5_Entacapone_means_NULL,
    survivors = survivors_5_Entacapone,
    predicted_magnitude_correct_fraction = predicted_magnitude_correct_fraction_5_Entacapone,
    predicted_magnitude_correct_fraction_NULL = predicted_magnitude_correct_fraction_5_Entacapone_NULL,
    predicted_mean_final_od = predicted_mean_final_od_5_Entacapone,
    predicted_sd_final_od = predicted_sd_final_od_5_Entacapone,
    real_mean_final_od = real_mean_final_od_5_Entacapone,
    real_sd_final_od = real_sd_final_od_5_Entacapone
  ),
  "20" = list(
    top_six_correct = top_six_correct_20_Entacapone,
    top_six_correct_means = top_six_correct_20_Entacapone_means,
    top_six_correct_NULL = top_six_correct_20_Entacapone_NULL,
    top_six_correct_means_NULL = top_six_correct_20_Entacapone_means_NULL,
    survivors = survivors_20_Entacapone,
    predicted_magnitude_correct_fraction = predicted_magnitude_correct_fraction_20_Entacapone,
    predicted_magnitude_correct_fraction_NULL = predicted_magnitude_correct_fraction_20_Entacapone_NULL,
    predicted_mean_final_od = predicted_mean_final_od_20_Entacapone,
    predicted_sd_final_od = predicted_sd_final_od_20_Entacapone,
    real_mean_final_od = real_mean_final_od_20_Entacapone,
    real_sd_final_od = real_sd_final_od_20_Entacapone
  ),
  "80" = list(
    top_six_correct = top_six_correct_80_Entacapone,
    top_six_correct_means = top_six_correct_80_Entacapone_means,
    top_six_correct_NULL = top_six_correct_80_Entacapone_NULL,
    top_six_correct_means_NULL = top_six_correct_80_Entacapone_means_NULL,
    survivors = survivors_80_Entacapone,
    predicted_magnitude_correct_fraction = predicted_magnitude_correct_fraction_80_Entacapone,
    predicted_magnitude_correct_fraction_NULL = predicted_magnitude_correct_fraction_80_Entacapone_NULL,
    predicted_mean_final_od = predicted_mean_final_od_80_Entacapone,
    predicted_sd_final_od = predicted_sd_final_od_80_Entacapone,
    real_mean_final_od = real_mean_final_od_80_Entacapone,
    real_sd_final_od = real_sd_final_od_80_Entacapone
  )
)

# Metrics for Felodipine
metrics_list$Felodipine <- list(
  "5" = list(
    top_six_correct = top_six_correct_5_Felodipine,
    top_six_correct_means = top_six_correct_5_Felodipine_means,
    top_six_correct_NULL = top_six_correct_5_Felodipine_NULL,
    top_six_correct_means_NULL = top_six_correct_5_Felodipine_means_NULL,
    survivors = survivors_5_Felodipine,
    predicted_magnitude_correct_fraction = predicted_magnitude_correct_fraction_5_Felodipine,
    predicted_magnitude_correct_fraction_NULL = predicted_magnitude_correct_fraction_5_Felodipine_NULL,
    predicted_mean_final_od = predicted_mean_final_od_5_Felodipine,
    predicted_sd_final_od = predicted_sd_final_od_5_Felodipine,
    real_mean_final_od = real_mean_final_od_5_Felodipine,
    real_sd_final_od = real_sd_final_od_5_Felodipine
  ),
  "20" = list(
    top_six_correct = top_six_correct_20_Felodipine,
    top_six_correct_means = top_six_correct_20_Felodipine_means,
    top_six_correct_NULL = top_six_correct_20_Felodipine_NULL,
    top_six_correct_means_NULL = top_six_correct_20_Felodipine_means_NULL,
    survivors = survivors_20_Felodipine,
    predicted_magnitude_correct_fraction = predicted_magnitude_correct_fraction_20_Felodipine,
    predicted_magnitude_correct_fraction_NULL = predicted_magnitude_correct_fraction_20_Felodipine_NULL,
    predicted_mean_final_od = predicted_mean_final_od_20_Felodipine,
    predicted_sd_final_od = predicted_sd_final_od_20_Felodipine,
    real_mean_final_od = real_mean_final_od_20_Felodipine,
    real_sd_final_od = real_sd_final_od_20_Felodipine
  ),
  "80" = list(
    top_six_correct = top_six_correct_80_Felodipine,
    top_six_correct_means = top_six_correct_80_Felodipine_means,
    top_six_correct_NULL = top_six_correct_80_Felodipine_NULL,
    top_six_correct_means_NULL = top_six_correct_80_Felodipine_means_NULL,
    survivors = survivors_80_Felodipine,
    predicted_magnitude_correct_fraction = predicted_magnitude_correct_fraction_80_Felodipine,
    predicted_magnitude_correct_fraction_NULL = predicted_magnitude_correct_fraction_80_Felodipine_NULL,
    predicted_mean_final_od = predicted_mean_final_od_80_Felodipine,
    predicted_sd_final_od = predicted_sd_final_od_80_Felodipine,
    real_mean_final_od = real_mean_final_od_80_Felodipine,
    real_sd_final_od = real_sd_final_od_80_Felodipine
  )
)

# Metrics for Ketoconazole
metrics_list$Ketoconazole <- list(
  "5" = list(
    top_six_correct = top_six_correct_5_Ketoconazole,
    top_six_correct_means = top_six_correct_5_Ketoconazole_means,
    top_six_correct_NULL = top_six_correct_5_Ketoconazole_NULL,
    top_six_correct_means_NULL = top_six_correct_5_Ketoconazole_means_NULL,
    survivors = survivors_5_Ketoconazole,
    predicted_magnitude_correct_fraction = predicted_magnitude_correct_fraction_5_Ketoconazole,
    predicted_magnitude_correct_fraction_NULL = predicted_magnitude_correct_fraction_5_Ketoconazole_NULL,
    predicted_mean_final_od = predicted_mean_final_od_5_Ketoconazole,
    predicted_sd_final_od = predicted_sd_final_od_5_Ketoconazole,
    real_mean_final_od = real_mean_final_od_5_Ketoconazole,
    real_sd_final_od = real_sd_final_od_5_Ketoconazole
  ),
  "20" = list(
    top_six_correct = top_six_correct_20_Ketoconazole,
    top_six_correct_means = top_six_correct_20_Ketoconazole_means,
    top_six_correct_NULL = top_six_correct_20_Ketoconazole_NULL,
    top_six_correct_means_NULL = top_six_correct_20_Ketoconazole_means_NULL,
    survivors = survivors_20_Ketoconazole,
    predicted_magnitude_correct_fraction = predicted_magnitude_correct_fraction_20_Ketoconazole,
    predicted_magnitude_correct_fraction_NULL = predicted_magnitude_correct_fraction_20_Ketoconazole_NULL,
    predicted_mean_final_od = predicted_mean_final_od_20_Ketoconazole,
    predicted_sd_final_od = predicted_sd_final_od_20_Ketoconazole,
    real_mean_final_od = real_mean_final_od_20_Ketoconazole,
    real_sd_final_od = real_sd_final_od_20_Ketoconazole
  ),
  "80" = list(
    top_six_correct = top_six_correct_80_Ketoconazole,
    top_six_correct_means = top_six_correct_80_Ketoconazole_means,
    top_six_correct_NULL = top_six_correct_80_Ketoconazole_NULL,
    top_six_correct_means_NULL = top_six_correct_80_Ketoconazole_means_NULL,
    survivors = survivors_80_Ketoconazole,
    predicted_magnitude_correct_fraction = predicted_magnitude_correct_fraction_80_Ketoconazole,
    predicted_magnitude_correct_fraction_NULL = predicted_magnitude_correct_fraction_80_Ketoconazole_NULL,
    predicted_mean_final_od = predicted_mean_final_od_80_Ketoconazole,
    predicted_sd_final_od = predicted_sd_final_od_80_Ketoconazole,
    real_mean_final_od = real_mean_final_od_80_Ketoconazole,
    real_sd_final_od = real_sd_final_od_80_Ketoconazole
  )
)

# Metrics for Lansoprazole
metrics_list$Lansoprazole <- list(
  "5" = list(
    top_six_correct = top_six_correct_5_Lansoprazole,
    top_six_correct_means = top_six_correct_5_Lansoprazole_means,
    top_six_correct_NULL = top_six_correct_5_Lansoprazole_NULL,
    top_six_correct_means_NULL = top_six_correct_5_Lansoprazole_means_NULL,
    survivors = survivors_5_Lansoprazole,
    predicted_magnitude_correct_fraction = predicted_magnitude_correct_fraction_5_Lansoprazole,
    predicted_magnitude_correct_fraction_NULL = predicted_magnitude_correct_fraction_5_Lansoprazole_NULL,
    predicted_mean_final_od = predicted_mean_final_od_5_Lansoprazole,
    predicted_sd_final_od = predicted_sd_final_od_5_Lansoprazole,
    real_mean_final_od = real_mean_final_od_5_Lansoprazole,
    real_sd_final_od = real_sd_final_od_5_Lansoprazole
  ),
  "20" = list(
    top_six_correct = top_six_correct_20_Lansoprazole,
    top_six_correct_means = top_six_correct_20_Lansoprazole_means,
    top_six_correct_NULL = top_six_correct_20_Lansoprazole_NULL,
    top_six_correct_means_NULL = top_six_correct_20_Lansoprazole_means_NULL,
    survivors = survivors_20_Lansoprazole,
    predicted_magnitude_correct_fraction = predicted_magnitude_correct_fraction_20_Lansoprazole,
    predicted_magnitude_correct_fraction_NULL = predicted_magnitude_correct_fraction_20_Lansoprazole_NULL,
    predicted_mean_final_od = predicted_mean_final_od_20_Lansoprazole,
    predicted_sd_final_od = predicted_sd_final_od_20_Lansoprazole,
    real_mean_final_od = real_mean_final_od_20_Lansoprazole,
    real_sd_final_od = real_sd_final_od_20_Lansoprazole
  ),
  "80" = list(
    top_six_correct = top_six_correct_80_Lansoprazole,
    top_six_correct_means = top_six_correct_80_Lansoprazole_means,
    top_six_correct_NULL = top_six_correct_80_Lansoprazole_NULL,
    top_six_correct_means_NULL = top_six_correct_80_Lansoprazole_means_NULL,
    survivors = survivors_80_Lansoprazole,
    predicted_magnitude_correct_fraction = predicted_magnitude_correct_fraction_80_Lansoprazole,
    predicted_magnitude_correct_fraction_NULL = predicted_magnitude_correct_fraction_80_Lansoprazole_NULL,
    predicted_mean_final_od = predicted_mean_final_od_80_Lansoprazole,
    predicted_sd_final_od = predicted_sd_final_od_80_Lansoprazole,
    real_mean_final_od = real_mean_final_od_80_Lansoprazole,
    real_sd_final_od = real_sd_final_od_80_Lansoprazole
  )
)

# Metrics for Loratadine
metrics_list$Loratadine <- list(
  "5" = list(
    top_six_correct = top_six_correct_5_Loratadine,
    top_six_correct_means = top_six_correct_5_Loratadine_means,
    top_six_correct_NULL = top_six_correct_5_Loratadine_NULL,
    top_six_correct_means_NULL = top_six_correct_5_Loratadine_means_NULL,
    survivors = survivors_5_Loratadine,
    predicted_magnitude_correct_fraction = predicted_magnitude_correct_fraction_5_Loratadine,
    predicted_magnitude_correct_fraction_NULL = predicted_magnitude_correct_fraction_5_Loratadine_NULL,
    predicted_mean_final_od = predicted_mean_final_od_5_Loratadine,
    predicted_sd_final_od = predicted_sd_final_od_5_Loratadine,
    real_mean_final_od = real_mean_final_od_5_Loratadine,
    real_sd_final_od = real_sd_final_od_5_Loratadine
  ),
  "20" = list(
    top_six_correct = top_six_correct_20_Loratadine,
    top_six_correct_means = top_six_correct_20_Loratadine_means,
    top_six_correct_NULL = top_six_correct_20_Loratadine_NULL,
    top_six_correct_means_NULL = top_six_correct_20_Loratadine_means_NULL,
    survivors = survivors_20_Loratadine,
    predicted_magnitude_correct_fraction = predicted_magnitude_correct_fraction_20_Loratadine,
    predicted_magnitude_correct_fraction_NULL = predicted_magnitude_correct_fraction_20_Loratadine_NULL,
    predicted_mean_final_od = predicted_mean_final_od_20_Loratadine,
    predicted_sd_final_od = predicted_sd_final_od_20_Loratadine,
    real_mean_final_od = real_mean_final_od_20_Loratadine,
    real_sd_final_od = real_sd_final_od_20_Loratadine
  ),
  "80" = list(
    top_six_correct = top_six_correct_80_Loratadine,
    top_six_correct_means = top_six_correct_80_Loratadine_means,
    top_six_correct_NULL = top_six_correct_80_Loratadine_NULL,
    top_six_correct_means_NULL = top_six_correct_80_Loratadine_means_NULL,
    survivors = survivors_80_Loratadine,
    predicted_magnitude_correct_fraction = predicted_magnitude_correct_fraction_80_Loratadine,
    predicted_magnitude_correct_fraction_NULL = predicted_magnitude_correct_fraction_80_Loratadine_NULL,
    predicted_mean_final_od = predicted_mean_final_od_80_Loratadine,
    predicted_sd_final_od = predicted_sd_final_od_80_Loratadine,
    real_mean_final_od = real_mean_final_od_80_Loratadine,
    real_sd_final_od = real_sd_final_od_80_Loratadine
  )
)

# Metrics for Loxapine
metrics_list$Loxapine <- list(
  "5" = list(
    top_six_correct = top_six_correct_5_Loxapine,
    top_six_correct_means = top_six_correct_5_Loxapine_means,
    top_six_correct_NULL = top_six_correct_5_Loxapine_NULL,
    top_six_correct_means_NULL = top_six_correct_5_Loxapine_means_NULL,
    survivors = survivors_5_Loxapine,
    predicted_magnitude_correct_fraction = predicted_magnitude_correct_fraction_5_Loxapine,
    predicted_magnitude_correct_fraction_NULL = predicted_magnitude_correct_fraction_5_Loxapine_NULL,
    predicted_mean_final_od = predicted_mean_final_od_5_Loxapine,
    predicted_sd_final_od = predicted_sd_final_od_5_Loxapine,
    real_mean_final_od = real_mean_final_od_5_Loxapine,
    real_sd_final_od = real_sd_final_od_5_Loxapine
  ),
  "20" = list(
    top_six_correct = top_six_correct_20_Loxapine,
    top_six_correct_means = top_six_correct_20_Loxapine_means,
    top_six_correct_NULL = top_six_correct_20_Loxapine_NULL,
    top_six_correct_means_NULL = top_six_correct_20_Loxapine_means_NULL,
    survivors = survivors_20_Loxapine,
    predicted_magnitude_correct_fraction = predicted_magnitude_correct_fraction_20_Loxapine,
    predicted_magnitude_correct_fraction_NULL = predicted_magnitude_correct_fraction_20_Loxapine_NULL,
    predicted_mean_final_od = predicted_mean_final_od_20_Loxapine,
    predicted_sd_final_od = predicted_sd_final_od_20_Loxapine,
    real_mean_final_od = real_mean_final_od_20_Loxapine,
    real_sd_final_od = real_sd_final_od_20_Loxapine
  ),
  "80" = list(
    top_six_correct = top_six_correct_80_Loxapine,
    top_six_correct_means = top_six_correct_80_Loxapine_means,
    top_six_correct_NULL = top_six_correct_80_Loxapine_NULL,
    top_six_correct_means_NULL = top_six_correct_80_Loxapine_means_NULL,
    survivors = survivors_80_Loxapine,
    predicted_magnitude_correct_fraction = predicted_magnitude_correct_fraction_80_Loxapine,
    predicted_magnitude_correct_fraction_NULL = predicted_magnitude_correct_fraction_80_Loxapine_NULL,
    predicted_mean_final_od = predicted_mean_final_od_80_Loxapine,
    predicted_sd_final_od = predicted_sd_final_od_80_Loxapine,
    real_mean_final_od = real_mean_final_od_80_Loxapine,
    real_sd_final_od = real_sd_final_od_80_Loxapine
  )
)

# Metrics for Mecillinam
metrics_list$Mecillinam <- list(
  "0.5" = list(
    top_six_correct = top_six_correct_0.5_Mecillinam,
    top_six_correct_means = top_six_correct_0.5_Mecillinam_means,
    top_six_correct_NULL = top_six_correct_0.5_Mecillinam_NULL,
    top_six_correct_means_NULL = top_six_correct_0.5_Mecillinam_means_NULL,
    survivors = survivors_0.5_Mecillinam,
    predicted_magnitude_correct_fraction = predicted_magnitude_correct_fraction_0.5_Mecillinam,
    predicted_magnitude_correct_fraction_NULL = predicted_magnitude_correct_fraction_0.5_Mecillinam_NULL,
    predicted_mean_final_od = predicted_mean_final_od_0.5_Mecillinam,
    predicted_sd_final_od = predicted_sd_final_od_0.5_Mecillinam,
    real_mean_final_od = real_mean_final_od_0.5_Mecillinam,
    real_sd_final_od = real_sd_final_od_0.5_Mecillinam
  ),
  "2.5" = list(
    top_six_correct = top_six_correct_2.5_Mecillinam,
    top_six_correct_means = top_six_correct_2.5_Mecillinam_means,
    top_six_correct_NULL = top_six_correct_2.5_Mecillinam_NULL,
    top_six_correct_means_NULL = top_six_correct_2.5_Mecillinam_means_NULL,
    survivors = survivors_2.5_Mecillinam,
    predicted_magnitude_correct_fraction = predicted_magnitude_correct_fraction_2.5_Mecillinam,
    predicted_magnitude_correct_fraction_NULL = predicted_magnitude_correct_fraction_2.5_Mecillinam_NULL,
    predicted_mean_final_od = predicted_mean_final_od_2.5_Mecillinam,
    predicted_sd_final_od = predicted_sd_final_od_2.5_Mecillinam,
    real_mean_final_od = real_mean_final_od_2.5_Mecillinam,
    real_sd_final_od = real_sd_final_od_2.5_Mecillinam
  ),
  "20" = list(
    top_six_correct = top_six_correct_20_Mecillinam,
    top_six_correct_means = top_six_correct_20_Mecillinam_means,
    top_six_correct_NULL = top_six_correct_20_Mecillinam_NULL,
    top_six_correct_means_NULL = top_six_correct_20_Mecillinam_means_NULL,
    survivors = survivors_20_Mecillinam,
    predicted_magnitude_correct_fraction = predicted_magnitude_correct_fraction_20_Mecillinam,
    predicted_magnitude_correct_fraction_NULL = predicted_magnitude_correct_fraction_20_Mecillinam_NULL,
    predicted_mean_final_od = predicted_mean_final_od_20_Mecillinam,
    predicted_sd_final_od = predicted_sd_final_od_20_Mecillinam,
    real_mean_final_od = real_mean_final_od_20_Mecillinam,
    real_sd_final_od = real_sd_final_od_20_Mecillinam
  )
)

# Metrics for Mefloquine
metrics_list$Mefloquine <- list(
  "5" = list(
    top_six_correct = top_six_correct_5_Mefloquine,
    top_six_correct_means = top_six_correct_5_Mefloquine_means,
    top_six_correct_NULL = top_six_correct_5_Mefloquine_NULL,
    top_six_correct_means_NULL = top_six_correct_5_Mefloquine_means_NULL,
    survivors = survivors_5_Mefloquine,
    predicted_magnitude_correct_fraction = predicted_magnitude_correct_fraction_5_Mefloquine,
    predicted_magnitude_correct_fraction_NULL = predicted_magnitude_correct_fraction_5_Mefloquine_NULL,
    predicted_mean_final_od = predicted_mean_final_od_5_Mefloquine,
    predicted_sd_final_od = predicted_sd_final_od_5_Mefloquine,
    real_mean_final_od = real_mean_final_od_5_Mefloquine,
    real_sd_final_od = real_sd_final_od_5_Mefloquine
  ),
  "20" = list(
    top_six_correct = top_six_correct_20_Mefloquine,
    top_six_correct_means = top_six_correct_20_Mefloquine_means,
    top_six_correct_NULL = top_six_correct_20_Mefloquine_NULL,
    top_six_correct_means_NULL = top_six_correct_20_Mefloquine_means_NULL,
    survivors = survivors_20_Mefloquine,
    predicted_magnitude_correct_fraction = predicted_magnitude_correct_fraction_20_Mefloquine,
    predicted_magnitude_correct_fraction_NULL = predicted_magnitude_correct_fraction_20_Mefloquine_NULL,
    predicted_mean_final_od = predicted_mean_final_od_20_Mefloquine,
    predicted_sd_final_od = predicted_sd_final_od_20_Mefloquine,
    real_mean_final_od = real_mean_final_od_20_Mefloquine,
    real_sd_final_od = real_sd_final_od_20_Mefloquine
  ),
  "60" = list(
    top_six_correct = top_six_correct_60_Mefloquine,
    top_six_correct_means = top_six_correct_60_Mefloquine_means,
    top_six_correct_NULL = top_six_correct_60_Mefloquine_NULL,
    top_six_correct_means_NULL = top_six_correct_60_Mefloquine_means_NULL,
    survivors = survivors_60_Mefloquine,
    predicted_magnitude_correct_fraction = predicted_magnitude_correct_fraction_60_Mefloquine,
    predicted_magnitude_correct_fraction_NULL = predicted_magnitude_correct_fraction_60_Mefloquine_NULL,
    predicted_mean_final_od = predicted_mean_final_od_60_Mefloquine,
    predicted_sd_final_od = predicted_sd_final_od_60_Mefloquine,
    real_mean_final_od = real_mean_final_od_60_Mefloquine,
    real_sd_final_od = real_sd_final_od_60_Mefloquine
  )
)

# Metrics for Methotrexate
metrics_list$Methotrexate <- list(
  "5" = list(
    top_six_correct = top_six_correct_5_Methotrexate,
    top_six_correct_means = top_six_correct_5_Methotrexate_means,
    top_six_correct_NULL = top_six_correct_5_Methotrexate_NULL,
    top_six_correct_means_NULL = top_six_correct_5_Methotrexate_means_NULL,
    survivors = survivors_5_Methotrexate,
    predicted_magnitude_correct_fraction = predicted_magnitude_correct_fraction_5_Methotrexate,
    predicted_magnitude_correct_fraction_NULL = predicted_magnitude_correct_fraction_5_Methotrexate_NULL,
    predicted_mean_final_od = predicted_mean_final_od_5_Methotrexate,
    predicted_sd_final_od = predicted_sd_final_od_5_Methotrexate,
    real_mean_final_od = real_mean_final_od_5_Methotrexate,
    real_sd_final_od = real_sd_final_od_5_Methotrexate
  ),
  "20" = list(
    top_six_correct = top_six_correct_20_Methotrexate,
    top_six_correct_means = top_six_correct_20_Methotrexate_means,
    top_six_correct_NULL = top_six_correct_20_Methotrexate_NULL,
    top_six_correct_means_NULL = top_six_correct_20_Methotrexate_means_NULL,
    survivors = survivors_20_Methotrexate,
    predicted_magnitude_correct_fraction = predicted_magnitude_correct_fraction_20_Methotrexate,
    predicted_magnitude_correct_fraction_NULL = predicted_magnitude_correct_fraction_20_Methotrexate_NULL,
    predicted_mean_final_od = predicted_mean_final_od_20_Methotrexate,
    predicted_sd_final_od = predicted_sd_final_od_20_Methotrexate,
    real_mean_final_od = real_mean_final_od_20_Methotrexate,
    real_sd_final_od = real_sd_final_od_20_Methotrexate
  ),
  "80" = list(
    top_six_correct = top_six_correct_80_Methotrexate,
    top_six_correct_means = top_six_correct_80_Methotrexate_means,
    top_six_correct_NULL = top_six_correct_80_Methotrexate_NULL,
    top_six_correct_means_NULL = top_six_correct_80_Methotrexate_means_NULL,
    survivors = survivors_80_Methotrexate,
    predicted_magnitude_correct_fraction = predicted_magnitude_correct_fraction_80_Methotrexate,
    predicted_magnitude_correct_fraction_NULL = predicted_magnitude_correct_fraction_80_Methotrexate_NULL,
    predicted_mean_final_od = predicted_mean_final_od_80_Methotrexate,
    predicted_sd_final_od = predicted_sd_final_od_80_Methotrexate,
    real_mean_final_od = real_mean_final_od_80_Methotrexate,
    real_sd_final_od = real_sd_final_od_80_Methotrexate
  )
)

# Metrics for Niclosamide
metrics_list$Niclosamide <- list(
  "20" = list(
    top_six_correct = top_six_correct_20_Niclosamide,
    top_six_correct_means = top_six_correct_20_Niclosamide_means,
    top_six_correct_NULL = top_six_correct_20_Niclosamide_NULL,
    top_six_correct_means_NULL = top_six_correct_20_Niclosamide_means_NULL,
    survivors = survivors_20_Niclosamide,
    predicted_magnitude_correct_fraction = predicted_magnitude_correct_fraction_20_Niclosamide,
    predicted_magnitude_correct_fraction_NULL = predicted_magnitude_correct_fraction_20_Niclosamide_NULL,
    predicted_mean_final_od = predicted_mean_final_od_20_Niclosamide,
    predicted_sd_final_od = predicted_sd_final_od_20_Niclosamide,
    real_mean_final_od = real_mean_final_od_20_Niclosamide,
    real_sd_final_od = real_sd_final_od_20_Niclosamide
  ),
  "80" = list(
    top_six_correct = top_six_correct_80_Niclosamide,
    top_six_correct_means = top_six_correct_80_Niclosamide_means,
    top_six_correct_NULL = top_six_correct_80_Niclosamide_NULL,
    top_six_correct_means_NULL = top_six_correct_80_Niclosamide_means_NULL,
    survivors = survivors_80_Niclosamide,
    predicted_magnitude_correct_fraction = predicted_magnitude_correct_fraction_80_Niclosamide,
    predicted_magnitude_correct_fraction_NULL = predicted_magnitude_correct_fraction_80_Niclosamide_NULL,
    predicted_mean_final_od = predicted_mean_final_od_80_Niclosamide,
    predicted_sd_final_od = predicted_sd_final_od_80_Niclosamide,
    real_mean_final_od = real_mean_final_od_80_Niclosamide,
    real_sd_final_od = real_sd_final_od_80_Niclosamide
  ),
  "160" = list(
    top_six_correct = top_six_correct_160_Niclosamide,
    top_six_correct_means = top_six_correct_160_Niclosamide_means,
    top_six_correct_NULL = top_six_correct_160_Niclosamide_NULL,
    top_six_correct_means_NULL = top_six_correct_160_Niclosamide_means_NULL,
    survivors = survivors_160_Niclosamide,
    predicted_magnitude_correct_fraction = predicted_magnitude_correct_fraction_160_Niclosamide,
    predicted_magnitude_correct_fraction_NULL = predicted_magnitude_correct_fraction_160_Niclosamide_NULL,
    predicted_mean_final_od = predicted_mean_final_od_160_Niclosamide,
    predicted_sd_final_od = predicted_sd_final_od_160_Niclosamide,
    real_mean_final_od = real_mean_final_od_160_Niclosamide,
    real_sd_final_od = real_sd_final_od_160_Niclosamide
  )
)

# Metrics for Nifurtimox
metrics_list$Nifurtimox <- list(
  "2.5" = list(
    top_six_correct = top_six_correct_2.5_Nifurtimox,
    top_six_correct_means = top_six_correct_2.5_Nifurtimox_means,
    top_six_correct_NULL = top_six_correct_2.5_Nifurtimox_NULL,
    top_six_correct_means_NULL = top_six_correct_2.5_Nifurtimox_means_NULL,
    survivors = survivors_2.5_Nifurtimox,
    predicted_magnitude_correct_fraction = predicted_magnitude_correct_fraction_2.5_Nifurtimox,
    predicted_magnitude_correct_fraction_NULL = predicted_magnitude_correct_fraction_2.5_Nifurtimox_NULL,
    predicted_mean_final_od = predicted_mean_final_od_2.5_Nifurtimox,
    predicted_sd_final_od = predicted_sd_final_od_2.5_Nifurtimox,
    real_mean_final_od = real_mean_final_od_2.5_Nifurtimox,
    real_sd_final_od = real_sd_final_od_2.5_Nifurtimox
  ),
  "20" = list(
    top_six_correct = top_six_correct_20_Nifurtimox,
    top_six_correct_means = top_six_correct_20_Nifurtimox_means,
    top_six_correct_NULL = top_six_correct_20_Nifurtimox_NULL,
    top_six_correct_means_NULL = top_six_correct_20_Nifurtimox_means_NULL,
    survivors = survivors_20_Nifurtimox,
    predicted_magnitude_correct_fraction = predicted_magnitude_correct_fraction_20_Nifurtimox,
    predicted_magnitude_correct_fraction_NULL = predicted_magnitude_correct_fraction_20_Nifurtimox_NULL,
    predicted_mean_final_od = predicted_mean_final_od_20_Nifurtimox,
    predicted_sd_final_od = predicted_sd_final_od_20_Nifurtimox,
    real_mean_final_od = real_mean_final_od_20_Nifurtimox,
    real_sd_final_od = real_sd_final_od_20_Nifurtimox
  ),
  "35" = list(
    top_six_correct = top_six_correct_35_Nifurtimox,
    top_six_correct_means = top_six_correct_35_Nifurtimox_means,
    top_six_correct_NULL = top_six_correct_35_Nifurtimox_NULL,
    top_six_correct_means_NULL = top_six_correct_35_Nifurtimox_means_NULL,
    survivors = survivors_35_Nifurtimox,
    predicted_magnitude_correct_fraction = predicted_magnitude_correct_fraction_35_Nifurtimox,
    predicted_magnitude_correct_fraction_NULL = predicted_magnitude_correct_fraction_35_Nifurtimox_NULL,
    predicted_mean_final_od = predicted_mean_final_od_35_Nifurtimox,
    predicted_sd_final_od = predicted_sd_final_od_35_Nifurtimox,
    real_mean_final_od = real_mean_final_od_35_Nifurtimox,
    real_sd_final_od = real_sd_final_od_35_Nifurtimox
  )
)

# Metrics for Olanzapine
metrics_list$Olanzapine <- list(
  "5" = list(
    top_six_correct = top_six_correct_5_Olanzapine,
    top_six_correct_means = top_six_correct_5_Olanzapine_means,
    top_six_correct_NULL = top_six_correct_5_Olanzapine_NULL,
    top_six_correct_means_NULL = top_six_correct_5_Olanzapine_means_NULL,
    survivors = survivors_5_Olanzapine,
    predicted_magnitude_correct_fraction = predicted_magnitude_correct_fraction_5_Olanzapine,
    predicted_magnitude_correct_fraction_NULL = predicted_magnitude_correct_fraction_5_Olanzapine_NULL,
    predicted_mean_final_od = predicted_mean_final_od_5_Olanzapine,
    predicted_sd_final_od = predicted_sd_final_od_5_Olanzapine,
    real_mean_final_od = real_mean_final_od_5_Olanzapine,
    real_sd_final_od = real_sd_final_od_5_Olanzapine
  ),
  "20" = list(
    top_six_correct = top_six_correct_20_Olanzapine,
    top_six_correct_means = top_six_correct_20_Olanzapine_means,
    top_six_correct_NULL = top_six_correct_20_Olanzapine_NULL,
    top_six_correct_means_NULL = top_six_correct_20_Olanzapine_means_NULL,
    survivors = survivors_20_Olanzapine,
    predicted_magnitude_correct_fraction = predicted_magnitude_correct_fraction_20_Olanzapine,
    predicted_magnitude_correct_fraction_NULL = predicted_magnitude_correct_fraction_20_Olanzapine_NULL,
    predicted_mean_final_od = predicted_mean_final_od_20_Olanzapine,
    predicted_sd_final_od = predicted_sd_final_od_20_Olanzapine,
    real_mean_final_od = real_mean_final_od_20_Olanzapine,
    real_sd_final_od = real_sd_final_od_20_Olanzapine
  ),
  "80" = list(
    top_six_correct = top_six_correct_80_Olanzapine,
    top_six_correct_means = top_six_correct_80_Olanzapine_means,
    top_six_correct_NULL = top_six_correct_80_Olanzapine_NULL,
    top_six_correct_means_NULL = top_six_correct_80_Olanzapine_means_NULL,
    survivors = survivors_80_Olanzapine,
    predicted_magnitude_correct_fraction = predicted_magnitude_correct_fraction_80_Olanzapine,
    predicted_magnitude_correct_fraction_NULL = predicted_magnitude_correct_fraction_80_Olanzapine_NULL,
    predicted_mean_final_od = predicted_mean_final_od_80_Olanzapine,
    predicted_sd_final_od = predicted_sd_final_od_80_Olanzapine,
    real_mean_final_od = real_mean_final_od_80_Olanzapine,
    real_sd_final_od = real_sd_final_od_80_Olanzapine
  )
)

# Metrics for Omeprazole
metrics_list$Omeprazole <- list(
  "5" = list(
    top_six_correct = top_six_correct_5_Omeprazole,
    top_six_correct_means = top_six_correct_5_Omeprazole_means,
    top_six_correct_NULL = top_six_correct_5_Omeprazole_NULL,
    top_six_correct_means_NULL = top_six_correct_5_Omeprazole_means_NULL,
    survivors = survivors_5_Omeprazole,
    predicted_magnitude_correct_fraction = predicted_magnitude_correct_fraction_5_Omeprazole,
    predicted_magnitude_correct_fraction_NULL = predicted_magnitude_correct_fraction_5_Omeprazole_NULL,
    predicted_mean_final_od = predicted_mean_final_od_5_Omeprazole,
    predicted_sd_final_od = predicted_sd_final_od_5_Omeprazole,
    real_mean_final_od = real_mean_final_od_5_Omeprazole,
    real_sd_final_od = real_sd_final_od_5_Omeprazole
  ),
  "20" = list(
    top_six_correct = top_six_correct_20_Omeprazole,
    top_six_correct_means = top_six_correct_20_Omeprazole_means,
    top_six_correct_NULL = top_six_correct_20_Omeprazole_NULL,
    top_six_correct_means_NULL = top_six_correct_20_Omeprazole_means_NULL,
    survivors = survivors_20_Omeprazole,
    predicted_magnitude_correct_fraction = predicted_magnitude_correct_fraction_20_Omeprazole,
    predicted_magnitude_correct_fraction_NULL = predicted_magnitude_correct_fraction_20_Omeprazole_NULL,
    predicted_mean_final_od = predicted_mean_final_od_20_Omeprazole,
    predicted_sd_final_od = predicted_sd_final_od_20_Omeprazole,
    real_mean_final_od = real_mean_final_od_20_Omeprazole,
    real_sd_final_od = real_sd_final_od_20_Omeprazole
  ),
  "80" = list(
    top_six_correct = top_six_correct_80_Omeprazole,
    top_six_correct_means = top_six_correct_80_Omeprazole_means,
    top_six_correct_NULL = top_six_correct_80_Omeprazole_NULL,
    top_six_correct_means_NULL = top_six_correct_80_Omeprazole_means_NULL,
    survivors = survivors_80_Omeprazole,
    predicted_magnitude_correct_fraction = predicted_magnitude_correct_fraction_80_Omeprazole,
    predicted_magnitude_correct_fraction_NULL = predicted_magnitude_correct_fraction_80_Omeprazole_NULL,
    predicted_mean_final_od = predicted_mean_final_od_80_Omeprazole,
    predicted_sd_final_od = predicted_sd_final_od_80_Omeprazole,
    real_mean_final_od = real_mean_final_od_80_Omeprazole,
    real_sd_final_od = real_sd_final_od_80_Omeprazole
  )
)

# Metrics for Oxolinic acid
metrics_list$Oxolinic_acid <- list(
  "0.5" = list(
    top_six_correct = top_six_correct_0.5_Oxolinic_acid,
    top_six_correct_means = top_six_correct_0.5_Oxolinic_acid_means,
    top_six_correct_NULL = top_six_correct_0.5_Oxolinic_acid_NULL,
    top_six_correct_means_NULL = top_six_correct_0.5_Oxolinic_acid_means_NULL,
    survivors = survivors_0.5_Oxolinic_acid,
    predicted_magnitude_correct_fraction = predicted_magnitude_correct_fraction_0.5_Oxolinic_acid,
    predicted_magnitude_correct_fraction_NULL = predicted_magnitude_correct_fraction_0.5_Oxolinic_acid_NULL,
    predicted_mean_final_od = predicted_mean_final_od_0.5_Oxolinic_acid,
    predicted_sd_final_od = predicted_sd_final_od_0.5_Oxolinic_acid,
    real_mean_final_od = real_mean_final_od_0.5_Oxolinic_acid,
    real_sd_final_od = real_sd_final_od_0.5_Oxolinic_acid
  ),
  "2.5" = list(
    top_six_correct = top_six_correct_2.5_Oxolinic_acid,
    top_six_correct_means = top_six_correct_2.5_Oxolinic_acid_means,
    top_six_correct_NULL = top_six_correct_2.5_Oxolinic_acid_NULL,
    top_six_correct_means_NULL = top_six_correct_2.5_Oxolinic_acid_means_NULL,
    survivors = survivors_2.5_Oxolinic_acid,
    predicted_magnitude_correct_fraction = predicted_magnitude_correct_fraction_2.5_Oxolinic_acid,
    predicted_magnitude_correct_fraction_NULL = predicted_magnitude_correct_fraction_2.5_Oxolinic_acid_NULL,
    predicted_mean_final_od = predicted_mean_final_od_2.5_Oxolinic_acid,
    predicted_sd_final_od = predicted_sd_final_od_2.5_Oxolinic_acid,
    real_mean_final_od = real_mean_final_od_2.5_Oxolinic_acid,
    real_sd_final_od = real_sd_final_od_2.5_Oxolinic_acid
  ),
  "20" = list(
    top_six_correct = top_six_correct_20_Oxolinic_acid,
    top_six_correct_means = top_six_correct_20_Oxolinic_acid_means,
    top_six_correct_NULL = top_six_correct_20_Oxolinic_acid_NULL,
    top_six_correct_means_NULL = top_six_correct_20_Oxolinic_acid_means_NULL,
    survivors = survivors_20_Oxolinic_acid,
    predicted_magnitude_correct_fraction = predicted_magnitude_correct_fraction_20_Oxolinic_acid,
    predicted_magnitude_correct_fraction_NULL = predicted_magnitude_correct_fraction_20_Oxolinic_acid_NULL,
    predicted_mean_final_od = predicted_mean_final_od_20_Oxolinic_acid,
    predicted_sd_final_od = predicted_sd_final_od_20_Oxolinic_acid,
    real_mean_final_od = real_mean_final_od_20_Oxolinic_acid,
    real_sd_final_od = real_sd_final_od_20_Oxolinic_acid
  )
)

# Metrics for Sertindole
metrics_list$Sertindole <- list(
  "5" = list(
    top_six_correct = top_six_correct_5_Sertindole,
    top_six_correct_means = top_six_correct_5_Sertindole_means,
    top_six_correct_NULL = top_six_correct_5_Sertindole_NULL,
    top_six_correct_means_NULL = top_six_correct_5_Sertindole_means_NULL,
    survivors = survivors_5_Sertindole,
    predicted_magnitude_correct_fraction = predicted_magnitude_correct_fraction_5_Sertindole,
    predicted_magnitude_correct_fraction_NULL = predicted_magnitude_correct_fraction_5_Sertindole_NULL,
    predicted_mean_final_od = predicted_mean_final_od_5_Sertindole,
    predicted_sd_final_od = predicted_sd_final_od_5_Sertindole,
    real_mean_final_od = real_mean_final_od_5_Sertindole,
    real_sd_final_od = real_sd_final_od_5_Sertindole
  ),
  "20" = list(
    top_six_correct = top_six_correct_20_Sertindole,
    top_six_correct_means = top_six_correct_20_Sertindole_means,
    top_six_correct_NULL = top_six_correct_20_Sertindole_NULL,
    top_six_correct_means_NULL = top_six_correct_20_Sertindole_means_NULL,
    survivors = survivors_20_Sertindole,
    predicted_magnitude_correct_fraction = predicted_magnitude_correct_fraction_20_Sertindole,
    predicted_magnitude_correct_fraction_NULL = predicted_magnitude_correct_fraction_20_Sertindole_NULL,
    predicted_mean_final_od = predicted_mean_final_od_20_Sertindole,
    predicted_sd_final_od = predicted_sd_final_od_20_Sertindole,
    real_mean_final_od = real_mean_final_od_20_Sertindole,
    real_sd_final_od = real_sd_final_od_20_Sertindole
  ),
  "80" = list(
    top_six_correct = top_six_correct_80_Sertindole,
    top_six_correct_means = top_six_correct_80_Sertindole_means,
    top_six_correct_NULL = top_six_correct_80_Sertindole_NULL,
    top_six_correct_means_NULL = top_six_correct_80_Sertindole_means_NULL,
    survivors = survivors_80_Sertindole,
    predicted_magnitude_correct_fraction = predicted_magnitude_correct_fraction_80_Sertindole,
    predicted_magnitude_correct_fraction_NULL = predicted_magnitude_correct_fraction_80_Sertindole_NULL,
    predicted_mean_final_od = predicted_mean_final_od_80_Sertindole,
    predicted_sd_final_od = predicted_sd_final_od_80_Sertindole,
    real_mean_final_od = real_mean_final_od_80_Sertindole,
    real_sd_final_od = real_sd_final_od_80_Sertindole
  )
)

# Metrics for Simvastatin
metrics_list$Simvastatin <- list(
  "5" = list(
    top_six_correct = top_six_correct_5_Simvastatin,
    top_six_correct_means = top_six_correct_5_Simvastatin_means,
    top_six_correct_NULL = top_six_correct_5_Simvastatin_NULL,
    top_six_correct_means_NULL = top_six_correct_5_Simvastatin_means_NULL,
    survivors = survivors_5_Simvastatin,
    predicted_magnitude_correct_fraction = predicted_magnitude_correct_fraction_5_Simvastatin,
    predicted_magnitude_correct_fraction_NULL = predicted_magnitude_correct_fraction_5_Simvastatin_NULL,
    predicted_mean_final_od = predicted_mean_final_od_5_Simvastatin,
    predicted_sd_final_od = predicted_sd_final_od_5_Simvastatin,
    real_mean_final_od = real_mean_final_od_5_Simvastatin,
    real_sd_final_od = real_sd_final_od_5_Simvastatin
  ),
  "20" = list(
    top_six_correct = top_six_correct_20_Simvastatin,
    top_six_correct_means = top_six_correct_20_Simvastatin_means,
    top_six_correct_NULL = top_six_correct_20_Simvastatin_NULL,
    top_six_correct_means_NULL = top_six_correct_20_Simvastatin_means_NULL,
    survivors = survivors_20_Simvastatin,
    predicted_magnitude_correct_fraction = predicted_magnitude_correct_fraction_20_Simvastatin,
    predicted_magnitude_correct_fraction_NULL = predicted_magnitude_correct_fraction_20_Simvastatin_NULL,
    predicted_mean_final_od = predicted_mean_final_od_20_Simvastatin,
    predicted_sd_final_od = predicted_sd_final_od_20_Simvastatin,
    real_mean_final_od = real_mean_final_od_20_Simvastatin,
    real_sd_final_od = real_sd_final_od_20_Simvastatin
  ),
  "80" = list(
    top_six_correct = top_six_correct_80_Simvastatin,
    top_six_correct_means = top_six_correct_80_Simvastatin_means,
    top_six_correct_NULL = top_six_correct_80_Simvastatin_NULL,
    top_six_correct_means_NULL = top_six_correct_80_Simvastatin_means_NULL,
    survivors = survivors_80_Simvastatin,
    predicted_magnitude_correct_fraction = predicted_magnitude_correct_fraction_80_Simvastatin,
    predicted_magnitude_correct_fraction_NULL = predicted_magnitude_correct_fraction_80_Simvastatin_NULL,
    predicted_mean_final_od = predicted_mean_final_od_80_Simvastatin,
    predicted_sd_final_od = predicted_sd_final_od_80_Simvastatin,
    real_mean_final_od = real_mean_final_od_80_Simvastatin,
    real_sd_final_od = real_sd_final_od_80_Simvastatin
  )
)

# Metrics for Tamoxifen
metrics_list$Tamoxifen <- list(
  "20" = list(
    top_six_correct = top_six_correct_20_Tamoxifen,
    top_six_correct_means = top_six_correct_20_Tamoxifen_means,
    top_six_correct_NULL = top_six_correct_20_Tamoxifen_NULL,
    top_six_correct_means_NULL = top_six_correct_20_Tamoxifen_means_NULL,
    survivors = survivors_20_Tamoxifen,
    predicted_magnitude_correct_fraction = predicted_magnitude_correct_fraction_20_Tamoxifen,
    predicted_magnitude_correct_fraction_NULL = predicted_magnitude_correct_fraction_20_Tamoxifen_NULL,
    predicted_mean_final_od = predicted_mean_final_od_20_Tamoxifen,
    predicted_sd_final_od = predicted_sd_final_od_20_Tamoxifen,
    real_mean_final_od = real_mean_final_od_20_Tamoxifen,
    real_sd_final_od = real_sd_final_od_20_Tamoxifen
  ),
  "80" = list(
    top_six_correct = top_six_correct_80_Tamoxifen,
    top_six_correct_means = top_six_correct_80_Tamoxifen_means,
    top_six_correct_NULL = top_six_correct_80_Tamoxifen_NULL,
    top_six_correct_means_NULL = top_six_correct_80_Tamoxifen_means_NULL,
    survivors = survivors_80_Tamoxifen,
    predicted_magnitude_correct_fraction = predicted_magnitude_correct_fraction_80_Tamoxifen,
    predicted_magnitude_correct_fraction_NULL = predicted_magnitude_correct_fraction_80_Tamoxifen_NULL,
    predicted_mean_final_od = predicted_mean_final_od_80_Tamoxifen,
    predicted_sd_final_od = predicted_sd_final_od_80_Tamoxifen,
    real_mean_final_od = real_mean_final_od_80_Tamoxifen,
    real_sd_final_od = real_sd_final_od_80_Tamoxifen
  ),
  "320" = list(
    top_six_correct = top_six_correct_320_Tamoxifen,
    top_six_correct_means = top_six_correct_320_Tamoxifen_means,
    top_six_correct_NULL = top_six_correct_320_Tamoxifen_NULL,
    top_six_correct_means_NULL = top_six_correct_320_Tamoxifen_means_NULL,
    survivors = survivors_320_Tamoxifen,
    predicted_magnitude_correct_fraction = predicted_magnitude_correct_fraction_320_Tamoxifen,
    predicted_magnitude_correct_fraction_NULL = predicted_magnitude_correct_fraction_320_Tamoxifen_NULL,
    predicted_mean_final_od = predicted_mean_final_od_320_Tamoxifen,
    predicted_sd_final_od = predicted_sd_final_od_320_Tamoxifen,
    real_mean_final_od = real_mean_final_od_320_Tamoxifen,
    real_sd_final_od = real_sd_final_od_320_Tamoxifen
  )
)




#metrics_df for dynamic drugs, metrics_df for fixed/static drugs
metrics_df <- bind_rows(
  lapply(names(metrics_list), function(drug) {
    bind_rows(
      lapply(names(metrics_list[[drug]]), function(concentration) {
        details <- metrics_list[[drug]][[concentration]]
        data.frame(
          drug = drug,
          concentration = as.numeric(concentration),
          top_six_correct = details$top_six_correct,
          top_six_correct_means = details$top_six_correct_means,
          top_six_correct_NULL = details$top_six_correct_NULL,
          top_six_correct_means_NULL = details$top_six_correct_means_NULL,
          survivors = details$survivors,
          predicted_magnitude_correct_fraction = details$predicted_magnitude_correct_fraction,
          predicted_magnitude_correct_fraction_NULL = details$predicted_magnitude_correct_fraction_NULL,
          predicted_mean_final_od = details$predicted_mean_final_od,
          predicted_sd_final_od = details$predicted_sd_final_od,
          real_mean_final_od = details$real_mean_final_od,
          real_sd_final_od = details$real_sd_final_od
        )
      })
    )
  }), .id = "id"
)



#compare modelled versus measured community final ODs

ggplot(metrics_df, aes(x = predicted_mean_final_od, y = real_mean_final_od, color = drug)) +
  scale_color_manual(values = drug_colours) +  
  geom_errorbar(aes(ymin = real_mean_final_od - real_sd_final_od, ymax = real_mean_final_od + real_sd_final_od), width = 0.04, alpha = 0.5) +
  geom_errorbarh(aes(xmin = predicted_mean_final_od - predicted_sd_final_od, xmax = predicted_mean_final_od + predicted_sd_final_od), height = 0.04, alpha = 0.5) +
  geom_abline(slope = 1, intercept = 0, linetype = "dashed", color = "gray") +
  labs(x = "Predicted Mean Final OD", y = "Real Mean Final OD", title = "") +
  xlim(0, 1.2) + 
  ylim(0, 1.2) +
  geom_vline(xintercept = rel_ab_control$mean_com_final_OD[1], linetype = "dashed", color = "red") +  #mean final OD in community
  geom_vline(xintercept = (rel_ab_control$mean_com_final_OD[1] - rel_ab_control$sd_com_final_OD[1]), linetype = "dashed", color = "red", alpha = 0.5) +  #mean - sd final OD in community
  geom_vline(xintercept = (rel_ab_control$mean_com_final_OD[1] + rel_ab_control$sd_com_final_OD[1]), linetype = "dashed", color = "red", alpha = 0.5) +  #mean + sd final OD in community
  geom_hline(yintercept = rel_ab_control$mean_com_final_OD[1], linetype = "dashed", color = "red") +  #mean final OD in community
  geom_hline(yintercept = (rel_ab_control$mean_com_final_OD[1] - rel_ab_control$sd_com_final_OD[1]), linetype = "dashed", color = "red", alpha = 0.5) +  #mean - sd final OD in community
  geom_hline(yintercept = (rel_ab_control$mean_com_final_OD[1] + rel_ab_control$sd_com_final_OD[1]), linetype = "dashed", color = "red", alpha = 0.5) +  #mean + sd final OD in community
  geom_point(aes(size = concentration), alpha = 0.7) +
  theme_minimal()

summary(lm(real_mean_final_od ~ predicted_mean_final_od, data = metrics_df))


metrics_model_performance <- metrics_df[, c(2:10)]
#metrics_model_performance_0 <- metrics_df_0[, c(2:10)]


metrics_model_performance <- metrics_model_performance %>%
  dplyr::mutate(drug = case_when(
    drug == "beta_estradiol_17_valerate" ~ "beta-estradiol 17-valerate",
    drug == "Oxolinic_acid" ~ "Oxolinic acid",
    TRUE ~ drug
  ))

            
All_metrics_combined <- AUCs_and_BC_joined1 %>%
  dplyr::left_join(metrics_model_performance, by = c("drug", "concentration"))

#take out the 0 Niclosamide:
All_metrics_combined <- subset(All_metrics_combined, concentration > 0)

#All_metrics_combined1 <- All_metrics_combined[, c(1:9, 11:14)]
All_metrics_combined1 <- All_metrics_combined

#Add community mean and sd max OD:
enhanced_mean_maxOD_focus_drugs

All_metrics_combined1a <- All_metrics_combined1 %>%
  dplyr::left_join(enhanced_mean_maxOD_focus_drugs %>% select(drug, concentration, mean_maxOD, sd_maxOD), by = c("drug", "concentration"))

#Add standard deviation Shannon diff relative to control (by means) info:
All_metrics_combined1b <- All_metrics_combined1a %>%
  dplyr::left_join(SDs_Shannon_diff %>% select(drug, concentration, SD_Shannon_diff), by = c("drug", "concentration"))



##Now, we have all metrics together; both measured as well as predicted/modelled metrics

##First: add means to wherever there is NA for the metabolomics metrics:
mean_Prop_left_24h_community <- mean(All_metrics_combined1b$Prop_left_24h_community, na.rm = TRUE)
mean_Prop_left_24h_background <- mean(All_metrics_combined1b$Prop_left_24h_background, na.rm = TRUE)

#Replace NA values with the calculated mean
All_metrics_combined1c <- All_metrics_combined1b %>%
  dplyr::mutate(Prop_left_24h_community = ifelse(is.na(Prop_left_24h_community), mean_Prop_left_24h_community, Prop_left_24h_community))

All_metrics_combined2 <- All_metrics_combined1c %>%
  dplyr::mutate(Prop_left_24h_background = ifelse(is.na(Prop_left_24h_background), mean_Prop_left_24h_background, Prop_left_24h_background))

#add the standard deviation of drug degradation by the community to the dataframe:
# All_metrics_combined3 <- All_metrics_combined2 %>%
#   dplyr::left_join(drug_dynamics %>% select(Drug, SD_drug_community), by = c("drug" = "Drug"))

mean_concentration_left_after_24h <- mean(All_metrics_combined2$Concentration_left_after_24h, na.rm = TRUE)

All_metrics_combined3 <- All_metrics_combined2 %>%
  dplyr::mutate(Concentration_left_after_24h = ifelse(is.na(Concentration_left_after_24h), mean_concentration_left_after_24h, Concentration_left_after_24h))


mean_sd_drug_degradation <- mean(All_metrics_combined2$SD_drug_community, na.rm = TRUE)

All_metrics_combined4 <- All_metrics_combined3 %>%
  dplyr::mutate(SD_drug_community = ifelse(is.na(SD_drug_community), mean_sd_drug_degradation, SD_drug_community))

#perform a stepwise linear model on model quality outcome
library(MASS)

full_model <- lm(predicted_magnitude_correct_fraction ~ mean_abs_change_AUC + sd_abs_change_AUC + dissimilarity + Prop_left_24h_community + Prop_left_24h_background + survivors + SD_drug_community + concentration + mean_maxOD + sd_maxOD + SD_Shannon_diff + Concentration_left_after_24h, data = All_metrics_combined4)
stepwise_model <- stepAIC(full_model, direction = "both")
summary(stepwise_model)



# plot(All_metrics_combined4$dissimilarity, All_metrics_combined4$predicted_magnitude_correct_fraction)
# plot(subset(All_metrics_combined4, concentration < 320)$concentration, subset(All_metrics_combined4, concentration < 320)$predicted_magnitude_correct_fraction)
# plot(All_metrics_combined4$mean_maxOD, All_metrics_combined4$predicted_magnitude_correct_fraction)
# plot(All_metrics_combined4$Concentration_left_after_24h, All_metrics_combined4$predicted_magnitude_correct_fraction)
# plot(All_metrics_combined4$survivors, All_metrics_combined4$predicted_magnitude_correct_fraction)
# plot(All_metrics_combined4$Prop_left_24h_community, All_metrics_combined4$predicted_magnitude_correct_fraction)


full_model1 <- lm(top_six_correct_means ~ mean_abs_change_AUC + sd_abs_change_AUC + dissimilarity + Prop_left_24h_community + Prop_left_24h_background + survivors + SD_drug_community + concentration + mean_maxOD + sd_maxOD + SD_Shannon_diff + Concentration_left_after_24h, data = All_metrics_combined4)
stepwise_model1 <- stepAIC(full_model1, direction = "both")
summary(stepwise_model1)

# plot(All_metrics_combined4$dissimilarity, All_metrics_combined4$top_six_correct_means)
# plot(All_metrics_combined4$Prop_left_24h_community, All_metrics_combined4$top_six_correct_means)
# plot(All_metrics_combined4$survivors , All_metrics_combined4$top_six_correct_means)
# plot(All_metrics_combined4$SD_drug_community, All_metrics_combined4$top_six_correct_means)
# plot(All_metrics_combined4$Concentration_left_after_24h, All_metrics_combined4$top_six_correct_means)
# plot(All_metrics_combined4$sd_maxOD, All_metrics_combined4$top_six_correct_means)
# plot(All_metrics_combined4$SD_Shannon_diff, All_metrics_combined4$top_six_correct_means)

##In which conditions does the NULL model perform better, and is that predictable?
str(All_metrics_combined4)

All_metrics_combined4$Null_vs_model_survivors_predicted <- All_metrics_combined4$predicted_magnitude_correct_fraction - All_metrics_combined4$predicted_magnitude_correct_fraction_NULL
#plot(All_metrics_combined4$Null_vs_model_survivors_predicted, All_metrics_combined4$mean_abs_change_AUC)

#Here, the object All_metrics_combined4_0 was formed by running the sims from line 2100 onwards without drug dynamics (dD/dt = 0)
All_metrics_combined4_0$Null_vs_model_survivors_predicted <- All_metrics_combined4_0$predicted_magnitude_correct_fraction - All_metrics_combined4_0$predicted_magnitude_correct_fraction_NULL
#plot(All_metrics_combined4_0$Null_vs_model_survivors_predicted, All_metrics_combined4_0$mean_abs_change_AUC)

All_metrics_combined4$Null_vs_model_top6 <- All_metrics_combined4$top_six_correct - All_metrics_combined4$top_six_correct_NULL
#plot(All_metrics_combined4$Null_vs_model_top6, All_metrics_combined4$mean_abs_change_AUC)

All_metrics_combined4_0$Null_vs_model_top6 <- All_metrics_combined4_0$top_six_correct - All_metrics_combined4_0$top_six_correct_NULL
#plot(All_metrics_combined4_0$Null_vs_model_top6, All_metrics_combined4_0$mean_abs_change_AUC)

#so the model is better at predicting the top 6 correctly than the null model for a greater usbset of drugs than those that don't
All_metrics_combined4$Null_vs_model_top6_means <- All_metrics_combined4$top_six_correct_means - All_metrics_combined4$top_six_correct_means_NULL
#plot(All_metrics_combined4$Null_vs_model_top6_means, All_metrics_combined4$mean_abs_change_AUC)

All_metrics_combined4$Null_vs_model_top6_means <- All_metrics_combined4$top_six_correct_means - All_metrics_combined4$top_six_correct_means_NULL
#plot(All_metrics_combined4$Null_vs_model_top6_means, All_metrics_combined4$mean_abs_change_AUC)



##what have these drugs in common though?
full_model2 <- lm(Null_vs_model_top6_means ~ mean_abs_change_AUC + sd_abs_change_AUC + dissimilarity + Prop_left_24h_community + Prop_left_24h_background + survivors + SD_drug_community + concentration + mean_maxOD + sd_maxOD + SD_Shannon_diff + Concentration_left_after_24h, data = All_metrics_combined4)
stepwise_model2 <- stepAIC(full_model2, direction = "both")
summary(stepwise_model2)

plot(subset(All_metrics_combined4, Null_vs_model_top6_means > -6)$Null_vs_model_top6_means, subset(All_metrics_combined4, Null_vs_model_top6_means > -6)$dissimilarity)
plot(All_metrics_combined4$Null_vs_model_top6_means, All_metrics_combined4$concentration)
plot(subset(All_metrics_combined4, Null_vs_model_top6_means > 0)$Null_vs_model_top6_means, subset(All_metrics_combined4, Null_vs_model_top6_means > 0)$concentration)
plot(All_metrics_combined4$Null_vs_model_top6_means, All_metrics_combined4$survivors)
plot(subset(All_metrics_combined4, Null_vs_model_top6_means > 0)$Null_vs_model_top6_means, subset(All_metrics_combined4, Null_vs_model_top6_means > 0)$survivors)



##for survivors correctly predicted, however, the null model outperforms our model in 45/87 (51.72%):
#53/67 for fixed drug dynamics
sum(All_metrics_combined4$Null_vs_model_survivors_predicted < 0)
sum(All_metrics_combined4$Null_vs_model_survivors_predicted < 0) / 87

#not assuming fixed drugs is 52/67 = 59.77%
sum(All_metrics_combined4_0$Null_vs_model_survivors_predicted < 0)
sum(All_metrics_combined4_0$Null_vs_model_survivors_predicted < 0) / 87

#whereas in predicting top 6 (by means), the null model only outperforms the model in 5 cases: 5/87  ~ 6%
#17/87 for fixed drugs
sum(All_metrics_combined4$Null_vs_model_top6_means < 0)
sum(All_metrics_combined4$Null_vs_model_top6_means < 0) / 87

#16 cases in fixed drugs: 16/87 = 18.4%
sum(All_metrics_combined4_0$Null_vs_model_top6_means < 0)
sum(All_metrics_combined4_0$Null_vs_model_top6_means < 0) / 87


#our model outperforms the null model in 14/87 = 16% of the cases
sum(All_metrics_combined4$Null_vs_model_top6 > 0)
sum(All_metrics_combined4$Null_vs_model_top6 > 0) / 87

#in fixed drug: 17/87 = 19.5%
sum(All_metrics_combined4_0$Null_vs_model_top6 > 0)
sum(All_metrics_combined4_0$Null_vs_model_top6 > 0) / 87

#in most cases (68/87) they perform equally (78%)
sum(All_metrics_combined4$Null_vs_model_top6_means == 0)
sum(All_metrics_combined4$Null_vs_model_top6_means == 0) / 87

#55/87 = 63% in fixed drugs:
sum(All_metrics_combined4_0$Null_vs_model_top6_means == 0)
sum(All_metrics_combined4_0$Null_vs_model_top6_means == 0) / 87



ggplot(subset(All_metrics_combined4, survivors > 5), aes(x = dissimilarity, y = predicted_magnitude_correct_fraction, color  = drug, size = concentration)) +
  geom_smooth(method = "lm", se = FALSE, color = "grey", linetype = "dashed", alpha = 0.5) +  
  geom_point(alpha = 0.7) +  
  labs(
    title = "",
    x = "Bray-Curtis Dissimilarity from Control",
    y = "Fraction Survivors (>1%) Magnitude Correctly Predicted",
    size = "Concentration
tested"
  ) +
  scale_color_manual(values = drug_colours) +  
  theme_minimal()



ggplot(All_metrics_combined4, aes(x = dissimilarity, y = predicted_magnitude_correct_fraction, alpha  = mean_abs_change_AUC, size = concentration)) +
  geom_point() +  
  #geom_smooth(method = "lm", se = FALSE, color = "red") +  # Linear regression line without confidence interval
  labs(
    title = "",
    x = "Dissimilarity",
    y = "Fraction Survivors (>1%) Magnitude Correctly Predicted",
    alpha = "Mean Impact 
on Monoculture", 
    size = "Concentration
tested"
  ) +
  scale_color_manual(values = drug_colours) +  
  theme_minimal()


ggplot(All_metrics_combined4, aes(x = dissimilarity, y = predicted_magnitude_correct_fraction, alpha  = survivors, size = concentration)) +
  geom_smooth(method = "lm", se = FALSE, color = "red", alpha = 0.5, linetype = "dashed") +  
  geom_point() +  
  labs(
    title = "Relationship Between Dissimilarity and Predicted Magnitude Correct Fraction",
    x = "Bray-Curtis Dissimilarity from Control",
    y = "Fraction Species Predicted Magnitude Correct",
    size = "Concentration (uM) tested",
    alpha = "Survivor (>1%) count"
  ) +
  #scale_color_manual(values = drug_colours) +  
  theme_minimal()



cor.test(subset(All_metrics_combined4, survivors > 5)$mean_maxOD, subset(All_metrics_combined4, survivors > 5)$predicted_magnitude_correct_fraction, method = "pearson")
#subset(All_metrics_combined4, survivors > 5)
ggplot(All_metrics_combined4, aes(x = mean_maxOD, y = predicted_magnitude_correct_fraction, color  = drug, size = concentration)) +
  geom_smooth(method = "lm", se = FALSE, color = "grey", linetype = "dashed", alpha = 0.5) +  
  geom_point(alpha = 0.7) +  
  labs(
    title = "",
    x = "mean max OD in community",
    y = "Fraction Survivors (>1%) Magnitude Correctly Predicted",
    size = "Concentration
tested"
  ) +
  scale_color_manual(values = drug_colours) +  
  theme_minimal()

# ggplot(All_metrics_combined4, aes(x = dissimilarity, y = predicted_magnitude_correct_fraction, color = (Function == "Antibiotic"), alpha = survivors, size = concentration)) +
#   geom_point() +
#   geom_smooth(method = "lm", se = FALSE, color = "red", alpha = 0.5, linetype = "dashed") +  
#   scale_color_manual(values = c("FALSE" = "black", "TRUE" = "red")) +
#   labs(
#     title = "Relationship Between Dissimilarity and Predicted Magnitude Correct Fraction",
#     x = "Bray-Curtis Dissimilarity from Control",
#     y = "Predicted Magnitude Correct Fraction",
#     color = "Is Antibiotic",
#     size = "Concentration (uM) tested",
#     alpha = "Survivor (>1%) count"
#   ) +
#   theme_minimal()
ggplot(All_metrics_combined4, aes(x = dissimilarity, y = top_six_correct, size = concentration, color = drug)) +
  geom_smooth(method = "lm", se = FALSE, color = "grey", alpha = 0.5, linetype = "dashed") +  
  geom_point(alpha = 0.7) +  
  labs(
    title = "",
    x = "Bray-Curtis Dissimilarity from Control",
    y = "Top six correctly predicted",
    size = "Concentration (uM) 
tested"
  ) +
  scale_color_manual(values = drug_colours) +  
  theme_minimal()



ggplot(All_metrics_combined4, aes(x = dissimilarity, y = top_six_correct, alpha  = survivors, size = concentration, color = (mean_abs_change_AUC > 0.6))) +
  geom_smooth(method = "lm", se = FALSE, color = "grey", alpha = 0.5, linetype = "dashed") +  
  geom_point() +  
  labs(
    title = "",
    x = "Bray-Curtis Dissimilarity from Control",
    y = "Top six correctly predicted",
    size = "Concentration (uM) 
tested",
    alpha = "Survivor (>1%) count",
    color = "High Mean Monoculture Impact (>0.6)"
  ) +
  scale_color_manual(values = c("FALSE" = "blue", "TRUE" = "red")) +
  #scale_color_manual(values = drug_colours) +  
  theme_minimal()


####

ggplot(All_metrics_combined4, aes(x = dissimilarity, y = top_six_correct, alpha = survivors, size = Prop_left_24h_community, color = (mean_abs_change_AUC > 0.6))) +
  geom_smooth(method = "lm", se = FALSE, color = "grey", alpha = 0.5, linetype = "dashed") +  
  geom_point() +
  labs(
    title = "",
    x = "Bray-Curtis Dissimilarity from Control",
    y = "Top six correctly predicted",
    size = "Proportion drug left",
    alpha = "Survivor (>1%) count",
    color = "High Mean Impact Monoculture (>0.6)"
  ) +
  scale_color_manual(values = c("FALSE" = "blue", "TRUE" = "red")) +
  scale_size_continuous(breaks = quantile(All_metrics_combined4$Prop_left_24h_community, probs = seq(0, 1, by = 0.25)), guide = guide_legend()) +
  theme_minimal()

ggplot(All_metrics_combined4, aes(x = dissimilarity, y = top_six_correct, alpha = survivors, size = Prop_left_24h_community, color = drug)) +
  geom_smooth(method = "lm", se = FALSE, color = "grey", alpha = 0.5, linetype = "dashed") +  
  geom_point() +
  labs(
    title = "",
    x = "Bray-Curtis Dissimilarity from Control",
    y = "Top six correctly predicted",
    size = "Proportion drug left",
    alpha = "Survivor (>1%) count",
    color = "High Mean Impact Monoculture (>0.6)"
  ) +
  scale_color_manual(values = drug_colours) + 
  scale_size_continuous(breaks = quantile(All_metrics_combined4$Prop_left_24h_community, probs = seq(0, 1, by = 0.25)), guide = guide_legend()) +
  theme_minimal()

####


#cor.test(All_metrics_combined4$mean_abs_change_AUC, All_metrics_combined4$top_six_correct, method = "spearman")
#cor.test(All_metrics_combined4$mean_abs_change_AUC, All_metrics_combined4$top_six_correct_means, method = "spearman")

ggplot(All_metrics_combined4, aes(x = mean_abs_change_AUC, y = top_six_correct, size = Prop_left_24h_community, color = drug)) +
  geom_smooth(method = "lm", se = FALSE, color = "grey", alpha = 0.5, linetype = "dashed") +  
  geom_point(alpha = 0.8) +
  labs(
    title = "",
    x = "Mean Impact Monoculture",
    y = "Top six correctly predicted",
    size = "Proportion drug left",
    alpha = "Survivor (>1%) count"
  ) +
  scale_color_manual(values = drug_colours) +  
  scale_size_continuous(breaks = quantile(All_metrics_combined4$Prop_left_24h_community, probs = seq(0, 1, by = 0.25)), guide = guide_legend()) +
  theme_minimal()



cor.test(All_metrics_combined4$mean_abs_change_AUC, All_metrics_combined4$predicted_magnitude_correct_fraction, method = "spearman")

ggplot(All_metrics_combined4, aes(x = mean_abs_change_AUC, y = predicted_magnitude_correct_fraction, alpha = survivors, size = Prop_left_24h_community)) +
  geom_smooth(method = "lm", se = FALSE, color = "grey", alpha = 0.5, linetype = "dashed") +  
  geom_point() +
  labs(
    title = "",
    x = "Mean Impact Monoculture",
    y = "Fraction survivors correctly predicted",
    size = "Proportion drug left
after 24h",
    alpha = "Survivor (>1%) count",
    color = "High Mean Monoculture Impact (>0.6)"
  ) +
  scale_color_manual(values = drug_colours) +  
  scale_size_continuous(breaks = quantile(All_metrics_combined4$Prop_left_24h_community, probs = seq(0, 1, by = 0.25)), guide = guide_legend()) +
  theme_minimal()






cor.test(All_metrics_combined4$Concentration_left_after_24h, All_metrics_combined4$predicted_magnitude_correct_fraction, method = "spearman")

ggplot(All_metrics_combined4, aes(x = Concentration_left_after_24h, y = predicted_magnitude_correct_fraction, alpha = survivors, size = Prop_left_24h_community)) +
  geom_smooth(method = "lm", se = FALSE, color = "grey", alpha = 0.5, linetype = "dashed") +  
  geom_point() +
  labs(
    title = "",
    x = "Concentration left after 24h",
    y = "Fraction survivors correctly predicted",
    size = "Proportion drug left
after 24h",
    alpha = "Survivor (>1%) count",
    color = "High Mean Monoculture Impact (>0.6)"
  ) +
  scale_color_manual(values = drug_colours) +  
  scale_size_continuous(breaks = quantile(All_metrics_combined4$Prop_left_24h_community, probs = seq(0, 1, by = 0.25)), guide = guide_legend()) +
  theme_minimal()


cor.test(All_metrics_combined4$mean_maxOD, All_metrics_combined4$predicted_magnitude_correct_fraction, method = "spearman")

ggplot(All_metrics_combined4, aes(x = mean_maxOD, y = predicted_magnitude_correct_fraction, alpha = survivors, size = Prop_left_24h_community)) +
  geom_smooth(method = "lm", se = FALSE, color = "grey", alpha = 0.5, linetype = "dashed") +  
  geom_point() +
  labs(
    title = "",
    x = "mean max OD",
    y = "Fraction survivors correctly predicted",
    size = "Proportion drug left
after 24h",
    alpha = "Survivor (>1%) count",
    color = "High Mean Monoculture Impact (>0.6)"
  ) +
  scale_color_manual(values = drug_colours) +  
  scale_size_continuous(breaks = quantile(All_metrics_combined4$Prop_left_24h_community, probs = seq(0, 1, by = 0.25)), guide = guide_legend()) +
  theme_minimal()


cor.test(All_metrics_combined4$survivors, All_metrics_combined4$predicted_magnitude_correct_fraction, method = "spearman")

ggplot(All_metrics_combined4, aes(x = survivors, y = predicted_magnitude_correct_fraction, alpha = survivors, size = Prop_left_24h_community)) +
  geom_smooth(method = "lm", se = FALSE, color = "grey", alpha = 0.5, linetype = "dashed") +  
  geom_point() +
  labs(
    title = "",
    x = "Survivors (1%) at endpoint",
    y = "Fraction survivors correctly predicted",
    size = "Proportion drug left
after 24h",
    alpha = "Survivor (>1%) count",
    color = "High Mean Monoculture Impact (>0.6)"
  ) +
  scale_color_manual(values = drug_colours) +  
  scale_size_continuous(breaks = quantile(All_metrics_combined4$Prop_left_24h_community, probs = seq(0, 1, by = 0.25)), guide = guide_legend()) +
  theme_minimal()


cor.test(subset(All_metrics_combined4, mean_abs_change_AUC > 0.6)$Prop_left_24h_community, subset(All_metrics_combined4, mean_abs_change_AUC > 0.6)$predicted_magnitude_correct_fraction, method = "spearman")

ggplot(subset(All_metrics_combined4, mean_abs_change_AUC > 0.6), aes(x = Prop_left_24h_community, y = predicted_magnitude_correct_fraction, alpha = survivors, size = Prop_left_24h_community)) +
  geom_smooth(method = "lm", se = FALSE, color = "grey", alpha = 0.5, linetype = "dashed") +  
  geom_point() +
  labs(
    title = "",
    x = "Proportion of drug left",
    y = "Fraction survivors correctly predicted",
    size = "Proportion drug left
after 24h",
    alpha = "Survivor (>1%) count",
    color = "High Mean Monoculture Impact (>0.6)"
  ) +
  scale_color_manual(values = drug_colours) +  
  scale_size_continuous(breaks = quantile(All_metrics_combined4$Prop_left_24h_community, probs = seq(0, 1, by = 0.25)), guide = guide_legend()) +
  theme_minimal()




cor.test(All_metrics_combined4$Prop_left_24h_community, All_metrics_combined4$predicted_magnitude_correct_fraction, method = "spearman")

ggplot(All_metrics_combined4, aes(x = Prop_left_24h_community, y = predicted_magnitude_correct_fraction, alpha = survivors, size = Prop_left_24h_community)) +
  geom_smooth(method = "lm", se = FALSE, color = "grey", alpha = 0.5, linetype = "dashed") +  
  geom_point() +
  labs(
    title = "",
    x = "Proportion left after 24h",
    y = "Fraction survivors correctly predicted",
    size = "Proportion drug left
after 24h",
    alpha = "Survivor (>1%) count",
    color = "High Mean Monoculture Impact (>0.6)"
  ) +
  scale_color_manual(values = drug_colours) +  
  scale_size_continuous(breaks = quantile(All_metrics_combined4$Prop_left_24h_community, probs = seq(0, 1, by = 0.25)), guide = guide_legend()) +
  theme_minimal()







ggplot(All_metrics_combined4, aes(x = mean_abs_change_AUC, y = predicted_magnitude_correct_fraction, alpha = survivors, size = Prop_left_24h_community)) +
  geom_smooth(method = "lm", se = FALSE, color = "grey", alpha = 0.5, linetype = "dashed") +  
  geom_point() +
  labs(
    title = "",
    x = "Mean Impact Monoculture",
    y = "Fraction survivors correctly predicted",
    size = "Proportion drug left
after 24h",
    alpha = "Survivor (>1%) count",
    color = "High Mean Monoculture Impact (>0.6)"
  ) +
  scale_color_manual(values = drug_colours) +  
  scale_size_continuous(breaks = quantile(All_metrics_combined4$Prop_left_24h_community, probs = seq(0, 1, by = 0.25)), guide = guide_legend()) +
  theme_minimal()




ggplot(All_metrics_combined4, aes(x = Prop_left_24h_community, y = predicted_magnitude_correct_fraction, alpha = survivors, size = conc)) +
  geom_smooth(method = "lm", se = FALSE, color = "grey", alpha = 0.5, linetype = "dashed") +  
  geom_point() +
  labs(
    title = "",
    x = "Proportion drug left after 24h",
    y = "Fraction Species Magnitude correctly predicted",
    size = "Concentration tested",
    alpha = "Survivor (>1%) count",
    color = "High Mean Monoculture Impact (>0.6)"
  ) +
  scale_color_manual(values = drug_colours) +  
  #scale_size_continuous(breaks = quantile(All_metrics_combined4$Prop_left_24h_community, probs = seq(0, 1, by = 0.25)), guide = guide_legend()) +
  theme_minimal()

All_metrics_combined4_measured_only <- subset(All_metrics_combined4, drug != "Acarbose" & drug != "Diacerein" & drug != "beta-estradiol 17-valerate")



cor.test(All_metrics_combined4$mean_abs_change_AUC, All_metrics_combined4$predicted_magnitude_correct_fraction, method = "spearman")
cor.test(All_metrics_combined4_measured_only$Prop_left_24h_community, All_metrics_combined4_measured_only$predicted_magnitude_correct_fraction, method = "spearman")
cor.test(All_metrics_combined4_measured_only$Concentration_left_after_24h, All_metrics_combined4_measured_only$predicted_magnitude_correct_fraction, method = "spearman")
cor.test(All_metrics_combined4$concentration, All_metrics_combined4$predicted_magnitude_correct_fraction, method = "spearman")
cor.test(All_metrics_combined4_measured_only$SD_drug_community, All_metrics_combined4_measured_only$predicted_magnitude_correct_fraction, method = "spearman")
cor.test(All_metrics_combined4$mean_maxOD, All_metrics_combined4$predicted_magnitude_correct_fraction, method = "spearman")

cor.test(subset(All_metrics_combined4, survivors > 5)$mean_abs_change_AUC, subset(All_metrics_combined4, survivors > 5)$top_six_correct, method = "spearman")
cor.test(subset(All_metrics_combined4_measured_only, survivors > 5)$Prop_left_24h_community, subset(All_metrics_combined4_measured_only, survivors > 5)$top_six_correct, method = "spearman")
cor.test(subset(All_metrics_combined4_measured_only, survivors > 5)$Concentration_left_after_24h, subset(All_metrics_combined4_measured_only, survivors > 5)$top_six_correct, method = "spearman")
cor.test(subset(All_metrics_combined4, survivors > 5)$concentration, subset(All_metrics_combined4, survivors > 5)$top_six_correct, method = "spearman")
cor.test(subset(All_metrics_combined4_measured_only, survivors >5)$SD_drug_community, subset(All_metrics_combined4_measured_only, survivors >5)$top_six_correct, method = "spearman")
cor.test(subset(All_metrics_combined4, survivors > 5)$mean_maxOD, subset(All_metrics_combined4, survivors > 5)$top_six_correct, method = "spearman")

cor.test(subset(All_metrics_combined4, survivors > 5)$mean_abs_change_AUC, subset(All_metrics_combined4, survivors > 5)$top_six_correct_means, method = "spearman")
cor.test(subset(All_metrics_combined4_measured_only, survivors > 5)$Prop_left_24h_community, subset(All_metrics_combined4_measured_only, survivors > 5)$top_six_correct_means, method = "spearman")
cor.test(subset(All_metrics_combined4_measured_only, survivors > 5)$Concentration_left_after_24h, subset(All_metrics_combined4_measured_only, survivors > 5)$top_six_correct_means, method = "spearman")
cor.test(subset(All_metrics_combined4, survivors > 5)$concentration, subset(All_metrics_combined4, survivors > 5)$top_six_correct_means, method = "spearman")
cor.test(subset(All_metrics_combined4_measured_only, survivors >5)$SD_drug_community, subset(All_metrics_combined4_measured_only, survivors >5)$top_six_correct_means, method = "spearman")
cor.test(subset(All_metrics_combined4, survivors > 5)$mean_maxOD, subset(All_metrics_combined4, survivors > 5)$top_six_correct_means, method = "spearman")

#cor.test(All_metrics_combined4$survivors, All_metrics_combined4$predicted_magnitude_correct_fraction, method = "spearman")


#Survivors correctly predicted
model <- lm(predicted_magnitude_correct_fraction ~ mean_abs_change_AUC, data = All_metrics_combined4)
summary(model)
model <- lm(predicted_magnitude_correct_fraction ~ Prop_left_24h_community, data = All_metrics_combined4_measured_only)
summary(model)
model <- lm(predicted_magnitude_correct_fraction ~ Concentration_left_after_24h, data = All_metrics_combined4_measured_only)
summary(model)
model <- lm(predicted_magnitude_correct_fraction ~ concentration, data = All_metrics_combined4)
summary(model)
model <- lm(predicted_magnitude_correct_fraction ~ SD_drug_community, data = All_metrics_combined4_measured_only)
summary(model)
model <- lm(predicted_magnitude_correct_fraction ~ mean_maxOD, data = All_metrics_combined4)
summary(model)
# model <- lm(predicted_magnitude_correct_fraction ~ survivors, data = All_metrics_combined4)
# summary(model)

#Top 6 ranked by lower bounds:
model <- lm(top_six_correct ~ mean_abs_change_AUC, data = subset(All_metrics_combined4, survivors >5))
summary(model)
model <- lm(top_six_correct ~ Prop_left_24h_community, data = subset(All_metrics_combined4_measured_only, survivors >5))
summary(model)
model <- lm(top_six_correct ~ Concentration_left_after_24h, data = subset(All_metrics_combined4_measured_only, survivors >5))
summary(model)
model <- lm(top_six_correct ~ concentration, subset(All_metrics_combined4, survivors >5))
summary(model)
model <- lm(top_six_correct ~ SD_drug_community, subset(All_metrics_combined4_measured_only, survivors >5))
summary(model)
model <- lm(top_six_correct ~ mean_maxOD, subset(All_metrics_combined4, survivors >5))
summary(model)
# model <- lm(top_six_correct ~ survivors, data = All_metrics_combined4)
# summary(model)


#Top 6 ranked by means:
model <- lm(top_six_correct_means ~ mean_abs_change_AUC, data = subset(All_metrics_combined4, survivors >5))
summary(model)
model <- lm(top_six_correct_means ~ Prop_left_24h_community, data = subset(All_metrics_combined4_measured_only, survivors >5))
summary(model)
model <- lm(top_six_correct_means ~ Concentration_left_after_24h, data = subset(All_metrics_combined4_measured_only, survivors >5))
summary(model)
model <- lm(top_six_correct_means ~ concentration, data = subset(All_metrics_combined4, survivors >5))
summary(model)
model <- lm(top_six_correct_means ~ SD_drug_community, data = subset(All_metrics_combined4_measured_only, survivors >5))
summary(model)
model <- lm(top_six_correct_means ~ mean_maxOD, data = subset(All_metrics_combined4, survivors >5))
summary(model)
# model <- lm(top_six_correct_means ~ survivors, data = All_metrics_combined4)
# summary(model)

cor.test(All_metrics_combined4$mean_maxOD, All_metrics_combined4$predicted_magnitude_correct_fraction, method = "spearman")
model <- lm(predicted_magnitude_correct_fraction ~ mean_maxOD, data = All_metrics_combined4)
summary(model)


ggplot(All_metrics_combined4, aes(x = Concentration_left_after_24h, y = top_six_correct_means, alpha = survivors, size = conc)) +
  geom_smooth(method = "lm", se = FALSE, color = "grey", alpha = 0.5, linetype = "dashed") +  
  geom_point() +
  labs(
    title = "",
    x = "Concentration drug left after 24h",
    y = "Top 6 correctly predicted",
    size = "Concentration tested",
    alpha = "Survivor (>1%) count",
    color = "High Mean Monoculture Impact (>0.6)"
  ) +
  scale_color_manual(values = drug_colours) +  
  #scale_size_continuous(breaks = quantile(All_metrics_combined4$Prop_left_24h_community, probs = seq(0, 1, by = 0.25)), guide = guide_legend()) +
  theme_minimal()

cor.test(All_metrics_combined4$Concentration_left_after_24h, All_metrics_combined4$top_six_correct_means, method = "spearman")

model <- lm(top_six_correct ~ Prop_left_24h_community, data = All_metrics_combined4)
model_summary <- summary(model)
r_squared <- model_summary$r.squared
print(r_squared)

cor.test(All_metrics_combined4$Concentration_left_after_24h, All_metrics_combined4$top_six_correct, method = "spearman")
model <- lm(top_six_correct ~ Concentration_left_after_24h, data = All_metrics_combined4)
summary(model)

##general performance metrics

# Order of magnitude of survivor species (>1%) correct:
percentage_OOM_over_0_9 <- mean(All_metrics_combined4$predicted_magnitude_correct_fraction >= 0.9) * 100
percentage_OOM_over_0_8 <- mean(All_metrics_combined4$predicted_magnitude_correct_fraction >= 0.8) * 100
percentage_OOM_over_0_6 <- mean(All_metrics_combined4$predicted_magnitude_correct_fraction >= 0.6) * 100

percentage_OOM_over_0_9
percentage_OOM_over_0_8
percentage_OOM_over_0_6

#without AB
percentage_OOM_over_0_9_no_AB <- mean(subset(All_metrics_combined4, Function != "Antibiotic")$predicted_magnitude_correct_fraction >= 0.9) * 100
percentage_OOM_over_0_8_no_AB <- mean(subset(All_metrics_combined4, Function != "Antibiotic")$predicted_magnitude_correct_fraction >= 0.8) * 100
percentage_OOM_over_0_6_no_AB <- mean(subset(All_metrics_combined4, Function != "Antibiotic")$predicted_magnitude_correct_fraction >= 0.6) * 100

percentage_OOM_over_0_9_no_AB
percentage_OOM_over_0_8_no_AB
percentage_OOM_over_0_6_no_AB


##NULL model:
# Order of magnitude of survivor species (>1%) correct:
percentage_OOM_over_0_9_NULL <- mean(All_metrics_combined4$predicted_magnitude_correct_fraction_NULL >= 0.9) * 100
percentage_OOM_over_0_8_NULL <- mean(All_metrics_combined4$predicted_magnitude_correct_fraction_NULL >= 0.8) * 100
percentage_OOM_over_0_6_NULL <- mean(All_metrics_combined4$predicted_magnitude_correct_fraction_NULL >= 0.6) * 100

percentage_OOM_over_0_9_NULL
percentage_OOM_over_0_8_NULL
percentage_OOM_over_0_6_NULL

#without AB
percentage_OOM_over_0_9_no_AB_NULL <- mean(subset(All_metrics_combined4, Function != "Antibiotic")$predicted_magnitude_correct_fraction_NULL >= 0.9) * 100
percentage_OOM_over_0_8_no_AB_NULL <- mean(subset(All_metrics_combined4, Function != "Antibiotic")$predicted_magnitude_correct_fraction_NULL >= 0.8) * 100
percentage_OOM_over_0_6_no_AB_NULL <- mean(subset(All_metrics_combined4, Function != "Antibiotic")$predicted_magnitude_correct_fraction_NULL >= 0.6) * 100

percentage_OOM_over_0_9_no_AB_NULL
percentage_OOM_over_0_8_no_AB_NULL
percentage_OOM_over_0_6_no_AB_NULL

##Top 6 by lower bounds
percentage_T6_6 <- mean(subset(All_metrics_combined4, survivors > 5)$top_six_correct>= 6) * 100
percentage_T6_over_4 <- mean(subset(All_metrics_combined4, survivors > 5)$top_six_correct>= 4) * 100
percentage_T6_over_3 <- mean(subset(All_metrics_combined4, survivors > 5)$top_six_correct>= 3) * 100

percentage_T6_6
percentage_T6_over_4
percentage_T6_over_3

#without AB
percentage_T6_over_6_no_AB <- mean(subset(All_metrics_combined4, Function != "Antibiotic" & survivors > 5)$top_six_correct>= 6) * 100
percentage_T6_over_4_no_AB <- mean(subset(All_metrics_combined4, Function != "Antibiotic" & survivors > 5)$top_six_correct>= 4) * 100
percentage_T6_over_3_no_AB <- mean(subset(All_metrics_combined4, Function != "Antibiotic" & survivors > 5)$top_six_correct>= 3) * 100

percentage_T6_over_6_no_AB
percentage_T6_over_4_no_AB
percentage_T6_over_3_no_AB


##Top 6 by lower bounds: NULL model
percentage_T6_6_NULL <- mean(subset(All_metrics_combined4, survivors > 5)$top_six_correct_NULL>= 6) * 100
percentage_T6_over_4_NULL <- mean(subset(All_metrics_combined4, survivors > 5)$top_six_correct_NULL>= 4) * 100
percentage_T6_over_3_NULL <- mean(subset(All_metrics_combined4, survivors > 5)$top_six_correct_NULL>= 3) * 100

percentage_T6_6_NULL
percentage_T6_over_4_NULL
percentage_T6_over_3_NULL

#without AB
percentage_T6_over_6_no_AB_NULL <- mean(subset(All_metrics_combined4, Function != "Antibiotic" & survivors > 5)$top_six_correct_NULL >= 6) * 100
percentage_T6_over_4_no_AB_NULL <- mean(subset(All_metrics_combined4, Function != "Antibiotic" & survivors > 5)$top_six_correct_NULL >= 4) * 100
percentage_T6_over_3_no_AB_NULL <- mean(subset(All_metrics_combined4, Function != "Antibiotic" & survivors > 5)$top_six_correct_NULL >= 3) * 100

percentage_T6_over_6_no_AB_NULL
percentage_T6_over_4_no_AB_NULL
percentage_T6_over_3_no_AB_NULL

##Top 6 by means
percentage_T6_6_means <- mean(subset(All_metrics_combined4, survivors > 5)$top_six_correct_means >= 6) * 100
percentage_T6_over_4_means <- mean(subset(All_metrics_combined4, survivors > 5)$top_six_correct_means >= 4) * 100
percentage_T6_over_3_means <- mean(subset(All_metrics_combined4, survivors > 5)$top_six_correct_means >= 3) * 100

percentage_T6_6_means
percentage_T6_over_4_means
percentage_T6_over_3_means

#without AB
percentage_T6_over_6_no_AB_means <- mean(subset(All_metrics_combined4, Function != "Antibiotic" & survivors > 5)$top_six_correct_means>= 6) * 100
percentage_T6_over_4_no_AB_means <- mean(subset(All_metrics_combined4, Function != "Antibiotic" & survivors > 5)$top_six_correct_means>= 4) * 100
percentage_T6_over_3_no_AB_means <- mean(subset(All_metrics_combined4, Function != "Antibiotic" & survivors > 5)$top_six_correct_means>= 3) * 100

percentage_T6_over_6_no_AB_means
percentage_T6_over_4_no_AB_means
percentage_T6_over_3_no_AB_means


##now for Null model:
percentage_T6_6_means_NULL <- mean(subset(All_metrics_combined4, survivors > 5)$top_six_correct_means_NULL >= 6) * 100
percentage_T6_over_4_means_NULL <- mean(subset(All_metrics_combined4, survivors > 5)$top_six_correct_means_NULL >= 4) * 100
percentage_T6_over_3_means_NULL <- mean(subset(All_metrics_combined4, survivors > 5)$top_six_correct_means_NULL >= 3) * 100

percentage_T6_6_means_NULL
percentage_T6_over_4_means_NULL
percentage_T6_over_3_means_NULL

#without AB
percentage_T6_over_6_no_AB_means_NULL <- mean(subset(All_metrics_combined4, Function !="Antibiotic" & survivors > 5)$top_six_correct_means_NULL >= 6) * 100
percentage_T6_over_4_no_AB_means_NULL <- mean(subset(All_metrics_combined4, Function !="Antibiotic" & survivors > 5)$top_six_correct_means_NULL >= 4) * 100
percentage_T6_over_3_no_AB_means_NULL <- mean(subset(All_metrics_combined4, Function !="Antibiotic" & survivors > 5)$top_six_correct_means_NULL >= 3) * 100

percentage_T6_over_6_no_AB_means_NULL
percentage_T6_over_4_no_AB_means_NULL
percentage_T6_over_3_no_AB_means_NULL






All_metrics_combined5 <- All_metrics_combined4 %>%
  dplyr::group_by(Function) %>%
  dplyr::mutate(median_predicted = median(predicted_magnitude_correct_fraction, na.rm = TRUE)) %>%
  dplyr::mutate(mean_MIM = mean(mean_abs_change_AUC, na.rm = TRUE)) %>%
  ungroup() %>%
  dplyr::mutate(Function = factor(Function, levels = unique(Function[order(median_predicted)])))


##account for a more coarsegrained function (e.g., Mefloquine = antimilarial and thus an antiprotozoal)

drugs <- c("Niclosamide", "Mecillinam", "Aripiprazole", "Simvastatin", "Acarbose", 
           "Aprepitant", "Mefloquine", "control", "Nifurtimox", "Sertindole", "Ebselen", 
           "Loratadine", "Tamoxifen", "Methotrexate", "Clomiphene", "beta-estradiol 17-valerate", 
           "Diacerein", "Loxapine", "Entacapone", "Chlorpromazine", "Ciprofloxacin", 
           "Felodipine", "Amlodipine", "Omeprazole", "Azithromycin", "Olanzapine", 
           "Dienestrol", "Doxycycline", "Lansoprazole", "Ketoconazole", "Oxolinic acid")

functions <- c("Anthelmintic", "Antibiotic", "Antipsychotic", "Cholesterol-lowering", "Antidiabetic", 
               "Anti-nausea", "Antiprotozoal", "Control", "Antiprotozoal", "Antipsychotic", "Antioxidant", 
               "Antihistamine", "Hormone Treatment", "Chemotherapy", "Hormone Treatment", "Hormone Treatment", 
               "Anti-inflammatory", "Antipsychotic", "Parkinson's Disease Management", "Antipsychotic", 
               "Antibiotic", "Calcium Channel Blocker", "Calcium Channel Blocker", "Proton Pump Inhibitor", 
               "Antibiotic", "Antipsychotic", "Hormone Treatment", "Antibiotic", "Proton Pump Inhibitor", 
               "Antifungal", "Antibiotic")

drug_function_map <- setNames(functions, drugs)

All_metrics_combined5$Function <- drug_function_map[All_metrics_combined5$drug]




# Now, creating the boxplot with data points overlaid
ggplot(All_metrics_combined5, aes(x = Function, y = predicted_magnitude_correct_fraction)) +
  geom_boxplot(outlier.shape = NA, fill = "lightblue", colour = "darkblue") + 
  geom_jitter(width = 0.2, size = 2, color = "darkred", alpha = 0.5) + 
  labs(x = "Function", y = "Predicted Magnitude Correct Fraction") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) 


##add colour coding of points, size = conc, and colour of underlying boxplot 
ggplot(All_metrics_combined5, aes(x = Function, y = predicted_magnitude_correct_fraction, fill = mean_MIM)) +
  geom_boxplot(outlier.shape = NA, alpha = 0.8) +  
  geom_jitter(aes(color = drug, size = conc), width = 0.25, alpha = 0.9) +  
  scale_fill_viridis_c(direction = -1) +  
  scale_color_manual(values = drug_colours) + 
  labs(x = "Function", y = "Magnitude 'Survivors' (>1%) Correctly Predicted?",
       fill = "mean MIM",
       size = "concentration tested") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) 



##Now for top 6 correctly predicted:
All_metrics_combined6 <- All_metrics_combined4 %>%
  dplyr::group_by(Function) %>%
  dplyr::mutate(median_predicted = median(top_six_correct, na.rm = TRUE)) %>%
  dplyr::mutate(mean_MIM = mean(mean_abs_change_AUC, na.rm = TRUE)) %>%
  dplyr::mutate(mean_survivors= mean(survivors, na.rm = TRUE)) %>%
  ungroup() %>%
  dplyr::mutate(Function = factor(Function, levels = unique(Function[order(median_predicted)])))

# Now, creating the boxplot with data points overlaid
ggplot(All_metrics_combined6, aes(x = Function, y = top_six_correct)) +
  geom_boxplot(outlier.shape = NA, fill = "lightblue", colour = "darkblue") + 
  geom_jitter(width = 0.2, size = 2, color = "darkred", alpha = 0.5) +
  labs(x = "Function", y = "Predicted Magnitude Correct Fraction") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) 


##add colour coding of points, size = conc, and colour of underlying boxplot = mean MIM of the function group
ggplot(All_metrics_combined6, aes(x = Function, y = top_six_correct, fill = mean_MIM)) +
  geom_boxplot(outlier.shape = NA) +  
  geom_jitter(aes(color = drug, size = conc, alpha = mean_survivors), width = 0.25) +  
  scale_fill_viridis_c(direction = -1) +  
  scale_color_manual(values = drug_colours) +  
  labs(x = "Function", y = "Top 6 Correctly Predicted?",
       fill = "mean MIM",
       size = "concentration tested") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) 



ggplot(All_metrics_combined6, aes(x = Function, y = top_six_correct, fill = mean_MIM)) +
  geom_boxplot(outlier.shape = NA, aes(alpha = ifelse(mean_survivors < 6, 0.1, 0.8))) +  
  geom_jitter(aes(color = drug, size = conc, alpha = ifelse(mean_survivors < 6, 0.1, 0.8)), width = 0.25, height = 0) +  
  scale_fill_viridis_c(direction = -1) +  
  scale_color_manual(values = drug_colours) +  
  scale_alpha_continuous(guide = 'none') +  
  labs(x = NULL, y = "Top 6 Correctly Predicted",
       fill = "mean MIM",
       size = "Concentration Tested",
       alpha = NULL) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))


#for drugs from which dynamics were pulled from metabolomics info of fellow drugs (beta-estradiol 17-valerate, Diacerein, Acarbose), fix the "Concentration_left" variable
All_metrics_combined4$Concentration_left_after_24h <- All_metrics_combined4$conc * All_metrics_combined4$Prop_left_24h_community

#write.csv(All_metrics_combined4, file = "~/Downloads/All_metrics_combined4_dynamic_drug_dynamics_Sept24.csv", row.names = FALSE)
#write.csv(All_metrics_combined4, file = "~/Downloads/All_metrics_combined4_fixed_drug_dynamics_Sept24.csv", row.names = FALSE)


##now, to assess the difference in model performance if dynamics are fixed or non-fixed, we first import respective All_metrics_combined4 dataframes 
# each formulated after running the model with and without fixed drug dynamics (dD/dt == 0)

All_metrics_combined4_dynamic_drugs <- read_csv("~/Downloads/All_metrics_combined4_dynamic_drug_dynamics_Sept24.csv")
All_metrics_combined4_fixed_drugs <- read_csv("~/Downloads/All_metrics_combined4_fixed_drug_dynamics_Sept24.csv")

drugs <- c("Niclosamide", "Mecillinam", "Aripiprazole", "Simvastatin", "Acarbose", 
           "Aprepitant", "Mefloquine", "control", "Nifurtimox", "Sertindole", "Ebselen", 
           "Loratadine", "Tamoxifen", "Methotrexate", "Clomiphene", "beta-estradiol 17-valerate", 
           "Diacerein", "Loxapine", "Entacapone", "Chlorpromazine", "Ciprofloxacin", 
           "Felodipine", "Amlodipine", "Omeprazole", "Azithromycin", "Olanzapine", 
           "Dienestrol", "Doxycycline", "Lansoprazole", "Ketoconazole", "Oxolinic acid")

functions <- c("Anthelmintic", "Antibiotic", "Antipsychotic", "Cholesterol-lowering", "Antidiabetic", 
               "Anti-nausea", "Antiprotozoal", "Control", "Antiprotozoal", "Antipsychotic", "Antioxidant", 
               "Antihistamine", "Hormone Treatment", "Chemotherapy", "Hormone Treatment", "Hormone Treatment", 
               "Anti-inflammatory", "Antipsychotic", "Parkinson's Disease Management", "Antipsychotic", 
               "Antibiotic", "Calcium Channel Blocker", "Calcium Channel Blocker", "Proton Pump Inhibitor", 
               "Antibiotic", "Antipsychotic", "Hormone Treatment", "Antibiotic", "Proton Pump Inhibitor", 
               "Antifungal", "Antibiotic")

drug_function_map <- setNames(functions, drugs)

All_metrics_combined4_dynamic_drugs$Function <- drug_function_map[All_metrics_combined4_dynamic_drugs$drug]
All_metrics_combined4_fixed_drugs$Function <- drug_function_map[All_metrics_combined4_fixed_drugs$drug]


##In order to map the relative difference in model performance whenever we fix drug dynamics (i.e, do not account for community-induced degradation of the drug)

All_metrics_combined4_fixed_drugs <- All_metrics_combined4_fixed_drugs %>%
  dplyr::mutate(
    difference_OOM_score = predicted_magnitude_correct_fraction - All_metrics_combined4_dynamic_drugs$predicted_magnitude_correct_fraction,
    difference_top6_score = top_six_correct - All_metrics_combined4_dynamic_drugs$top_six_correct,
    difference_top6_score_means = top_six_correct_means - All_metrics_combined4_dynamic_drugs$top_six_correct_means,
  )


All_metrics_combined4_fixed_drugs1 <- All_metrics_combined4_fixed_drugs %>%
  dplyr::group_by(Function) %>%
  dplyr::mutate(median_predicted = median(predicted_magnitude_correct_fraction, na.rm = TRUE)) %>%
  dplyr::mutate(mean_MIM = mean(mean_abs_change_AUC, na.rm = TRUE)) %>%
  dplyr::mutate(mean_survivors= mean(survivors, na.rm = TRUE)) %>%
  ungroup() %>%
  dplyr::mutate(Function = factor(Function, levels = unique(Function[order(difference_OOM_score)])))



All_metrics_combined4_fixed_drugs2 <- subset(All_metrics_combined4_fixed_drugs, survivors > 5) %>%
  dplyr::group_by(Function) %>%
  dplyr::mutate(median_predicted = median(predicted_magnitude_correct_fraction, na.rm = TRUE)) %>%
  dplyr::mutate(mean_MIM = mean(mean_abs_change_AUC, na.rm = TRUE)) %>%
  dplyr::mutate(mean_survivors= mean(survivors, na.rm = TRUE)) %>%
  ungroup() %>%
  dplyr::mutate(Function = factor(Function, levels = unique(Function[order(difference_OOM_score)])))




function_colours <- c(
  "Antidiabetic" = "blue", 
  "Calcium Channel Blocker" = "red", 
  "Anti-nausea" = "lightseagreen", 
  "Antipsychotic" = "purple", 
  "Antibiotic" = "orange1", 
  "Hormone Treatment" = "lightgreen",    
  "Anti-inflammatory" = "lightblue", 
  "Antioxidant" = "tan4", 
  "Parkinson's Disease Management" = "cyan", 
  "Antifungal" = "coral1", 
  "Proton Pump Inhibitor" = "grey", 
  "Antihistamine" = "cornflowerblue", 
  "Antimalarial" = "navy", 
  "Chemotherapy" = "grey44", 
  "Anthelmintic" = "maroon", 
  "Antiprotozoal" = "gold", 
  "Cholesterol-lowering" = "violet" 
)



##add _means to metrics if interested in looking at top 6 assessed by means rather than lower bound
##Top 6
percentage_T6_6_means <- mean(subset(All_metrics_combined4_dynamic_drugs, survivors > 5)$top_six_correct_means >= 6) * 100
percentage_T6_over_4_means <- mean(subset(All_metrics_combined4_dynamic_drugs, survivors > 5)$top_six_correct_means >= 4) * 100
percentage_T6_over_3_means <- mean(subset(All_metrics_combined4_dynamic_drugs, survivors > 5)$top_six_correct_means >= 3) * 100

percentage_T6_6_means
percentage_T6_over_4_means
percentage_T6_over_3_means

#without AB
percentage_T6_over_6_no_AB_means <- mean(subset(All_metrics_combined4_dynamic_drugs, Function != "Antibiotic" & survivors > 5)$top_six_correct_means>= 6) * 100
percentage_T6_over_4_no_AB_means <- mean(subset(All_metrics_combined4_dynamic_drugs, Function != "Antibiotic" & survivors > 5)$top_six_correct_means>= 4) * 100
percentage_T6_over_3_no_AB_means <- mean(subset(All_metrics_combined4_dynamic_drugs, Function != "Antibiotic" & survivors > 5)$top_six_correct_means>= 3) * 100

percentage_T6_over_6_no_AB_means
percentage_T6_over_4_no_AB_means
percentage_T6_over_3_no_AB_means




##now for fixed drug:

#surivivors correctly predicted
mean(All_metrics_combined4_fixed_drugs$predicted_magnitude_correct_fraction >= 0.6) * 100
mean(All_metrics_combined4_fixed_drugs$predicted_magnitude_correct_fraction >= 0.8) * 100
mean(All_metrics_combined4_fixed_drugs$predicted_magnitude_correct_fraction >= 0.9) * 100

#w/o AB:
mean(subset(All_metrics_combined4_fixed_drugs, Function != "Antibiotic")$predicted_magnitude_correct_fraction >= 0.6) * 100
mean(subset(All_metrics_combined4_fixed_drugs, Function != "Antibiotic")$predicted_magnitude_correct_fraction >= 0.8) * 100
mean(subset(All_metrics_combined4_fixed_drugs, Function != "Antibiotic")$predicted_magnitude_correct_fraction >= 0.9) * 100

##Top 6
percentage_T6_6_fixed <- mean(subset(All_metrics_combined4_fixed_drugs, survivors > 5)$top_six_correct >= 6) * 100
percentage_T6_over_4_fixed <- mean(subset(All_metrics_combined4_fixed_drugs, survivors > 5)$top_six_correct >= 4) * 100
percentage_T6_over_3_fixed <- mean(subset(All_metrics_combined4_fixed_drugs, survivors > 5)$top_six_correct >= 3) * 100

percentage_T6_6_fixed
percentage_T6_over_4_fixed
percentage_T6_over_3_fixed

#without AB
percentage_T6_over_6_no_AB_fixed <- mean(subset(All_metrics_combined4_fixed_drugs, Function != "Antibiotic" & survivors > 5)$top_six_correct>= 6) * 100
percentage_T6_over_4_no_AB_fixed <- mean(subset(All_metrics_combined4_fixed_drugs, Function != "Antibiotic" & survivors > 5)$top_six_correct>= 4) * 100
percentage_T6_over_3_no_AB_fixed <- mean(subset(All_metrics_combined4_fixed_drugs, Function != "Antibiotic" & survivors > 5)$top_six_correct>= 3) * 100

percentage_T6_over_6_no_AB_fixed
percentage_T6_over_4_no_AB_fixed
percentage_T6_over_3_no_AB_fixed

##Top 6 by means
percentage_T6_6_fixed_means <- mean(subset(All_metrics_combined4_fixed_drugs, survivors > 5)$top_six_correct_means >= 6) * 100
percentage_T6_over_4_fixed_means <- mean(subset(All_metrics_combined4_fixed_drugs, survivors > 5)$top_six_correct_means >= 4) * 100
percentage_T6_over_3_fixed_means <- mean(subset(All_metrics_combined4_fixed_drugs, survivors > 5)$top_six_correct_means >= 3) * 100

percentage_T6_6_fixed_means
percentage_T6_over_4_fixed_means
percentage_T6_over_3_fixed_means

#without AB
percentage_T6_over_6_no_AB_fixed_means <- mean(subset(All_metrics_combined4_fixed_drugs, Function != "Antibiotic" & survivors > 5)$top_six_correct_means>= 6) * 100
percentage_T6_over_4_no_AB_fixed_means <- mean(subset(All_metrics_combined4_fixed_drugs, Function != "Antibiotic" & survivors > 5)$top_six_correct_means>= 4) * 100
percentage_T6_over_3_no_AB_fixed_means <- mean(subset(All_metrics_combined4_fixed_drugs, Function != "Antibiotic" & survivors > 5)$top_six_correct_means>= 3) * 100

percentage_T6_over_6_no_AB_fixed_means
percentage_T6_over_4_no_AB_fixed_means
percentage_T6_over_3_no_AB_fixed_means




All_metrics_combined4_dynamic_drugs_a <- All_metrics_combined4_dynamic_drugs %>%
  dplyr::group_by(drug) %>%
  dplyr::mutate(median_predicted = median(predicted_magnitude_correct_fraction, na.rm = TRUE)) %>%
  dplyr::mutate(mean_MIM = mean(mean_abs_change_AUC, na.rm = TRUE)) %>%
  dplyr::mutate(mean_survivors= mean(survivors, na.rm = TRUE)) %>%
  ungroup() %>%
  dplyr::mutate(drug = factor(drug, levels = unique(drug[order(median_predicted)])))


# All_metrics_combined4_dynamic_drugs_b <- subset(All_metrics_combined4_dynamic_drugs, Function != "Antibiotic") %>%
#   dplyr::group_by(drug) %>%
#   dplyr::mutate(median_predicted = median(predicted_magnitude_correct_fraction, na.rm = TRUE)) %>%
#   dplyr::mutate(mean_MIM = mean(mean_abs_change_AUC, na.rm = TRUE)) %>%
#   dplyr::mutate(mean_survivors= mean(survivors, na.rm = TRUE)) %>%
#   ungroup() %>%
#   dplyr::mutate(drug = factor(drug, levels = unique(drug[order(median_predicted)])))


## Model score of fraction of survivors correctly predicted
ggplot(All_metrics_combined4_dynamic_drugs_a, aes(x = drug, y = predicted_magnitude_correct_fraction)) +
  geom_boxplot(aes(fill = Function), outlier.shape = NA, alpha = 0.6) +  
  #geom_jitter(aes(color = mean_abs_change_AUC, size = conc, alpha = ifelse(survivors < 5, 0.1, 1)), width = 0.35) +  
  geom_jitter(aes(color = mean_abs_change_AUC, size = conc), alpha = 0.8, width = 0.35) + 
  ylim(-0.1, 1.05) + 
  geom_text(aes(label = ifelse(survivors < 6, "*", ""), color  = mean_abs_change_AUC), vjust = 0, hjust = 0.8) +
  scale_fill_manual(values = function_colours, name = "Function") +  
  scale_color_viridis_c(name = "MIM", direction = -1) +  
  labs(x = NULL, y = "Fraction Survivors Correctly Predicted",
       size = "Concentration Tested") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  guides(alpha = FALSE)


## NULL score of fraction of survivors correctly predicted
ggplot(All_metrics_combined4_dynamic_drugs_a, aes(x = drug, y = predicted_magnitude_correct_fraction_NULL)) +
  geom_boxplot(aes(fill = Function), outlier.shape = NA, alpha = 0.6) +  
  #geom_jitter(aes(color = mean_abs_change_AUC, size = conc, alpha = ifelse(survivors < 5, 0.1, 1)), width = 0.35) +  
  geom_jitter(aes(color = mean_abs_change_AUC, size = conc), alpha = 0.8, width = 0.35) + 
  ylim(-0.1, 1.05) + 
  geom_text(aes(label = ifelse(survivors < 6, "*", ""), color  = mean_abs_change_AUC), vjust = 0, hjust = 0.8) +
  scale_fill_manual(values = function_colours, name = "Function") +  
  scale_color_viridis_c(name = "MIM", direction = -1) +  
  labs(x = NULL, y = "Fraction Survivors Correctly Predicted by NULL",
       size = "Concentration Tested") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  guides(alpha = FALSE)


All_metrics_combined4_dynamic_drugs_b1 <- subset(All_metrics_combined4_dynamic_drugs) %>%
  dplyr::group_by(drug) %>%
  dplyr::mutate(median_predicted = mean(top_six_correct_means, na.rm = TRUE)) %>%
  dplyr::mutate(mean_MIM = mean(mean_abs_change_AUC, na.rm = TRUE)) %>%
  dplyr::mutate(mean_survivors= mean(survivors, na.rm = TRUE)) %>%
  ungroup() %>%
  dplyr::mutate(drug = factor(drug, levels = unique(drug[order(median_predicted)])))


#Included in thesis: model score survivors correctly predicted
ggplot(All_metrics_combined4_dynamic_drugs_b1, aes(x = drug, y = top_six_correct_means)) +
  geom_boxplot(aes(fill = Function), outlier.shape = NA, alpha = 0.6) +  
  #geom_jitter(aes(color = mean_abs_change_AUC, size = conc, alpha = ifelse(survivors < 5, 0.1, 1)), width = 0.35) +  
  geom_jitter(aes(color = mean_abs_change_AUC, size = conc), alpha = 0.8, width = 0.35, height = 0) +  
  geom_text(aes(label = ifelse(survivors < 6, "*", ""), color  = mean_abs_change_AUC), vjust = 0, hjust = 0.8) +
  scale_fill_manual(values = function_colours, name = "Function") +  
  scale_color_viridis_c(name = "MIM", direction = -1) +  
  labs(x = NULL, y = "Top 6 species (ranked by mean rel. abundance) correctly predicted",
       size = "Concentration Tested") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  guides(alpha = FALSE)

#Included in thesis: NULL score survivors correctly predicted
ggplot(All_metrics_combined4_dynamic_drugs_b1, aes(x = drug, y = top_six_correct_means_NULL)) +
  geom_boxplot(aes(fill = Function), outlier.shape = NA, alpha = 0.6) +  
  #geom_jitter(aes(color = mean_abs_change_AUC, size = conc, alpha = ifelse(survivors < 5, 0.1, 1)), width = 0.35) +  
  geom_jitter(aes(color = mean_abs_change_AUC, size = conc), alpha = 0.8, width = 0.35, height = 0) +  
  geom_text(aes(label = ifelse(survivors < 6, "*", ""), color  = mean_abs_change_AUC), vjust = 0, hjust = 0.8) +
  scale_fill_manual(values = function_colours, name = "Function") +  
  scale_color_viridis_c(name = "MIM", direction = -1) +  
  labs(x = NULL, y = "Top 6 species (ranked by mean rel. abundance) correctly predicted by NULL",
       size = "Concentration Tested") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  guides(alpha = FALSE)


All_metrics_combined4_dynamic_drugs_b1a <- subset(All_metrics_combined4_dynamic_drugs) %>%
  dplyr::group_by(drug) %>%
  dplyr::mutate(median_predicted = mean(top_six_correct, na.rm = TRUE)) %>%
  dplyr::mutate(mean_MIM = mean(mean_abs_change_AUC, na.rm = TRUE)) %>%
  dplyr::mutate(mean_survivors= mean(survivors, na.rm = TRUE)) %>%
  ungroup() %>%
  dplyr::mutate(drug = factor(drug, levels = unique(drug[order(median_predicted)])))

ggplot(All_metrics_combined4_dynamic_drugs_b1a, aes(x = drug, y = top_six_correct)) +
  geom_boxplot(aes(fill = Function), outlier.shape = NA, alpha = 0.6) +  
  #geom_jitter(aes(color = mean_abs_change_AUC, size = conc, alpha = ifelse(survivors < 5, 0.1, 1)), width = 0.35) +  
  geom_jitter(aes(color = mean_abs_change_AUC, size = conc), alpha = 0.8, width = 0.35, height = 0) +  
  geom_text(aes(label = ifelse(survivors < 6, "*", ""), color  = mean_abs_change_AUC), vjust = 0, hjust = 0.8) +
  scale_fill_manual(values = function_colours, name = "Function") +  
  scale_color_viridis_c(name = "MIM", direction = -1) +  
  labs(x = NULL, y = "Top 6 species (ranked by lower bound rel. abundance) correctly predicted",
       size = "Concentration Tested") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  guides(alpha = FALSE)


#Included in thesis: 
##quadrants of scores:
All_metrics_combined4$Null_vs_model_survivors_predicted <- All_metrics_combined4$predicted_magnitude_correct_fraction - All_metrics_combined4$predicted_magnitude_correct_fraction_NULL
All_metrics_combined4_dynamic_drugs_a$OOM_diff_with_NULL <- All_metrics_combined4_dynamic_drugs_a$predicted_magnitude_correct_fraction - All_metrics_combined4_dynamic_drugs_a$predicted_magnitude_correct_fraction_NULL

# Merge the two dataframes on "drug" and "conc"
# Create a new dataframe with "drug", "conc", and "OOM_diff_with_NULL"
selected_column_OOM_diff_with_NULL <- All_metrics_combined4_dynamic_drugs_a[, c("drug", "conc", "OOM_diff_with_NULL")]

All_metrics_combined4_fixed_drugs3a <- All_metrics_combined4_fixed_drugs %>%
  dplyr::group_by(drug) %>%
  dplyr::mutate(median_predicted = median(predicted_magnitude_correct_fraction, na.rm = TRUE)) %>%
  dplyr::mutate(mean_MIM = mean(mean_abs_change_AUC, na.rm = TRUE)) %>%
  dplyr::mutate(mean_survivors= mean(survivors, na.rm = TRUE)) %>%
  dplyr::mutate(median_diff_OOM= median(difference_OOM_score, na.rm = TRUE)) %>%
  dplyr::mutate(mean_diff_OOM= mean(difference_OOM_score, na.rm = TRUE)) %>%
  ungroup() %>%
  dplyr::mutate(drug = factor(drug, levels = unique(drug[order(mean_diff_OOM)])))

Scores_survivors_df <- merge(selected_column_OOM_diff_with_NULL, All_metrics_combined4_fixed_drugs3a, by = c("drug", "conc"))

#transparancy: is drug left; this we expect can help explain points at 0 on the x-axis: accounting for dynamics is not important because there are barely any dynamics (for example)
# size = drug impact on monoculture; this can help explain points that are on the 0 for x-axis as well; accounting for drug dynamics is not important because the drug barely has an effect; both in monoculture as well as co-culture
# colour = drug 
#on the right side of the plot, but on the bottom half: while extrapolating monoculture sensitivities via co-culture correction does not improve the model's ability to predcit survivors relative to the null model;
#if we do extrapolate monoculture sensitivities, it is important to account for drug dynamics 
#then, along the y-axis, if we do extrapolate monoculture sensitivities via co-culture correction, how informative these are of co-culture outcomes

# ggplot(Scores_survivors_df, aes(x = difference_OOM_score, y = OOM_diff_with_NULL, color = drug, alpha = Prop_left_24h_community)) +
#   geom_point(aes(size = mean_abs_change_AUC, alpha = Prop_left_24h_community)) +  
#   scale_color_manual(values = drug_colours) +  
#   #geom_hline(yintercept = 0, linetype = "dashed", color = "red") +  
#   #geom_vline(yintercept = 0, linetype = "dashed", color = "red") +  
#   labs(x = "Importance accounting for drug dynamics", y = "Importance extrapolating drug sensitivities") +  
#   theme_minimal() 

#flip difference_OOM_score around so that positive values mean drug dynamics are important
ggplot(Scores_survivors_df, aes(x = (difference_OOM_score * -1), y = Null_vs_model_survivors_predicted, 
                                color = drug, fill = drug, alpha = Prop_left_24h_community)) +
  geom_point(aes(size = mean_abs_change_AUC), shape = 21, stroke = 0.9) +  
  scale_color_manual(values = drug_colours) +  
  scale_fill_manual(values = drug_colours) +  
  scale_alpha_continuous(range = c(0.2, 1)) +  
  labs(x = "Importance accounting for drug dynamics", 
       y = "Importance extrapolating drug sensitivities",
       alpha = "Proportion drug left", 
       size = "Mean Impact Monoculture") +  
  theme_minimal()

#more visible transparancy for concentration left after 24h:
ggplot(Scores_survivors_df, aes(x = (difference_OOM_score * -1), y = Null_vs_model_survivors_predicted, 
                                color = drug, fill = drug, alpha = Concentration_left_after_24h)) +
  geom_point(aes(size = mean_abs_change_AUC), shape = 21, stroke = 0.9) +  
  scale_color_manual(values = drug_colours) +  
  scale_fill_manual(values = drug_colours) +  
  scale_alpha_continuous(range = c(0.3, 0.75)) +  
  labs(x = "Importance accounting for drug dynamics", 
       y = "Importance extrapolating drug sensitivities",
       alpha = "Concentration left after 24h", 
       size = "Mean Impact Monoculture") +  
  theme_minimal()

# with a linear model fitted through the points along the quadrants:
ggplot(Scores_survivors_df, aes(x = (difference_OOM_score * -1), y = Null_vs_model_survivors_predicted, 
                                color = drug, fill = drug, alpha = mean_abs_change_AUC)) +
  geom_smooth(aes(group = 1), method = "lm", se = FALSE, color = "black", linetype = "dashed") +  
  geom_point(aes(size = Concentration_left_after_24h), shape = 21, stroke = 0.9, 
             position = position_jitter(width = 0.015, height = 0.015)) +  
  scale_color_manual(values = drug_colours) +  
  scale_fill_manual(values = drug_colours) +  
  scale_size_continuous(range = c(3, 6)) +  
  scale_alpha_continuous(range = c(0.2, 0.9)) +  
  labs(x = "Importance accounting for drug dynamics", 
       y = "Importance extrapolating drug sensitivities",
       alpha = "Mean Impact Monoculture", 
       size = "Concentration left after 24h") +  
  theme_minimal()

cor.test((Scores_survivors_df$difference_OOM_score * -1), Scores_survivors_df$Null_vs_model_survivors_predicted, method = "spearman")
summary(lm((Scores_survivors_df$difference_OOM_score * -1) ~ Scores_survivors_df$Null_vs_model_survivors_predicted))

#top 6 by lower bound
ggplot(Scores_survivors_df, aes(x = (difference_top6_score * -1), y = Null_vs_model_top6, color = drug, alpha = Prop_left_24h_community)) +
  geom_point(aes(size = mean_abs_change_AUC)) +  
  scale_color_manual(values = drug_colours) +  
  scale_alpha_continuous(range = c(0.2, 1)) +  
  labs(x = "Importance accounting for drug dynamics", y = "Importance extrapolating drug sensitivities",
       alpha = "Proportion drug left", size = "Mean Impact Monoculture") +  
  theme_minimal()



##work with top6 means


#Included in thesis: with jitter
#exclude conditions with fewer than 6 survivors, since this confounds our ability to deduce top 6 reliably
ggplot(subset(Scores_survivors_df, survivors > 5), aes(x = (difference_top6_score_means * -1), y = Null_vs_model_top6_means, 
                                color = drug, fill = drug, alpha = mean_abs_change_AUC)) +
  geom_smooth(aes(group = 1), method = "lm", se = FALSE, color = "black", linetype = "dashed") +  
  geom_point(aes(size = Concentration_left_after_24h), shape = 21, stroke = 0.9, 
             position = position_jitter(width = 0.1, height = 0.1)) +  
  scale_color_manual(values = drug_colours) +  
  scale_fill_manual(values = drug_colours) +  
  scale_size_continuous(range = c(3, 6)) +  
  scale_alpha_continuous(range = c(0.2, 0.9)) +  
  labs(x = "Importance accounting for drug dynamics", 
       y = "Importance extrapolating drug sensitivities",
       alpha = "Mean Impact Monoculture", 
       size = "Concentration left after 24h") +  
  theme_minimal()

cor.test((subset(Scores_survivors_df, survivors > 5)$difference_top6_score_means * -1), subset(Scores_survivors_df, survivors > 5)$Null_vs_model_top6_means, method = "spearman")
summary(lm((subset(Scores_survivors_df, survivors > 5)$difference_top6_score_means * -1) ~ subset(Scores_survivors_df, survivors > 5)$Null_vs_model_top6_means))






##Dominant species predictions
##Rank position 1 correct?

drugs <- c("Acarbose", "Amlodipine", "Aprepitant", "Aripiprazole", "Azithromycin", 
           "beta_estradiol_17_valerate", "Chlorpromazine", "Ciprofloxacin", "Clomiphene", 
           "Diacerein", "Dienestrol", "Doxycycline", "Ebselen", "Entacapone", 
           "Felodipine", "Ketoconazole", "Lansoprazole", "Loratadine", "Loxapine", 
           "Mecillinam", "Mefloquine", "Methotrexate", "Niclosamide", "Nifurtimox", 
           "Olanzapine", "Omeprazole", "Oxolinic_acid", "Sertindole", "Simvastatin", 
           "Tamoxifen")

concentrations <- list(
  Acarbose = c(5, 20, 80),
  Amlodipine = c(20, 80, 160),
  Aprepitant = c(5, 20, 30),
  Aripiprazole = c(5, 20, 80),
  Azithromycin = c(2.5, 20, 50),
  beta_estradiol_17_valerate = c(5, 20, 80),
  Chlorpromazine = c(5, 20),
  Ciprofloxacin = c(20, 80),
  Clomiphene = c(5, 20, 80),
  Diacerein = c(20, 80, 320),
  Dienestrol = c(5, 20, 80),
  Doxycycline = c(0.5, 2.5),
  Ebselen = c(1.25, 5, 20),
  Entacapone = c(5, 20, 80),
  Felodipine = c(5, 20, 80),
  Ketoconazole = c(5, 20, 80),
  Lansoprazole = c(5, 20, 80),
  Loratadine = c(5, 20, 80),
  Loxapine = c(5, 20, 80),
  Mecillinam = c(0.5, 2.5, 20),
  Mefloquine = c(5, 20, 60),
  Methotrexate = c(5, 20, 80),
  Niclosamide = c(20, 80, 160),
  Nifurtimox = c(2.5, 20, 35),
  Olanzapine = c(5, 20, 80),
  Omeprazole = c(5, 20, 80),
  Oxolinic_acid = c(0.5, 2.5, 20),
  Sertindole = c(5, 20, 80),
  Simvastatin = c(5, 20, 80),
  Tamoxifen = c(20, 80, 320)
)

species_data <- list()

for (drug in drugs) {
  for (conc in concentrations[[drug]]) {
    ##define the variable names dynamically
    real_var_name <- paste0("top6_real_", conc, "_", drug, "_means")
    predicted_var_name <- paste0("top6_predicted_", conc, "_", drug, "_means")
    
    ##retrieve the values of the variables
    top6_real <- get(real_var_name, envir = .GlobalEnv)
    top6_predicted <- get(predicted_var_name, envir = .GlobalEnv)
    top6_NULL <- c("C_perfringens", "E_coli", "F_nucleatum", "V_parvula", "B_vulgatus", "B_thetaiotaomicron")
    
    ##Append to the list
    species_data[[length(species_data) + 1]] <- list(
      drug = drug,
      conc = conc,
      top6_real = top6_real,
      top6_predicted = top6_predicted,
      top6_NULL = top6_NULL
    )
  }
}


check_prediction <- function(real, predicted, null_model) {
  top_real <- real[1]  #1st species in the real top 6
  correct_predicted <- top_real == predicted[1]
  correct_null <- top_real == null_model[1]
  return(list(correct_predicted = correct_predicted, correct_null = correct_null))
}

##Initialise results list
results <- list()

for (i in 1:length(species_data)) {
  real <- species_data[[i]]$top6_real
  predicted <- species_data[[i]]$top6_predicted
  null_model <- species_data[[i]]$top6_NULL
  result <- check_prediction(real, predicted, null_model)
  
  ##Store results & the drug and concentration info
  results[[i]] <- list(drug = species_data[[i]]$drug, 
                       conc = species_data[[i]]$conc, 
                       correct_predicted = result$correct_predicted, 
                       correct_null = result$correct_null)
}

##Convert results to a df for better viewing
results_df <- do.call(rbind, lapply(results, as.data.frame))

##Convert results to a df for better viewing
results_df <- do.call(rbind, results)
View(results_df)

#results_df_dynamic_drugs <- results_df
str(results_df)


drugs <- results_df[1:87]
concs <- results_df[88:174]
correct_predicted <- results_df[175:261]
correct_null <- results_df[262:348]

##Combine into a data frame
results_df1 <- data.frame(
  drug = unlist(drugs),
  conc = as.numeric(unlist(concs)),
  correct_predicted = unlist(correct_predicted),
  correct_null = unlist(correct_null),
  stringsAsFactors = FALSE
)


#Convert the 'correct_predicted' and 'correct_null' columns to logical type
results_df1$correct_predicted <- as.logical(results_df1$correct_predicted)
results_df1$correct_null <- as.logical(results_df1$correct_null)

sum(results_df1$correct_predicted, na.rm=TRUE)
sum(results_df1$correct_null, na.rm=TRUE)

#in 62/87 of the cases (~71%), our predictions correctly predicted the top 1
#in 53/87 of the cases (~60%), the null model aligns with the top 1 of the drugs

#to discount issues with solubility of drug:
results_df2 <- subset(results_df1, conc < 100)

results_df2$correct_predicted <- as.logical(results_df2$correct_predicted)
results_df2$correct_null <- as.logical(results_df2$correct_null)

sum(results_df2$correct_predicted, na.rm=TRUE)
sum(results_df2$correct_null, na.rm=TRUE)


#to discount antibiotics:
results_df3 <- subset(results_df1, !(drug %in% c("Azithromycin", "Ciprofloxacin", "Doxycycline", "Mecillinam", "Oxolinic_acid")))

results_df3$correct_predicted <- as.logical(results_df3$correct_predicted)
results_df3$correct_null <- as.logical(results_df3$correct_null)

sum(results_df3$correct_predicted, na.rm=TRUE)     
sum(results_df3$correct_null, na.rm=TRUE)   



